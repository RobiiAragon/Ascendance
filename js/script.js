        // Page/View System
        const pages = {
            dashboard: document.getElementById('page-dashboard'),
            employees: null,
            training: null,
            licenses: null,
            analytics: null,
            newstuff: null,
            restock: null,
            abundancecloud: null,
            stores: null,
            announcements: null,
            tasks: null,
            schedule: null,
            settings: null,
            help: null,
            thieves: null,
            invoices: null,
            issues: null,
            gsuite: null,
            vendors: null,
            clockin: null,
            dailysales: null,
            cashout: null,
            change: null,
            projectanalytics: null
        };

        // Current state
        let currentPage = 'dashboard';
        let employees = [
            { id: 1, name: 'Marcus Rodriguez', initials: 'MR', role: 'Store Manager', store: 'Miramar', status: 'active', email: 'marcus@vsu.com', phone: '(619) 555-0101', emergencyContact: 'Maria Rodriguez - (619) 555-0102', allergies: 'None', hireDate: '2023-01-15', color: 'a' },
            { id: 2, name: 'Sarah Kim', initials: 'SK', role: 'Sales Associate', store: 'Morena', status: 'active', email: 'sarah@vsu.com', phone: '(619) 555-0103', emergencyContact: 'John Kim - (619) 555-0104', allergies: 'Peanuts', hireDate: '2023-03-20', color: 'b' },
            { id: 3, name: 'James Thompson', initials: 'JT', role: 'Shift Lead', store: 'Kearny Mesa', status: 'active', email: 'james@vsu.com', phone: '(619) 555-0105', emergencyContact: 'Lisa Thompson - (619) 555-0106', allergies: 'None', hireDate: '2023-02-10', color: 'c' },
            { id: 4, name: 'Amanda Lopez', initials: 'AL', role: 'Sales Associate', store: 'Chula Vista', status: 'inactive', email: 'amanda@vsu.com', phone: '(619) 555-0107', emergencyContact: 'Carlos Lopez - (619) 555-0108', allergies: 'Shellfish', hireDate: '2023-05-01', color: 'd' },
            { id: 5, name: 'David Nguyen', initials: 'DN', role: 'Inventory Specialist', store: 'Miramar', status: 'active', email: 'david@vsu.com', phone: '(619) 555-0109', emergencyContact: 'Linh Nguyen - (619) 555-0110', allergies: 'None', hireDate: '2023-04-15', color: 'e' }
        ];

        let trainings = [
            { id: 1, title: 'Product Knowledge 101', type: 'video', url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ', duration: '45 min', completion: 92, required: true },
            { id: 2, title: 'Customer Service Excellence', type: 'video', url: 'https://vimeo.com/148751763', duration: '30 min', completion: 78, required: true },
            { id: 3, title: 'Safety & Compliance', type: 'document', url: '#', duration: '20 min', completion: 85, required: true },
            { id: 4, title: 'POS System Training', type: 'video', url: 'https://www.youtube.com/watch?v=jNQXAC9IVRw', duration: '60 min', completion: 64, required: true }
        ];

        let licenses = [
            { id: 1, name: 'Business License', store: 'Miramar', expires: '2025-12-31', status: 'valid', file: 'business_license_miramar.pdf' },
            { id: 2, name: 'Tobacco License', store: 'Morena', expires: '2026-01-15', status: 'expiring', file: 'tobacco_license_morena.pdf' },
            { id: 3, name: 'Health Permit', store: 'Kearny Mesa', expires: '2026-03-20', status: 'valid', file: 'health_permit_kearny.pdf' },
            { id: 4, name: 'Fire Safety Certificate', store: 'Chula Vista', expires: '2026-02-10', status: 'expiring', file: 'fire_safety_chula.pdf' },
            { id: 5, name: 'Business License', store: 'Morena', expires: '2025-11-30', status: 'valid', file: 'business_license_morena.pdf' },
            { id: 6, name: 'Business License', store: 'Kearny Mesa', expires: '2026-06-15', status: 'valid', file: 'business_license_kearny.pdf' }
        ];

        let announcements = [
            { id: 1, date: '2025-12-02', title: 'Holiday Schedule', content: 'Holiday schedule updates have been posted. Please check your shifts for the upcoming weeks.', author: 'Carlos Admin' },
            { id: 2, date: '2025-11-28', title: 'New Product Line', content: 'New product line arriving next week - mandatory training session on Thursday.', author: 'Carlos Admin' },
            { id: 3, date: '2025-11-25', title: 'Q4 Achievement', content: 'Congratulations to VSU Miramar for hitting Q4 sales targets! ', author: 'Carlos Admin' }
        ];

        // Track which announcements the current user has read
        let readAnnouncementIds = [];

        /**
         * Show a confirmation modal dialog
         * @param {Object} options - Configuration options
         * @param {string} options.title - Modal title
         * @param {string} options.message - Confirmation message
         * @param {string} options.confirmText - Text for confirm button (default: 'Delete')
         * @param {string} options.cancelText - Text for cancel button (default: 'Cancel')
         * @param {string} options.type - Type of modal: 'danger', 'warning', 'info' (default: 'danger')
         * @param {Function} options.onConfirm - Callback function when confirmed
         * @param {Function} options.onCancel - Callback function when cancelled (optional)
         */
        function showConfirmModal(options) {
            const {
                title = 'Confirm Action',
                message = 'Are you sure you want to proceed?',
                confirmText = 'Delete',
                cancelText = 'Cancel',
                type = 'danger',
                onConfirm,
                onCancel
            } = options;

            // Define colors based on type
            const typeColors = {
                danger: { bg: '#ef4444', icon: 'fa-trash-alt' },
                warning: { bg: '#f59e0b', icon: 'fa-exclamation-triangle' },
                info: { bg: '#3b82f6', icon: 'fa-info-circle' }
            };
            const colors = typeColors[type] || typeColors.danger;

            // Create modal HTML
            const modalHtml = `
                <div id="confirm-modal-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(4px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    animation: fadeIn 0.2s ease;
                ">
                    <div id="confirm-modal-content" style="
                        background: var(--bg-primary);
                        border-radius: 16px;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        max-width: 420px;
                        width: 90%;
                        overflow: hidden;
                        animation: slideUp 0.3s ease;
                    ">
                        <div style="
                            background: ${colors.bg};
                            padding: 24px;
                            text-align: center;
                        ">
                            <div style="
                                width: 64px;
                                height: 64px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 16px;
                            ">
                                <i class="fas ${colors.icon}" style="font-size: 28px; color: white;"></i>
                            </div>
                            <h3 style="color: white; margin: 0; font-size: 20px; font-weight: 600;">${title}</h3>
                        </div>
                        <div style="padding: 24px;">
                            <p style="
                                color: var(--text-secondary);
                                text-align: center;
                                margin: 0 0 24px 0;
                                font-size: 15px;
                                line-height: 1.6;
                            ">${message}</p>
                            <div style="display: flex; gap: 12px;">
                                <button id="confirm-modal-cancel" style="
                                    flex: 1;
                                    padding: 12px 20px;
                                    border: 1px solid var(--border-color);
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                ">${cancelText}</button>
                                <button id="confirm-modal-confirm" style="
                                    flex: 1;
                                    padding: 12px 20px;
                                    border: none;
                                    background: ${colors.bg};
                                    color: white;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                ">${confirmText}</button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    #confirm-modal-cancel:hover {
                        background: var(--bg-tertiary) !important;
                    }
                    #confirm-modal-confirm:hover {
                        filter: brightness(1.1);
                    }
                </style>
            `;

            // Remove any existing confirm modal
            const existingModal = document.getElementById('confirm-modal-overlay');
            if (existingModal) existingModal.remove();

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Get references
            const overlay = document.getElementById('confirm-modal-overlay');
            const cancelBtn = document.getElementById('confirm-modal-cancel');
            const confirmBtn = document.getElementById('confirm-modal-confirm');

            // Close modal function
            const closeConfirmModal = () => {
                overlay.style.animation = 'fadeIn 0.2s ease reverse';
                setTimeout(() => overlay.remove(), 150);
            };

            // Event listeners
            cancelBtn.addEventListener('click', () => {
                closeConfirmModal();
                if (onCancel) onCancel();
            });

            confirmBtn.addEventListener('click', () => {
                closeConfirmModal();
                if (onConfirm) onConfirm();
            });

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeConfirmModal();
                    if (onCancel) onCancel();
                }
            });

            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeConfirmModal();
                    if (onCancel) onCancel();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        /**
         * Compress image to ensure it's under the specified max size
         * Uses canvas to resize and reduce quality
         * @param {string} base64String - The base64 encoded image string
         * @param {number} maxSizeKB - Maximum size in KB (default 700KB to be safe under Firestore 1MB limit)
         * @param {number} maxWidth - Maximum width in pixels (default 1200)
         * @param {number} maxHeight - Maximum height in pixels (default 1200)
         * @returns {Promise<string>} - Compressed base64 image string
         */
        async function compressImage(base64String, maxSizeKB = 700, maxWidth = 1200, maxHeight = 1200) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions while maintaining aspect ratio
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Start with high quality and reduce until under max size
                    let quality = 0.9;
                    let result = canvas.toDataURL('image/jpeg', quality);

                    // Iteratively reduce quality until under max size
                    while (result.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) { // 1.37 accounts for base64 overhead
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }

                    // If still too large, reduce dimensions further
                    if (result.length > maxSizeKB * 1024 * 1.37) {
                        const scaleFactor = 0.7;
                        canvas.width = Math.round(width * scaleFactor);
                        canvas.height = Math.round(height * scaleFactor);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.7);
                    }

                    console.log(`Image compressed: ${Math.round(base64String.length / 1024)}KB -> ${Math.round(result.length / 1024)}KB`);
                    resolve(result);
                };

                img.onerror = function() {
                    reject(new Error('Failed to load image for compression'));
                };

                img.src = base64String;
            });
        }

        /**
         * Initialize Firebase and load announcements from Firestore
         */
        async function initializeFirebaseAnnouncements() {
            console.log('Initializing Firebase for announcements...');

            const initialized = await firebaseAnnouncementsManager.initialize();

            if (initialized) {
                try {
                    const firestoreAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();

                    if (firestoreAnnouncements && firestoreAnnouncements.length > 0) {
                        console.log('Loaded announcements from Firestore:', firestoreAnnouncements);
                        announcements = firestoreAnnouncements;
                    } else {
                        console.log('No announcements in Firestore, using fallback data and migrating...');
                        // Migrate fallback data to Firebase
                        for (const announcement of announcements) {
                            await firebaseAnnouncementsManager.addAnnouncement({
                                date: announcement.date,
                                title: announcement.title,
                                content: announcement.content,
                                author: announcement.author,
                                targetStores: 'all'
                            });
                        }
                        // Reload from Firestore to get IDs
                        const migratedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                        if (migratedAnnouncements && migratedAnnouncements.length > 0) {
                            announcements = migratedAnnouncements;
                        }
                        console.log('Migrated fallback announcements to Firestore');
                    }

                    // Load read announcements for current user
                    await loadReadAnnouncementsForUser();
                } catch (error) {
                    console.error('Error loading announcements from Firestore:', error);
                }
            } else {
                console.warn('Firebase not initialized, using fallback announcement data');
            }

            // Update badges after loading announcements
            updateAnnouncementsBadge();
            populateAnnouncementsDropdown();
        }

        /**
         * Load read announcements for the current user from Firebase
         */
        async function loadReadAnnouncementsForUser() {
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const userId = user?.userId || user?.id || user?.email;

            if (!userId) {
                console.warn('No user logged in, cannot load read announcements');
                return;
            }

            try {
                if (firebaseAnnouncementsManager.isInitialized) {
                    readAnnouncementIds = await firebaseAnnouncementsManager.getReadAnnouncements(userId);
                    console.log('Loaded read announcements for user:', readAnnouncementIds);
                }
            } catch (error) {
                console.error('Error loading read announcements:', error);
            }
        }

        // Update announcement badge counts in sidebar and header (only unread)
        function updateAnnouncementsBadge() {
            // Count only unread announcements
            const unreadCount = announcements.filter(ann => {
                const annId = ann.firestoreId || ann.id;
                return !readAnnouncementIds.includes(annId) && !readAnnouncementIds.includes(String(annId));
            }).length;

            // Update sidebar badge
            const sidebarBadge = document.getElementById('announcements-badge');
            if (sidebarBadge) {
                sidebarBadge.textContent = unreadCount;
                sidebarBadge.style.display = unreadCount > 0 ? 'inline-flex' : 'none';
            }

            // Update header bell badge
            const headerBadge = document.getElementById('header-announcements-badge');
            if (headerBadge) {
                headerBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                headerBadge.style.display = unreadCount > 0 ? 'inline-flex' : 'none';
            }
        }

        // Populate the announcements dropdown in the header
        function populateAnnouncementsDropdown() {
            const dropdownList = document.getElementById('announcements-dropdown-list');
            if (!dropdownList) return;

            if (announcements.length === 0) {
                dropdownList.innerHTML = `
                    <div style="padding: 24px; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-bell-slash" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p style="margin: 0;">No announcements</p>
                    </div>
                `;
                return;
            }

            // Show latest 5 announcements
            const recentAnnouncements = announcements.slice(0, 5);

            dropdownList.innerHTML = recentAnnouncements.map(ann => `
                <div class="announcement-dropdown-item" style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="navigateTo('announcements'); closeAnnouncementsDropdown();">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                        <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${ann.title}</span>
                        <span style="font-size: 11px; color: var(--text-muted); white-space: nowrap; margin-left: 8px;">${formatDate(ann.date)}</span>
                    </div>
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                        ${ann.content}
                    </p>
                </div>
            `).join('');
        }

        // Toggle announcements dropdown visibility
        async function toggleAnnouncementsDropdown() {
            const dropdown = document.getElementById('announcements-dropdown');
            if (dropdown) {
                const isOpening = !dropdown.classList.contains('active');
                dropdown.classList.toggle('active');

                // Mark all announcements as read when opening the dropdown
                if (isOpening) {
                    await markAllAnnouncementsAsRead();
                }
            }
        }

        // Mark all announcements as read for the current user
        async function markAllAnnouncementsAsRead() {
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const userId = user?.userId || user?.id || user?.email;

            if (!userId) {
                console.warn('No user logged in, cannot mark announcements as read');
                return;
            }

            // Get all announcement IDs
            const allAnnouncementIds = announcements.map(ann => String(ann.firestoreId || ann.id));

            // Filter out already read ones
            const newlyReadIds = allAnnouncementIds.filter(id =>
                !readAnnouncementIds.includes(id) && !readAnnouncementIds.includes(String(id))
            );

            if (newlyReadIds.length === 0) {
                return; // Nothing new to mark as read
            }

            try {
                if (firebaseAnnouncementsManager.isInitialized) {
                    await firebaseAnnouncementsManager.markAnnouncementsAsRead(userId, newlyReadIds);
                }

                // Update local state
                readAnnouncementIds = [...new Set([...readAnnouncementIds, ...newlyReadIds])];

                // Update badge to reflect read status
                updateAnnouncementsBadge();
            } catch (error) {
                console.error('Error marking announcements as read:', error);
            }
        }

        // Close announcements dropdown
        function closeAnnouncementsDropdown() {
            const dropdown = document.getElementById('announcements-dropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('announcements-dropdown');
            const btn = document.querySelector('.header-notification-btn');
            if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        async function initializeFirebaseRestockRequests() {
            console.log('Initializing Firebase for restock requests...');

            const initialized = await firebaseRestockRequestsManager.initialize();

            if (initialized) {
                try {
                    const firestoreRequests = await firebaseRestockRequestsManager.loadRestockRequests();

                    if (firestoreRequests && firestoreRequests.length > 0) {
                        console.log('Loaded restock requests from Firestore:', firestoreRequests);
                        restockRequests = firestoreRequests;
                    } else {
                        console.log('No restock requests in Firestore, using fallback data and migrating...');
                        // Migrate fallback data to Firebase
                        for (const request of restockRequests) {
                            await firebaseRestockRequestsManager.addRestockRequest({
                                productName: request.productName,
                                quantity: request.quantity,
                                store: request.store,
                                requestedBy: request.requestedBy,
                                requestDate: request.requestDate,
                                status: request.status,
                                priority: request.priority,
                                notes: request.notes
                            });
                        }
                        // Reload from Firestore to get IDs
                        const migratedRequests = await firebaseRestockRequestsManager.loadRestockRequests();
                        if (migratedRequests && migratedRequests.length > 0) {
                            restockRequests = migratedRequests;
                        }
                        console.log('Migrated fallback restock requests to Firestore');
                    }
                } catch (error) {
                    console.error('Error loading restock requests from Firestore:', error);
                }
            } else {
                console.warn('Firebase not initialized, using fallback restock requests data');
            }
        }

        async function initializeFirebaseChangeRecords() {
            console.log('Initializing Firebase for change records...');

            const initialized = await firebaseChangeRecordsManager.initialize();

            if (initialized) {
                try {
                    const firestoreRecords = await firebaseChangeRecordsManager.loadChangeRecords();

                    if (firestoreRecords && firestoreRecords.length > 0) {
                        console.log('Loaded change records from Firestore:', firestoreRecords);
                        changeRecords = firestoreRecords;
                    } else {
                        console.log('No change records in Firestore, using fallback data and migrating...');
                        // Migrate fallback data to Firebase
                        for (const record of changeRecords) {
                            await firebaseChangeRecordsManager.addChangeRecord({
                                store: record.store,
                                amount: record.amount,
                                date: record.date,
                                leftBy: record.leftBy,
                                receivedBy: record.receivedBy,
                                notes: record.notes,
                                photo: record.photo || null
                            });
                        }
                        // Reload from Firestore to get IDs
                        const migratedRecords = await firebaseChangeRecordsManager.loadChangeRecords();
                        if (migratedRecords && migratedRecords.length > 0) {
                            changeRecords = migratedRecords;
                        }
                        console.log('Migrated fallback change records to Firestore');
                    }
                } catch (error) {
                    console.error('Error loading change records from Firestore:', error);
                }
            } else {
                console.warn('Firebase not initialized, using fallback change records data');
            }
        }

        async function initializeFirebaseCashOut() {
            console.log('Initializing Firebase for cash out records...');

            const initialized = await firebaseCashOutManager.initialize();

            if (initialized) {
                try {
                    const firestoreRecords = await firebaseCashOutManager.loadCashOutRecords();

                    if (firestoreRecords && firestoreRecords.length > 0) {
                        console.log('Loaded cash out records from Firestore:', firestoreRecords);
                        cashOutRecords = firestoreRecords;
                    } else {
                        console.log('No cash out records in Firestore, using fallback data and migrating...');
                        // Migrate fallback data to Firebase
                        for (const record of cashOutRecords) {
                            await firebaseCashOutManager.addCashOutRecord({
                                name: record.name,
                                amount: record.amount,
                                reason: record.reason,
                                createdDate: record.createdDate,
                                createdBy: record.createdBy,
                                store: record.store || '',
                                status: record.status || 'open',
                                closedDate: record.closedDate || null,
                                receiptPhoto: record.receiptPhoto || null,
                                amountSpent: record.amountSpent || null,
                                moneyLeft: record.moneyLeft || null,
                                hasMoneyLeft: record.hasMoneyLeft || null
                            });
                        }
                        // Reload from Firestore to get IDs
                        const migratedRecords = await firebaseCashOutManager.loadCashOutRecords();
                        if (migratedRecords && migratedRecords.length > 0) {
                            cashOutRecords = migratedRecords;
                        }
                        console.log('Migrated fallback cash out records to Firestore');
                    }
                } catch (error) {
                    console.error('Error loading cash out records from Firestore:', error);
                }
            } else {
                console.warn('Firebase not initialized, using fallback cash out records data');
            }
        }

        let products = [
            { id: 1, name: 'JUUL Starter Kit', category: 'Vape Devices', quantity: 24, arrivalDate: '2025-12-10', store: 'Miramar', status: 'pending', supplier: 'JUUL Labs', price: 34.99, image: 'https://images.unsplash.com/photo-1560913210-fd4c0e4c3f75?w=400&h=300&fit=crop' },
            { id: 3, name: 'Elf Bar BC5000 - Mixed Flavors', category: 'Disposables', quantity: 120, arrivalDate: '2025-12-15', store: 'Kearny Mesa', status: 'pending', supplier: 'Elf Bar', price: 15.99, image: 'https://images.unsplash.com/photo-1530281700549-e82e7bf110d6?w=400&h=300&fit=crop' },
            { id: 4, name: 'Marlboro Red Box', category: 'Cigarettes', quantity: 200, arrivalDate: '2025-12-12', store: 'Chula Vista', status: 'pending', supplier: 'Philip Morris', price: 8.99, image: 'https://images.unsplash.com/photo-1571941736487-969c8e1d8e9f?w=400&h=300&fit=crop' },
            { id: 5, name: 'Puff Bar Plus', category: 'Disposables', quantity: 80, arrivalDate: '2025-12-07', store: 'Miramar', status: 'arrived', supplier: 'Puff Bar', price: 13.99, image: 'https://images.unsplash.com/photo-1606235727737-4c2b7a0ecab7?w=400&h=300&fit=crop' },
            { id: 6, name: 'SMOK Nord 4 Kit', category: 'Vape Devices', quantity: 15, arrivalDate: '2025-12-20', store: 'Morena', status: 'pending', supplier: 'SMOK', price: 42.99, image: 'https://images.unsplash.com/photo-1559813114-caa66ac94942?w=400&h=300&fit=crop' }
        ];

        let inventory = [
            { id: 1, brand: 'JUUL', productName: 'JUUL Starter Kit', flavor: 'Virginia Tobacco', volume: '0.7ml', nicotine: '5%', unitPrice: 34.99, minStock: 10, stock: 5, store: 'Miramar' },
            { id: 3, brand: 'Elf Bar', productName: 'BC5000', flavor: 'Blue Razz Ice', volume: '13ml', nicotine: '50mg', unitPrice: 15.99, minStock: 50, stock: 45, store: 'Kearny Mesa' },
            { id: 4, brand: 'Marlboro', productName: 'Red Box', flavor: 'Original', volume: 'N/A', nicotine: 'Full', unitPrice: 8.99, minStock: 100, stock: 80, store: 'Chula Vista' },
            { id: 5, brand: 'Puff Bar', productName: 'Puff Plus', flavor: 'Mango', volume: '3.2ml', nicotine: '50mg', unitPrice: 13.99, minStock: 30, stock: 12, store: 'Miramar' },
            { id: 6, brand: 'SMOK', productName: 'Nord 4 Kit', flavor: 'N/A', volume: 'N/A', nicotine: 'N/A', unitPrice: 42.99, minStock: 15, stock: 8, store: 'Morena' },
            { id: 7, brand: 'Newport', productName: 'Menthol', flavor: 'Menthol', volume: 'N/A', nicotine: 'Full', unitPrice: 9.49, minStock: 100, stock: 120, store: 'Miramar' },
            { id: 8, brand: 'Hyde', productName: 'Edge Rave', flavor: 'Strawberry Kiwi', volume: '10ml', nicotine: '50mg', unitPrice: 14.99, minStock: 40, stock: 25, store: 'Kearny Mesa' },
            { id: 9, brand: 'RELX', productName: 'Infinity', flavor: 'Classic Tobacco', volume: '1.9ml', nicotine: '3%', unitPrice: 39.99, minStock: 12, stock: 3, store: 'Chula Vista' },
            { id: 10, brand: 'Camel', productName: 'Blue', flavor: 'Light', volume: 'N/A', nicotine: 'Light', unitPrice: 8.49, minStock: 80, stock: 95, store: 'Morena' },
            { id: 11, brand: 'Lost Mary', productName: 'OS5000', flavor: 'Watermelon Ice', volume: '13ml', nicotine: '50mg', unitPrice: 16.99, minStock: 35, stock: 42, store: 'Miramar' },
            { id: 12, brand: 'Geek Bar', productName: 'Pulse', flavor: 'Fcuking Fab', volume: '16ml', nicotine: '50mg', unitPrice: 18.99, minStock: 25, stock: 18, store: 'Kearny Mesa' },
            { id: 13, brand: 'JUUL', productName: 'JUUL Starter Kit', flavor: 'Virginia Tobacco', volume: '0.7ml', nicotine: '5%', unitPrice: 34.99, minStock: 10, stock: 8, store: 'Morena' },
            { id: 14, brand: 'Elf Bar', productName: 'BC5000', flavor: 'Blue Razz Ice', volume: '13ml', nicotine: '50mg', unitPrice: 15.99, minStock: 50, stock: 52, store: 'Miramar' },
            { id: 15, brand: 'Marlboro', productName: 'Red Box', flavor: 'Original', volume: 'N/A', nicotine: 'Full', unitPrice: 8.99, minStock: 100, stock: 105, store: 'Miramar' },
            { id: 16, brand: 'VUSE', productName: 'Alto Pods', flavor: 'Menthol', volume: '1.8ml', nicotine: '5%', unitPrice: 12.99, minStock: 20, stock: 22, store: 'Chula Vista' }
        ];

        let restockRequests = [
            { id: 1, productName: 'JUUL Starter Kit', quantity: 20, store: 'Miramar', requestedBy: 'Marcus Rodriguez', requestDate: '2025-12-03', status: 'pending', priority: 'high', notes: 'Running low, high demand' },
            { id: 2, productName: 'Puff Bar Plus', quantity: 30, store: 'Morena', requestedBy: 'Sarah Kim', requestDate: '2025-12-02', status: 'approved', priority: 'medium', notes: 'Restock for weekend rush' },
            { id: 3, productName: 'RELX Infinity', quantity: 15, store: 'Kearny Mesa', requestedBy: 'James Thompson', requestDate: '2025-12-01', status: 'pending', priority: 'high', notes: 'Stock critically low' }
        ];

        // Treasury - Select Pieces Collection
        let treasuryItems = [
            {
                id: 1,
                artworkName: 'Vintage Tobacco Advertisement',
                artist: 'Unknown',
                acquisitionDate: '2024-03-15',
                value: 2500.00,
                location: 'VSU Kearny Mesa',
                photos: [],
                description: 'Original 1940s tobacco advertisement poster in excellent condition'
            },
            {
                id: 2,
                artworkName: 'Neon Sign Collection',
                artist: 'Custom Neon Works',
                acquisitionDate: '2023-11-20',
                value: 4800.00,
                location: 'VSU Miramar',
                photos: [],
                description: 'Set of three vintage neon signs from the 1960s'
            }
        ];

        // Cash Out Records
        let currentCashOutStoreFilter = 'all';
        let cashOutViewState = {
            viewType: 'month',
            expenseAnalysisExpanded: false
        };
        let cashOutCharts = {};
        let cashOutRecords = [
            {
                id: 1,
                name: 'Office Supplies',
                amount: 150.00,
                reason: 'Printer paper and ink cartridges',
                createdDate: '2025-12-08',
                createdBy: 'Carlos Admin',
                status: 'open',
                closedDate: null,
                receiptPhoto: null,
                amountSpent: null,
                moneyLeft: null,
                hasMoneyLeft: null
            },
            {
                id: 2,
                name: 'Store Maintenance',
                amount: 300.00,
                reason: 'Cleaning supplies and minor repairs',
                createdDate: '2025-12-05',
                createdBy: 'Marcus Rodriguez',
                status: 'closed',
                closedDate: '2025-12-06',
                receiptPhoto: null,
                amountSpent: 285.50,
                moneyLeft: 14.50,
                hasMoneyLeft: true
            },
            {
                id: 3,
                name: 'Team Lunch',
                amount: 200.00,
                reason: 'Employee appreciation lunch',
                createdDate: '2025-12-03',
                createdBy: 'Sarah Kim',
                status: 'closed',
                closedDate: '2025-12-03',
                receiptPhoto: null,
                amountSpent: 200.00,
                moneyLeft: 0.00,
                hasMoneyLeft: false
            }
        ];

        // Issues Database
        let issues = [
            {
                id: 1,
                customer: 'John Smith',
                phone: '5551234567',
                type: 'In Store',
                description: 'Customer received wrong product in their order',
                incidentDate: '2025-12-08',
                perception: 2,
                status: 'open',
                createdBy: 'Marcus Rodriguez',
                createdDate: '2025-12-08',
                solution: null,
                resolvedBy: null,
                resolutionDate: null
            },
            {
                id: 2,
                customer: 'Maria Garcia',
                phone: '5559876543',
                type: 'Online',
                description: 'Payment was charged twice for the same order',
                incidentDate: '2025-12-07',
                perception: 1,
                status: 'in_progress',
                createdBy: 'Sarah Kim',
                createdDate: '2025-12-07',
                solution: null,
                resolvedBy: null,
                resolutionDate: null
            },
            {
                id: 3,
                customer: 'Robert Johnson',
                phone: '5555551234',
                type: 'In Store',
                description: 'Product defective - vape device not working',
                incidentDate: '2025-12-05',
                perception: 4,
                status: 'resolved',
                createdBy: 'James Thompson',
                createdDate: '2025-12-05',
                solution: 'Replaced device with new unit and tested before customer left',
                resolvedBy: 'James Thompson',
                resolutionDate: '2025-12-05'
            }
        ];

        // Vendors Database
        let vendors = [
            {
                id: 1,
                name: 'VaporHub Distributors',
                category: 'Vape Products',
                contact: 'John Martinez',
                phone: '(800) 555-0101',
                email: 'sales@vaporhub.com',
                website: 'https://www.vaporhub.com',
                access: 'Online Portal - Account #VH12345',
                products: 'Disposable vapes, Pod systems, E-liquids, Accessories',
                orderMethods: 'Online portal, Phone orders, Email orders',
                notes: 'Net 30 payment terms, Free shipping over $500'
            },
            {
                id: 2,
                name: 'Premium Tobacco Supply',
                category: 'Tobacco Products',
                contact: 'Sarah Johnson',
                phone: '(800) 555-0202',
                email: 'orders@premiumtobacco.com',
                website: 'https://www.premiumtobacco.com',
                access: 'Account Manager: Sarah - Direct line (800) 555-0203',
                products: 'Cigarettes, Cigars, Rolling papers, Lighters',
                orderMethods: 'Phone orders (preferred), Email',
                notes: 'Minimum order $1000, Weekly deliveries on Thursdays'
            },
            {
                id: 3,
                name: 'Beverage Wholesale Direct',
                category: 'Beverages',
                contact: 'Mike Chen',
                phone: '(800) 555-0303',
                email: 'info@beveragewholesale.com',
                website: 'https://www.beveragewholesale.com',
                access: 'Online ordering system - Username: VSU_Admin',
                products: 'Energy drinks, Sodas, Water, Sports drinks, Coffee',
                orderMethods: 'Online portal (24/7), Phone (business hours)',
                notes: 'Next day delivery available, Volume discounts'
            },
            {
                id: 4,
                name: 'Snack Solutions Inc',
                category: 'Snacks & Candy',
                contact: 'Lisa Rodriguez',
                phone: '(800) 555-0404',
                email: 'sales@snacksolutions.com',
                website: 'https://www.snacksolutions.com',
                access: 'Rep visits monthly, Online catalog access',
                products: 'Chips, Candy bars, Gum, Cookies, Nuts',
                orderMethods: 'Mobile app, Website, Sales rep',
                notes: 'Flexible payment terms, Returns accepted'
            },
            {
                id: 5,
                name: 'General Supplies Co',
                category: 'Store Supplies',
                contact: 'David Park',
                phone: '(800) 555-0505',
                email: 'support@generalsupplies.com',
                website: 'https://www.generalsupplies.com',
                access: 'Amazon Business account linked',
                products: 'Bags, Receipt paper, Cleaning supplies, Office supplies',
                orderMethods: 'Amazon Business, Direct website, Phone',
                notes: 'Prime shipping available, Bulk discounts'
            }
        ];

        // Change Records - Cambio dejado en Campos
        let changeRecords = [
            {
                id: 1,
                store: 'Miramar',
                amount: 500.00,
                date: '2025-12-10',
                leftBy: 'Marcus Rodriguez',
                receivedBy: 'Sarah Kim',
                notes: 'Se dej贸 en caja 1',
                photo: null
            },
            {
                id: 2,
                store: 'Morena',
                amount: 300.00,
                date: '2025-12-09',
                leftBy: 'James Thompson',
                receivedBy: 'Amanda Lopez',
                notes: 'Se meti贸 extra por falta de cambio',
                photo: null
            },
            {
                id: 3,
                store: 'Kearny Mesa',
                amount: 400.00,
                date: '2025-12-08',
                leftBy: 'David Nguyen',
                receivedBy: 'Marcus Rodriguez',
                notes: '',
                photo: null
            }
        ];

        // Gifts Records - Control de Regalos en Especie
        let giftsCurrentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
        let giftsRecords = [
            {
                id: 1,
                product: 'Vape Pen SMOK Nord 4',
                quantity: 1,
                value: 45.99,
                recipient: 'Juan P茅rez',
                recipientType: 'customer',
                reason: 'Producto defectuoso - reemplazo por garant铆a',
                store: 'Miramar',
                date: '2025-12-10',
                notes: 'Cliente habitual, su vape dej贸 de funcionar despu茅s de 2 semanas',
                photo: null
            },
            {
                id: 2,
                product: 'E-Liquid 60ml Naked 100',
                quantity: 2,
                value: 39.98,
                recipient: 'Mar铆a Garc铆a',
                recipientType: 'customer',
                reason: 'Compensaci贸n por error en pedido',
                store: 'Morena',
                date: '2025-12-09',
                notes: 'Se le envi贸 sabor equivocado, se le regal贸 el correcto + el err贸neo',
                photo: null
            },
            {
                id: 3,
                product: 'Coils para Caliburn',
                quantity: 5,
                value: 24.95,
                recipient: 'Carlos L贸pez',
                recipientType: 'vendor',
                reason: 'Regalo a proveedor por colaboraci贸n',
                store: 'Kearny Mesa',
                date: '2025-12-08',
                notes: 'Proveedor nos ayud贸 con entrega urgente',
                photo: null
            }
        ];

        /**
         * Initialize Firebase and load employees from Firestore
         * This function is called when the page loads
         */
        async function initializeFirebaseEmployees() {
            console.log('Initializing Firebase for employee management...');
            
            // Initialize Firebase manager
            const initialized = await firebaseEmployeeManager.initialize();
            
            if (initialized) {
                try {
                    // Load employees from Firestore
                    const firestoreEmployees = await firebaseEmployeeManager.loadEmployees();
                    
                    if (firestoreEmployees && firestoreEmployees.length > 0) {
                        console.log('Loaded employees from Firestore:', firestoreEmployees);
                        
                        // Map Firestore data to the local employees array
                        // This maintains compatibility with existing code while loading from Firebase
                        employees = firestoreEmployees.map(emp => ({
                            id: emp.firestoreId || emp.id,
                            firestoreId: emp.firestoreId || emp.id,
                            name: emp.name || '',
                            email: emp.email || '',
                            phone: emp.phone || '',
                            store: emp.store || 'Miramar',
                            status: emp.status || 'active',
                            role: emp.role || window.EMPLOYEE_ROLES?.EMPLOYEE || 'employee', // Role from Firestore
                            employeeType: emp.employeeType || 'regular', // admin, manager, employee
                            hireDate: emp.hireDate || new Date().toISOString().split('T')[0],
                            emergencyContact: emp.emergencyContact || '',
                            allergies: emp.allergies || 'None',
                            initials: (emp.name || 'X').split(' ').map(n => n[0]).join(''),
                            color: emp.color || ['a', 'b', 'c', 'd', 'e'][Math.floor(Math.random() * 5)]
                        }));
                        
                        console.log(`Successfully loaded ${employees.length} employees from Firestore`);
                        // Update employee count badge in sidebar
                        if (typeof updateEmployeeCountBadge === 'function') {
                            updateEmployeeCountBadge();
                        }
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading employees from Firestore:', error);
                }
            } else {
                console.warn('Firebase not available. Using fallback data.');
            }

            return false;
        }

        /**
         * Save employee to Firebase
         */
        async function saveEmployeeToFirebase(employeeData) {
            if (!firebaseEmployeeManager.isInitialized) {
                console.warn('Firebase not initialized');
                return null;
            }

            try {
                if (employeeData.firestoreId) {
                    // Update existing
                    const success = await firebaseEmployeeManager.updateEmployee(
                        employeeData.firestoreId,
                        employeeData
                    );
                    return success ? employeeData.firestoreId : null;
                } else {
                    // Create new
                    const newId = await firebaseEmployeeManager.addEmployee(employeeData);
                    return newId;
                }
            } catch (error) {
                console.error('Error saving employee to Firebase:', error);
                return null;
            }
        }

        /**
         * Delete employee from Firebase
         */
        async function deleteEmployeeFromFirebase(firestoreId) {
            if (!firebaseEmployeeManager.isInitialized) {
                console.warn('Firebase not initialized');
                return false;
            }

            try {
                return await firebaseEmployeeManager.deleteEmployee(firestoreId);
            } catch (error) {
                console.error('Error deleting employee from Firebase:', error);
                return false;
            }
        }

        /**
         * Update employee role in Firebase
         */
        async function updateEmployeeRoleInFirebase(firestoreId, newRole) {
            if (!firebaseEmployeeManager.isInitialized) {
                console.warn('Firebase not initialized');
                return false;
            }

            try {
                return await firebaseEmployeeManager.updateEmployeeRole(firestoreId, newRole);
            } catch (error) {
                console.error('Error updating employee role in Firebase:', error);
                return false;
            }
        }

        // Navigation handler
        function navigateTo(page) {
            // Check if user has permission to access this page
            const user = getCurrentUser();
            const userRole = user.role || 'employee';
            const userPermissions = window.ROLE_PERMISSIONS[userRole] || window.ROLE_PERMISSIONS['employee'];
            const allowedPages = userPermissions.pages || [];
            
            // If page not in allowed list, silently deny access and return to current page
            if (!allowedPages.includes(page)) {
                console.warn(`锔 Access denied: ${userPermissions.label} role cannot access ${page}`);
                return;
            }
            
            currentPage = page;
            
            // Save current page to sessionStorage (persists on refresh, clears on tab close)
            sessionStorage.setItem('ascendance_current_page', page);
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });

            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                employees: 'Employees',
                training: 'Training Center',
                licenses: 'Licenses & Documents',
                analytics: 'Sales Analytics',
                stores: 'Store Management',
                announcements: 'Announcements',
                tasks: 'Tasks & Checklists',
                schedule: 'Schedule',
                settings: 'Settings',
                help: 'Help Center',
                thieves: 'Thieves Database',
                invoices: 'Invoices',
                issues: 'Issues Registry',
                vendors: 'Vendors & Suppliers',
                clockin: 'Clock In/Out',
                dailysales: 'Daily Sales',
                cashout: 'Expenses Control',
                treasury: 'Treasury - Select Pieces',
                gconomics: 'Gconomics',
                gforce: 'G Force',
                abundancecloud: 'Abundance Cloud',
                newstuff: 'New Stuff',
                change: 'Change',
                gifts: 'Customer Care',
                risknotes: 'Risk Notes',
                passwords: 'Password Manager',
                projectanalytics: 'Project Analytics'
            };
            document.querySelector('.page-title').textContent = titles[page] || 'Dashboard';

            // Render page content
            renderPage(page);
        }

        function renderPage(page) {
            console.log('renderPage called with:', page);
            const dashboard = document.querySelector('.dashboard');

            // Stop clock in polling when navigating away from clockin page
            if (page !== 'clockin' && typeof stopClockInPolling === 'function') {
                stopClockInPolling();
            }

            switch(page) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'employees':
                    renderEmployees();
                    break;
                case 'training':
                    renderTraining();
                    break;
                case 'licenses':
                    renderLicenses();
                    break;
                case 'analytics':
                    if (typeof renderAnalyticsWithData === 'function') { renderAnalyticsWithData(); } else { renderAnalytics(); }
                    break;
                case 'newstuff':
                    renderNewStuff();
                    break;
                case 'restock':
                    renderRestockRequests();
                    break;
                case 'abundancecloud':
                    renderAbundanceCloud();
                    break;
                case 'stores':
                    renderStores();
                    break;
                case 'announcements':
                    renderAnnouncements();
                    break;
                case 'schedule':
                    renderSchedule();
                    break;
                case 'thieves':
                    renderThieves();
                    break;
                case 'invoices':
                    renderInvoices();
                    break;
                case 'issues':
                    renderIssues();
                    break;
                case 'gconomics':
                    renderGconomics();
                    break;
                case 'vendors':
                    renderVendors();
                    break;
                case 'clockin':
                    renderClockIn();
                    break;
                case 'dailysales':
                    renderDailySales();
                    break;
                case 'cashout':
                    renderCashOut();
                    break;
                case 'treasury':
                    renderTreasury();
                    break;
                case 'change':
                    renderChange();
                    break;
                case 'gifts':
                    renderGifts();
                    break;
                case 'gforce':
                    renderGForce();
                    break;
                case 'risknotes':
                    renderRiskNotes();
                    break;
                case 'passwords':
                    renderPasswordManager();
                    break;
                case 'projectanalytics':
                    renderProjectAnalytics();
                    break;
                default:
                    renderDashboard();
            }
        }

        function renderDashboard() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon purple"><i class="fas fa-users"></i></div>
                            <div class="stat-trend up"><i class="fas fa-arrow-up"></i> +2</div>
                        </div>
                        <div class="stat-value">${employees.length}</div>
                        <div class="stat-label">Total Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
                            <div class="stat-trend up"><i class="fas fa-arrow-up"></i> +12.5%</div>
                        </div>
                        <div class="stat-value">$48.2K</div>
                        <div class="stat-label">Monthly Revenue</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue"><i class="fas fa-file-alt"></i></div>
                            <div class="stat-trend down"><i class="fas fa-exclamation"></i> 2 expiring</div>
                        </div>
                        <div class="stat-value">${licenses.length}</div>
                        <div class="stat-label">Active Licenses</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <a href="#" class="quick-action" onclick="navigateTo('employees'); setTimeout(() => openModal('add-employee'), 100); return false;">
                        <div class="quick-action-icon"><i class="fas fa-user-plus"></i></div>
                        <span class="quick-action-label">Add Employee</span>
                    </a>
                    <a href="#" class="quick-action" onclick="navigateTo('training'); setTimeout(() => openModal('add-training'), 100); return false;">
                        <div class="quick-action-icon"><i class="fas fa-video"></i></div>
                        <span class="quick-action-label">Upload Training</span>
                    </a>
                    <a href="#" class="quick-action" onclick="navigateTo('licenses'); setTimeout(() => openModal('add-license'), 100); return false;">
                        <div class="quick-action-icon"><i class="fas fa-file-upload"></i></div>
                        <span class="quick-action-label">Add License</span>
                    </a>
                    <a href="#" class="quick-action" onclick="navigateTo('analytics'); return false;">
                        <div class="quick-action-icon"><i class="fas fa-chart-bar"></i></div>
                        <span class="quick-action-label">View Reports</span>
                    </a>
                </div>

                <!-- Cards Grid -->
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-users"></i> Recent Employees</h3>
                            <button class="card-action" onclick="navigateTo('employees')">View All</button>
                        </div>
                        <div class="card-body">
                            <div class="employee-list">
                                ${employees.slice(0, 5).map(emp => `
                                    <div class="employee-item" onclick="viewEmployee('${emp.id}')">
                                        <div class="employee-avatar ${emp.color}">${emp.initials}</div>
                                        <div class="employee-info">
                                            <div class="employee-name">${emp.name}</div>
                                            <div class="employee-role">${emp.role}</div>
                                        </div>
                                        <span class="employee-store">${emp.store}</span>
                                        <div class="employee-status ${emp.status}"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    
                </div>

                <!-- Bottom Grid -->
                <div class="bottom-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-trophy"></i> Store Performance</h3>
                            <button class="card-action" onclick="navigateTo('analytics')">Details</button>
                        </div>
                        <div class="card-body">
                            <div class="store-performance">
                                <div class="store-item">
                                    <div class="store-rank first">1</div>
                                    <div class="store-details">
                                        <div class="store-name">VSU Miramar</div>
                                        <div class="store-sales">142 orders this week</div>
                                    </div>
                                    <div class="store-amount">$15,420</div>
                                </div>
                                <div class="store-item">
                                    <div class="store-rank second">2</div>
                                    <div class="store-details">
                                        <div class="store-name">VSU Kearny Mesa</div>
                                        <div class="store-sales">118 orders this week</div>
                                    </div>
                                    <div class="store-amount">$12,890</div>
                                </div>
                                <div class="store-item">
                                    <div class="store-rank third">3</div>
                                    <div class="store-details">
                                        <div class="store-name">VSU Chula Vista</div>
                                        <div class="store-sales">96 orders this week</div>
                                    </div>
                                    <div class="store-amount">$10,340</div>
                                </div>
                                <div class="store-item">
                                    <div class="store-rank fourth">4</div>
                                    <div class="store-details">
                                        <div class="store-name">VSU Morena</div>
                                        <div class="store-sales">87 orders this week</div>
                                    </div>
                                    <div class="store-amount">$9,550</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-file-certificate"></i> Licenses Status</h3>
                            <button class="card-action" onclick="navigateTo('licenses')">Upload</button>
                        </div>
                        <div class="card-body">
                            <div class="licenses-grid">
                                ${licenses.slice(0, 4).map(lic => `
                                    <div class="license-card">
                                        <div class="license-icon ${lic.status}">
                                            <i class="fas fa-${lic.status === 'valid' ? 'check-circle' : 'clock'}"></i>
                                        </div>
                                        <div class="license-info">
                                            <div class="license-name">${lic.name} - ${lic.store}</div>
                                            <div class="license-meta">Expires: ${formatDate(lic.expires)}</div>
                                        </div>
                                        <span class="license-status ${lic.status}">${lic.status.charAt(0).toUpperCase() + lic.status.slice(1)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bullhorn"></i> Recent Announcements</h3>
                            <button class="card-action" onclick="navigateTo('announcements')">Post New</button>
                        </div>
                        <div class="card-body">
                            <div class="announcement-list">
                                ${announcements.map(ann => `
                                    <div class="announcement-item">
                                        <div class="announcement-date">${formatDate(ann.date)}</div>
                                        <div class="announcement-text">${ann.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderEmployees() {
            const dashboard = document.querySelector('.dashboard');

            // Show loading state first
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Employee Directory</h2>
                        <p class="section-subtitle">Manage your team across all stores</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="openInactiveEmployeesModal()" title="View Inactive Employees">
                            <i class="fas fa-user-slash"></i> Inactive
                        </button>
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-employee')">
                            <i class="fas fa-plus"></i> Add Employee
                        </button>
                    </div>
                </div>

                <div class="filters-bar">
                    <div class="search-filter">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search employees..." id="employee-search" onkeyup="filterEmployees()">
                    </div>
                    <select class="filter-select" id="store-filter" onchange="filterEmployees()">
                        <option value="">All Stores</option>
                        <option value="Miramar">VSU Miramar</option>
                        <option value="Morena">VSU Morena</option>
                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                        <option value="Chula Vista">VSU Chula Vista</option>
                        <option value="North Park">VSU North Park</option>
                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                    </select>
                    <select class="filter-select" id="status-filter" onchange="filterEmployees()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <button class="btn-secondary" onclick="refreshEmployeesFromFirebase()" title="Refresh from database">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div class="employees-grid" id="employees-grid">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading employees...</p>
                    </div>
                </div>
            `;

            // Load employees from Firebase
            await loadEmployeesFromFirebase();

            // Render employees grid
            const grid = document.getElementById('employees-grid');
            if (grid) {
                if (employees.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No employees yet</h3>
                            <p>Add your first employee to get started</p>
                            <button class="btn-primary" onclick="openModal('add-employee')">
                                <i class="fas fa-plus"></i> Add Employee
                            </button>
                        </div>
                    `;
                } else {
                    grid.innerHTML = employees.map(emp => renderEmployeeCard(emp)).join('');
                }
            }
        }

        /**
         * Load employees from Firebase and update local array
         */
        async function loadEmployeesFromFirebase() {
            if (!firebaseEmployeeManager.isInitialized) {
                await firebaseEmployeeManager.initialize();
            }

            if (firebaseEmployeeManager.isInitialized) {
                try {
                    const firestoreEmployees = await firebaseEmployeeManager.loadEmployees();
                    if (firestoreEmployees && firestoreEmployees.length > 0) {
                        employees = firestoreEmployees.map(emp => ({
                            id: emp.firestoreId || emp.id,
                            firestoreId: emp.firestoreId || emp.id,
                            name: emp.name || '',
                            email: emp.email || '',
                            authEmail: emp.authEmail || emp.email || '',
                            phone: emp.phone || '',
                            store: emp.store || 'Miramar',
                            status: emp.status || 'active',
                            role: emp.role || 'Sales Associate',
                            employeeType: emp.employeeType || 'employee',
                            hireDate: emp.hireDate || new Date().toISOString().split('T')[0],
                            emergencyContact: emp.emergencyContact || '',
                            allergies: emp.allergies || 'None',
                            initials: (emp.name || 'XX').split(' ').map(n => n[0] || '').join('').substring(0, 2).toUpperCase(),
                            color: emp.color || ['a', 'b', 'c', 'd', 'e'][Math.floor(Math.random() * 5)],
                            offboarding: emp.offboarding || null
                        }));
                        console.log(`Loaded ${employees.length} employees from Firebase`);
                        // Update employee count badge in sidebar
                        updateEmployeeCountBadge();
                    }

                } catch (error) {
                    console.error('Error loading employees from Firebase:', error);
                }
            }
        }

        /**
         * Update the employee count badge in the sidebar
         */
        function updateEmployeeCountBadge() {
            const badge = document.getElementById('employees-count-badge');
            if (badge) {
                badge.textContent = employees.length;
                badge.style.display = employees.length > 0 ? 'inline-flex' : 'none';
            }
        }

        /**
         * Refresh employees from Firebase (manual refresh button)
         */
        async function refreshEmployeesFromFirebase() {
            const grid = document.getElementById('employees-grid');
            if (grid) {
                grid.innerHTML = `
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Refreshing...</p>
                    </div>
                `;
            }

            await loadEmployeesFromFirebase();

            if (grid) {
                grid.innerHTML = employees.map(emp => renderEmployeeCard(emp)).join('');
            }
        }

        function renderEmployeeCard(emp) {
            // Get role badge color based on employeeType
            const getRoleColor = () => {
                const colors = {
                    'admin': '#ef4444',      // Red
                    'manager': '#f59e0b',    // Amber
                    'employee': '#3b82f6'    // Blue
                };
                return colors[emp.employeeType] || '#6b7280';
            };

            const getRoleIcon = () => {
                const icons = {
                    'admin': 'crown',
                    'manager': 'chart-bar',
                    'employee': 'user'
                };
                return icons[emp.employeeType] || 'user';
            };

            const getRoleLabel = () => {
                const labels = {
                    'admin': 'Administrator',
                    'manager': 'Manager',
                    'employee': 'Employee'
                };
                return labels[emp.employeeType] || 'Employee';
            };

            const empId = emp.firestoreId || emp.id;
            return `
                <div class="employee-card" onclick="viewEmployee('${empId}')">
                    <div class="employee-card-header">
                        <div class="employee-avatar-lg ${emp.color}">${emp.initials}</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div class="employee-status-badge ${emp.status}">${emp.status}</div>
                            <div class="badge" style="background: ${getRoleColor()}; color: white; font-size: 11px; padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-${getRoleIcon()}"></i>
                                ${getRoleLabel()}
                            </div>
                        </div>
                    </div>
                    <div class="employee-card-body">
                        <h3 class="employee-card-name">${emp.name}</h3>
                        <p class="employee-card-role">${emp.role}</p>
                        <div class="employee-card-store">
                            <i class="fas fa-store"></i> ${emp.store}
                        </div>
                        <div class="employee-card-meta">
                            <span><i class="fas fa-envelope"></i> ${emp.email}</span>
                            <span><i class="fas fa-phone"></i> ${emp.phone}</span>
                        </div>
                    </div>
                    <div class="employee-card-footer">
                        <button class="btn-icon" onclick="event.stopPropagation(); viewEmployeePaperwork('${empId}')" title="View Documents"><i class="fas fa-file-pdf"></i></button>
                        ${emp.status === 'inactive' && emp.offboarding ? `
                            <button class="btn-icon" onclick="event.stopPropagation(); viewOffboardingDetails('${empId}')" title="View Offboarding Info" style="color: #ef4444;"><i class="fas fa-user-minus"></i></button>
                        ` : ''}
                        <button class="btn-icon" onclick="event.stopPropagation(); editEmployee('${empId}')"><i class="fas fa-edit"></i></button>
                        ${emp.status === 'inactive' ? `
                            <button class="btn-icon success" onclick="event.stopPropagation(); activateEmployee('${empId}')" title="Activate Employee"><i class="fas fa-check"></i></button>
                        ` : `
                            <button class="btn-icon danger" onclick="event.stopPropagation(); deleteEmployee('${empId}')"><i class="fas fa-trash"></i></button>
                        `}
                    </div>
                </div>
            `;
        }

        /**
         * Get color for document type
         */
        function getDocumentColor(fileType) {
            if (!fileType) return '#6b7280';
            if (fileType.includes('pdf')) return '#ef4444';
            if (fileType.includes('word') || fileType.includes('doc')) return '#3b82f6';
            if (fileType.includes('image') || fileType.includes('jpg') || fileType.includes('jpeg') || fileType.includes('png')) return '#10b981';
            return '#6b7280';
        }

        /**
         * Download document
         */
        function downloadDocument(url, fileName) {
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function renderTraining() {
            const dashboard = document.querySelector('.dashboard');

            // Show loading state
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Training Center</h2>
                        <p class="section-subtitle">Videos, documents, and courses for your team</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-training')">
                        <i class="fas fa-plus"></i> Add Training
                    </button>
                </div>
                <div style="text-align: center; padding: 60px 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--accent-primary);"></i>
                    <p style="color: var(--text-muted); margin-top: 16px;">Loading training materials...</p>
                </div>
            `;

            // Load trainings from Firebase
            await loadTrainingsFromFirebase();

            // Calculate mandatory training compliance
            const mandatoryTrainings = trainings.filter(t => t.required);
            const totalEmployees = employees.length;
            const employeesCompliantCount = employees.filter(emp => {
                return mandatoryTrainings.every(training => {
                    const completions = training.completions || [];
                    return completions.some(c => c.employeeId === (emp.firestoreId || emp.id));
                });
            }).length;
            const compliancePercentage = totalEmployees > 0 ? Math.round((employeesCompliantCount / totalEmployees) * 100) : 0;

            // Render the trainings grid
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Training Center</h2>
                        <p class="section-subtitle">Videos, documents, and courses for your team</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-training')">
                        <i class="fas fa-plus"></i> Add Training
                    </button>
                </div>

                ${mandatoryTrainings.length > 0 ? `
                    <!-- Mandatory Training Compliance -->
                    <div class="card" style="margin-bottom: 24px; border-left: 4px solid ${compliancePercentage === 100 ? '#10b981' : '#ef4444'};">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">
                                    <i class="fas fa-exclamation-circle" style="color: ${compliancePercentage === 100 ? '#10b981' : '#ef4444'};"></i>
                                    Mandatory Training Compliance
                                </h3>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted);">
                                    ${mandatoryTrainings.length} mandatory course${mandatoryTrainings.length !== 1 ? 's' : ''}  ${employeesCompliantCount} of ${totalEmployees} employees fully compliant
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 32px; font-weight: 700; color: ${compliancePercentage === 100 ? '#10b981' : '#ef4444'};">${compliancePercentage}%</div>
                                <button class="btn-secondary" style="margin-top: 8px;" onclick="viewMandatoryTrainingCompliance()">
                                    <i class="fas fa-chart-bar"></i> View Details
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${trainings.length === 0 ? `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-graduation-cap" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 16px;">No training materials yet</div>
                        <div style="font-size: 14px; margin-top: 8px;">Click "Add Training" to create your first training material</div>
                    </div>
                ` : `
                    <div class="training-grid">
                        ${trainings.map(t => `
                            <div class="training-card" onclick="${t.type === 'video' ? `playTrainingVideo('${t.id}')` : `viewTraining('${t.id}')`}" style="cursor: pointer;">
                                <div class="training-card-thumbnail ${t.type}">
                                    <i class="fas fa-${t.type === 'video' ? 'play-circle' : 'file-pdf'}"></i>
                                </div>
                                <div class="training-card-body">
                                    <div class="training-card-type">${(t.type || 'document').toUpperCase()}</div>
                                    <h3 class="training-card-title">${t.title}</h3>
                                    <div class="training-card-meta">
                                        <span><i class="fas fa-clock"></i> ${t.duration || '30 min'}</span>
                                        <span class="${t.required ? 'required' : ''}"><i class="fas fa-${t.required ? 'exclamation-circle' : 'check'}"></i> ${t.required ? 'Required' : 'Optional'}</span>
                                    </div>
                                    ${t.fileName ? `
                                        <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                                            <i class="fas fa-file-pdf"></i> ${t.fileName}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="training-card-footer">
                                    <button class="btn-secondary" onclick="event.stopPropagation(); viewTraining('${t.id}')">View Details</button>
                                    <button class="btn-icon" onclick="event.stopPropagation(); editTraining('${t.id}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn-icon danger" onclick="event.stopPropagation(); deleteTraining('${t.id}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            `;
        }

        function renderLicenses() {
            const stores = ['Miramar', 'Miramar Wine & Liquor', 'Morena', 'Kearny Mesa', 'Chula Vista', 'North Park'];

            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Licenses & Documents</h2>
                        <div style="display: flex; align-items: center; gap: 16px; margin-top: 12px;">
                            <p class="section-subtitle">Drag and drop documents between stores</p>
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-size: 13px; font-weight: 500; color: var(--text-secondary);">Edit Mode:</span>
                                <button onclick="toggleLicensesEditMode()" style="background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center;">
                                    <div style="width: 44px; height: 24px; background: ${licensesEditMode ? '#10b981' : '#ef4444'}; border-radius: 12px; position: relative; transition: background 0.3s;">
                                        <div style="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; ${licensesEditMode ? 'right: 2px;' : 'left: 2px;'} transition: all 0.3s;"></div>
                                    </div>
                                </button>
                                <span style="font-size: 12px; color: ${licensesEditMode ? '#10b981' : '#ef4444'}; font-weight: 600; min-width: 60px;">${licensesEditMode ? ' EDITABLE' : ' LOCKED'}</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="openModal('add-license')">
                        <i class="fas fa-plus"></i> Add Document
                    </button>
                </div>

                <div class="license-summary">
                    <div class="license-summary-card valid">
                        <i class="fas fa-check-circle"></i>
                        <span class="count">${licenses.filter(l => l.status === 'valid').length}</span>
                        <span class="label">Valid</span>
                    </div>
                    <div class="license-summary-card expiring">
                        <i class="fas fa-clock"></i>
                        <span class="count">${licenses.filter(l => l.status === 'expiring').length}</span>
                        <span class="label">Expiring Soon</span>
                    </div>
                    <div class="license-summary-card expired">
                        <i class="fas fa-times-circle"></i>
                        <span class="count">${licenses.filter(l => l.status === 'expired').length}</span>
                        <span class="label">Expired</span>
                    </div>
                </div>

                <div class="license-stores-grid">
                    ${stores.map(store => {
                        const storeLicenses = licenses.filter(l => l.store === store);
                        return `
                            <div class="license-store-zone"
                                 data-store="${store}"
                                 ondrop="handleLicenseDrop(event, '${store}')"
                                 ondragover="handleLicenseDragOver(event)"
                                 ondragleave="handleLicenseDragLeave(event)">
                                <div class="license-store-header">
                                    <div class="license-store-title">
                                        <i class="fas fa-store"></i>
                                        <span>VSU ${store}</span>
                                    </div>
                                    <div class="license-store-count">
                                        <span class="count-badge">${storeLicenses.length}</span>
                                    </div>
                                </div>
                                <div class="license-drop-area">
                                    ${storeLicenses.length === 0 ? `
                                        <div class="license-empty-state">
                                            <i class="fas fa-file-upload"></i>
                                            <span>Drop documents here</span>
                                        </div>
                                    ` : ''}
                                    ${storeLicenses.map(lic => `
                                        <div class="license-item"
                                             draggable="${licensesEditMode ? 'true' : 'false'}"
                                             data-license-id="${lic.id}"
                                             ondragstart="handleLicenseDragStart(event, '${lic.id}')"
                                             style="cursor: ${licensesEditMode ? 'grab' : 'default'}; opacity: ${licensesEditMode ? '1' : '0.85'}; ${!licensesEditMode ? 'pointer-events: none;' : ''}">
                                            <div class="license-item-header">
                                                <div class="license-item-name">
                                                    <i class="fas fa-file-pdf"></i>
                                                    <span>${lic.name}</span>
                                                </div>
                                                <div class="license-item-status">
                                                    <div class="status-dot ${lic.status}" title="${lic.status}"></div>
                                                </div>
                                            </div>
                                            <div class="license-item-footer">
                                                <span class="license-expires">
                                                    <i class="fas fa-calendar"></i>
                                                    ${formatDate(lic.expires)}
                                                </span>
                                                <div class="license-item-actions">
                                                    <button class="btn-icon-sm" onclick="event.stopPropagation(); viewLicense('${lic.id}')" title="View${lic.fileData ? ' PDF' : ''}">
                                                        <i class="fas ${lic.fileData ? 'fa-file-pdf' : 'fa-eye'}"></i>
                                                    </button>
                                                    <button class="btn-icon-sm" onclick="event.stopPropagation(); deleteLicense('${lic.id}')" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderAnalytics() {
            const dashboard = document.querySelector('.dashboard');

            // Calculate real totals from Cash Out records
            const totalCashOut = cashOutRecords.reduce((sum, r) => sum + (r.amount || 0), 0);

            // Monthly data for Income vs Expenses chart (sample data - would come from Shopify/POS in production)
            const monthlyData = [
                { month: 'Jan', income: 42500, expenses: 8200 },
                { month: 'Feb', income: 38900, expenses: 7500 },
                { month: 'Mar', income: 45200, expenses: 9100 },
                { month: 'Apr', income: 41800, expenses: 8400 },
                { month: 'May', income: 48600, expenses: 9800 },
                { month: 'Jun', income: 52100, expenses: 10200 },
                { month: 'Jul', income: 49800, expenses: 9600 },
                { month: 'Aug', income: 54300, expenses: 10800 },
                { month: 'Sep', income: 51200, expenses: 10100 },
                { month: 'Oct', income: 56800, expenses: 11200 },
                { month: 'Nov', income: 62400, expenses: 12100 },
                { month: 'Dec', income: 68500, expenses: 13500 }
            ];

            // Calculate totals
            const totalIncome = monthlyData.reduce((sum, m) => sum + m.income, 0);
            const totalExpenses = monthlyData.reduce((sum, m) => sum + m.expenses, 0);
            const netProfit = totalIncome - totalExpenses;
            const profitMargin = ((netProfit / totalIncome) * 100).toFixed(1);

            // Find max values for chart scaling
            const maxIncome = Math.max(...monthlyData.map(m => m.income));

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Sales Analytics</h2>
                        <p class="section-subtitle">Performance insights - Annual totals and monthly breakdown</p>
                    </div>
                    <div class="date-range-picker">
                        <button class="date-btn active">2025</button>
                        <button class="date-btn">2024</button>
                        <button class="date-btn">Custom</button>
                    </div>
                </div>

                <!-- Annual Totals -->
                <div class="analytics-grid">
                    <div class="analytics-card revenue">
                        <div class="analytics-card-header">
                            <h3>Total Annual Revenue</h3>
                            <span class="trend up"><i class="fas fa-arrow-up"></i> 18.2%</span>
                        </div>
                        <div class="analytics-value">$${(totalIncome / 1000).toFixed(1)}K</div>
                        <div class="analytics-comparison">
                            <span>All stores combined</span>
                        </div>
                    </div>

                    <div class="analytics-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <div class="analytics-card-header">
                            <h3 style="color: white;">Total Expenses</h3>
                            <span class="trend" style="background: rgba(255,255,255,0.2); color: white;"><i class="fas fa-chart-line"></i></span>
                        </div>
                        <div class="analytics-value" style="color: white;">$${(totalExpenses / 1000).toFixed(1)}K</div>
                        <div class="analytics-comparison" style="color: rgba(255,255,255,0.8);">
                            <span>Cash outs: $${totalCashOut.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>

                    <div class="analytics-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div class="analytics-card-header">
                            <h3 style="color: white;">Net Profit</h3>
                            <span class="trend" style="background: rgba(255,255,255,0.2); color: white;"><i class="fas fa-arrow-up"></i> ${profitMargin}%</span>
                        </div>
                        <div class="analytics-value" style="color: white;">$${(netProfit / 1000).toFixed(1)}K</div>
                        <div class="analytics-comparison" style="color: rgba(255,255,255,0.8);">
                            <span>Profit margin: ${profitMargin}%</span>
                        </div>
                    </div>

                    <div class="analytics-card orders">
                        <div class="analytics-card-header">
                            <h3>Total Orders</h3>
                            <span class="trend up"><i class="fas fa-arrow-up"></i> 12.5%</span>
                        </div>
                        <div class="analytics-value">5,842</div>
                        <div class="analytics-breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Avg/Month</span>
                                <span class="breakdown-value">487</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Income vs Expenses Chart -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Income vs Expenses by Month</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 24px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 4px;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Income</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 4px;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Expenses</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 3px; background: #10b981; border-radius: 2px;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Net Profit</span>
                            </div>
                        </div>

                        <div style="display: flex; align-items: flex-end; gap: 12px; height: 250px; padding: 20px 0; border-bottom: 2px solid var(--border-color);">
                            ${monthlyData.map(m => {
                                const incomeHeight = (m.income / maxIncome) * 100;
                                const expenseHeight = (m.expenses / maxIncome) * 100;
                                const profit = m.income - m.expenses;
                                const profitPercent = ((profit / m.income) * 100).toFixed(0);
                                return `
                                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div style="font-size: 11px; color: #10b981; font-weight: 600;">+${profitPercent}%</div>
                                        <div style="display: flex; gap: 4px; align-items: flex-end; height: 180px;">
                                            <div style="width: 20px; height: ${incomeHeight}%; background: linear-gradient(180deg, #6366f1, #8b5cf6); border-radius: 4px 4px 0 0; transition: height 0.3s;" title="Income: $${m.income.toLocaleString()}"></div>
                                            <div style="width: 20px; height: ${expenseHeight}%; background: linear-gradient(180deg, #ef4444, #dc2626); border-radius: 4px 4px 0 0; transition: height 0.3s;" title="Expenses: $${m.expenses.toLocaleString()}"></div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-muted); font-weight: 500;">${m.month}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Monthly Summary Table -->
                        <div style="margin-top: 20px; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: var(--bg-secondary);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Month</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Income</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Expenses</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Net Profit</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Margin</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${monthlyData.map(m => {
                                        const profit = m.income - m.expenses;
                                        const margin = ((profit / m.income) * 100).toFixed(1);
                                        return `
                                            <tr>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); font-weight: 500;">${m.month}</td>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: var(--accent-primary);">$${m.income.toLocaleString()}</td>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: #ef4444;">$${m.expenses.toLocaleString()}</td>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: #10b981; font-weight: 600;">$${profit.toLocaleString()}</td>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right;">
                                                    <span style="padding: 4px 8px; background: ${parseFloat(margin) > 80 ? '#10b98120' : '#f59e0b20'}; color: ${parseFloat(margin) > 80 ? '#10b981' : '#f59e0b'}; border-radius: 12px; font-size: 12px; font-weight: 600;">${margin}%</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr style="background: var(--bg-secondary); font-weight: 700;">
                                        <td style="padding: 12px;">TOTAL</td>
                                        <td style="padding: 12px; text-align: right; color: var(--accent-primary);">$${totalIncome.toLocaleString()}</td>
                                        <td style="padding: 12px; text-align: right; color: #ef4444;">$${totalExpenses.toLocaleString()}</td>
                                        <td style="padding: 12px; text-align: right; color: #10b981;">$${netProfit.toLocaleString()}</td>
                                        <td style="padding: 12px; text-align: right;">${profitMargin}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="analytics-stores">
                    <h3 class="section-subtitle-alt">Store Performance Comparison (Annual)</h3>
                    <div class="store-bars">
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU Miramar</span>
                                <span>$185,040</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill miramar" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU Kearny Mesa</span>
                                <span>$154,680</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill kearny" style="width: 83%;"></div>
                            </div>
                        </div>
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU Chula Vista</span>
                                <span>$124,080</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill chula" style="width: 67%;"></div>
                            </div>
                        </div>
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU Morena</span>
                                <span>$114,600</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill morena" style="width: 62%;"></div>
                            </div>
                        </div>
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU North Park</span>
                                <span>$33,700</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill" style="width: 18%; background: linear-gradient(90deg, #14b8a6, #0d9488);"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shopify-connect">
                    <div class="shopify-icon"><i class="fab fa-shopify"></i></div>
                    <div class="shopify-text">
                        <h4>Connect to Shopify</h4>
                        <p>Sync real-time sales data from your stores</p>
                    </div>
                    <button class="btn-primary">Connect Store</button>
                </div>
            `;
        }

        function renderStores() {
            const stores = [
                { name: 'VSU Miramar', address: '8250 Camino Santa Fe, San Diego, CA 92121', manager: 'Marcus Rodriguez', employees: 6, status: 'open', isHQ: true },
                { name: 'VSU Morena', address: '5050 Morena Blvd, San Diego, CA 92117', manager: 'Sarah Kim', employees: 5, status: 'open', isHQ: false },
                { name: 'VSU Kearny Mesa', address: '4747 Convoy St, San Diego, CA 92111', manager: 'James Thompson', employees: 5, status: 'open', isHQ: false },
                { name: 'VSU Chula Vista', address: '555 Broadway, Chula Vista, CA 91910', manager: 'Amanda Lopez', employees: 4, status: 'open', isHQ: false },
                { name: 'VSU North Park', address: '3000 University Ave, San Diego, CA 92104', manager: 'Pending', employees: 3, status: 'open', isHQ: false }
            ];

            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Store Management</h2>
                        <p class="section-subtitle">Manage your VSU locations</p>
                    </div>
                </div>

                <div class="stores-grid">
                    ${stores.map(store => `
                        <div class="store-card ${store.isHQ ? 'hq' : ''}">
                            ${store.isHQ ? '<div class="hq-badge">HEADQUARTERS</div>' : ''}
                            <div class="store-card-header">
                                <h3>${store.name}</h3>
                                <span class="store-status ${store.status}">${store.status}</span>
                            </div>
                            <div class="store-card-body">
                                <div class="store-info-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${store.address}</span>
                                </div>
                                <div class="store-info-row">
                                    <i class="fas fa-user-tie"></i>
                                    <span>Manager: ${store.manager}</span>
                                </div>
                                <div class="store-info-row">
                                    <i class="fas fa-users"></i>
                                    <span>${store.employees} Employees</span>
                                </div>
                            </div>
                            <div class="store-card-footer">
                                <button class="btn-secondary">View Details</button>
                                <button class="btn-icon"><i class="fas fa-edit"></i></button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAnnouncements() {
            const dashboard = document.querySelector('.dashboard');

            // Get current user for author info
            const user = authManager.getCurrentUser();
            const authorName = user?.name || user?.email?.split('@')[0] || 'Unknown';
            const authorInitials = authorName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Announcements</h2>
                        <p class="section-subtitle">Company-wide communications</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-announcement')">
                            <i class="fas fa-plus"></i> New Announcement
                        </button>
                    </div>
                </div>

                <div class="announcements-list">
                    <div class="announcement-card" style="border: 2px dashed var(--border-color); background: var(--bg-secondary);">
                        <div class="announcement-card-header">
                            <div class="announcement-author">
                                <div class="author-avatar">${authorInitials}</div>
                                <div class="author-info">
                                    <span class="author-name">${authorName}</span>
                                    <span class="announcement-date">New Announcement</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <input type="text" class="form-input" id="new-announcement-title" placeholder="Announcement title..." style="font-size: 16px; font-weight: 600;">
                        </div>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <textarea class="form-input" id="new-announcement-content" placeholder="Write your announcement here..." style="min-height: 80px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; justify-content: flex-end;">
                            <button class="btn-primary" onclick="saveAnnouncementInline()">
                                <i class="fas fa-paper-plane"></i> Post Announcement
                            </button>
                        </div>
                    </div>

                    ${announcements.map(ann => {
                        const annAuthorInitials = (ann.author || 'UN').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        const annId = ann.firestoreId || ann.id;
                        return `
                        <div class="announcement-card" data-id="${annId}">
                            <div class="announcement-card-header">
                                <div class="announcement-author">
                                    <div class="author-avatar">${annAuthorInitials}</div>
                                    <div class="author-info">
                                        <span class="author-name">${ann.author}</span>
                                        <span class="announcement-date">${formatDate(ann.date)}</span>
                                    </div>
                                </div>
                                <div class="announcement-actions">
                                    <button class="btn-icon" onclick="editAnnouncement('${annId}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn-icon danger" onclick="deleteAnnouncement('${annId}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <h3 class="announcement-title">${ann.title}</h3>
                            <p class="announcement-content">${ann.content}</p>
                            ${ann.targetStores && ann.targetStores !== 'all' ? `<div class="announcement-stores" style="margin-top: 8px; font-size: 12px; color: var(--text-muted);"><i class="fas fa-store"></i> ${ann.targetStores}</div>` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        /**
         * Delete announcement from Firebase
         */
        function deleteAnnouncement(announcementId) {
            const announcement = announcements.find(a => a.id === announcementId || a.firestoreId === announcementId);
            const title = announcement?.title || 'this announcement';

            showConfirmModal({
                title: 'Delete Announcement',
                message: `Are you sure you want to delete "${title}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        if (firebaseAnnouncementsManager.isInitialized) {
                            const success = await firebaseAnnouncementsManager.deleteAnnouncement(announcementId);
                            if (success) {
                                // Reload announcements from Firebase
                                const updatedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                                announcements = updatedAnnouncements || [];
                                console.log('Announcement deleted from Firebase');
                            }
                        } else {
                            // Fallback to local deletion
                            announcements = announcements.filter(a => a.id !== announcementId && a.firestoreId !== announcementId);
                        }

                        renderAnnouncements();
                        updateAnnouncementsBadge();
                        populateAnnouncementsDropdown();
                    } catch (error) {
                        console.error('Error deleting announcement:', error);
                    }
                }
            });
        }

        /**
         * Edit announcement - opens modal with pre-filled data
         */
        function editAnnouncement(announcementId) {
            const announcement = announcements.find(a => a.id === announcementId || a.firestoreId === announcementId);
            if (!announcement) {
                alert('Announcement not found');
                return;
            }

            // Open modal with edit content
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Edit Announcement</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" class="form-input" id="edit-announcement-title" value="${announcement.title}" placeholder="Announcement title...">
                    </div>
                    <div class="form-group">
                        <label>Message *</label>
                        <textarea class="form-input" id="edit-announcement-content" rows="5" placeholder="Write your announcement...">${announcement.content}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Target Stores</label>
                        <select class="form-input" id="edit-announcement-stores">
                            <option value="all" ${announcement.targetStores === 'all' ? 'selected' : ''}>All Stores</option>
                            <option value="Miramar" ${announcement.targetStores === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                            <option value="Morena" ${announcement.targetStores === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                            <option value="Kearny Mesa" ${announcement.targetStores === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                            <option value="Chula Vista" ${announcement.targetStores === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                            <option value="North Park" ${announcement.targetStores === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                            <option value="Santee" ${announcement.targetStores === 'Santee' ? 'selected' : ''}>VSU Santee</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn-primary" onclick="updateAnnouncement('${announcementId}')">Update Announcement</button>
                </div>
            `;

            modal.classList.add('active');
        }

        /**
         * Update announcement in Firebase
         */
        async function updateAnnouncement(announcementId) {
            const title = document.getElementById('edit-announcement-title').value;
            const content = document.getElementById('edit-announcement-content').value;
            const targetStores = document.getElementById('edit-announcement-stores').value;

            if (!title || !content) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                if (firebaseAnnouncementsManager.isInitialized) {
                    const success = await firebaseAnnouncementsManager.updateAnnouncement(announcementId, {
                        title,
                        content,
                        targetStores
                    });
                    if (success) {
                        // Reload announcements from Firebase
                        const updatedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                        if (updatedAnnouncements && updatedAnnouncements.length > 0) {
                            announcements = updatedAnnouncements;
                        }
                        console.log('Announcement updated in Firebase');
                    }
                } else {
                    // Fallback to local update
                    const index = announcements.findIndex(a => a.id === announcementId || a.firestoreId === announcementId);
                    if (index !== -1) {
                        announcements[index] = { ...announcements[index], title, content, targetStores };
                    }
                }

                closeModal();
                renderAnnouncements();
                updateAnnouncementsBadge();
                populateAnnouncementsDropdown();
            } catch (error) {
                console.error('Error updating announcement:', error);
                alert('Failed to update announcement. Please try again.');
            }
        }

        // ==========================================
        // CLOCK IN/OUT FUNCTIONALITY
        // ==========================================

        // Clock In attendance records storage
        let clockinAttendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        let currentClockAction = '';
        let clockInterval = null;
        let clockPollingInterval = null; // For real-time AJAX polling

        function renderClockIn() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">
                            Clock In/Out
                            <span style="
                                display: inline-flex;
                                align-items: center;
                                gap: 6px;
                                padding: 4px 12px;
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                border-radius: 20px;
                                font-size: 12px;
                                font-weight: 600;
                                color: white;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-left: 12px;
                                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                            ">
                                <span style="
                                    width: 8px;
                                    height: 8px;
                                    background: white;
                                    border-radius: 50%;
                                    animation: pulse-live 2s infinite;
                                "></span>
                                Live
                            </span>
                        </h2>
                        <p class="section-subtitle">Real-time employee attendance tracking</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <div class="search-filter">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search employees..." id="attendanceSearch" onkeyup="filterAttendanceSearch()">
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes pulse-live {
                        0%, 100% {
                            opacity: 1;
                            transform: scale(1);
                        }
                        50% {
                            opacity: 0.5;
                            transform: scale(1.2);
                        }
                    }
                </style>

                <!-- Current Time Display -->
                <div class="time-display-card">
                    <div class="current-time">
                        <div class="time-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="time-info">
                            <div class="current-date" id="currentDate">Loading...</div>
                            <div class="current-clock" id="currentClock">00:00:00 AM</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Clock Actions -->
                <div class="clock-quick-actions">
                    <button class="clock-action-btn clock-in" onclick="showClockModal('in')">
                        <div class="action-icon">
                            <i class="fas fa-sign-in-alt"></i>
                        </div>
                        <span>Clock In</span>
                    </button>
                    <button class="clock-action-btn lunch-start" onclick="showClockModal('lunch-start')">
                        <div class="action-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <span>Start Lunch</span>
                    </button>
                    <button class="clock-action-btn lunch-end" onclick="showClockModal('lunch-end')">
                        <div class="action-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <span>End Lunch</span>
                    </button>
                    <button class="clock-action-btn clock-out" onclick="showClockModal('out')">
                        <div class="action-icon">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                        <span>Clock Out</span>
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="attendance-stats-grid">
                    <div class="attendance-stat-card">
                        <div class="stat-icon-container clocked-in">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="clockedInCount">0</div>
                            <div class="stat-label">Clocked In</div>
                        </div>
                    </div>
                    <div class="attendance-stat-card">
                        <div class="stat-icon-container on-lunch">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="onLunchCount">0</div>
                            <div class="stat-label">On Lunch</div>
                        </div>
                    </div>
                    <div class="attendance-stat-card">
                        <div class="stat-icon-container clocked-out">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="clockedOutCount">0</div>
                            <div class="stat-label">Clocked Out</div>
                        </div>
                    </div>
                    <div class="attendance-stat-card">
                        <div class="stat-icon-container total">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="totalEmployeesCount">0</div>
                            <div class="stat-label">Total Employees</div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-clipboard-list"></i>
                            Today's Attendance
                        </h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button class="btn-secondary" onclick="exportAttendance()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                            <button class="card-action" onclick="refreshAttendance()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="loadingAttendance" class="loading-state">
                            <div class="spinner"></div>
                            <span>Loading attendance...</span>
                        </div>
                        <div id="attendanceTableContainer" style="display: none;">
                            <table class="attendance-table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Store</th>
                                        <th>Clock In</th>
                                        <th>Lunch Start</th>
                                        <th>Lunch End</th>
                                        <th>Clock Out</th>
                                        <th>Total Hours</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div id="emptyAttendanceState" class="empty-state" style="display: none;">
                            <i class="fas fa-clipboard"></i>
                            <h3>No attendance records today</h3>
                            <p>Records will appear here once employees clock in</p>
                        </div>
                    </div>
                </div>
            `;

            // Initialize clock and load data
            initializeClockIn();
        }

        function initializeClockIn() {
            updateClockDisplay();
            // Clear any existing intervals
            if (clockInterval) clearInterval(clockInterval);
            if (clockPollingInterval) clearInterval(clockPollingInterval);

            // Update clock display every second
            clockInterval = setInterval(updateClockDisplay, 1000);

            // Load initial data
            loadAttendanceData();

            // Start real-time polling for clock records (every 5 seconds)
            startClockInPolling();
        }

        /**
         * Start real-time AJAX polling to check for new clock in/out records
         */
        function startClockInPolling() {
            // Clear any existing polling interval
            if (clockPollingInterval) {
                clearInterval(clockPollingInterval);
            }

            // Poll every 5 seconds for real-time updates
            clockPollingInterval = setInterval(async () => {
                await pollForClockUpdates();
            }, 5000);

            console.log(' Real-time clock in/out polling started');
        }

        /**
         * Stop real-time polling
         */
        function stopClockInPolling() {
            if (clockPollingInterval) {
                clearInterval(clockPollingInterval);
                clockPollingInterval = null;
                console.log('癸 Real-time clock in/out polling stopped');
            }
        }

        /**
         * Poll Firebase for clock record updates
         */
        async function pollForClockUpdates() {
            try {
                const dateString = new Date().toISOString().split('T')[0];

                // Initialize Firebase if needed
                if (!firebaseClockInManager.isInitialized) {
                    await firebaseClockInManager.initialize();
                }

                // Load latest records from Firebase
                const firebaseRecords = await firebaseClockInManager.loadClockRecordsByDate(dateString);

                if (firebaseRecords.length > 0) {
                    const today = new Date().toDateString();
                    let hasUpdates = false;

                    // Check if there are any new or updated records
                    firebaseRecords.forEach(fbRecord => {
                        const localRecord = clockinAttendanceRecords.find(r =>
                            r.employeeName === fbRecord.employeeName && r.date === today
                        );

                        // Check if record is new or has been updated
                        if (!localRecord ||
                            localRecord.clockIn !== fbRecord.clockIn ||
                            localRecord.lunchStart !== fbRecord.lunchStart ||
                            localRecord.lunchEnd !== fbRecord.lunchEnd ||
                            localRecord.clockOut !== fbRecord.clockOut) {
                            hasUpdates = true;
                        }
                    });

                    // If updates detected, refresh the display
                    if (hasUpdates) {
                        console.log(' New clock in/out updates detected, refreshing...');

                        // Update local records
                        const updatedRecords = [];
                        const processedNames = new Set();

                        firebaseRecords.forEach(rec => {
                            processedNames.add(rec.employeeName);
                            updatedRecords.push({
                                id: rec.id || Date.now(),
                                employeeId: rec.employeeId,
                                employeeName: rec.employeeName,
                                employeeRole: rec.employeeRole,
                                employeeInitials: rec.employeeName?.substring(0, 2).toUpperCase() || '',
                                store: rec.store,
                                date: today,
                                clockIn: rec.clockIn || null,
                                lunchStart: rec.lunchStart || null,
                                lunchEnd: rec.lunchEnd || null,
                                clockOut: rec.clockOut || null,
                                notes: rec.notes || ''
                            });
                        });

                        // Add any local-only records
                        clockinAttendanceRecords.forEach(localRec => {
                            if (!processedNames.has(localRec.employeeName) && localRec.date === today) {
                                updatedRecords.push(localRec);
                            }
                        });

                        clockinAttendanceRecords = updatedRecords;
                        localStorage.setItem('attendanceRecords', JSON.stringify(clockinAttendanceRecords));

                        // Update UI with visual feedback
                        showRealtimeUpdateNotification();
                        updateClockInUI();
                    }
                }
            } catch (error) {
                // Silently fail to avoid console spam
                console.debug('Polling update check failed:', error);
            }
        }

        /**
         * Update Clock In UI elements
         */
        function updateClockInUI() {
            const today = new Date().toDateString();
            const todayRecords = clockinAttendanceRecords.filter(r => r.date === today);

            const tableContainer = document.getElementById('attendanceTableContainer');
            const emptyState = document.getElementById('emptyAttendanceState');

            if (todayRecords.length === 0) {
                if (tableContainer) tableContainer.style.display = 'none';
                if (emptyState) emptyState.style.display = 'flex';
            } else {
                if (tableContainer) tableContainer.style.display = 'block';
                if (emptyState) emptyState.style.display = 'none';
                renderAttendanceTableRows(todayRecords);
            }

            updateAttendanceStats(todayRecords);
        }

        /**
         * Show real-time update notification
         */
        function showRealtimeUpdateNotification() {
            // Create a subtle notification indicator
            const refreshBtn = document.querySelector('.card-action');
            if (refreshBtn && refreshBtn.innerHTML.includes('Refresh')) {
                // Add a pulsing dot to indicate new data
                const originalHTML = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-sync" style="color: var(--accent-primary);"></i> Updated';
                refreshBtn.style.color = 'var(--accent-primary)';

                // Reset after 2 seconds
                setTimeout(() => {
                    refreshBtn.innerHTML = originalHTML;
                    refreshBtn.style.color = '';
                }, 2000);
            }
        }

        function updateClockDisplay() {
            const now = new Date();
            const dateEl = document.getElementById('currentDate');
            const clockEl = document.getElementById('currentClock');

            if (!dateEl || !clockEl) return;

            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateEl.textContent = now.toLocaleDateString('en-US', options);

            // Format time
            let hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;

            clockEl.textContent = `${padZeroTime(hours)}:${padZeroTime(minutes)}:${padZeroTime(seconds)} ${ampm}`;
        }

        function padZeroTime(num) {
            return num.toString().padStart(2, '0');
        }

        function showClockModal(action) {
            // No modal - directly submit with current user and time
            submitClockAction(action);
        }

        function closeClockModal() {
            // Not needed anymore, but kept for compatibility
        }

        async function submitClockAction(action = null) {
            // Use the action passed as parameter if available
            if (action) {
                currentClockAction = action;
            }

            // Get current logged-in user
            const currentUser = getCurrentUser();
            
            if (!currentUser || (!currentUser.userId && !currentUser.id)) {
                console.error('No user logged in');
                showNotification('Error: No user logged in', 'error');
                return;
            }

            // Get current time in HH:MM format
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const time = `${hours}:${minutes}`;

            // Get employee info from current user
            // Priority: Name (main identifier) -> ID -> Email -> Create fallback
            let employee = null;
            
            // 1. First try to find by NAME (this is the primary identifier to avoid duplicates)
            if (currentUser.name) {
                employee = employees.find(e => e.name === currentUser.name);
                if (employee) console.log(' Found employee by name:', currentUser.name);
            }
            
            // 2. If not found by name, try by ID
            if (!employee) {
                const userId = currentUser.userId || currentUser.id;
                if (userId) {
                    employee = employees.find(e => String(e.id) === String(userId));
                    if (employee) console.log(' Found employee by ID:', userId);
                }
            }

            // 3. If still not found, try by email
            if (!employee && currentUser.email) {
                employee = employees.find(e => e.email === currentUser.email);
                if (employee) console.log(' Found employee by email:', currentUser.email);
            }

            // 4. If still not found, create a minimal employee object
            if (!employee) {
                const userId = currentUser.userId || currentUser.id;
                console.warn('锔 Employee not found in database, creating fallback record');
                employee = {
                    id: userId,
                    name: currentUser.name || 'Current User',
                    role: currentUser.role || 'Employee',
                    initials: (currentUser.name || 'CU')?.substring(0, 2).toUpperCase() || 'CU',
                    store: currentUser.store || 'VSU Miramar',
                    email: currentUser.email
                };
            }

            const store = employee.store || 'VSU Miramar';

            console.log(' Clock action for user:', employee.name, 'at', time, 'Action:', currentClockAction);

            // Format date as YYYY-MM-DD for consistency
            const today = new Date();
            const dateString = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            const dateDisplayString = today.toDateString();

            // Find record by EMPLOYEE NAME (primary identifier to avoid duplicates)
            let record = clockinAttendanceRecords.find(r => r.employeeName === employee.name && r.date === dateDisplayString);

            // Create new record if doesn't exist
            if (!record) {
                record = {
                    id: Date.now(),
                    employeeId: employee.id,
                    employeeName: employee.name,
                    employeeRole: employee.role,
                    employeeInitials: employee.initials || employee.name?.substring(0, 2).toUpperCase() || '',
                    store: store,
                    date: dateDisplayString,
                    clockIn: null,
                    lunchStart: null,
                    lunchEnd: null,
                    clockOut: null,
                    notes: ''
                };
                clockinAttendanceRecords.push(record);
            } else {
                // Update existing record's store
                if (store) record.store = store;
            }

            // Update record based on action
            switch(currentClockAction) {
                case 'in':
                    if (record.clockIn) {
                        console.warn('Employee already clocked in today');
                        showNotification('You are already clocked in', 'warning');
                        return;
                    }
                    record.clockIn = time;
                    console.log('憋 Clocking in:', record.employeeName, 'at', time);
                    break;
                case 'lunch-start':
                    if (!record.clockIn) {
                        console.warn('Lunch start attempted without clock in');
                        showNotification('Please clock in first', 'warning');
                        return;
                    }
                    if (record.lunchStart) {
                        console.warn('Lunch break already started');
                        showNotification('Lunch break already started', 'warning');
                        return;
                    }
                    record.lunchStart = time;
                    console.log('斤 Lunch start:', record.employeeName, 'at', time);
                    break;
                case 'lunch-end':
                    if (!record.lunchStart) {
                        console.warn('Lunch break not started yet');
                        showNotification('Lunch break not started yet', 'warning');
                        return;
                    }
                    if (record.lunchEnd) {
                        console.warn('Lunch break already ended');
                        showNotification('Lunch break already ended', 'warning');
                        return;
                    }
                    record.lunchEnd = time;
                    console.log('斤 Lunch end:', record.employeeName, 'at', time);
                    break;
                case 'out':
                    if (!record.clockIn) {
                        console.warn('Clock out attempted without clock in');
                        showNotification('Please clock in first', 'warning');
                        return;
                    }
                    if (record.clockOut) {
                        console.warn('Employee already clocked out today');
                        showNotification('You are already clocked out', 'warning');
                        return;
                    }
                    record.clockOut = time;
                    console.log('憋 Clocking out:', record.employeeName, 'at', time);
                    break;
            }

            // Save to localStorage
            localStorage.setItem('attendanceRecords', JSON.stringify(clockinAttendanceRecords));

            // Save to Firebase
            try {
                // Initialize Firebase Clock In Manager if not already done
                if (!firebaseClockInManager.isInitialized) {
                    await firebaseClockInManager.initialize();
                }

                // Prepare clock record for Firebase
                const firebaseRecord = {
                    employeeId: employee.id,
                    employeeName: employee.name,
                    employeeRole: employee.role,
                    store: store,
                    date: dateString, // YYYY-MM-DD format
                    clockIn: record.clockIn,
                    lunchStart: record.lunchStart,
                    lunchEnd: record.lunchEnd,
                    clockOut: record.clockOut,
                    notes: record.notes || ''
                };

                // Save to Firebase
                await firebaseClockInManager.saveClockRecord(firebaseRecord);
                console.log(' Clock record saved to Firebase successfully');
                
                // Reload from Firebase immediately to sync state across devices/reloads
                try {
                    const updatedRecords = await firebaseClockInManager.loadClockRecordsByDate(dateString);
                    console.log(' Reloaded updated records from Firebase:', updatedRecords.length);
                    
                    if (updatedRecords.length > 0) {
                        // Update local records with Firebase data
                        const today = new Date().toDateString();
                        const updatedArray = [];
                        const processedNames = new Set();
                        
                        updatedRecords.forEach(rec => {
                            processedNames.add(rec.employeeName);
                            updatedArray.push({
                                id: rec.id || Date.now(),
                                employeeId: rec.employeeId,
                                employeeName: rec.employeeName,
                                employeeRole: rec.employeeRole,
                                employeeInitials: rec.employeeName?.substring(0, 2).toUpperCase() || '',
                                store: rec.store,
                                date: today,
                                clockIn: rec.clockIn || null,
                                lunchStart: rec.lunchStart || null,
                                lunchEnd: rec.lunchEnd || null,
                                clockOut: rec.clockOut || null,
                                notes: rec.notes || ''
                            });
                        });
                        
                        // Add any local-only records
                        clockinAttendanceRecords.forEach(localRec => {
                            if (!processedNames.has(localRec.employeeName) && localRec.date === today) {
                                updatedArray.push(localRec);
                            }
                        });
                        
                        clockinAttendanceRecords = updatedArray;
                        localStorage.setItem('attendanceRecords', JSON.stringify(clockinAttendanceRecords));
                    }
                } catch (reloadError) {
                    console.warn('锔 Could not reload from Firebase after save:', reloadError);
                }
            } catch (error) {
                console.error('锔 Error saving to Firebase:', error);
                // Don't prevent saving to localStorage if Firebase fails
                // The user will still see success message but data is local only
            }

            // Show success message and reload
            showNotification('Action recorded successfully!', 'success');
            
            // Reload attendance table
            setTimeout(() => {
                loadAttendanceData();
            }, 500);
        }

        async function loadAttendanceData() {
            const today = new Date().toDateString();
            const dateString = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            
            const loadingDiv = document.getElementById('loadingAttendance');
            const tableContainer = document.getElementById('attendanceTableContainer');
            const emptyState = document.getElementById('emptyAttendanceState');

            if (!loadingDiv) return;

            // Show loading
            loadingDiv.style.display = 'flex';
            tableContainer.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                // Initialize Firebase Clock In Manager if not already done
                if (!firebaseClockInManager.isInitialized) {
                    await firebaseClockInManager.initialize();
                }

                // Try to load from Firebase first
                let firebaseRecords = [];
                try {
                    firebaseRecords = await firebaseClockInManager.loadClockRecordsByDate(dateString);
                    console.log(' Loaded clock records from Firebase:', firebaseRecords.length);
                    
                    // Merge Firebase records with local records intelligently
                    if (firebaseRecords.length > 0) {
                        // Create a map of Firebase records by EMPLOYEE NAME (primary identifier)
                        const firebaseMap = {};
                        firebaseRecords.forEach(rec => {
                            firebaseMap[rec.employeeName] = rec;
                        });
                        
                        // Update or add records
                        const updatedRecords = [];
                        const processedNames = new Set();
                        
                        // First, process Firebase records (they're latest)
                        firebaseRecords.forEach(rec => {
                            processedNames.add(rec.employeeName);
                            updatedRecords.push({
                                id: rec.id || Date.now(),
                                employeeId: rec.employeeId,
                                employeeName: rec.employeeName,
                                employeeRole: rec.employeeRole,
                                employeeInitials: rec.employeeName?.substring(0, 2).toUpperCase() || '',
                                store: rec.store,
                                date: today, // Use display format for local tracking
                                clockIn: rec.clockIn || null,
                                lunchStart: rec.lunchStart || null,
                                lunchEnd: rec.lunchEnd || null,
                                clockOut: rec.clockOut || null,
                                notes: rec.notes || ''
                            });
                        });
                        
                        // Then, add any local-only records
                        clockinAttendanceRecords.forEach(localRec => {
                            if (!processedNames.has(localRec.employeeName) && localRec.date === today) {
                                updatedRecords.push(localRec);
                            }
                        });
                        
                        clockinAttendanceRecords = updatedRecords;
                        // Save merged data to localStorage for fallback
                        localStorage.setItem('attendanceRecords', JSON.stringify(clockinAttendanceRecords));
                    }
                } catch (firebaseError) {
                    console.warn('锔 Could not load from Firebase, using local data:', firebaseError);
                    // Fall back to localStorage - filter only today's records
                    clockinAttendanceRecords = clockinAttendanceRecords.filter(r => r.date === today);
                }
            } catch (error) {
                console.error('Error in loadAttendanceData:', error);
            }

            // Get today's records
            const todayRecords = clockinAttendanceRecords.filter(r => r.date === today);

            // Simulate loading delay
            setTimeout(() => {
                loadingDiv.style.display = 'none';

                if (todayRecords.length === 0) {
                    emptyState.style.display = 'flex';
                } else {
                    tableContainer.style.display = 'block';
                    renderAttendanceTableRows(todayRecords);
                }

                updateAttendanceStats(todayRecords);
            }, 300);
        }

        function renderAttendanceTableRows(records) {
            const tableBody = document.getElementById('attendanceTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = records.map(record => {
                const status = getAttendanceStatus(record);
                const totalHours = calculateAttendanceTotalHours(record);

                return `
                    <tr>
                        <td>
                            <div class="employee-table-info">
                                <div class="employee-table-avatar">${record.employeeInitials}</div>
                                <div class="employee-table-details">
                                    <div class="employee-table-name">${record.employeeName}</div>
                                    <div class="employee-table-role">${record.employeeRole}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="store-badge">${record.store}</span></td>
                        <td><span class="time-cell ${!record.clockIn ? 'empty' : ''}">${record.clockIn || '-'}</span></td>
                        <td><span class="time-cell ${!record.lunchStart ? 'empty' : ''}">${record.lunchStart || '-'}</span></td>
                        <td><span class="time-cell ${!record.lunchEnd ? 'empty' : ''}">${record.lunchEnd || '-'}</span></td>
                        <td><span class="time-cell ${!record.clockOut ? 'empty' : ''}">${record.clockOut || '-'}</span></td>
                        <td><span class="total-hours">${totalHours}</span></td>
                        <td><span class="status-badge ${status.class}">${status.text}</span></td>
                        <td>
                            <button class="table-action-btn" onclick="viewAttendanceDetails('${record.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getAttendanceStatus(record) {
            if (record.clockOut) {
                return { text: 'Clocked Out', class: 'clocked-out' };
            }
            if (record.lunchStart && !record.lunchEnd) {
                return { text: 'On Lunch', class: 'on-lunch' };
            }
            if (record.clockIn) {
                return { text: 'Clocked In', class: 'clocked-in' };
            }
            return { text: 'Not Started', class: 'not-started' };
        }

        function calculateAttendanceTotalHours(record) {
            if (!record.clockIn) return '-';

            const clockIn = parseAttendanceTime(record.clockIn);
            const clockOut = record.clockOut ? parseAttendanceTime(record.clockOut) : new Date();

            let totalMinutes = (clockOut - clockIn) / 1000 / 60;

            // Subtract lunch time if applicable
            if (record.lunchStart && record.lunchEnd) {
                const lunchStart = parseAttendanceTime(record.lunchStart);
                const lunchEnd = parseAttendanceTime(record.lunchEnd);
                const lunchMinutes = (lunchEnd - lunchStart) / 1000 / 60;
                totalMinutes -= lunchMinutes;
            }

            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);

            return `${hours}h ${minutes}m`;
        }

        function parseAttendanceTime(timeString) {
            const today = new Date();
            const [hours, minutes] = timeString.split(':');
            today.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return today;
        }

        function updateAttendanceStats(records) {
            const clockedInCount = records.filter(r => r.clockIn && !r.clockOut).length;
            const onLunchCount = records.filter(r => r.lunchStart && !r.lunchEnd).length;
            const clockedOutCount = records.filter(r => r.clockOut).length;

            const clockedInEl = document.getElementById('clockedInCount');
            const onLunchEl = document.getElementById('onLunchCount');
            const clockedOutEl = document.getElementById('clockedOutCount');
            const totalEl = document.getElementById('totalEmployeesCount');

            if (clockedInEl) clockedInEl.textContent = clockedInCount;
            if (onLunchEl) onLunchEl.textContent = onLunchCount;
            if (clockedOutEl) clockedOutEl.textContent = clockedOutCount;
            if (totalEl) totalEl.textContent = employees.length;
        }

        function viewAttendanceDetails(recordId) {
            const record = clockinAttendanceRecords.find(r => r.id === recordId);
            if (!record) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            const status = getAttendanceStatus(record);
            const totalHours = calculateAttendanceTotalHours(record);

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-clock" style="color: var(--accent-primary);"></i>
                        Attendance Details
                    </h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Employee Info Header -->
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700;">
                            ${record.employeeName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 4px; font-size: 18px; font-weight: 600;">${record.employeeName}</h3>
                            <div style="font-size: 14px; color: var(--text-muted);">
                                <span style="margin-right: 16px;"><i class="fas fa-briefcase"></i> ${record.employeeRole || 'Employee'}</span>
                                <span><i class="fas fa-store"></i> ${record.store}</span>
                            </div>
                        </div>
                        <span class="status-badge" style="background: ${status.color}20; color: ${status.color}; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
                            ${status.text}
                        </span>
                    </div>

                    <!-- Date and Total Hours -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                <i class="fas fa-calendar"></i> Date
                            </div>
                            <div style="font-size: 18px; font-weight: 600;">${record.date}</div>
                        </div>
                        <div style="padding: 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">
                                <i class="fas fa-hourglass-half"></i> Total Hours
                            </div>
                            <div style="font-size: 24px; font-weight: 700;">${totalHours}</div>
                        </div>
                    </div>

                    <!-- Time Details -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;">
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #10b981;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Clock In</div>
                            <div style="font-size: 16px; font-weight: 600; color: #10b981;">${record.clockIn || '-'}</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Lunch Start</div>
                            <div style="font-size: 16px; font-weight: 600; color: #f59e0b;">${record.lunchStart || '-'}</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Lunch End</div>
                            <div style="font-size: 16px; font-weight: 600; color: #f59e0b;">${record.lunchEnd || '-'}</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #ef4444;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Clock Out</div>
                            <div style="font-size: 16px; font-weight: 600; color: #ef4444;">${record.clockOut || '-'}</div>
                        </div>
                    </div>

                    ${record.notes ? `
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                                <i class="fas fa-sticky-note"></i> Notes
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">${record.notes}</div>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;

            modal.classList.add('active');
        }

        function refreshAttendance() {
            loadAttendanceData();
        }

        function exportAttendance() {
            const today = new Date().toDateString();
            const todayRecords = clockinAttendanceRecords.filter(r => r.date === today);

            if (todayRecords.length === 0) {
                alert('No attendance records to export');
                return;
            }

            // Create CSV content
            let csv = 'Employee,Role,Store,Clock In,Lunch Start,Lunch End,Clock Out,Total Hours,Status\n';

            todayRecords.forEach(record => {
                const status = getAttendanceStatus(record);
                const totalHours = calculateAttendanceTotalHours(record);

                csv += `"${record.employeeName}","${record.employeeRole}","${record.store}",`;
                csv += `"${record.clockIn || '-'}","${record.lunchStart || '-'}","${record.lunchEnd || '-'}",`;
                csv += `"${record.clockOut || '-'}","${totalHours}","${status.text}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function filterAttendanceSearch() {
            const searchInput = document.getElementById('attendanceSearch');
            if (!searchInput) return;

            const searchTerm = searchInput.value.toLowerCase();
            const today = new Date().toDateString();
            let records = clockinAttendanceRecords.filter(r => r.date === today);

            if (searchTerm) {
                records = records.filter(r =>
                    r.employeeName.toLowerCase().includes(searchTerm) ||
                    r.employeeRole.toLowerCase().includes(searchTerm) ||
                    r.store.toLowerCase().includes(searchTerm)
                );
            }

            renderAttendanceTableRows(records);
            updateAttendanceStats(records);
        }

        // ==========================================
        // END CLOCK IN/OUT FUNCTIONALITY
        // ==========================================

        function renderNewStuff() {
            const dashboard = document.querySelector('.dashboard');

            // Show loading state
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">New Stuff</h2>
                        <p class="section-subtitle">Incoming products and inventory</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-product')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 16px;"></i>
                    <p>Loading products from Firebase...</p>
                </div>
            `;

            // Load products from Firebase
            loadProductsFromFirebase().then(() => {
                dashboard.innerHTML = `
                    <div class="page-header">
                        <div class="page-header-left">
                            <h2 class="section-title">New Stuff</h2>
                            <p class="section-subtitle">Incoming products</p>
                        </div>
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-product')">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>

                    ${products.length === 0 ? `
                        <div style="text-align: center; padding: 60px 20px; background: var(--bg-hover); border-radius: 12px;">
                            <i class="fas fa-box-open" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;"></i>
                            <h3 style="color: var(--text-secondary);">No Products Yet</h3>
                            <p style="color: var(--text-muted); margin-bottom: 20px;">Add your first product to get started</p>
                            <button class="btn-primary floating-add-btn" onclick="openModal('add-product')">
                                <i class="fas fa-plus"></i> Add First Product
                            </button>
                        </div>
                    ` : `
                        <div class="employees-grid">
                            ${products.map(product => `
                                <div class="card" onclick="viewProductDetails('${product.id}')" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
                                    ${product.image ? `
                                        <div class="product-image-container" style="position: relative; width: 100%; height: 180px; overflow: hidden; border-radius: 12px 12px 0 0;">
                                            <img src="${product.image}"
                                                 alt="${product.name}"
                                                 style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;"
                                                 onerror="this.parentElement.style.display='none'">
                                        </div>
                                    ` : ''}
                                    <div class="card-header" style="background: rgba(139, 92, 246, 0.1); border-radius: ${product.image ? '0' : '12px 12px 0 0'};">
                                        <h3 class="card-title" style="font-size: 16px; font-weight: 600;">
                                            ${product.name}
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                                <span style="color: var(--text-muted); font-size: 13px;">Category:</span>
                                                <span style="font-weight: 600; font-size: 13px;">${product.category || '-'}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                                <span style="color: var(--text-muted); font-size: 13px;">Est. Price:</span>
                                                <span style="font-weight: 600; font-size: 13px; color: var(--success);">$${product.price || 0}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                                <span style="color: var(--text-muted); font-size: 13px;">Est. Arrival:</span>
                                                <span style="font-weight: 600; font-size: 13px;">${product.arrivalDate ? formatDate(product.arrivalDate) : '-'}</span>
                                            </div>
                                            ${product.url ? `
                                                <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                                                    <span style="color: var(--text-muted); font-size: 13px;">More Info:</span>
                                                    <a href="${product.url}" target="_blank" onclick="event.stopPropagation();" style="font-weight: 600; font-size: 13px; color: var(--accent-primary); text-decoration: none;">
                                                        <i class="fas fa-external-link-alt"></i> View
                                                    </a>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="card-footer" style="padding: 12px 16px; border-top: 1px solid var(--border-color); text-align: center;">
                                        <span style="color: var(--text-muted); font-size: 12px;">
                                            <i class="fas fa-hand-pointer"></i> Click to view details
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                `;
            });
        }

        function viewProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; gap: 12px; margin: 0;">
                        <i class="fas fa-box" style="color: var(--accent-primary); font-size: 24px;"></i>
                        Product Details
                    </h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    ${product.image ? `
                        <div style="
                            margin-bottom: 24px;
                            border-radius: 16px;
                            overflow: hidden;
                            background: var(--bg-secondary);
                            position: relative;
                            aspect-ratio: 16 / 10;
                        ">
                            <img 
                                src="${product.image}" 
                                alt="${product.name}" 
                                style="
                                    width: 100%;
                                    height: 100%;
                                    object-fit: cover;
                                    display: block;
                                " 
                                onerror="this.style.display='none'">
                        </div>
                    ` : `
                        <div style="
                            margin-bottom: 24px;
                            border-radius: 16px;
                            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                            height: 200px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-image" style="font-size: 48px; color: rgba(255,255,255,0.5);"></i>
                        </div>
                    `}

                    <div style="margin-bottom: 24px;">
                        <h3 style="
                            margin: 0 0 8px 0;
                            font-size: 24px;
                            font-weight: 700;
                            color: var(--text-primary);
                        ">${product.name}</h3>
                        <p style="
                            margin: 0;
                            color: var(--text-muted);
                            font-size: 14px;
                        ">Product Reference ID: #${product.id}</p>
                    </div>

                    <div style="
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 16px;
                        margin-bottom: 24px;
                    ">
                        <!-- Category -->
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                            transition: all 0.2s ease;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">Category</div>
                            <div style="
                                font-weight: 600;
                                font-size: 15px;
                                color: var(--text-primary);
                            ">${product.category || '-'}</div>
                        </div>

                        <!-- Estimated Price -->
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                            transition: all 0.2s ease;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">Estimated Price</div>
                            <div style="
                                font-weight: 600;
                                font-size: 18px;
                                color: var(--success);
                            ">$${(product.price || 0).toFixed(2)}</div>
                        </div>

                        <!-- Estimated Arrival -->
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">
                                <i class="fas fa-calendar" style="margin-right: 6px; font-size: 12px;"></i>Estimated Arrival
                            </div>
                            <div style="
                                font-weight: 600;
                                font-size: 15px;
                                color: var(--text-primary);
                            ">${product.arrivalDate ? formatDate(product.arrivalDate) : '-'}</div>
                        </div>

                        <!-- Supplier -->
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">
                                <i class="fas fa-truck" style="margin-right: 6px; font-size: 12px;"></i>Supplier
                            </div>
                            <div style="
                                font-weight: 600;
                                font-size: 15px;
                                color: var(--text-primary);
                            ">${product.supplier || '-'}</div>
                        </div>
                    </div>

                    ${product.url ? `
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                            margin-bottom: 24px;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">
                                <i class="fas fa-link" style="margin-right: 6px; font-size: 12px;"></i>Product URL
                            </div>
                            <a href="${product.url}" target="_blank" style="
                                font-weight: 600;
                                font-size: 14px;
                                color: var(--accent-primary);
                                text-decoration: none;
                                word-break: break-all;
                            ">${product.url} <i class="fas fa-external-link-alt" style="margin-left: 6px; font-size: 12px;"></i></a>
                        </div>
                    ` : ''}

                    ${product.description ? `
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                            margin-bottom: 24px;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 12px;
                            ">Description</div>
                            <p style="
                                margin: 0;
                                line-height: 1.6;
                                color: var(--text-secondary);
                                font-size: 14px;
                            ">${product.description}</p>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" style="
                            flex: 1;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            padding: 12px 16px;
                            border-radius: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            border: none;
                            transition: all 0.2s ease;
                        " onclick="closeModal(); editProduct('${product.id}');">
                            <i class="fas fa-edit"></i>
                            Edit Product
                        </button>
                        <button style="
                            flex: 1;
                            background: var(--danger);
                            color: white;
                            border: none;
                            padding: 12px 16px;
                            border-radius: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                        " onclick="deleteProductFromFirebase('${product.id}'); closeModal();" onhover="this.style.opacity='0.9'">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        let currentRestockTab = 'inventory';
        let selectedStoreFilter = 'all';
        let selectedRestockTypeFilter = 'all'; // 'all', 'product', 'supply'

        function renderRestockRequests() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Inventory & Restock</h2>
                        <p class="section-subtitle">Manage inventory and restock requests</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openNewRestockRequestModal()">
                        <i class="fas fa-plus"></i> Create Restock Request
                    </button>
                </div>

                <div class="restock-tabs" style="display: flex; gap: 16px; margin-bottom: 24px; border-bottom: 2px solid var(--border-color);">
                    <button onclick="switchRestockTab('inventory')" class="tab-btn ${currentRestockTab === 'inventory' ? 'active' : ''}" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid ${currentRestockTab === 'inventory' ? 'var(--accent-primary)' : 'transparent'}; color: ${currentRestockTab === 'inventory' ? 'var(--accent-primary)' : 'var(--text-secondary)'}; font-weight: 600; font-size: 14px; cursor: pointer; margin-bottom: -2px; transition: all 0.2s;">
                        <i class="fas fa-boxes"></i> Inventory
                    </button>
                    <button onclick="switchRestockTab('requests')" class="tab-btn ${currentRestockTab === 'requests' ? 'active' : ''}" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid ${currentRestockTab === 'requests' ? 'var(--accent-primary)' : 'transparent'}; color: ${currentRestockTab === 'requests' ? 'var(--accent-primary)' : 'var(--text-secondary)'}; font-weight: 600; font-size: 14px; cursor: pointer; margin-bottom: -2px; transition: all 0.2s;">
                        <i class="fas fa-list"></i> Requests <span style="background: var(--accent-gradient); color: white; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 10px; margin-left: 6px;">${restockRequests.length}</span>
                    </button>
                </div>

                <div id="restock-tab-content">
                    ${currentRestockTab === 'inventory' ? renderInventoryTab() : renderRequestsTab()}
                </div>
            `;
        }

        function renderInventoryTab() {
            const filteredInventory = selectedStoreFilter === 'all'
                ? inventory
                : inventory.filter(item => item.store === selectedStoreFilter);

            return `
                <div class="restock-filter-header" style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label style="font-weight: 600; font-size: 14px; color: var(--text-secondary);">
                            <i class="fas fa-filter"></i> Filter by Store:
                        </label>
                        <select class="form-input" id="store-filter" onchange="filterInventoryByStore(this.value)" style="width: 200px;">
                            <option value="all" ${selectedStoreFilter === 'all' ? 'selected' : ''}>All Stores</option>
                            <option value="Miramar" ${selectedStoreFilter === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                            <option value="Morena" ${selectedStoreFilter === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                            <option value="Kearny Mesa" ${selectedStoreFilter === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                            <option value="Chula Vista" ${selectedStoreFilter === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                            <option value="North Park" ${selectedStoreFilter === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                            <option value="Miramar Wine & Liquor" ${selectedStoreFilter === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                        </select>
                    </div>
                    <div style="font-size: 13px; color: var(--text-muted);">
                        Showing ${filteredInventory.length} ${filteredInventory.length === 1 ? 'item' : 'items'}
                    </div>
                </div>

                <div class="licenses-table-container">
                    <table class="data-table restock-inventory-table">
                        <thead>
                            <tr>
                                <th>Brand</th>
                                <th>Product Name</th>
                                <th>Flavor</th>
                                <th>Unit Price</th>
                                <th>Min Stock</th>
                                <th>Stock</th>
                                <th>Store</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredInventory.map(item => `
                                <tr>
                                    <td data-label="Brand" style="font-weight: 600;">${item.brand}</td>
                                    <td data-label="Product">${item.productName}</td>
                                    <td data-label="Flavor">${item.flavor}</td>
                                    <td data-label="Price" style="font-weight: 600; color: var(--success);">$${item.unitPrice}</td>
                                    <td data-label="Min Stock">${item.minStock}</td>
                                    <td data-label="Stock">
                                        <span style="font-weight: 600; color: ${item.stock < item.minStock ? 'var(--danger)' : 'var(--success)'};">
                                            ${item.stock}
                                        </span>
                                    </td>
                                    <td data-label="Store" style="font-weight: 500; font-size: 12px;">${item.store}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderRequestsTab() {
            // Filter requests by type
            const filteredRequests = selectedRestockTypeFilter === 'all'
                ? restockRequests
                : restockRequests.filter(r => (r.itemType || 'product') === selectedRestockTypeFilter);

            // Type filter buttons
            const typeFilterButtons = `
                <div class="restock-type-filters" style="display: flex; gap: 8px; margin-bottom: 20px;">
                    <button onclick="filterRestockByType('all')" style="padding: 8px 16px; border-radius: 20px; border: 2px solid ${selectedRestockTypeFilter === 'all' ? 'var(--accent-primary)' : 'var(--border-color)'}; background: ${selectedRestockTypeFilter === 'all' ? 'var(--accent-primary)' : 'transparent'}; color: ${selectedRestockTypeFilter === 'all' ? 'white' : 'var(--text-secondary)'}; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-layer-group" style="margin-right: 6px;"></i>All
                    </button>
                    <button onclick="filterRestockByType('product')" style="padding: 8px 16px; border-radius: 20px; border: 2px solid ${selectedRestockTypeFilter === 'product' ? '#10b981' : 'var(--border-color)'}; background: ${selectedRestockTypeFilter === 'product' ? '#10b981' : 'transparent'}; color: ${selectedRestockTypeFilter === 'product' ? 'white' : 'var(--text-secondary)'}; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-box" style="margin-right: 6px;"></i>Products
                    </button>
                    <button onclick="filterRestockByType('supply')" style="padding: 8px 16px; border-radius: 20px; border: 2px solid ${selectedRestockTypeFilter === 'supply' ? '#8b5cf6' : 'var(--border-color)'}; background: ${selectedRestockTypeFilter === 'supply' ? '#8b5cf6' : 'transparent'}; color: ${selectedRestockTypeFilter === 'supply' ? 'white' : 'var(--text-secondary)'}; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-tools" style="margin-right: 6px;"></i>Supplies
                    </button>
                </div>
            `;

            if (filteredRequests.length === 0) {
                return `
                    ${typeFilterButtons}
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="font-size: 16px;">No ${selectedRestockTypeFilter === 'all' ? '' : selectedRestockTypeFilter + ' '}requests found</p>
                    </div>
                `;
            }

            return `
                ${typeFilterButtons}
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    ${filteredRequests.map(request => {
                        const itemType = request.itemType || 'product';
                        const typeLabel = itemType === 'supply' ? 'Supply' : 'Product';
                        const typeColor = itemType === 'supply' ? '#8b5cf6' : '#10b981';
                        const typeIcon = itemType === 'supply' ? 'fa-tools' : 'fa-box';
                        return `
                        <div class="card">
                            <div class="card-body">
                                <div class="restock-request-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap;">
                                            <div style="font-weight: 700; font-size: 16px;">${request.productName}</div>
                                            <span style="background: ${typeColor}; color: white; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 12px; display: inline-flex; align-items: center; gap: 4px;">
                                                <i class="fas ${typeIcon}" style="font-size: 9px;"></i>${typeLabel}
                                            </span>
                                        </div>
                                        <div style="font-size: 13px; color: var(--text-muted);">
                                            Requested by ${request.requestedBy} on ${formatDate(request.requestDate)}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        ${request.status === 'approved' ? `
                                            <span class="status-badge valid" style="background: var(--success); color: white;">
                                                <i class="fas fa-check-circle" style="margin-right: 4px;"></i>Approved
                                            </span>
                                        ` : request.status === 'rejected' ? `
                                            <span class="status-badge expired" style="background: var(--danger); color: white;">
                                                <i class="fas fa-times-circle" style="margin-right: 4px;"></i>Rejected
                                            </span>
                                        ` : `
                                            <span class="status-badge expiring">
                                                Pending
                                            </span>
                                        `}
                                    </div>
                                </div>
                                <div class="restock-request-details" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Quantity</div>
                                        <div style="font-weight: 600; font-size: 14px; color: var(--accent-primary);">${request.quantity} units</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Store</div>
                                        <div style="font-weight: 600; font-size: 14px;">${request.store}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Priority</div>
                                        <div style="font-weight: 600; font-size: 14px; text-transform: capitalize; color: ${request.priority === 'high' ? 'var(--danger)' : request.priority === 'medium' ? 'var(--warning)' : 'var(--success)'};">${request.priority}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Request ID</div>
                                        <div style="font-weight: 600; font-size: 14px; font-family: 'Space Mono', monospace;">#${String(request.id).padStart(4, '0')}</div>
                                    </div>
                                </div>
                                ${request.notes ? `
                                    <div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Notes:</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">${request.notes}</div>
                                    </div>
                                ` : ''}
                                <div class="restock-request-actions" style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                    ${request.status === 'pending' ? `
                                        <button class="btn-secondary" style="font-size: 13px;" onclick="approveRestockRequest('${request.firestoreId || request.id}')">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button class="btn-secondary" style="font-size: 13px;" onclick="rejectRestockRequest('${request.firestoreId || request.id}')">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    ` : ''}
                                    <button class="btn-icon" onclick="openEditRestockRequestModal('${request.firestoreId || request.id}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn-icon danger" onclick="deleteRestockRequest('${request.firestoreId || request.id}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;}).join('')}
                </div>
            `;
        }

        function switchRestockTab(tab) {
            currentRestockTab = tab;
            renderRestockRequests();
        }

        function filterInventoryByStore(store) {
            selectedStoreFilter = store;
            renderRestockRequests();
        }

        function filterRestockByType(type) {
            selectedRestockTypeFilter = type;
            renderRestockRequests();
        }

        function approveRestockRequest(requestId) {
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);
            if (request) {
                request.status = 'approved';
                
                // Update in Firebase if initialized
                if (firebaseRestockRequestsManager.isInitialized) {
                    firebaseRestockRequestsManager.updateRestockRequest(request.firestoreId || requestId, {
                        status: 'approved'
                    }).then(success => {
                        if (success) {
                            console.log('Request approved in Firebase:', requestId);
                            renderRestockRequests();
                        }
                    }).catch(error => {
                        console.error('Error approving request in Firebase:', error);
                        renderRestockRequests();
                    });
                } else {
                    renderRestockRequests();
                }
            }
        }

        function rejectRestockRequest(requestId) {
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);
            if (request) {
                request.status = 'rejected';
                
                // Update in Firebase if initialized
                if (firebaseRestockRequestsManager.isInitialized) {
                    firebaseRestockRequestsManager.updateRestockRequest(request.firestoreId || requestId, {
                        status: 'rejected'
                    }).then(success => {
                        if (success) {
                            console.log('Request rejected in Firebase:', requestId);
                            renderRestockRequests();
                        }
                    }).catch(error => {
                        console.error('Error rejecting request in Firebase:', error);
                        renderRestockRequests();
                    });
                } else {
                    renderRestockRequests();
                }
            }
        }

        function deleteRestockRequest(requestId) {
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);
            const productName = request?.productName || 'this request';

            showConfirmModal({
                title: 'Delete Restock Request',
                message: `Are you sure you want to delete the restock request for "${productName}"?`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: () => {
                    // Remove from local array
                    const index = restockRequests.findIndex(r => r.firestoreId === requestId || r.id === requestId);
                    if (index > -1) {
                        restockRequests.splice(index, 1);
                    }

                    // Delete from Firebase if initialized
                    if (firebaseRestockRequestsManager.isInitialized) {
                        firebaseRestockRequestsManager.deleteRestockRequest(requestId).then(success => {
                            if (success) {
                                console.log('Request deleted from Firebase:', requestId);
                                renderRestockRequests();
                            }
                        }).catch(error => {
                            console.error('Error deleting request from Firebase:', error);
                            renderRestockRequests();
                        });
                    } else {
                        renderRestockRequests();
                    }
                }
            });
        }

        let editingRestockRequestId = null;

        function openEditRestockRequestModal(requestId) {
            editingRestockRequestId = requestId;
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);

            if (!request) {
                alert('Request not found');
                return;
            }

            openModal('edit-restock-request');

            // Populate form with current values
            setTimeout(() => {
                const productName = request.productName;
                // Try to parse product name (Brand ProductName - Flavor format)
                let brand = '', flavor = '', product = '';

                const parts = productName.split(' - ');
                if (parts.length === 2) {
                    flavor = parts[1];
                    const productParts = parts[0].split(' ');
                    if (productParts.length > 1) {
                        brand = productParts[0];
                        product = productParts.slice(1).join(' ');
                    } else {
                        product = parts[0];
                    }
                } else {
                    product = productName;
                }

                // Set form values
                document.getElementById('edit-restock-item-type').value = request.itemType || 'product';
                document.getElementById('edit-restock-product').value = product || '';
                document.getElementById('edit-restock-quantity').value = request.quantity || '';
                document.getElementById('edit-restock-priority').value = request.priority || 'medium';
                document.getElementById('edit-restock-date').value = request.requestDate || '';
                document.getElementById('edit-restock-store').value = request.store || '';
                document.getElementById('edit-restock-notes').value = request.notes || '';

                // Set brand dropdown - try to match existing option or select "Other"
                const brandSelect = document.getElementById('edit-restock-brand');
                if (brandSelect) {
                    const brandOption = Array.from(brandSelect.options).find(opt => opt.value === brand);
                    if (brandOption) {
                        brandSelect.value = brand;
                    } else if (brand) {
                        brandSelect.value = 'Other';
                    }
                }

                // Set flavor dropdown - try to match existing option or select "Other"
                const flavorSelect = document.getElementById('edit-restock-flavor');
                if (flavorSelect) {
                    const flavorOption = Array.from(flavorSelect.options).find(opt => opt.value === flavor);
                    if (flavorOption) {
                        flavorSelect.value = flavor;
                    } else if (flavor) {
                        flavorSelect.value = 'Other';
                    }
                }

                // Populate and set employee dropdown
                populateEmployeeDropdown('edit-restock-requested-by', request.requestedBy || '');
            }, 100);
        }

        function submitEditRestockRequest() {
            const itemType = document.getElementById('edit-restock-item-type').value;
            const product = document.getElementById('edit-restock-product').value;
            const brand = document.getElementById('edit-restock-brand').value;
            const flavor = document.getElementById('edit-restock-flavor').value;
            const quantity = document.getElementById('edit-restock-quantity').value;
            const priority = document.getElementById('edit-restock-priority').value;
            const date = document.getElementById('edit-restock-date').value;
            const store = document.getElementById('edit-restock-store').value;
            const requestedBy = document.getElementById('edit-restock-requested-by').value;
            const notes = document.getElementById('edit-restock-notes').value;

            // Validation
            if (!product || !quantity || !priority || !date || !store || !requestedBy) {
                alert('Please fill in all required fields');
                return;
            }

            // Find and update the request
            const request = restockRequests.find(r => r.firestoreId === editingRestockRequestId || r.id === editingRestockRequestId);
            if (!request) {
                alert('Request not found');
                return;
            }

            // Build product name
            let productName = product;
            if (brand) productName = `${brand} ${productName}`;
            if (flavor) productName = `${productName} - ${flavor}`;

            // Update local request
            request.productName = productName;
            request.itemType = itemType;
            request.quantity = parseInt(quantity);
            request.priority = priority;
            request.requestDate = date;
            request.store = store;
            request.requestedBy = requestedBy;
            request.notes = notes;
            request.status = 'pending';  // Automatically set to pending when edited

            // Update in Firebase if initialized
            if (firebaseRestockRequestsManager.isInitialized) {
                const updateData = {
                    productName: productName,
                    itemType: itemType,
                    quantity: parseInt(quantity),
                    priority: priority,
                    requestDate: date,
                    store: store,
                    requestedBy: requestedBy,
                    notes: notes,
                    status: 'pending'  // Automatically set to pending when edited
                };

                firebaseRestockRequestsManager.updateRestockRequest(editingRestockRequestId, updateData).then(success => {
                    if (success) {
                        console.log('Request updated in Firebase and status set to pending:', editingRestockRequestId);
                        closeModal();
                        currentRestockTab = 'requests';
                        renderRestockRequests();
                    } else {
                        alert('Error updating request. Please try again.');
                    }
                }).catch(error => {
                    console.error('Error updating request in Firebase:', error);
                    alert('Error updating request: ' + error.message);
                });
            } else {
                // Fallback to local storage only
                closeModal();
                currentRestockTab = 'requests';
                renderRestockRequests();
            }

            editingRestockRequestId = null;
        }

        function renderAbundanceCloud() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Abundance Cloud</h2>
                        <p class="section-subtitle">Custom app integration</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body" style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-cloud" style="font-size: 64px; color: var(--accent-primary); margin-bottom: 24px;"></i>
                        <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 12px;">Abundance Cloud</h3>
                        <p style="color: var(--text-muted); font-size: 15px; max-width: 500px; margin: 0 auto;">
                            This module is currently under development. Check back soon for updates.
                        </p>
                    </div>
                </div>
            `;
        }

        function renderTaskCard(task) {
            return `
                <div class="task-card priority-${task.priority}">
                    <div class="task-priority ${task.priority}">${task.priority}</div>
                    <h4 class="task-title">${task.title}</h4>
                    <div class="task-meta">
                        <span><i class="fas fa-user"></i> ${task.assignee}</span>
                        <span><i class="fas fa-calendar"></i> ${formatDate(task.due)}</span>
                    </div>
                </div>
            `;
        }

        // Schedules data array
        let schedules = [];
        let daysOff = []; // Array to store employee days off: { employeeId, date, store }
        let currentWeekStart = getWeekStart(new Date());
        let draggedShift = null;

        // Shift types configuration
        const SHIFT_TYPES = {
            opening: {
                name: 'Opening',
                icon: 'fa-sun',
                color: '#f59e0b',
                gradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                defaultStart: '09:00',
                defaultEnd: '17:00'
            },
            closing: {
                name: 'Closing',
                icon: 'fa-moon',
                color: '#6366f1',
                gradient: 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)',
                defaultStart: '14:00',
                defaultEnd: '22:00'
            }
        };

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function getWeekDates(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function formatDateKey(date) {
            // Use local date components to avoid timezone offset issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Convert number to ordinal (1st, 2nd, 3rd, etc.)
         */
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function renderSchedule() {
            const dashboard = document.querySelector('.dashboard');
            const weekDates = getWeekDates(currentWeekStart);
            const weekRangeText = `${weekDates[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekDates[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            dashboard.innerHTML = `
                <style>
                    /* Schedule Header */
                    .schedule-header-bar {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 24px;
                        flex-wrap: wrap;
                        gap: 16px;
                    }
                    .schedule-title-section h2 {
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 4px;
                    }
                    .schedule-title-section p {
                        color: var(--text-muted);
                        font-size: 14px;
                    }
                    .schedule-controls {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    .week-nav {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        background: var(--bg-card);
                        padding: 6px;
                        border-radius: 12px;
                        border: 1px solid var(--border-color);
                    }
                    .week-nav-btn {
                        background: transparent;
                        border: none;
                        width: 36px;
                        height: 36px;
                        border-radius: 8px;
                        cursor: pointer;
                        color: var(--text-secondary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    .week-nav-btn:hover {
                        background: var(--accent-primary);
                        color: white;
                    }
                    .week-display {
                        font-size: 15px;
                        font-weight: 600;
                        min-width: 180px;
                        text-align: center;
                        color: var(--text-primary);
                    }
                    .store-filter-select {
                        background: var(--bg-card);
                        border: 1px solid var(--border-color);
                        border-radius: 10px;
                        padding: 10px 16px;
                        color: var(--text-primary);
                        font-size: 14px;
                        cursor: pointer;
                        min-width: 160px;
                    }

                    /* Days Grid - Horizontal scroll for week */
                    .schedule-days-container {
                        display: flex;
                        gap: 12px;
                        overflow-x: auto;
                        padding-bottom: 12px;
                        scroll-snap-type: x mandatory;
                    }
                    .schedule-days-container::-webkit-scrollbar {
                        height: 6px;
                    }
                    .schedule-days-container::-webkit-scrollbar-track {
                        background: var(--bg-secondary);
                        border-radius: 3px;
                    }
                    .schedule-days-container::-webkit-scrollbar-thumb {
                        background: var(--border-color);
                        border-radius: 3px;
                    }

                    /* Day Card */
                    .schedule-day-card {
                        flex: 0 0 calc(14.28% - 10px);
                        min-width: 200px;
                        background: var(--bg-card);
                        border-radius: 16px;
                        border: 1px solid var(--border-color);
                        overflow: hidden;
                        scroll-snap-align: start;
                        transition: all 0.3s ease;
                    }
                    .schedule-day-card:hover {
                        border-color: var(--accent-primary);
                        box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1);
                    }
                    .schedule-day-card.today {
                        border-color: var(--accent-primary);
                        box-shadow: 0 0 0 2px var(--accent-glow);
                    }
                    .day-card-header {
                        padding: 16px;
                        text-align: center;
                        border-bottom: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                    }
                    .schedule-day-card.today .day-card-header {
                        background: var(--accent-gradient);
                    }
                    .schedule-day-card.today .day-card-header * {
                        color: white !important;
                    }
                    .day-card-header .day-name {
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        color: var(--text-muted);
                        font-weight: 600;
                    }
                    .day-card-header .day-number {
                        font-size: 28px;
                        font-weight: 700;
                        color: var(--text-primary);
                        line-height: 1.2;
                    }
                    .day-card-body {
                        padding: 12px;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    /* Shift Slot */
                    .shift-slot {
                        border-radius: 12px;
                        padding: 12px;
                        transition: all 0.2s;
                        position: relative;
                    }
                    .shift-slot.opening {
                        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%);
                        border: 1px solid rgba(245, 158, 11, 0.2);
                    }
                    .shift-slot.closing {
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(79, 70, 229, 0.05) 100%);
                        border: 1px solid rgba(99, 102, 241, 0.2);
                    }
                    .shift-slot-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 10px;
                    }
                    .shift-type-badge {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        font-size: 11px;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .shift-slot.opening .shift-type-badge {
                        color: #f59e0b;
                    }
                    .shift-slot.closing .shift-type-badge {
                        color: #6366f1;
                    }
                    .shift-time-display {
                        font-size: 12px;
                        color: var(--text-muted);
                        font-weight: 500;
                    }

                    /* Employee Drop Zone */
                    .employee-drop-zone {
                        min-height: 50px;
                        border: 2px dashed var(--border-color);
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s;
                        padding: 8px;
                    }
                    .employee-drop-zone:hover {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.05);
                    }
                    .employee-drop-zone.drag-over {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.1);
                        border-style: solid;
                    }
                    .employee-drop-zone.empty {
                        color: var(--text-muted);
                        font-size: 13px;
                    }
                    .employee-drop-zone.empty i {
                        margin-right: 6px;
                    }

                    /* Assigned Employee Card */
                    .assigned-employee {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 8px 12px;
                        background: var(--bg-secondary);
                        border-radius: 10px;
                        width: 100%;
                        cursor: grab;
                        transition: all 0.2s;
                        position: relative;
                    }
                    .assigned-employee:hover {
                        background: var(--bg-hover);
                        transform: translateY(-1px);
                    }
                    .assigned-employee:active {
                        cursor: grabbing;
                    }
                    .assigned-employee.dragging {
                        opacity: 0.5;
                        transform: scale(0.98);
                    }
                    .assigned-employee-avatar {
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 13px;
                        font-weight: 600;
                        color: white;
                        flex-shrink: 0;
                    }
                    .assigned-employee-info {
                        flex: 1;
                        min-width: 0;
                    }
                    .assigned-employee-name {
                        font-size: 14px;
                        font-weight: 600;
                        color: var(--text-primary);
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .assigned-employee-hours {
                        font-size: 12px;
                        color: var(--text-muted);
                    }
                    .assigned-employee-remove {
                        position: absolute;
                        top: -6px;
                        right: -6px;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: var(--danger);
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10px;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .assigned-employee:hover .assigned-employee-remove {
                        opacity: 1;
                    }
                    .assigned-employee-clone {
                        position: absolute;
                        top: -6px;
                        right: 18px;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: var(--accent-primary);
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 9px;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .assigned-employee:hover .assigned-employee-clone {
                        opacity: 1;
                    }
                    .assigned-employee-clone:hover {
                        background: var(--accent-secondary);
                        transform: scale(1.1);
                    }

                    /* Days Off Section */
                    .day-off-section {
                        margin-top: 12px;
                        border-top: 1px solid var(--border-color);
                        padding-top: 12px;
                    }
                    .day-off-header {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px 12px;
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.05) 100%);
                        border-radius: 8px;
                        font-size: 12px;
                        font-weight: 600;
                        color: var(--text-secondary);
                        cursor: pointer;
                        transition: all 0.2s;
                        border: 1px solid rgba(99, 102, 241, 0.15);
                    }
                    .day-off-header:hover {
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(139, 92, 246, 0.08) 100%);
                        border-color: var(--accent-primary);
                    }
                    .day-off-employees {
                        margin-top: 8px;
                        display: flex;
                        flex-direction: column;
                        gap: 6px;
                    }
                    .day-off-employee-badge {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 6px 10px;
                        background: var(--bg-secondary);
                        border-radius: 8px;
                        font-size: 13px;
                        position: relative;
                        transition: all 0.2s;
                    }
                    .day-off-employee-badge:hover {
                        background: var(--bg-hover);
                    }
                    .day-off-avatar {
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        font-weight: 600;
                        color: white;
                        flex-shrink: 0;
                    }
                    .day-off-name {
                        flex: 1;
                        color: var(--text-primary);
                        font-weight: 500;
                        font-size: 12px;
                    }
                    .day-off-remove {
                        width: 18px;
                        height: 18px;
                        border-radius: 50%;
                        background: var(--danger);
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 9px;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .day-off-employee-badge:hover .day-off-remove {
                        opacity: 1;
                    }
                    .day-off-remove:hover {
                        background: #dc2626;
                        transform: scale(1.1);
                    }
                    .day-off-empty {
                        padding: 12px;
                        text-align: center;
                        color: var(--text-muted);
                        font-size: 12px;
                        font-style: italic;
                    }

                    /* Time Slider */
                    .time-slider-container {
                        margin-top: 8px;
                        padding: 12px;
                        background: var(--bg-secondary);
                        border-radius: 10px;
                        display: none;
                    }
                    .time-slider-container.active {
                        display: block;
                    }
                    .time-slider-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                    }
                    .time-slider-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        color: var(--text-muted);
                    }
                    .time-slider-value {
                        font-size: 14px;
                        font-weight: 700;
                        color: var(--text-primary);
                    }
                    .time-slider-track {
                        position: relative;
                        height: 40px;
                        background: var(--bg-card);
                        border-radius: 8px;
                        border: 1px solid var(--border-color);
                        overflow: hidden;
                    }
                    .time-slider-hours {
                        display: flex;
                        justify-content: space-between;
                        padding: 0 4px;
                        margin-top: 6px;
                    }
                    .time-slider-hours span {
                        font-size: 9px;
                        color: var(--text-muted);
                    }
                    .time-slider-range {
                        position: absolute;
                        top: 4px;
                        bottom: 4px;
                        border-radius: 6px;
                        cursor: move;
                        transition: background 0.2s;
                    }
                    .shift-slot.opening .time-slider-range {
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    }
                    .shift-slot.closing .time-slider-range {
                        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
                    }
                    .time-slider-handle {
                        position: absolute;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 16px;
                        height: 28px;
                        background: white;
                        border-radius: 4px;
                        cursor: ew-resize;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .time-slider-handle::after {
                        content: '';
                        width: 4px;
                        height: 12px;
                        background: var(--border-color);
                        border-radius: 2px;
                    }
                    .time-slider-handle.start {
                        left: -8px;
                    }
                    .time-slider-handle.end {
                        right: -8px;
                    }
                    .time-slider-actions {
                        display: flex;
                        gap: 8px;
                        margin-top: 12px;
                    }
                    .time-slider-btn {
                        flex: 1;
                        padding: 8px 12px;
                        border-radius: 8px;
                        border: none;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 600;
                        transition: all 0.2s;
                    }
                    .time-slider-btn.save {
                        background: var(--accent-primary);
                        color: white;
                    }
                    .time-slider-btn.save:hover {
                        background: var(--accent-secondary);
                    }
                    .time-slider-btn.cancel {
                        background: var(--bg-card);
                        color: var(--text-secondary);
                        border: 1px solid var(--border-color);
                    }

                    /* Employee Picker Modal */
                    .employee-picker-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        backdrop-filter: blur(4px);
                        z-index: 1000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0;
                        visibility: hidden;
                        transition: all 0.3s;
                    }
                    .employee-picker-overlay.active {
                        opacity: 1;
                        visibility: visible;
                    }
                    .employee-picker {
                        background: var(--bg-card);
                        border-radius: 20px;
                        width: 90%;
                        max-width: 400px;
                        max-height: 80vh;
                        overflow: hidden;
                        transform: scale(0.9);
                        transition: transform 0.3s;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }
                    .employee-picker-overlay.active .employee-picker {
                        transform: scale(1);
                    }
                    .employee-picker-header {
                        padding: 20px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .employee-picker-header h3 {
                        font-size: 18px;
                        font-weight: 600;
                    }
                    .employee-picker-close {
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        background: var(--bg-secondary);
                        border: none;
                        cursor: pointer;
                        color: var(--text-secondary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    .employee-picker-close:hover {
                        background: var(--danger);
                        color: white;
                    }
                    .employee-picker-search {
                        padding: 16px 20px;
                        border-bottom: 1px solid var(--border-color);
                    }
                    .employee-picker-search input {
                        width: 100%;
                        padding: 12px 16px;
                        border-radius: 10px;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        font-size: 14px;
                    }
                    .employee-picker-search input:focus {
                        outline: none;
                        border-color: var(--accent-primary);
                    }
                    .employee-picker-list {
                        padding: 12px;
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .employee-picker-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .employee-picker-item:hover {
                        background: var(--bg-hover);
                    }
                    .employee-picker-avatar {
                        width: 44px;
                        height: 44px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        font-weight: 600;
                        color: white;
                    }
                    .employee-picker-info {
                        flex: 1;
                    }
                    .employee-picker-name {
                        font-weight: 600;
                        font-size: 15px;
                    }
                    .employee-picker-store {
                        font-size: 13px;
                        color: var(--text-muted);
                    }

                    /* Time Editor Modal */
                    .time-editor-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.6);
                        backdrop-filter: blur(8px);
                        z-index: 1001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0;
                        visibility: hidden;
                        transition: all 0.3s;
                    }
                    .time-editor-overlay.active {
                        opacity: 1;
                        visibility: visible;
                    }
                    .time-editor-modal {
                        background: var(--bg-card);
                        border-radius: 24px;
                        width: 90%;
                        max-width: 480px;
                        overflow: hidden;
                        transform: scale(0.9) translateY(20px);
                        transition: transform 0.3s;
                        box-shadow: 0 25px 80px rgba(0,0,0,0.4);
                    }
                    .time-editor-overlay.active .time-editor-modal {
                        transform: scale(1) translateY(0);
                    }
                    .time-editor-header {
                        padding: 24px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .time-editor-header h3 {
                        font-size: 20px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .time-editor-close {
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        background: var(--bg-secondary);
                        border: none;
                        cursor: pointer;
                        color: var(--text-secondary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        transition: all 0.2s;
                    }
                    .time-editor-close:hover {
                        background: var(--danger);
                        color: white;
                    }
                    .time-editor-body {
                        padding: 24px;
                    }
                    .time-editor-info {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        padding: 16px;
                        background: var(--bg-secondary);
                        border-radius: 16px;
                        margin-bottom: 24px;
                    }
                    .time-editor-avatar {
                        width: 56px;
                        height: 56px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        font-weight: 700;
                        color: white;
                    }
                    .time-editor-details h4 {
                        font-size: 18px;
                        font-weight: 600;
                        margin-bottom: 4px;
                    }
                    .time-editor-details p {
                        font-size: 14px;
                        color: var(--text-muted);
                    }
                    .time-editor-current {
                        text-align: center;
                        margin-bottom: 24px;
                    }
                    .time-editor-current-label {
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        color: var(--text-muted);
                        margin-bottom: 8px;
                    }
                    .time-editor-current-value {
                        font-size: 32px;
                        font-weight: 700;
                        color: var(--text-primary);
                    }
                    .time-editor-current-hours {
                        font-size: 14px;
                        color: var(--accent-primary);
                        margin-top: 4px;
                    }
                    .time-editor-slider-section {
                        margin-bottom: 24px;
                    }
                    .time-editor-slider-label {
                        font-size: 13px;
                        font-weight: 600;
                        color: var(--text-secondary);
                        margin-bottom: 12px;
                        display: flex;
                        justify-content: space-between;
                    }
                    .time-editor-slider-track {
                        position: relative;
                        height: 56px;
                        background: var(--bg-secondary);
                        border-radius: 12px;
                        border: 2px solid var(--border-color);
                        overflow: hidden;
                        margin-bottom: 8px;
                    }
                    .time-editor-slider-track:hover {
                        border-color: var(--accent-primary);
                    }
                    .time-editor-slider-range {
                        position: absolute;
                        top: 4px;
                        bottom: 4px;
                        border-radius: 8px;
                        cursor: grab;
                    }
                    .time-editor-slider-range:active {
                        cursor: grabbing;
                    }
                    .time-editor-slider-range.opening {
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    }
                    .time-editor-slider-range.closing {
                        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
                    }
                    .time-editor-handle {
                        position: absolute;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 24px;
                        height: 44px;
                        background: white;
                        border-radius: 8px;
                        cursor: ew-resize;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: box-shadow 0.2s;
                    }
                    .time-editor-handle:hover {
                        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
                    }
                    .time-editor-handle::after {
                        content: '';
                        width: 6px;
                        height: 20px;
                        background: linear-gradient(180deg, var(--border-color) 0%, var(--border-color) 33%, transparent 33%, transparent 66%, var(--border-color) 66%);
                        border-radius: 3px;
                    }
                    .time-editor-handle.start {
                        left: -12px;
                    }
                    .time-editor-handle.end {
                        right: -12px;
                    }
                    .time-editor-hours-ruler {
                        display: flex;
                        justify-content: space-between;
                        padding: 0 4px;
                    }
                    .time-editor-hours-ruler span {
                        font-size: 11px;
                        color: var(--text-muted);
                        font-weight: 500;
                    }
                    .time-editor-presets {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 10px;
                        margin-bottom: 24px;
                    }
                    .time-editor-preset {
                        padding: 12px;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.2s;
                    }
                    .time-editor-preset:hover {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.1);
                    }
                    .time-editor-preset.active {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.15);
                    }
                    .time-editor-preset-time {
                        font-size: 14px;
                        font-weight: 700;
                        color: var(--text-primary);
                    }
                    .time-editor-preset-label {
                        font-size: 11px;
                        color: var(--text-muted);
                        margin-top: 2px;
                    }
                    .time-editor-footer {
                        padding: 20px 24px;
                        border-top: 1px solid var(--border-color);
                        display: flex;
                        gap: 12px;
                    }
                    .time-editor-btn {
                        flex: 1;
                        padding: 14px 20px;
                        border-radius: 12px;
                        border: none;
                        cursor: pointer;
                        font-size: 15px;
                        font-weight: 600;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    }
                    .time-editor-btn.cancel {
                        background: var(--bg-secondary);
                        color: var(--text-secondary);
                        border: 1px solid var(--border-color);
                    }
                    .time-editor-btn.cancel:hover {
                        background: var(--bg-hover);
                    }
                    .time-editor-btn.save {
                        background: var(--accent-primary);
                        color: white;
                    }
                    .time-editor-btn.save:hover {
                        background: var(--accent-secondary);
                        transform: translateY(-1px);
                    }
                    .time-editor-btn.delete {
                        background: transparent;
                        color: var(--danger);
                        flex: 0;
                        padding: 14px;
                    }
                    .time-editor-btn.delete:hover {
                        background: rgba(239, 68, 68, 0.1);
                    }

                    /* Clone Modal */
                    .clone-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.6);
                        backdrop-filter: blur(8px);
                        z-index: 1001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0;
                        visibility: hidden;
                        transition: all 0.3s;
                    }
                    .clone-modal-overlay.active {
                        opacity: 1;
                        visibility: visible;
                    }
                    .clone-modal {
                        background: var(--bg-card);
                        border-radius: 20px;
                        width: 90%;
                        max-width: 400px;
                        overflow: hidden;
                        transform: scale(0.9);
                        transition: transform 0.3s;
                        box-shadow: 0 25px 80px rgba(0,0,0,0.4);
                    }
                    .clone-modal-overlay.active .clone-modal {
                        transform: scale(1);
                    }
                    .clone-modal-header {
                        padding: 20px 24px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .clone-modal-header h3 {
                        font-size: 18px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .clone-modal-body {
                        padding: 24px;
                    }
                    .clone-option {
                        padding: 16px;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        margin-bottom: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        gap: 14px;
                    }
                    .clone-option:hover {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.05);
                    }
                    .clone-option-icon {
                        width: 44px;
                        height: 44px;
                        border-radius: 10px;
                        background: var(--bg-secondary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        color: var(--accent-primary);
                    }
                    .clone-option-info h4 {
                        font-size: 15px;
                        font-weight: 600;
                        margin-bottom: 2px;
                    }
                    .clone-option-info p {
                        font-size: 13px;
                        color: var(--text-muted);
                    }
                    .clone-modal-footer {
                        padding: 16px 24px;
                        border-top: 1px solid var(--border-color);
                        display: flex;
                        justify-content: flex-end;
                    }

                    /* All Stores View */
                    .stores-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .store-schedule-card {
                        background: var(--bg-card);
                        border-radius: 16px;
                        border: 1px solid var(--border-color);
                        overflow: hidden;
                    }
                    .store-schedule-header {
                        padding: 16px 20px;
                        background: var(--bg-secondary);
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    }
                    .store-schedule-header h4 {
                        font-size: 16px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .store-schedule-header .store-icon {
                        width: 32px;
                        height: 32px;
                        border-radius: 8px;
                        background: var(--accent-gradient);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 14px;
                    }
                    .store-schedule-body {
                        padding: 12px;
                    }
                    .store-day-row {
                        display: flex;
                        align-items: stretch;
                        gap: 8px;
                        padding: 8px 0;
                        border-bottom: 1px solid var(--border-color);
                    }
                    .store-day-row:last-child {
                        border-bottom: none;
                    }
                    .store-day-label {
                        width: 60px;
                        font-size: 11px;
                        font-weight: 600;
                        color: var(--text-muted);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        white-space: nowrap;
                    }
                    .store-day-label.today {
                        color: var(--accent-primary);
                    }
                    .store-shifts {
                        flex: 1;
                        display: flex;
                        gap: 6px;
                    }
                    .store-shift-slot {
                        flex: 1;
                        min-height: 40px;
                        border-radius: 8px;
                        padding: 6px 8px;
                        font-size: 11px;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .store-shift-slot.opening {
                        background: rgba(245, 158, 11, 0.1);
                        border: 1px solid rgba(245, 158, 11, 0.2);
                    }
                    .store-shift-slot.closing {
                        background: rgba(99, 102, 241, 0.1);
                        border: 1px solid rgba(99, 102, 241, 0.2);
                    }
                    .store-shift-slot.empty {
                        background: var(--bg-secondary);
                        border: 1px dashed var(--border-color);
                        align-items: center;
                        color: var(--text-muted);
                    }
                    .store-shift-slot:hover {
                        transform: scale(1.02);
                    }
                    .store-shift-slot.filled {
                        cursor: grab;
                        position: relative;
                    }
                    .store-shift-slot.filled:active {
                        cursor: grabbing;
                    }
                    .store-shift-slot.filled.dragging {
                        opacity: 0.5;
                        transform: scale(0.95);
                    }
                    .store-shift-slot.empty.drag-over {
                        background: rgba(99, 102, 241, 0.2);
                        border: 2px solid var(--accent-primary);
                        border-style: solid;
                    }
                    .store-shift-name {
                        font-weight: 600;
                        color: var(--text-primary);
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .store-shift-time {
                        color: var(--text-muted);
                        font-size: 10px;
                    }
                    .store-shift-clone {
                        position: absolute;
                        top: 2px;
                        right: 2px;
                        width: 18px;
                        height: 18px;
                        border-radius: 4px;
                        background: rgba(255,255,255,0.9);
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 9px;
                        color: var(--accent-primary);
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .store-shift-slot:hover .store-shift-clone {
                        opacity: 1;
                    }
                    .store-shift-clone:hover {
                        background: var(--accent-primary);
                        color: white;
                    }

                    /* Days Off Section for All Stores View */
                    .store-days-off-section {
                        padding: 16px;
                        border-top: 1px solid var(--border-color);
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.02) 100%);
                    }
                    .store-days-off-header {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 12px;
                        color: var(--text-secondary);
                    }
                    .store-days-off-header.clickable {
                        cursor: pointer;
                        padding: 8px 12px;
                        background: rgba(99, 102, 241, 0.05);
                        border-radius: 8px;
                        border: 1px solid rgba(99, 102, 241, 0.15);
                        transition: all 0.2s;
                    }
                    .store-days-off-header.clickable:hover {
                        background: rgba(99, 102, 241, 0.1);
                        border-color: var(--accent-primary);
                        transform: translateY(-1px);
                    }
                    .store-days-off-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    .store-day-off-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 8px 12px;
                        background: var(--bg-card);
                        border-radius: 8px;
                        border: 1px solid var(--border-color);
                        transition: all 0.2s;
                        position: relative;
                    }
                    .store-day-off-item:hover {
                        background: var(--bg-hover);
                        border-color: var(--accent-primary);
                    }
                    .store-day-off-avatar {
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        font-weight: 600;
                        color: white;
                        flex-shrink: 0;
                    }
                    .store-day-off-info {
                        flex: 1;
                        min-width: 0;
                    }
                    .store-day-off-name {
                        font-size: 13px;
                        font-weight: 600;
                        color: var(--text-primary);
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .store-day-off-date {
                        font-size: 11px;
                        color: var(--text-muted);
                    }
                    .store-day-off-remove {
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: var(--danger);
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10px;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .store-day-off-item:hover .store-day-off-remove {
                        opacity: 1;
                    }
                    .store-day-off-remove:hover {
                        background: #dc2626;
                        transform: scale(1.1);
                    }
                    .store-days-off-empty {
                        padding: 16px;
                        text-align: center;
                        color: var(--text-muted);
                        font-size: 12px;
                        font-style: italic;
                    }

                    /* Date Picker Modal for All Stores View */
                    .date-picker-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        backdrop-filter: blur(4px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }
                    .date-picker-modal-overlay.active {
                        opacity: 1;
                    }
                    .date-picker-modal {
                        background: var(--bg-card);
                        border-radius: 16px;
                        border: 1px solid var(--border-color);
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        transform: scale(0.9);
                        transition: transform 0.3s ease;
                    }
                    .date-picker-modal-overlay.active .date-picker-modal {
                        transform: scale(1);
                    }
                    .date-picker-header {
                        padding: 20px 24px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        background: var(--bg-secondary);
                    }
                    .date-picker-header h3 {
                        margin: 0;
                        font-size: 18px;
                        font-weight: 600;
                        color: var(--text-primary);
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .close-modal-btn {
                        width: 32px;
                        height: 32px;
                        border-radius: 8px;
                        background: transparent;
                        border: none;
                        color: var(--text-muted);
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    .close-modal-btn:hover {
                        background: var(--bg-hover);
                        color: var(--text-primary);
                    }
                    .date-picker-body {
                        padding: 24px;
                    }
                    .date-picker-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                    }
                    .date-picker-option {
                        padding: 16px;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.2s;
                        background: var(--bg-secondary);
                        position: relative;
                    }
                    .date-picker-option:hover {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.05);
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
                    }
                    .date-picker-option.today {
                        border-color: var(--accent-primary);
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
                    }
                    .date-picker-day {
                        font-size: 14px;
                        font-weight: 600;
                        color: var(--text-primary);
                        margin-bottom: 4px;
                    }
                    .date-picker-date {
                        font-size: 12px;
                        color: var(--text-muted);
                    }
                    .date-picker-today-badge {
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: var(--accent-primary);
                        color: white;
                        font-size: 9px;
                        font-weight: 600;
                        padding: 2px 6px;
                        border-radius: 4px;
                        text-transform: uppercase;
                    }
                </style>

                <div class="schedule-header-bar">
                    <div class="schedule-title-section">
                        <h2><i class="fas fa-calendar-alt" style="color: var(--accent-primary); margin-right: 10px;"></i>Schedule</h2>
                        <p>Drag employees to Opening or Closing shifts</p>
                    </div>
                    <div class="schedule-controls">
                        <button class="week-nav-btn" onclick="openCloneModal()" title="Clone from previous week" style="background: var(--bg-card); border: 1px solid var(--border-color); margin-right: 8px;">
                            <i class="fas fa-clone"></i>
                        </button>
                        <div class="week-nav">
                            <button class="week-nav-btn" onclick="changeWeek(-1)" title="Previous week">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="week-display">${weekRangeText}</div>
                            <button class="week-nav-btn" onclick="changeWeek(1)" title="Next week">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="week-nav-btn" onclick="goToToday()" title="Today">
                                <i class="fas fa-calendar-day"></i>
                            </button>
                        </div>
                        <select class="store-filter-select" id="schedule-store-filter" onchange="renderScheduleGrid()">
                            <option value="all">All Stores</option>
                            <option value="Miramar">VSU Miramar</option>
                            <option value="Morena">VSU Morena</option>
                            <option value="Kearny Mesa">VSU Kearny Mesa</option>
                            <option value="Chula Vista">VSU Chula Vista</option>
                            <option value="North Park">VSU North Park</option>
                            <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                        </select>
                    </div>
                </div>

                <div id="schedule-container">
                    <div style="padding: 60px; text-align: center;">
                        <div class="loading-spinner"></div>
                        <p style="color: var(--text-muted); margin-top: 15px;">Loading schedules...</p>
                    </div>
                </div>

                <!-- Employee Picker Modal -->
                <div class="employee-picker-overlay" id="employeePickerOverlay" onclick="closeEmployeePicker(event)">
                    <div class="employee-picker" onclick="event.stopPropagation()">
                        <div class="employee-picker-header">
                            <h3><i class="fas fa-user-plus" style="margin-right: 8px; color: var(--accent-primary);"></i>Assign Employee</h3>
                            <button class="employee-picker-close" onclick="closeEmployeePicker()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="employee-picker-search">
                            <input type="text" id="employeePickerSearch" placeholder="Search employee..." oninput="filterEmployeePicker()">
                        </div>
                        <div class="employee-picker-list" id="employeePickerList">
                            <!-- Employees will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Time Editor Modal -->
                <div class="time-editor-overlay" id="timeEditorOverlay" onclick="closeTimeEditor(event)">
                    <div class="time-editor-modal" onclick="event.stopPropagation()">
                        <div class="time-editor-header">
                            <h3 id="timeEditorTitle"><i class="fas fa-clock"></i> Edit Shift</h3>
                            <button class="time-editor-close" onclick="closeTimeEditor()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="time-editor-body">
                            <div class="time-editor-info" id="timeEditorInfo">
                                <!-- Employee info will be loaded here -->
                            </div>
                            <div class="time-editor-current">
                                <div class="time-editor-current-label">Current Schedule</div>
                                <div class="time-editor-current-value" id="timeEditorCurrentValue">9:00a - 5:00p</div>
                                <div class="time-editor-current-hours" id="timeEditorCurrentHours">8.0 hours</div>
                            </div>
                            <div class="time-editor-presets">
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('06:00', '14:00')">
                                    <div class="time-editor-preset-time">6a - 2p</div>
                                    <div class="time-editor-preset-label">Early</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('09:00', '17:00')">
                                    <div class="time-editor-preset-time">9a - 5p</div>
                                    <div class="time-editor-preset-label">Standard</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('10:00', '18:00')">
                                    <div class="time-editor-preset-time">10a - 6p</div>
                                    <div class="time-editor-preset-label">Mid</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('12:00', '20:00')">
                                    <div class="time-editor-preset-time">12p - 8p</div>
                                    <div class="time-editor-preset-label">Afternoon</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('14:00', '22:00')">
                                    <div class="time-editor-preset-time">2p - 10p</div>
                                    <div class="time-editor-preset-label">Evening</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('16:00', '00:00')">
                                    <div class="time-editor-preset-time">4p - 12a</div>
                                    <div class="time-editor-preset-label">Night</div>
                                </div>
                            </div>
                            <div class="time-editor-slider-section">
                                <div class="time-editor-slider-label">
                                    <span>Drag to adjust</span>
                                </div>
                                <div class="time-editor-slider-track" id="timeEditorTrack">
                                    <div class="time-editor-slider-range" id="timeEditorRange">
                                        <div class="time-editor-handle start" id="timeEditorHandleStart"></div>
                                        <div class="time-editor-handle end" id="timeEditorHandleEnd"></div>
                                    </div>
                                </div>
                                <div class="time-editor-hours-ruler">
                                    <span>6am</span>
                                    <span>9am</span>
                                    <span>12pm</span>
                                    <span>3pm</span>
                                    <span>6pm</span>
                                    <span>9pm</span>
                                    <span>12am</span>
                                </div>
                            </div>
                        </div>
                        <div class="time-editor-footer">
                            <button class="time-editor-btn delete" onclick="deleteFromTimeEditor()" title="Remove shift">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="time-editor-btn cancel" onclick="closeTimeEditor()">Cancel</button>
                            <button class="time-editor-btn save" onclick="saveTimeEditor()">
                                <i class="fas fa-check"></i> Save
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Clone Modal -->
                <div class="clone-modal-overlay" id="cloneModalOverlay" onclick="closeCloneModal(event)">
                    <div class="clone-modal" onclick="event.stopPropagation()">
                        <div class="clone-modal-header">
                            <h3><i class="fas fa-clone" style="color: var(--accent-primary);"></i> Clone Schedule</h3>
                            <button class="time-editor-close" onclick="closeCloneModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="clone-modal-body">
                            <div class="clone-option" onclick="cloneFromPreviousWeek()">
                                <div class="clone-option-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <div class="clone-option-info">
                                    <h4>Clone Previous Week</h4>
                                    <p>Copy all shifts from last week to this week</p>
                                </div>
                            </div>
                            <div class="clone-option" onclick="cloneToNextWeek()">
                                <div class="clone-option-icon">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <div class="clone-option-info">
                                    <h4>Clone to Next Week</h4>
                                    <p>Copy this week's shifts to next week</p>
                                </div>
                            </div>
                            <div class="clone-option" onclick="clearCurrentWeek()">
                                <div class="clone-option-icon" style="color: var(--danger);">
                                    <i class="fas fa-trash-alt"></i>
                                </div>
                                <div class="clone-option-info">
                                    <h4>Clear This Week</h4>
                                    <p>Remove all shifts from current week</p>
                                </div>
                            </div>
                        </div>
                        <div class="clone-modal-footer">
                            <button class="time-editor-btn cancel" onclick="closeCloneModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            loadScheduleData();
        }

        async function loadScheduleData() {
            const container = document.getElementById('schedule-container');
            if (!container) return;

            try {
                // Make sure employees are loaded first
                if (employees.length === 0) {
                    console.log(' Loading employees for schedule...');
                    await loadEmployeesFromFirebase();
                    console.log(' Employees loaded:', employees.length);
                    console.log(' Employee details:', employees);
                } else {
                    console.log(' Employees already loaded:', employees.length);
                }

                const db = firebase.firestore();

                // Load schedules
                const schedulesRef = db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules');
                const snapshot = await schedulesRef.get();

                schedules = [];
                snapshot.forEach(doc => {
                    schedules.push({ id: doc.id, ...doc.data() });
                });

                // Load days off
                const daysOffRef = db.collection(window.FIREBASE_COLLECTIONS.daysOff || 'daysOff');
                const daysOffSnapshot = await daysOffRef.get();

                daysOff = [];
                daysOffSnapshot.forEach(doc => {
                    daysOff.push({ id: doc.id, ...doc.data() });
                });

                console.log(' Loaded schedules from Firestore:', schedules.length);
                console.log('锔 Loaded days off from Firestore:', daysOff.length);
                console.log(' Employees available:', employees.length);
                renderScheduleGrid();
            } catch (error) {
                console.error('Error loading schedules:', error);
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                        <h2 style="color: var(--text-secondary); margin-bottom: 10px;">Connection Error</h2>
                        <p style="color: var(--text-muted);">Unable to load schedule data.</p>
                        <button class="btn-primary" style="margin-top: 20px;" onclick="loadScheduleData()"><i class="fas fa-sync"></i> Retry</button>
                    </div>
                `;
            }
        }

        function renderScheduleGrid() {
            const container = document.getElementById('schedule-container');
            if (!container) return;

            const storeFilter = document.getElementById('schedule-store-filter')?.value || 'all';
            const weekDates = getWeekDates(currentWeekStart);
            const today = formatDateKey(new Date());

            // If "All Stores" is selected, show the stores grid view
            if (storeFilter === 'all') {
                renderAllStoresView(container, weekDates, today);
                return;
            }

            // Filter employees by store
            let filteredEmployees = [...employees];
            if (storeFilter !== 'all') {
                filteredEmployees = filteredEmployees.filter(e => e.store === storeFilter);
            }

            if (filteredEmployees.length === 0) {
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <i class="fas fa-users" style="font-size: 48px; color: var(--text-muted); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Employees</h3>
                        <p style="color: var(--text-muted);">No employees found for the selected store.</p>
                    </div>
                `;
                return;
            }

            // Build day cards HTML
            let html = '<div class="schedule-days-container">';

            weekDates.forEach(date => {
                const dateKey = formatDateKey(date);
                const isToday = dateKey === today;
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = date.getDate();

                html += `
                    <div class="schedule-day-card ${isToday ? 'today' : ''}" data-date="${dateKey}">
                        <div class="day-card-header">
                            <div class="day-name">${dayName}</div>
                            <div class="day-number">${dayNumber}</div>
                        </div>
                        <div class="day-card-body">
                `;

                // Render both shift slots (Opening and Closing)
                ['opening', 'closing'].forEach(shiftType => {
                    const shiftConfig = SHIFT_TYPES[shiftType];
                    // Find schedule for this day and shift type
                    const schedule = schedules.find(s =>
                        s.date === dateKey &&
                        s.shiftType === shiftType &&
                        (storeFilter === 'all' || s.store === storeFilter)
                    );

                    const emp = schedule ? employees.find(e => e.id === schedule.employeeId) : null;
                    const startTime = schedule?.startTime || shiftConfig.defaultStart;
                    const endTime = schedule?.endTime || shiftConfig.defaultEnd;
                    const hours = calculateHours(startTime, endTime);

                    html += `
                        <div class="shift-slot ${shiftType}" data-date="${dateKey}" data-shift-type="${shiftType}">
                            <div class="shift-slot-header">
                                <div class="shift-type-badge">
                                    <i class="fas ${shiftConfig.icon}"></i>
                                    ${shiftConfig.name}
                                </div>
                                <div class="shift-time-display" id="time-display-${dateKey}-${shiftType}">
                                    ${formatTimeShort(startTime)} - ${formatTimeShort(endTime)}
                                </div>
                            </div>
                            <div class="employee-drop-zone ${schedule ? '' : 'empty'}"
                                 data-date="${dateKey}"
                                 data-shift-type="${shiftType}"
                                 data-schedule-id="${schedule?.id || ''}"
                                 onclick="openEmployeePicker('${dateKey}', '${shiftType}', '${storeFilter}')"
                                 ondragover="handleShiftDragOver(event)"
                                 ondragleave="handleShiftDragLeave(event)"
                                 ondrop="handleShiftDrop(event, '${dateKey}', '${shiftType}')">
                    `;

                    if (schedule && emp) {
                        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
                        const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                        const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

                        html += `
                            <div class="assigned-employee"
                                 draggable="true"
                                 data-schedule-id="${schedule.id}"
                                 data-employee-id="${emp.id}"
                                 ondragstart="handleEmployeeDragStart(event, '${schedule.id}')"
                                 ondragend="handleEmployeeDragEnd(event)"
                                 onclick="event.stopPropagation(); openTimeEditor('${schedule.id}')">
                                <div class="assigned-employee-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                                <div class="assigned-employee-info">
                                    <div class="assigned-employee-name">${emp.name}</div>
                                    <div class="assigned-employee-hours">${hours}h</div>
                                </div>
                                <button class="assigned-employee-clone" onclick="event.stopPropagation(); cloneShift('${schedule.id}')" title="Clone shift">
                                    <i class="fas fa-clone"></i>
                                </button>
                                <button class="assigned-employee-remove" onclick="event.stopPropagation(); removeSchedule('${schedule.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        html += `<i class="fas fa-plus"></i> Assign`;
                    }

                    html += `</div>`;

                    html += `</div>`;
                });

                // Days off section for this date
                const dayOffEmployees = daysOff.filter(d =>
                    d.date === dateKey &&
                    (storeFilter === 'all' || d.store === storeFilter)
                );

                html += `
                    <div class="day-off-section">
                        <div class="day-off-header" onclick="openDayOffPicker('${dateKey}', '${storeFilter}')">
                            <i class="fas fa-umbrella-beach" style="color: var(--accent-primary);"></i>
                            <span>Days Off</span>
                            <i class="fas fa-plus" style="margin-left: auto; font-size: 12px;"></i>
                        </div>
                        <div class="day-off-employees">
                `;

                if (dayOffEmployees.length > 0) {
                    const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
                    dayOffEmployees.forEach(dayOff => {
                        const emp = employees.find(e => e.id === dayOff.employeeId);
                        if (emp) {
                            const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                            const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
                            html += `
                                <div class="day-off-employee-badge">
                                    <div class="day-off-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                                    <span class="day-off-name">${emp.name}</span>
                                    <button class="day-off-remove" onclick="event.stopPropagation(); removeDayOff('${dayOff.id}')" title="Remove day off">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                        }
                    });
                } else {
                    html += `<div class="day-off-empty">No days off</div>`;
                }

                html += `
                        </div>
                    </div>
                `;

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Time editor modal functions
        let currentTimeEditorContext = null;

        function timeToPercent(time) {
            if (!time) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            let totalMinutes = hours * 60 + minutes;
            // Handle midnight (00:00) as end of day
            if (totalMinutes < 360) totalMinutes += 1440;
            // Range: 6am (360) to 12am (1440) = 1080 minutes
            const minMinutes = 360; // 6am
            const maxMinutes = 1440; // 12am (midnight)
            return Math.max(0, Math.min(100, ((totalMinutes - minMinutes) / (maxMinutes - minMinutes)) * 100));
        }

        function percentToTime(percent) {
            const minMinutes = 360; // 6am
            const maxMinutes = 1440; // 12am
            const totalMinutes = Math.round((percent / 100) * (maxMinutes - minMinutes) + minMinutes);
            // Round to nearest 15 minutes
            const roundedMinutes = Math.round(totalMinutes / 15) * 15;
            const hours = Math.floor(roundedMinutes / 60) % 24;
            const minutes = roundedMinutes % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function openTimeEditor(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;

            const emp = employees.find(e => e.id === schedule.employeeId);
            const shiftConfig = SHIFT_TYPES[schedule.shiftType] || SHIFT_TYPES.opening;
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
            const colorIndex = emp?.name ? emp.name.charCodeAt(0) % colors.length : 0;
            const initials = emp?.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

            currentTimeEditorContext = {
                scheduleId,
                startTime: schedule.startTime,
                endTime: schedule.endTime,
                shiftType: schedule.shiftType
            };

            // Update modal content
            const titleEl = document.getElementById('timeEditorTitle');
            const infoEl = document.getElementById('timeEditorInfo');
            const currentValueEl = document.getElementById('timeEditorCurrentValue');
            const currentHoursEl = document.getElementById('timeEditorCurrentHours');
            const rangeEl = document.getElementById('timeEditorRange');

            if (titleEl) {
                const icon = shiftConfig.icon;
                titleEl.innerHTML = `<i class="fas ${icon}" style="color: ${shiftConfig.color};"></i> Edit ${shiftConfig.name} Shift`;
            }

            if (infoEl) {
                const dateObj = new Date(schedule.date + 'T12:00:00');
                const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                infoEl.innerHTML = `
                    <div class="time-editor-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                    <div class="time-editor-details">
                        <h4>${emp?.name || 'Unknown'}</h4>
                        <p>${dateStr} &bull; ${schedule.store || ''}</p>
                    </div>
                `;
            }

            // Set initial values
            updateTimeEditorDisplay();

            // Set slider position
            if (rangeEl) {
                rangeEl.className = `time-editor-slider-range ${schedule.shiftType}`;
                updateTimeEditorSlider();
            }

            // Setup slider drag handlers
            setupTimeEditorSlider();

            // Show modal
            document.getElementById('timeEditorOverlay').classList.add('active');
        }

        function closeTimeEditor(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('timeEditorOverlay').classList.remove('active');
            currentTimeEditorContext = null;
        }

        function updateTimeEditorDisplay() {
            if (!currentTimeEditorContext) return;

            const { startTime, endTime } = currentTimeEditorContext;
            const currentValueEl = document.getElementById('timeEditorCurrentValue');
            const currentHoursEl = document.getElementById('timeEditorCurrentHours');

            if (currentValueEl) {
                currentValueEl.textContent = `${formatTimeShort(startTime)} - ${formatTimeShort(endTime)}`;
            }

            if (currentHoursEl) {
                const hours = calculateHours(startTime, endTime);
                currentHoursEl.textContent = `${hours} hours`;
            }
        }

        function updateTimeEditorSlider() {
            if (!currentTimeEditorContext) return;

            const { startTime, endTime } = currentTimeEditorContext;
            const rangeEl = document.getElementById('timeEditorRange');

            if (rangeEl) {
                const startPercent = timeToPercent(startTime);
                const endPercent = timeToPercent(endTime);
                rangeEl.style.left = `${startPercent}%`;
                rangeEl.style.right = `${100 - endPercent}%`;
            }
        }

        function setupTimeEditorSlider() {
            const track = document.getElementById('timeEditorTrack');
            const range = document.getElementById('timeEditorRange');
            const handleStart = document.getElementById('timeEditorHandleStart');
            const handleEnd = document.getElementById('timeEditorHandleEnd');

            if (!track || !range) return;

            function startDrag(handleType) {
                return function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const trackRect = track.getBoundingClientRect();

                    function onMouseMove(e) {
                        if (!currentTimeEditorContext) return;

                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const x = Math.max(0, Math.min(clientX - trackRect.left, trackRect.width));
                        const percent = (x / trackRect.width) * 100;

                        let startPercent = timeToPercent(currentTimeEditorContext.startTime);
                        let endPercent = timeToPercent(currentTimeEditorContext.endTime);

                        if (handleType === 'start') {
                            startPercent = Math.min(percent, endPercent - 5);
                            currentTimeEditorContext.startTime = percentToTime(startPercent);
                        } else {
                            endPercent = Math.max(percent, startPercent + 5);
                            currentTimeEditorContext.endTime = percentToTime(endPercent);
                        }

                        updateTimeEditorDisplay();
                        updateTimeEditorSlider();
                    }

                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        document.removeEventListener('touchmove', onMouseMove);
                        document.removeEventListener('touchend', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    document.addEventListener('touchmove', onMouseMove);
                    document.addEventListener('touchend', onMouseUp);
                };
            }

            // Remove old listeners by cloning
            const newHandleStart = handleStart.cloneNode(true);
            const newHandleEnd = handleEnd.cloneNode(true);
            handleStart.parentNode.replaceChild(newHandleStart, handleStart);
            handleEnd.parentNode.replaceChild(newHandleEnd, handleEnd);

            newHandleStart.addEventListener('mousedown', startDrag('start'));
            newHandleStart.addEventListener('touchstart', startDrag('start'));
            newHandleEnd.addEventListener('mousedown', startDrag('end'));
            newHandleEnd.addEventListener('touchstart', startDrag('end'));
        }

        function setTimeEditorPreset(startTime, endTime) {
            if (!currentTimeEditorContext) return;

            currentTimeEditorContext.startTime = startTime;
            currentTimeEditorContext.endTime = endTime;

            updateTimeEditorDisplay();
            updateTimeEditorSlider();

            // Highlight active preset
            document.querySelectorAll('.time-editor-preset').forEach(p => p.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        async function saveTimeEditor() {
            if (!currentTimeEditorContext) return;

            const { scheduleId, startTime, endTime } = currentTimeEditorContext;

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).update({
                    startTime,
                    endTime,
                    updatedAt: new Date().toISOString()
                });

                // Update local data
                const schedule = schedules.find(s => s.id === scheduleId);
                if (schedule) {
                    schedule.startTime = startTime;
                    schedule.endTime = endTime;
                }

                showNotification('Schedule updated!', 'success');
                closeTimeEditor();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error updating schedule:', error);
                showNotification('Error updating schedule', 'error');
            }
        }

        async function deleteFromTimeEditor() {
            if (!currentTimeEditorContext) return;

            if (!confirm('Remove this employee from the shift?')) return;

            const { scheduleId } = currentTimeEditorContext;

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).delete();

                schedules = schedules.filter(s => s.id !== scheduleId);
                showNotification('Shift removed', 'success');
                closeTimeEditor();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error removing schedule:', error);
                showNotification('Error removing shift', 'error');
            }
        }

        // All Stores View
        function renderAllStoresView(container, weekDates, today) {
            const stores = ['Miramar', 'Morena', 'Kearny Mesa', 'Chula Vista', 'North Park', 'Miramar Wine & Liquor'];

            let html = '<div class="stores-grid">';

            stores.forEach(store => {
                html += `
                    <div class="store-schedule-card">
                        <div class="store-schedule-header">
                            <h4>
                                <div class="store-icon"><i class="fas fa-store"></i></div>
                                ${store}
                            </h4>
                        </div>
                        <div class="store-schedule-body">
                `;

                weekDates.forEach(date => {
                    const dateKey = formatDateKey(date);
                    const isToday = dateKey === today;
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayNumber = date.getDate();
                    const ordinalDay = getOrdinal(dayNumber);

                    html += `
                        <div class="store-day-row">
                            <div class="store-day-label ${isToday ? 'today' : ''}">${dayName} (${ordinalDay})</div>
                            <div class="store-shifts">
                    `;

                    ['opening', 'closing'].forEach(shiftType => {
                        const schedule = schedules.find(s =>
                            s.date === dateKey &&
                            s.shiftType === shiftType &&
                            s.store === store
                        );
                        const emp = schedule ? employees.find(e => e.id === schedule.employeeId) : null;

                        if (schedule && emp) {
                            const firstName = emp.name?.split(' ')[0] || 'Unknown';
                            html += `
                                <div class="store-shift-slot ${shiftType} filled"
                                     draggable="true"
                                     data-schedule-id="${schedule.id}"
                                     ondragstart="handleEmployeeDragStart(event, '${schedule.id}')"
                                     ondragend="handleEmployeeDragEnd(event)"
                                     onclick="openTimeEditor('${schedule.id}')">
                                    <div class="store-shift-name">${firstName}</div>
                                    <div class="store-shift-time">${formatTimeShort(schedule.startTime)}-${formatTimeShort(schedule.endTime)}</div>
                                    <button class="store-shift-clone" onclick="event.stopPropagation(); cloneShift('${schedule.id}')" title="Clone shift">
                                        <i class="fas fa-clone"></i>
                                    </button>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="store-shift-slot empty"
                                     data-date="${dateKey}"
                                     data-shift-type="${shiftType}"
                                     data-store="${store}"
                                     ondragover="handleStoreSlotDragOver(event)"
                                     ondragleave="handleStoreSlotDragLeave(event)"
                                     ondrop="handleStoreSlotDrop(event, '${dateKey}', '${shiftType}', '${store}')"
                                     onclick="openEmployeePicker('${dateKey}', '${shiftType}', '${store}')">
                                    <i class="fas fa-plus" style="font-size: 10px;"></i>
                                </div>
                            `;
                        }
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                // Days Off section for All Stores view
                html += `
                    <div class="store-days-off-section">
                        <div class="store-days-off-header clickable" onclick="openStoreDayOffPicker('${store}')">
                            <i class="fas fa-umbrella-beach" style="color: var(--accent-primary); font-size: 14px;"></i>
                            <span style="font-weight: 600; font-size: 13px;">Days Off This Week</span>
                            <i class="fas fa-plus" style="margin-left: auto; font-size: 12px; color: var(--accent-primary);"></i>
                        </div>
                        <div class="store-days-off-list">
                `;

                // Get all days off for this store in the current week
                const storeDaysOff = daysOff.filter(d => {
                    const dateInWeek = weekDates.some(date => formatDateKey(date) === d.date);
                    return d.store === store && dateInWeek;
                });

                if (storeDaysOff.length > 0) {
                    const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
                    storeDaysOff.forEach(dayOff => {
                        const emp = employees.find(e => e.id === dayOff.employeeId);
                        if (emp) {
                            const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                            const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
                            const dateObj = new Date(dayOff.date + 'T12:00:00');
                            const dayLabel = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                            html += `
                                <div class="store-day-off-item">
                                    <div class="store-day-off-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                                    <div class="store-day-off-info">
                                        <div class="store-day-off-name">${emp.name}</div>
                                        <div class="store-day-off-date">${dayLabel}</div>
                                    </div>
                                    <button class="store-day-off-remove" onclick="event.stopPropagation(); removeDayOff('${dayOff.id}')" title="Remove day off">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                        }
                    });
                } else {
                    html += `<div class="store-days-off-empty">No days off this week</div>`;
                }

                html += `
                        </div>
                    </div>
                `;

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Drag handlers for All Stores view
        function handleStoreSlotDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleStoreSlotDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleStoreSlotDrop(event, dateKey, shiftType, store) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (!draggedShift) return;

            const schedule = schedules.find(s => s.id === draggedShift);
            if (!schedule) return;

            const shiftConfig = SHIFT_TYPES[shiftType];

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(draggedShift).update({
                    date: dateKey,
                    shiftType,
                    store,
                    startTime: shiftConfig.defaultStart,
                    endTime: shiftConfig.defaultEnd,
                    updatedAt: new Date().toISOString()
                });

                schedule.date = dateKey;
                schedule.shiftType = shiftType;
                schedule.store = store;
                schedule.startTime = shiftConfig.defaultStart;
                schedule.endTime = shiftConfig.defaultEnd;

                showNotification('Shift moved!', 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error moving shift:', error);
                showNotification('Error moving shift', 'error');
            }
        }

        // Clone individual shift
        async function cloneShift(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;

            const weekDates = getWeekDates(currentWeekStart);
            const weekKeys = weekDates.map(d => formatDateKey(d));
            const currentDayIndex = weekKeys.indexOf(schedule.date);

            // Find next available day for same shift type in same store
            let targetDate = null;
            for (let i = currentDayIndex + 1; i < 7; i++) {
                const exists = schedules.find(s =>
                    s.date === weekKeys[i] &&
                    s.shiftType === schedule.shiftType &&
                    s.store === schedule.store
                );
                if (!exists) {
                    targetDate = weekKeys[i];
                    break;
                }
            }

            if (!targetDate) {
                // Try from beginning of week
                for (let i = 0; i < currentDayIndex; i++) {
                    const exists = schedules.find(s =>
                        s.date === weekKeys[i] &&
                        s.shiftType === schedule.shiftType &&
                        s.store === schedule.store
                    );
                    if (!exists) {
                        targetDate = weekKeys[i];
                        break;
                    }
                }
            }

            if (!targetDate) {
                showNotification('No empty slots available this week', 'warning');
                return;
            }

            const currentUser = getCurrentUser();

            try {
                const db = firebase.firestore();
                const newSchedule = {
                    employeeId: schedule.employeeId,
                    employeeName: schedule.employeeName,
                    store: schedule.store,
                    date: targetDate,
                    shiftType: schedule.shiftType,
                    startTime: schedule.startTime,
                    endTime: schedule.endTime,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.name || 'Unknown',
                    clonedFrom: scheduleId
                };

                const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(newSchedule);
                schedules.push({ id: docRef.id, ...newSchedule });

                const targetDay = new Date(targetDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short' });
                showNotification(`Shift cloned to ${targetDay}!`, 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error cloning shift:', error);
                showNotification('Error cloning shift', 'error');
            }
        }

        // Clone modal functions
        function openCloneModal() {
            document.getElementById('cloneModalOverlay').classList.add('active');
        }

        function closeCloneModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('cloneModalOverlay').classList.remove('active');
        }

        async function cloneFromPreviousWeek() {
            const previousWeekStart = new Date(currentWeekStart);
            previousWeekStart.setDate(previousWeekStart.getDate() - 7);
            const previousWeekDates = getWeekDates(previousWeekStart);
            const currentWeekDates = getWeekDates(currentWeekStart);

            // Get schedules from previous week
            const previousWeekKeys = previousWeekDates.map(d => formatDateKey(d));
            const previousSchedules = schedules.filter(s => previousWeekKeys.includes(s.date));

            if (previousSchedules.length === 0) {
                showNotification('No schedules found in previous week', 'warning');
                closeCloneModal();
                return;
            }

            const storeFilter = document.getElementById('schedule-store-filter')?.value || 'all';

            try {
                const db = firebase.firestore();
                const currentUser = getCurrentUser();
                let clonedCount = 0;

                for (const prevSchedule of previousSchedules) {
                    // Skip if filtering by store and doesn't match
                    if (storeFilter !== 'all' && prevSchedule.store !== storeFilter) continue;

                    // Calculate new date (same day of week, current week)
                    const prevDateIndex = previousWeekKeys.indexOf(prevSchedule.date);
                    const newDate = formatDateKey(currentWeekDates[prevDateIndex]);

                    // Check if schedule already exists for this slot
                    const exists = schedules.find(s =>
                        s.date === newDate &&
                        s.shiftType === prevSchedule.shiftType &&
                        s.store === prevSchedule.store
                    );

                    if (!exists) {
                        const newSchedule = {
                            employeeId: prevSchedule.employeeId,
                            employeeName: prevSchedule.employeeName,
                            store: prevSchedule.store,
                            date: newDate,
                            shiftType: prevSchedule.shiftType,
                            startTime: prevSchedule.startTime,
                            endTime: prevSchedule.endTime,
                            createdAt: new Date().toISOString(),
                            createdBy: currentUser?.name || 'Unknown',
                            clonedFrom: prevSchedule.id
                        };

                        const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(newSchedule);
                        schedules.push({ id: docRef.id, ...newSchedule });
                        clonedCount++;
                    }
                }

                showNotification(`Cloned ${clonedCount} shifts from previous week!`, 'success');
                closeCloneModal();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error cloning schedules:', error);
                showNotification('Error cloning schedules', 'error');
            }
        }

        async function cloneToNextWeek() {
            const nextWeekStart = new Date(currentWeekStart);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7);
            const nextWeekDates = getWeekDates(nextWeekStart);
            const currentWeekDates = getWeekDates(currentWeekStart);

            // Get schedules from current week
            const currentWeekKeys = currentWeekDates.map(d => formatDateKey(d));
            const currentSchedules = schedules.filter(s => currentWeekKeys.includes(s.date));

            if (currentSchedules.length === 0) {
                showNotification('No schedules in current week to clone', 'warning');
                closeCloneModal();
                return;
            }

            const storeFilter = document.getElementById('schedule-store-filter')?.value || 'all';

            try {
                const db = firebase.firestore();
                const currentUser = getCurrentUser();
                let clonedCount = 0;

                for (const currSchedule of currentSchedules) {
                    if (storeFilter !== 'all' && currSchedule.store !== storeFilter) continue;

                    const currDateIndex = currentWeekKeys.indexOf(currSchedule.date);
                    const newDate = formatDateKey(nextWeekDates[currDateIndex]);

                    const exists = schedules.find(s =>
                        s.date === newDate &&
                        s.shiftType === currSchedule.shiftType &&
                        s.store === currSchedule.store
                    );

                    if (!exists) {
                        const newSchedule = {
                            employeeId: currSchedule.employeeId,
                            employeeName: currSchedule.employeeName,
                            store: currSchedule.store,
                            date: newDate,
                            shiftType: currSchedule.shiftType,
                            startTime: currSchedule.startTime,
                            endTime: currSchedule.endTime,
                            createdAt: new Date().toISOString(),
                            createdBy: currentUser?.name || 'Unknown',
                            clonedFrom: currSchedule.id
                        };

                        const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(newSchedule);
                        schedules.push({ id: docRef.id, ...newSchedule });
                        clonedCount++;
                    }
                }

                showNotification(`Cloned ${clonedCount} shifts to next week!`, 'success');
                closeCloneModal();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error cloning schedules:', error);
                showNotification('Error cloning schedules', 'error');
            }
        }

        async function clearCurrentWeek() {
            if (!confirm('Are you sure you want to remove all shifts from the current week?')) return;

            const currentWeekDates = getWeekDates(currentWeekStart);
            const currentWeekKeys = currentWeekDates.map(d => formatDateKey(d));
            const storeFilter = document.getElementById('schedule-store-filter')?.value || 'all';

            const schedulesToDelete = schedules.filter(s =>
                currentWeekKeys.includes(s.date) &&
                (storeFilter === 'all' || s.store === storeFilter)
            );

            if (schedulesToDelete.length === 0) {
                showNotification('No schedules to clear', 'info');
                closeCloneModal();
                return;
            }

            try {
                const db = firebase.firestore();
                const batch = db.batch();

                schedulesToDelete.forEach(s => {
                    const docRef = db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(s.id);
                    batch.delete(docRef);
                });

                await batch.commit();

                schedules = schedules.filter(s => !schedulesToDelete.find(d => d.id === s.id));
                showNotification(`Cleared ${schedulesToDelete.length} shifts`, 'success');
                closeCloneModal();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error clearing schedules:', error);
                showNotification('Error clearing schedules', 'error');
            }
        }

        // Employee picker functions
        let currentPickerContext = null;

        function openEmployeePicker(dateKey, shiftType, storeFilter) {
            currentPickerContext = { dateKey, shiftType, storeFilter };

            const overlay = document.getElementById('employeePickerOverlay');
            const list = document.getElementById('employeePickerList');
            const search = document.getElementById('employeePickerSearch');

            if (search) search.value = '';
            renderEmployeePickerList();

            overlay.classList.add('active');
        }

        function closeEmployeePicker(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.getElementById('employeePickerOverlay');
            const title = overlay.querySelector('h3');

            // Reset title to default
            if (title) title.textContent = 'Select Employee';

            overlay.classList.remove('active');
            currentPickerContext = null;
            currentDayOffContext = null;
        }

        function filterEmployeePicker() {
            if (currentDayOffContext) {
                renderDayOffPickerList();
            } else {
                renderEmployeePickerList();
            }
        }

        function renderEmployeePickerList() {
            const list = document.getElementById('employeePickerList');
            const search = document.getElementById('employeePickerSearch')?.value?.toLowerCase() || '';

            if (!currentPickerContext) return;

            console.log(' Employee Picker Debug:');
            console.log('Total employees loaded:', employees.length);
            console.log('Current store filter:', currentPickerContext.storeFilter);
            console.log('Selected date:', currentPickerContext.dateKey);
            console.log('All employees:', employees);

            let filteredEmployees = [...employees];

            // REMOVED: Filter by store - Show ALL employees from Firebase regardless of store
            // This allows assigning any employee to any shift at any store
            // if (currentPickerContext.storeFilter !== 'all') {
            //     filteredEmployees = filteredEmployees.filter(e => e.store === currentPickerContext.storeFilter);
            //     console.log(`After store filter (${currentPickerContext.storeFilter}):`, filteredEmployees.length, 'employees');
            // }

            // Filter by search only
            if (search) {
                filteredEmployees = filteredEmployees.filter(e =>
                    e.name?.toLowerCase().includes(search)
                );
                console.log(`After search filter (${search}):`, filteredEmployees.length, 'employees');
            }

            // Filter out inactive employees
            filteredEmployees = filteredEmployees.filter(e => e.status === 'active');

            // Filter out employees who have a day off on this date
            if (currentPickerContext.dateKey) {
                console.log('锔 Checking days off for date:', currentPickerContext.dateKey);
                console.log('锔 All days off in memory:', daysOff);

                const daysOffOnThisDate = daysOff.filter(d => d.date === currentPickerContext.dateKey);
                console.log('锔 Days off matching this date:', daysOffOnThisDate);

                const employeesWithDayOff = daysOffOnThisDate.map(d => d.employeeId);
                console.log('锔 Employee IDs with day off:', employeesWithDayOff);

                const beforeFilter = filteredEmployees.length;
                filteredEmployees = filteredEmployees.filter(e => !employeesWithDayOff.includes(e.id));
                console.log(`锔 Filtered out ${beforeFilter - filteredEmployees.length} employees with days off`);
            }

            console.log('Final filtered employees:', filteredEmployees);

            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];

            list.innerHTML = filteredEmployees.map(emp => {
                const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

                return `
                    <div class="employee-picker-item" onclick="assignEmployee('${emp.id}')">
                        <div class="employee-picker-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                        <div class="employee-picker-info">
                            <div class="employee-picker-name">${emp.name}</div>
                            <div class="employee-picker-store">${emp.store || ''}</div>
                        </div>
                    </div>
                `;
            }).join('') || '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No employees found</div>';
        }

        async function assignEmployee(employeeId) {
            if (!currentPickerContext) return;

            const { dateKey, shiftType, storeFilter } = currentPickerContext;
            const emp = employees.find(e => e.id === employeeId);
            const shiftConfig = SHIFT_TYPES[shiftType];
            const store = storeFilter !== 'all' ? storeFilter : emp?.store || '';

            // Check if employee has a day off on this date
            const hasDayOff = daysOff.some(d =>
                d.date === dateKey &&
                d.employeeId === employeeId
            );

            if (hasDayOff) {
                showNotification('This employee has a day off on this date', 'warning');
                return;
            }

            // Check if there's already a schedule for this slot
            const existingSchedule = schedules.find(s =>
                s.date === dateKey &&
                s.shiftType === shiftType &&
                s.store === store
            );

            const currentUser = getCurrentUser();

            try {
                const db = firebase.firestore();
                let assignedCount = 1;

                if (existingSchedule) {
                    // Update existing
                    await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(existingSchedule.id).update({
                        employeeId,
                        employeeName: emp?.name || '',
                        updatedAt: new Date().toISOString()
                    });
                    existingSchedule.employeeId = employeeId;
                    existingSchedule.employeeName = emp?.name || '';
                } else {
                    // Create new
                    const scheduleData = {
                        employeeId,
                        employeeName: emp?.name || '',
                        store,
                        date: dateKey,
                        shiftType,
                        startTime: shiftConfig.defaultStart,
                        endTime: shiftConfig.defaultEnd,
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.name || 'Unknown'
                    };
                    const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(scheduleData);
                    schedules.push({ id: docRef.id, ...scheduleData });

                    // Auto-assign to closing if opening shift ends at or after 2pm (14:00)
                    if (shiftType === 'opening' && shiftConfig.defaultEnd >= '14:00') {
                        const closingExists = schedules.find(s =>
                            s.date === dateKey &&
                            s.shiftType === 'closing' &&
                            s.store === store
                        );

                        if (!closingExists) {
                            const closingConfig = SHIFT_TYPES.closing;
                            const closingData = {
                                employeeId,
                                employeeName: emp?.name || '',
                                store,
                                date: dateKey,
                                shiftType: 'closing',
                                startTime: closingConfig.defaultStart,
                                endTime: closingConfig.defaultEnd,
                                createdAt: new Date().toISOString(),
                                createdBy: currentUser?.name || 'Unknown',
                                autoAssigned: true
                            };
                            const closingRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(closingData);
                            schedules.push({ id: closingRef.id, ...closingData });
                            assignedCount = 2;
                        }
                    }
                }

                showNotification(assignedCount > 1 ? 'Employee assigned to both shifts!' : 'Employee assigned!', 'success');
                closeEmployeePicker();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error assigning employee:', error);
                showNotification('Error assigning employee', 'error');
            }
        }

        async function removeSchedule(scheduleId) {
            if (!confirm('Remove this employee from the shift?')) return;

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).delete();

                schedules = schedules.filter(s => s.id !== scheduleId);
                showNotification('Shift removed', 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error removing schedule:', error);
                showNotification('Error removing shift', 'error');
            }
        }

        // Days Off Management
        let currentDayOffContext = null;

        function openDayOffPicker(dateKey, storeFilter) {
            currentDayOffContext = { dateKey, storeFilter };

            const overlay = document.getElementById('employeePickerOverlay');
            const list = document.getElementById('employeePickerList');
            const search = document.getElementById('employeePickerSearch');
            const title = overlay.querySelector('h3');

            if (title) title.textContent = 'Select Employee for Day Off';
            if (search) search.value = '';
            renderDayOffPickerList();

            overlay.classList.add('active');
        }

        function renderDayOffPickerList() {
            const list = document.getElementById('employeePickerList');
            const search = document.getElementById('employeePickerSearch')?.value?.toLowerCase() || '';

            if (!currentDayOffContext) return;

            let filteredEmployees = [...employees];

            // Filter by search
            if (search) {
                filteredEmployees = filteredEmployees.filter(e =>
                    e.name?.toLowerCase().includes(search)
                );
            }

            // Filter out inactive employees
            filteredEmployees = filteredEmployees.filter(e => e.status === 'active');

            // Filter out employees who already have a day off on this date
            const existingDayOffs = daysOff.filter(d => d.date === currentDayOffContext.dateKey);
            filteredEmployees = filteredEmployees.filter(e =>
                !existingDayOffs.some(d => d.employeeId === e.id)
            );

            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];

            list.innerHTML = filteredEmployees.map(emp => {
                const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

                return `
                    <div class="employee-picker-item" onclick="assignDayOff('${emp.id}')">
                        <div class="employee-picker-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                        <div class="employee-picker-info">
                            <div class="employee-picker-name">${emp.name}</div>
                            <div class="employee-picker-store">${emp.store || ''}</div>
                        </div>
                    </div>
                `;
            }).join('') || '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No employees available</div>';
        }

        async function assignDayOff(employeeId) {
            if (!currentDayOffContext) return;

            const { dateKey, storeFilter } = currentDayOffContext;
            const emp = employees.find(e => e.id === employeeId);
            const store = storeFilter !== 'all' ? storeFilter : emp?.store || '';

            // Check if employee already has a day off
            const existingDayOff = daysOff.find(d =>
                d.date === dateKey &&
                d.employeeId === employeeId
            );

            if (existingDayOff) {
                showNotification('Employee already has a day off on this date', 'warning');
                return;
            }

            const currentUser = getCurrentUser();

            try {
                const db = firebase.firestore();
                const dayOffData = {
                    employeeId,
                    employeeName: emp?.name || '',
                    store,
                    date: dateKey,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.name || 'Unknown'
                };

                const docRef = await db.collection(window.FIREBASE_COLLECTIONS.daysOff || 'daysOff').add(dayOffData);
                daysOff.push({ id: docRef.id, ...dayOffData });

                showNotification('Day off assigned!', 'success');
                closeEmployeePicker();
                currentDayOffContext = null;
                renderScheduleGrid();
            } catch (error) {
                console.error('Error assigning day off:', error);
                showNotification('Error assigning day off', 'error');
            }
        }

        async function removeDayOff(dayOffId) {
            if (!confirm('Remove this day off?')) return;

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.daysOff || 'daysOff').doc(dayOffId).delete();

                daysOff = daysOff.filter(d => d.id !== dayOffId);
                showNotification('Day off removed', 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error removing day off:', error);
                showNotification('Error removing day off', 'error');
            }
        }

        // Open day off picker for All Stores view - shows date selector modal
        function openStoreDayOffPicker(store) {
            // Create a modal to select the date for the day off
            const weekDates = getWeekDates(currentWeekStart);
            const today = formatDateKey(new Date());

            let modalHTML = `
                <div class="date-picker-modal-overlay" id="datePickerOverlay" onclick="closeDatePicker(event)">
                    <div class="date-picker-modal">
                        <div class="date-picker-header">
                            <h3><i class="fas fa-calendar-day" style="color: var(--accent-primary);"></i> Select Day Off Date</h3>
                            <button onclick="closeDatePicker()" class="close-modal-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="date-picker-body">
                            <p style="margin-bottom: 16px; color: var(--text-secondary);">Select a date for the day off at <strong>${store}</strong></p>
                            <div class="date-picker-grid">
            `;

            weekDates.forEach(date => {
                const dateKey = formatDateKey(date);
                const isToday = dateKey === today;
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const monthDay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                modalHTML += `
                    <div class="date-picker-option ${isToday ? 'today' : ''}" onclick="selectDayOffDate('${dateKey}', '${store}')">
                        <div class="date-picker-day">${dayName}</div>
                        <div class="date-picker-date">${monthDay}</div>
                        ${isToday ? '<div class="date-picker-today-badge">Today</div>' : ''}
                    </div>
                `;
            });

            modalHTML += `
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Insert modal into document
            const existingModal = document.getElementById('datePickerOverlay');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            setTimeout(() => {
                document.getElementById('datePickerOverlay').classList.add('active');
            }, 10);
        }

        function closeDatePicker(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.getElementById('datePickerOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function selectDayOffDate(dateKey, store) {
            closeDatePicker();
            // Now open the employee picker for this specific date and store
            openDayOffPicker(dateKey, store);
        }

        // Drag and drop for employees between shifts
        function handleEmployeeDragStart(event, scheduleId) {
            draggedShift = scheduleId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleEmployeeDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.employee-drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            draggedShift = null;
        }

        function handleShiftDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleShiftDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleShiftDrop(event, dateKey, shiftType) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (!draggedShift) return;

            const schedule = schedules.find(s => s.id === draggedShift);
            if (!schedule) return;

            const shiftConfig = SHIFT_TYPES[shiftType];

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(draggedShift).update({
                    date: dateKey,
                    shiftType,
                    startTime: shiftConfig.defaultStart,
                    endTime: shiftConfig.defaultEnd,
                    updatedAt: new Date().toISOString()
                });

                schedule.date = dateKey;
                schedule.shiftType = shiftType;
                schedule.startTime = shiftConfig.defaultStart;
                schedule.endTime = shiftConfig.defaultEnd;

                showNotification('Shift moved!', 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error moving shift:', error);
                showNotification('Error moving shift', 'error');
            }
        }

        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            renderSchedule();
        }

        function goToToday() {
            currentWeekStart = getWeekStart(new Date());
            renderSchedule();
        }

        function formatTimeShort(time) {
            if (!time) return '--';
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'p' : 'a';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes}${ampm}`;
        }

        function calculateHours(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;
            const diff = endMinutes - startMinutes;
            return (diff / 60).toFixed(1);
        }

        function formatTime(time) {
            if (!time) return '--';
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }

        // Legacy function kept for modal compatibility
        async function saveSchedule(isQuick = false) {
            const employeeId = document.getElementById('schedule-employee')?.value;
            const store = document.getElementById('schedule-store')?.value;
            const date = document.getElementById('schedule-date')?.value;
            const startTime = document.getElementById('schedule-start')?.value;
            const endTime = document.getElementById('schedule-end')?.value;

            console.log('Saving schedule:', { employeeId, store, date, startTime, endTime });

            if (!employeeId || !store || !date || !startTime || !endTime) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const emp = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);

            const currentUser = getCurrentUser();
            const scheduleData = {
                employeeId,
                employeeName: emp ? emp.name : '',
                store,
                date,
                startTime,
                endTime,
                shiftType: startTime < '14:00' ? 'opening' : 'closing',
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.name || 'Unknown'
            };

            console.log('Schedule data to save:', scheduleData);

            try {
                const db = firebase.firestore();
                const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(scheduleData);
                console.log('Schedule saved with ID:', docRef.id);

                showNotification('Shift added!', 'success');
                closeModal();
                loadScheduleData();
            } catch (error) {
                console.error('Error saving schedule:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function updateSchedule(scheduleId) {
            const employeeId = document.getElementById('schedule-employee').value;
            const store = document.getElementById('schedule-store').value;
            const date = document.getElementById('schedule-date').value;
            const startTime = document.getElementById('schedule-start').value;
            const endTime = document.getElementById('schedule-end').value;

            if (!employeeId || !store || !date || !startTime || !endTime) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const emp = employees.find(e => e.id === employeeId);

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).update({
                    employeeId,
                    employeeName: emp ? emp.name : '',
                    store,
                    date,
                    startTime,
                    endTime,
                    updatedAt: new Date().toISOString()
                });

                showNotification('Shift updated!', 'success');
                closeModal();
                loadScheduleData();
            } catch (error) {
                console.error('Error updating schedule:', error);
                showNotification('Error updating schedule', 'error');
            }
        }

        async function deleteSchedule(scheduleId) {
            showConfirmModal({
                title: 'Delete Shift',
                message: 'Are you sure you want to delete this shift?',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        const db = firebase.firestore();
                        await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).delete();

                        showNotification('Shift deleted!', 'success');
                        loadScheduleData();
                    } catch (error) {
                        console.error('Error deleting schedule:', error);
                        showNotification('Error deleting schedule', 'error');
                    }
                }
            });
        }

        // Thieves database
        let thieves = [
            {
                id: 1,
                name: 'John Doe',
                photo: null,
                date: '2025-11-15',
                store: 'Miramar',
                crimeType: 'Shoplifting',
                itemsStolen: 'Vape devices (2x)',
                estimatedValue: 89.98,
                description: 'Subject entered store around 3:45 PM, concealed two vape devices in jacket pocket. Left without paying.',
                policeReport: 'PR-2025-11-15-001',
                banned: true
            },
            {
                id: 2,
                name: 'Jane Smith',
                photo: null,
                date: '2025-10-28',
                store: 'Morena',
                crimeType: 'Attempted Theft',
                itemsStolen: 'E-liquid bottles (3x)',
                estimatedValue: 65.00,
                description: 'Individual attempted to leave with items in bag. Stopped by staff, returned items and left premises.',
                policeReport: null,
                banned: true
            }
        ];

        /**
         * Initialize Firebase and load thieves from Firestore
         */
        async function initializeFirebaseThieves() {
            console.log('Initializing Firebase for thieves database...');

            const initialized = await firebaseThievesManager.initialize();

            if (initialized) {
                try {
                    const firestoreThieves = await firebaseThievesManager.loadThieves();

                    if (firestoreThieves && firestoreThieves.length > 0) {
                        console.log('Loaded thieves from Firestore:', firestoreThieves);
                        thieves = firestoreThieves;
                        console.log(`Successfully loaded ${thieves.length} thief records from Firestore`);
                        return true;
                    } else {
                        console.log('No thieves found in Firestore, using fallback data');
                    }
                } catch (error) {
                    console.error('Error loading thieves from Firestore:', error);
                }
            } else {
                console.warn('Firebase not available for thieves. Using fallback data.');
            }

            return false;
        }

        /**
         * Save thief record to Firebase
         */
        async function saveThiefToFirebase(thiefData) {
            if (!firebaseThievesManager.isInitialized) {
                console.warn('Firebase Thieves Manager not initialized');
                return null;
            }

            try {
                if (thiefData.firestoreId) {
                    // Update existing
                    const success = await firebaseThievesManager.updateThief(
                        thiefData.firestoreId,
                        thiefData
                    );
                    return success ? thiefData.firestoreId : null;
                } else {
                    // Create new
                    const newId = await firebaseThievesManager.addThief(thiefData);
                    return newId;
                }
            } catch (error) {
                console.error('Error saving thief to Firebase:', error);
                return null;
            }
        }

        /**
         * Delete thief record from Firebase
         */
        async function deleteThiefFromFirebase(firestoreId) {
            if (!firebaseThievesManager.isInitialized) {
                console.warn('Firebase Thieves Manager not initialized');
                return false;
            }

            try {
                return await firebaseThievesManager.deleteThief(firestoreId);
            } catch (error) {
                console.error('Error deleting thief from Firebase:', error);
                return false;
            }
        }

        function renderThieves() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Thieves Database</h2>
                        <p class="section-subtitle">Track and manage theft incidents</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-thief')">
                        <i class="fas fa-plus"></i>
                        Add New Record
                    </button>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                    <select class="form-input" style="width: 180px;" id="thieves-filter" onchange="filterThieves(this.value)">
                        <option value="all">All Stores</option>
                        <option value="Miramar">Miramar</option>
                        <option value="Morena">Morena</option>
                        <option value="Kearny Mesa">Kearny Mesa</option>
                        <option value="Chula Vista">Chula Vista</option>
                        <option value="North Park">North Park</option>
                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                    </select>
                </div>

                <div id="thievesCardsContainer">
                    ${renderThievesCards()}
                </div>
            `;
        }

        function renderThievesCards(filter = 'all') {
            const filteredThieves = filter === 'all' ? thieves : thieves.filter(t => t.store === filter);

            if (filteredThieves.length === 0) {
                return `
                    <div class="card" style="padding: 60px; text-align: center;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; color: var(--text-muted);"></i>
                        <p style="color: var(--text-muted);">No records found</p>
                    </div>
                `;
            }

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    ${filteredThieves.map(thief => `
                        <div class="card" style="overflow: hidden;">
                            <div style="width: 100%; height: 200px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                ${thief.photo ? `<img src="${thief.photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="${thief.name}">` : `<i class="fas fa-user" style="font-size: 64px; color: var(--text-muted);"></i>`}
                            </div>
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${thief.name}</h3>
                                        <span style="font-size: 12px; color: var(--text-muted);">${formatDate(thief.date)}</span>
                                    </div>
                                    ${thief.banned
                                        ? '<span class="badge" style="background: var(--error); color: var(--text-primary);">Banned</span>'
                                        : '<span class="badge" style="background: var(--warning); color: var(--text-primary);">Warning</span>'}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="color: var(--text-muted); font-size: 13px;">Store</span>
                                        <span style="font-weight: 600; font-size: 13px;">${thief.store}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="color: var(--text-muted); font-size: 13px;">Crime Type</span>
                                        <span style="font-weight: 600; font-size: 13px;">${thief.crimeType}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="color: var(--text-muted); font-size: 13px;">Items Stolen</span>
                                        <span style="font-weight: 600; font-size: 13px;">${thief.itemsStolen}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                        <span style="color: var(--text-muted); font-size: 13px;">Estimated Value</span>
                                        <span style="font-weight: 600; font-size: 13px; color: var(--error);">$${thief.estimatedValue.toFixed(2)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    <button class="btn-secondary" onclick="viewThief('${thief.firestoreId || thief.id}')" style="padding: 8px 16px; font-size: 13px;">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn-icon" onclick="editThief('${thief.firestoreId || thief.id}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon danger" onclick="deleteThief('${thief.firestoreId || thief.id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function filterThieves(store) {
            const container = document.getElementById('thievesCardsContainer');
            if (container) {
                container.innerHTML = renderThievesCards(store);
            }
        }

        function viewThief(id) {
            const thief = thieves.find(t => t.id === id || t.firestoreId === id);
            if (!thief) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Theft Record Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 120px 1fr; gap: 24px; margin-bottom: 24px;">
                        <div style="width: 120px; height: 120px; border-radius: 12px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            ${thief.photo ? `<img src="${thief.photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="${thief.name}">` : `<i class="fas fa-user" style="font-size: 48px; color: var(--text-muted);"></i>`}
                        </div>
                        <div>
                            <h3 style="margin: 0 0 8px;">${thief.name}</h3>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <span class="badge" style="background: var(--accent-primary);">${thief.store}</span>
                                ${thief.banned ? '<span class="badge" style="background: var(--error);">Banned</span>' : '<span class="badge" style="background: var(--warning);">Warning</span>'}
                            </div>
                            <p style="color: var(--text-muted); margin: 0;"><i class="fas fa-calendar"></i> ${formatDate(thief.date)}</p>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted);">Crime Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Crime Type</label>
                                    <div>${thief.crimeType}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Estimated Value</label>
                                    <div style="color: var(--error); font-weight: 600;">$${thief.estimatedValue.toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Items Stolen</label>
                                <div>${thief.itemsStolen}</div>
                            </div>
                            ${thief.policeReport ? `
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Police Report #</label>
                                    <div>${thief.policeReport}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted);">Description</h4>
                            <p style="margin: 0; line-height: 1.6;">${thief.description}</p>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        async function deleteThief(id) {
            showConfirmModal({
                title: 'Delete Record',
                message: 'Are you sure you want to delete this thief record? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    // Find the thief to get the firestoreId
                    const thief = thieves.find(t => t.id === id || t.firestoreId === id);

                    if (thief && thief.firestoreId) {
                        // Delete from Firebase
                        const deleted = await deleteThiefFromFirebase(thief.firestoreId);
                        if (deleted) {
                            console.log('Thief record deleted from Firebase:', thief.firestoreId);
                        } else {
                            console.warn('Failed to delete from Firebase, removing locally');
                        }
                    }

                    // Remove from local array
                    thieves = thieves.filter(t => t.id !== id && t.firestoreId !== id);
                    renderThieves();
                }
            });
        }

        function previewThiefPhoto(input) {
            const preview = document.getElementById('thief-photo-preview');
            const img = document.getElementById('thief-photo-img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        function previewEditThiefPhoto(input) {
            const preview = document.getElementById('edit-thief-photo-preview');
            const img = document.getElementById('edit-thief-photo-img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // Variable to store the thief being edited
        let editingThiefId = null;

        function editThief(id) {
            // Find thief by id or firestoreId
            const thief = thieves.find(t => t.id === id || t.firestoreId === id);
            if (!thief) {
                alert('Thief record not found');
                return;
            }

            // Store the thief being edited
            editingThiefId = thief.firestoreId || thief.id;

            // Open modal with edit form
            openModal('edit-thief', thief);
        }

        async function saveEditedThief() {
            if (!editingThiefId) {
                alert('No thief record selected for editing');
                return;
            }

            // Get the current thief data
            const currentThief = thieves.find(t => t.id === editingThiefId || t.firestoreId === editingThiefId);
            if (!currentThief) {
                alert('Thief record not found');
                return;
            }

            // Get form values (use current values as fallback if empty)
            const name = document.getElementById('edit-thief-name').value.trim() || currentThief.name;
            const date = document.getElementById('edit-thief-date').value || currentThief.date;
            const store = document.getElementById('edit-thief-store').value || currentThief.store;
            const crimeType = document.getElementById('edit-thief-crime-type').value || currentThief.crimeType;
            const items = document.getElementById('edit-thief-items').value.trim() || currentThief.itemsStolen;
            const value = document.getElementById('edit-thief-value').value;
            const description = document.getElementById('edit-thief-description').value.trim() || currentThief.description;
            const policeReport = document.getElementById('edit-thief-police-report').value.trim();
            const status = document.getElementById('edit-thief-status').value;
            const photoInput = document.getElementById('edit-thief-photo');

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Get photo - use new one if uploaded, otherwise keep current
                let photoUrl = currentThief.photo;
                let photoPath = currentThief.photoPath || null;
                const photoImg = document.getElementById('edit-thief-photo-img');

                // Check if a new photo was uploaded (it will be base64)
                if (photoInput.files && photoInput.files.length > 0 && photoImg && photoImg.src && photoImg.src.startsWith('data:')) {
                    if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading photo...';

                    // Initialize storage if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    // Delete old photo from storage if it exists
                    if (currentThief.photoPath) {
                        try {
                            await firebaseStorageHelper.deleteFile(currentThief.photoPath);
                        } catch (e) {
                            console.warn('Could not delete old photo:', e);
                        }
                    }

                    // Upload new photo
                    const tempId = currentThief.firestoreId || Date.now().toString();
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        photoImg.src,
                        'thieves/photos',
                        tempId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                }

                const updatedData = {
                    name: name,
                    photo: photoUrl,
                    photoPath: photoPath,
                    date: date,
                    store: store,
                    crimeType: crimeType,
                    itemsStolen: items,
                    estimatedValue: value ? parseFloat(value) : currentThief.estimatedValue,
                    description: description,
                    policeReport: policeReport || currentThief.policeReport || null,
                    banned: status === 'banned'
                };

                if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                // Update in Firebase
                if (firebaseThievesManager.isInitialized && currentThief.firestoreId) {
                    const success = await firebaseThievesManager.updateThief(currentThief.firestoreId, updatedData);
                    if (!success) {
                        throw new Error('Failed to update in Firebase');
                    }
                    console.log('Thief record updated in Firebase:', currentThief.firestoreId);
                }

                // Update local array
                const index = thieves.findIndex(t => t.id === editingThiefId || t.firestoreId === editingThiefId);
                if (index !== -1) {
                    thieves[index] = {
                        ...thieves[index],
                        ...updatedData
                    };
                }

                // Clear editing state
                editingThiefId = null;

                closeModal();
                renderThieves();

                // Show success notification if available
                if (typeof showNotification === 'function') {
                    showNotification('Thief record updated successfully!', 'success');
                }
            } catch (error) {
                console.error('Error updating thief record:', error);
                alert('Error updating thief record. Please try again.');

                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        async function saveThief() {
            const name = document.getElementById('thief-name').value.trim();
            const date = document.getElementById('thief-date').value;
            const store = document.getElementById('thief-store').value;
            const crimeType = document.getElementById('thief-crime-type').value;
            const items = document.getElementById('thief-items').value.trim();
            const value = document.getElementById('thief-value').value;
            const description = document.getElementById('thief-description').value.trim();
            const policeReport = document.getElementById('thief-police-report').value.trim();
            const status = document.getElementById('thief-status').value;
            const photoInput = document.getElementById('thief-photo');

            // Validation
            if (!name || !date || !store || !crimeType || !items || !value || !description) {
                alert('Please fill in all required fields');
                return;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('#add-thief-modal .btn-primary, .modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Get photo and upload to Firebase Storage if available
                let photoUrl = null;
                let photoPath = null;
                const photoImg = document.getElementById('thief-photo-img');
                if (photoImg && photoImg.src && photoInput.files.length > 0 && photoImg.src.startsWith('data:')) {
                    if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading photo...';

                    // Initialize storage if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    // Generate a temporary ID for the file name
                    const tempId = Date.now().toString();
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        photoImg.src,
                        'thieves/photos',
                        tempId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                }

                // Create thief data object with Storage URL instead of base64
                const thiefData = {
                    name: name,
                    photo: photoUrl,           // Now stores URL instead of base64
                    photoPath: photoPath,      // Store path for future deletion
                    date: date,
                    store: store,
                    crimeType: crimeType,
                    itemsStolen: items,
                    estimatedValue: parseFloat(value),
                    description: description,
                    policeReport: policeReport || null,
                    banned: status === 'banned'
                };

                if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving record...';

                // Try to save to Firebase
                const firestoreId = await saveThiefToFirebase(thiefData);

                if (firestoreId) {
                    // Successfully saved to Firebase
                    thiefData.id = firestoreId;
                    thiefData.firestoreId = firestoreId;
                    console.log('Thief record saved to Firebase with ID:', firestoreId);
                } else {
                    // Fallback to local ID
                    const newId = thieves.length > 0 ? Math.max(...thieves.map(t => typeof t.id === 'number' ? t.id : 0)) + 1 : 1;
                    thiefData.id = newId;
                    console.log('Thief record saved locally with ID:', newId);
                }

                // Add to local array
                thieves.unshift(thiefData);

                closeModal();
                renderThieves();
            } catch (error) {
                console.error('Error saving thief:', error);
                alert('Error saving record. Please try again.');
            } finally {
                // Restore button state
                if (saveBtn) {
                    saveBtn.innerHTML = originalText || '<i class="fas fa-save"></i> Save';
                    saveBtn.disabled = false;
                }
            }
        }

        // Invoices database
        let invoices = [
            {
                id: 1,
                invoiceNumber: 'INV-2025-001',
                vendor: 'Cloud Services Inc.',
                category: 'Technology',
                description: 'Cloud storage subscription',
                amount: 299.99,
                dueDate: '2025-12-15',
                paidDate: null,
                status: 'pending',
                recurring: true,
                notes: 'Monthly subscription'
            },
            {
                id: 2,
                invoiceNumber: 'INV-2025-002',
                vendor: 'Office Supplies Co.',
                category: 'Office',
                description: 'Office supplies and equipment',
                amount: 456.50,
                dueDate: '2025-12-10',
                paidDate: '2025-12-08',
                status: 'paid',
                recurring: false,
                notes: ''
            },
            {
                id: 3,
                invoiceNumber: 'INV-2025-003',
                vendor: 'Utilities Provider',
                category: 'Utilities',
                description: 'Monthly electricity bill',
                amount: 523.75,
                dueDate: '2025-12-20',
                paidDate: null,
                status: 'overdue',
                recurring: true,
                notes: 'Store: Miramar'
            }
        ];

        // Invoice filter state
        let invoiceFilters = {
            store: 'all',
            timePeriod: 'all',
            vendor: 'all',
            category: 'all',
            status: 'all',
            minAmount: null,
            maxAmount: null,
            activeTab: 'current' // 'current' or 'recurring'
        };

        // Chart instances (for cleanup)
        let invoiceCharts = {
            statusChart: null,
            timeChart: null,
            vendorChart: null,
            trendChart: null,
            categoryChart: null
        };

        // Helper function to get filtered invoices
        function getFilteredInvoices() {
            let filtered = [...invoices];

            // Filter by store
            if (invoiceFilters.store !== 'all') {
                filtered = filtered.filter(i => i.store === invoiceFilters.store);
            }

            // Filter by time period
            if (invoiceFilters.timePeriod !== 'all') {
                const now = new Date();
                const filterDate = new Date();

                switch (invoiceFilters.timePeriod) {
                    case '7days':
                        filterDate.setDate(now.getDate() - 7);
                        break;
                    case 'thisMonth':
                        filterDate.setDate(1);
                        break;
                    case 'lastMonth':
                        filterDate.setMonth(now.getMonth() - 1);
                        filterDate.setDate(1);
                        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                        filtered = filtered.filter(i => {
                            const date = new Date(i.dueDate);
                            return date >= filterDate && date <= lastMonthEnd;
                        });
                        return filtered;
                    case 'thisQuarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        filterDate.setMonth(quarter * 3);
                        filterDate.setDate(1);
                        break;
                    case 'thisYear':
                        filterDate.setMonth(0);
                        filterDate.setDate(1);
                        break;
                }

                filtered = filtered.filter(i => new Date(i.dueDate) >= filterDate);
            }

            // Filter by vendor
            if (invoiceFilters.vendor !== 'all') {
                filtered = filtered.filter(i => i.vendor === invoiceFilters.vendor);
            }

            // Filter by category
            if (invoiceFilters.category !== 'all') {
                filtered = filtered.filter(i => i.category.toLowerCase() === invoiceFilters.category.toLowerCase());
            }

            // Filter by status
            if (invoiceFilters.status !== 'all') {
                filtered = filtered.filter(i => i.status === invoiceFilters.status);
            }

            // Filter by amount range
            if (invoiceFilters.minAmount !== null) {
                filtered = filtered.filter(i => i.amount >= invoiceFilters.minAmount);
            }
            if (invoiceFilters.maxAmount !== null) {
                filtered = filtered.filter(i => i.amount <= invoiceFilters.maxAmount);
            }

            return filtered;
        }

        // Update invoice filter and re-render
        function updateInvoiceFilter(filterKey, value) {
            invoiceFilters[filterKey] = value;
            renderInvoices();
        }

        // Reset all invoice filters
        function resetInvoiceFilters() {
            invoiceFilters = {
                store: 'all',
                timePeriod: 'all',
                vendor: 'all',
                category: 'all',
                status: 'all',
                minAmount: null,
                maxAmount: null,
                activeTab: invoiceFilters.activeTab
            };
            renderInvoices();
        }

        // Switch invoice tab
        function switchInvoiceTab(tab) {
            invoiceFilters.activeTab = tab;
            renderInvoices();
        }

        // Render current invoices table
        function renderCurrentInvoicesTable(filteredInvoices) {
            if (filteredInvoices.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 16px;">No invoices found</div>
                        <div style="font-size: 14px; margin-top: 8px;">Try adjusting your filters</div>
                    </div>
                `;
            }

            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">File</th>
                            <th>Invoice #</th>
                            <th>Vendor</th>
                            <th>Category</th>
                            <th>Store</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th style="width: 140px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredInvoices.map(invoice => {
                            const statusStyles = {
                                paid: 'background: #10b981; color: #fff;',
                                pending: 'background: #f59e0b; color: #000;',
                                overdue: 'background: #ef4444; color: #fff;'
                            };
                            const invoiceId = invoice.firestoreId || invoice.id;

                            return `
                                <tr>
                                    <td>
                                        ${invoice.photo ? (invoice.fileType === 'pdf' ? `
                                            <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="viewInvoice('${invoiceId}')" title="PDF">
                                                <i class="fas fa-file-pdf" style="font-size: 20px; color: #ef4444;"></i>
                                            </div>
                                        ` : `
                                            <img src="${invoice.photo}" alt="Invoice" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer;" onclick="viewInvoice('${invoiceId}')">
                                        `) : `
                                            <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-file-invoice" style="color: var(--text-muted);"></i>
                                            </div>
                                        `}
                                    </td>
                                    <td><strong>${invoice.invoiceNumber}</strong></td>
                                    <td>${invoice.vendor}</td>
                                    <td><span class="badge" style="background: var(--accent-primary); color: #fff; font-size: 11px;">${invoice.category}</span></td>
                                    <td>${invoice.store || '<span style="color: var(--text-muted);">Unassigned</span>'}</td>
                                    <td style="font-weight: 600;">$${invoice.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                    <td>${formatDate(invoice.dueDate)}</td>
                                    <td>
                                        <span class="badge" style="${statusStyles[invoice.status]}; font-size: 11px;">${invoice.status.toUpperCase()}</span>
                                        ${invoice.recurring ? '<i class="fas fa-sync-alt" style="margin-left: 6px; color: var(--text-muted); font-size: 12px;" title="Recurring"></i>' : ''}
                                    </td>
                                    <td>
                                        ${invoice.status !== 'paid' ? `<button class="btn-icon" onclick="markInvoicePaid('${invoiceId}')" title="Mark Paid"><i class="fas fa-check"></i></button>` : ''}
                                        <button class="btn-icon" onclick="viewInvoice('${invoiceId}')" title="View"><i class="fas fa-eye"></i></button>
                                        <button class="btn-icon" onclick="editInvoice('${invoiceId}')" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="btn-icon danger" onclick="deleteInvoice('${invoiceId}')" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Render recurring projections
        function renderRecurringProjections() {
            const recurringInvoices = invoices.filter(i => i.recurring);

            if (recurringInvoices.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-sync-alt" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 16px;">No recurring invoices found</div>
                        <div style="font-size: 14px; margin-top: 8px;">Mark invoices as recurring to see future projections</div>
                    </div>
                `;
            }

            // Generate next 6 months of projections
            const projections = [];
            const today = new Date();

            recurringInvoices.forEach(invoice => {
                for (let i = 1; i <= 6; i++) {
                    const projectionDate = new Date(today);
                    projectionDate.setMonth(today.getMonth() + i);

                    projections.push({
                        ...invoice,
                        projectedDate: projectionDate,
                        isProjection: true
                    });
                }
            });

            // Sort by date
            projections.sort((a, b) => a.projectedDate - b.projectedDate);

            return `
                <div style="padding: 20px;">
                    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i class="fas fa-info-circle" style="color: var(--accent-primary); font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Recurring Invoice Projections</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Showing projected invoices for the next 6 months based on monthly recurrence</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px;">
                            <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Total Projected (6mo)</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent-primary);">
                                    $${projections.reduce((sum, p) => sum + p.amount, 0).toLocaleString('en-US', {minimumFractionDigits: 2})}
                                </div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Recurring Invoices</div>
                                <div style="font-size: 20px; font-weight: 700;">${recurringInvoices.length}</div>
                            </div>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Projected Date</th>
                                <th>Invoice #</th>
                                <th>Vendor</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${projections.map(proj => `
                                <tr>
                                    <td><strong>${formatDate(proj.projectedDate)}</strong></td>
                                    <td>${proj.invoiceNumber} <span style="font-size: 11px; color: var(--text-muted);">(recurring)</span></td>
                                    <td>${proj.vendor}</td>
                                    <td><span class="badge" style="background: var(--accent-primary); color: #fff; font-size: 11px;">${proj.category}</span></td>
                                    <td>${proj.store || '<span style="color: var(--text-muted);">Unassigned</span>'}</td>
                                    <td style="font-weight: 600;">$${proj.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Initialize all invoice charts
        function initializeInvoiceCharts(filteredInvoices) {
            // Destroy existing charts
            Object.values(invoiceCharts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Status Breakdown (Donut Chart)
            const statusCtx = document.getElementById('invoice-status-chart');
            if (statusCtx) {
                const statusCounts = {
                    paid: filteredInvoices.filter(i => i.status === 'paid').length,
                    pending: filteredInvoices.filter(i => i.status === 'pending').length,
                    overdue: filteredInvoices.filter(i => i.status === 'overdue').length
                };

                invoiceCharts.statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Paid', 'Pending', 'Overdue'],
                        datasets: [{
                            data: [statusCounts.paid, statusCounts.pending, statusCounts.overdue],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Category Breakdown (Pie Chart)
            const categoryCtx = document.getElementById('invoice-category-chart');
            if (categoryCtx) {
                const categoryData = {};
                filteredInvoices.forEach(inv => {
                    const cat = inv.category || 'Other';
                    categoryData[cat] = (categoryData[cat] || 0) + inv.amount;
                });

                const categoryLabels = Object.keys(categoryData);
                const categoryValues = Object.values(categoryData);
                const categoryColors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444'];

                invoiceCharts.categoryChart = new Chart(categoryCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: categoryColors.slice(0, categoryLabels.length),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': $' + context.parsed.toLocaleString('en-US', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Amount Over Time (Bar Chart - Weekly)
            const timeCtx = document.getElementById('invoice-time-chart');
            if (timeCtx) {
                // Get last 8 weeks of data
                const weeks = [];
                const now = new Date();

                for (let i = 7; i >= 0; i--) {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (i * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    const weekInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.dueDate);
                        return invDate >= weekStart && invDate <= weekEnd;
                    });

                    const weekTotal = weekInvoices.reduce((sum, inv) => sum + inv.amount, 0);

                    weeks.push({
                        label: `${weekStart.getMonth() + 1}/${weekStart.getDate()}`,
                        total: weekTotal
                    });
                }

                invoiceCharts.timeChart = new Chart(timeCtx, {
                    type: 'bar',
                    data: {
                        labels: weeks.map(w => w.label),
                        datasets: [{
                            label: 'Amount',
                            data: weeks.map(w => w.total),
                            backgroundColor: '#6366f1',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Trend Analysis (Line Chart)
            const trendCtx = document.getElementById('invoice-trend-chart');
            if (trendCtx) {
                // Get last 12 weeks cumulative
                const trendWeeks = [];
                const now = new Date();
                let cumulative = 0;

                for (let i = 11; i >= 0; i--) {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (i * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    const weekInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.dueDate);
                        return invDate >= weekStart && invDate <= weekEnd;
                    });

                    const weekTotal = weekInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                    cumulative += weekTotal;

                    trendWeeks.push({
                        label: `${weekStart.getMonth() + 1}/${weekStart.getDate()}`,
                        cumulative: cumulative
                    });
                }

                invoiceCharts.trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: trendWeeks.map(w => w.label),
                        datasets: [{
                            label: 'Cumulative Amount',
                            data: trendWeeks.map(w => w.cumulative),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Top Vendors (Horizontal Bar Chart)
            const vendorCtx = document.getElementById('invoice-vendor-chart');
            if (vendorCtx) {
                const vendorData = {};
                filteredInvoices.forEach(inv => {
                    vendorData[inv.vendor] = (vendorData[inv.vendor] || 0) + inv.amount;
                });

                const sortedVendors = Object.entries(vendorData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                invoiceCharts.vendorChart = new Chart(vendorCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedVendors.map(v => v[0]),
                        datasets: [{
                            label: 'Total Amount',
                            data: sortedVendors.map(v => v[1]),
                            backgroundColor: '#8b5cf6',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '$' + context.parsed.x.toLocaleString('en-US', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        async function renderInvoices() {
            const dashboard = document.querySelector('.dashboard');

            // Load invoices from Firebase if available
            await loadInvoicesFromFirebase();

            // Get filtered invoices
            const filteredInvoices = getFilteredInvoices();

            // Calculate metrics
            const totalAmount = filteredInvoices.reduce((sum, i) => sum + i.amount, 0);
            const totalPaid = filteredInvoices.filter(i => i.status === 'paid').reduce((sum, i) => sum + i.amount, 0);
            const totalPending = filteredInvoices.filter(i => i.status === 'pending').reduce((sum, i) => sum + i.amount, 0);
            const overdueCount = filteredInvoices.filter(i => i.status === 'overdue').length;

            // Get unique values for filters
            const stores = ['All Stores', ...new Set(invoices.filter(i => i.store).map(i => i.store))];
            const vendors = [...new Set(invoices.map(i => i.vendor))].sort();
            const categories = ['utilities', 'rent', 'supplies', 'inventory', 'services', 'equipment', 'other'];

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Invoices</h2>
                        <p class="section-subtitle">Track and manage payments with insights</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-invoice')">
                        <i class="fas fa-plus"></i> Add Invoice
                    </button>
                </div>

                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; padding: 20px; color: white;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Total Amount</div>
                        <div style="font-size: 28px; font-weight: 700;">$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 20px; color: white;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Paid</div>
                        <div style="font-size: 28px; font-weight: 700;">$${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 20px; color: white;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Pending</div>
                        <div style="font-size: 28px; font-weight: 700;">$${totalPending.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; padding: 20px; color: white;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Overdue</div>
                        <div style="font-size: 28px; font-weight: 700;">${overdueCount}</div>
                    </div>
                </div>

                <!-- Filters Bar -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; align-items: end;">
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Store</label>
                                <select class="form-input" onchange="updateInvoiceFilter('store', this.value)">
                                    ${stores.map(s => `<option value="${s === 'All Stores' ? 'all' : s}" ${invoiceFilters.store === (s === 'All Stores' ? 'all' : s) ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Time Period</label>
                                <select class="form-input" onchange="updateInvoiceFilter('timePeriod', this.value)">
                                    <option value="all">All Time</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="thisMonth">This Month</option>
                                    <option value="lastMonth">Last Month</option>
                                    <option value="thisQuarter">This Quarter</option>
                                    <option value="thisYear">This Year</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Vendor</label>
                                <select class="form-input" onchange="updateInvoiceFilter('vendor', this.value)">
                                    <option value="all">All Vendors</option>
                                    ${vendors.map(v => `<option value="${v}">${v}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Category</label>
                                <select class="form-input" onchange="updateInvoiceFilter('category', this.value)">
                                    <option value="all">All Categories</option>
                                    ${categories.map(c => `<option value="${c}">${c.charAt(0).toUpperCase() + c.slice(1)}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Status</label>
                                <select class="form-input" onchange="updateInvoiceFilter('status', this.value)">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                            <button class="btn-secondary" onclick="resetInvoiceFilters()" style="height: 40px;">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <!-- Status Breakdown (Donut) -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-pie"></i> Payment Status</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="invoice-status-chart" height="250"></canvas>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-tags"></i> By Category</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="invoice-category-chart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Time Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <!-- Amount Over Time (Bar) -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-bar"></i> Amount Over Time</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="invoice-time-chart" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Trend Line Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-line"></i> Trend Analysis</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="invoice-trend-chart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Vendors -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Top Vendors by Amount</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="invoice-vendor-chart" height="150"></canvas>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="card">
                    <div class="card-header" style="border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; gap: 16px;">
                            <button class="btn-${invoiceFilters.activeTab === 'current' ? 'primary' : 'secondary'}" onclick="switchInvoiceTab('current')">
                                <i class="fas fa-file-invoice"></i> Current Invoices
                            </button>
                            <button class="btn-${invoiceFilters.activeTab === 'recurring' ? 'primary' : 'secondary'}" onclick="switchInvoiceTab('recurring')">
                                <i class="fas fa-sync-alt"></i> Recurring Projections
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="invoice-tab-content">
                            ${invoiceFilters.activeTab === 'current' ? renderCurrentInvoicesTable(filteredInvoices) : renderRecurringProjections()}
                        </div>
                    </div>
                </div>
            `;

            // Initialize charts after DOM is ready
            setTimeout(() => initializeInvoiceCharts(filteredInvoices), 100);
        }

        function renderInvoicesTable(filter = 'all') {
            const filteredInvoices = filter === 'all' ? invoices : invoices.filter(i => i.status === filter);

            if (filteredInvoices.length === 0) {
                return `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            No invoices found
                        </td>
                    </tr>
                `;
            }

            return filteredInvoices.map(invoice => {
                const statusStyles = {
                    paid: 'background: var(--success); color: #fff;',
                    pending: 'background: var(--warning); color: #000;',
                    overdue: 'background: var(--danger); color: #fff;'
                };

                const invoiceId = invoice.firestoreId || invoice.id;

                return `
                    <tr>
                        <td>
                            ${invoice.photo ? (invoice.fileType === 'pdf' ? `
                                <div style="width: 50px; height: 50px; background: var(--bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="viewInvoice('${invoiceId}')" title="Click to view PDF">
                                    <i class="fas fa-file-pdf" style="font-size: 24px; color: #ef4444;"></i>
                                </div>
                            ` : `
                                <img src="${invoice.photo}" alt="Invoice" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; cursor: pointer;" onclick="viewInvoice('${invoiceId}')" title="Click to view details">
                            `) : `
                                <div style="width: 50px; height: 50px; background: var(--bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-file-invoice" style="color: var(--text-muted);"></i>
                                </div>
                            `}
                        </td>
                        <td><strong>${invoice.invoiceNumber}</strong></td>
                        <td>${invoice.vendor}</td>
                        <td>
                            <span class="badge" style="background: var(--accent-primary); color: #fff;">${invoice.category}</span>
                        </td>
                        <td>${invoice.description}</td>
                        <td style="font-weight: 600;">$${invoice.amount.toFixed(2)}</td>
                        <td>${invoice.paymentAccount || '-'}</td>
                        <td>${formatDate(invoice.dueDate)}</td>
                        <td>
                            <span class="badge" style="${statusStyles[invoice.status]}">${invoice.status.toUpperCase()}</span>
                            ${invoice.recurring ? '<i class="fas fa-sync-alt" style="margin-left: 8px; color: var(--text-muted);" title="Recurring"></i>' : ''}
                        </td>
                        <td>
                            ${invoice.status !== 'paid' ? `<button class="btn-icon" onclick="markInvoicePaid('${invoiceId}')" title="Mark Paid"><i class="fas fa-check"></i></button>` : ''}
                            <button class="btn-icon" onclick="viewInvoice('${invoiceId}')" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="btn-icon" onclick="editInvoice('${invoiceId}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon" onclick="deleteInvoice('${invoiceId}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterInvoices(status) {
            const tbody = document.getElementById('invoicesTableBody');
            if (tbody) {
                tbody.innerHTML = renderInvoicesTable(status);
            }
        }

        async function markInvoicePaid(id) {
            const numericId = !isNaN(id) ? parseInt(id, 10) : id;
            const invoice = invoices.find(i => i.id === id || i.id === numericId || i.firestoreId === id);
            if (invoice) {
                // Update in Firebase
                if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized) {
                    const firestoreId = invoice.firestoreId || id;
                    const success = await firebaseInvoiceManager.markInvoicePaid(firestoreId);
                    if (success) {
                        // Update local state
                        invoice.status = 'paid';
                        invoice.paidDate = new Date().toISOString().split('T')[0];
                        renderInvoices();
                    } else {
                        alert('Error marking invoice as paid');
                    }
                } else {
                    // Fallback to local only
                    invoice.status = 'paid';
                    invoice.paidDate = new Date().toISOString().split('T')[0];
                    renderInvoices();
                }
            }
        }

        function viewInvoice(id) {
            // Convert id to number if it's a numeric string for comparison with numeric IDs
            const numericId = !isNaN(id) ? parseInt(id, 10) : id;
            const invoice = invoices.find(i => i.id === id || i.id === numericId || i.firestoreId === id);

            if (!invoice) {
                console.error('Invoice not found with ID:', id);
                return;
            }

            const invoiceId = invoice.firestoreId || invoice.id;
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Invoice Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                <div>
                                    <h3 style="margin: 0 0 8px;">${invoice.invoiceNumber}</h3>
                                    <div style="display: flex; gap: 8px;">
                                        <span class="badge" style="background: ${invoice.status === 'paid' ? 'var(--success)' : invoice.status === 'pending' ? 'var(--warning)' : 'var(--error)'};">${invoice.status.toUpperCase()}</span>
                                        ${invoice.recurring ? '<span class="badge" style="background: var(--accent-primary);"><i class="fas fa-sync-alt"></i> Recurring</span>' : ''}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">$${invoice.amount.toFixed(2)}</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Vendor</label>
                                    <div>${invoice.vendor}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Category</label>
                                    <div>${invoice.category}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Due Date</label>
                                    <div>${formatDate(invoice.dueDate)}</div>
                                </div>
                                ${invoice.paidDate ? `
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Paid Date</label>
                                        <div style="color: var(--success);">${formatDate(invoice.paidDate)}</div>
                                    </div>
                                ` : ''}
                            </div>

                            ${invoice.description ? `
                                <div style="margin-top: 20px;">
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Description</label>
                                    <div>${invoice.description}</div>
                                </div>
                            ` : ''}

                            ${invoice.notes ? `
                                <div style="margin-top: 20px;">
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Notes</label>
                                    <div style="color: var(--text-secondary);">${invoice.notes}</div>
                                </div>
                            ` : ''}

                            ${invoice.photo ? `
                                <div style="margin-top: 20px;">
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px;">Invoice File</label>
                                    ${invoice.fileType === 'pdf' ? `
                                        <div style="border-radius: 8px; overflow: hidden; background: var(--bg-tertiary);">
                                            <div style="padding: 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                                                <div style="display: flex; align-items: center; gap: 12px;">
                                                    <i class="fas fa-file-pdf" style="font-size: 24px; color: #ef4444;"></i>
                                                    <span style="font-weight: 500;">${invoice.fileName || 'Invoice.pdf'}</span>
                                                </div>
                                                <div style="display: flex; gap: 8px;">
                                                    <button class="btn-secondary" onclick="openPdfInNewTab('${invoice.photo.replace(/'/g, "\\'")}')" style="padding: 6px 12px;">
                                                        <i class="fas fa-external-link-alt"></i> Open in Tab
                                                    </button>
                                                    <button class="btn-primary" onclick="downloadPdf('${invoice.photo.replace(/'/g, "\\'")}', '${(invoice.fileName || 'Invoice.pdf').replace(/'/g, "\\'")}')" style="padding: 6px 12px;">
                                                        <i class="fas fa-download"></i> Download
                                                    </button>
                                                </div>
                                            </div>
                                            <div style="width: 100%; height: 600px; position: relative; background: #525659; border-radius: 0 0 8px 8px; overflow: hidden;">
                                                <iframe
                                                    src="${invoice.photo}#toolbar=0&navpanes=0&scrollbar=0"
                                                    type="application/pdf"
                                                    style="width: 100%; height: 100%; border: none; display: block;"
                                                    frameborder="0"
                                                    allowfullscreen>
                                                </iframe>
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="border-radius: 8px; overflow: hidden; background: var(--bg-tertiary);">
                                            <!-- Zoom Controls -->
                                            <div style="padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <i class="fas fa-image" style="color: var(--text-muted);"></i>
                                                    <span style="font-size: 13px; color: var(--text-secondary);">Invoice Image</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <button class="btn-icon" onclick="zoomInvoiceImage(-0.25)" title="Zoom Out" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-search-minus"></i>
                                                    </button>
                                                    <span id="invoice-zoom-level" style="font-size: 12px; color: var(--text-muted); min-width: 45px; text-align: center;">100%</span>
                                                    <button class="btn-icon" onclick="zoomInvoiceImage(0.25)" title="Zoom In" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-search-plus"></i>
                                                    </button>
                                                    <button class="btn-icon" onclick="resetInvoiceZoom()" title="Reset Zoom" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-compress-arrows-alt"></i>
                                                    </button>
                                                    <button class="btn-icon" onclick="openInvoiceImageFullSize()" title="Open Full Size" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-external-link-alt"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <!-- Image Container with Zoom -->
                                            <div id="invoice-image-container" style="overflow: hidden; max-height: 400px; position: relative;">
                                                <img id="invoice-zoom-image" src="${invoice.photo}" alt="Invoice Photo" style="width: 100%; transform-origin: top left; transition: transform 0.15s ease; cursor: default; user-select: none;" ondragstart="return false;" onmousedown="startImageDrag(event)">
                                            </div>
                                        </div>
                                    `}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${invoice.status !== 'paid' ? `
                        <button class="btn-primary" style="width: 100%;" onclick="markInvoicePaid('${invoiceId}'); closeModal();">
                            <i class="fas fa-check"></i>
                            Mark as Paid
                        </button>
                    ` : ''}
                </div>
            `;

            modal.classList.add('active');

            // Reset zoom level for new invoice
            invoiceZoomLevel = 1;
        }

        async function deleteInvoice(id) {
            showConfirmModal({
                title: 'Delete Invoice',
                message: 'Are you sure you want to delete this invoice? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    const numericId = !isNaN(id) ? parseInt(id, 10) : id;
                    // Delete from Firebase
                    if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized) {
                        const success = await firebaseInvoiceManager.deleteInvoice(id);
                        if (success) {
                            // Update local state
                            invoices = invoices.filter(i => i.id !== id && i.id !== numericId && i.firestoreId !== id);
                            renderInvoices();
                        } else {
                            showNotification('Error deleting invoice', 'error');
                        }
                    } else {
                        // Fallback to local only
                        invoices = invoices.filter(i => i.id !== id && i.id !== numericId && i.firestoreId !== id);
                        renderInvoices();
                    }
                }
            });
        }

        async function saveInvoice() {
            const invoiceNumber = document.getElementById('invoice-number').value.trim();
            const vendor = document.getElementById('invoice-vendor').value.trim();
            const category = document.getElementById('invoice-category').value;
            const store = document.getElementById('invoice-store').value || null;
            const amount = document.getElementById('invoice-amount').value;
            const description = document.getElementById('invoice-description').value.trim();
            const dueDate = document.getElementById('invoice-due-date').value;
            const status = document.getElementById('invoice-status').value;
            const paymentAccount = document.getElementById('invoice-payment-account').value;
            const recurring = document.getElementById('invoice-recurring').checked;
            const notes = document.getElementById('invoice-notes').value.trim();

            // Validate required fields
            if (!invoiceNumber || !vendor || !amount) {
                alert('Please fill in all required fields (Invoice #, Vendor, Amount)');
                return;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Get file if uploaded - upload to Firebase Storage
                const fileInput = document.getElementById('invoice-photo');
                let fileUrl = null;
                let filePath = null;
                let fileType = null;
                let fileName = null;

                if (fileInput && fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];

                    // Validate file size (max 10MB for Storage)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File is too large. Please use a file smaller than 10MB.');
                        if (saveBtn) {
                            saveBtn.innerHTML = originalText;
                            saveBtn.disabled = false;
                        }
                        return;
                    }

                    if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading file...';

                    // Initialize storage if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    // Determine file type
                    const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                    fileType = isPdf ? 'pdf' : 'image';
                    fileName = file.name;

                    // Upload to Firebase Storage
                    const uploadResult = await firebaseStorageHelper.uploadDocument(
                        file,
                        'invoices/attachments',
                        invoiceNumber.replace(/[^a-zA-Z0-9]/g, '_') + '_'
                    );
                    fileUrl = uploadResult.url;
                    filePath = uploadResult.path;
                }

                if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving invoice...';

                await createInvoiceRecord(invoiceNumber, vendor, category, store, amount, description, dueDate, status, paymentAccount, recurring, notes, fileUrl, fileType, fileName, filePath);
            } catch (error) {
                console.error('Error saving invoice:', error);
                alert('Error saving invoice. Please try again.');
            } finally {
                if (saveBtn) {
                    saveBtn.innerHTML = originalText || 'Save Invoice';
                    saveBtn.disabled = false;
                }
            }
        }

        async function createInvoiceRecord(invoiceNumber, vendor, category, store, amount, description, dueDate, status, paymentAccount, recurring, notes, photo, fileType = null, fileName = null, filePath = null) {
            // Create invoice data object
            const invoiceData = {
                invoiceNumber: invoiceNumber || '',
                vendor: vendor || '',
                category: category || '',
                store: store || null,
                description: description || '',
                amount: parseFloat(amount) || 0,
                dueDate: dueDate || '',
                paidDate: status === 'paid' ? new Date().toISOString().split('T')[0] : null,
                status: status || 'pending',
                paymentAccount: paymentAccount || '',
                recurring: recurring,
                notes: notes || '',
                photo: photo,           // Now stores URL instead of base64
                filePath: filePath,     // Storage path for deletion
                fileType: fileType,     // 'pdf' or 'image' or null
                fileName: fileName      // Original filename for PDFs
            };

            // Save to Firebase
            if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized) {
                const docId = await firebaseInvoiceManager.addInvoice(invoiceData);
                if (docId) {
                    // Add to local array with Firebase ID
                    invoiceData.id = docId;
                    invoiceData.firestoreId = docId;
                    invoices.unshift(invoiceData);
                    closeModal();
                    renderInvoices();
                } else {
                    alert('Error saving invoice to Firebase');
                }
            } else {
                // Fallback to local only
                const newId = invoices.length > 0 ? Math.max(...invoices.map(i => typeof i.id === 'number' ? i.id : 0)) + 1 : 1;
                invoiceData.id = newId;
                invoices.unshift(invoiceData);
                closeModal();
                renderInvoices();
            }
        }

        function previewInvoiceFile(input) {
            const photoPreview = document.getElementById('invoice-photo-preview');
            const pdfPreview = document.getElementById('invoice-pdf-preview');
            const img = document.getElementById('invoice-photo-img');
            const pdfName = document.getElementById('invoice-pdf-name');
            const pdfSize = document.getElementById('invoice-pdf-size');

            // Hide both previews initially
            if (photoPreview) photoPreview.style.display = 'none';
            if (pdfPreview) pdfPreview.style.display = 'none';

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Validate file size (max 1MB for Firestore)
                if (file.size > 1024 * 1024) {
                    alert('File is too large. Please use a file smaller than 1MB.');
                    input.value = '';
                    return;
                }

                // Check if it's a PDF
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    // Show PDF preview
                    if (pdfPreview && pdfName && pdfSize) {
                        pdfName.textContent = file.name;
                        pdfSize.textContent = formatFileSize(file.size);
                        pdfPreview.style.display = 'block';
                    }
                } else {
                    // Show image preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (img && photoPreview) {
                            img.src = e.target.result;
                            photoPreview.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Keep old function name for backwards compatibility
        function previewInvoicePhoto(input) {
            previewInvoiceFile(input);
        }

        // Open PDF in a new browser tab
        function openPdfInNewTab(base64Data) {
            // Create a blob from the base64 data
            try {
                const byteCharacters = atob(base64Data.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                const blobUrl = URL.createObjectURL(blob);
                window.open(blobUrl, '_blank');
            } catch (error) {
                console.error('Error opening PDF:', error);
                // Fallback to direct base64 URL
                window.open(base64Data, '_blank');
            }
        }

        // Download PDF file
        function downloadPdf(base64Data, fileName) {
            try {
                const byteCharacters = atob(base64Data.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });

                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName || 'invoice.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF. Please try the "Open in Tab" option instead.');
            }
        }

        // Invoice Image Zoom Controls
        let invoiceZoomLevel = 1;
        let isImageDragging = false;
        let imageDragStartX = 0;
        let imageDragStartY = 0;
        let imageTranslateX = 0;
        let imageTranslateY = 0;
        let imageStartTranslateX = 0;
        let imageStartTranslateY = 0;

        function zoomInvoiceImage(delta) {
            const img = document.getElementById('invoice-zoom-image');
            const zoomDisplay = document.getElementById('invoice-zoom-level');

            if (!img) return;

            // Calculate new zoom level (min 0.5, max 4)
            const newZoom = Math.max(0.5, Math.min(4, invoiceZoomLevel + delta));

            // If zooming out to 1 or less, reset position
            if (newZoom <= 1) {
                imageTranslateX = 0;
                imageTranslateY = 0;
            }

            invoiceZoomLevel = newZoom;

            // Apply zoom with transform
            img.style.transform = `scale(${invoiceZoomLevel}) translate(${imageTranslateX}px, ${imageTranslateY}px)`;

            // Update display
            if (zoomDisplay) {
                zoomDisplay.textContent = `${Math.round(invoiceZoomLevel * 100)}%`;
            }

            // Update cursor based on zoom level
            img.style.cursor = invoiceZoomLevel > 1 ? 'grab' : 'default';
        }

        function resetInvoiceZoom() {
            const img = document.getElementById('invoice-zoom-image');
            const zoomDisplay = document.getElementById('invoice-zoom-level');

            if (!img) return;

            invoiceZoomLevel = 1;
            imageTranslateX = 0;
            imageTranslateY = 0;
            img.style.transform = 'scale(1) translate(0px, 0px)';
            img.style.cursor = 'default';

            if (zoomDisplay) {
                zoomDisplay.textContent = '100%';
            }
        }

        function startImageDrag(event) {
            const img = document.getElementById('invoice-zoom-image');
            if (!img || invoiceZoomLevel <= 1) return;

            isImageDragging = true;
            img.style.cursor = 'grabbing';
            img.style.transition = 'none'; // Disable transition during drag for smooth movement
            imageDragStartX = event.clientX;
            imageDragStartY = event.clientY;
            imageStartTranslateX = imageTranslateX;
            imageStartTranslateY = imageTranslateY;
            event.preventDefault();

            // Add document-level listeners so dragging continues even outside the image
            document.addEventListener('mousemove', dragImage);
            document.addEventListener('mouseup', stopImageDrag);
        }

        function dragImage(event) {
            if (!isImageDragging) return;

            const img = document.getElementById('invoice-zoom-image');
            if (!img) return;

            // Calculate delta and apply to translate (divide by zoom to keep movement proportional)
            const deltaX = (event.clientX - imageDragStartX) / invoiceZoomLevel;
            const deltaY = (event.clientY - imageDragStartY) / invoiceZoomLevel;

            imageTranslateX = imageStartTranslateX + deltaX;
            imageTranslateY = imageStartTranslateY + deltaY;

            img.style.transform = `scale(${invoiceZoomLevel}) translate(${imageTranslateX}px, ${imageTranslateY}px)`;
        }

        function stopImageDrag() {
            const img = document.getElementById('invoice-zoom-image');
            if (img) {
                img.style.cursor = invoiceZoomLevel > 1 ? 'grab' : 'default';
                img.style.transition = 'transform 0.15s ease'; // Re-enable smooth transition
            }
            isImageDragging = false;

            // Remove document-level listeners
            document.removeEventListener('mousemove', dragImage);
            document.removeEventListener('mouseup', stopImageDrag);
        }

        function openInvoiceImageFullSize() {
            const img = document.getElementById('invoice-zoom-image');
            if (!img || !img.src) return;

            const base64Data = img.src;

            // Check if it's a base64 image
            if (base64Data.startsWith('data:image')) {
                // Convert base64 to blob and open in new tab
                try {
                    const parts = base64Data.split(',');
                    const mimeMatch = parts[0].match(/:(.*?);/);
                    const mimeType = mimeMatch ? mimeMatch[1] : 'image/png';
                    const byteString = atob(parts[1]);
                    const byteNumbers = new Array(byteString.length);

                    for (let i = 0; i < byteString.length; i++) {
                        byteNumbers[i] = byteString.charCodeAt(i);
                    }

                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: mimeType });
                    const blobUrl = URL.createObjectURL(blob);

                    // Open in new tab
                    const newTab = window.open(blobUrl, '_blank');

                    // Clean up blob URL after a delay
                    if (newTab) {
                        setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                    }
                } catch (error) {
                    console.error('Error opening image:', error);
                    // Fallback: try opening directly
                    window.open(base64Data, '_blank');
                }
            } else {
                // It's a regular URL, just open it
                window.open(base64Data, '_blank');
            }
        }

        function editInvoice(id) {
            const numericId = !isNaN(id) ? parseInt(id, 10) : id;
            const invoice = invoices.find(i => i.id === id || i.id === numericId || i.firestoreId === id);
            if (!invoice) return;

            const invoiceId = invoice.firestoreId || invoice.id;
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Edit Invoice</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <form id="edit-invoice-form" onsubmit="event.preventDefault(); saveInvoiceChanges('${invoiceId}');">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Invoice Number *</label>
                                <input type="text" class="form-input" id="edit-invoice-number" value="${invoice.invoiceNumber || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vendor *</label>
                                <input type="text" class="form-input" id="edit-invoice-vendor" value="${invoice.vendor || ''}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-input" id="edit-invoice-category">
                                    <option value="utilities" ${invoice.category === 'utilities' ? 'selected' : ''}>Utilities</option>
                                    <option value="rent" ${invoice.category === 'rent' ? 'selected' : ''}>Rent</option>
                                    <option value="supplies" ${invoice.category === 'supplies' ? 'selected' : ''}>Supplies</option>
                                    <option value="inventory" ${invoice.category === 'inventory' ? 'selected' : ''}>Inventory</option>
                                    <option value="services" ${invoice.category === 'services' ? 'selected' : ''}>Services</option>
                                    <option value="equipment" ${invoice.category === 'equipment' ? 'selected' : ''}>Equipment</option>
                                    <option value="other" ${invoice.category === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Store</label>
                                <select class="form-input" id="edit-invoice-store">
                                    <option value="" ${!invoice.store ? 'selected' : ''}>Unassigned</option>
                                    <option value="Miramar" ${invoice.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                    <option value="Morena" ${invoice.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                    <option value="Kearny Mesa" ${invoice.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                    <option value="Chula Vista" ${invoice.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                    <option value="North Park" ${invoice.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                    <option value="Miramar Wine & Liquor" ${invoice.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Amount *</label>
                                <input type="number" step="0.01" class="form-input" id="edit-invoice-amount" value="${invoice.amount || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-input" id="edit-invoice-due-date" value="${invoice.dueDate || ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="edit-invoice-description" value="${invoice.description || ''}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-input" id="edit-invoice-status">
                                    <option value="pending" ${invoice.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="overdue" ${invoice.status === 'overdue' ? 'selected' : ''}>Overdue</option>
                                    <option value="paid" ${invoice.status === 'paid' ? 'selected' : ''}>Paid</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Account</label>
                                <select class="form-input" id="edit-invoice-payment-account">
                                    <option value="" ${!invoice.paymentAccount ? 'selected' : ''}>Select account...</option>
                                    <option value="Shop App" ${invoice.paymentAccount === 'Shop App' ? 'selected' : ''}>Shop App</option>
                                    <option value="Personal Account" ${invoice.paymentAccount === 'Personal Account' ? 'selected' : ''}>Personal Account</option>
                                    <option value="Business Account" ${invoice.paymentAccount === 'Business Account' ? 'selected' : ''}>Business Account</option>
                                    <option value="PayPal" ${invoice.paymentAccount === 'PayPal' ? 'selected' : ''}>PayPal</option>
                                    <option value="Credit Card" ${invoice.paymentAccount === 'Credit Card' ? 'selected' : ''}>Credit Card</option>
                                    <option value="Cash" ${invoice.paymentAccount === 'Cash' ? 'selected' : ''}>Cash</option>
                                    <option value="Other" ${invoice.paymentAccount === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="edit-invoice-recurring" ${invoice.recurring ? 'checked' : ''} style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                Recurring Invoice
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="edit-invoice-notes" rows="3">${invoice.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Invoice File (Photo or PDF)</label>
                            ${invoice.photo ? `
                                <div id="edit-invoice-current-file" style="margin-bottom: 10px;">
                                    ${invoice.fileType === 'pdf' ? `
                                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                            <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444;"></i>
                                            <div>
                                                <div style="font-weight: 500;">${invoice.fileName || 'Invoice.pdf'}</div>
                                                <p style="font-size: 12px; color: var(--text-muted); margin: 4px 0 0 0;">Current PDF (upload new to replace)</p>
                                            </div>
                                        </div>
                                    ` : `
                                        <img src="${invoice.photo}" alt="Current Invoice Photo" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: contain;">
                                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Current photo (upload new to replace)</p>
                                    `}
                                </div>
                            ` : ''}
                            <input type="file" class="form-input" id="edit-invoice-photo" accept="image/*,.pdf,application/pdf" onchange="previewEditInvoiceFile(this)">
                            <div id="edit-invoice-photo-preview" style="margin-top: 10px; display: none;">
                                <img id="edit-invoice-photo-img" src="" alt="New Photo Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: contain;">
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">New photo preview</p>
                            </div>
                            <div id="edit-invoice-pdf-preview" style="margin-top: 10px; display: none;">
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444;"></i>
                                    <div>
                                        <div id="edit-invoice-pdf-name" style="font-weight: 500;"></div>
                                        <div id="edit-invoice-pdf-size" style="font-size: 12px; color: var(--text-muted);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions" style="margin-top: 24px;">
                            <button type="button" class="btn-secondary" onclick="closeModal()">Close</button>
                            <button type="button" class="btn-primary" onclick="saveInvoiceChanges('${invoiceId}')">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            `;

            modal.classList.add('active');
        }

        function previewEditInvoiceFile(input) {
            const photoPreview = document.getElementById('edit-invoice-photo-preview');
            const pdfPreview = document.getElementById('edit-invoice-pdf-preview');
            const img = document.getElementById('edit-invoice-photo-img');
            const pdfName = document.getElementById('edit-invoice-pdf-name');
            const pdfSize = document.getElementById('edit-invoice-pdf-size');

            // Hide both previews initially
            if (photoPreview) photoPreview.style.display = 'none';
            if (pdfPreview) pdfPreview.style.display = 'none';

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Validate file size (max 1MB for Firestore)
                if (file.size > 1024 * 1024) {
                    alert('File is too large. Please use a file smaller than 1MB.');
                    input.value = '';
                    return;
                }

                // Check if it's a PDF
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    // Show PDF preview
                    if (pdfPreview && pdfName && pdfSize) {
                        pdfName.textContent = file.name;
                        pdfSize.textContent = formatFileSize(file.size);
                        pdfPreview.style.display = 'block';
                    }
                } else {
                    // Show image preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (img && photoPreview) {
                            img.src = e.target.result;
                            photoPreview.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Keep old function name for backwards compatibility
        function previewEditInvoicePhoto(input) {
            previewEditInvoiceFile(input);
        }

        async function saveInvoiceChanges(invoiceId) {
            const invoiceNumber = document.getElementById('edit-invoice-number').value.trim();
            const vendor = document.getElementById('edit-invoice-vendor').value.trim();
            const category = document.getElementById('edit-invoice-category').value;
            const store = document.getElementById('edit-invoice-store').value || null;
            const amount = document.getElementById('edit-invoice-amount').value;
            const description = document.getElementById('edit-invoice-description').value.trim();
            const dueDate = document.getElementById('edit-invoice-due-date').value;
            const status = document.getElementById('edit-invoice-status').value;
            const paymentAccount = document.getElementById('edit-invoice-payment-account').value;
            const recurring = document.getElementById('edit-invoice-recurring').checked;
            const notes = document.getElementById('edit-invoice-notes').value.trim();

            // Validate required fields
            if (!invoiceNumber || !vendor || !amount) {
                showNotification('Please fill in all required fields (Invoice #, Vendor, Amount)', 'error');
                return;
            }

            // Find the invoice to get current file data
            const numericId = !isNaN(invoiceId) ? parseInt(invoiceId, 10) : invoiceId;
            const invoice = invoices.find(i => i.id === invoiceId || i.id === numericId || i.firestoreId === invoiceId);

            // Get new file if uploaded (Base64 encoding for both images and PDFs)
            const fileInput = document.getElementById('edit-invoice-photo');
            let fileData = invoice ? invoice.photo : null; // Keep existing file by default
            let fileType = invoice ? invoice.fileType : null;
            let fileName = invoice ? invoice.fileName : null;

            if (fileInput && fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];

                // Validate file size (max 1MB for Firestore)
                if (file.size > 1024 * 1024) {
                    showNotification('File is too large. Please use a file smaller than 1MB.', 'error');
                    return;
                }

                // Determine file type
                const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                fileType = isPdf ? 'pdf' : 'image';
                fileName = file.name;

                // Convert to Base64
                fileData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsDataURL(file);
                });
            }

            // Create update data object
            const updateData = {
                invoiceNumber: invoiceNumber || '',
                vendor: vendor || '',
                category: category || '',
                store: store || null,
                description: description || '',
                amount: parseFloat(amount) || 0,
                dueDate: dueDate || '',
                paidDate: status === 'paid' ? (invoice && invoice.paidDate ? invoice.paidDate : new Date().toISOString().split('T')[0]) : null,
                status: status || 'pending',
                paymentAccount: paymentAccount || '',
                recurring: recurring,
                notes: notes || '',
                photo: fileData,
                fileType: fileType,
                fileName: fileName
            };

            try {
                // Update in Firebase
                if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized) {
                    const success = await firebaseInvoiceManager.updateInvoice(invoiceId, updateData);
                    if (success) {
                        // Update local state
                        const idx = invoices.findIndex(i => i.id === invoiceId || i.firestoreId === invoiceId);
                        if (idx !== -1) {
                            invoices[idx] = { ...invoices[idx], ...updateData };
                        }
                        closeModal();
                        renderInvoices();
                        showNotification('Invoice updated successfully', 'success');
                    } else {
                        showNotification('Error updating invoice', 'error');
                    }
                } else {
                    // Fallback to local only
                    const idx = invoices.findIndex(i => i.id === invoiceId || i.firestoreId === invoiceId);
                    if (idx !== -1) {
                        invoices[idx] = { ...invoices[idx], ...updateData };
                    }
                    closeModal();
                    renderInvoices();
                    showNotification('Invoice updated locally', 'success');
                }
            } catch (error) {
                console.error('Error saving invoice changes:', error);
                showNotification('Error saving invoice changes', 'error');
            }
        }

        // Load invoices from Firebase
        async function loadInvoicesFromFirebase() {
            try {
                if (typeof firebaseInvoiceManager === 'undefined') {
                    console.log('Firebase Invoice Manager not available');
                    return;
                }

                if (!firebaseInvoiceManager.isInitialized) {
                    await firebaseInvoiceManager.initialize();
                }

                const firebaseInvoices = await firebaseInvoiceManager.loadInvoices();

                if (firebaseInvoices.length > 0) {
                    // Replace local invoices with Firebase data
                    invoices = firebaseInvoices;
                    console.log('Loaded', firebaseInvoices.length, 'invoices from Firebase');
                }
            } catch (error) {
                console.error('Error loading invoices from Firebase:', error);
            }
        }

        // Treasury Functions
        async function loadTreasuryItemsFromFirebase() {
            try {
                console.log(' Loading treasury from Firebase...');
                if (typeof firebase === 'undefined' || !firebase.firestore) {
                    console.warn('锔 Firebase not available for treasury');
                    return false;
                }

                const db = firebase.firestore();
                const treasuryCollection = window.FIREBASE_COLLECTIONS?.treasury || 'treasury';
                
                const snapshot = await db.collection(treasuryCollection).get();
                const items = [];
                
                snapshot.forEach(doc => {
                    items.push({
                        id: items.length > 0 ? Math.max(...items.map(i => i.id || 0)) + 1 : 1,
                        firestoreId: doc.id,
                        ...doc.data()
                    });
                });

                treasuryItems = items;
                console.log(' Loaded treasury items from Firebase:', treasuryItems.length);
                return true;
            } catch (error) {
                console.error(' Error loading treasury items from Firebase:', error);
                return false;
            }
        }

        function renderTreasury() {
            console.log(' renderTreasury called');
            // Load from Firebase first
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                loadTreasuryItemsFromFirebase().then(() => {
                    console.log(' Firebase load complete, rendering content');
                    renderTreasuryContent();
                }).catch(error => {
                    console.error(' Error in renderTreasury:', error);
                    renderTreasuryContent(); // Still render even if Firebase fails
                });
            } else {
                console.warn('锔 Firebase not initialized, rendering with local data');
                // If Firebase not available, just render with existing data
                renderTreasuryContent();
            }
        }

        function renderTreasuryContent() {
            console.log(' renderTreasuryContent called with', treasuryItems.length, 'items');
            const dashboard = document.querySelector('.dashboard');
            
            if (!dashboard) {
                console.error(' Dashboard element not found!');
                return;
            }

            const totalValue = treasuryItems.reduce((sum, item) => sum + item.value, 0);
            const itemsByLocation = {
                'VSU Kearny Mesa': treasuryItems.filter(i => i.location === 'VSU Kearny Mesa').length,
                'VSU Miramar': treasuryItems.filter(i => i.location === 'VSU Miramar').length,
                'VSU Morena': treasuryItems.filter(i => i.location === 'VSU Morena').length,
                'VSU North Park': treasuryItems.filter(i => i.location === 'VSU North Park').length
            };

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Treasury - Select Pieces</h2>
                        <p class="section-subtitle">Manage your valuable collection</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-treasury')">
                        <i class="fas fa-plus"></i>
                        Add Piece
                    </button>
                </div>

                <div class="treasury-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--accent-primary) 0%, #818cf8 100%); text-align: center; padding: 32px 24px;">
                        <div class="stat-icon" style="margin: 0 auto 16px; background: rgba(255, 255, 255, 0.2);"><i class="fas fa-vault"></i></div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9);">Total Value</div>
                            <div class="stat-value" style="color: white;">$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); text-align: center; padding: 32px 24px;">
                        <div class="stat-icon" style="margin: 0 auto 16px; background: rgba(255, 255, 255, 0.2);"><i class="fas fa-gem"></i></div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9);">Total Pieces</div>
                            <div class="stat-value" style="color: white;">${treasuryItems.length}</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header treasury-card-header">
                        <h3 class="card-title">
                            <i class="fas fa-images"></i>
                            Collection Inventory
                        </h3>
                        <div class="treasury-filter-container" style="display: flex; gap: 12px;">
                            <select class="form-input" style="width: 200px;" onchange="filterTreasury(this.value)">
                                <option value="all">All Locations</option>
                                <option value="VSU Kearny Mesa">VSU Kearny Mesa (${itemsByLocation['VSU Kearny Mesa']})</option>
                                <option value="VSU Miramar">VSU Miramar (${itemsByLocation['VSU Miramar']})</option>
                                <option value="VSU Morena">VSU Morena (${itemsByLocation['VSU Morena']})</option>
                                <option value="VSU North Park">VSU North Park (${itemsByLocation['VSU North Park']})</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0; overflow-x: auto;">
                        <table class="data-table treasury-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Photo</th>
                                    <th>Artwork Name</th>
                                    <th>Artist</th>
                                    <th>Acquisition Date</th>
                                    <th>Value (USD)</th>
                                    <th>Location</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="treasuryTableBody">
                                ${renderTreasuryTable()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderTreasuryTable(filter = 'all') {
            const filteredItems = filter === 'all' ? treasuryItems : treasuryItems.filter(i => i.location === filter);

            if (filteredItems.length === 0) {
                return `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-gem" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            No pieces found
                        </td>
                    </tr>
                `;
            }

            return filteredItems.map(item => {
                // Support both 'image' field and legacy 'photos' array
                const itemImage = item.image || (item.photos && item.photos.length > 0 ? item.photos[0] : null);
                const photoDisplay = itemImage
                    ? `<img src="${itemImage}" style="width: 100%; height: 100%; object-fit: cover;" alt="${item.artworkName}">`
                    : `<i class="fas fa-gem" style="color: var(--text-muted); font-size: 24px;"></i>`;

                const itemValue = parseFloat(item.value) || 0;
                const itemName = item.artworkName || 'Unknown';
                const itemArtist = item.artist || '-';
                const itemDate = item.acquisitionDate || '-';
                const itemLocation = item.location || 'Unknown';

                return `
                    <tr>
                        <td data-label="Photo">
                            <div style="width: 60px; height: 60px; border-radius: 8px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--border-color);">
                                ${photoDisplay}
                            </div>
                        </td>
                        <td data-label="Artwork Name"><strong>${itemName}</strong></td>
                        <td data-label="Artist">${itemArtist}</td>
                        <td data-label="Acquisition Date">${formatDate(itemDate)}</td>
                        <td data-label="Value" style="font-weight: 600; color: var(--success);">$${itemValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td data-label="Location">
                            <span class="badge" style="background: var(--accent-primary);">${itemLocation}</span>
                        </td>
                        <td data-label="Actions">
                            <button class="btn-icon" onclick="viewTreasuryItem('${item.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon" onclick="editTreasuryItem('${item.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteTreasuryItem('${item.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterTreasury(location) {
            const tbody = document.getElementById('treasuryTableBody');
            if (tbody) {
                tbody.innerHTML = renderTreasuryTable(location);
            }
        }

        function viewTreasuryItem(id) {
            const item = treasuryItems.find(t => t.id === id);
            if (!item) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            // Support both 'image' field and legacy 'photos' array
            const itemImage = item.image || (item.photos && item.photos.length > 0 ? item.photos[0] : null);
            const imageDisplay = itemImage
                ? `<img src="${itemImage}" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 12px;" alt="${item.artworkName}">`
                : `<div style="text-align: center; padding: 60px; background: var(--bg-secondary); border-radius: 12px; color: var(--text-muted);">
                    <i class="fas fa-gem" style="font-size: 64px; margin-bottom: 16px; display: block;"></i>
                    No image available
                </div>`;

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-gem"></i> ${item.artworkName}</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 24px; text-align: center;">
                        ${imageDisplay}
                    </div>

                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <h4 style="margin: 0 0 16px; font-size: 14px; color: var(--text-muted);">Piece Information</h4>
                            <div class="treasury-info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-bottom: 16px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Artist</label>
                                    <div style="font-weight: 500;">${item.artist || 'Unknown'}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Acquisition Date</label>
                                    <div>${formatDate(item.acquisitionDate) || '-'}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Estimated Value</label>
                                    <div style="font-weight: 600; color: var(--success); font-size: 18px;">$${(parseFloat(item.value) || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Current Location</label>
                                    <div><span class="badge" style="background: var(--accent-primary);">${item.location || 'Unknown'}</span></div>
                                </div>
                            </div>

                            ${item.description ? `
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px;">Description</label>
                                    <p style="margin: 0; line-height: 1.6; color: var(--text-secondary);">${item.description}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="treasury-modal-actions" style="display: flex; gap: 12px;">
                        <button class="btn-secondary" style="flex: 1;" onclick="editTreasuryItem('${item.id}')">
                            <i class="fas fa-edit"></i>
                            Edit Piece
                        </button>
                        <button class="btn-secondary" style="flex: 1; background: var(--danger); color: white; border-color: var(--danger);" onclick="closeModal(); deleteTreasuryItem('${item.id}');">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function editTreasuryItem(id) {
            closeModal();
            setTimeout(() => openModal('edit-treasury', id), 100);
        }

        async function deleteTreasuryItem(id) {
            showConfirmModal({
                title: 'Delete Treasury Item',
                message: 'Are you sure you want to delete this piece from the collection? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        // Find the item to get firestoreId
                        const item = treasuryItems.find(t => t.id === id);

                        // Delete from Firebase if firestoreId exists
                        if (item && item.firestoreId && typeof firebase !== 'undefined' && firebase.firestore) {
                            const db = firebase.firestore();
                            const treasuryCollection = window.FIREBASE_COLLECTIONS?.treasury || 'treasury';
                            await db.collection(treasuryCollection).doc(item.firestoreId).delete();
                            console.log(' Treasury item deleted from Firebase');
                        }

                        // Remove from local array
                        treasuryItems = treasuryItems.filter(t => t.id !== id);

                        await loadTreasuryItemsFromFirebase();
                        renderTreasuryContent();
                    } catch (error) {
                        console.error('Error deleting treasury item:', error);
                        showNotification('Error deleting item. Please try again.', 'error');
                    }
                }
            });
        }

        /**
         * Preview treasury image before upload
         */
        function previewTreasuryImage(input) {
            const preview = document.getElementById('treasury-image-preview');
            if (!preview) return;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    preview.removeAttribute('data-removed');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        /**
         * Remove treasury image from preview
         */
        function removeTreasuryImage() {
            const preview = document.getElementById('treasury-image-preview');
            const input = document.getElementById('treasury-image');

            if (preview) {
                preview.innerHTML = `<i class="fas fa-gem" style="font-size: 36px; color: var(--text-muted);"></i>`;
                preview.setAttribute('data-removed', 'true');
            }
            if (input) {
                input.value = '';
            }
        }

        async function saveTreasuryItem(isEdit = false, itemId = null) {
            const artworkName = document.getElementById('treasury-artwork-name').value.trim();
            const artist = document.getElementById('treasury-artist').value.trim();
            const acquisitionDate = document.getElementById('treasury-acquisition-date').value;
            const value = parseFloat(document.getElementById('treasury-value').value) || 0;
            const location = document.getElementById('treasury-location').value;
            const description = document.getElementById('treasury-description').value.trim();

            // Get the image
            const imageInput = document.getElementById('treasury-image');
            const imagePreview = document.getElementById('treasury-image-preview');

            // Determine image value
            let image = null;
            const wasRemoved = imagePreview?.getAttribute('data-removed') === 'true';

            if (wasRemoved) {
                // Image was explicitly removed
                image = null;
            } else if (imageInput?.files && imageInput.files.length > 0) {
                // New image uploaded - convert to base64 and compress
                const rawBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageInput.files[0]);
                });
                try {
                    image = await compressImage(rawBase64);
                } catch (err) {
                    console.error('Error compressing treasury image:', err);
                    image = rawBase64;
                }
            } else if (isEdit) {
                // Keep existing image
                const existingItem = treasuryItems.find(t => t.id === itemId);
                image = existingItem?.image || (existingItem?.photos && existingItem.photos.length > 0 ? existingItem.photos[0] : null);
            }

            if (!artworkName || !location) {
                alert('Please fill in at least the artwork name and location');
                return;
            }

            try {
                if (isEdit) {
                    const item = treasuryItems.find(t => t.id === itemId);
                    if (item) {
                        item.artworkName = artworkName;
                        item.artist = artist;
                        item.acquisitionDate = acquisitionDate;
                        item.value = value;
                        item.location = location;
                        item.description = description;
                        item.image = image;

                        // Update in Firebase
                        if (typeof firebase !== 'undefined' && firebase.firestore) {
                            const db = firebase.firestore();
                            const treasuryCollection = window.FIREBASE_COLLECTIONS?.treasury || 'treasury';

                            // Use firestoreId if available, otherwise create new
                            if (item.firestoreId) {
                                await db.collection(treasuryCollection).doc(item.firestoreId).update({
                                    artworkName,
                                    artist,
                                    acquisitionDate,
                                    value,
                                    location,
                                    description,
                                    image,
                                    updatedAt: new Date()
                                });
                                console.log(' Treasury item updated in Firebase');
                            } else {
                                // If no firestoreId, save as new
                                const docRef = await db.collection(treasuryCollection).add({
                                    artworkName,
                                    artist,
                                    acquisitionDate,
                                    value,
                                    location,
                                    description,
                                    image,
                                    createdAt: new Date(),
                                    updatedAt: new Date()
                                });
                                item.firestoreId = docRef.id;
                                console.log(' Treasury item created in Firebase');
                            }
                        }
                    }
                } else {
                    const newItem = {
                        id: treasuryItems.length > 0 ? Math.max(...treasuryItems.map(t => t.id)) + 1 : 1,
                        artworkName,
                        artist,
                        acquisitionDate,
                        value,
                        location,
                        description,
                        image
                    };

                    // Save to Firebase
                    if (typeof firebase !== 'undefined' && firebase.firestore) {
                        const db = firebase.firestore();
                        const treasuryCollection = window.FIREBASE_COLLECTIONS?.treasury || 'treasury';

                        const docRef = await db.collection(treasuryCollection).add({
                            artworkName,
                            artist,
                            acquisitionDate,
                            value,
                            location,
                            description,
                            image,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        newItem.firestoreId = docRef.id;
                        console.log(' Treasury item saved to Firebase');
                    }

                    treasuryItems.push(newItem);
                }

                closeModal();
                await loadTreasuryItemsFromFirebase();
                renderTreasuryContent();
            } catch (error) {
                console.error('Error saving treasury item:', error);
                alert('Error saving treasury item. Please try again.');
            }
        }

        // Change Functions - Daily Change Register
        const CHANGE_DENOMINATIONS = {
            coins: [
                { id: 'pennies', label: 'Pennies', value: 0.01, icon: '1垄' },
                { id: 'nickels', label: 'Nickels', value: 0.05, icon: '5垄' },
                { id: 'dimes', label: 'Dimes', value: 0.10, icon: '10垄' },
                { id: 'quarters', label: 'Quarters', value: 0.25, icon: '25垄' },
                { id: 'dollars_coin', label: 'Dollar Coins', value: 1.00, icon: '$1' }
            ],
            bills: [
                { id: 'ones', label: '$1 Bills', value: 1, icon: '$1' },
                { id: 'fives', label: '$5 Bills', value: 5, icon: '$5' },
                { id: 'tens', label: '$10 Bills', value: 10, icon: '$10' },
                { id: 'twenties', label: '$20 Bills', value: 20, icon: '$20' }
            ]
        };

        let changeFilterStore = 'all';

        function renderChange() {
            const dashboard = document.querySelector('.dashboard');
            const today = new Date().toISOString().split('T')[0];

            // Filter records
            const filteredRecords = changeFilterStore === 'all'
                ? changeRecords
                : changeRecords.filter(r => r.store === changeFilterStore);

            // Sort by date descending
            const sortedRecords = [...filteredRecords].sort((a, b) => new Date(b.date) - new Date(a.date));

            // Today's records
            const todayRecords = changeRecords.filter(r => r.date === today);
            const todayTotal = todayRecords.reduce((sum, r) => sum + (r.amount || 0), 0);

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title" style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-coins" style="color: white; font-size: 20px;"></i>
                            </div>
                            Daily Change Register
                        </h2>
                        <p class="section-subtitle">Record daily change by denomination</p>
                    </div>
                    <button class="btn-primary" onclick="openDailyChangeForm()">
                        <i class="fas fa-plus"></i> New Daily Record
                    </button>
                </div>

                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 16px; padding: 20px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Today's Total</div>
                        <div style="font-size: 28px; font-weight: 700;">$${todayTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">${todayRecords.length} record${todayRecords.length !== 1 ? 's' : ''}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 20px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Total Records</div>
                        <div style="font-size: 28px; font-weight: 700;">${changeRecords.length}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">All time</div>
                    </div>
                </div>

                <!-- Daily Change Form (hidden by default) -->
                <div id="daily-change-form" style="display: none; margin-bottom: 24px;"></div>

                <!-- Filter -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center;">
                    <select class="form-input" style="width: 200px;" onchange="filterChangeByStore(this.value)">
                        <option value="all" ${changeFilterStore === 'all' ? 'selected' : ''}>All Stores</option>
                        <option value="Miramar" ${changeFilterStore === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                        <option value="Morena" ${changeFilterStore === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                        <option value="Kearny Mesa" ${changeFilterStore === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                        <option value="Chula Vista" ${changeFilterStore === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                        <option value="Miramar Wine & Liquor" ${changeFilterStore === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                    </select>
                    <span style="font-size: 13px; color: var(--text-muted);">${filteredRecords.length} records</span>
                </div>

                <!-- Records List -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${sortedRecords.length === 0 ? `
                        <div class="card">
                            <div class="card-body" style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <i class="fas fa-coins" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.3;"></i>
                                <div style="font-size: 16px; margin-bottom: 8px;">No change records yet</div>
                                <div style="font-size: 13px;">Click "New Daily Record" to add one</div>
                            </div>
                        </div>
                    ` : sortedRecords.map(record => renderChangeRecordRow(record)).join('')}
                </div>
            `;
        }

        function renderDailyChangeForm() {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, var(--bg-secondary) 100%);">
                    <div class="card-header" style="background: transparent;">
                        <h3 class="card-title" style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-coins" style="color: #f59e0b;"></i>
                            New Daily Change Record
                        </h3>
                        <button onclick="closeDailyChangeForm()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 8px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <!-- Basic Info -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Date</label>
                                <input type="date" id="change-date" class="form-input" value="${today}">
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Store</label>
                                <select id="change-store" class="form-input">
                                    <option value="Miramar">VSU Miramar</option>
                                    <option value="Morena">VSU Morena</option>
                                    <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                    <option value="Chula Vista">VSU Chula Vista</option>
                                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Recorded By</label>
                                <input type="text" id="change-recorded-by" class="form-input" placeholder="Your name">
                            </div>
                        </div>

                        <!-- Coins Section -->
                        <div style="margin-bottom: 24px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-circle" style="color: #f59e0b; font-size: 10px;"></i> Coins
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                ${CHANGE_DENOMINATIONS.coins.map(d => `
                                    <div style="background: var(--bg-primary); border-radius: 12px; padding: 14px; text-align: center;">
                                        <div style="font-size: 18px; font-weight: 700; color: #f59e0b; margin-bottom: 6px;">${d.icon}</div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">${d.label}</div>
                                        <input type="number" id="change-${d.id}" class="form-input" value="0" min="0"
                                            style="text-align: center; font-weight: 600;" onchange="calculateChangeTotal()">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Bills Section -->
                        <div style="margin-bottom: 24px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-money-bill" style="color: #10b981; font-size: 10px;"></i> Bills
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                ${CHANGE_DENOMINATIONS.bills.map(d => `
                                    <div style="background: var(--bg-primary); border-radius: 12px; padding: 14px; text-align: center;">
                                        <div style="font-size: 18px; font-weight: 700; color: #10b981; margin-bottom: 6px;">${d.icon}</div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">${d.label}</div>
                                        <input type="number" id="change-${d.id}" class="form-input" value="0" min="0"
                                            style="text-align: center; font-weight: 600;" onchange="calculateChangeTotal()">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Total -->
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 6px;">TOTAL</div>
                            <div id="change-total-display" style="font-size: 32px; font-weight: 700; color: white;">$0.00</div>
                        </div>

                        <!-- Photo Upload -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Photo (optional)</label>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <label style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 20px; border: 2px dashed var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='var(--border-color)'">
                                        <i class="fas fa-camera" style="font-size: 20px; color: var(--text-muted);"></i>
                                        <span style="font-size: 13px; color: var(--text-muted);">Upload envelope photo</span>
                                        <input type="file" id="change-photo" accept="image/*" style="display: none;" onchange="previewChangePhoto(this)">
                                    </label>
                                </div>
                                <div id="change-photo-preview" style="display: none; width: 80px; height: 80px; border-radius: 10px; overflow: hidden; background: var(--bg-secondary);">
                                    <img id="change-photo-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Notes (optional)</label>
                            <textarea id="change-notes" class="form-input" placeholder="Any additional notes..." style="min-height: 60px; resize: vertical;"></textarea>
                        </div>

                        <!-- Actions -->
                        <div style="display: flex; justify-content: flex-end; gap: 12px;">
                            <button class="btn-secondary" onclick="closeDailyChangeForm()">Cancel</button>
                            <button class="btn-primary" onclick="saveDailyChange()">
                                <i class="fas fa-save"></i> Save Record
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChangeRecordRow(record) {
            const recordId = record.firestoreId || record.id;
            const recordDate = new Date(record.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const isToday = record.date === new Date().toISOString().split('T')[0];

            return `
                <div class="card" style="border-radius: 12px; overflow: hidden; ${isToday ? 'border-left: 4px solid #f59e0b;' : ''}">
                    <div onclick="toggleChangeDetails('${recordId}')" style="display: flex; align-items: center; padding: 16px 20px; gap: 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                        <!-- Date -->
                        <div style="min-width: 80px;">
                            <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${recordDate}</div>
                            ${isToday ? '<div style="font-size: 10px; color: #f59e0b; font-weight: 600;">TODAY</div>' : ''}
                        </div>

                        <!-- Store -->
                        <div style="background: var(--accent-primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            ${record.store}
                        </div>

                        <!-- Amount -->
                        <div style="flex: 1; text-align: right;">
                            <div style="font-size: 20px; font-weight: 700; color: #10b981;">$${(record.amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>

                        <!-- Recorded By -->
                        <div style="font-size: 13px; color: var(--text-muted); min-width: 100px; display: flex; align-items: center; gap: 8px;">
                            <span><i class="fas fa-user" style="margin-right: 6px;"></i>${record.recordedBy || record.leftBy || 'Unknown'}</span>
                            ${record.photo ? '<i class="fas fa-image" style="color: #f59e0b;" title="Has photo"></i>' : ''}
                        </div>

                        <!-- Arrow -->
                        <div style="color: var(--text-muted);" id="change-arrow-${recordId}">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <!-- Expanded Details -->
                    <div id="change-details-${recordId}" style="display: none; padding: 0 20px 20px; border-top: 1px solid var(--border-color);">
                        <div style="padding-top: 16px;">
                            <!-- Denomination Breakdown -->
                            ${record.denominations && Object.keys(record.denominations).length > 0 ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <!-- Bills (left side, highest to lowest) -->
                                        <div>
                                            <div style="font-size: 12px; font-weight: 600; color: #10b981; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                                <i class="fas fa-money-bill"></i> Bills
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                ${[...CHANGE_DENOMINATIONS.bills].reverse().map(d => {
                                                    const count = record.denominations[d.id] || 0;
                                                    if (count === 0) return '';
                                                    const total = count * d.value;
                                                    return `
                                                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 10px; padding: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(16, 185, 129, 0.2);">
                                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                                <div style="font-size: 18px; font-weight: 700; color: #10b981;">${d.icon}</div>
                                                                <div style="font-size: 12px; color: var(--text-muted);">x${count}</div>
                                                            </div>
                                                            <div style="font-size: 14px; color: var(--text-primary); font-weight: 600;">$${total.toFixed(2)}</div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                        <!-- Coins (right side, highest to lowest) -->
                                        <div>
                                            <div style="font-size: 12px; font-weight: 600; color: #f59e0b; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                                <i class="fas fa-coins"></i> Coins
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                ${[...CHANGE_DENOMINATIONS.coins].reverse().map(d => {
                                                    const count = record.denominations[d.id] || 0;
                                                    if (count === 0) return '';
                                                    const total = count * d.value;
                                                    return `
                                                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 10px; padding: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(245, 158, 11, 0.2);">
                                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                                <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${d.icon}</div>
                                                                <div style="font-size: 12px; color: var(--text-muted);">x${count}</div>
                                                            </div>
                                                            <div style="font-size: 14px; color: var(--text-primary); font-weight: 600;">$${total.toFixed(2)}</div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 16px; margin-bottom: 16px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #10b981;">$${(record.amount || 0).toFixed(2)}</div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Total Amount</div>
                                </div>
                            `}

                            ${record.photo ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">
                                        <i class="fas fa-image"></i> Envelope Photo
                                    </div>
                                    <div style="border-radius: 10px; overflow: hidden; background: var(--bg-secondary);">
                                        <img src="${record.photo}" alt="Envelope" style="width: 100%; max-height: 200px; object-fit: contain; cursor: pointer;" onclick="window.open('${record.photo}', '_blank')">
                                    </div>
                                </div>
                            ` : ''}

                            ${record.notes ? `
                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Notes</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">${record.notes}</div>
                                </div>
                            ` : ''}

                            <div style="display: flex; justify-content: flex-end; gap: 8px;">
                                <button onclick="event.stopPropagation(); deleteChangeRecord('${recordId}')" class="btn-secondary" style="font-size: 12px; color: #ef4444; border-color: #ef444450;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function openDailyChangeForm() {
            const form = document.getElementById('daily-change-form');
            form.style.display = 'block';
            form.innerHTML = renderDailyChangeForm();
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function closeDailyChangeForm() {
            document.getElementById('daily-change-form').style.display = 'none';
        }

        function previewChangePhoto(input) {
            const preview = document.getElementById('change-photo-preview');
            const img = document.getElementById('change-photo-img');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        function calculateChangeTotal() {
            let total = 0;
            [...CHANGE_DENOMINATIONS.coins, ...CHANGE_DENOMINATIONS.bills].forEach(d => {
                const count = parseInt(document.getElementById(`change-${d.id}`)?.value) || 0;
                total += count * d.value;
            });
            document.getElementById('change-total-display').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2});
            return total;
        }

        function saveDailyChange() {
            const date = document.getElementById('change-date').value;
            const store = document.getElementById('change-store').value;
            const recordedBy = document.getElementById('change-recorded-by').value.trim();
            const notes = document.getElementById('change-notes').value.trim();
            const photoInput = document.getElementById('change-photo');
            const photoImg = document.getElementById('change-photo-img');
            const photo = photoImg && photoImg.src && !photoImg.src.includes('undefined') ? photoImg.src : null;

            if (!recordedBy) {
                alert('Please enter your name');
                return;
            }

            const denominations = {};
            let total = 0;
            [...CHANGE_DENOMINATIONS.coins, ...CHANGE_DENOMINATIONS.bills].forEach(d => {
                const count = parseInt(document.getElementById(`change-${d.id}`)?.value) || 0;
                if (count > 0) {
                    denominations[d.id] = count;
                    total += count * d.value;
                }
            });

            if (total === 0) {
                alert('Please enter at least one denomination');
                return;
            }

            const newRecord = {
                id: Date.now().toString(),
                date,
                store,
                recordedBy,
                amount: total,
                denominations,
                notes,
                photo,
                createdAt: new Date().toISOString()
            };

            changeRecords.unshift(newRecord);
            localStorage.setItem('changeRecords', JSON.stringify(changeRecords));
            closeDailyChangeForm();
            renderChange();
        }

        function toggleChangeDetails(id) {
            const details = document.getElementById(`change-details-${id}`);
            const arrow = document.getElementById(`change-arrow-${id}`);

            if (details.style.display === 'none') {
                // Collapse all others
                document.querySelectorAll('[id^="change-details-"]').forEach(el => el.style.display = 'none');
                document.querySelectorAll('[id^="change-arrow-"]').forEach(el => el.style.transform = 'rotate(0deg)');

                details.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function filterChangeByStore(store) {
            changeFilterStore = store;
            renderChange();
        }

        function filterChangeRecords(store) {
            filterChangeByStore(store);
        }

        function viewChangeRecord(id) {
            const record = changeRecords.find(r => r.id === id || r.firestoreId === id);
            if (!record) return;

            const recordId = record.firestoreId || record.id;
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const photoDisplay = record.photo
                ? `<img src="${record.photo}" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px;" alt="Change photo">`
                : `<div style="text-align: center; padding: 40px; background: var(--bg-secondary); border-radius: 8px; color: var(--text-muted);">
                    <i class="fas fa-image" style="font-size: 48px; margin-bottom: 12px; display: block;"></i>
                    No photo available
                </div>`;

            // Build denominations display if available
            let denominationsDisplay = '';
            if (record.denominations) {
                const d = record.denominations;
                const billsItems = [];
                const coinsItems = [];

                // Bills
                if (d.bills?.hundreds > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$100</strong>  ${d.bills.hundreds}</span>`);
                if (d.bills?.fifties > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$50</strong>  ${d.bills.fifties}</span>`);
                if (d.bills?.twenties > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$20</strong>  ${d.bills.twenties}</span>`);
                if (d.bills?.tens > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$10</strong>  ${d.bills.tens}</span>`);
                if (d.bills?.fives > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$5</strong>  ${d.bills.fives}</span>`);
                if (d.bills?.twos > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$2</strong>  ${d.bills.twos}</span>`);
                if (d.bills?.ones > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$1</strong>  ${d.bills.ones}</span>`);

                // Coins
                if (d.coins?.dollars > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$1</strong>  ${d.coins.dollars}</span>`);
                if (d.coins?.halfDollars > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>50垄</strong>  ${d.coins.halfDollars}</span>`);
                if (d.coins?.quarters > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>25垄</strong>  ${d.coins.quarters}</span>`);
                if (d.coins?.dimes > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>10垄</strong>  ${d.coins.dimes}</span>`);
                if (d.coins?.nickels > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>5垄</strong>  ${d.coins.nickels}</span>`);
                if (d.coins?.pennies > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>1垄</strong>  ${d.coins.pennies}</span>`);

                if (billsItems.length > 0 || coinsItems.length > 0) {
                    denominationsDisplay = `
                        <div style="margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
                                <i class="fas fa-money-bill-wave" style="color: var(--success);"></i> Currency Breakdown
                            </label>
                            ${billsItems.length > 0 ? `
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Bills</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">${billsItems.join('')}</div>
                                </div>
                            ` : ''}
                            ${coinsItems.length > 0 ? `
                                <div>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Coins</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">${coinsItems.join('')}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-coins"></i> Change Record Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        ${photoDisplay}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Store</label>
                            <p style="margin: 0; font-weight: 500;">VSU ${record.store}</p>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Total Amount</label>
                            <p style="margin: 0; font-weight: 600; color: var(--success); font-size: 20px;">$${record.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Date</label>
                            <p style="margin: 0; font-weight: 500;">${formatDate(record.date)}</p>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Left By</label>
                            <p style="margin: 0; font-weight: 500;">${record.leftBy}</p>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Received By</label>
                            <p style="margin: 0; font-weight: 500;">${record.receivedBy}</p>
                        </div>
                    </div>

                    ${denominationsDisplay}

                    ${record.changeInStore !== undefined && record.changeInStore !== null ? `
                        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #10b98115, #10b98108); border: 2px solid #10b98140; border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: #10b98120; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-cash-register" style="color: #10b981; font-size: 18px;"></i>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Change in Store</label>
                                    <p style="margin: 0; font-weight: 700; font-size: 24px; color: #10b981;">$${record.changeInStore.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${record.notes ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px;">Notes</label>
                            <p style="margin: 0; line-height: 1.6; color: var(--text-secondary);">${record.notes}</p>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                    <button class="btn-primary" style="background: var(--danger); border-color: var(--danger);" onclick="closeModal(); deleteChangeRecord('${recordId}');">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        function viewChangePhoto(id) {
            const record = changeRecords.find(r => r.id === id || r.firestoreId === id);
            if (!record || !record.photo) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-image"></i> Change Photo</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <img src="${record.photo}" style="width: 100%; height: auto; display: block;" alt="Change photo">
                </div>
            `;

            modal.classList.add('active');
        }

        async function deleteChangeRecord(id) {
            showConfirmModal({
                title: 'Delete Change Record',
                message: 'Are you sure you want to delete this change record? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        // Delete from Firebase
                        if (typeof firebaseChangeRecordsManager !== 'undefined' && firebaseChangeRecordsManager.isInitialized) {
                            const success = await firebaseChangeRecordsManager.deleteChangeRecord(id);
                            if (success) {
                                changeRecords = changeRecords.filter(r => r.id !== id && r.firestoreId !== id);
                                renderChange();
                            } else {
                                showNotification('Error deleting record from Firebase', 'error');
                            }
                        } else {
                            // Fallback to local deletion
                            changeRecords = changeRecords.filter(r => r.id !== id && r.firestoreId !== id);
                            renderChange();
                        }
                    } catch (error) {
                        console.error('Error deleting change record:', error);
                        showNotification('Error deleting record. Please try again.', 'error');
                    }
                }
            });
        }

        // Helper function to preview change photo
        function previewChangePhoto(input) {
            const preview = document.getElementById('change-photo-preview');
            if (!preview) return;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Helper function to remove change photo
        function removeChangePhoto() {
            const preview = document.getElementById('change-photo-preview');
            const input = document.getElementById('change-photo');
            if (preview) {
                preview.innerHTML = `<i class="fas fa-coins" style="font-size: 36px; color: var(--text-muted);"></i>`;
            }
            if (input) {
                input.value = '';
            }
        }

        // Calculate total from currency breakdown
        function calculateChangeTotal() {
            let total = 0;

            // Bills
            const bills100 = parseInt(document.getElementById('change-bills-100')?.value) || 0;
            const bills50 = parseInt(document.getElementById('change-bills-50')?.value) || 0;
            const bills20 = parseInt(document.getElementById('change-bills-20')?.value) || 0;
            const bills10 = parseInt(document.getElementById('change-bills-10')?.value) || 0;
            const bills5 = parseInt(document.getElementById('change-bills-5')?.value) || 0;
            const bills2 = parseInt(document.getElementById('change-bills-2')?.value) || 0;
            const bills1 = parseInt(document.getElementById('change-bills-1')?.value) || 0;

            // Coins
            const coins100 = parseInt(document.getElementById('change-coins-100')?.value) || 0;
            const coins50 = parseInt(document.getElementById('change-coins-50')?.value) || 0;
            const coins25 = parseInt(document.getElementById('change-coins-25')?.value) || 0;
            const coins10 = parseInt(document.getElementById('change-coins-10')?.value) || 0;
            const coins5 = parseInt(document.getElementById('change-coins-5')?.value) || 0;
            const coins1 = parseInt(document.getElementById('change-coins-1')?.value) || 0;

            total = (bills100 * 100) + (bills50 * 50) + (bills20 * 20) + (bills10 * 10) +
                    (bills5 * 5) + (bills2 * 2) + (bills1 * 1) +
                    (coins100 * 1) + (coins50 * 0.50) + (coins25 * 0.25) +
                    (coins10 * 0.10) + (coins5 * 0.05) + (coins1 * 0.01);

            // Update display
            const displayEl = document.getElementById('change-total-display');
            if (displayEl) {
                displayEl.textContent = total.toFixed(2);
            }

            return total;
        }

        // Get currency breakdown object
        function getChangeDenominations() {
            return {
                bills: {
                    hundreds: parseInt(document.getElementById('change-bills-100')?.value) || 0,
                    fifties: parseInt(document.getElementById('change-bills-50')?.value) || 0,
                    twenties: parseInt(document.getElementById('change-bills-20')?.value) || 0,
                    tens: parseInt(document.getElementById('change-bills-10')?.value) || 0,
                    fives: parseInt(document.getElementById('change-bills-5')?.value) || 0,
                    twos: parseInt(document.getElementById('change-bills-2')?.value) || 0,
                    ones: parseInt(document.getElementById('change-bills-1')?.value) || 0
                },
                coins: {
                    dollars: parseInt(document.getElementById('change-coins-100')?.value) || 0,
                    halfDollars: parseInt(document.getElementById('change-coins-50')?.value) || 0,
                    quarters: parseInt(document.getElementById('change-coins-25')?.value) || 0,
                    dimes: parseInt(document.getElementById('change-coins-10')?.value) || 0,
                    nickels: parseInt(document.getElementById('change-coins-5')?.value) || 0,
                    pennies: parseInt(document.getElementById('change-coins-1')?.value) || 0
                }
            };
        }

        async function saveChangeRecord() {
            const store = document.getElementById('change-store').value;
            const date = document.getElementById('change-date').value;
            const leftBy = document.getElementById('change-left-by').value.trim();
            const receivedBy = document.getElementById('change-received-by').value.trim();
            const notes = document.getElementById('change-notes').value.trim();
            const changeInStore = parseFloat(document.getElementById('change-in-store')?.value) || 0;
            const photoInput = document.getElementById('change-photo');

            // Calculate amount from denominations
            const amount = calculateChangeTotal();
            const denominations = getChangeDenominations();

            if (!store || !date || !leftBy || !receivedBy) {
                alert('Please fill in all required fields');
                return;
            }

            if (amount <= 0) {
                alert('Please enter at least one denomination');
                return;
            }

            // Upload photo to Firebase Storage if provided
            let photoUrl = null;
            let photoPath = null;
            if (photoInput && photoInput.files && photoInput.files[0]) {
                const rawBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(photoInput.files[0]);
                });

                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                try {
                    const tempId = Date.now().toString();
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        rawBase64,
                        'change-records/photos',
                        tempId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading change record photo to Storage:', err);
                    // Fallback to compressed base64
                    try {
                        photoUrl = await compressImage(rawBase64);
                    } catch (compressErr) {
                        console.error('Error compressing image:', compressErr);
                        photoUrl = rawBase64;
                    }
                }
            }

            const newRecord = {
                store,
                amount,
                date,
                leftBy,
                receivedBy,
                notes,
                changeInStore,
                denominations,
                photo: photoUrl,      // Now stores URL instead of base64
                photoPath: photoPath  // For future deletion
            };

            try {
                // Save to Firebase
                if (typeof firebaseChangeRecordsManager !== 'undefined' && firebaseChangeRecordsManager.isInitialized) {
                    const docId = await firebaseChangeRecordsManager.addChangeRecord(newRecord);
                    if (docId) {
                        newRecord.id = docId;
                        newRecord.firestoreId = docId;
                        changeRecords.unshift(newRecord);
                        closeModal();
                        renderChange();
                    } else {
                        alert('Error saving record to Firebase');
                    }
                } else {
                    // Fallback to local storage
                    newRecord.id = Math.max(0, ...changeRecords.map(r => r.id || 0)) + 1;
                    changeRecords.unshift(newRecord);
                    closeModal();
                    renderChange();
                }
            } catch (error) {
                console.error('Error saving change record:', error);
                alert('Error saving record. Please try again.');
            }
        }

        /**
         * Initialize Firebase and load gifts from Firestore
         */
        async function initializeFirebaseGifts() {
            try {
                console.log('Initializing Firebase for gifts management...');
                
                // Initialize Firebase manager
                const initialized = await firebaseGiftsManager.initialize();
                
                if (initialized) {
                    try {
                        // Load gifts from Firestore
                        const firestoreGifts = await firebaseGiftsManager.loadGifts();
                        
                        if (firestoreGifts && firestoreGifts.length > 0) {
                            console.log('Loaded gifts from Firestore:', firestoreGifts);
                            
                            // Map Firestore data to the local giftsRecords array
                            giftsRecords = firestoreGifts.map(gift => ({
                                id: gift.firestoreId || gift.id,
                                firestoreId: gift.firestoreId || gift.id,
                                product: gift.product || '',
                                quantity: gift.quantity || 0,
                                value: gift.value || 0,
                                recipient: gift.recipient || '',
                                recipientType: gift.recipientType || 'customer',
                                reason: gift.reason || '',
                                store: gift.store || 'Miramar',
                                date: gift.date || new Date().toISOString().split('T')[0],
                                notes: gift.notes || '',
                                photo: gift.photo || null
                            }));
                            
                            console.log(`Successfully loaded ${giftsRecords.length} gifts from Firestore`);
                            return true;
                        }
                    } catch (error) {
                        console.error('Error loading gifts from Firestore:', error);
                    }
                } else {
                    console.warn('Firebase not available. Using fallback data.');
                }
            } catch (error) {
                console.error('Error initializing Firebase gifts:', error);
            }
            
            return false;
        }

        /**
         * Save gift to Firebase
         */
        async function saveGiftToFirebase(giftData) {
            if (!firebaseGiftsManager.isInitialized) {
                console.warn('Firebase Gifts Manager not initialized');
                return null;
            }

            try {
                if (giftData.firestoreId) {
                    // Update existing
                    const success = await firebaseGiftsManager.updateGift(
                        giftData.firestoreId,
                        giftData
                    );
                    return success ? giftData.firestoreId : null;
                } else {
                    // Create new
                    const newId = await firebaseGiftsManager.addGift(giftData);
                    return newId;
                }
            } catch (error) {
                console.error('Error saving gift to Firebase:', error);
                return null;
            }
        }

        /**
         * Delete gift record from Firebase
         */
        async function deleteGiftFromFirebase(firestoreId) {
            if (!firebaseGiftsManager.isInitialized) {
                console.warn('Firebase Gifts Manager not initialized');
                return false;
            }

            try {
                return await firebaseGiftsManager.deleteGift(firestoreId);
            } catch (error) {
                console.error('Error deleting gift from Firebase:', error);
                return false;
            }
        }

        /**
         * Initialize Firebase and load issues from Firestore
         */
        async function initializeFirebaseIssues() {
            try {
                console.log('Initializing Firebase for issues management...');

                // Initialize Firebase manager
                const initialized = await firebaseIssuesManager.initialize();

                if (initialized) {
                    try {
                        // Load issues from Firestore
                        const firestoreIssues = await firebaseIssuesManager.loadIssues();

                        if (firestoreIssues && firestoreIssues.length > 0) {
                            console.log('Loaded issues from Firestore:', firestoreIssues);

                            // Map Firestore data to the local issues array
                            issues = firestoreIssues.map(issue => ({
                                id: issue.firestoreId || issue.id,
                                firestoreId: issue.firestoreId || issue.id,
                                customer: issue.customer || 'Anonymous',
                                phone: issue.phone || '',
                                type: issue.type || 'In Store',
                                store: issue.store || '',
                                description: issue.description || '',
                                incidentDate: issue.incidentDate || '',
                                perception: issue.perception || null,
                                status: issue.status || 'open',
                                createdBy: issue.createdBy || '',
                                createdDate: issue.createdDate || '',
                                solution: issue.solution || null,
                                resolvedBy: issue.resolvedBy || null,
                                resolutionDate: issue.resolutionDate || null,
                                followUpNotes: issue.followUpNotes || '',
                                statusHistory: issue.statusHistory || []
                            }));

                            console.log(`Successfully loaded ${issues.length} issues from Firestore`);
                            return true;
                        }
                    } catch (error) {
                        console.error('Error loading issues from Firestore:', error);
                    }
                } else {
                    console.warn('Firebase not available. Using fallback data.');
                }
            } catch (error) {
                console.error('Error initializing Firebase issues:', error);
            }

            return false;
        }

        // Initialize Firebase Licenses
        async function initializeFirebaseLicenses() {
            try {
                console.log('Initializing Firebase for licenses management...');

                // Initialize Firebase manager
                const initialized = await firebaseLicensesManager.initialize();

                if (initialized) {
                    try {
                        // Load licenses from Firestore
                        const firestoreLicenses = await firebaseLicensesManager.loadLicenses();

                        if (firestoreLicenses && firestoreLicenses.length > 0) {
                            console.log('Loaded licenses from Firestore:', firestoreLicenses.length);

                            // Map Firestore data to the local licenses array
                            licenses = firestoreLicenses.map(lic => ({
                                id: lic.firestoreId || lic.id,
                                firestoreId: lic.firestoreId || lic.id,
                                name: lic.name || '',
                                store: lic.store || '',
                                expires: lic.expires || '',
                                status: lic.status || 'valid',
                                file: lic.file || lic.fileName || null,
                                fileName: lic.fileName || null,
                                fileType: lic.fileType || null,
                                fileData: lic.fileData || null,
                                uploadedBy: lic.uploadedBy || null
                            }));

                            console.log(` Successfully loaded ${licenses.length} licenses from Firestore`);
                            return true;
                        } else {
                            console.log('No licenses found in Firestore, using local data');
                        }
                    } catch (error) {
                        console.error('Error loading licenses from Firestore:', error);
                    }
                } else {
                    console.warn('Firebase Licenses not available. Using fallback data.');
                }
            } catch (error) {
                console.error('Error initializing Firebase licenses:', error);
            }

            return false;
        }

        // Function to view/download a license PDF
        function viewLicensePdf(licenseId) {
            const license = licenses.find(l => l.id === licenseId || l.firestoreId === licenseId);
            if (!license) {
                alert('License not found');
                return;
            }

            if (!license.fileData) {
                alert('No PDF file attached to this license');
                return;
            }

            // Open PDF in new tab
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                    <head><title>${license.name} - ${license.store}</title></head>
                    <body style="margin:0;padding:0;">
                        <embed src="${license.fileData}" type="application/pdf" width="100%" height="100%" style="position:absolute;top:0;left:0;right:0;bottom:0;">
                    </body>
                    </html>
                `);
            } else {
                // Fallback: download the file
                const link = document.createElement('a');
                link.href = license.fileData;
                link.download = license.fileName || `${license.name}.pdf`;
                link.click();
            }
        }

        // Function to delete a license
        function deleteLicense(licenseId) {
            const license = licenses.find(l => l.id === licenseId || l.firestoreId === licenseId);
            if (!license) return;

            showConfirmModal({
                title: 'Delete License/Document',
                message: `Are you sure you want to delete "${license.name}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    // Delete from Firebase
                    if (firebaseLicensesManager && firebaseLicensesManager.isInitialized && license.firestoreId) {
                        try {
                            await firebaseLicensesManager.deleteLicense(license.firestoreId);
                            console.log(' License deleted from Firebase');
                        } catch (error) {
                            console.error('Error deleting license from Firebase:', error);
                        }
                    }

                    // Remove from local array
                    licenses = licenses.filter(l => l.id !== licenseId && l.firestoreId !== licenseId);
                    renderPage(currentPage);
                }
            });
        }

        // Gifts Functions - Control de Regalos en Especie
        function getGiftsAvailableMonths() {
            const months = new Set();
            giftsRecords.forEach(r => {
                if (r.date) months.add(r.date.slice(0, 7));
            });
            months.add(new Date().toISOString().slice(0, 7));
            return Array.from(months).sort().reverse();
        }

        function changeGiftsMonth(month) {
            giftsCurrentMonth = month;
            renderGifts();
        }

        function renderGifts() {
            const dashboard = document.querySelector('.dashboard');

            // Filter by current month
            const monthlyRecords = giftsRecords.filter(r => r.date && r.date.startsWith(giftsCurrentMonth));
            const monthlyTotal = monthlyRecords.reduce((sum, r) => sum + r.value, 0);
            const monthlyItems = monthlyRecords.reduce((sum, r) => sum + r.quantity, 0);
            const monthName = new Date(giftsCurrentMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();
            const availableMonths = getGiftsAvailableMonths();

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Customer Care</h2>
                        <p class="section-subtitle">In-Kind Gifts & Product Giveaways</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-gift')">
                        <i class="fas fa-plus"></i>
                        Register Gift
                    </button>
                </div>

                <!-- Monthly Total Card -->
                <div style="background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); border-radius: 16px; padding: 30px 40px; margin-bottom: 24px; position: relative; overflow: hidden;">
                    <div style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); width: 180px; height: 180px; border-radius: 50%; background: rgba(255,255,255,0.1);"></div>
                    <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 12px; font-weight: 600; letter-spacing: 1px; margin-bottom: 8px;">${monthName}</div>
                            <div style="color: white; font-size: 42px; font-weight: 700; margin-bottom: 4px;">$${monthlyTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 14px;">${monthlyRecords.length} gift${monthlyRecords.length !== 1 ? 's' : ''} (${monthlyItems} items) this month</div>
                        </div>
                        <select class="form-input" style="width: 150px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;" onchange="changeGiftsMonth(this.value)">
                            ${availableMonths.map(month => {
                                const mName = new Date(month + '-01').toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                                return `<option value="${month}" ${month === giftsCurrentMonth ? 'selected' : ''} style="color: black;">${mName}</option>`;
                            }).join('')}
                        </select>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body" style="padding: 12px 16px;">
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; color: var(--text-secondary);">Store:</label>
                                <select class="form-input" id="gifts-store-filter" style="width: 180px;" onchange="filterGiftsTable()">
                                    <option value="all">All Stores</option>
                                    <option value="Miramar">Miramar</option>
                                    <option value="Morena">Morena</option>
                                    <option value="Kearny Mesa">Kearny Mesa</option>
                                    <option value="Chula Vista">Chula Vista</option>
                                    <option value="North Park">North Park</option>
                                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; color: var(--text-secondary);">Recipient:</label>
                                <select class="form-input" id="gifts-type-filter" style="width: 150px;" onchange="filterGiftsTable()">
                                    <option value="all">All Types</option>
                                    <option value="customer">Customer</option>
                                    <option value="vendor">Vendor</option>
                                    <option value="employee">Employee</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gifts Table -->
                <div class="card">
                    <div class="card-body" style="padding: 0;">
                        ${monthlyRecords.length === 0 ? `
                            <div style="padding: 60px; text-align: center; color: var(--text-muted);">
                                <i class="fas fa-gift" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                                <h3 style="margin-bottom: 8px; color: var(--text-secondary);">No Gifts This Month</h3>
                                <p>Click "Register Gift" to add a new record</p>
                            </div>
                        ` : `
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Product</th>
                                        <th>Qty</th>
                                        <th>Value</th>
                                        <th>Recipient</th>
                                        <th>Type</th>
                                        <th>Details</th>
                                        <th>Store</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="giftsTableBody">
                                    ${renderGiftsTableRows(monthlyRecords)}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;
        }

        function renderGiftsTableRows(records) {
            if (records.length === 0) return '';

            return records.map(gift => `
                <tr>
                    <td>${new Date(gift.date).toLocaleDateString()}</td>
                    <td>
                        <div style="font-weight: 500;">${gift.product}</div>
                        ${gift.notes ? `<div style="font-size: 11px; color: var(--text-muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${gift.notes}</div>` : ''}
                    </td>
                    <td style="text-align: center;">${gift.quantity}</td>
                    <td style="font-weight: 600; color: var(--danger);">$${gift.value.toFixed(2)}</td>
                    <td>${gift.recipient}</td>
                    <td>
                        <span class="status-badge ${gift.recipientType === 'customer' ? 'active' : gift.recipientType === 'vendor' ? 'warning' : 'inactive'}">
                            ${gift.recipientType.charAt(0).toUpperCase() + gift.recipientType.slice(1)}
                        </span>
                    </td>
                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${gift.reason}">${gift.reason}</td>
                    <td>
                        <span style="background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${gift.store}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-icon" onclick="viewGiftDetails('${String(gift.id).replace(/'/g, "\\'")}');" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon" onclick="editGift('${String(gift.id).replace(/'/g, "\\'")}');" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteGift('${String(gift.id).replace(/'/g, "\\'")}');" title="Delete" style="color: var(--danger);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterGiftsTable() {
            const storeFilter = document.getElementById('gifts-store-filter')?.value || 'all';
            const typeFilter = document.getElementById('gifts-type-filter')?.value || 'all';

            // Start with monthly records
            let filteredRecords = giftsRecords.filter(r => r.date && r.date.startsWith(giftsCurrentMonth));

            // Apply store filter
            if (storeFilter !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.store === storeFilter);
            }

            // Apply type filter
            if (typeFilter !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.recipientType === typeFilter);
            }

            const tbody = document.getElementById('giftsTableBody');
            if (tbody) {
                tbody.innerHTML = renderGiftsTableRows(filteredRecords);
            }
        }

        function viewGiftDetails(id) {
            // Convert to number if it's a numeric string
            const giftId = typeof id === 'string' && !isNaN(id) ? parseInt(id) : id;
            const gift = giftsRecords.find(r => r.id === giftId);
            if (!gift) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-gift" style="color: var(--accent-primary);"></i>
                        Gift Details
                    </h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 16px;">
                        <div class="card" style="background: var(--bg-tertiary);">
                            <div class="card-body">
                                <h3 style="margin: 0 0 12px 0; color: var(--text-primary);">${gift.product}</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Quantity</div>
                                        <div style="font-weight: 600;">${gift.quantity}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Value</div>
                                        <div style="font-weight: 600; color: var(--danger);">$${gift.value.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Date</div>
                                        <div style="font-weight: 500;">${new Date(gift.date).toLocaleDateString()}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Store</div>
                                        <div style="font-weight: 500;">${gift.store}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="background: var(--bg-tertiary);">
                            <div class="card-body">
                                <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
                                    <i class="fas fa-user" style="margin-right: 8px;"></i>Recipient
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Name</div>
                                        <div style="font-weight: 600;">${gift.recipient}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Type</div>
                                        <span class="status-badge ${gift.recipientType === 'customer' ? 'active' : gift.recipientType === 'vendor' ? 'warning' : 'inactive'}">
                                            ${gift.recipientType.charAt(0).toUpperCase() + gift.recipientType.slice(1)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="background: var(--bg-tertiary);">
                            <div class="card-body">
                                <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
                                    <i class="fas fa-clipboard-list" style="margin-right: 8px;"></i>Reason
                                </h4>
                                <p style="margin: 0; line-height: 1.6; color: var(--text-secondary);">${gift.reason}</p>
                            </div>
                        </div>

                        ${gift.notes ? `
                            <div class="card" style="background: var(--bg-tertiary);">
                                <div class="card-body">
                                    <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
                                        <i class="fas fa-sticky-note" style="margin-right: 8px;"></i>Notes
                                    </h4>
                                    <p style="margin: 0; line-height: 1.6; color: var(--text-secondary);">${gift.notes}</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn-secondary" style="flex: 1;" onclick="editGift('${String(gift.id).replace(/'/g, "\\'")}'); closeModal();">
                            <i class="fas fa-edit"></i>
                            Edit Gift
                        </button>
                        <button class="btn-secondary" style="flex: 1; background: var(--danger); color: white; border-color: var(--danger);" onclick="closeModal(); deleteGift('${String(gift.id).replace(/'/g, "\\'")}');">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function editGift(id) {
            // Convert to number if it's a numeric string
            const giftId = typeof id === 'string' && !isNaN(id) ? parseInt(id) : id;
            closeModal();
            setTimeout(() => openModal('edit-gift', giftId), 100);
        }

        function deleteGift(id) {
            // Convert to number if it's a numeric string
            const giftId = typeof id === 'string' && !isNaN(id) ? parseInt(id) : id;
            const gift = giftsRecords.find(r => r.id === giftId);
            const productName = gift?.product || 'this gift record';

            showConfirmModal({
                title: 'Delete Gift Record',
                message: `Are you sure you want to delete "${productName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    if (gift) {
                        // Try to delete from Firebase
                        if (gift.firestoreId) {
                            const success = await deleteGiftFromFirebase(gift.firestoreId);
                            if (!success) {
                                console.warn('Failed to delete from Firebase, but deleting locally');
                            }
                        }
                    }
                    giftsRecords = giftsRecords.filter(r => r.id !== giftId);
                    renderGifts();
                }
            });
        }

        async function saveGift(isEdit = false, giftId = null) {
            const product = document.getElementById('gift-product').value.trim();
            const quantity = parseInt(document.getElementById('gift-quantity').value);
            const value = parseFloat(document.getElementById('gift-value').value);
            const recipient = document.getElementById('gift-recipient').value.trim();
            const recipientType = document.getElementById('gift-recipient-type').value;
            const reason = document.getElementById('gift-reason').value.trim();
            const store = document.getElementById('gift-store').value;
            const date = document.getElementById('gift-date').value;
            const notes = document.getElementById('gift-notes').value.trim();
            const photoInput = document.getElementById('gift-photo');

            if (!product) {
                alert('Please enter a product name');
                return;
            }

            try {
                if (isEdit && giftId) {
                    // Convert giftId to number if it's a string
                    const numericGiftId = typeof giftId === 'string' && !isNaN(giftId) ? parseInt(giftId) : giftId;
                    const gift = giftsRecords.find(r => r.id === numericGiftId);
                    if (gift) {
                        const giftData = {
                            product,
                            quantity,
                            value,
                            recipient,
                            recipientType,
                            reason,
                            store,
                            date,
                            notes,
                            photo: gift.photo || null,
                            photoPath: gift.photoPath || null
                        };

                        // Upload photo to Firebase Storage if new one provided
                        if (photoInput && photoInput.files.length > 0) {
                            const rawBase64 = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.readAsDataURL(photoInput.files[0]);
                            });

                            // Initialize storage helper if needed
                            if (!firebaseStorageHelper.isInitialized) {
                                firebaseStorageHelper.initialize();
                            }

                            // Delete old photo from Storage if exists
                            if (gift.photoPath) {
                                try {
                                    await firebaseStorageHelper.deleteFile(gift.photoPath);
                                } catch (err) {
                                    console.error('Error deleting old gift photo from Storage:', err);
                                }
                            }

                            try {
                                const uploadResult = await firebaseStorageHelper.uploadImage(
                                    rawBase64,
                                    'gifts/photos',
                                    gift.firestoreId || numericGiftId.toString()
                                );
                                giftData.photo = uploadResult.url;
                                giftData.photoPath = uploadResult.path;
                            } catch (err) {
                                console.error('Error uploading gift photo to Storage:', err);
                                // Fallback to compressed base64
                                try {
                                    giftData.photo = await compressImage(rawBase64);
                                } catch (compressErr) {
                                    giftData.photo = rawBase64;
                                }
                            }
                        }

                        // Update Firebase if it has a firestoreId
                        if (gift.firestoreId) {
                            giftData.firestoreId = gift.firestoreId;
                            const result = await saveGiftToFirebase(giftData);
                            if (!result) {
                                console.error('Failed to update gift in Firebase');
                            }
                        }

                        gift.product = product;
                        gift.quantity = quantity;
                        gift.value = value;
                        gift.recipient = recipient;
                        gift.recipientType = recipientType;
                        gift.reason = reason;
                        gift.store = store;
                        gift.date = date;
                        gift.notes = notes;
                        gift.photo = giftData.photo;
                        gift.photoPath = giftData.photoPath;
                    } else {
                        alert('Gift record not found');
                        return;
                    }
                } else {
                    // Upload photo to Firebase Storage if provided
                    let photoUrl = null;
                    let photoPath = null;
                    if (photoInput && photoInput.files.length > 0) {
                        const rawBase64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(photoInput.files[0]);
                        });

                        // Initialize storage helper if needed
                        if (!firebaseStorageHelper.isInitialized) {
                            firebaseStorageHelper.initialize();
                        }

                        try {
                            const tempId = Date.now().toString();
                            const uploadResult = await firebaseStorageHelper.uploadImage(
                                rawBase64,
                                'gifts/photos',
                                tempId
                            );
                            photoUrl = uploadResult.url;
                            photoPath = uploadResult.path;
                        } catch (err) {
                            console.error('Error uploading gift photo to Storage:', err);
                            // Fallback to compressed base64
                            try {
                                photoUrl = await compressImage(rawBase64);
                            } catch (compressErr) {
                                photoUrl = rawBase64;
                            }
                        }
                    }

                    const giftData = {
                        product,
                        quantity,
                        value,
                        recipient,
                        recipientType,
                        reason,
                        store,
                        date,
                        notes,
                        photo: photoUrl,       // Now stores URL instead of base64
                        photoPath: photoPath   // For future deletion
                    };

                    // Save to Firebase
                    const firestoreId = await saveGiftToFirebase(giftData);

                    const newGift = {
                        id: Math.max(0, ...giftsRecords.map(r => r.id)) + 1,
                        firestoreId: firestoreId || undefined,
                        ...giftData
                    };
                    giftsRecords.unshift(newGift);
                }

                closeModal();
                renderGifts();
            } catch (error) {
                console.error('Error saving gift:', error);
                alert('Error saving gift. Please try again.');
            }
        }

        // Cash Out Functions
        function renderCashOut() {
            const dashboard = document.querySelector('.dashboard');

            // Filter by store first
            let filteredRecords = [...cashOutRecords];
            if (currentCashOutStoreFilter !== 'all') {
                filteredRecords = cashOutRecords.filter(r => r.store === currentCashOutStoreFilter);
            }

            // Calculate monthly total (from filtered records)
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthlyRecords = filteredRecords.filter(r => {
                const date = new Date(r.createdDate);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            const monthlyTotal = monthlyRecords.reduce((sum, r) => sum + r.amount, 0);
            const monthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Expenses Control</h2>
                        <p class="section-subtitle">Track and manage store expenses</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('create-cashout')">
                        <i class="fas fa-plus"></i>
                        Add Expense
                    </button>
                </div>

                <!-- Monthly Total Card -->
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border-radius: 16px; padding: 30px 40px; margin-bottom: 24px; position: relative; overflow: hidden;">
                    <div style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); width: 180px; height: 180px; border-radius: 50%; background: rgba(255,255,255,0.1);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 12px; font-weight: 600; letter-spacing: 1px; margin-bottom: 8px;">
                            ${monthName} ${currentCashOutStoreFilter !== 'all' ? `路 ${currentCashOutStoreFilter}` : ''}
                        </div>
                        <div style="color: white; font-size: 42px; font-weight: 700; margin-bottom: 4px;">$${monthlyTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 14px;">${monthlyRecords.length} expense${monthlyRecords.length !== 1 ? 's' : ''} this month</div>
                    </div>
                </div>

                <!-- Store Filter -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-store" style="color: var(--text-muted);"></i>
                                <span style="font-weight: 500; color: var(--text-secondary);">Filter by Store:</span>
                            </div>
                            <select id="cashout-store-filter" class="form-input" onchange="filterCashOutByStore(this.value)" style="width: 220px;">
                                <option value="all" ${currentCashOutStoreFilter === 'all' ? 'selected' : ''}>All Stores</option>
                                <option value="Miramar" ${currentCashOutStoreFilter === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                <option value="Morena" ${currentCashOutStoreFilter === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                <option value="Kearny Mesa" ${currentCashOutStoreFilter === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                <option value="Chula Vista" ${currentCashOutStoreFilter === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                <option value="North Park" ${currentCashOutStoreFilter === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                <option value="Miramar Wine & Liquor" ${currentCashOutStoreFilter === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                            </select>
                            ${currentCashOutStoreFilter !== 'all' ? `
                                <button onclick="filterCashOutByStore('all')" class="btn-secondary" style="padding: 8px 12px;">
                                    <i class="fas fa-times"></i> Clear Filter
                                </button>
                                <span style="margin-left: auto; font-size: 13px; color: var(--text-muted);">
                                    Showing ${filteredRecords.length} of ${cashOutRecords.length} records
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Charts Card -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header" style="cursor: pointer; user-select: none;" onclick="toggleCashOutExpenseAnalysis()">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <i class="fas fa-chart-line"></i>
                            <h3 class="card-title" style="margin: 0;">Expense Analysis</h3>
                            <i class="fas fa-chevron-down" style="transition: transform 0.3s ease; transform: ${cashOutViewState.expenseAnalysisExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}; margin-left: auto;"></i>
                        </div>
                    </div>

                    ${cashOutViewState.expenseAnalysisExpanded ? `
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                            <!-- View Toggle Buttons -->
                            <button class="cashout-filter-btn ${cashOutViewState.viewType === 'week' ? 'active' : ''}"
                                    onclick="switchCashOutView('week')"
                                    id="cashout-week-btn">
                                <i class="fas fa-calendar-week"></i> Week
                            </button>
                            <button class="cashout-filter-btn ${cashOutViewState.viewType === 'month' ? 'active' : ''}"
                                    onclick="switchCashOutView('month')"
                                    id="cashout-month-btn">
                                <i class="fas fa-calendar"></i> Month
                            </button>
                        </div>

                        ${cashOutRecords.length === 0 ? `
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                                <p>No expense data available yet</p>
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <!-- Daily/Weekly Expenses Chart -->
                                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                                        ${cashOutViewState.viewType === 'week' ? 'Daily Expenses This Week' : 'Daily Expenses This Month'}
                                    </div>
                                    <canvas id="cashout-daily-chart" style="max-height: 200px;"></canvas>
                                </div>

                                <!-- Store Breakdown Chart -->
                                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                                        Expenses by Store
                                    </div>
                                    <canvas id="cashout-store-chart" style="max-height: 200px;"></canvas>
                                </div>
                            </div>

                            <!-- Trend Chart (Full Width) -->
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                                    Expense Trend
                                </div>
                                <canvas id="cashout-trend-chart" style="max-height: 250px;"></canvas>
                            </div>
                        `}
                    </div>
                    ` : ''}
                </div>

                <!-- Data Table Card -->
                <div class="card">
                    <div class="card-body" style="padding: 0;">
                        ${filteredRecords.length === 0 ? `
                            <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                                <i class="fas fa-money-bill-wave" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                <h3 style="margin-bottom: 8px; color: var(--text-secondary);">No Cash Outs Yet</h3>
                                <p>Click "Add Cash Out" to create a new record</p>
                            </div>
                        ` : `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Store</th>
                                        <th>Created By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredRecords.map(record => {
                                        const recordId = record.firestoreId || record.id;
                                        return `
                                        <tr>
                                            <td>${formatDate(record.createdDate)}</td>
                                            <td>
                                                <strong>${record.name}</strong>
                                                ${record.reason ? `<div style="font-size: 12px; color: var(--text-muted);">${record.reason}</div>` : ''}
                                            </td>
                                            <td style="font-weight: 600; color: var(--danger);">
                                                $${record.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                            </td>
                                            <td><span class="status-badge">${record.store || 'N/A'}</span></td>
                                            <td>${record.createdBy}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn-icon" onclick="viewCashOutDetails('${recordId}')" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn-icon btn-danger" onclick="deleteCashOut('${recordId}')" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;

            // Initialize charts after DOM is rendered
            setTimeout(() => initializeCashOutCharts(), 100);
        }

        // Filter cash out by store
        function filterCashOutByStore(store) {
            currentCashOutStoreFilter = store;
            renderCashOut();
        }

        // Switch cash out view between week and month
        function switchCashOutView(viewType) {
            cashOutViewState.viewType = viewType;
            renderCashOut();
        }

        // Toggle expense analysis expansion
        function toggleCashOutExpenseAnalysis() {
            cashOutViewState.expenseAnalysisExpanded = !cashOutViewState.expenseAnalysisExpanded;
            renderCashOut();
            
            // Initialize charts after expansion if needed
            if (cashOutViewState.expenseAnalysisExpanded) {
                setTimeout(() => initializeCashOutCharts(), 100);
            }
        }

        // Get date range based on view type
        function getCashOutDateRange() {
            const now = new Date();
            let startDate, endDate = new Date(now);

            if (cashOutViewState.viewType === 'week') {
                // Get start of current week (Sunday)
                const day = now.getDay();
                startDate = new Date(now);
                startDate.setDate(now.getDate() - day);
                startDate.setHours(0, 0, 0, 0);
            } else {
                // Get start of current month
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            }

            endDate.setHours(23, 59, 59, 999);
            return { startDate, endDate };
        }

        // Initialize cashout charts
        function initializeCashOutCharts() {
            // Destroy existing charts
            Object.values(cashOutCharts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Apply store filter
            let filtered = cashOutRecords;
            if (currentCashOutStoreFilter !== 'all') {
                filtered = cashOutRecords.filter(r => r.store === currentCashOutStoreFilter);
            }

            if (filtered.length === 0) return;

            const { startDate, endDate } = getCashOutDateRange();

            // Filter records by date range
            const rangeFiltered = filtered.filter(r => {
                const recordDate = new Date(r.createdDate);
                return recordDate >= startDate && recordDate <= endDate;
            });

            // 1. Daily Expenses Chart
            initializeDailyExpensesChart(rangeFiltered);

            // 2. Store Breakdown Chart (use all records for store breakdown, but respect store filter)
            initializeStoreBreakdownChart(filtered);

            // 3. Trend Chart
            initializeTrendChart(filtered);
        }

        // Daily expenses bar chart
        function initializeDailyExpensesChart(records) {
            const dailyCtx = document.getElementById('cashout-daily-chart');
            if (!dailyCtx) return;

            // Group by day
            const dailyData = {};
            records.forEach(r => {
                const dateStr = new Date(r.createdDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dailyData[dateStr] = (dailyData[dateStr] || 0) + r.amount;
            });

            const labels = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
            const data = labels.map(label => dailyData[label]);

            cashOutCharts.dailyChart = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Amount ($)',
                        data: data,
                        backgroundColor: '#8b5cf6',
                        borderColor: '#7c3aed',
                        borderWidth: 1,
                        borderRadius: 6,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            }
                        }
                    }
                }
            });
        }

        // Store breakdown pie chart
        function initializeStoreBreakdownChart(records) {
            const storeCtx = document.getElementById('cashout-store-chart');
            if (!storeCtx) return;

            // Group by store
            const storeData = {};
            records.forEach(r => {
                const store = r.store || 'Unknown';
                storeData[store] = (storeData[store] || 0) + r.amount;
            });

            const labels = Object.keys(storeData);
            const data = Object.values(storeData);

            // Color palette
            const colors = ['#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#06b6d4'];

            cashOutCharts.storeChart = new Chart(storeCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 12,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Trend line chart (last 30 days)
        function initializeTrendChart(records) {
            const trendCtx = document.getElementById('cashout-trend-chart');
            if (!trendCtx) return;

            // Get last 30 days
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            const trendData = {};
            for (let i = 29; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                trendData[dateStr] = 0;
            }

            records.forEach(r => {
                const recordDate = new Date(r.createdDate);
                if (recordDate >= thirtyDaysAgo) {
                    const dateStr = recordDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    if (trendData.hasOwnProperty(dateStr)) {
                        trendData[dateStr] += r.amount;
                    }
                }
            });

            const labels = Object.keys(trendData);
            const data = Object.values(trendData);

            // Calculate cumulative sum
            let cumulative = 0;
            const cumulativeData = data.map(val => cumulative += val);

            cashOutCharts.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Total ($)',
                        data: cumulativeData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            }
                        }
                    }
                }
            });
        }

        async function deleteCashOut(id) {
            showConfirmModal({
                title: 'Delete Cash Out',
                message: 'Are you sure you want to delete this cash out record? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        // Delete from Firebase
                        if (typeof firebaseCashOutManager !== 'undefined' && firebaseCashOutManager.isInitialized) {
                            const success = await firebaseCashOutManager.deleteCashOutRecord(id);
                            if (success) {
                                cashOutRecords = cashOutRecords.filter(r => r.id !== id && r.firestoreId !== id);
                                renderCashOut();
                                showNotification('Cash out deleted', 'success');
                            } else {
                                showNotification('Error deleting from Firebase', 'error');
                            }
                        } else {
                            // Fallback to local deletion
                            cashOutRecords = cashOutRecords.filter(r => r.id !== id && r.firestoreId !== id);
                            renderCashOut();
                            showNotification('Cash out deleted', 'success');
                        }
                    } catch (error) {
                        console.error('Error deleting cash out:', error);
                        showNotification('Error deleting cash out', 'error');
                    }
                }
            });
        }

        async function createCashOut() {
            const name = document.getElementById('cashout-name').value.trim();
            const amount = parseFloat(document.getElementById('cashout-amount').value);
            const store = document.getElementById('cashout-store').value;
            const date = document.getElementById('cashout-date').value;
            const reason = document.getElementById('cashout-reason').value.trim();

            if (!name || !amount || !store) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be greater than zero', 'error');
                return;
            }

            // Get current user
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

            const newRecord = {
                name,
                amount,
                store,
                reason,
                createdDate: date || new Date().toISOString().split('T')[0],
                createdBy: user?.name || 'Unknown',
                status: 'open',
                closedDate: null,
                receiptPhoto: null,
                amountSpent: null,
                moneyLeft: null,
                hasMoneyLeft: null
            };

            try {
                // Save to Firebase
                if (typeof firebaseCashOutManager !== 'undefined' && firebaseCashOutManager.isInitialized) {
                    const docId = await firebaseCashOutManager.addCashOutRecord(newRecord);
                    if (docId) {
                        newRecord.id = docId;
                        newRecord.firestoreId = docId;
                        cashOutRecords.unshift(newRecord);
                        closeModal();
                        renderCashOut();
                        showNotification('Cash out added!', 'success');
                    } else {
                        showNotification('Error saving to Firebase', 'error');
                    }
                } else {
                    // Fallback to local storage
                    newRecord.id = cashOutRecords.length > 0 ? Math.max(...cashOutRecords.map(r => r.id || 0)) + 1 : 1;
                    cashOutRecords.unshift(newRecord);
                    closeModal();
                    renderCashOut();
                    showNotification('Cash out added!', 'success');
                }
            } catch (error) {
                console.error('Error creating cash out:', error);
                showNotification('Error creating cash out', 'error');
            }
        }

        async function closeCashOut(recordId) {
            const amountSpent = parseFloat(document.getElementById('cashout-amount-spent').value);
            const hasMoneyLeft = document.getElementById('cashout-money-left-yes').checked;
            const receiptInput = document.getElementById('cashout-receipt-photo');

            if (isNaN(amountSpent)) {
                showNotification('Please enter the amount spent', 'error');
                return;
            }

            const record = cashOutRecords.find(r => r.id === recordId || r.firestoreId === recordId);
            if (!record) return;

            // Check if amount exceeds and show warning modal
            if (amountSpent > record.amount) {
                showConfirmModal({
                    title: 'Amount Exceeds Original',
                    message: `Amount spent ($${amountSpent.toFixed(2)}) exceeds the original amount ($${record.amount.toFixed(2)}). Are you sure you want to continue?`,
                    confirmText: 'Continue',
                    type: 'warning',
                    onConfirm: () => {
                        processCloseCashOut(recordId, amountSpent, hasMoneyLeft, receiptInput, record);
                    }
                });
                return;
            }

            processCloseCashOut(recordId, amountSpent, hasMoneyLeft, receiptInput, record);
        }

        async function processCloseCashOut(recordId, amountSpent, hasMoneyLeft, receiptInput, record) {

            // Upload receipt to Firebase Storage if provided
            let receiptUrl = null;
            let receiptPath = null;
            if (receiptInput && receiptInput.files && receiptInput.files[0]) {
                const rawBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(receiptInput.files[0]);
                });

                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                try {
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        rawBase64,
                        'cashout/receipts',
                        recordId.toString()
                    );
                    receiptUrl = uploadResult.url;
                    receiptPath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading cash out receipt to Storage:', err);
                    // Fallback to compressed base64
                    try {
                        receiptUrl = await compressImage(rawBase64);
                    } catch (compressErr) {
                        console.error('Error compressing receipt image:', compressErr);
                        receiptUrl = rawBase64;
                    }
                }
            }

            const updateData = {
                status: 'closed',
                closedDate: new Date().toISOString().split('T')[0],
                amountSpent: amountSpent,
                moneyLeft: record.amount - amountSpent,
                hasMoneyLeft: hasMoneyLeft,
                receiptPhoto: receiptUrl,     // Now stores URL instead of base64
                receiptPath: receiptPath      // For future deletion
            };

            try {
                // Update in Firebase
                const firestoreId = record.firestoreId || record.id;
                if (typeof firebaseCashOutManager !== 'undefined' && firebaseCashOutManager.isInitialized) {
                    const success = await firebaseCashOutManager.updateCashOutRecord(firestoreId, updateData);
                    if (success) {
                        // Update local record
                        Object.assign(record, updateData);
                        closeModal();
                        renderCashOut();
                        showNotification('Cash out closed successfully', 'success');
                    } else {
                        showNotification('Error updating in Firebase', 'error');
                    }
                } else {
                    // Fallback to local update
                    Object.assign(record, updateData);
                    closeModal();
                    renderCashOut();
                    showNotification('Cash out closed successfully', 'success');
                }
            } catch (error) {
                console.error('Error closing cash out:', error);
                showNotification('Error closing cash out', 'error');
            }
        }

        function viewCashOutDetails(recordId) {
            console.log('viewCashOutDetails called with:', recordId);
            console.log('cashOutRecords:', cashOutRecords);

            const record = cashOutRecords.find(r => r.id === recordId || r.firestoreId === recordId || String(r.id) === String(recordId) || String(r.firestoreId) === String(recordId));

            console.log('Found record:', record);

            if (!record) {
                console.error('Record not found for ID:', recordId);
                showNotification('Record not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            if (!modal || !modalContent) {
                console.error('Modal elements not found');
                return;
            }

            const receiptDisplay = record.receiptPhoto
                ? `<img src="${record.receiptPhoto}" style="width: 100%; max-width: 400px; border-radius: 8px; margin-top: 8px;" alt="Receipt">`
                : '<div style="color: var(--text-muted); font-style: italic;">No receipt uploaded</div>';

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-info-circle"></i> Cash Out Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Cash Out Name</div>
                                <div style="font-size: 18px; font-weight: 600;">${record.name}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Store</div>
                                <span class="badge" style="background: var(--accent-primary);">
                                    <i class="fas fa-store"></i> ${record.store || 'N/A'}
                                </span>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Created By</div>
                                <div style="font-weight: 500;">${record.createdBy}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Created Date</div>
                                <div style="font-weight: 500;">${formatDate(record.createdDate)}</div>
                            </div>
                        </div>

                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Reason</div>
                            <div style="font-size: 14px;">${record.reason || 'No reason provided'}</div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Amount Given</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-primary);">
                                    $${record.amount ? record.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Status</div>
                                <span class="badge" style="background: ${record.status === 'open' ? 'var(--warning)' : 'var(--success)'}; font-size: 14px; padding: 8px 16px;">
                                    ${record.status === 'open' ? 'Open' : 'Closed'}
                                </span>
                            </div>
                        </div>

                        ${record.status === 'closed' ? `
                            <div style="border-top: 2px solid var(--border-color); padding-top: 16px; margin-top: 8px;">
                                <h3 style="font-size: 16px; margin-bottom: 16px;">Closure Details</h3>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Amount Spent</div>
                                        <div style="font-size: 20px; font-weight: 700; color: var(--danger);">
                                            $${(record.amountSpent || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                        </div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Money Left</div>
                                        <div style="font-size: 20px; font-weight: 700; color: ${record.hasMoneyLeft ? 'var(--success)' : 'var(--text-muted)'};">
                                            $${(record.moneyLeft || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                        </div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Closed Date</div>
                                        <div style="font-size: 14px; font-weight: 600;">
                                            ${formatDate(record.closedDate)}
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Receipt Photo</div>
                                    ${receiptDisplay}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    ${record.status === 'open' ? `
                        <button class="btn-primary" onclick="closeModal(); setTimeout(() => openModal('close-cashout', '${record.firestoreId || record.id}'), 100);">
                            <i class="fas fa-check"></i> Close Cash Out
                        </button>
                    ` : ''}
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Issues Functions
        // Issue status configuration
        const issueStatusConfig = {
            'open': { label: 'Open', icon: 'fa-circle-exclamation', color: '#ef4444', bg: '#ef444420' },
            'follow-up': { label: 'Need Follow Up', icon: 'fa-clock', color: '#f59e0b', bg: '#f59e0b20' },
            'resolved': { label: 'Resolved', icon: 'fa-circle-check', color: '#10b981', bg: '#10b98120' }
        };

        // Current filter for issues
        let currentIssueStatusFilter = 'all';
        let currentIssueStoreFilter = 'all';

        function renderIssues() {
            const dashboard = document.querySelector('.dashboard');

            // Filter issues based on store filter first (for accurate counts)
            let storeFilteredIssues = [...issues];
            if (currentIssueStoreFilter !== 'all') {
                storeFilteredIssues = issues.filter(i => i.store === currentIssueStoreFilter);
            }

            // Count issues by status (after store filter)
            const openCount = storeFilteredIssues.filter(i => !i.status || i.status === 'open').length;
            const followUpCount = storeFilteredIssues.filter(i => i.status === 'follow-up').length;
            const resolvedCount = storeFilteredIssues.filter(i => i.status === 'resolved').length;

            // Filter issues based on status filter
            let filteredIssues = [...storeFilteredIssues];
            if (currentIssueStatusFilter !== 'all') {
                if (currentIssueStatusFilter === 'open') {
                    filteredIssues = storeFilteredIssues.filter(i => !i.status || i.status === 'open');
                } else {
                    filteredIssues = storeFilteredIssues.filter(i => i.status === currentIssueStatusFilter);
                }
            }

            // Sort issues by date, most recent first
            const sortedIssues = filteredIssues.sort((a, b) => new Date(b.incidentDate) - new Date(a.incidentDate));

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Issues Registry</h2>
                        <p class="section-subtitle">Customer incident documentation & follow-up tracking</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('create-issue')">
                        <i class="fas fa-plus"></i>
                        New Issue
                    </button>
                </div>

                <!-- Status Summary Cards -->
                <div class="issues-status-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="card" onclick="filterIssuesByStatus('open')" style="cursor: pointer; transition: all 0.2s; ${currentIssueStatusFilter === 'open' ? 'border: 2px solid #ef4444;' : ''}">
                        <div class="card-body" style="padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="width: 50px; height: 50px; background: #ef444420; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-circle-exclamation" style="font-size: 24px; color: #ef4444;"></i>
                            </div>
                            <div>
                                <div style="font-size: 28px; font-weight: 700; color: #ef4444;">${openCount}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Open</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" onclick="filterIssuesByStatus('follow-up')" style="cursor: pointer; transition: all 0.2s; ${currentIssueStatusFilter === 'follow-up' ? 'border: 2px solid #f59e0b;' : ''}">
                        <div class="card-body" style="padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="width: 50px; height: 50px; background: #f59e0b20; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-clock" style="font-size: 24px; color: #f59e0b;"></i>
                            </div>
                            <div>
                                <div style="font-size: 28px; font-weight: 700; color: #f59e0b;">${followUpCount}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Need Follow Up</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" onclick="filterIssuesByStatus('resolved')" style="cursor: pointer; transition: all 0.2s; ${currentIssueStatusFilter === 'resolved' ? 'border: 2px solid #10b981;' : ''}">
                        <div class="card-body" style="padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="width: 50px; height: 50px; background: #10b98120; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-circle-check" style="font-size: 24px; color: #10b981;"></i>
                            </div>
                            <div>
                                <div style="font-size: 28px; font-weight: 700; color: #10b981;">${resolvedCount}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Resolved</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" onclick="filterIssuesByStatus('all')" style="cursor: pointer; transition: all 0.2s; ${currentIssueStatusFilter === 'all' ? 'border: 2px solid var(--accent-primary);' : ''}">
                        <div class="card-body" style="padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-primary)20; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-list" style="font-size: 24px; color: var(--accent-primary);"></i>
                            </div>
                            <div>
                                <div style="font-size: 28px; font-weight: 700; color: var(--accent-primary);">${storeFilteredIssues.length}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">All Issues</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Perception Chart -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header issues-card-header" style="flex-wrap: wrap; gap: 12px;">
                        <div>
                            <h3 class="card-title">
                                <i class="fas fa-smile"></i>
                                Customer Perception
                            </h3>
                            <span style="font-size: 13px; color: var(--text-muted);">How customers felt when leaving</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                            <select id="issue-store-filter" class="form-input" onchange="filterIssuesByStore(this.value)" style="width: 200px; padding: 8px 12px; font-size: 13px;">
                                <option value="all" ${currentIssueStoreFilter === 'all' ? 'selected' : ''}>All Stores</option>
                                <option value="Miramar" ${currentIssueStoreFilter === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                <option value="Morena" ${currentIssueStoreFilter === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                <option value="Kearny Mesa" ${currentIssueStoreFilter === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                <option value="Chula Vista" ${currentIssueStoreFilter === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                <option value="North Park" ${currentIssueStoreFilter === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                <option value="Miramar Wine & Liquor" ${currentIssueStoreFilter === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body issues-perception-chart">
                        ${renderPerceptionGanttChart()}
                    </div>
                </div>

                <!-- All Issues List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i>
                            ${currentIssueStatusFilter === 'all' ? 'All Issues' : issueStatusConfig[currentIssueStatusFilter]?.label || 'Issues'}
                        </h3>
                        <span class="badge" style="background: var(--accent-primary);">${sortedIssues.length} ${sortedIssues.length === 1 ? 'Issue' : 'Issues'}</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        ${sortedIssues.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                No issues ${currentIssueStatusFilter !== 'all' ? 'with this status' : 'recorded yet'}
                            </div>
                        ` : `
                            <table class="data-table issues-table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Store</th>
                                        <th>Customer</th>
                                        <th>Phone</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Perception</th>
                                        <th style="width: 180px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedIssues.map(issue => {
                                        const status = issue.status || 'open';
                                        const statusConfig = issueStatusConfig[status];
                                        return `
                                        <tr>
                                            <td data-label="Status">
                                                <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: ${statusConfig.bg}; color: ${statusConfig.color}; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                                    <i class="fas ${statusConfig.icon}"></i>
                                                    ${statusConfig.label}
                                                </span>
                                            </td>
                                            <td data-label="Date" style="white-space: nowrap;">${formatDate(issue.incidentDate)}</td>
                                            <td data-label="Store">
                                                ${issue.store ? `
                                                    <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-secondary);">
                                                        <i class="fas fa-store" style="color: var(--accent-primary);"></i>
                                                        ${issue.store}
                                                    </span>
                                                ` : '<span style="color: var(--text-muted);">-</span>'}
                                            </td>
                                            <td data-label="Customer"><strong>${issue.customer}</strong></td>
                                            <td data-label="Phone">
                                                ${issue.phone ? `<a href="tel:${issue.phone}" style="color: var(--accent-primary); text-decoration: none;"><i class="fas fa-phone"></i> ${issue.phone}</a>` : '-'}
                                            </td>
                                            <td data-label="Type">
                                                <span class="badge" style="background: ${issue.type === 'In Store' ? 'var(--accent-primary)' : 'var(--info)'};">
                                                    <i class="fas fa-${issue.type === 'In Store' ? 'store' : 'globe'}"></i>
                                                    ${issue.type}
                                                </span>
                                            </td>
                                            <td data-label="Description" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${issue.description || '-'}</td>
                                            <td data-label="Perception" style="text-align: center; font-size: 24px;">
                                                ${issue.perception ? getPerceptionEmoji(issue.perception) : '-'}
                                            </td>
                                            <td data-label="Actions">
                                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                                    ${status !== 'follow-up' ? `
                                                        <button class="btn-icon" onclick="updateIssueStatus('${issue.firestoreId || issue.id}', 'follow-up')" title="Mark as Need Follow Up" style="background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b50;">
                                                            <i class="fas fa-clock"></i>
                                                        </button>
                                                    ` : ''}
                                                    ${status !== 'resolved' ? `
                                                        <button class="btn-icon" onclick="updateIssueStatus('${issue.firestoreId || issue.id}', 'resolved')" title="Mark as Resolved" style="background: #10b98120; color: #10b981; border: 1px solid #10b98150;">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    ` : ''}
                                                    ${status !== 'open' ? `
                                                        <button class="btn-icon" onclick="updateIssueStatus('${issue.firestoreId || issue.id}', 'open')" title="Reopen Issue" style="background: #ef444420; color: #ef4444; border: 1px solid #ef444450;">
                                                            <i class="fas fa-rotate-left"></i>
                                                        </button>
                                                    ` : ''}
                                                    <button class="btn-icon" onclick="viewIssueDetails('${issue.firestoreId || issue.id}')" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn-icon danger" onclick="deleteIssue('${issue.firestoreId || issue.id}')" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;

            // Update sidebar badge
            updateIssuesSidebarBadge();
        }

        // Filter issues by status
        function filterIssuesByStatus(status) {
            currentIssueStatusFilter = status;
            renderIssues();
        }

        // Filter issues by store
        function filterIssuesByStore(store) {
            currentIssueStoreFilter = store;
            renderIssues();
        }

        // Update issue status
        async function updateIssueStatus(issueId, newStatus) {
            const issue = issues.find(i => i.firestoreId === issueId || i.id === issueId);
            if (!issue) return;

            try {
                // Update locally
                issue.status = newStatus;
                if (!issue.statusHistory) issue.statusHistory = [];
                issue.statusHistory.push({
                    status: newStatus,
                    timestamp: new Date().toISOString(),
                    updatedBy: getCurrentUser()?.name || 'Unknown'
                });

                // Update in Firebase
                if (firebaseIssuesManager && firebaseIssuesManager.isInitialized && issue.firestoreId) {
                    await firebaseIssuesManager.updateIssue(issue.firestoreId, {
                        status: newStatus,
                        statusHistory: issue.statusHistory
                    });
                }

                renderIssues();

                const statusLabel = issueStatusConfig[newStatus]?.label || newStatus;
                showIssueToast(`Issue marked as "${statusLabel}"`, 'success');
            } catch (error) {
                console.error('Error updating issue status:', error);
                showIssueToast('Error updating status', 'error');
            }
        }

        // Update sidebar badge for issues needing follow up
        function updateIssuesSidebarBadge() {
            const followUpCount = issues.filter(i => i.status === 'follow-up').length;
            const openCount = issues.filter(i => !i.status || i.status === 'open').length;
            const totalPending = followUpCount + openCount;

            // Find the issues nav item
            const issuesNavItem = document.querySelector('.nav-item[data-page="issues"]');
            if (issuesNavItem) {
                // Remove existing badge
                const existingBadge = issuesNavItem.querySelector('.issues-badge');
                if (existingBadge) existingBadge.remove();

                // Add badge if there are pending issues
                if (totalPending > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'issues-badge';
                    badge.style.cssText = `
                        position: absolute;
                        right: 8px;
                        background: ${followUpCount > 0 ? '#f59e0b' : '#ef4444'};
                        color: white;
                        font-size: 11px;
                        font-weight: 700;
                        padding: 2px 6px;
                        border-radius: 10px;
                        min-width: 18px;
                        text-align: center;
                    `;
                    badge.textContent = totalPending;
                    issuesNavItem.style.position = 'relative';
                    issuesNavItem.appendChild(badge);
                }
            }
        }

        // Toast notification for issues
        function showIssueToast(message, type = 'info') {
            let toastContainer = document.getElementById('issue-toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'issue-toast-container';
                toastContainer.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            const colors = { success: '#10b981', error: '#ef4444', warning: '#f59e0b', info: '#3b82f6' };
            toast.style.cssText = `
                padding: 14px 20px;
                background: ${colors[type] || colors.info};
                color: white;
                border-radius: 10px;
                font-weight: 500;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                animation: issueSlideIn 0.3s ease;
            `;
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i> ${message}`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'issueSlideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add CSS for issue toast animations
        const issueToastStyles = document.createElement('style');
        issueToastStyles.textContent = `
            @keyframes issueSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
            @keyframes issueSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        `;
        document.head.appendChild(issueToastStyles);

        function selectPerception(value) {
            // Update hidden input
            document.getElementById('issue-perception').value = value;

            // Update button styles
            const buttons = document.querySelectorAll('.perception-btn');
            buttons.forEach(btn => {
                const btnValue = parseInt(btn.dataset.value);
                if (btnValue === value) {
                    btn.style.borderColor = 'var(--accent-primary)';
                    btn.style.background = 'rgba(99, 102, 241, 0.1)';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'var(--bg-secondary)';
                    btn.style.transform = 'scale(1)';
                }
            });
        }

        function getPerceptionEmoji(value) {
            const emojis = {
                1: '',
                2: '',
                3: '',
                4: '',
                5: ''
            };
            return emojis[value] || '';
        }

        function getPerceptionLabel(value) {
            const labels = {
                1: 'Very Upset',
                2: 'Upset',
                3: 'Neutral',
                4: 'Satisfied',
                5: 'Happy'
            };
            return labels[value] || 'Unknown';
        }

        function getPerceptionColor(value) {
            const colors = {
                1: '#ef4444',
                2: '#f97316',
                3: '#eab308',
                4: '#22c55e',
                5: '#10b981'
            };
            return colors[value] || '#6b7280';
        }

        function renderPerceptionGanttChart() {
            // Get issues with perception data, filtered by store
            let issuesWithPerception = issues
                .filter(i => i.perception !== null && i.perception !== undefined);

            // Apply store filter
            if (currentIssueStoreFilter !== 'all') {
                issuesWithPerception = issuesWithPerception.filter(i => i.store === currentIssueStoreFilter);
            }

            // Determine the store label for display
            const storeLabel = currentIssueStoreFilter === 'all' ? 'All Stores' : `VSU ${currentIssueStoreFilter}`;

            if (issuesWithPerception.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                        <p>No perception data recorded yet</p>
                        <p style="font-size: 13px;">Create issues with customer perception to see the chart</p>
                    </div>
                `;
            }

            // Calculate perception distribution for filtered issues
            const perceptionCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            let totalSum = 0;
            issuesWithPerception.forEach(i => {
                if (perceptionCounts[i.perception] !== undefined) {
                    perceptionCounts[i.perception]++;
                    totalSum += i.perception;
                }
            });

            const total = issuesWithPerception.length;
            const average = total > 0 ? (totalSum / total) : 0;
            const averageRounded = Math.round(average * 10) / 10; // Round to 1 decimal
            const averageColor = getPerceptionColor(Math.round(average));
            const averageEmoji = getPerceptionEmoji(Math.round(average));
            const averagePercentage = (average / 5) * 100;

            return `
                <!-- Average Score Display -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 24px; margin-bottom: 24px; padding: 24px; background: linear-gradient(135deg, ${averageColor}15, ${averageColor}08); border: 2px solid ${averageColor}40; border-radius: 16px;">
                    <div style="text-align: center;">
                        <div style="font-size: 64px; line-height: 1;">${averageEmoji}</div>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;">Average Score for ${storeLabel}</div>
                        <div style="font-size: 48px; font-weight: 800; color: ${averageColor}; line-height: 1;">${averageRounded}</div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">out of 5.0 路 ${total} interactions</div>
                    </div>
                    <div style="flex: 1; max-width: 300px;">
                        <div style="background: var(--bg-tertiary); border-radius: 12px; height: 24px; overflow: hidden; position: relative;">
                            <div style="width: ${averagePercentage}%; height: 100%; background: linear-gradient(90deg, ${averageColor}88, ${averageColor}); border-radius: 12px; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: var(--text-muted);">
                            <span>1.0</span>
                            <span>5.0</span>
                        </div>
                    </div>
                </div>

                <!-- Perception Distribution -->
                <div style="margin-bottom: 16px;">
                    <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">
                        <i class="fas fa-chart-pie"></i> Perception Distribution
                    </h4>
                </div>

                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;">
                    ${[1, 2, 3, 4, 5].map(level => {
                        const count = perceptionCounts[level];
                        const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                        const barHeight = total > 0 ? Math.max((count / Math.max(...Object.values(perceptionCounts))) * 100, 5) : 5;
                        return `
                            <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size: 32px; margin-bottom: 8px;">${getPerceptionEmoji(level)}</div>
                                <div style="height: 60px; display: flex; align-items: flex-end; justify-content: center; margin-bottom: 8px;">
                                    <div style="width: 40px; height: ${barHeight}%; background: ${getPerceptionColor(level)}; border-radius: 6px 6px 0 0; min-height: 4px;"></div>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; color: ${getPerceptionColor(level)};">${count}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${percentage}%</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${getPerceptionLabel(level)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <!-- Perception Scale Legend -->
                <div style="padding-top: 16px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: center; gap: 24px; font-size: 12px; color: var(--text-muted);">
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 3px; margin-right: 4px;"></span> Very Upset</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #f97316; border-radius: 3px; margin-right: 4px;"></span> Upset</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #eab308; border-radius: 3px; margin-right: 4px;"></span> Neutral</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #22c55e; border-radius: 3px; margin-right: 4px;"></span> Satisfied</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 3px; margin-right: 4px;"></span> Happy</span>
                    </div>
                </div>
            `;
        }

        async function createIssue() {
            const customer = document.getElementById('issue-customer').value.trim();
            const phone = document.getElementById('issue-phone').value.trim();
            const type = document.getElementById('issue-type').value;
            const store = document.getElementById('issue-store').value;
            const description = document.getElementById('issue-description').value.trim();
            const incidentDate = document.getElementById('issue-incident-date').value;
            const perception = document.getElementById('issue-perception').value;

            // Get current user
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

            const newIssue = {
                customer: customer || 'Anonymous',
                phone: phone || '',
                type: type || 'In Store',
                store: store || '',
                description: description || '',
                incidentDate: incidentDate || new Date().toISOString().split('T')[0],
                perception: perception ? parseInt(perception) : null,
                status: 'open',
                createdBy: user?.name || 'Unknown',
                createdDate: new Date().toISOString().split('T')[0],
                solution: null,
                resolvedBy: null,
                resolutionDate: null
            };

            // Try to save to Firebase
            if (typeof firebaseIssuesManager !== 'undefined' && firebaseIssuesManager.isInitialized) {
                const firestoreId = await firebaseIssuesManager.addIssue(newIssue);
                if (firestoreId) {
                    newIssue.id = firestoreId;
                    newIssue.firestoreId = firestoreId;
                    issues.unshift(newIssue);
                    closeModal();
                    renderIssues();
                    return;
                }
            }

            // Fallback to local storage
            newIssue.id = issues.length > 0 ? Math.max(...issues.map(i => typeof i.id === 'number' ? i.id : 0)) + 1 : 1;
            issues.unshift(newIssue);
            closeModal();
            renderIssues();
        }

        function deleteIssue(issueId) {
            const issue = issues.find(i => i.firestoreId === issueId || i.id === issueId);
            const customerName = issue?.customer || 'this issue';

            showConfirmModal({
                title: 'Delete Issue',
                message: `Are you sure you want to delete the issue reported by "${customerName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    // Try to delete from Firebase
                    if (typeof firebaseIssuesManager !== 'undefined' && firebaseIssuesManager.isInitialized) {
                        const success = await firebaseIssuesManager.deleteIssue(issueId);
                        if (success) {
                            issues = issues.filter(i => i.firestoreId !== issueId && i.id !== issueId);
                            renderIssues();
                            return;
                        }
                    }

                    // Fallback to local deletion
                    issues = issues.filter(i => i.id !== issueId && i.firestoreId !== issueId);
                    renderIssues();
                }
            });
        }

        async function resolveIssue(issueId) {
            const solution = document.getElementById('issue-solution').value.trim();
            const resolvedBy = document.getElementById('issue-resolved-by').value.trim();

            if (!solution || !resolvedBy) {
                alert('Please fill in all required fields');
                return;
            }

            const issue = issues.find(i => i.id === issueId || i.firestoreId === issueId);
            if (!issue) return;

            const updateData = {
                status: 'resolved',
                solution: solution,
                resolvedBy: resolvedBy,
                resolutionDate: new Date().toISOString().split('T')[0]
            };

            // Try to update in Firebase
            const firestoreId = issue.firestoreId || issueId;
            if (typeof firebaseIssuesManager !== 'undefined' && firebaseIssuesManager.isInitialized && firestoreId) {
                const success = await firebaseIssuesManager.updateIssue(firestoreId, updateData);
                if (success) {
                    // Update local data
                    Object.assign(issue, updateData);
                    closeModal();
                    renderIssues();
                    return;
                }
            }

            // Fallback to local update
            Object.assign(issue, updateData);
            closeModal();
            renderIssues();
        }

        function viewIssueDetails(issueId) {
            const issue = issues.find(i => i.id === issueId || i.firestoreId === issueId);
            if (!issue) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const status = issue.status || 'open';
            const statusConfig = issueStatusConfig[status];

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-info-circle"></i> Issue Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Customer Name</div>
                                <div style="font-size: 18px; font-weight: 600;">${issue.customer}</div>
                            </div>
                            <span style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: ${statusConfig.bg}; color: ${statusConfig.color}; border-radius: 20px; font-size: 14px; font-weight: 600;">
                                <i class="fas ${statusConfig.icon}"></i>
                                ${statusConfig.label}
                            </span>
                        </div>

                        <!-- Quick Status Actions -->
                        <div style="display: flex; gap: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <span style="color: var(--text-muted); font-size: 13px; display: flex; align-items: center;">Change Status:</span>
                            ${status !== 'open' ? `
                                <button onclick="updateIssueStatusFromModal('${issue.firestoreId || issue.id}', 'open')" style="padding: 6px 12px; background: #ef444420; color: #ef4444; border: 1px solid #ef444450; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-circle-exclamation"></i> Open
                                </button>
                            ` : ''}
                            ${status !== 'follow-up' ? `
                                <button onclick="updateIssueStatusFromModal('${issue.firestoreId || issue.id}', 'follow-up')" style="padding: 6px 12px; background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b50; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-clock"></i> Need Follow Up
                                </button>
                            ` : ''}
                            ${status !== 'resolved' ? `
                                <button onclick="updateIssueStatusFromModal('${issue.firestoreId || issue.id}', 'resolved')" style="padding: 6px 12px; background: #10b98120; color: #10b981; border: 1px solid #10b98150; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-circle-check"></i> Resolved
                                </button>
                            ` : ''}
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Phone Number</div>
                                <div style="font-weight: 500;">${issue.phone ? `<a href="tel:${issue.phone}" style="color: var(--accent-primary); text-decoration: none;"><i class="fas fa-phone"></i> ${issue.phone}</a>` : '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Store</div>
                                <div style="font-weight: 500;">
                                    ${issue.store ? `<span style="display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-store" style="color: var(--accent-primary);"></i> ${issue.store}</span>` : '-'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Issue Type</div>
                                <span class="badge" style="background: ${issue.type === 'In Store' ? 'var(--accent-primary)' : 'var(--info)'};">
                                    <i class="fas fa-${issue.type === 'In Store' ? 'store' : 'globe'}"></i>
                                    ${issue.type}
                                </span>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Incident Date</div>
                                <div style="font-weight: 500;">${formatDate(issue.incidentDate)}</div>
                            </div>
                        </div>

                        <!-- Editable Customer Perception -->
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-size: 13px; color: var(--text-muted);">Customer Perception</div>
                                <button onclick="togglePerceptionEdit('${issue.firestoreId || issue.id}')" class="btn-secondary" style="padding: 4px 10px; font-size: 12px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>

                            <!-- Current Perception Display -->
                            <div id="perception-display-${issue.firestoreId || issue.id}" style="text-align: center;">
                                ${issue.perception ? `
                                    <div style="font-size: 48px;">${getPerceptionEmoji(issue.perception)}</div>
                                    <div style="font-size: 14px; font-weight: 500; margin-top: 4px;">${getPerceptionLabel(issue.perception)}</div>
                                ` : `
                                    <div style="color: var(--text-muted); padding: 16px;">No perception recorded</div>
                                `}
                            </div>

                            <!-- Perception Editor (hidden by default) -->
                            <div id="perception-edit-${issue.firestoreId || issue.id}" style="display: none;">
                                <div style="display: flex; justify-content: space-between; gap: 8px; margin-bottom: 12px;">
                                    ${[1, 2, 3, 4, 5].map(level => `
                                        <button type="button"
                                            class="perception-edit-btn"
                                            data-issue-id="${issue.firestoreId || issue.id}"
                                            data-value="${level}"
                                            onclick="selectPerceptionForEdit('${issue.firestoreId || issue.id}', ${level})"
                                            style="flex: 1; padding: 12px 8px; border: 2px solid ${issue.perception === level ? 'var(--accent-primary)' : 'var(--border-color)'}; border-radius: 12px; background: ${issue.perception === level ? 'rgba(99, 102, 241, 0.1)' : 'var(--bg-tertiary)'}; cursor: pointer; transition: all 0.2s; transform: ${issue.perception === level ? 'scale(1.05)' : 'scale(1)'};">
                                            <div style="font-size: 28px; margin-bottom: 4px;">${getPerceptionEmoji(level)}</div>
                                            <div style="font-size: 10px; color: var(--text-muted);">${getPerceptionLabel(level)}</div>
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="perception-value-${issue.firestoreId || issue.id}" value="${issue.perception || ''}">
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <button onclick="savePerceptionEdit('${issue.firestoreId || issue.id}')" class="btn-primary" style="padding: 8px 16px;">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                    <button onclick="togglePerceptionEdit('${issue.firestoreId || issue.id}')" class="btn-secondary" style="padding: 8px 16px;">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Description</div>
                            <div style="font-size: 14px; line-height: 1.6;">${issue.description}</div>
                        </div>

                        <!-- Follow Up Notes Section -->
                        <div style="border: 2px solid ${status === 'follow-up' ? '#f59e0b' : 'var(--border-color)'}; border-radius: 8px; padding: 16px; ${status === 'follow-up' ? 'background: #f59e0b08;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-size: 14px; font-weight: 600; color: ${status === 'follow-up' ? '#f59e0b' : 'var(--text-primary)'};">
                                    <i class="fas fa-sticky-note"></i> Follow Up Notes
                                </div>
                            </div>
                            <textarea id="issue-followup-notes" class="form-input" placeholder="Add notes about follow-up actions, calls made, updates..." style="min-height: 80px; resize: vertical;">${issue.followUpNotes || ''}</textarea>
                            <button onclick="saveFollowUpNotes('${issue.firestoreId || issue.id}')" class="btn-secondary" style="margin-top: 8px;">
                                <i class="fas fa-save"></i> Save Notes
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Created By</div>
                                <div style="font-weight: 500;">${issue.createdBy}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Created Date</div>
                                <div style="font-weight: 500;">${formatDate(issue.createdDate)}</div>
                            </div>
                        </div>

                        ${issue.status === 'resolved' && issue.solution ? `
                            <div style="border-top: 2px solid var(--border-color); padding-top: 16px; margin-top: 8px;">
                                <h3 style="font-size: 16px; margin-bottom: 16px; color: var(--success);">
                                    <i class="fas fa-check-circle"></i> Resolution Details
                                </h3>

                                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">How it was resolved</div>
                                    <div style="font-size: 14px; line-height: 1.6;">${issue.solution}</div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Resolved By</div>
                                        <div style="font-weight: 600; color: var(--success);">${issue.resolvedBy || '-'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Resolution Date</div>
                                        <div style="font-weight: 600; color: var(--success);">${issue.resolutionDate ? formatDate(issue.resolutionDate) : '-'}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${issue.statusHistory && issue.statusHistory.length > 0 ? `
                            <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 8px;">
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                    <i class="fas fa-history"></i> Status History
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px; max-height: 150px; overflow-y: auto;">
                                    ${issue.statusHistory.slice().reverse().map(h => {
                                        const hConfig = issueStatusConfig[h.status] || issueStatusConfig['open'];
                                        return `
                                            <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 6px 10px; background: var(--bg-tertiary); border-radius: 6px;">
                                                <span style="color: ${hConfig.color};"><i class="fas ${hConfig.icon}"></i></span>
                                                <span style="font-weight: 500;">${hConfig.label}</span>
                                                <span style="color: var(--text-muted);">by ${h.updatedBy}</span>
                                                <span style="color: var(--text-muted); margin-left: auto;">${new Date(h.timestamp).toLocaleString()}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                    <button class="btn-primary" onclick="editIssueDetails('${issue.firestoreId || issue.id}')">
                        <i class="fas fa-edit"></i> Edit Issue
                    </button>
                    <button class="btn-primary" onclick="closeModal()" style="background: var(--success);">
                        <i class="fas fa-check"></i> Accept
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Edit issue details modal
        function editIssueDetails(issueId) {
            const issue = issues.find(i => i.id === issueId || i.firestoreId === issueId);
            if (!issue) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-edit"></i> Edit Issue</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-input" id="edit-issue-customer" value="${issue.customer || ''}" placeholder="Customer name">
                            </div>
                            <div>
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" id="edit-issue-phone" value="${issue.phone || ''}" placeholder="Phone number">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Store</label>
                                <select class="form-input" id="edit-issue-store">
                                    <option value="" ${!issue.store ? 'selected' : ''}>Select Store</option>
                                    <option value="Miramar" ${issue.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                    <option value="Morena" ${issue.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                    <option value="Kearny Mesa" ${issue.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                    <option value="Chula Vista" ${issue.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                    <option value="North Park" ${issue.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                    <option value="Miramar Wine & Liquor" ${issue.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Issue Type</label>
                                <select class="form-input" id="edit-issue-type">
                                    <option value="In Store" ${issue.type === 'In Store' ? 'selected' : ''}>In Store</option>
                                    <option value="Online" ${issue.type === 'Online' ? 'selected' : ''}>Online</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Incident Date</label>
                            <input type="date" class="form-input" id="edit-issue-incident-date" value="${issue.incidentDate || ''}">
                        </div>

                        <div>
                            <label class="form-label">Description</label>
                            <textarea class="form-input" id="edit-issue-description" rows="4" placeholder="Describe the issue...">${issue.description || ''}</textarea>
                        </div>

                        <div>
                            <label class="form-label">Customer Perception</label>
                            <div style="display: flex; justify-content: space-between; gap: 8px;">
                                ${[1, 2, 3, 4, 5].map(level => `
                                    <button type="button"
                                        class="edit-issue-perception-btn"
                                        data-value="${level}"
                                        onclick="selectEditIssuePerception(${level})"
                                        style="flex: 1; padding: 12px 8px; border: 2px solid ${issue.perception === level ? 'var(--accent-primary)' : 'var(--border-color)'}; border-radius: 12px; background: ${issue.perception === level ? 'rgba(99, 102, 241, 0.1)' : 'var(--bg-secondary)'}; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 28px; margin-bottom: 4px;">${getPerceptionEmoji(level)}</div>
                                        <div style="font-size: 10px; color: var(--text-muted);">${getPerceptionLabel(level)}</div>
                                    </button>
                                `).join('')}
                            </div>
                            <input type="hidden" id="edit-issue-perception" value="${issue.perception || ''}">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="viewIssueDetails('${issueId}')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn-primary" onclick="saveIssueEdit('${issue.firestoreId || issue.id}')">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Select perception in edit mode
        function selectEditIssuePerception(level) {
            document.getElementById('edit-issue-perception').value = level;
            document.querySelectorAll('.edit-issue-perception-btn').forEach(btn => {
                const btnLevel = parseInt(btn.dataset.value);
                if (btnLevel === level) {
                    btn.style.borderColor = 'var(--accent-primary)';
                    btn.style.background = 'rgba(99, 102, 241, 0.1)';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'var(--bg-secondary)';
                }
            });
        }

        // Save issue edit
        async function saveIssueEdit(issueId) {
            const customer = document.getElementById('edit-issue-customer').value.trim();
            const phone = document.getElementById('edit-issue-phone').value.trim();
            const store = document.getElementById('edit-issue-store').value;
            const type = document.getElementById('edit-issue-type').value;
            const incidentDate = document.getElementById('edit-issue-incident-date').value;
            const description = document.getElementById('edit-issue-description').value.trim();
            const perception = document.getElementById('edit-issue-perception').value;

            const updateData = {
                customer: customer || 'Anonymous',
                phone: phone || '',
                store: store || '',
                type: type || 'In Store',
                incidentDate: incidentDate || '',
                description: description || '',
                perception: perception ? parseInt(perception) : null
            };

            // Update in Firebase
            if (typeof firebaseIssuesManager !== 'undefined' && firebaseIssuesManager.isInitialized) {
                const success = await firebaseIssuesManager.updateIssue(issueId, updateData);
                if (success) {
                    // Update local array
                    const issueIndex = issues.findIndex(i => i.id === issueId || i.firestoreId === issueId);
                    if (issueIndex !== -1) {
                        issues[issueIndex] = { ...issues[issueIndex], ...updateData };
                    }
                    showNotification('Issue updated successfully', 'success');
                    viewIssueDetails(issueId);
                    return;
                }
            }

            // Fallback to local update
            const issueIndex = issues.findIndex(i => i.id === issueId || i.firestoreId === issueId);
            if (issueIndex !== -1) {
                issues[issueIndex] = { ...issues[issueIndex], ...updateData };
            }
            showNotification('Issue updated successfully', 'success');
            viewIssueDetails(issueId);
        }

        // Update issue status from modal
        async function updateIssueStatusFromModal(issueId, newStatus) {
            await updateIssueStatus(issueId, newStatus);
            viewIssueDetails(issueId); // Refresh modal
        }

        // Save follow up notes
        async function saveFollowUpNotes(issueId) {
            const issue = issues.find(i => i.firestoreId === issueId || i.id === issueId);
            if (!issue) return;

            const notes = document.getElementById('issue-followup-notes')?.value || '';

            try {
                issue.followUpNotes = notes;

                if (firebaseIssuesManager && firebaseIssuesManager.isInitialized && issue.firestoreId) {
                    await firebaseIssuesManager.updateIssue(issue.firestoreId, {
                        followUpNotes: notes
                    });
                }

                showIssueToast('Follow up notes saved!', 'success');
            } catch (error) {
                console.error('Error saving follow up notes:', error);
                showIssueToast('Error saving notes', 'error');
            }
        }

        // Toggle perception edit mode
        function togglePerceptionEdit(issueId) {
            const displayEl = document.getElementById(`perception-display-${issueId}`);
            const editEl = document.getElementById(`perception-edit-${issueId}`);

            if (displayEl && editEl) {
                if (editEl.style.display === 'none') {
                    displayEl.style.display = 'none';
                    editEl.style.display = 'block';
                } else {
                    displayEl.style.display = 'block';
                    editEl.style.display = 'none';
                }
            }
        }

        // Select perception value for editing
        function selectPerceptionForEdit(issueId, value) {
            // Update hidden input
            const hiddenInput = document.getElementById(`perception-value-${issueId}`);
            if (hiddenInput) {
                hiddenInput.value = value;
            }

            // Update button styles
            const buttons = document.querySelectorAll(`.perception-edit-btn[data-issue-id="${issueId}"]`);
            buttons.forEach(btn => {
                const btnValue = parseInt(btn.dataset.value);
                if (btnValue === value) {
                    btn.style.borderColor = 'var(--accent-primary)';
                    btn.style.background = 'rgba(99, 102, 241, 0.1)';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'var(--bg-tertiary)';
                    btn.style.transform = 'scale(1)';
                }
            });
        }

        // Save perception edit
        async function savePerceptionEdit(issueId) {
            const issue = issues.find(i => i.firestoreId === issueId || i.id === issueId);
            if (!issue) return;

            const hiddenInput = document.getElementById(`perception-value-${issueId}`);
            const newPerception = hiddenInput ? parseInt(hiddenInput.value) : null;

            if (!newPerception || newPerception < 1 || newPerception > 5) {
                showIssueToast('Please select a perception level', 'warning');
                return;
            }

            try {
                const oldPerception = issue.perception;
                issue.perception = newPerception;

                // Update in Firebase
                if (firebaseIssuesManager && firebaseIssuesManager.isInitialized && issue.firestoreId) {
                    await firebaseIssuesManager.updateIssue(issue.firestoreId, {
                        perception: newPerception
                    });
                }

                // Update the display
                const displayEl = document.getElementById(`perception-display-${issueId}`);
                if (displayEl) {
                    displayEl.innerHTML = `
                        <div style="font-size: 48px;">${getPerceptionEmoji(newPerception)}</div>
                        <div style="font-size: 14px; font-weight: 500; margin-top: 4px;">${getPerceptionLabel(newPerception)}</div>
                    `;
                }

                // Toggle back to display mode
                togglePerceptionEdit(issueId);

                // Re-render the issues list to update the chart
                renderIssues();

                // Re-open the modal to show updated data
                setTimeout(() => viewIssueDetails(issueId), 100);

                showIssueToast(`Perception updated: ${getPerceptionLabel(oldPerception || 0)}  ${getPerceptionLabel(newPerception)}`, 'success');
            } catch (error) {
                console.error('Error saving perception:', error);
                showIssueToast('Error saving perception', 'error');
            }
        }

        // Vendors Functions
        let vendorSearchTerm = '';
        let vendorCategoryFilter = 'all';
        let vendorTypeFilter = 'all'; // 'all', 'vendor', 'service'
        let firebaseVendors = [];

        async function initVendors() {
            try {
                // Initialize Firebase if not already done
                if (!firebaseVendorsManager.isInitialized) {
                    console.log('Initializing Firebase Vendors Manager...');
                    await firebaseVendorsManager.initialize();
                }
                
                // Load vendors from Firebase
                if (firebaseVendorsManager.isInitialized) {
                    firebaseVendors = await firebaseVendorsManager.loadVendors();
                    console.log(` Loaded ${firebaseVendors.length} vendors from Firebase`);
                } else {
                    console.warn('锔 Firebase not initialized.');
                    firebaseVendors = [];
                }
            } catch (error) {
                console.error('Error loading vendors:', error);
                firebaseVendors = [];
            }
        }

        async function renderVendors() {
            const dashboard = document.querySelector('.dashboard');
            
            // Load vendors from Firebase
            try {
                await initVendors();
            } catch (error) {
                console.error('Error initializing vendors:', error);
            }

            const categories = [...new Set(firebaseVendors.map(v => v.category))];

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Vendors & Suppliers</h2>
                        <p class="section-subtitle">Manage your supplier contacts and information</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openAddVendorModal()">
                        <i class="fas fa-plus"></i>
                        Add Vendor
                    </button>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body">
                        <div class="vendor-type-filters" style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                            <button class="vendor-filter-btn ${vendorTypeFilter === 'all' ? 'active' : ''}" onclick="filterVendorsByType('all')">
                                <i class="fas fa-th-large"></i> All
                            </button>
                            <button class="vendor-filter-btn ${vendorTypeFilter === 'vendor' ? 'active' : ''}" onclick="filterVendorsByType('vendor')">
                                <i class="fas fa-truck"></i> Vendors
                            </button>
                            <button class="vendor-filter-btn ${vendorTypeFilter === 'service' ? 'active' : ''}" onclick="filterVendorsByType('service')">
                                <i class="fas fa-wrench"></i> Services
                            </button>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 250px;">
                                <div style="position: relative;">
                                    <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                                    <input
                                        type="text"
                                        class="form-input"
                                        placeholder="Search by vendor name..."
                                        style="padding-left: 40px;"
                                        oninput="searchVendors(this.value)"
                                        value="${vendorSearchTerm}"
                                    >
                                </div>
                            </div>
                            <div style="min-width: 200px;">
                                <select class="form-input" onchange="filterVendorsByCategory(this.value)">
                                    <option value="all" ${vendorCategoryFilter === 'all' ? 'selected' : ''}>All Categories</option>
                                    ${categories.map(cat => `
                                        <option value="${cat}" ${vendorCategoryFilter === cat ? 'selected' : ''}>${cat}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="vendors-list">
                    ${renderVendorsList()}
                </div>
            `;
        }

        function renderVendorsList() {
            let filteredVendors = firebaseVendors;

            // Apply type filter (vendor/service)
            if (vendorTypeFilter !== 'all') {
                filteredVendors = filteredVendors.filter(v => (v.type || 'vendor') === vendorTypeFilter);
            }

            // Apply category filter
            if (vendorCategoryFilter !== 'all') {
                filteredVendors = filteredVendors.filter(v => v.category === vendorCategoryFilter);
            }

            // Apply search filter
            if (vendorSearchTerm) {
                filteredVendors = filteredVendors.filter(v =>
                    v.name.toLowerCase().includes(vendorSearchTerm.toLowerCase()) ||
                    v.contact.toLowerCase().includes(vendorSearchTerm.toLowerCase()) ||
                    v.category.toLowerCase().includes(vendorSearchTerm.toLowerCase())
                );
            }

            if (filteredVendors.length === 0) {
                return `
                    <div class="card">
                        <div class="card-body" style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-search" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px; display: block;"></i>
                            <div style="font-size: 16px; color: var(--text-muted);">No vendors found</div>
                            <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Try adjusting your search or filter</div>
                        </div>
                    </div>
                `;
            }

            const categoryColors = {
                'Vape Products': '#6366f1',
                'Tobacco Products': '#8b5cf6',
                'Beverages': '#3b82f6',
                'Snacks & Candy': '#f59e0b',
                'Store Supplies': '#10b981'
            };

            const typeColors = {
                'vendor': '#10b981',
                'service': '#8b5cf6'
            };

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    ${filteredVendors.map(vendor => {
                        const vendorType = vendor.type || 'vendor';
                        const typeLabel = vendorType === 'service' ? 'Service' : 'Vendor';
                        const typeColor = typeColors[vendorType] || typeColors['vendor'];
                        return `
                        <div class="card" style="cursor: pointer; transition: all 0.2s; border-left: 4px solid ${categoryColors[vendor.category] || 'var(--accent-primary)'};" onclick="viewVendorDetails('${vendor.firestoreId}')">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: start; gap: 14px; flex: 1;">
                                        <!-- Vendor Image -->
                                        <div style="width: 56px; height: 56px; border-radius: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${vendor.image
                                                ? `<img src="${vendor.image}" style="width: 100%; height: 100%; object-fit: cover;">`
                                                : `<i class="fas fa-building" style="font-size: 20px; color: var(--text-muted);"></i>`
                                            }
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                ${vendor.name}
                                            </h3>
                                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                                <span class="badge" style="background: ${typeColor};">
                                                    <i class="fas ${vendorType === 'service' ? 'fa-wrench' : 'fa-truck'}" style="margin-right: 4px; font-size: 10px;"></i>${typeLabel}
                                                </span>
                                                <span class="badge" style="background: ${categoryColors[vendor.category] || 'var(--accent-primary)'};">
                                                    ${vendor.category}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: var(--text-muted); font-size: 14px;"></i>
                                </div>

                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                    <div style="display: grid; gap: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <i class="fas fa-user" style="width: 16px; color: var(--text-muted);"></i>
                                            <span style="color: var(--text-secondary);">${vendor.contact}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <i class="fas fa-phone" style="width: 16px; color: var(--text-muted);"></i>
                                            <span style="color: var(--text-secondary);">${vendor.phone}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <i class="fas fa-envelope" style="width: 16px; color: var(--text-muted);"></i>
                                            <span style="color: var(--text-secondary);">${vendor.email}</span>
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Products</div>
                                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4;">
                                        ${vendor.products ? vendor.products.split(',').slice(0, 2).join(',') + (vendor.products.split(',').length > 2 ? '...' : '') : 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function searchVendors(searchTerm) {
            vendorSearchTerm = searchTerm;
            const vendorsList = document.getElementById('vendors-list');
            if (vendorsList) {
                vendorsList.innerHTML = renderVendorsList();
            }
        }

        function filterVendorsByCategory(category) {
            vendorCategoryFilter = category;
            const vendorsList = document.getElementById('vendors-list');
            if (vendorsList) {
                vendorsList.innerHTML = renderVendorsList();
            }
        }

        function filterVendorsByType(type) {
            vendorTypeFilter = type;
            // Update button active states
            document.querySelectorAll('.vendor-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            // Re-render the vendors list
            const vendorsList = document.getElementById('vendors-list');
            if (vendorsList) {
                vendorsList.innerHTML = renderVendorsList();
            }
        }

        function openAddVendorModal() {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-plus-circle"></i> Add New Vendor</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <form id="add-vendor-form" style="display: grid; gap: 16px;">
                        <!-- Vendor Image Upload -->
                        <div>
                            <label class="form-label">Vendor Logo/Image</label>
                            <div style="display: flex; align-items: start; gap: 16px;">
                                <div id="vendor-image-preview" style="width: 100px; height: 100px; border-radius: 12px; border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden; flex-shrink: 0;">
                                    <i class="fas fa-building" style="font-size: 32px; color: var(--text-muted);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <input type="file" id="vendor-image" accept="image/*" style="display: none;" onchange="previewVendorImage(this, 'vendor-image-preview')">
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('vendor-image').click()" style="margin-bottom: 8px;">
                                        <i class="fas fa-upload"></i> Upload Image
                                    </button>
                                    <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Recommended: Square image, max 2MB</p>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Vendor Name</label>
                                <input type="text" id="vendor-name" class="form-input" placeholder="Enter vendor name">
                            </div>
                            <div>
                                <label class="form-label">Type</label>
                                <select id="vendor-type" class="form-input">
                                    <option value="vendor">Vendor</option>
                                    <option value="service">Service</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Category</label>
                                <select id="vendor-category" class="form-input">
                                    <option value="">Select category</option>
                                    <option value="Vape Products">Vape Products</option>
                                    <option value="Tobacco Products">Tobacco Products</option>
                                    <option value="Beverages">Beverages</option>
                                    <option value="Snacks & Candy">Snacks & Candy</option>
                                    <option value="Store Supplies">Store Supplies</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Contact Person</label>
                                <input type="text" id="vendor-contact" class="form-input" placeholder="Enter contact name">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Phone</label>
                                <input type="tel" id="vendor-phone" class="form-input" placeholder="(800) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                            </div>
                            <div>
                                <label class="form-label">Email</label>
                                <input type="email" id="vendor-email" class="form-input" placeholder="contact@vendor.com">
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Website</label>
                            <input type="url" id="vendor-website" class="form-input" placeholder="https://www.vendor.com" pattern="https?://.+">
                        </div>

                        <div>
                            <label class="form-label">Access Information</label>
                            <textarea id="vendor-access" class="form-input" placeholder="Account details, login info, etc." style="min-height: 80px;"></textarea>
                        </div>

                        <div>
                            <label class="form-label">Products/Services</label>
                            <textarea id="vendor-products" class="form-input" placeholder="What products/services do you buy from this vendor?" style="min-height: 80px;"></textarea>
                        </div>

                        <div>
                            <label class="form-label">Order Methods</label>
                            <textarea id="vendor-order-methods" class="form-input" placeholder="How to order (phone, email, online, etc.)" style="min-height: 80px;"></textarea>
                        </div>

                        <div>
                            <label class="form-label">Additional Notes</label>
                            <textarea id="vendor-notes" class="form-input" placeholder="Payment terms, delivery schedule, discounts, etc." style="min-height: 80px;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" onclick="createVendor()">
                        <i class="fas fa-save"></i> Save Vendor
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;

            modal.classList.add('active');
        }

        /**
         * Preview vendor image before upload
         */
        function previewVendorImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (!preview) return;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function createVendor() {
            const name = document.getElementById('vendor-name').value.trim();
            const type = document.getElementById('vendor-type').value;
            const category = document.getElementById('vendor-category').value;
            const contact = document.getElementById('vendor-contact').value.trim();
            const phone = document.getElementById('vendor-phone').value.trim();
            const email = document.getElementById('vendor-email').value.trim();
            const website = document.getElementById('vendor-website').value.trim();
            const access = document.getElementById('vendor-access').value.trim();
            const products = document.getElementById('vendor-products').value.trim();
            const orderMethods = document.getElementById('vendor-order-methods').value.trim();
            const notes = document.getElementById('vendor-notes').value.trim();
            const imageInput = document.getElementById('vendor-image');

            try {
                // Upload image to Firebase Storage if provided
                let imageUrl = null;
                let imagePath = null;
                if (imageInput.files && imageInput.files.length > 0) {
                    // Initialize storage helper if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    const rawBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageInput.files[0]);
                    });

                    try {
                        const tempId = Date.now().toString();
                        const uploadResult = await firebaseStorageHelper.uploadImage(
                            rawBase64,
                            'vendors/images',
                            tempId
                        );
                        imageUrl = uploadResult.url;
                        imagePath = uploadResult.path;
                    } catch (err) {
                        console.error('Error uploading vendor image to Storage:', err);
                        // Fallback to compressed base64 for Firestore
                        imageUrl = await compressImage(rawBase64);
                    }
                }

                const newVendor = {
                    name,
                    type,
                    category,
                    contact,
                    phone,
                    email,
                    website,
                    access,
                    products,
                    orderMethods,
                    notes,
                    image: imageUrl,      // Now stores URL instead of base64
                    imagePath: imagePath  // For future deletion
                };

                await firebaseVendorsManager.addVendor(newVendor);

                // Reload vendors
                firebaseVendors = await firebaseVendorsManager.loadVendors();
                closeModal();
                renderVendors();
            } catch (error) {
                console.error('Error creating vendor:', error);
                alert('Error creating vendor: ' + error.message);
            }
        }

        async function viewVendorDetails(firestoreId) {
            const vendor = firebaseVendors.find(v => v.firestoreId === firestoreId);
            if (!vendor) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const categoryColors = {
                'Vape Products': '#6366f1',
                'Tobacco Products': '#8b5cf6',
                'Beverages': '#3b82f6',
                'Snacks & Candy': '#f59e0b',
                'Store Supplies': '#10b981'
            };

            const typeColors = {
                'vendor': '#10b981',
                'service': '#8b5cf6'
            };

            const vendorType = vendor.type || 'vendor';
            const typeLabel = vendorType === 'service' ? 'Service' : 'Vendor';
            const typeColor = typeColors[vendorType] || typeColors['vendor'];
            const typeIcon = vendorType === 'service' ? 'fa-wrench' : 'fa-truck';

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas ${typeIcon}"></i> ${vendor.name}</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 20px;">
                        <!-- Header with Image and Category -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                            <div style="width: 100px; height: 100px; border-radius: 16px; background: var(--bg-secondary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                ${vendor.image
                                    ? `<img src="${vendor.image}" style="width: 100%; height: 100%; object-fit: cover;">`
                                    : `<i class="fas fa-building" style="font-size: 40px; color: var(--text-muted);"></i>`
                                }
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                <span class="badge" style="background: ${typeColor}; font-size: 14px; padding: 8px 16px;">
                                    <i class="fas ${typeIcon}" style="margin-right: 6px;"></i>${typeLabel}
                                </span>
                                <span class="badge" style="background: ${categoryColors[vendor.category] || 'var(--accent-primary)'}; font-size: 14px; padding: 8px 16px;">
                                    ${vendor.category}
                                </span>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                <i class="fas fa-address-book"></i> Contact Information
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-user" style="width: 20px; color: var(--text-muted);"></i>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Contact Person</div>
                                        <div style="font-weight: 500;">${vendor.contact}</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-phone" style="width: 20px; color: var(--text-muted);"></i>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Phone</div>
                                        <a href="tel:${vendor.phone}" style="font-weight: 500; color: var(--accent-primary); text-decoration: none;">${vendor.phone}</a>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-envelope" style="width: 20px; color: var(--text-muted);"></i>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Email</div>
                                        <a href="mailto:${vendor.email}" style="font-weight: 500; color: var(--accent-primary); text-decoration: none;">${vendor.email}</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Website & Access -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                <i class="fas fa-key"></i> Access Information
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                ${vendor.website ? `
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Website</div>
                                        <a href="${vendor.website}" target="_blank" style="color: var(--accent-primary); text-decoration: none; display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-external-link-alt"></i>
                                            ${vendor.website}
                                        </a>
                                    </div>
                                ` : ''}
                                ${vendor.access ? `
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Access Details</div>
                                        <div style="font-size: 14px; padding: 10px; background: var(--bg-primary); border-radius: 6px; font-family: monospace;">
                                            ${vendor.access}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Products -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                <i class="fas fa-boxes"></i> What We Buy
                            </h3>
                            <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                                ${vendor.products}
                            </div>
                        </div>

                        <!-- Order Methods -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                <i class="fas fa-shopping-cart"></i> How to Order
                            </h3>
                            <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                                ${vendor.orderMethods}
                            </div>
                        </div>

                        <!-- Notes -->
                        ${vendor.notes ? `
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                                <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                    <i class="fas fa-sticky-note"></i> Additional Notes
                                </h3>
                                <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                                    ${vendor.notes}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" onclick="closeModal(); setTimeout(() => editVendorModal('${vendor.firestoreId}'), 100);">
                        <i class="fas fa-edit"></i> Edit ${typeLabel}
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;

            modal.classList.add('active');
        }

        function editVendorModal(firestoreId) {
            const vendor = firebaseVendors.find(v => v.firestoreId === firestoreId);
            if (!vendor) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-edit"></i> Edit Vendor</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <form id="edit-vendor-form" style="display: grid; gap: 16px;">
                        <!-- Vendor Image Upload -->
                        <div>
                            <label class="form-label">Vendor Logo/Image</label>
                            <div style="display: flex; align-items: start; gap: 16px;">
                                <div id="edit-vendor-image-preview" style="width: 100px; height: 100px; border-radius: 12px; border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden; flex-shrink: 0;">
                                    ${vendor.image ? `<img src="${vendor.image}" style="width: 100%; height: 100%; object-fit: cover;">` : `<i class="fas fa-building" style="font-size: 32px; color: var(--text-muted);"></i>`}
                                </div>
                                <div style="flex: 1;">
                                    <input type="file" id="edit-vendor-image" accept="image/*" style="display: none;" onchange="previewVendorImage(this, 'edit-vendor-image-preview')">
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('edit-vendor-image').click()" style="margin-bottom: 8px;">
                                        <i class="fas fa-upload"></i> ${vendor.image ? 'Change Image' : 'Upload Image'}
                                    </button>
                                    ${vendor.image ? `<button type="button" class="btn-secondary" onclick="removeVendorImage('edit')" style="margin-left: 8px; margin-bottom: 8px;"><i class="fas fa-trash"></i></button>` : ''}
                                    <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Recommended: Square image, max 2MB</p>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Vendor Name</label>
                                <input type="text" id="edit-vendor-name" class="form-input" value="${vendor.name}" placeholder="Enter vendor name">
                            </div>
                            <div>
                                <label class="form-label">Type</label>
                                <select id="edit-vendor-type" class="form-input">
                                    <option value="vendor" ${vendor.type === 'vendor' || !vendor.type ? 'selected' : ''}>Vendor</option>
                                    <option value="service" ${vendor.type === 'service' ? 'selected' : ''}>Service</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Category</label>
                                <select id="edit-vendor-category" class="form-input">
                                    <option value="">Select category</option>
                                    <option value="Vape Products" ${vendor.category === 'Vape Products' ? 'selected' : ''}>Vape Products</option>
                                    <option value="Tobacco Products" ${vendor.category === 'Tobacco Products' ? 'selected' : ''}>Tobacco Products</option>
                                    <option value="Beverages" ${vendor.category === 'Beverages' ? 'selected' : ''}>Beverages</option>
                                    <option value="Snacks & Candy" ${vendor.category === 'Snacks & Candy' ? 'selected' : ''}>Snacks & Candy</option>
                                    <option value="Store Supplies" ${vendor.category === 'Store Supplies' ? 'selected' : ''}>Store Supplies</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Contact Person</label>
                                <input type="text" id="edit-vendor-contact" class="form-input" value="${vendor.contact}" placeholder="Enter contact name">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Phone</label>
                                <input type="tel" id="edit-vendor-phone" class="form-input" value="${vendor.phone}" placeholder="(800) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                            </div>
                            <div>
                                <label class="form-label">Email</label>
                                <input type="email" id="edit-vendor-email" class="form-input" value="${vendor.email}" placeholder="contact@vendor.com">
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Website</label>
                            <input type="url" id="edit-vendor-website" class="form-input" value="${vendor.website || ''}" placeholder="https://www.vendor.com" pattern="https?://.+">
                        </div>

                        <div>
                            <label class="form-label">Access Information</label>
                            <textarea id="edit-vendor-access" class="form-input" placeholder="Account details, login info, etc." style="min-height: 80px;">${vendor.access || ''}</textarea>
                        </div>

                        <div>
                            <label class="form-label">Products/Services</label>
                            <textarea id="edit-vendor-products" class="form-input" placeholder="What products/services do you buy from this vendor?" style="min-height: 80px;">${vendor.products}</textarea>
                        </div>

                        <div>
                            <label class="form-label">Order Methods</label>
                            <textarea id="edit-vendor-order-methods" class="form-input" placeholder="How to order (phone, email, online, etc.)" style="min-height: 80px;">${vendor.orderMethods}</textarea>
                        </div>

                        <div>
                            <label class="form-label">Additional Notes</label>
                            <textarea id="edit-vendor-notes" class="form-input" placeholder="Payment terms, delivery schedule, discounts, etc." style="min-height: 80px;">${vendor.notes || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-primary" onclick="saveVendorChanges('${vendor.firestoreId}')">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                    <button class="btn-danger" onclick="deleteVendorConfirm('${vendor.firestoreId}')">
                        <i class="fas fa-trash"></i> Delete Vendor
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        /**
         * Remove vendor image from preview
         */
        function removeVendorImage(mode) {
            const previewId = mode === 'edit' ? 'edit-vendor-image-preview' : 'vendor-image-preview';
            const inputId = mode === 'edit' ? 'edit-vendor-image' : 'vendor-image';
            const preview = document.getElementById(previewId);
            const input = document.getElementById(inputId);

            if (preview) {
                preview.innerHTML = `<i class="fas fa-building" style="font-size: 32px; color: var(--text-muted);"></i>`;
                preview.setAttribute('data-removed', 'true');
            }
            if (input) {
                input.value = '';
            }
        }

        async function saveVendorChanges(firestoreId) {
            const name = document.getElementById('edit-vendor-name').value.trim();
            const type = document.getElementById('edit-vendor-type').value;
            const category = document.getElementById('edit-vendor-category').value;
            const contact = document.getElementById('edit-vendor-contact').value.trim();
            const phone = document.getElementById('edit-vendor-phone').value.trim();
            const email = document.getElementById('edit-vendor-email').value.trim();
            const website = document.getElementById('edit-vendor-website').value.trim();
            const access = document.getElementById('edit-vendor-access').value.trim();
            const products = document.getElementById('edit-vendor-products').value.trim();
            const orderMethods = document.getElementById('edit-vendor-order-methods').value.trim();
            const notes = document.getElementById('edit-vendor-notes').value.trim();
            const imageInput = document.getElementById('edit-vendor-image');
            const imagePreview = document.getElementById('edit-vendor-image-preview');

            try {
                const existingVendor = firebaseVendors.find(v => v.firestoreId === firestoreId);

                // Determine image value
                let imageUrl = null;
                let imagePath = null;
                const wasRemoved = imagePreview?.getAttribute('data-removed') === 'true';

                if (wasRemoved) {
                    // Image was explicitly removed - delete from Storage if exists
                    if (existingVendor?.imagePath) {
                        try {
                            if (!firebaseStorageHelper.isInitialized) {
                                firebaseStorageHelper.initialize();
                            }
                            await firebaseStorageHelper.deleteFile(existingVendor.imagePath);
                        } catch (err) {
                            console.error('Error deleting old vendor image from Storage:', err);
                        }
                    }
                    imageUrl = null;
                    imagePath = null;
                } else if (imageInput?.files && imageInput.files.length > 0) {
                    // New image uploaded - upload to Firebase Storage
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    // Delete old image from Storage if exists
                    if (existingVendor?.imagePath) {
                        try {
                            await firebaseStorageHelper.deleteFile(existingVendor.imagePath);
                        } catch (err) {
                            console.error('Error deleting old vendor image from Storage:', err);
                        }
                    }

                    const rawBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageInput.files[0]);
                    });

                    try {
                        const uploadResult = await firebaseStorageHelper.uploadImage(
                            rawBase64,
                            'vendors/images',
                            firestoreId
                        );
                        imageUrl = uploadResult.url;
                        imagePath = uploadResult.path;
                    } catch (err) {
                        console.error('Error uploading vendor image to Storage:', err);
                        // Fallback to compressed base64
                        imageUrl = await compressImage(rawBase64);
                    }
                } else {
                    // Keep existing image
                    imageUrl = existingVendor?.image || null;
                    imagePath = existingVendor?.imagePath || null;
                }

                const updateData = {
                    name,
                    type,
                    category,
                    contact,
                    phone,
                    email,
                    website,
                    access,
                    products,
                    orderMethods,
                    notes,
                    image: imageUrl,
                    imagePath: imagePath
                };

                await firebaseVendorsManager.updateVendor(firestoreId, updateData);

                // Reload vendors
                firebaseVendors = await firebaseVendorsManager.loadVendors();
                closeModal();
                renderVendors();
            } catch (error) {
                console.error('Error updating vendor:', error);
                alert('Error updating vendor: ' + error.message);
            }
        }

        function deleteVendorConfirm(firestoreId) {
            const vendor = firebaseVendors.find(v => v.firestoreId === firestoreId);
            if (!vendor) return;

            showConfirmModal({
                title: 'Delete Vendor',
                message: `Are you sure you want to delete "${vendor.name}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: () => deleteVendor(firestoreId)
            });
        }

        async function deleteVendor(firestoreId) {
            try {
                await firebaseVendorsManager.deleteVendor(firestoreId);

                // Reload vendors
                firebaseVendors = await firebaseVendorsManager.loadVendors();
                closeModal();
                renderVendors();
            } catch (error) {
                console.error('Error deleting vendor:', error);
            }
        }

        // Helper functions
        function formatDate(dateStr) {
            // Format date string directly without using Date object to avoid timezone issues
            if (!dateStr) return '';

            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Handle Date objects
            if (dateStr instanceof Date) {
                const monthName = monthNames[dateStr.getMonth()];
                const dayNum = dateStr.getDate();
                const year = dateStr.getFullYear();
                return `${monthName} ${dayNum}, ${year}`;
            }

            // Handle Firestore Timestamp objects
            if (dateStr && typeof dateStr.toDate === 'function') {
                const date = dateStr.toDate();
                const monthName = monthNames[date.getMonth()];
                const dayNum = date.getDate();
                const year = date.getFullYear();
                return `${monthName} ${dayNum}, ${year}`;
            }

            // Handle string format "YYYY-MM-DD"
            if (typeof dateStr === 'string' && dateStr.includes('-')) {
                const [year, month, day] = dateStr.split('-');
                const monthIndex = parseInt(month, 10) - 1;
                const monthName = monthNames[monthIndex];
                const dayNum = parseInt(day, 10);
                return `${monthName} ${dayNum}, ${year}`;
            }

            return String(dateStr);
        }

        // Format phone number to US format (XXX) XXX-XXXX
        function formatPhoneNumber(input) {
            // Remove all non-digit characters
            let value = input.value.replace(/\D/g, '');

            // Limit to 10 digits
            if (value.length > 10) {
                value = value.substring(0, 10);
            }

            // Format the number
            if (value.length === 0) {
                input.value = '';
            } else if (value.length <= 3) {
                input.value = '(' + value;
            } else if (value.length <= 6) {
                input.value = '(' + value.substring(0, 3) + ') ' + value.substring(3);
            } else {
                input.value = '(' + value.substring(0, 3) + ') ' + value.substring(3, 6) + '-' + value.substring(6);
            }
        }

        // Helper function to extract emergency contact name from combined string
        function getEmergencyContactName(emergencyContact) {
            if (!emergencyContact) return '';
            // Format is typically "Name - (XXX) XXX-XXXX" or "Name - Phone"
            const parts = emergencyContact.split(' - ');
            return parts[0] || '';
        }

        // Helper function to extract emergency contact phone from combined string
        function getEmergencyContactPhone(emergencyContact) {
            if (!emergencyContact) return '';
            // Format is typically "Name - (XXX) XXX-XXXX" or "Name - Phone"
            const parts = emergencyContact.split(' - ');
            return parts[1] || '';
        }

        // Helper function to combine emergency contact name and phone
        function combineEmergencyContact(name, phone) {
            if (!name && !phone) return 'Not provided';
            if (!name) return phone;
            if (!phone) return name;
            return `${name} - ${phone}`;
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;

            // Determine icon based on type
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'error') icon = 'fa-exclamation-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';

            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;

            // Add to body
            document.body.appendChild(toast);

            // Show toast with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Variable to track employee being edited
        let editingEmployeeId = null;

        // Variables to store selected files for employee paperwork
        let selectedEmployeePaperworkFiles = [];
        let editEmployeePaperworkFiles = [];

        // Helper function to render existing paperwork
        function renderExistingPaperwork(employeeData) {
            const paperwork = employeeData.paperwork || [];
            if (paperwork.length === 0) {
                return '<p style="color: var(--text-muted); font-size: 14px; padding: 12px; background: var(--surface-secondary); border-radius: 8px;">No documents uploaded yet</p>';
            }

            return `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${paperwork.map((doc, index) => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <i class="fas ${getFileIcon(doc.fileType)}" style="color: var(--accent-primary); font-size: 18px;"></i>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${doc.fileName}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">
                                        ${doc.documentType || 'Document'}  ${formatFileSize(doc.fileSize)}  ${formatDate(doc.uploadedAt.toDate ? doc.uploadedAt.toDate() : doc.uploadedAt)}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-icon" onclick="window.open('${doc.downloadURL}', '_blank')" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon danger" onclick="deleteEmployeePaperwork('${employeeData.id || employeeData.firestoreId}', '${doc.storagePath}', ${index})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Helper function to get file icon based on file type
        function getFileIcon(fileType) {
            if (!fileType) return 'fa-file';
            if (fileType.includes('pdf')) return 'fa-file-pdf';
            if (fileType.includes('word') || fileType.includes('doc')) return 'fa-file-word';
            if (fileType.includes('image') || fileType.includes('jpg') || fileType.includes('jpeg') || fileType.includes('png')) return 'fa-file-image';
            return 'fa-file';
        }

        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Handle file selection for add employee paperwork
        function handleEmployeePaperworkSelect(input) {
            const files = Array.from(input.files);
            const maxSize = 10 * 1024 * 1024; // 10MB

            // Validate files
            const validFiles = files.filter(file => {
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return false;
                }
                return true;
            });

            // Add to selected files
            selectedEmployeePaperworkFiles = [...selectedEmployeePaperworkFiles, ...validFiles];

            // Update UI
            updateEmployeePaperworkList();
        }

        // Handle file selection for edit employee paperwork
        function handleEditEmployeePaperworkSelect(input) {
            const files = Array.from(input.files);
            const maxSize = 10 * 1024 * 1024; // 10MB

            // Validate files
            const validFiles = files.filter(file => {
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return false;
                }
                return true;
            });

            // Add to selected files
            editEmployeePaperworkFiles = [...editEmployeePaperworkFiles, ...validFiles];

            // Update UI
            updateEditEmployeePaperworkList();
        }

        // Update paperwork list display for add employee
        function updateEmployeePaperworkList() {
            const listContainer = document.getElementById('emp-paperwork-list');
            if (!listContainer) return;

            if (selectedEmployeePaperworkFiles.length === 0) {
                listContainer.innerHTML = '';
                return;
            }

            listContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${selectedEmployeePaperworkFiles.map((file, index) => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas ${getFileIcon(file.type)}" style="color: var(--accent-primary); font-size: 18px;"></i>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${file.name}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${formatFileSize(file.size)}</div>
                                </div>
                            </div>
                            <button class="btn-icon danger" onclick="removeEmployeePaperwork(${index})" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Update paperwork list display for edit employee
        function updateEditEmployeePaperworkList() {
            const listContainer = document.getElementById('edit-emp-paperwork-list');
            if (!listContainer) return;

            if (editEmployeePaperworkFiles.length === 0) {
                listContainer.innerHTML = '';
                return;
            }

            listContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${editEmployeePaperworkFiles.map((file, index) => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas ${getFileIcon(file.type)}" style="color: var(--accent-primary); font-size: 18px;"></i>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${file.name}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${formatFileSize(file.size)}</div>
                                </div>
                            </div>
                            <button class="btn-icon danger" onclick="removeEditEmployeePaperwork(${index})" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Remove file from add employee paperwork list
        function removeEmployeePaperwork(index) {
            selectedEmployeePaperworkFiles.splice(index, 1);
            updateEmployeePaperworkList();
        }

        // Remove file from edit employee paperwork list
        function removeEditEmployeePaperwork(index) {
            editEmployeePaperworkFiles.splice(index, 1);
            updateEditEmployeePaperworkList();
        }

        // Delete existing employee paperwork
        async function deleteEmployeePaperwork(employeeId, storagePath, index) {
            if (!confirm('Are you sure you want to delete this document?')) {
                return;
            }

            try {
                const success = await firebaseEmployeeManager.deletePaperwork(employeeId, storagePath);
                if (success) {
                    showNotification('Document deleted successfully', 'success');
                    // Refresh the modal with updated data
                    const emp = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);
                    if (emp) {
                        // Reload employee data from Firebase
                        const updatedEmp = await firebaseEmployeeManager.getEmployee(employeeId);
                        if (updatedEmp) {
                            // Update local array
                            const localIndex = employees.findIndex(e => e.id === employeeId || e.firestoreId === employeeId);
                            if (localIndex !== -1) {
                                employees[localIndex] = updatedEmp;
                            }
                            // Re-render the existing paperwork section
                            const existingPaperworkDiv = document.getElementById('edit-emp-existing-paperwork');
                            if (existingPaperworkDiv) {
                                existingPaperworkDiv.innerHTML = renderExistingPaperwork(updatedEmp);
                            }
                        }
                    }
                } else {
                    alert('Failed to delete document. Please try again.');
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                alert('Error deleting document. Please try again.');
            }
        }

        function openModal(type, data = null) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            let content = '';
            switch(type) {
                case 'edit-employee':
                    if (!data) {
                        alert('No employee data provided');
                        return;
                    }
                    // Split name into first and last
                    const nameParts = data.name.split(' ');
                    const firstName = nameParts[0] || '';
                    const lastName = nameParts.slice(1).join(' ') || '';

                    content = `
                        <div class="modal-header">
                            <h2>Edit Employee</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>First Name *</label>
                                    <input type="text" class="form-input" id="edit-emp-first-name" value="${firstName}" placeholder="John">
                                </div>
                                <div class="form-group">
                                    <label>Last Name *</label>
                                    <input type="text" class="form-input" id="edit-emp-last-name" value="${lastName}" placeholder="Doe">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Login Email *</label>
                                    <input type="email" class="form-input" id="edit-emp-email" value="${data.authEmail || data.email || ''}" placeholder="john@vsu.com">
                                </div>
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" class="form-input" id="edit-emp-phone" value="${data.phone || ''}" placeholder="(619) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Password (leave blank to keep current)</label>
                                    <input type="password" class="form-input" id="edit-emp-password" placeholder="Enter new password or leave blank">
                                </div>
                                <div class="form-group">
                                    <label>Confirm Password</label>
                                    <input type="password" class="form-input" id="edit-emp-confirm-password" placeholder="Confirm new password">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Job Position/Role *</label>
                                    <select class="form-input" id="edit-emp-role">
                                        <option value="">Select role...</option>
                                        <option value="Store Manager" ${data.role === 'Store Manager' ? 'selected' : ''}>Store Manager</option>
                                        <option value="Shift Lead" ${data.role === 'Shift Lead' ? 'selected' : ''}>Shift Lead</option>
                                        <option value="Sales Associate" ${data.role === 'Sales Associate' ? 'selected' : ''}>Sales Associate</option>
                                        <option value="Inventory Specialist" ${data.role === 'Inventory Specialist' ? 'selected' : ''}>Inventory Specialist</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Permission Level *</label>
                                    <select class="form-input" id="edit-emp-employee-type">
                                        <option value="">Select permission level...</option>
                                        <option value="admin" ${data.employeeType === 'admin' ? 'selected' : ''}> Admin - Full System Access</option>
                                        <option value="manager" ${data.employeeType === 'manager' ? 'selected' : ''}> Manager - Employee Management</option>
                                        <option value="employee" ${data.employeeType === 'employee' ? 'selected' : ''}> Employee - Limited Access</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="edit-emp-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar" ${data.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                        <option value="Morena" ${data.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                        <option value="Kearny Mesa" ${data.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                        <option value="Chula Vista" ${data.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                        <option value="North Park" ${data.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                        <option value="Miramar Wine & Liquor" ${data.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Status *</label>
                                    <select class="form-input" id="edit-emp-status">
                                        <option value="active" ${data.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="inactive" ${data.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Hire Date</label>
                                <input type="date" class="form-input" id="edit-emp-hire-date" value="${data.hireDate || ''}">
                            </div>
                            <div class="form-divider"></div>
                            <h3 class="form-section-title">Emergency Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Emergency Contact Name</label>
                                    <input type="text" class="form-input" id="edit-emp-emergency-name" value="${getEmergencyContactName(data.emergencyContact)}" placeholder="Contact name">
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Phone</label>
                                    <input type="tel" class="form-input" id="edit-emp-emergency-phone" value="${getEmergencyContactPhone(data.emergencyContact)}" placeholder="(555) 555-5555" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Allergies / Medical Notes</label>
                                <textarea class="form-input" id="edit-emp-allergies" rows="2" placeholder="Any allergies or medical conditions...">${data.allergies || ''}</textarea>
                            </div>
                            <div class="form-divider"></div>
                            <h3 class="form-section-title">Employee Paperwork</h3>
                            <div class="form-group">
                                <label>Existing Documents</label>
                                <div id="edit-emp-existing-paperwork" style="margin-bottom: 12px;">
                                    ${renderExistingPaperwork(data)}
                                </div>
                                <label>Upload New Documents <span style="font-size: 12px; color: var(--text-muted);">(ID, contracts, certificates, etc.)</span></label>
                                <div class="file-upload-area" id="edit-emp-paperwork-upload" onclick="document.getElementById('edit-emp-paperwork-files').click()">
                                    <input type="file" id="edit-emp-paperwork-files" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;" onchange="handleEditEmployeePaperworkSelect(this)">
                                    <div class="file-upload-content">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--accent-primary); margin-bottom: 8px;"></i>
                                        <span style="color: var(--text-secondary);">Click to upload or drag and drop</span>
                                        <span style="color: var(--text-muted); font-size: 12px;">PDF, DOC, DOCX, JPG, PNG files (max 10MB each)</span>
                                    </div>
                                </div>
                                <div id="edit-emp-paperwork-list" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveEditedEmployee()">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'offboarding':
                    const offboardingEmp = data;
                    content = `
                        <div class="modal-header">
                            <h2 style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-user-minus" style="color: #ef4444;"></i>
                                Employee Offboarding
                            </h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-info-circle" style="color: #ef4444;"></i>
                                    <span style="font-size: 13px; color: #991b1b;">Documenting exit for <strong>${offboardingEmp.name}</strong></span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Reason for Leaving *</label>
                                <select class="form-input" id="offboard-reason" required>
                                    <option value="">Select reason...</option>
                                    <option value="resignation">Resignation</option>
                                    <option value="termination">Termination</option>
                                    <option value="contract_end">End of Contract</option>
                                    <option value="abandonment">Job Abandonment</option>
                                    <option value="mutual">Mutual Agreement</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group" id="offboard-other-reason-container" style="display: none;">
                                <label>Specify Reason *</label>
                                <input type="text" class="form-input" id="offboard-other-reason" placeholder="Please specify...">
                            </div>
                            <div class="form-group">
                                <label>Last Day Worked *</label>
                                <input type="date" class="form-input" id="offboard-last-day" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>

                            <div class="form-divider"></div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="offboard-keys" style="width: 18px; height: 18px;">
                                    <span><i class="fas fa-key" style="color: var(--accent-primary); margin-right: 4px;"></i> Keys Returned</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label>Received By *</label>
                                <input type="text" class="form-input" id="offboard-received-by" placeholder="Name of person who received items" required>
                            </div>

                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-input" id="offboard-notes" rows="2" placeholder="Any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="cancelOffboarding()">Cancel</button>
                            <button class="btn-primary" style="background: #ef4444; border-color: #ef4444;" onclick="confirmOffboarding()">
                                <i class="fas fa-check"></i> Complete
                            </button>
                        </div>
                    `;

                    // Add event listener for reason change after modal renders
                    setTimeout(() => {
                        const reasonSelect = document.getElementById('offboard-reason');
                        if (reasonSelect) {
                            reasonSelect.addEventListener('change', function() {
                                const otherContainer = document.getElementById('offboard-other-reason-container');
                                otherContainer.style.display = this.value === 'other' ? 'block' : 'none';
                            });
                        }
                    }, 100);
                    break;
                case 'inactive-employees':
                    const inactiveEmps = data || [];
                    content = `
                        <div class="modal-header">
                            <h2 style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-user-slash" style="color: #ef4444;"></i>
                                Inactive Employees
                            </h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                            ${inactiveEmps.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px; color: var(--success);"></i>
                                    <p>No inactive employees</p>
                                </div>
                            ` : `
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    ${inactiveEmps.map(emp => {
                                        const empId = emp.firestoreId || emp.id;
                                        const hasOffboarding = emp.offboarding && emp.offboarding.reason;
                                        return `
                                            <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                                    <div style="display: flex; align-items: center; gap: 12px;">
                                                        <div class="avatar avatar-${emp.color || 'a'}" style="width: 40px; height: 40px; font-size: 14px;">${emp.initials || 'XX'}</div>
                                                        <div>
                                                            <div style="font-weight: 600; color: var(--text-primary);">${emp.name || 'Unknown'}</div>
                                                            <div style="font-size: 12px; color: var(--text-muted);">${emp.role || 'N/A'} - ${emp.store || 'N/A'}</div>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 8px;">
                                                        ${hasOffboarding ? `
                                                            <button class="btn-secondary" onclick="viewOffboardingDetails('${empId}')" style="font-size: 12px; padding: 6px 12px;">
                                                                <i class="fas fa-file-alt"></i> View Details
                                                            </button>
                                                        ` : `
                                                            <span style="font-size: 11px; color: var(--text-muted); padding: 6px 12px;">No offboarding data</span>
                                                        `}
                                                        <button class="btn-icon success" onclick="activateEmployee('${empId}'); closeModal();" title="Reactivate">
                                                            <i class="fas fa-user-check"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                ${hasOffboarding ? `
                                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary);">
                                                        <span style="background: #fef2f2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-weight: 500;">
                                                            ${emp.offboarding.reasonText || emp.offboarding.reason}
                                                        </span>
                                                        <span style="margin-left: 12px;">Last day: ${formatDate(emp.offboarding.lastDayWorked)}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Close</button>
                        </div>
                    `;
                    break;
                case 'offboarding-details':
                    const offEmp = data;
                    const offData = offEmp.offboarding || {};
                    content = `
                        <div class="modal-header">
                            <h2 style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-file-alt" style="color: var(--accent-primary);"></i>
                                Offboarding Details
                            </h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div class="avatar avatar-${offEmp.color || 'a'}" style="width: 48px; height: 48px; font-size: 16px;">${offEmp.initials || 'XX'}</div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 18px; color: var(--text-primary);">${offEmp.name || 'Unknown'}</div>
                                        <div style="font-size: 13px; color: var(--text-muted);">${offEmp.role || 'N/A'} - ${offEmp.store || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>

                            <div style="display: grid; gap: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Reason for Leaving</label>
                                        <div style="background: #fef2f2; color: #991b1b; padding: 8px 12px; border-radius: 6px; font-weight: 500;">
                                            ${offData.reasonText || offData.reason || 'Not specified'}
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Last Day Worked</label>
                                        <div style="background: var(--bg-secondary); padding: 8px 12px; border-radius: 6px; font-weight: 500;">
                                            ${offData.lastDayWorked ? formatDate(offData.lastDayWorked) : 'Not specified'}
                                        </div>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Keys Returned</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i class="fas ${offData.keysReturned ? 'fa-check-circle' : 'fa-times-circle'}" style="color: ${offData.keysReturned ? 'var(--success)' : 'var(--danger)'}; font-size: 18px;"></i>
                                            <span>${offData.keysReturned ? 'Yes' : 'No'}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Received By</label>
                                        <div style="background: var(--bg-secondary); padding: 8px 12px; border-radius: 6px;">
                                            ${offData.receivedBy || 'Not specified'}
                                        </div>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Offboarding Date</label>
                                        <div style="background: var(--bg-secondary); padding: 8px 12px; border-radius: 6px;">
                                            ${offData.offboardingDate ? formatDate(offData.offboardingDate.split('T')[0]) : 'Not specified'}
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Processed By</label>
                                        <div style="background: var(--bg-secondary); padding: 8px 12px; border-radius: 6px;">
                                            ${offData.offboardingBy || 'Not specified'}
                                        </div>
                                    </div>
                                </div>

                                ${offData.notes ? `
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Notes</label>
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; white-space: pre-wrap;">
                                            ${offData.notes}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="openInactiveEmployeesModal()">
                                <i class="fas fa-arrow-left"></i> Back to List
                            </button>
                            <button class="btn-primary" onclick="activateEmployee('${offEmp.firestoreId || offEmp.id}'); closeModal();">
                                <i class="fas fa-user-check"></i> Reactivate Employee
                            </button>
                        </div>
                    `;
                    break;
                case 'add-employee':
                    content = `
                        <div class="modal-header">
                            <h2>Add New Employee</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>First Name *</label>
                                    <input type="text" class="form-input" id="emp-first-name" placeholder="John">
                                </div>
                                <div class="form-group">
                                    <label>Last Name *</label>
                                    <input type="text" class="form-input" id="emp-last-name" placeholder="Doe">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" class="form-input" id="emp-email" placeholder="john@vsu.com">
                                </div>
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" class="form-input" id="emp-phone" placeholder="(619) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Password *</label>
                                    <input type="password" class="form-input" id="emp-password" placeholder="Enter a secure password">
                                </div>
                                <div class="form-group">
                                    <label>Confirm Password *</label>
                                    <input type="password" class="form-input" id="emp-confirm-password" placeholder="Confirm password">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Job Position/Role *</label>
                                    <select class="form-input" id="emp-role">
                                        <option value="">Select role...</option>
                                        <option value="Store Manager">Store Manager</option>
                                        <option value="Shift Lead">Shift Lead</option>
                                        <option value="Sales Associate">Sales Associate</option>
                                        <option value="Inventory Specialist">Inventory Specialist</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Permission Level * <i class="fas fa-info-circle" style="color: var(--accent-primary); font-size: 12px; cursor: help;" title="Admin: Full access | Manager: Can manage employees | Employee: Limited access"></i></label>
                                    <select class="form-input" id="emp-employee-type">
                                        <option value="">Select permission level...</option>
                                        <option value="admin"> Admin - Full System Access</option>
                                        <option value="manager"> Manager - Employee Management</option>
                                        <option value="employee"> Employee - Limited Access</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="emp-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Hire Date *</label>
                                    <input type="date" class="form-input" id="emp-hire-date">
                                </div>
                            </div>
                            <div class="form-divider"></div>
                            <h3 class="form-section-title">Emergency Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Emergency Contact Name</label>
                                    <input type="text" class="form-input" id="emp-emergency-name" placeholder="Contact name">
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Phone</label>
                                    <input type="tel" class="form-input" id="emp-emergency-phone" placeholder="(555) 555-5555" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Allergies / Medical Notes</label>
                                <textarea class="form-input" id="emp-allergies" rows="2" placeholder="Any allergies or medical conditions..."></textarea>
                            </div>
                            <div class="form-divider"></div>
                            <h3 class="form-section-title">Employee Paperwork</h3>
                            <div class="form-group">
                                <label>Upload Documents <span style="font-size: 12px; color: var(--text-muted);">(ID, contracts, certificates, etc.)</span></label>
                                <div class="file-upload-area" id="emp-paperwork-upload" onclick="document.getElementById('emp-paperwork-files').click()">
                                    <input type="file" id="emp-paperwork-files" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;" onchange="handleEmployeePaperworkSelect(this)">
                                    <div class="file-upload-content">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--accent-primary); margin-bottom: 8px;"></i>
                                        <span style="color: var(--text-secondary);">Click to upload or drag and drop</span>
                                        <span style="color: var(--text-muted); font-size: 12px;">PDF, DOC, DOCX, JPG, PNG files (max 10MB each)</span>
                                    </div>
                                </div>
                                <div id="emp-paperwork-list" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveEmployee()">Add Employee</button>
                        </div>
                    `;
                    break;
                case 'add-training':
                    content = `
                        <div class="modal-header">
                            <h2>Add Training Material</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Title *</label>
                                <input type="text" class="form-input" id="training-title" placeholder="Training name...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type *</label>
                                    <select class="form-input" id="training-type" onchange="toggleTrainingTypeFields()">
                                        <option value="video">Video (YouTube/Vimeo)</option>
                                        <option value="document">Document (PDF)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" id="training-url-group">
                                <label>Video URL *</label>
                                <input type="url" class="form-input" id="training-url" placeholder="https://youtube.com/watch?v=...">
                                <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">Supports YouTube and Vimeo links</small>
                            </div>
                            <div class="form-group" id="training-file-group" style="display: none;">
                                <label>PDF File *</label>
                                <div class="file-upload" id="training-file-upload" onclick="document.getElementById('training-file').click()">
                                    <input type="file" id="training-file" accept=".pdf" style="display: none;" onchange="handleTrainingFileSelect(this)">
                                    <div class="file-upload-content" id="training-file-content">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--accent-primary); margin-bottom: 8px;"></i>
                                        <span style="color: var(--text-secondary);">Click to upload or drag and drop</span>
                                        <span style="color: var(--text-muted); font-size: 12px;">PDF files only (max 50MB)</span>
                                    </div>
                                </div>
                                <div id="training-upload-progress" style="display: none; margin-top: 12px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="progress-bar" style="flex: 1; height: 8px;">
                                            <div class="progress-fill" id="training-progress-fill" style="width: 0%;"></div>
                                        </div>
                                        <span id="training-progress-text" style="font-size: 12px; color: var(--text-muted);">0%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="training-description" rows="3" placeholder="Brief description of the training content..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="training-required" checked>
                                    <span>Required for all employees</span>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" id="save-training-btn" onclick="saveTraining()">
                                <span id="save-training-text">Add Training</span>
                                <i class="fas fa-spinner fa-spin" id="save-training-spinner" style="display: none;"></i>
                            </button>
                        </div>
                    `;
                    break;
                case 'mandatory-compliance':
                    const mandatoryTrainings = data.mandatoryTrainings || [];
                    const allEmployees = data.employees || [];

                    // Calculate per-training compliance
                    const trainingStats = mandatoryTrainings.map(training => {
                        const completions = training.completions || [];
                        const completedEmployees = allEmployees.filter(emp => {
                            const empId = emp.firestoreId || emp.id;
                            return completions.some(c => c.employeeId === empId);
                        });
                        const pendingEmployees = allEmployees.filter(emp => {
                            const empId = emp.firestoreId || emp.id;
                            return !completions.some(c => c.employeeId === empId);
                        });

                        return {
                            training,
                            completedEmployees,
                            pendingEmployees,
                            completionPercentage: allEmployees.length > 0 ? Math.round((completedEmployees.length / allEmployees.length) * 100) : 0
                        };
                    });

                    // Calculate overall compliance
                    const fullyCompliantEmployees = allEmployees.filter(emp => {
                        return mandatoryTrainings.every(training => {
                            const empId = emp.firestoreId || emp.id;
                            const completions = training.completions || [];
                            return completions.some(c => c.employeeId === empId);
                        });
                    });

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-exclamation-circle"></i> Mandatory Training Compliance Report</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- Overall Compliance -->
                            <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; padding: 24px; margin-bottom: 24px; color: white;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Overall Compliance</div>
                                <div style="font-size: 36px; font-weight: 700; margin-bottom: 4px;">${fullyCompliantEmployees.length} / ${allEmployees.length}</div>
                                <div style="font-size: 13px; opacity: 0.9;">Employees fully compliant with all mandatory trainings</div>
                            </div>

                            <!-- Per-Training Breakdown -->
                            <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Per-Training Compliance</h3>
                            <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
                                ${trainingStats.map(stat => `
                                    <div class="card">
                                        <div class="card-body">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                <div style="flex: 1;">
                                                    <h4 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600;">${stat.training.title}</h4>
                                                    <div style="font-size: 12px; color: var(--text-muted);">${stat.training.type.toUpperCase()}</div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-size: 24px; font-weight: 700; color: ${stat.completionPercentage === 100 ? '#10b981' : '#ef4444'};">${stat.completionPercentage}%</div>
                                                    <div style="font-size: 12px; color: var(--text-muted);">${stat.completedEmployees.length}/${allEmployees.length} completed</div>
                                                </div>
                                            </div>
                                            <div style="background: var(--bg-tertiary); border-radius: 8px; height: 8px; overflow: hidden; margin-bottom: 12px;">
                                                <div style="background: ${stat.completionPercentage === 100 ? '#10b981' : '#6366f1'}; height: 100%; width: ${stat.completionPercentage}%; transition: width 0.3s;"></div>
                                            </div>
                                            ${stat.pendingEmployees.length > 0 ? `
                                                <details style="margin-top: 12px;">
                                                    <summary style="cursor: pointer; font-size: 13px; color: var(--text-secondary); font-weight: 500;">
                                                        <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> ${stat.pendingEmployees.length} employee${stat.pendingEmployees.length !== 1 ? 's' : ''} pending
                                                    </summary>
                                                    <div style="margin-top: 8px; padding-left: 20px;">
                                                        ${stat.pendingEmployees.slice(0, 10).map(emp => `
                                                            <div style="padding: 4px 0; font-size: 13px; color: var(--text-secondary);">
                                                                 ${emp.name} (${emp.role} @ ${emp.store})
                                                            </div>
                                                        `).join('')}
                                                        ${stat.pendingEmployees.length > 10 ? `<div style="padding: 4px 0; font-size: 12px; color: var(--text-muted);">+${stat.pendingEmployees.length - 10} more...</div>` : ''}
                                                    </div>
                                                </details>
                                            ` : '<div style="font-size: 13px; color: #10b981;"><i class="fas fa-check-circle"></i> All employees completed</div>'}
                                            <div style="margin-top: 12px;">
                                                <button class="btn-secondary" onclick="closeModal(); setTimeout(() => openTrainingCompletionModal('${stat.training.id}'), 100);">
                                                    <i class="fas fa-check-circle"></i> Manage Completions
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Non-Compliant Employees -->
                            ${fullyCompliantEmployees.length < allEmployees.length ? `
                                <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Non-Compliant Employees
                                </h3>
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; max-height: 300px; overflow-y: auto;">
                                    ${allEmployees.filter(emp => !fullyCompliantEmployees.includes(emp)).map(emp => {
                                        const incompleteTrainings = mandatoryTrainings.filter(training => {
                                            const empId = emp.firestoreId || emp.id;
                                            const completions = training.completions || [];
                                            return !completions.some(c => c.employeeId === empId);
                                        });
                                        return `
                                            <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px;">
                                                <div style="font-weight: 500; margin-bottom: 4px;">${emp.name}</div>
                                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">${emp.role} @ ${emp.store}</div>
                                                <div style="font-size: 13px; color: #ef4444;">
                                                    Missing ${incompleteTrainings.length} training${incompleteTrainings.length !== 1 ? 's' : ''}:
                                                    ${incompleteTrainings.slice(0, 3).map(t => t.title).join(', ')}${incompleteTrainings.length > 3 ? ` +${incompleteTrainings.length - 3} more` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<div style="text-align: center; padding: 40px; background: var(--bg-secondary); border-radius: 12px;"><i class="fas fa-check-circle" style="font-size: 48px; color: #10b981; margin-bottom: 16px; display: block;"></i><div style="font-size: 16px; font-weight: 600; color: #10b981;">100% Compliance!</div><div style="font-size: 14px; color: var(--text-muted); margin-top: 4px;">All employees have completed all mandatory trainings</div></div>'}
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Close</button>
                        </div>
                    `;
                    break;
                case 'add-license':
                    content = `
                        <div class="modal-header">
                            <h2>Add License / Document</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Document Name *</label>
                                <input type="text" class="form-input" id="license-name" placeholder="Business License">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="license-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Expiration Date *</label>
                                    <input type="date" class="form-input" id="license-expires">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Upload PDF</label>
                                <div class="file-upload">
                                    <input type="file" id="license-file" accept=".pdf">
                                    <div class="file-upload-content">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>Click to upload or drag and drop</span>
                                        <small>PDF files only (optional)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveLicense()">Upload License</button>
                        </div>
                    `;
                    break;
                case 'add-announcement':
                    content = `
                        <div class="modal-header">
                            <h2>New Announcement</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Title *</label>
                                <input type="text" class="form-input" id="announcement-title" placeholder="Announcement title...">
                            </div>
                            <div class="form-group">
                                <label>Message *</label>
                                <textarea class="form-input" id="announcement-content" rows="5" placeholder="Write your announcement..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Target Stores</label>
                                <select class="form-input" id="announcement-stores">
                                    <option value="all">All Stores</option>
                                    <option value="Miramar">VSU Miramar</option>
                                    <option value="Morena">VSU Morena</option>
                                    <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                    <option value="Chula Vista">VSU Chula Vista</option>
                                    <option value="North Park">VSU North Park</option>
                                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveAnnouncement()">Post Announcement</button>
                        </div>
                    `;
                    break;
                case 'add-product':
                    content = `
                        <div class="modal-header">
                            <h2>Add New Product</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Product Name *</label>
                                    <input type="text" class="form-input" id="new-product-name" placeholder="Enter product name...">
                                </div>
                                <div class="form-group">
                                    <label>Category</label>
                                    <select class="form-input" id="new-product-category">
                                        <option value="">Select category...</option>
                                        <option value="Vape Devices">Vape Devices</option>
                                        <option value="Vape Pods">Vape Pods</option>
                                        <option value="Disposables">Disposables</option>
                                        <option value="Cigarettes">Cigarettes</option>
                                        <option value="Accessories">Accessories</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Estimated Price</label>
                                    <input type="number" step="0.01" class="form-input" id="new-product-price" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Arrival</label>
                                    <input type="date" class="form-input" id="new-product-arrival">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Estimated Deals</label>
                                    <input type="text" class="form-input" id="new-product-deals" placeholder="e.g., 2x1, 20% off, Buy 3 get 1 free...">
                                </div>
                                <div class="form-group">
                                    <label>Product URL</label>
                                    <input type="url" class="form-input" id="new-product-url" placeholder="https://example.com/product">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Supplier</label>
                                <input type="text" class="form-input" id="new-product-supplier" placeholder="Enter supplier name...">
                            </div>
                            <div class="form-group">
                                <label>Product Image (optional)</label>
                                <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 16px; text-align: center; background: var(--bg-hover);">
                                    <input type="file" class="form-input" id="new-product-image" accept="image/*" onchange="previewProductImage(this)" style="display: none;">
                                    <div id="product-image-preview" style="display: none; margin-bottom: 12px;">
                                        <img id="product-image-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover;">
                                    </div>
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('new-product-image').click()" style="margin: 0;">
                                        <i class="fas fa-image"></i> Choose Photo
                                    </button>
                                    <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 12px;">Optional - Click to select an image</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" id="save-product-btn" onclick="saveProduct()">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                    `;
                    break;
                case 'add-thief':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-user-secret"></i> Add Theft Record</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" class="form-input" id="thief-name" placeholder="Enter name or description...">
                                </div>
                                <div class="form-group">
                                    <label>Date of Incident *</label>
                                    <input type="date" class="form-input" id="thief-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="thief-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Crime Type *</label>
                                    <select class="form-input" id="thief-crime-type">
                                        <option value="">Select type...</option>
                                        <option value="Shoplifting">Shoplifting</option>
                                        <option value="Attempted Theft">Attempted Theft</option>
                                        <option value="Robbery">Robbery</option>
                                        <option value="Fraud">Fraud</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Items Stolen *</label>
                                    <input type="text" class="form-input" id="thief-items" placeholder="e.g., Vape devices (2x)">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Value ($) *</label>
                                    <input type="number" step="0.01" class="form-input" id="thief-value" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea class="form-input" id="thief-description" rows="3" placeholder="Describe the incident in detail..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Police Report #</label>
                                    <input type="text" class="form-input" id="thief-police-report" placeholder="e.g., PR-2025-12-10-001">
                                </div>
                                <div class="form-group">
                                    <label>Status *</label>
                                    <select class="form-input" id="thief-status">
                                        <option value="banned">Banned</option>
                                        <option value="warning">Warning</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Photo (Optional)</label>
                                <input type="file" class="form-input" id="thief-photo" accept="image/*" onchange="previewThiefPhoto(this)">
                                <div id="thief-photo-preview" style="margin-top: 10px; display: none;">
                                    <img id="thief-photo-img" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveThief()">
                                <i class="fas fa-plus"></i> Add Record
                            </button>
                        </div>
                    `;
                    break;
                case 'edit-thief':
                    if (!data) {
                        alert('No thief data provided');
                        return;
                    }
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-user-secret"></i> Edit Theft Record</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" class="form-input" id="edit-thief-name" value="${data.name || ''}" placeholder="Enter name or description...">
                                </div>
                                <div class="form-group">
                                    <label>Date of Incident</label>
                                    <input type="date" class="form-input" id="edit-thief-date" value="${data.date || ''}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="edit-thief-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar" ${data.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                        <option value="Morena" ${data.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                        <option value="Kearny Mesa" ${data.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                        <option value="Chula Vista" ${data.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                        <option value="North Park" ${data.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                        <option value="Miramar Wine & Liquor" ${data.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Crime Type</label>
                                    <select class="form-input" id="edit-thief-crime-type">
                                        <option value="">Select type...</option>
                                        <option value="Shoplifting" ${data.crimeType === 'Shoplifting' ? 'selected' : ''}>Shoplifting</option>
                                        <option value="Attempted Theft" ${data.crimeType === 'Attempted Theft' ? 'selected' : ''}>Attempted Theft</option>
                                        <option value="Robbery" ${data.crimeType === 'Robbery' ? 'selected' : ''}>Robbery</option>
                                        <option value="Fraud" ${data.crimeType === 'Fraud' ? 'selected' : ''}>Fraud</option>
                                        <option value="Other" ${data.crimeType === 'Other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Items Stolen</label>
                                    <input type="text" class="form-input" id="edit-thief-items" value="${data.itemsStolen || ''}" placeholder="e.g., Vape devices (2x)">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Value ($)</label>
                                    <input type="number" step="0.01" class="form-input" id="edit-thief-value" value="${data.estimatedValue || ''}" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="edit-thief-description" rows="3" placeholder="Describe the incident in detail...">${data.description || ''}</textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Police Report #</label>
                                    <input type="text" class="form-input" id="edit-thief-police-report" value="${data.policeReport || ''}" placeholder="e.g., PR-2025-12-10-001">
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select class="form-input" id="edit-thief-status">
                                        <option value="banned" ${data.banned ? 'selected' : ''}>Banned</option>
                                        <option value="warning" ${!data.banned ? 'selected' : ''}>Warning</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Photo (leave empty to keep current)</label>
                                <input type="file" class="form-input" id="edit-thief-photo" accept="image/*" onchange="previewEditThiefPhoto(this)">
                                <div id="edit-thief-photo-preview" style="margin-top: 10px; ${data.photo ? '' : 'display: none;'}">
                                    <img id="edit-thief-photo-img" src="${data.photo || ''}" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveEditedThief()">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    `;
                    break;
                case 'add-invoice':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-file-invoice-dollar"></i> Add Invoice</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Invoice Number</label>
                                    <input type="text" class="form-input" id="invoice-number" placeholder="e.g., INV-2025-004">
                                </div>
                                <div class="form-group">
                                    <label>Vendor</label>
                                    <input type="text" class="form-input" id="invoice-vendor" placeholder="Enter vendor name...">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category</label>
                                    <select class="form-input" id="invoice-category">
                                        <option value="">Select category...</option>
                                        <option value="utilities">Utilities</option>
                                        <option value="rent">Rent</option>
                                        <option value="supplies">Supplies</option>
                                        <option value="inventory">Inventory</option>
                                        <option value="services">Services</option>
                                        <option value="equipment">Equipment</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="invoice-store">
                                        <option value="">Unassigned</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Amount ($)</label>
                                    <input type="number" step="0.01" class="form-input" id="invoice-amount" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Due Date</label>
                                    <input type="date" class="form-input" id="invoice-due-date">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" class="form-input" id="invoice-description" placeholder="Enter description...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Status</label>
                                    <select class="form-input" id="invoice-status">
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                        <option value="overdue">Overdue</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Payment Account</label>
                                    <select class="form-input" id="invoice-payment-account">
                                        <option value="">Select account...</option>
                                        <option value="Shop App">Shop App</option>
                                        <option value="Personal Account">Personal Account</option>
                                        <option value="Business Account">Business Account</option>
                                        <option value="PayPal">PayPal</option>
                                        <option value="Credit Card">Credit Card</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="invoice-recurring" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                    <span>Recurring Invoice</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Invoice File (Photo or PDF)</label>
                                <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 16px; text-align: center; background: var(--bg-hover);">
                                    <input type="file" class="form-input" id="invoice-photo" accept="image/*,.pdf,application/pdf" onchange="previewInvoiceFile(this)" style="display: none;">
                                    <div id="invoice-photo-preview" style="display: none; margin-bottom: 12px;">
                                        <img id="invoice-photo-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover;">
                                    </div>
                                    <div id="invoice-pdf-preview" style="display: none; margin-bottom: 12px;">
                                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                            <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444;"></i>
                                            <div style="text-align: left;">
                                                <div id="invoice-pdf-name" style="font-weight: 600;"></div>
                                                <div id="invoice-pdf-size" style="font-size: 12px; color: var(--text-muted);"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('invoice-photo').click()" style="margin: 0;">
                                        <i class="fas fa-upload"></i> Upload File
                                    </button>
                                    <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 12px;">Upload a photo or PDF of the invoice (max 1MB)</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-input" id="invoice-notes" rows="2" placeholder="Add any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn-primary" onclick="saveInvoice()">
                                <i class="fas fa-plus"></i> Add Invoice
                            </button>
                        </div>
                    `;
                    break;
                case 'restock-request':
                    const itemId = modal.dataset.itemId;
                    const item = inventory.find(i => i.id == itemId);
                    content = `
                        <div class="modal-header">
                            <h2>New Restock Request</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Item *</label>
                                <input type="text" class="form-input" id="restock-item" value="${item.brand} ${item.productName} - ${item.flavor}" readonly style="background: var(--bg-hover);">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="restock-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="restock-modal-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Qty on Hand *</label>
                                    <input type="number" class="form-input" id="restock-qty-hand" placeholder="Current quantity in stock" value="${item.stock}">
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <input type="checkbox" id="customer-request" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                        <span>Customer Request</span>
                                    </label>
                                    <input type="text" class="form-input" id="customer-info" placeholder="Customer name or info..." disabled style="background: var(--bg-hover);">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea class="form-input" id="restock-modal-notes" rows="3" placeholder="Add any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="submitRestockFromModal('${itemId}')">Request</button>
                        </div>
                    `;
                    break;
                case 'new-restock-request':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-box"></i> New Restock Request</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Item Type *</label>
                                    <select class="form-input" id="new-restock-item-type">
                                        <option value="product">Product</option>
                                        <option value="supply">Supply</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Product/Supply Name *</label>
                                    <input type="text" class="form-input" id="new-restock-product" placeholder="Enter name...">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Brand</label>
                                    <select class="form-input" id="new-restock-brand">
                                        <option value="">Select brand...</option>
                                        <option value="Elf Bar">Elf Bar</option>
                                        <option value="Lost Mary">Lost Mary</option>
                                        <option value="Funky Republic">Funky Republic</option>
                                        <option value="Puff Bar">Puff Bar</option>
                                        <option value="JUUL">JUUL</option>
                                        <option value="SMOK">SMOK</option>
                                        <option value="Vuse">Vuse</option>
                                        <option value="Hyde">Hyde</option>
                                        <option value="Breeze">Breeze</option>
                                        <option value="Geek Bar">Geek Bar</option>
                                        <option value="RAZ">RAZ</option>
                                        <option value="Orion">Orion</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Flavor/Variant</label>
                                    <select class="form-input" id="new-restock-flavor">
                                        <option value="">Select flavor...</option>
                                        <option value="Strawberry">Strawberry</option>
                                        <option value="Watermelon">Watermelon</option>
                                        <option value="Blue Razz">Blue Razz</option>
                                        <option value="Mango">Mango</option>
                                        <option value="Grape">Grape</option>
                                        <option value="Mint">Mint</option>
                                        <option value="Menthol">Menthol</option>
                                        <option value="Tobacco">Tobacco</option>
                                        <option value="Mixed Berry">Mixed Berry</option>
                                        <option value="Peach">Peach</option>
                                        <option value="Lemon">Lemon</option>
                                        <option value="Apple">Apple</option>
                                        <option value="Cherry">Cherry</option>
                                        <option value="Pineapple">Pineapple</option>
                                        <option value="Cotton Candy">Cotton Candy</option>
                                        <option value="Vanilla">Vanilla</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity Requested *</label>
                                    <input type="number" class="form-input" id="new-restock-quantity" placeholder="Enter quantity...">
                                </div>
                                <div class="form-group">
                                    <label>Priority *</label>
                                    <select class="form-input" id="new-restock-priority">
                                        <option value="">Select priority...</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="new-restock-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="new-restock-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Requested By *</label>
                                    <select class="form-input" id="new-restock-requested-by">
                                        <option value="">Select employee...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <input type="checkbox" id="new-restock-customer-request" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                        <span>Customer Request</span>
                                    </label>
                                    <input type="text" class="form-input" id="new-restock-customer-info" placeholder="Customer name or info..." disabled style="background: var(--bg-hover);">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea class="form-input" id="new-restock-notes" rows="3" placeholder="Add any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="submitNewRestockRequest()">Submit Request</button>
                        </div>
                    `;
                    break;
                case 'edit-restock-request':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Restock Request</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Item Type *</label>
                                    <select class="form-input" id="edit-restock-item-type">
                                        <option value="product">Product</option>
                                        <option value="supply">Supply</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Product/Supply Name *</label>
                                    <input type="text" class="form-input" id="edit-restock-product" placeholder="Enter name...">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Brand</label>
                                    <select class="form-input" id="edit-restock-brand">
                                        <option value="">Select brand...</option>
                                        <option value="Elf Bar">Elf Bar</option>
                                        <option value="Lost Mary">Lost Mary</option>
                                        <option value="Funky Republic">Funky Republic</option>
                                        <option value="Puff Bar">Puff Bar</option>
                                        <option value="JUUL">JUUL</option>
                                        <option value="SMOK">SMOK</option>
                                        <option value="Vuse">Vuse</option>
                                        <option value="Hyde">Hyde</option>
                                        <option value="Breeze">Breeze</option>
                                        <option value="Geek Bar">Geek Bar</option>
                                        <option value="RAZ">RAZ</option>
                                        <option value="Orion">Orion</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Flavor/Variant</label>
                                    <select class="form-input" id="edit-restock-flavor">
                                        <option value="">Select flavor...</option>
                                        <option value="Strawberry">Strawberry</option>
                                        <option value="Watermelon">Watermelon</option>
                                        <option value="Blue Razz">Blue Razz</option>
                                        <option value="Mango">Mango</option>
                                        <option value="Grape">Grape</option>
                                        <option value="Mint">Mint</option>
                                        <option value="Menthol">Menthol</option>
                                        <option value="Tobacco">Tobacco</option>
                                        <option value="Mixed Berry">Mixed Berry</option>
                                        <option value="Peach">Peach</option>
                                        <option value="Lemon">Lemon</option>
                                        <option value="Apple">Apple</option>
                                        <option value="Cherry">Cherry</option>
                                        <option value="Pineapple">Pineapple</option>
                                        <option value="Cotton Candy">Cotton Candy</option>
                                        <option value="Vanilla">Vanilla</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity Requested *</label>
                                    <input type="number" class="form-input" id="edit-restock-quantity" placeholder="Enter quantity...">
                                </div>
                                <div class="form-group">
                                    <label>Priority *</label>
                                    <select class="form-input" id="edit-restock-priority">
                                        <option value="">Select priority...</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="edit-restock-date">
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="edit-restock-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Requested By *</label>
                                <select class="form-input" id="edit-restock-requested-by">
                                    <option value="">Select employee...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea class="form-input" id="edit-restock-notes" rows="3" placeholder="Add any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="submitEditRestockRequest()">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'create-cashout':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-money-bill-wave"></i> Add Cash Out</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Description *</label>
                                    <input type="text" class="form-input" id="cashout-name" placeholder="e.g., Office Supplies, Bank Deposit...">
                                </div>
                                <div class="form-group">
                                    <label>Amount *</label>
                                    <input type="number" step="0.01" class="form-input" id="cashout-amount" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="cashout-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-input" id="cashout-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-input" id="cashout-reason" rows="2" placeholder="Additional notes (optional)..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="createCashOut()">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    `;
                    break;
                case 'close-cashout':
                    const cashoutId = arguments[1];
                    const cashoutRecord = cashOutRecords.find(r => r.id === cashoutId || r.firestoreId === cashoutId);
                    if (!cashoutRecord) break;

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-check-circle"></i> Close Cash Out</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">Cash Out Name:</span>
                                    <strong>${cashoutRecord.name}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Amount Given:</span>
                                    <strong style="color: var(--accent-primary); font-size: 18px;">$${cashoutRecord.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Receipt Photo *</label>
                                <div class="file-upload">
                                    <input type="file" id="cashout-receipt-photo" accept="image/*">
                                    <div class="file-upload-content">
                                        <i class="fas fa-camera"></i>
                                        <span>Click to upload receipt photo</span>
                                        <small>JPG, PNG, or GIF</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Amount Spent *</label>
                                <input type="number" step="0.01" class="form-input" id="cashout-amount-spent" placeholder="0.00" max="${cashoutRecord.amount}">
                                <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                                    Maximum: $${cashoutRecord.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </small>
                            </div>

                            <div class="form-group">
                                <label>Is there money left? *</label>
                                <div style="display: flex; gap: 24px; margin-top: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="money-left" id="cashout-money-left-yes" value="yes" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                        <span>Yes, there is money left</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="money-left" id="cashout-money-left-no" value="no" checked style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                        <span>No, all money was spent</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="closeCashOut('${cashoutRecord.firestoreId || cashoutRecord.id}')">
                                <i class="fas fa-check"></i>
                                Close Cash Out
                            </button>
                        </div>
                    `;
                    break;
                case 'create-issue':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-exclamation-triangle"></i> Create Issue</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Customer Name</label>
                                    <input type="text" class="form-input" id="issue-customer" placeholder="Enter customer name...">
                                </div>
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="tel" class="form-input" id="issue-phone" placeholder="(555) 555-5555" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Issue Type</label>
                                    <select class="form-input" id="issue-type">
                                        <option value="">Select type...</option>
                                        <option value="In Store">In Store</option>
                                        <option value="Online">Online</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="issue-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Incident Date</label>
                                <input type="date" class="form-input" id="issue-incident-date" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Brief Description</label>
                                <textarea class="form-input" id="issue-description" rows="3" placeholder="Describe the issue briefly..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Customer Perception When Leaving</label>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">How did the customer feel when leaving the store?</p>
                                <div id="perception-selector" style="display: flex; justify-content: space-between; gap: 8px;">
                                    <button type="button" class="perception-btn" data-value="1" onclick="selectPerception(1)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;"></div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Very Upset</div>
                                    </button>
                                    <button type="button" class="perception-btn" data-value="2" onclick="selectPerception(2)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;"></div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Upset</div>
                                    </button>
                                    <button type="button" class="perception-btn" data-value="3" onclick="selectPerception(3)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;"></div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Neutral</div>
                                    </button>
                                    <button type="button" class="perception-btn" data-value="4" onclick="selectPerception(4)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;"></div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Satisfied</div>
                                    </button>
                                    <button type="button" class="perception-btn" data-value="5" onclick="selectPerception(5)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;"></div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Happy</div>
                                    </button>
                                </div>
                                <input type="hidden" id="issue-perception" value="">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="createIssue()">
                                <i class="fas fa-plus"></i>
                                Create Issue
                            </button>
                        </div>
                    `;
                    break;
                case 'resolve-issue':
                    const issueId = arguments[1];
                    const issue = issues.find(i => i.id === issueId);
                    if (!issue) break;

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-check-circle"></i> Resolve Issue</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">Customer:</span>
                                    <strong>${issue.customer}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">Type:</span>
                                    <span class="badge" style="background: ${issue.type === 'In Store' ? 'var(--accent-primary)' : 'var(--info)'};">
                                        ${issue.type}
                                    </span>
                                </div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Issue Description:</div>
                                    <div style="font-size: 14px;">${issue.description}</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>How was it resolved? *</label>
                                <textarea class="form-input" id="issue-solution" rows="4" placeholder="Describe how the issue was resolved..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Responsible Person *</label>
                                <input type="text" class="form-input" id="issue-resolved-by" placeholder="Who handled this issue?" value="Carlos Admin">
                            </div>

                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-top: 16px;">
                                <div style="font-size: 13px; color: var(--text-muted);">
                                    <i class="fas fa-info-circle"></i>
                                    Resolution date will be set to today automatically
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="resolveIssue('${issueId}')">
                                <i class="fas fa-check"></i>
                                Mark as Resolved
                            </button>
                        </div>
                    `;
                    break;
                case 'create-vendor':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-truck"></i> Add Vendor</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Vendor Name *</label>
                                <input type="text" class="form-input" id="vendor-name" placeholder="Enter vendor name...">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select class="form-input" id="vendor-category">
                                        <option value="">Select category...</option>
                                        <option value="Vape Products">Vape Products</option>
                                        <option value="Tobacco Products">Tobacco Products</option>
                                        <option value="Beverages">Beverages</option>
                                        <option value="Snacks & Candy">Snacks & Candy</option>
                                        <option value="Store Supplies">Store Supplies</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Contact Person *</label>
                                    <input type="text" class="form-input" id="vendor-contact" placeholder="Contact name...">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" class="form-input" id="vendor-phone" placeholder="(800) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" class="form-input" id="vendor-email" placeholder="contact@vendor.com">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Website (Optional)</label>
                                    <input type="url" class="form-input" id="vendor-website" placeholder="https://www.vendor.com" pattern="https?://.+">
                                </div>
                                <div class="form-group">
                                    <label>Access Info (Optional)</label>
                                    <input type="text" class="form-input" id="vendor-access" placeholder="Account #, login details, etc.">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>What We Buy *</label>
                                <textarea class="form-input" id="vendor-products" rows="3" placeholder="List products purchased from this vendor..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>How to Order *</label>
                                <textarea class="form-input" id="vendor-order-methods" rows="2" placeholder="Online portal, phone, email, etc."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Additional Notes (Optional)</label>
                                <textarea class="form-input" id="vendor-notes" rows="2" placeholder="Payment terms, delivery schedules, etc."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="createVendor()">
                                <i class="fas fa-plus"></i>
                                Add Vendor
                            </button>
                        </div>
                    `;
                    break;
                case 'edit-vendor':
                    const editVendorId = arguments[1];
                    const editVendor = vendors.find(v => v.id === editVendorId);
                    if (!editVendor) break;

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Vendor</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Vendor Name *</label>
                                <input type="text" class="form-input" id="edit-vendor-name" placeholder="Enter vendor name..." value="${editVendor.name}">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select class="form-input" id="edit-vendor-category">
                                        <option value="">Select category...</option>
                                        <option value="Vape Products" ${editVendor.category === 'Vape Products' ? 'selected' : ''}>Vape Products</option>
                                        <option value="Tobacco Products" ${editVendor.category === 'Tobacco Products' ? 'selected' : ''}>Tobacco Products</option>
                                        <option value="Beverages" ${editVendor.category === 'Beverages' ? 'selected' : ''}>Beverages</option>
                                        <option value="Snacks & Candy" ${editVendor.category === 'Snacks & Candy' ? 'selected' : ''}>Snacks & Candy</option>
                                        <option value="Store Supplies" ${editVendor.category === 'Store Supplies' ? 'selected' : ''}>Store Supplies</option>
                                        <option value="Other" ${editVendor.category === 'Other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Contact Person *</label>
                                    <input type="text" class="form-input" id="edit-vendor-contact" placeholder="Contact name..." value="${editVendor.contact}">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" class="form-input" id="edit-vendor-phone" placeholder="(800) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14" value="${editVendor.phone}">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" class="form-input" id="edit-vendor-email" placeholder="contact@vendor.com" value="${editVendor.email}">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Website (Optional)</label>
                                    <input type="url" class="form-input" id="edit-vendor-website" placeholder="https://www.vendor.com" pattern="https?://.+" value="${editVendor.website || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Access Info (Optional)</label>
                                    <input type="text" class="form-input" id="edit-vendor-access" placeholder="Account #, login details, etc." value="${editVendor.access || ''}">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>What We Buy *</label>
                                <textarea class="form-input" id="edit-vendor-products" rows="3" placeholder="List products purchased from this vendor...">${editVendor.products}</textarea>
                            </div>

                            <div class="form-group">
                                <label>How to Order *</label>
                                <textarea class="form-input" id="edit-vendor-order-methods" rows="2" placeholder="Online portal, phone, email, etc.">${editVendor.orderMethods}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Additional Notes (Optional)</label>
                                <textarea class="form-input" id="edit-vendor-notes" rows="2" placeholder="Payment terms, delivery schedules, etc.">${editVendor.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="editVendor('${editVendorId}')">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                    `;
                    break;
                case 'add-expense':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-wallet"></i> New Expense</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Description *</label>
                                <input type="text" class="form-input" id="expense-description" placeholder="What did you spend on?">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Amount *</label>
                                    <input type="number" step="0.01" class="form-input" id="expense-amount" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select class="form-input" id="expense-category">
                                        <option value="">Select category...</option>
                                        <option value="Food"> Food</option>
                                        <option value="Home"> Home</option>
                                        <option value="Subscriptions"> Subscriptions</option>
                                        <option value="Health"> Health</option>
                                        <option value="Gifts"> Gifts</option>
                                        <option value="Others"> Others</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" class="form-input" id="expense-date" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="addExpense()">
                                <i class="fas fa-plus"></i>
                                Add Expense
                            </button>
                        </div>
                    `;
                    break;
                case 'add-treasury':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-gem"></i> Add Treasury Piece</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- Image Upload Section -->
                            <div class="form-group">
                                <label>Piece Image</label>
                                <div style="display: flex; align-items: start; gap: 16px;">
                                    <div id="treasury-image-preview" style="width: 120px; height: 120px; border-radius: 12px; border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden; flex-shrink: 0;">
                                        <i class="fas fa-gem" style="font-size: 36px; color: var(--text-muted);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="treasury-image" accept="image/*" style="display: none;" onchange="previewTreasuryImage(this)">
                                        <button type="button" class="btn-secondary" onclick="document.getElementById('treasury-image').click()" style="margin-bottom: 8px;">
                                            <i class="fas fa-upload"></i> Upload Image
                                        </button>
                                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Recommended: Square image, max 2MB</p>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Artwork Name *</label>
                                <input type="text" class="form-input" id="treasury-artwork-name" placeholder="Enter artwork name...">
                            </div>
                            <div class="form-group">
                                <label>Artist</label>
                                <input type="text" class="form-input" id="treasury-artist" placeholder="Artist name...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Acquisition Date</label>
                                    <input type="date" class="form-input" id="treasury-acquisition-date">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Value (USD)</label>
                                    <input type="number" step="0.01" class="form-input" id="treasury-value" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Current Location *</label>
                                <select class="form-input" id="treasury-location">
                                    <option value="">Select location...</option>
                                    <option value="VSU Miramar">VSU Miramar</option>
                                    <option value="VSU Morena">VSU Morena</option>
                                    <option value="VSU Kearny Mesa">VSU Kearny Mesa</option>
                                    <option value="VSU North Park">VSU North Park</option>
                                    <option value="VSU Chula Vista">VSU Chula Vista</option>
                                    <option value="VSU North Park">VSU North Park</option>
                                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="treasury-description" rows="4" placeholder="Add details about the piece..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveTreasuryItem(false)">
                                <i class="fas fa-save"></i>
                                Add Piece
                            </button>
                        </div>
                    `;
                    break;
                case 'edit-treasury':
                    const treasuryId = arguments[1];
                    const treasuryItem = treasuryItems.find(t => t.id === treasuryId);
                    if (!treasuryItem) break;

                    // Get the main image (first photo or image field)
                    const treasuryEditImage = treasuryItem.image || (treasuryItem.photos && treasuryItem.photos.length > 0 ? treasuryItem.photos[0] : null);

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Treasury Piece</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- Image Upload Section -->
                            <div class="form-group">
                                <label>Piece Image</label>
                                <div style="display: flex; align-items: start; gap: 16px;">
                                    <div id="treasury-image-preview" style="width: 120px; height: 120px; border-radius: 12px; border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden; flex-shrink: 0;">
                                        ${treasuryEditImage ? `<img src="${treasuryEditImage}" style="width: 100%; height: 100%; object-fit: cover;">` : `<i class="fas fa-gem" style="font-size: 36px; color: var(--text-muted);"></i>`}
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="treasury-image" accept="image/*" style="display: none;" onchange="previewTreasuryImage(this)">
                                        <button type="button" class="btn-secondary" onclick="document.getElementById('treasury-image').click()" style="margin-bottom: 8px;">
                                            <i class="fas fa-upload"></i> ${treasuryEditImage ? 'Change Image' : 'Upload Image'}
                                        </button>
                                        ${treasuryEditImage ? `<button type="button" class="btn-secondary" onclick="removeTreasuryImage()" style="margin-left: 8px; margin-bottom: 8px;"><i class="fas fa-trash"></i></button>` : ''}
                                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Recommended: Square image, max 2MB</p>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Artwork Name *</label>
                                <input type="text" class="form-input" id="treasury-artwork-name" placeholder="Enter artwork name..." value="${treasuryItem.artworkName || ''}">
                            </div>
                            <div class="form-group">
                                <label>Artist</label>
                                <input type="text" class="form-input" id="treasury-artist" placeholder="Artist name..." value="${treasuryItem.artist || ''}">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Acquisition Date</label>
                                    <input type="date" class="form-input" id="treasury-acquisition-date" value="${treasuryItem.acquisitionDate || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Value (USD)</label>
                                    <input type="number" step="0.01" class="form-input" id="treasury-value" placeholder="0.00" value="${treasuryItem.value || ''}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Current Location *</label>
                                <select class="form-input" id="treasury-location">
                                    <option value="">Select location...</option>
                                    <option value="VSU Miramar" ${treasuryItem.location === 'VSU Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                    <option value="VSU Morena" ${treasuryItem.location === 'VSU Morena' ? 'selected' : ''}>VSU Morena</option>
                                    <option value="VSU Kearny Mesa" ${treasuryItem.location === 'VSU Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                    <option value="VSU North Park" ${treasuryItem.location === 'VSU North Park' ? 'selected' : ''}>VSU North Park</option>
                                    <option value="VSU Chula Vista" ${treasuryItem.location === 'VSU Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                    <option value="Miramar Wine & Liquor" ${treasuryItem.location === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="treasury-description" rows="4" placeholder="Add details about the piece...">${treasuryItem.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveTreasuryItem(true, ${treasuryId})">
                                <i class="fas fa-save"></i>
                                Update Piece
                            </button>
                        </div>
                    `;
                    break;
                case 'add-change':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-coins"></i> Add Change Record</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Photo of Envelope/Receipt (Optional)</label>
                                <div style="display: flex; align-items: flex-start; gap: 16px;">
                                    <div id="change-photo-preview" style="width: 120px; height: 120px; border-radius: 12px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed var(--border-color); cursor: pointer;" onclick="document.getElementById('change-photo').click()">
                                        <i class="fas fa-coins" style="font-size: 36px; color: var(--text-muted);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="change-photo" accept="image/*" style="display: none;" onchange="previewChangePhoto(this)">
                                        <button type="button" class="btn-secondary" onclick="document.getElementById('change-photo').click()" style="margin-bottom: 8px;">
                                            <i class="fas fa-upload"></i> Upload Image
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="removeChangePhoto()" style="margin-left: 8px; margin-bottom: 8px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Upload a photo of the envelope or receipt (optional)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store / Location *</label>
                                    <select class="form-input" id="change-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="change-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>

                            <!-- Currency Breakdown Section -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin: 16px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <label style="font-weight: 600; color: var(--text-primary); margin: 0;">
                                        <i class="fas fa-money-bill-wave" style="color: var(--success);"></i> Currency Breakdown *
                                    </label>
                                    <div style="font-size: 18px; font-weight: 700; color: var(--accent-primary);">
                                        Total: $<span id="change-total-display">0.00</span>
                                    </div>
                                </div>

                                <!-- Bills -->
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Bills</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$100</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="100" id="change-bills-100" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$50</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="50" id="change-bills-50" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$20</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="20" id="change-bills-20" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$10</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="10" id="change-bills-10" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$5</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="5" id="change-bills-5" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$2</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="2" id="change-bills-2" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$1</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="1" id="change-bills-1" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                    </div>
                                </div>

                                <!-- Coins -->
                                <div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Coins</div>
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$1 coin</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="1" id="change-coins-100" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">50垄</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.50" id="change-coins-50" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">25垄</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.25" id="change-coins-25" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">10垄</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.10" id="change-coins-10" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">5垄</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.05" id="change-coins-5" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">1垄</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.01" id="change-coins-1" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Change in Store Section -->
                            <div style="background: linear-gradient(135deg, #10b98115, #10b98108); border: 2px solid #10b98140; border-radius: 12px; padding: 16px; margin: 16px 0;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div style="width: 40px; height: 40px; background: #10b98120; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-cash-register" style="color: #10b981; font-size: 18px;"></i>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: var(--text-primary); margin: 0; display: block;">Change in Store</label>
                                        <span style="font-size: 12px; color: var(--text-muted);">Amount of change currently available in the register</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 24px; font-weight: 600; color: #10b981;">$</span>
                                    <input type="number" step="0.01" min="0" class="form-input" id="change-in-store" placeholder="0.00" style="font-size: 20px; font-weight: 600; text-align: center; max-width: 200px;">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Left By (Person who left the change) *</label>
                                    <input type="text" class="form-input" id="change-left-by" placeholder="Name of person...">
                                </div>
                                <div class="form-group">
                                    <label>Received By (Person who received it) *</label>
                                    <input type="text" class="form-input" id="change-received-by" placeholder="Name of person...">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea class="form-input" id="change-notes" rows="3" placeholder="e.g., 'Se dej贸 en caja 1', 'Se meti贸 extra por falta de cambio'..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveChangeRecord()">
                                <i class="fas fa-save"></i>
                                Save Record
                            </button>
                        </div>
                    `;
                    break;

                case 'add-risknote':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-shield-halved"></i> New Risk Note</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-input" id="risknote-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="risknote-store">
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Type of Behavior</label>
                                <select class="form-input" id="risknote-type">
                                    <option value="strange_questions">Strange Questions</option>
                                    <option value="unusual_purchase">Unusual Purchase</option>
                                    <option value="recording">Recording / Taking Photos</option>
                                    <option value="policy_violation">Policy Violation Attempt</option>
                                    <option value="suspicious_attitude">Suspicious Attitude</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="risknote-description" rows="3" placeholder="Describe what happened..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Risk Level</label>
                                <div style="display: flex; gap: 12px;">
                                    <button type="button" class="risk-level-btn" data-level="low" onclick="selectRiskLevel('low')" style="flex: 1; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 20px; margin-bottom: 4px; color: #22c55e;"></div>
                                        <div style="font-size: 12px; font-weight: 600;">Low</div>
                                    </button>
                                    <button type="button" class="risk-level-btn" data-level="medium" onclick="selectRiskLevel('medium')" style="flex: 1; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 20px; margin-bottom: 4px; color: #f59e0b;"></div>
                                        <div style="font-size: 12px; font-weight: 600;">Medium</div>
                                    </button>
                                    <button type="button" class="risk-level-btn" data-level="high" onclick="selectRiskLevel('high')" style="flex: 1; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 20px; margin-bottom: 4px; color: #ef4444;"></div>
                                        <div style="font-size: 12px; font-weight: 600;">High</div>
                                    </button>
                                </div>
                                <input type="hidden" id="risknote-level" value="low">
                            </div>
                            <div class="form-group">
                                <label>Reported By</label>
                                <input type="text" class="form-input" id="risknote-reporter" placeholder="Your name...">
                            </div>
                            <div class="form-group">
                                <label>Photo (Optional)</label>
                                <div style="border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; background: var(--bg-hover);">
                                    <input type="file" id="risknote-photo" accept="image/*" onchange="previewRiskNotePhoto(this)" style="display: none;">
                                    <div id="risknote-photo-preview" style="display: none; margin-bottom: 12px;">
                                        <img id="risknote-photo-img" style="max-width: 100%; max-height: 150px; border-radius: 8px; object-fit: cover;">
                                    </div>
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('risknote-photo').click()" style="margin: 0;">
                                        <i class="fas fa-camera"></i> Upload Photo
                                    </button>
                                    <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 12px;">Add photo evidence if available</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Manager Note (Optional)</label>
                                <textarea class="form-input" id="risknote-manager-note" rows="2" placeholder="Internal notes for management..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveRiskNote()">
                                <i class="fas fa-save"></i> Save Note
                            </button>
                        </div>
                    `;
                    break;

                case 'add-gift':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-gift"></i> Register Gift</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Product Name</label>
                                    <input type="text" class="form-input" id="gift-product" placeholder="e.g., Vape Pen SMOK Nord 4">
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-input" id="gift-quantity" value="1" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Value ($)</label>
                                    <input type="number" step="0.01" class="form-input" id="gift-value" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Recipient Name</label>
                                    <input type="text" class="form-input" id="gift-recipient" placeholder="Name of person receiving the gift">
                                </div>
                                <div class="form-group">
                                    <label>Recipient Type</label>
                                    <select class="form-input" id="gift-recipient-type">
                                        <option value="">Select type...</option>
                                        <option value="customer">Customer</option>
                                        <option value="vendor">Vendor</option>
                                        <option value="employee">Employee</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Reason for Gift</label>
                                <textarea class="form-input" id="gift-reason" rows="2" placeholder="e.g., Defective product replacement, compensation for error, promotional gift..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="gift-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-input" id="gift-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea class="form-input" id="gift-notes" rows="2" placeholder="Any additional details..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Photo of Gift</label>
                                <div class="file-upload">
                                    <input type="file" id="gift-photo" accept="image/*">
                                    <div class="file-upload-content">
                                        <i class="fas fa-camera"></i>
                                        <span>Click to upload photo</span>
                                        <small>JPG, PNG, GIF accepted</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveGift()">
                                <i class="fas fa-save"></i>
                                Save Gift
                            </button>
                        </div>
                    `;
                    break;

                case 'edit-gift':
                    const editGiftRecord = giftsRecords.find(r => r.id === data);
                    if (!editGiftRecord) {
                        content = '<div class="modal-body"><p>Gift record not found</p></div>';
                        break;
                    }
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Gift</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Product Name</label>
                                    <input type="text" class="form-input" id="gift-product" value="${editGiftRecord.product || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-input" id="gift-quantity" value="${editGiftRecord.quantity || 1}" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Value ($)</label>
                                    <input type="number" step="0.01" class="form-input" id="gift-value" value="${editGiftRecord.value || ''}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Recipient Name</label>
                                    <input type="text" class="form-input" id="gift-recipient" value="${editGiftRecord.recipient || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Recipient Type</label>
                                    <select class="form-input" id="gift-recipient-type">
                                        <option value="">Select type...</option>
                                        <option value="customer" ${editGiftRecord.recipientType === 'customer' ? 'selected' : ''}>Customer</option>
                                        <option value="vendor" ${editGiftRecord.recipientType === 'vendor' ? 'selected' : ''}>Vendor</option>
                                        <option value="employee" ${editGiftRecord.recipientType === 'employee' ? 'selected' : ''}>Employee</option>
                                        <option value="other" ${editGiftRecord.recipientType === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Reason for Gift</label>
                                <textarea class="form-input" id="gift-reason" rows="2">${editGiftRecord.reason || ''}</textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="gift-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar" ${editGiftRecord.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                        <option value="Morena" ${editGiftRecord.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                        <option value="Kearny Mesa" ${editGiftRecord.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                        <option value="Chula Vista" ${editGiftRecord.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                        <option value="North Park" ${editGiftRecord.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                        <option value="Miramar Wine & Liquor" ${editGiftRecord.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-input" id="gift-date" value="${editGiftRecord.date || ''}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea class="form-input" id="gift-notes" rows="2">${editGiftRecord.notes || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Photo of Gift</label>
                                <div class="file-upload">
                                    <input type="file" id="gift-photo" accept="image/*">
                                    <div class="file-upload-content">
                                        <i class="fas fa-camera"></i>
                                        <span>Click to upload new photo</span>
                                        <small>JPG, PNG, GIF accepted</small>
                                    </div>
                                </div>
                                ${editGiftRecord.photo ? `<img src="${editGiftRecord.photo}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;">` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveGift(true, '${String(editGiftRecord.id).replace(/'/g, "\\'")}')">
                                <i class="fas fa-save"></i>
                                Update Gift
                            </button>
                        </div>
                    `;
                    break;

                case 'add-schedule':
                    const scheduleEmployeeOptions = employees.map(emp =>
                        `<option value="${emp.id}">${emp.name} - ${emp.store}</option>`
                    ).join('');
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-calendar-plus"></i> Add Schedule</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Employee *</label>
                                    <select class="form-input" id="schedule-employee">
                                        <option value="">Select employee...</option>
                                        ${scheduleEmployeeOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="schedule-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="schedule-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Start Time *</label>
                                    <input type="time" class="form-input" id="schedule-start" value="09:00">
                                </div>
                                <div class="form-group">
                                    <label>End Time *</label>
                                    <input type="time" class="form-input" id="schedule-end" value="17:00">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveSchedule()">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                        </div>
                    `;
                    break;

                case 'quick-add-schedule':
                    const quickData = data || {};
                    const dayName = quickData.date ? new Date(quickData.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) : '';
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-clock"></i> Add Shift</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--bg-hover); padding: 12px 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--text-primary);">${quickData.employeeName || 'Employee'}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">${dayName} @ ${quickData.store || ''}</div>
                            </div>
                            <input type="hidden" id="schedule-employee" value="${quickData.employeeId || ''}">
                            <input type="hidden" id="schedule-store" value="${quickData.store || ''}">
                            <input type="hidden" id="schedule-date" value="${quickData.date || ''}">
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button type="button" class="shift-preset-btn" onclick="setShiftPreset('09:00', '17:00')" style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                                    <div style="font-weight: 600;">Morning</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">9am - 5pm</div>
                                </button>
                                <button type="button" class="shift-preset-btn" onclick="setShiftPreset('14:00', '22:00')" style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                                    <div style="font-weight: 600;">Evening</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">2pm - 10pm</div>
                                </button>
                                <button type="button" class="shift-preset-btn" onclick="setShiftPreset('10:00', '19:00')" style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                                    <div style="font-weight: 600;">Mid</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">10am - 7pm</div>
                                </button>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Start Time</label>
                                    <input type="time" class="form-input" id="schedule-start" value="09:00" style="font-size: 18px; padding: 12px;">
                                </div>
                                <div class="form-group">
                                    <label>End Time</label>
                                    <input type="time" class="form-input" id="schedule-end" value="17:00" style="font-size: 18px; padding: 12px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveSchedule()" style="min-width: 120px;">
                                <i class="fas fa-plus"></i> Add Shift
                            </button>
                        </div>
                    `;
                    break;

                case 'edit-schedule':
                    const editSchedule = schedules.find(s => s.id === data);
                    if (!editSchedule) {
                        content = '<div class="modal-body"><p>Schedule not found</p></div>';
                        break;
                    }
                    const editScheduleEmployeeOptions = employees.map(emp =>
                        `<option value="${emp.id}" ${emp.id === editSchedule.employeeId ? 'selected' : ''}>${emp.name} - ${emp.store}</option>`
                    ).join('');
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-calendar-edit"></i> Edit Schedule</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Employee *</label>
                                    <select class="form-input" id="schedule-employee">
                                        <option value="">Select employee...</option>
                                        ${editScheduleEmployeeOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="schedule-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar" ${editSchedule.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                        <option value="Morena" ${editSchedule.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                        <option value="Kearny Mesa" ${editSchedule.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                        <option value="Chula Vista" ${editSchedule.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                        <option value="North Park" ${editSchedule.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                        <option value="Miramar Wine & Liquor" ${editSchedule.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="schedule-date" value="${editSchedule.date || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Start Time *</label>
                                    <input type="time" class="form-input" id="schedule-start" value="${editSchedule.startTime || '09:00'}">
                                </div>
                                <div class="form-group">
                                    <label>End Time *</label>
                                    <input type="time" class="form-input" id="schedule-end" value="${editSchedule.endTime || '17:00'}">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="updateSchedule('${editSchedule.id}')">
                                <i class="fas fa-save"></i>
                                Update
                            </button>
                        </div>
                    `;
                    break;
            }

            modalContent.innerHTML = content;
            modal.classList.add('active');

            // Add event listener for customer request checkbox if it exists
            const customerCheckbox = document.getElementById('customer-request');
            if (customerCheckbox) {
                customerCheckbox.addEventListener('change', function() {
                    const customerInfo = document.getElementById('customer-info');
                    customerInfo.disabled = !this.checked;
                    if (!this.checked) {
                        customerInfo.value = '';
                        customerInfo.style.background = 'var(--bg-hover)';
                    } else {
                        customerInfo.style.background = 'var(--bg-card)';
                    }
                });
            }
        }

        function closeModal(forceClose = false) {
            // Reset form protection before closing
            if (typeof formProtectionManager !== 'undefined') {
                formProtectionManager.resetProtection();
            }

            document.getElementById('modal').classList.remove('active');
        }

        function viewEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Employee Profile</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="employee-profile">
                        <div class="profile-header">
                            <div class="employee-avatar-xl ${emp.color}">${emp.initials}</div>
                            <div class="profile-info">
                                <h2>${emp.name}</h2>
                                <p>${emp.role} @ ${emp.store}</p>
                                <span class="status-badge ${emp.status}">${emp.status}</span>
                            </div>
                        </div>
                        <div class="profile-details">
                            <div class="detail-row">
                                <i class="fas fa-envelope"></i>
                                <span>${emp.email}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-phone"></i>
                                <span>${emp.phone}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-calendar"></i>
                                <span>Hired: ${formatDate(emp.hireDate)}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-ambulance"></i>
                                <span>Emergency: ${emp.emergencyContact}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-allergies"></i>
                                <span>Allergies: ${emp.allergies}</span>
                            </div>
                        </div>
                        ${emp.paperwork && emp.paperwork.length > 0 ? `
                        <div class="form-divider"></div>
                        <h3 class="form-section-title">Employee Paperwork</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${emp.paperwork.map((doc, index) => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                        <i class="fas ${getFileIcon(doc.fileType)}" style="color: var(--accent-primary); font-size: 18px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${doc.fileName}</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">
                                                ${doc.documentType || 'Document'}  ${formatFileSize(doc.fileSize)}  ${formatDate(doc.uploadedAt.toDate ? doc.uploadedAt.toDate() : doc.uploadedAt)}
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn-icon" onclick="window.open('${doc.downloadURL}', '_blank')" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                    <button class="btn-secondary" style="display:none;" onclick="requestDayOff('${emp.id}')"><i class="fas fa-calendar-xmark"></i> Day Off Request</button>
                    <button class="btn-primary" onclick="editEmployee('${emp.id}')"><i class="fas fa-edit"></i> Edit</button>
                </div>
            `;
            modal.classList.add('active');
        }

        /**
         * Get current user info (simulated - would come from Firebase Auth in production)
         */
        function getCurrentUser() {
            // Get user from authentication manager
            const user = authManager.getCurrentUser();
            
            if (user) {
                return user;
            }
            
            // Fallback if not authenticated (should redirect to login)
            return {
                id: null,
                name: 'Unknown',
                email: 'unknown@vsu.com',
                role: 'employee'
            };
        }

        /**
         * Check if current user has permission for an action
         */
        function checkPermission(permission) {
            const currentUser = getCurrentUser();
            const permissions = window.ROLE_PERMISSIONS?.[currentUser.role];
            
            if (!permissions) {
                console.warn('No permissions found for role:', currentUser.role);
                return false;
            }

            return permissions[permission] === true;
        }

        /**
         * Show permission denied message
         */
        function showPermissionDenied(action = 'perform this action') {
            const currentUser = getCurrentUser();
            const roleLabel = window.ROLE_PERMISSIONS?.[currentUser.role]?.label || currentUser.role;
            
            alert(` Permission Denied\n\nYour role (${roleLabel}) does not have permission to ${action}.\n\nPlease contact an Administrator for assistance.`);
        }

        /**
         * Filter navigation menu based on user role
         * Show/hide menu items that user doesn't have access to
         */
        function filterNavigationByRole() {
            const user = getCurrentUser();
            const userRole = user.role || 'employee';
            const userPermissions = window.ROLE_PERMISSIONS[userRole] || window.ROLE_PERMISSIONS['employee'];
            const allowedPages = userPermissions.pages || [];

            // Hide all nav items first
            document.querySelectorAll('.nav-section a, .nav-section div').forEach(item => {
                if (!item.classList.contains('nav-label')) {
                    item.style.display = 'none';
                }
            });

            // Show only allowed pages using data-page attribute
            allowedPages.forEach(page => {
                document.querySelectorAll(`.nav-item[data-page="${page}"], .nav-dropdown-item[data-page="${page}"]`).forEach(item => {
                    item.style.display = '';
                    
                    // Show parent div if it's a nav-item
                    if (item.classList.contains('nav-item') && item.parentElement.tagName === 'DIV') {
                        item.parentElement.style.display = '';
                    }
                    
                    // If it's a dropdown item, show parent dropdown and parent nav-item
                    if (item.classList.contains('nav-dropdown-item')) {
                        const dropdownContainer = item.closest('.nav-dropdown');
                        if (dropdownContainer) {
                            dropdownContainer.style.display = '';
                            // Find and show the parent nav-item that triggers this dropdown
                            const parentNavItem = dropdownContainer.previousElementSibling;
                            if (parentNavItem && parentNavItem.classList.contains('nav-item')) {
                                parentNavItem.style.display = '';
                                if (parentNavItem.parentElement.tagName === 'DIV') {
                                    parentNavItem.parentElement.style.display = '';
                                }
                            }
                        }
                    }
                });
            });

            // Show parent divs that contain visible nav-items
            document.querySelectorAll('.nav-section > div').forEach(div => {
                const hasVisibleItems = div.querySelector('.nav-item:not([style*="display: none"])');
                if (hasVisibleItems) {
                    div.style.display = '';
                }
            });
        }

        function editEmployee(id) {
            // Check permission
            if (!checkPermission('canEditAllEmployees')) {
                showPermissionDenied('edit employees');
                return;
            }

            // Find employee by id or firestoreId
            const emp = employees.find(e => e.id === id || e.firestoreId === id);
            if (!emp) {
                alert('Employee not found');
                return;
            }

            // Store the employee being edited (using the global variable declared in openModal section)
            editingEmployeeId = emp.firestoreId || emp.id;

            // Open modal with edit form
            openModal('edit-employee', emp);
        }

        /**
         * Save edited employee to Firebase
         */
        async function saveEditedEmployee() {
            if (!editingEmployeeId) {
                alert('No employee selected for editing');
                return;
            }
            const employeeId = editingEmployeeId;

            // Get the current employee data
            const currentEmployee = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);
            if (!currentEmployee) {
                alert('Employee not found');
                return;
            }

            // Get current name parts for fallback
            const currentNameParts = (currentEmployee.name || '').split(' ');
            const currentFirstName = currentNameParts[0] || '';
            const currentLastName = currentNameParts.slice(1).join(' ') || '';

            const firstName = document.getElementById('edit-emp-first-name').value.trim() || currentFirstName;
            const lastName = document.getElementById('edit-emp-last-name').value.trim() || currentLastName;
            const authEmail = document.getElementById('edit-emp-email').value.trim() || currentEmployee.authEmail || currentEmployee.email;
            const phone = document.getElementById('edit-emp-phone').value.trim() || currentEmployee.phone;
            const password = document.getElementById('edit-emp-password').value.trim();
            const confirmPassword = document.getElementById('edit-emp-confirm-password').value.trim();
            const role = document.getElementById('edit-emp-role').value || currentEmployee.role;
            const employeeType = document.getElementById('edit-emp-employee-type')?.value || currentEmployee.employeeType || 'employee';
            const store = document.getElementById('edit-emp-store').value || currentEmployee.store;
            const status = document.getElementById('edit-emp-status').value || currentEmployee.status;
            const hireDate = document.getElementById('edit-emp-hire-date').value || currentEmployee.hireDate;
            const emergencyName = document.getElementById('edit-emp-emergency-name').value.trim();
            const emergencyPhone = document.getElementById('edit-emp-emergency-phone').value.trim();
            const allergies = document.getElementById('edit-emp-allergies').value.trim();

            // Check if status is changing from active to inactive - trigger offboarding
            if (currentEmployee.status === 'active' && status === 'inactive') {
                // Store the pending update data temporarily
                window.pendingOffboardingData = {
                    employeeId,
                    currentEmployee,
                    updatedData: {
                        firstName, lastName, authEmail, phone, password, confirmPassword,
                        role, employeeType, store, status, hireDate, emergencyName, emergencyPhone, allergies
                    }
                };
                // Close current modal and open offboarding modal
                closeModal();
                setTimeout(() => {
                    openModal('offboarding', currentEmployee);
                }, 100);
                return;
            }

            // If new password is provided, validate it
            if (password && !confirmPassword) {
                alert('Please confirm the new password');
                return;
            }

            if (password && password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (password && password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            const updatedData = {
                name: `${firstName} ${lastName}`,
                initials: `${firstName[0]}${lastName[0]}`.toUpperCase(),
                authEmail,
                phone,
                role,
                employeeType,
                store,
                status,
                hireDate: hireDate || new Date().toISOString().split('T')[0],
                emergencyContact: combineEmergencyContact(emergencyName, emergencyPhone) || currentEmployee.emergencyContact || 'Not provided',
                allergies: allergies || currentEmployee.allergies || 'None'
            };

            // Only include password if it's being changed
            if (password) {
                updatedData.password = password;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Update in Firebase
                if (firebaseEmployeeManager.isInitialized) {
                    const success = await firebaseEmployeeManager.updateEmployee(employeeId, updatedData);
                    if (!success) {
                        throw new Error('Failed to update in Firebase');
                    }

                    // Upload new paperwork files if any
                    if (editEmployeePaperworkFiles.length > 0) {
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading documents...';

                        for (const file of editEmployeePaperworkFiles) {
                            try {
                                await firebaseEmployeeManager.uploadPaperwork(employeeId, file, 'Document');
                            } catch (uploadError) {
                                console.error('Error uploading file:', file.name, uploadError);
                                // Continue with other files even if one fails
                            }
                        }

                        // Clear the selected files after upload
                        editEmployeePaperworkFiles = [];
                    }
                }

                // Reload employee data to get latest paperwork
                let updatedEmployee = updatedData;
                if (firebaseEmployeeManager.isInitialized) {
                    const freshData = await firebaseEmployeeManager.getEmployee(employeeId);
                    if (freshData) {
                        updatedEmployee = freshData;
                    }
                }

                // Update local array
                const index = employees.findIndex(e => e.id === employeeId || e.firestoreId === employeeId);
                if (index !== -1) {
                    employees[index] = {
                        ...employees[index],
                        ...updatedEmployee
                    };
                }

                // Clear editing state
                editingEmployeeId = null;

                closeModal();
                renderPage(currentPage);
                showNotification('Employee updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating employee:', error);
                alert('Error updating employee. Please try again.');

                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        // Offboarding Functions
        function cancelOffboarding() {
            window.pendingOffboardingData = null;
            closeModal();
            showNotification('Offboarding cancelled. Employee status unchanged.', 'info');
        }

        async function confirmOffboarding() {
            const pendingData = window.pendingOffboardingData;
            if (!pendingData) {
                alert('No pending offboarding data found');
                closeModal();
                return;
            }

            // Validate required fields
            const reason = document.getElementById('offboard-reason').value;
            const lastDay = document.getElementById('offboard-last-day').value;
            const receivedBy = document.getElementById('offboard-received-by').value.trim();
            const otherReason = document.getElementById('offboard-other-reason')?.value || '';

            if (!reason) {
                alert('Please select a reason for leaving');
                return;
            }

            if (reason === 'other' && !otherReason.trim()) {
                alert('Please specify the reason for leaving');
                return;
            }

            if (!lastDay) {
                alert('Please enter the last day worked');
                return;
            }

            if (!receivedBy) {
                alert('Please enter who received the items');
                return;
            }

            // Collect offboarding data
            const offboardingData = {
                reason: reason,
                reasonText: reason === 'other' ? otherReason : getOffboardingReasonText(reason),
                lastDayWorked: lastDay,
                keysReturned: document.getElementById('offboard-keys').checked,
                receivedBy: receivedBy,
                notes: document.getElementById('offboard-notes').value.trim(),
                offboardingDate: new Date().toISOString(),
                offboardingBy: getCurrentUser().name || 'Admin'
            };

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                saveBtn.disabled = true;
            }

            try {
                const { employeeId, currentEmployee, updatedData } = pendingData;

                // Build the full update object
                const fullUpdatedData = {
                    name: `${updatedData.firstName} ${updatedData.lastName}`,
                    initials: `${updatedData.firstName[0]}${updatedData.lastName[0]}`.toUpperCase(),
                    authEmail: updatedData.authEmail,
                    phone: updatedData.phone,
                    role: updatedData.role,
                    employeeType: updatedData.employeeType,
                    store: updatedData.store,
                    status: 'inactive',
                    hireDate: updatedData.hireDate || new Date().toISOString().split('T')[0],
                    emergencyContact: combineEmergencyContact(updatedData.emergencyName, updatedData.emergencyPhone) || currentEmployee.emergencyContact || 'Not provided',
                    allergies: updatedData.allergies || currentEmployee.allergies || 'None',
                    offboarding: offboardingData
                };

                // Only include password if it's being changed
                if (updatedData.password) {
                    fullUpdatedData.password = updatedData.password;
                }

                // Update in Firebase
                if (firebaseEmployeeManager.isInitialized) {
                    const success = await firebaseEmployeeManager.updateEmployee(employeeId, fullUpdatedData);
                    if (!success) {
                        throw new Error('Failed to update in Firebase');
                    }
                }

                // Update local array
                const index = employees.findIndex(e => e.id === employeeId || e.firestoreId === employeeId);
                if (index !== -1) {
                    employees[index] = {
                        ...employees[index],
                        ...fullUpdatedData
                    };
                }

                // Clear pending data
                window.pendingOffboardingData = null;
                editingEmployeeId = null;

                closeModal();
                renderPage(currentPage);
                updateEmployeeCountBadge();
                showNotification(`${currentEmployee.name} has been deactivated and offboarding documented.`, 'success');
            } catch (error) {
                console.error('Error during offboarding:', error);
                alert('Error completing offboarding. Please try again.');

                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        function getOffboardingReasonText(reason) {
            const reasons = {
                'resignation': 'Resignation',
                'termination': 'Termination',
                'contract_end': 'End of Contract',
                'abandonment': 'Job Abandonment',
                'mutual': 'Mutual Agreement',
                'other': 'Other'
            };
            return reasons[reason] || reason;
        }

        function deleteEmployee(id) {
            // Check permission
            if (!checkPermission('canDeleteEmployees')) {
                showPermissionDenied('delete employees');
                return;
            }

            // Find employee by id or firestoreId
            const emp = employees.find(e => e.id === id || e.firestoreId === id);
            if (!emp) return;

            // Store pending offboarding data and open offboarding modal
            window.pendingOffboardingData = {
                employeeId: emp.firestoreId || emp.id,
                currentEmployee: emp,
                updatedData: {
                    firstName: emp.name?.split(' ')[0] || '',
                    lastName: emp.name?.split(' ').slice(1).join(' ') || '',
                    email: emp.email,
                    phone: emp.phone,
                    role: emp.role,
                    employeeType: emp.employeeType || 'employee',
                    store: emp.store,
                    status: 'inactive',
                    hireDate: emp.hireDate,
                    emergencyName: emp.emergencyContact?.split(' - ')[0] || '',
                    emergencyPhone: emp.emergencyContact?.split(' - ')[1] || '',
                    allergies: emp.allergies
                }
            };

            // Open offboarding modal
            openModal('offboarding', emp);
        }

        function activateEmployee(id) {
            // Check permission
            if (!checkPermission('canEditAllEmployees')) {
                showPermissionDenied('activate employees');
                return;
            }

            // Find employee by id or firestoreId
            const emp = employees.find(e => e.id === id || e.firestoreId === id);
            if (!emp) return;

            showConfirmModal({
                title: 'Activate Employee',
                message: `Are you sure you want to activate "${emp.name}"? The employee status will be changed to active.`,
                confirmText: 'Activate',
                type: 'info',
                onConfirm: async () => {
                    try {
                        // Mark as active in Firebase
                        const firestoreId = emp.firestoreId || emp.id;
                        if (firebaseEmployeeManager.isInitialized) {
                            const updated = await firebaseEmployeeManager.updateEmployee(firestoreId, { status: 'active' });
                            if (!updated) {
                                throw new Error('Failed to activate employee');
                            }
                        }

                        // Update in local array
                        const empIndex = employees.findIndex(e => e.id === id || e.firestoreId === id);
                        if (empIndex !== -1) {
                            employees[empIndex].status = 'active';
                        }

                        // Update employee count badge
                        updateEmployeeCountBadge();

                        // Re-render page
                        renderPage(currentPage);
                        showNotification('Employee activated successfully', 'success');
                    } catch (error) {
                        console.error('Error activating employee:', error);
                    }
                }
            });
        }

        function filterEmployees() {
            const search = document.getElementById('employee-search').value.toLowerCase();
            const store = document.getElementById('store-filter').value;
            const status = document.getElementById('status-filter').value;

            const filtered = employees.filter(emp => {
                const matchSearch = emp.name.toLowerCase().includes(search) || emp.role.toLowerCase().includes(search);
                const matchStore = !store || emp.store === store;
                const matchStatus = !status || emp.status === status;
                return matchSearch && matchStore && matchStatus;
            });

            document.getElementById('employees-grid').innerHTML = filtered.map(emp => renderEmployeeCard(emp)).join('');
        }

        /**
         * Open modal showing inactive employees with their offboarding details
         */
        function openInactiveEmployeesModal() {
            const inactiveEmployees = employees.filter(emp => emp.status === 'inactive');
            openModal('inactive-employees', inactiveEmployees);
        }

        /**
         * View offboarding details for a specific employee
         */
        function viewOffboardingDetails(employeeId) {
            const emp = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);
            if (!emp || !emp.offboarding) {
                showNotification('No offboarding information available', 'warning');
                return;
            }
            openModal('offboarding-details', emp);
        }

        /**
         * View employee paperwork/documents
         */
        async function viewEmployeePaperwork(employeeId) {
            const emp = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);
            if (!emp) {
                showNotification('Employee not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            // Show loading state
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Employee Documents</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--accent-primary); margin-bottom: 16px;"></i>
                        <p style="color: var(--text-muted);">Loading documents...</p>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            try {
                // Get paperwork from Firebase
                let paperwork = [];
                if (firebaseEmployeeManager.isInitialized) {
                    paperwork = await firebaseEmployeeManager.getPaperwork(employeeId);
                }

                modalContent.innerHTML = `
                    <div class="modal-header">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div class="employee-avatar-lg ${emp.color}">${emp.initials}</div>
                            <div>
                                <h2 style="margin: 0; font-size: 20px;">${emp.name}</h2>
                                <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 13px;">${emp.role} @ ${emp.store}</p>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-file-contract" style="color: var(--accent-primary);"></i>
                                Employee Paperwork & Documents
                            </h3>
                            <p style="color: var(--text-muted); font-size: 13px; margin: 0;">
                                Registered documents: ${paperwork.length}
                            </p>
                        </div>

                        ${paperwork && paperwork.length > 0 ? `
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${paperwork.map((doc, index) => `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color); transition: all 0.2s;">
                                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                            <div style="width: 48px; height: 48px; background: ${getDocumentColor(doc.fileType)}; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas ${getFileIcon(doc.fileType)}" style="color: white; font-size: 20px;"></i>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px;">
                                                    ${doc.fileName}
                                                </div>
                                                <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-muted);">
                                                    <span>${doc.documentType || 'Document'}</span>
                                                    <span></span>
                                                    <span>${formatFileSize(doc.fileSize)}</span>
                                                    <span></span>
                                                    <span>Uploaded ${formatDate(doc.uploadedAt?.toDate ? doc.uploadedAt.toDate() : doc.uploadedAt)}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-icon" onclick="window.open('${doc.downloadURL}', '_blank')" title="View Document">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; background: var(--bg-secondary); border-radius: 8px;">
                                <i class="fas fa-inbox" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px; display: block;"></i>
                                <h3 style="color: var(--text-muted); font-size: 16px; margin-bottom: 8px;">No Documents Yet</h3>
                                <p style="color: var(--text-muted); font-size: 13px; margin: 0;">No paperwork has been uploaded for this employee yet.</p>
                            </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading documents:', error);
                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h2>Employee Documents</h2>
                        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"></i>
                            <p>Error loading documents</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                `;
            }
        }

        // Save functions
        async function saveEmployee() {
            const firstName = document.getElementById('emp-first-name').value.trim();
            const lastName = document.getElementById('emp-last-name').value.trim();
            const email = document.getElementById('emp-email').value.trim();
            const phone = document.getElementById('emp-phone').value.trim();
            const password = document.getElementById('emp-password').value.trim();
            const confirmPassword = document.getElementById('emp-confirm-password').value.trim();
            const role = document.getElementById('emp-role').value;
            const employeeType = document.getElementById('emp-employee-type')?.value || 'employee';
            const store = document.getElementById('emp-store').value;
            const hireDate = document.getElementById('emp-hire-date').value;
            const emergencyName = document.getElementById('emp-emergency-name').value.trim();
            const emergencyPhone = document.getElementById('emp-emergency-phone').value.trim();
            const allergies = document.getElementById('emp-allergies').value.trim();

            if (!firstName || !lastName || !email || !phone || !role || !store || !password) {
                alert('Please fill in all required fields');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            const newEmployee = {
                name: `${firstName} ${lastName}`,
                initials: `${firstName[0]}${lastName[0]}`.toUpperCase(),
                email,
                phone,
                role,                                    // Job position (Store Manager, Sales Associate, etc)
                employeeType: employeeType,              // Permission level (admin, manager, employee)
                store,
                hireDate: hireDate || new Date().toISOString().split('T')[0],
                emergencyContact: combineEmergencyContact(emergencyName, emergencyPhone),
                allergies: allergies || 'None',
                status: 'active',
                color: ['a', 'b', 'c', 'd', 'e'][Math.floor(Math.random() * 5)]
            };

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Initialize Firebase if needed
                if (!firebaseEmployeeManager.isInitialized) {
                    await firebaseEmployeeManager.initialize();
                }

                // Save to Firebase
                if (firebaseEmployeeManager.isInitialized) {
                    const firestoreId = await firebaseEmployeeManager.addEmployee(newEmployee, email, password);
                    if (firestoreId) {
                        newEmployee.id = firestoreId;
                        newEmployee.firestoreId = firestoreId;
                        console.log('Employee saved to Firebase:', firestoreId);

                        // Upload paperwork files if any
                        if (selectedEmployeePaperworkFiles.length > 0) {
                            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading documents...';

                            for (const file of selectedEmployeePaperworkFiles) {
                                try {
                                    await firebaseEmployeeManager.uploadPaperwork(firestoreId, file, 'Document');
                                } catch (uploadError) {
                                    console.error('Error uploading file:', file.name, uploadError);
                                    // Continue with other files even if one fails
                                }
                            }

                            // Clear the selected files after upload
                            selectedEmployeePaperworkFiles = [];

                            // Reload employee data to get updated paperwork
                            const updatedEmployee = await firebaseEmployeeManager.getEmployee(firestoreId);
                            if (updatedEmployee) {
                                newEmployee.paperwork = updatedEmployee.paperwork;
                            }
                        }

                        // Add to local array
                        employees.push(newEmployee);

                        // Update employee count badge
                        updateEmployeeCountBadge();

                        closeModal();
                        renderPage(currentPage);

                        // Show success message
                        showNotification('Employee added successfully!', 'success');
                    } else {
                        throw new Error('Failed to get Firestore ID');
                    }
                } else {
                    // Fallback: save locally only
                    newEmployee.id = Date.now().toString();
                    employees.push(newEmployee);

                    // Update employee count badge
                    updateEmployeeCountBadge();

                    closeModal();
                    renderPage(currentPage);
                    showNotification('Employee added (offline mode)', 'warning');
                }
            } catch (error) {
                console.error('Error saving employee:', error);
                
                // Show specific error message
                let errorMessage = error.message || 'Error saving employee. Please try again.';
                alert(errorMessage);

                // Reset button
                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        /**
         * Show notification toast
         */
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelector('.notification-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Variable to store selected training file
        let selectedTrainingFile = null;

        // Toggle between video URL and PDF file upload fields
        function toggleTrainingTypeFields() {
            const type = document.getElementById('training-type').value;
            const urlGroup = document.getElementById('training-url-group');
            const fileGroup = document.getElementById('training-file-group');

            if (type === 'video') {
                urlGroup.style.display = 'block';
                fileGroup.style.display = 'none';
            } else {
                urlGroup.style.display = 'none';
                fileGroup.style.display = 'block';
            }
        }

        // Handle training file selection
        function handleTrainingFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            if (file.type !== 'application/pdf') {
                showToast('Please select a PDF file', 'error');
                input.value = '';
                return;
            }

            // Validate file size (max 50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showToast('File size exceeds 50MB limit', 'error');
                input.value = '';
                return;
            }

            selectedTrainingFile = file;

            // Update UI to show selected file
            const fileContent = document.getElementById('training-file-content');
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            fileContent.innerHTML = `
                <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444; margin-bottom: 8px;"></i>
                <span style="color: var(--text-primary); font-weight: 500;">${file.name}</span>
                <span style="color: var(--text-muted); font-size: 12px;">${fileSize} MB</span>
            `;
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function saveTraining() {
            const title = document.getElementById('training-title').value.trim();
            const type = document.getElementById('training-type').value;
            const url = document.getElementById('training-url').value.trim();
            const description = document.getElementById('training-description')?.value.trim() || '';
            const required = document.getElementById('training-required').checked;

            // Validation
            if (!title) {
                showToast('Please enter a training title', 'error');
                return;
            }

            if (type === 'video' && !url) {
                showToast('Please enter a video URL', 'error');
                return;
            }

            if (type === 'document' && !selectedTrainingFile) {
                showToast('Please select a PDF file', 'error');
                return;
            }

            // Show loading state
            const saveBtn = document.getElementById('save-training-btn');
            const saveText = document.getElementById('save-training-text');
            const saveSpinner = document.getElementById('save-training-spinner');

            if (saveBtn) saveBtn.disabled = true;
            if (saveText) saveText.textContent = 'Saving...';
            if (saveSpinner) saveSpinner.style.display = 'inline-block';

            // Show upload progress for PDF files
            if (type === 'document') {
                const progressDiv = document.getElementById('training-upload-progress');
                if (progressDiv) progressDiv.style.display = 'block';

                // Listen for upload progress
                const progressHandler = (e) => {
                    const progress = e.detail.progress;
                    const progressFill = document.getElementById('training-progress-fill');
                    const progressText = document.getElementById('training-progress-text');
                    if (progressFill) progressFill.style.width = progress + '%';
                    if (progressText) progressText.textContent = Math.round(progress) + '%';
                };
                window.addEventListener('uploadProgress', progressHandler);

                try {
                    // Initialize Firebase Training Manager if not already
                    if (!firebaseTrainingManager.isInitialized) {
                        await firebaseTrainingManager.initialize();
                    }

                    // Prepare training data
                    const trainingData = {
                        title,
                        type,
                        url: type === 'video' ? url : '',
                        completion: 0,
                        required,
                        description
                    };

                    // Save to Firebase with file
                    const newId = await firebaseTrainingManager.addTraining(trainingData, selectedTrainingFile);

                    if (newId) {
                        showToast('Training material added successfully!', 'success');
                        selectedTrainingFile = null;
                        closeModal();
                        await loadTrainingsFromFirebase();
                        renderPage(currentPage);
                    } else {
                        throw new Error('Failed to save training');
                    }

                    window.removeEventListener('uploadProgress', progressHandler);
                } catch (error) {
                    console.error('Error saving training:', error);
                    showToast('Error saving training: ' + error.message, 'error');
                    window.removeEventListener('uploadProgress', progressHandler);

                    // Reset button state
                    if (saveBtn) saveBtn.disabled = false;
                    if (saveText) saveText.textContent = 'Add Training';
                    if (saveSpinner) saveSpinner.style.display = 'none';
                }
            } else {
                // Video type - no file upload needed
                try {
                    if (!firebaseTrainingManager.isInitialized) {
                        await firebaseTrainingManager.initialize();
                    }

                    const trainingData = {
                        title,
                        type,
                        url,
                        completion: 0,
                        required,
                        description
                    };

                    const newId = await firebaseTrainingManager.addTraining(trainingData);

                    if (newId) {
                        showToast('Training material added successfully!', 'success');
                        closeModal();
                        await loadTrainingsFromFirebase();
                        renderPage(currentPage);
                    } else {
                        throw new Error('Failed to save training');
                    }
                } catch (error) {
                    console.error('Error saving training:', error);
                    showToast('Error saving training: ' + error.message, 'error');

                    // Reset button state
                    if (saveBtn) saveBtn.disabled = false;
                    if (saveText) saveText.textContent = 'Add Training';
                    if (saveSpinner) saveSpinner.style.display = 'none';
                }
            }
        }

        // Load trainings from Firebase
        async function loadTrainingsFromFirebase() {
            try {
                if (!firebaseTrainingManager.isInitialized) {
                    await firebaseTrainingManager.initialize();
                }

                const firebaseTrainings = await firebaseTrainingManager.loadTrainings();

                if (firebaseTrainings.length > 0) {
                    trainings = firebaseTrainings;
                    console.log('Loaded trainings from Firebase:', trainings.length);
                } else {
                    console.log('No trainings in Firebase, using default data');
                }
            } catch (error) {
                console.error('Error loading trainings from Firebase:', error);
            }
        }

        async function saveLicense() {
            const name = document.getElementById('license-name').value;
            const store = document.getElementById('license-store').value;
            const expires = document.getElementById('license-expires').value;
            const fileInput = document.getElementById('license-file');

            if (!name || !store || !expires) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const expiresDate = new Date(expires);
            const today = new Date();
            const daysUntilExpiry = Math.ceil((expiresDate - today) / (1000 * 60 * 60 * 24));

            let status = 'valid';
            if (daysUntilExpiry < 0) status = 'expired';
            else if (daysUntilExpiry < 60) status = 'expiring';

            // Get current user info
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const uploadedBy = user?.name || user?.email || 'Unknown';

            try {
                // Initialize Firebase if needed
                if (!firebaseLicensesManager.isInitialized) {
                    await firebaseLicensesManager.initialize();
                }

                let file = null;
                if (fileInput && fileInput.files.length > 0) {
                    file = fileInput.files[0];

                    // Validate file type
                    if (file.type !== 'application/pdf') {
                        showToast('Please select a PDF file', 'error');
                        return;
                    }

                    // Check file size (max 50MB for Storage)
                    const maxSize = 50 * 1024 * 1024; // 50MB
                    if (file.size > maxSize) {
                        showToast('File size exceeds 50MB limit', 'error');
                        return;
                    }
                }

                const licenseData = {
                    name,
                    store,
                    expires,
                    status,
                    file: file ? file.name : null,
                    uploadedBy: uploadedBy
                };

                // Save to Firebase (with or without file)
                const docId = await firebaseLicensesManager.addLicense(licenseData, file);

                if (docId) {
                    showToast('License uploaded successfully!', 'success');

                    // Reload licenses from Firebase
                    const updatedLicenses = await firebaseLicensesManager.loadLicenses();
                    if (updatedLicenses && updatedLicenses.length > 0) {
                        licenses = updatedLicenses;
                    }

                    closeModal();
                    renderPage(currentPage);
                } else {
                    throw new Error('Failed to save license');
                }
            } catch (error) {
                console.error('Error saving license:', error);
                showToast('Error saving license: ' + error.message, 'error');
            }
        }

        // Legacy function kept for compatibility
        async function saveLicenseOld() {
            const name = document.getElementById('license-name').value;
            const store = document.getElementById('license-store').value;
            const expires = document.getElementById('license-expires').value;
            const fileInput = document.getElementById('license-file');

            if (!name || !store || !expires) {
                alert('Please fill in all required fields');
                return;
            }

            const expiresDate = new Date(expires);
            const today = new Date();
            const daysUntilExpiry = Math.ceil((expiresDate - today) / (1000 * 60 * 60 * 24));

            let status = 'valid';
            if (daysUntilExpiry < 0) status = 'expired';
            else if (daysUntilExpiry < 60) status = 'expiring';

            // Get current user info
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const uploadedBy = user?.name || user?.email || 'Unknown';

            // No file uploaded
            const licenseData = {
                name,
                store,
                expires,
                status,
                file: null,
                fileName: null,
                fileType: null,
                fileData: null,
                uploadedBy: uploadedBy
            };

            // Save to Firebase
            if (firebaseLicensesManager && firebaseLicensesManager.isInitialized) {
                try {
                    const docId = await firebaseLicensesManager.addLicense(licenseData);
                    if (docId) {
                        // Reload licenses from Firebase
                        const updatedLicenses = await firebaseLicensesManager.loadLicenses();
                        if (updatedLicenses && updatedLicenses.length > 0) {
                            licenses = updatedLicenses;
                        }
                        console.log(' License saved to Firebase with ID:', docId);
                    }
                } catch (error) {
                    console.error('Error saving license to Firebase:', error);
                    // Fallback to local
                    licenses.push({
                        id: Date.now().toString(),
                        ...licenseData
                    });
                }
            } else {
                // Fallback to local storage
                licenses.push({
                    id: Date.now().toString(),
                    ...licenseData
                });
            }

            closeModal();
            renderPage(currentPage);
        }

        async function saveAnnouncement() {
            const title = document.getElementById('announcement-title').value;
            const content = document.getElementById('announcement-content').value;
            const targetStores = document.getElementById('announcement-stores')?.value || 'all';

            if (!title || !content) {
                alert('Please fill in all required fields');
                return;
            }

            // Get current user info for author
            const user = authManager.getCurrentUser();
            const authorName = user?.name || user?.email?.split('@')[0] || 'Unknown';

            const announcementData = {
                date: new Date().toISOString().split('T')[0],
                title,
                content,
                author: authorName,
                targetStores
            };

            try {
                // Save to Firebase
                if (firebaseAnnouncementsManager.isInitialized) {
                    const docId = await firebaseAnnouncementsManager.addAnnouncement(announcementData);
                    if (docId) {
                        // Reload announcements from Firebase
                        const updatedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                        if (updatedAnnouncements && updatedAnnouncements.length > 0) {
                            announcements = updatedAnnouncements;
                        }
                        console.log('Announcement saved to Firebase with ID:', docId);
                    }
                } else {
                    // Fallback to local storage
                    announcements.unshift({
                        id: announcements.length + 1,
                        ...announcementData
                    });
                }

                closeModal();
                renderPage(currentPage);
                updateAnnouncementsBadge();
                populateAnnouncementsDropdown();
            } catch (error) {
                console.error('Error saving announcement:', error);
                alert('Failed to save announcement. Please try again.');
            }
        }

        async function saveAnnouncementInline() {
            const title = document.getElementById('new-announcement-title').value;
            const content = document.getElementById('new-announcement-content').value;

            if (!title || !content) {
                alert('Please fill in both title and content');
                return;
            }

            // Get current user info for author
            const user = authManager.getCurrentUser();
            const authorName = user?.name || user?.email?.split('@')[0] || 'Unknown';

            const announcementData = {
                date: new Date().toISOString().split('T')[0],
                title,
                content,
                author: authorName,
                targetStores: 'all'
            };

            try {
                // Save to Firebase
                if (firebaseAnnouncementsManager.isInitialized) {
                    const docId = await firebaseAnnouncementsManager.addAnnouncement(announcementData);
                    if (docId) {
                        // Reload announcements from Firebase
                        const updatedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                        if (updatedAnnouncements && updatedAnnouncements.length > 0) {
                            announcements = updatedAnnouncements;
                        }
                        console.log('Announcement saved to Firebase with ID:', docId);
                    }
                } else {
                    // Fallback to local storage
                    announcements.unshift({
                        id: announcements.length + 1,
                        ...announcementData
                    });
                }

                renderAnnouncements();
                updateAnnouncementsBadge();
                populateAnnouncementsDropdown();
            } catch (error) {
                console.error('Error saving announcement:', error);
                alert('Failed to save announcement. Please try again.');
            }
        }

        async function saveProduct() {
            const name = document.getElementById('new-product-name').value.trim();
            const category = document.getElementById('new-product-category').value;
            const price = document.getElementById('new-product-price').value;
            const arrivalDate = document.getElementById('new-product-arrival').value;
            const estimatedDeals = document.getElementById('new-product-deals')?.value || '';
            const url = document.getElementById('new-product-url')?.value.trim() || '';
            const supplier = document.getElementById('new-product-supplier')?.value.trim() || '';
            const imageInput = document.getElementById('new-product-image');

            if (!name) {
                alert('Please enter a product name');
                return;
            }

            // Show loading state
            const saveBtn = document.getElementById('save-product-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                // Upload image to Firebase Storage if provided
                let imageUrl = null;
                let imagePath = null;
                const imageImg = document.getElementById('product-image-img');
                if (imageImg && imageImg.src && imageInput && imageInput.files && imageInput.files.length > 0 && imageImg.src.startsWith('data:')) {
                    // Initialize storage helper if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    try {
                        const tempId = Date.now().toString();
                        const uploadResult = await firebaseStorageHelper.uploadImage(
                            imageImg.src,
                            'products/images',
                            tempId
                        );
                        imageUrl = uploadResult.url;
                        imagePath = uploadResult.path;
                    } catch (err) {
                        console.error('Error uploading product image to Storage:', err);
                        // Fallback to compressed base64
                        imageUrl = await compressImage(imageImg.src);
                    }
                }

                // Create product data object
                const productData = {
                    name,
                    category: category || '',
                    price: parseFloat(price) || 0,
                    arrivalDate: arrivalDate || '',
                    estimatedDeals: estimatedDeals || '',
                    url: url || '',
                    supplier: supplier || '',
                    image: imageUrl,      // Now stores URL instead of base64
                    imagePath: imagePath, // For future deletion
                    status: 'pending'
                };

                // Ensure Firebase Product Manager is initialized
                if (!firebaseProductManager.isInitialized) {
                    const initialized = await firebaseProductManager.initialize();
                    if (!initialized) {
                        throw new Error('Failed to initialize Firebase Product Manager');
                    }
                }

                // Save to Firebase Firestore
                console.log(' Saving product to Firestore...');
                const savedProduct = await firebaseProductManager.saveProduct(productData);

                if (savedProduct) {
                    console.log(' Product saved successfully:', savedProduct);
                    showToast('Product added successfully!', 'success');
                    closeModal();
                    // Reload products from Firebase and render
                    await loadProductsFromFirebase();
                    renderNewStuff();
                } else {
                    throw new Error('Failed to save product');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showToast('Error saving product: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        /**
         * Preview product image (converts to Base64 for direct Firestore storage)
         */
        function previewProductImage(input) {
            const preview = document.getElementById('product-image-preview');
            const img = document.getElementById('product-image-img');

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Validate file size (max 1MB for Firestore document limit)
                const maxSize = 1 * 1024 * 1024; // 1MB
                if (file.size > maxSize) {
                    showToast('Image too large. Please use an image under 1MB.', 'error');
                    input.value = '';
                    preview.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;  // Base64 DataURL
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }

        /**
         * View product image in a modal
         */
        function viewProductImage(imageUrl) {
            if (!imageUrl) {
                alert('No image available');
                return;
            }

            openModal('view-image');
            setTimeout(() => {
                const modal = document.getElementById('modal');
                const modalContent = modal.querySelector('.modal-content');
                modalContent.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <img src="${imageUrl}" alt="Product" style="max-width: 100%; max-height: 80vh; border-radius: 12px;">
                        <button class="btn-secondary" onclick="closeModal()" style="margin-top: 20px; width: 100%;">Close</button>
                    </div>
                `;
            }, 100);
        }

        /**
         * Load products from Firebase
         */
        async function loadProductsFromFirebase() {
            try {
                if (!firebaseProductManager.isInitialized) {
                    const initialized = await firebaseProductManager.initialize();
                    if (!initialized) {
                        console.warn('Firebase not initialized, using empty local products');
                        products = [];
                        return Promise.resolve();
                    }
                }

                console.log(' Loading products from Firebase...');
                const firebaseProducts = await firebaseProductManager.loadProducts();
                
                // Replace local products with Firebase products
                products = firebaseProducts || [];
                
                console.log(` Loaded ${products.length} products from Firebase`);
                return Promise.resolve();
            } catch (error) {
                console.error('Error loading products from Firebase:', error);
                products = [];
                return Promise.resolve();
            }
        }

        /**
         * Delete product from Firebase
         */
        async function deleteProductFromFirebase(productId) {
            showConfirmModal({
                title: 'Delete Product',
                message: 'Are you sure you want to delete this product? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        if (!firebaseProductManager.isInitialized) {
                            const initialized = await firebaseProductManager.initialize();
                            if (!initialized) {
                                showNotification('Firebase not initialized', 'error');
                                return;
                            }
                        }

                        console.log(`锔 Deleting product: ${productId}`);
                        const success = await firebaseProductManager.deleteProduct(productId);

                        if (success) {
                            console.log(' Product deleted successfully');
                            // Remove from local array
                            products = products.filter(p => p.id !== productId);
                            renderNewStuff();
                        } else {
                            showNotification('Error deleting product', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showNotification('Error deleting product', 'error');
                    }
                }
            });
        }

        // Variable to store the product being edited
        let editingProductId = null;

        /**
         * Preview edit product image (converts to Base64)
         */
        function previewEditProductImage(input) {
            const preview = document.getElementById('edit-product-image-preview');
            const img = document.getElementById('edit-product-image-img');

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Validate file size (max 1MB for Firestore document limit)
                const maxSize = 1 * 1024 * 1024; // 1MB
                if (file.size > maxSize) {
                    showToast('Image too large. Please use an image under 1MB.', 'error');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;  // Base64 DataURL
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        /**
         * Get unique supplier options from existing products
         */
        function getSupplierOptions(currentSupplier = '') {
            // Get unique suppliers from existing products
            const suppliers = [...new Set(products.map(p => p.supplier).filter(s => s && s.trim()))];

            // Add some default suppliers if not already in the list
            const defaultSuppliers = ['Direct Import', 'Local Vendor', 'Wholesale'];
            defaultSuppliers.forEach(s => {
                if (!suppliers.includes(s)) suppliers.push(s);
            });

            // Sort alphabetically
            suppliers.sort((a, b) => a.localeCompare(b));

            // Generate options HTML
            return suppliers.map(supplier =>
                `<option value="${supplier}" ${currentSupplier === supplier ? 'selected' : ''}>${supplier}</option>`
            ).join('');
        }

        /**
         * Edit product
         */
        function editProduct(productId) {
            const product = products.find(p => p.id === productId || p.firestoreId === productId);
            if (!product) {
                alert('Product not found');
                return;
            }

            editingProductId = productId;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; gap: 12px; margin: 0;">
                        <i class="fas fa-edit" style="color: var(--accent-primary); font-size: 24px;"></i>
                        Edit Product
                    </h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-product-form" style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Product Name</label>
                            <input type="text" id="edit-product-name" value="${product.name || ''}" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Category</label>
                                <select id="edit-product-category" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                                    <option value="">Select category...</option>
                                    <option value="Vape Devices" ${product.category === 'Vape Devices' ? 'selected' : ''}>Vape Devices</option>
                                    <option value="Vape Pods" ${product.category === 'Vape Pods' ? 'selected' : ''}>Vape Pods</option>
                                    <option value="Disposables" ${product.category === 'Disposables' ? 'selected' : ''}>Disposables</option>
                                    <option value="Cigarettes" ${product.category === 'Cigarettes' ? 'selected' : ''}>Cigarettes</option>
                                    <option value="Accessories" ${product.category === 'Accessories' ? 'selected' : ''}>Accessories</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Quantity</label>
                                <input type="number" id="edit-product-quantity" value="${product.quantity || 0}" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Price</label>
                                <input type="number" id="edit-product-price" value="${product.price || 0}" step="0.01" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Store</label>
                                <select id="edit-product-store" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                                    <option value="">Select store...</option>
                                    <option value="Miramar" ${product.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                    <option value="Morena" ${product.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                    <option value="Kearny Mesa" ${product.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                    <option value="Chula Vista" ${product.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                    <option value="North Park" ${product.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                    <option value="Miramar Wine & Liquor" ${product.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Arrival Date</label>
                                <input type="date" id="edit-product-arrival-date" value="${product.arrivalDate || ''}" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Supplier</label>
                                <select id="edit-product-supplier" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                                    <option value="">Select supplier...</option>
                                    ${getSupplierOptions(product.supplier)}
                                </select>
                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div>
                            <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Product Image (leave empty to keep current)</label>
                            <input type="file" class="form-input" id="edit-product-image" accept="image/*" onchange="previewEditProductImage(this)" style="display: none;">
                            <div id="edit-product-image-preview" style="margin-bottom: 12px; ${product.image ? '' : 'display: none;'}">
                                <img id="edit-product-image-img" src="${product.image || ''}" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover;">
                            </div>
                            <button type="button" class="btn-secondary" onclick="document.getElementById('edit-product-image').click()" style="margin: 0;">
                                <i class="fas fa-image"></i> ${product.image ? 'Change Image' : 'Select Image'}
                            </button>
                            <small style="display: block; margin-top: 8px; color: var(--text-muted);">Max file size: 1MB</small>
                        </div>

                        <div>
                            <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Description</label>
                            <textarea id="edit-product-description" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit; min-height: 100px; resize: vertical;">${product.description || ''}</textarea>
                        </div>
                    </form>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn-primary" style="
                            flex: 1;
                            padding: 12px 16px;
                            border-radius: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            border: none;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        " onclick="saveProductChanges('${productId}')">
                            <i class="fas fa-check"></i>
                            Save Changes
                        </button>
                        <button style="
                            flex: 1;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border: 1px solid var(--border-color);
                            padding: 12px 16px;
                            border-radius: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                        " onclick="closeModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        async function saveProductChanges(productId) {
            const product = products.find(p => p.id === productId || p.firestoreId === productId);
            if (!product) {
                showToast('Product not found', 'error');
                return;
            }

            const imageInput = document.getElementById('edit-product-image');

            // Upload image to Firebase Storage if new one provided
            let imageUrl = product.image;
            let imagePath = product.imagePath || null;
            const imageImg = document.getElementById('edit-product-image-img');
            if (imageInput && imageInput.files && imageInput.files.length > 0 && imageImg && imageImg.src && imageImg.src.startsWith('data:')) {
                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                // Delete old image from Storage if exists
                if (product.imagePath) {
                    try {
                        await firebaseStorageHelper.deleteFile(product.imagePath);
                    } catch (err) {
                        console.error('Error deleting old product image from Storage:', err);
                    }
                }

                try {
                    const firestoreId = product.firestoreId || productId;
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        imageImg.src,
                        'products/images',
                        firestoreId
                    );
                    imageUrl = uploadResult.url;
                    imagePath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading product image to Storage:', err);
                    // Fallback to compressed base64
                    imageUrl = await compressImage(imageImg.src);
                }
            }

            // Update product with new values
            const updatedData = {
                name: document.getElementById('edit-product-name').value.trim() || product.name,
                category: document.getElementById('edit-product-category').value.trim() || product.category,
                quantity: parseInt(document.getElementById('edit-product-quantity').value) || 0,
                price: parseFloat(document.getElementById('edit-product-price').value) || 0,
                store: document.getElementById('edit-product-store').value.trim() || product.store,
                arrivalDate: document.getElementById('edit-product-arrival-date').value || product.arrivalDate,
                supplier: document.getElementById('edit-product-supplier').value.trim() || product.supplier,
                description: document.getElementById('edit-product-description').value.trim() || '',
                image: imageUrl,      // Now stores URL instead of base64
                imagePath: imagePath  // For future deletion
            };

            // Update local product
            const productIndex = products.findIndex(p => p.id === productId || p.firestoreId === productId);
            if (productIndex !== -1) {
                products[productIndex] = {
                    ...products[productIndex],
                    ...updatedData
                };
            }

            // Save to Firebase
            try {
                if (firebaseProductManager && firebaseProductManager.isInitialized) {
                    const firestoreId = product.firestoreId || productId;
                    await firebaseProductManager.updateProduct(String(firestoreId), updatedData);
                    console.log(' Product updated in Firebase');
                    showToast('Product updated successfully!', 'success');
                } else {
                    console.warn('锔 Firebase not initialized, saving locally only');
                    showToast('Product updated locally', 'success');
                }
            } catch (error) {
                console.error('Error updating product in Firebase:', error);
                showToast('Error updating product: ' + error.message, 'error');
            }

            editingProductId = null;
            closeModal();
            renderNewStuff();
        }

        function openRestockModal(itemId) {
            const modal = document.getElementById('modal');
            modal.dataset.itemId = itemId;
            openModal('restock-request');
        }

        function submitRestockFromModal(itemId) {
            const item = inventory.find(i => i.id == itemId);
            const date = document.getElementById('restock-date').value;
            const store = document.getElementById('restock-modal-store').value;
            const qtyHand = document.getElementById('restock-qty-hand').value;
            const isCustomerRequest = document.getElementById('customer-request').checked;
            const customerInfo = document.getElementById('customer-info').value;
            const notes = document.getElementById('restock-modal-notes').value;

            if (!date || !store || !qtyHand) {
                alert('Please fill in all required fields');
                return;
            }

            if (isCustomerRequest && !customerInfo) {
                alert('Please provide customer information');
                return;
            }

            const productName = `${item.brand} ${item.productName} - ${item.flavor}`;
            const noteText = isCustomerRequest
                ? `Customer Request: ${customerInfo}${notes ? '\n' + notes : ''}`
                : notes;

            const newRequest = {
                productName: productName,
                quantity: item.minStock - parseInt(qtyHand),
                store,
                requestedBy: 'Carlos Admin',
                requestDate: date,
                status: 'pending',
                priority: parseInt(qtyHand) < item.minStock * 0.3 ? 'high' : parseInt(qtyHand) < item.minStock * 0.6 ? 'medium' : 'low',
                notes: noteText
            };

            // Save to Firebase if initialized
            if (firebaseRestockRequestsManager.isInitialized) {
                firebaseRestockRequestsManager.addRestockRequest(newRequest).then(newId => {
                    if (newId) {
                        restockRequests.unshift({
                            id: newId,
                            firestoreId: newId,
                            ...newRequest
                        });
                        console.log(' Restock request created in Firebase');
                        closeModal();
                        currentRestockTab = 'requests';
                        renderRestockRequests();
                    }
                }).catch(error => {
                    console.error('Error creating restock request in Firebase:', error);
                    alert('Error creating restock request: ' + error.message);
                });
            } else {
                // Fallback to local storage only
                restockRequests.unshift({
                    id: restockRequests.length + 1,
                    ...newRequest
                });
                closeModal();
                currentRestockTab = 'requests';
                renderRestockRequests();
            }
        }

        // Helper function to populate employee dropdown for restock requests
        function populateEmployeeDropdown(selectId, selectedValue = '') {
            const select = document.getElementById(selectId);
            if (!select) return;

            // Clear existing options except the first placeholder
            select.innerHTML = '<option value="">Select employee...</option>';

            // Add active employees from the employees array
            const activeEmployees = employees.filter(emp => emp.status === 'active');
            activeEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = `${emp.name} (${emp.store})`;
                if (emp.name === selectedValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function openNewRestockRequestModal() {
            openModal('new-restock-request');

            // Populate employee dropdown and enable/disable customer info field
            setTimeout(() => {
                // Populate employee dropdown
                populateEmployeeDropdown('new-restock-requested-by');

                const checkbox = document.getElementById('new-restock-customer-request');
                const customerInfo = document.getElementById('new-restock-customer-info');

                if (checkbox && customerInfo) {
                    checkbox.addEventListener('change', function() {
                        customerInfo.disabled = !this.checked;
                        customerInfo.style.background = this.checked ? 'var(--bg-primary)' : 'var(--bg-hover)';
                        if (!this.checked) customerInfo.value = '';
                    });
                }
            }, 100);
        }

        function submitNewRestockRequest() {
            const itemType = document.getElementById('new-restock-item-type').value;
            const product = document.getElementById('new-restock-product').value;
            const brand = document.getElementById('new-restock-brand').value;
            const flavor = document.getElementById('new-restock-flavor').value;
            const quantity = document.getElementById('new-restock-quantity').value;
            const priority = document.getElementById('new-restock-priority').value;
            const date = document.getElementById('new-restock-date').value;
            const store = document.getElementById('new-restock-store').value;
            const requestedBy = document.getElementById('new-restock-requested-by').value;
            const isCustomerRequest = document.getElementById('new-restock-customer-request').checked;
            const customerInfo = document.getElementById('new-restock-customer-info').value;
            const notes = document.getElementById('new-restock-notes').value;

            // Validation
            if (!product || !quantity || !priority || !date || !store || !requestedBy) {
                alert('Please fill in all required fields');
                return;
            }

            if (isCustomerRequest && !customerInfo) {
                alert('Please provide customer information');
                return;
            }

            // Build product name
            let productName = product;
            if (brand) productName = `${brand} ${productName}`;
            if (flavor) productName = `${productName} - ${flavor}`;

            // Build notes
            const noteText = isCustomerRequest
                ? `Customer Request: ${customerInfo}${notes ? '\n' + notes : ''}`
                : notes;

            // Create request object
            const newRequest = {
                productName: productName,
                itemType: itemType,
                quantity: parseInt(quantity),
                store,
                requestedBy,
                requestDate: date,
                status: 'pending',
                priority,
                notes: noteText
            };

            // Save to Firebase if initialized
            if (firebaseRestockRequestsManager.isInitialized) {
                firebaseRestockRequestsManager.addRestockRequest(newRequest).then(newId => {
                    if (newId) {
                        // Add to local array with Firestore ID
                        restockRequests.unshift({
                            id: newId,
                            firestoreId: newId,
                            ...newRequest
                        });
                        console.log(' Restock request created in Firebase');
                        closeModal();
                        currentRestockTab = 'requests';
                        renderRestockRequests();
                    } else {
                        alert('Error creating restock request. Please try again.');
                    }
                }).catch(error => {
                    console.error('Error creating restock request in Firebase:', error);
                    alert('Error creating restock request: ' + error.message);
                });
            } else {
                // Fallback to local storage only
                restockRequests.unshift({
                    id: restockRequests.length + 1,
                    ...newRequest
                });
                closeModal();
                currentRestockTab = 'requests';
                renderRestockRequests();
            }
        }

        // Initialize navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            const page = item.querySelector('.nav-icon i').className.split(' ')[1].replace('fa-', '');
            const pageMap = {
                'th-large': 'dashboard',
                'users': 'employees',
                'graduation-cap': 'training',
                'folder-open': 'licenses',
                'chart-line': 'analytics',
                'box': 'newstuff',
                'boxes': 'restock',
                'cloud': 'abundancecloud',
                'store': 'stores',
                'bullhorn': 'announcements',
                'calendar-alt': 'schedule',
                'user-secret': 'thieves',
                'file-invoice-dollar': 'invoices',
                'exclamation-triangle': 'issues',
                'wallet': 'gconomics',
                'truck': 'vendors',
                'clock': 'clockin',
                'chart-bar': 'dailysales',
                'money-bill-wave': 'cashout',
                'vault': 'treasury',
                'coins': 'change',
                'gift': 'gifts',
                'shield-halved': 'risknotes',
                'key': 'passwords',
                'bolt': 'gforce'
            };
            item.dataset.page = pageMap[page] || 'dashboard';
            
            item.addEventListener('click', function(e) {
                // Allow external links (like Abundance Cloud) to navigate normally
                if (this.classList.contains('external-link') || this.getAttribute('href') !== '#') {
                    return; // Let the browser handle the navigation
                }
                e.preventDefault();
                navigateTo(this.dataset.page);
            });
        });

        // Close modal on background click
        const modal = document.getElementById('modal');
        if (modal) {
            modal.addEventListener('mousedown', function(e) {
                if (e.target === this) {
                    // Check form protection before closing
                    if (typeof formProtectionManager !== 'undefined' && formProtectionManager.shouldPreventClose()) {
                        formProtectionManager.showConfirmDialog();
                        return;
                    }
                    closeModal();
                }
            });
        }

        // Close expense modal on background click
        const expenseModal = document.getElementById('expenseModal');
        if (expenseModal) {
            expenseModal.addEventListener('mousedown', function(e) {
                if (e.target === this) {
                    // Check form protection before closing
                    if (typeof formProtectionManager !== 'undefined' && formProtectionManager.shouldPreventClose()) {
                        formProtectionManager.showConfirmDialog();
                        return;
                    }
                    closeExpenseModal();
                }
            });
        }

        // Training video player functions
        function getVideoEmbedUrl(url) {
            // Detect YouTube URLs
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const youtubeMatch = url.match(youtubeRegex);

            if (youtubeMatch) {
                return {
                    type: 'youtube',
                    embedUrl: `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=1`
                };
            }

            // Detect Vimeo URLs
            const vimeoRegex = /vimeo\.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:$|\/|\?)/;
            const vimeoMatch = url.match(vimeoRegex);

            if (vimeoMatch) {
                return {
                    type: 'vimeo',
                    embedUrl: `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1`
                };
            }

            return null;
        }

        function playTrainingVideo(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.id === parseInt(trainingId));
            if (!training || training.type !== 'video') return;

            const videoInfo = getVideoEmbedUrl(training.url);
            if (!videoInfo) {
                showToast('Invalid video URL. Please use a YouTube or Vimeo link.', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>${training.title}</h2>
                    <button class="modal-close" onclick="closeVideoPlayer()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                        <iframe
                            src="${videoInfo.embedUrl}"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                            frameborder="0"
                            allow="autoplay; fullscreen; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span style="color: var(--text-muted); font-size: 13px;">
                            <i class="fas fa-${training.required ? 'exclamation-circle' : 'check'}"></i> ${training.required ? 'Required' : 'Optional'}
                        </span>
                        <button class="btn-primary" onclick="closeVideoPlayer()">Close</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        function closeVideoPlayer() {
            closeModal();
        }

        function viewTraining(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.id === parseInt(trainingId));
            if (!training) {
                showToast('Training not found', 'error');
                return;
            }

            if (training.type === 'video') {
                playTrainingVideo(trainingId);
            } else {
                // For document type, show PDF preview modal
                showTrainingDetailsModal(training);
            }
        }

        // Show training details modal with PDF preview
        function showTrainingDetailsModal(training) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const hasPdf = training.fileUrl && training.type === 'document';
            const fileSize = training.fileSize ? formatFileSize(training.fileSize) : 'N/A';

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-file-pdf" style="color: #ef4444; margin-right: 10px;"></i>${training.title}</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    ${hasPdf ? `
                        <div style="background: var(--bg-tertiary); border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
                            <iframe
                                src="${training.fileUrl}"
                                style="width: 100%; height: 500px; border: none;"
                                title="PDF Preview">
                            </iframe>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px; background: var(--bg-tertiary); border-radius: 12px; margin-bottom: 20px;">
                            <i class="fas fa-file-pdf" style="font-size: 64px; color: #ef4444; margin-bottom: 16px;"></i>
                            <p style="color: var(--text-muted);">No PDF file available for preview</p>
                        </div>
                    `}

                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Training Details</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Type</label>
                                    <span style="font-weight: 500; color: var(--text-primary);">${(training.type || 'Document').toUpperCase()}</span>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Status</label>
                                    <span class="badge ${training.required ? 'danger' : 'success'}">${training.required ? 'Required' : 'Optional'}</span>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Completion</label>
                                    <span style="font-weight: 500; color: var(--text-primary);">${training.completion || 0}%</span>
                                </div>
                                ${training.fileName ? `
                                    <div style="grid-column: span 2;">
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">File</label>
                                        <span style="font-weight: 500; color: var(--text-primary);">
                                            <i class="fas fa-file-pdf" style="color: #ef4444;"></i> ${training.fileName} (${fileSize})
                                        </span>
                                    </div>
                                ` : ''}
                                ${training.description ? `
                                    <div style="grid-column: span 2;">
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Description</label>
                                        <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">${training.description}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    ${training.required ? `
                        <div class="card">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="margin: 0; color: var(--text-primary);">
                                    <i class="fas fa-users"></i> Completion Tracking
                                </h4>
                                <button class="btn-primary" onclick="openTrainingCompletionModal('${training.id}')">
                                    <i class="fas fa-check-circle"></i> Manage Completions
                                </button>
                            </div>
                            <div class="card-body">
                                ${renderTrainingCompletionSummary(training)}
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div style="display: flex; gap: 8px;">
                            ${hasPdf ? `
                                <a href="${training.fileUrl}" target="_blank" class="btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-external-link-alt"></i> Open in New Tab
                                </a>
                                <a href="${training.fileUrl}" download="${training.fileName || 'training.pdf'}" class="btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            ` : ''}
                        </div>
                        <button class="btn-primary" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        // Edit training function
        function editTraining(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.id === parseInt(trainingId));
            if (!training) {
                showToast('Training not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Edit Training Material</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" class="form-input" id="edit-training-title" value="${training.title || ''}" placeholder="Training name...">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <input type="text" class="form-input" value="${(training.type || 'document').toUpperCase()}" disabled style="background: var(--bg-tertiary);">
                    </div>
                    ${training.type === 'video' ? `
                        <div class="form-group">
                            <label>Video URL</label>
                            <input type="url" class="form-input" id="edit-training-url" value="${training.url || ''}" placeholder="https://youtube.com/watch?v=...">
                        </div>
                    ` : ''}
                    ${training.fileName ? `
                        <div class="form-group">
                            <label>Current File</label>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-file-pdf" style="font-size: 24px; color: #ef4444;"></i>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${training.fileName}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${training.fileSize ? formatFileSize(training.fileSize) : 'Unknown size'}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-input" id="edit-training-description" rows="3" placeholder="Brief description...">${training.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="edit-training-required" ${training.required ? 'checked' : ''}>
                            <span>Required for all employees</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn-primary" onclick="updateTraining('${trainingId}')">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            `;
            modal.classList.add('active');
        }

        // Update training in Firebase
        async function updateTraining(trainingId) {
            const title = document.getElementById('edit-training-title').value.trim();
            const urlInput = document.getElementById('edit-training-url');
            const url = urlInput ? urlInput.value.trim() : '';
            const description = document.getElementById('edit-training-description').value.trim();
            const required = document.getElementById('edit-training-required').checked;

            if (!title) {
                showToast('Please enter a title', 'error');
                return;
            }

            // Check if this is a mock training (numeric ID like "1", "2", etc.)
            const isMockTraining = /^\d+$/.test(String(trainingId));

            if (isMockTraining) {
                showToast('Cannot edit demo training. Please delete it and create a new one in Firebase.', 'warning');
                closeModal();
                return;
            }

            try {
                if (!firebaseTrainingManager.isInitialized) {
                    await firebaseTrainingManager.initialize();
                }

                const updateData = {
                    title,
                    description,
                    required
                };

                if (url) {
                    updateData.url = url;
                }

                const success = await firebaseTrainingManager.updateTraining(trainingId, updateData);

                if (success) {
                    showToast('Training updated successfully!', 'success');
                    closeModal();
                    await loadTrainingsFromFirebase();
                    renderPage(currentPage);
                } else {
                    throw new Error('Failed to update training');
                }
            } catch (error) {
                console.error('Error updating training:', error);

                // Check if error is "document not found"
                if (error.message && error.message.includes('No document to update')) {
                    showToast('This training does not exist in Firebase. Please create a new one.', 'warning');
                } else {
                    showToast('Error updating training: ' + error.message, 'error');
                }
            }
        }

        // Delete training from Firebase
        async function deleteTraining(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.id === parseInt(trainingId));
            if (!training) {
                showToast('Training not found', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${training.title}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                if (!firebaseTrainingManager.isInitialized) {
                    await firebaseTrainingManager.initialize();
                }

                        const success = await firebaseTrainingManager.deleteTraining(trainingId);

                if (success) {
                    showToast('Training deleted successfully!', 'success');
                    await loadTrainingsFromFirebase();
                    renderPage(currentPage);
                } else {
                    throw new Error('Failed to delete training');
                }
            } catch (error) {
                console.error('Error deleting training:', error);
                showToast('Error deleting training: ' + error.message, 'error');
            }
        }

        // Render training completion summary
        function renderTrainingCompletionSummary(training) {
            const completions = training.completions || [];
            const totalEmployees = employees.length;
            const completedCount = completions.length;
            const completionPercentage = totalEmployees > 0 ? Math.round((completedCount / totalEmployees) * 100) : 0;

            return `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 14px; color: var(--text-secondary);">Completion Progress</span>
                        <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${completedCount} / ${totalEmployees} employees (${completionPercentage}%)</span>
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; height: 12px; overflow: hidden;">
                        <div style="background: ${completionPercentage === 100 ? '#10b981' : '#6366f1'}; height: 100%; width: ${completionPercentage}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                ${completedCount > 0 ? `
                    <div style="max-height: 200px; overflow-y: auto;">
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Recently Completed:</div>
                        ${completions.slice(0, 5).map(c => {
                            const emp = employees.find(e => (e.firestoreId || e.id) === c.employeeId);
                            const completedDate = c.completedAt ? (c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt)) : null;
                            return `
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 4px;">
                                    <span style="font-size: 13px; color: var(--text-primary);">
                                        <i class="fas fa-check-circle" style="color: #10b981;"></i> ${emp ? emp.name : 'Unknown Employee'}
                                    </span>
                                    <span style="font-size: 12px; color: var(--text-muted);">${completedDate ? formatDate(completedDate) : 'N/A'}</span>
                                </div>
                            `;
                        }).join('')}
                        ${completedCount > 5 ? `<div style="font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 8px;">+${completedCount - 5} more</div>` : ''}
                    </div>
                ` : '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 14px;">No employees have completed this training yet</div>'}
            `;
        }

        // View mandatory training compliance
        function viewMandatoryTrainingCompliance() {
            const mandatoryTrainings = trainings.filter(t => t.required);

            openModal('mandatory-compliance', { mandatoryTrainings, employees });
        }

        // Open training completion modal
        function openTrainingCompletionModal(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.firestoreId === trainingId);
            if (!training) {
                showToast('Training not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const completions = training.completions || [];
            const employeesWithStatus = employees.map(emp => {
                const empId = emp.firestoreId || emp.id;
                const completion = completions.find(c => c.employeeId === empId);
                return {
                    ...emp,
                    completed: !!completion,
                    completedAt: completion ? (completion.completedAt.toDate ? completion.completedAt.toDate() : new Date(completion.completedAt)) : null
                };
            });

            const completedEmployees = employeesWithStatus.filter(e => e.completed);
            const pendingEmployees = employeesWithStatus.filter(e => !e.completed);

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-check-circle"></i> Manage Completions: ${training.title}</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <div style="flex: 1; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
                                <div style="font-size: 28px; font-weight: 700;">${completedEmployees.length}</div>
                                <div style="font-size: 13px; opacity: 0.9;">Completed</div>
                            </div>
                            <div style="flex: 1; padding: 16px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; color: white;">
                                <div style="font-size: 28px; font-weight: 700;">${pendingEmployees.length}</div>
                                <div style="font-size: 13px; opacity: 0.9;">Pending</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <input type="text" id="completion-search" class="form-input" placeholder="Search employees..." oninput="filterCompletionList()">
                    </div>

                    <div id="completion-list" style="max-height: 400px; overflow-y: auto;">
                        ${employeesWithStatus.map(emp => `
                            <div class="completion-item" data-employee-name="${emp.name.toLowerCase()}">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: var(--text-primary);">${emp.name}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${emp.role}  ${emp.store}</div>
                                        ${emp.completed ? `<div style="font-size: 12px; color: #10b981; margin-top: 4px;"><i class="fas fa-check-circle"></i> Completed on ${formatDate(emp.completedAt)}</div>` : ''}
                                    </div>
                                    <div>
                                        ${emp.completed ? `
                                            <button class="btn-secondary" onclick="toggleEmployeeCompletion('${training.id}', '${emp.firestoreId || emp.id}', false)">
                                                <i class="fas fa-times"></i> Remove
                                            </button>
                                        ` : `
                                            <button class="btn-primary" onclick="toggleEmployeeCompletion('${training.id}', '${emp.firestoreId || emp.id}', true)">
                                                <i class="fas fa-check"></i> Mark Complete
                                            </button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Filter completion list
        function filterCompletionList() {
            const search = document.getElementById('completion-search').value.toLowerCase();
            const items = document.querySelectorAll('.completion-item');

            items.forEach(item => {
                const name = item.dataset.employeeName;
                if (name.includes(search)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Toggle employee completion
        async function toggleEmployeeCompletion(trainingId, employeeId, markComplete) {
            try {
                if (!firebaseTrainingManager.isInitialized) {
                    await firebaseTrainingManager.initialize();
                }

                let success;
                if (markComplete) {
                    success = await firebaseTrainingManager.markEmployeeCompleted(trainingId, employeeId);
                } else {
                    success = await firebaseTrainingManager.removeEmployeeCompletion(trainingId, employeeId);
                }

                if (success) {
                    showToast(markComplete ? 'Employee marked as completed' : 'Completion removed', 'success');

                    // Reload trainings to get updated completion data
                    await loadTrainingsFromFirebase();

                    // Re-open the modal with updated data
                    openTrainingCompletionModal(trainingId);
                } else {
                    throw new Error('Failed to update completion status');
                }
            } catch (error) {
                console.error('Error toggling completion:', error);
                showToast('Error updating completion status', 'error');
            }
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');

            if (body.classList.contains('light-theme')) {
                // Switch to dark theme
                body.classList.remove('light-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                // Switch to light theme
                body.classList.add('light-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        }

        // Load theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');

            // Default to light theme if no saved preference
            if (!savedTheme || savedTheme === 'light') {
                document.body.classList.add('light-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                if (!savedTheme) {
                    localStorage.setItem('theme', 'light');
                }
            }
        }

        // User menu dropdown functionality
        function toggleUserMenu() {
            const container = document.querySelector('.user-menu-container');
            if (container) {
                container.classList.toggle('open');
            }
        }

        function closeUserMenu() {
            const container = document.querySelector('.user-menu-container');
            if (container) {
                container.classList.remove('open');
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.querySelector('.user-menu-container');
            if (container && !container.contains(e.target)) {
                container.classList.remove('open');
            }
        });

        // Logout functionality
        function logout() {
            // Clear auth data
            if (typeof authManager !== 'undefined') {
                authManager.logout();
            }
            
            // Clear all localStorage data for security
            localStorage.clear();
            
            // Also clear sessionStorage to ensure clean state
            sessionStorage.clear();

            // Redirect to login page
            window.location.href = 'login.html';
        }

        // Global Search Functionality
        let searchTimeout = null;

        function handleGlobalSearch(query) {
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // Debounce search for better performance
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 150);
        }

        function performSearch(query) {
            const dropdown = document.getElementById('search-results-dropdown');
            const resultsList = document.getElementById('search-results-list');

            if (!query || query.trim().length < 2) {
                dropdown.classList.remove('show');
                return;
            }

            const searchTerm = query.toLowerCase().trim();
            const results = [];

            // Search Employees
            const employeeResults = employees.filter(emp =>
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.role.toLowerCase().includes(searchTerm) ||
                emp.store.toLowerCase().includes(searchTerm) ||
                emp.email.toLowerCase().includes(searchTerm)
            ).slice(0, 5);

            if (employeeResults.length > 0) {
                results.push({
                    category: 'Employees',
                    icon: 'fa-users',
                    page: 'employees',
                    items: employeeResults.map(emp => ({
                        id: emp.id,
                        title: emp.name,
                        subtitle: `${emp.role} - ${emp.store}`,
                        status: emp.status
                    }))
                });
            }

            // Search Thieves Database
            const thiefResults = thieves.filter(thief =>
                thief.name.toLowerCase().includes(searchTerm) ||
                thief.store.toLowerCase().includes(searchTerm) ||
                thief.crimeType.toLowerCase().includes(searchTerm) ||
                (thief.itemsStolen && thief.itemsStolen.toLowerCase().includes(searchTerm))
            ).slice(0, 5);

            if (thiefResults.length > 0) {
                results.push({
                    category: 'Thieves Database',
                    icon: 'fa-user-secret',
                    page: 'thieves',
                    items: thiefResults.map(thief => ({
                        id: thief.id,
                        title: thief.name,
                        subtitle: `${thief.crimeType} - ${thief.store}`,
                        status: thief.banned ? 'banned' : 'active'
                    }))
                });
            }

            // Search Invoices
            const invoiceResults = invoices.filter(inv =>
                inv.invoiceNumber.toLowerCase().includes(searchTerm) ||
                inv.vendor.toLowerCase().includes(searchTerm) ||
                inv.category.toLowerCase().includes(searchTerm) ||
                inv.description.toLowerCase().includes(searchTerm)
            ).slice(0, 5);

            if (invoiceResults.length > 0) {
                results.push({
                    category: 'Invoices',
                    icon: 'fa-file-invoice-dollar',
                    page: 'invoices',
                    items: invoiceResults.map(inv => ({
                        id: inv.id,
                        title: inv.invoiceNumber,
                        subtitle: `${inv.vendor} - $${inv.amount.toFixed(2)}`,
                        status: inv.status
                    }))
                });
            }

            // Search Products (New Stuff)
            const productResults = products.filter(prod =>
                prod.name.toLowerCase().includes(searchTerm) ||
                prod.category.toLowerCase().includes(searchTerm) ||
                prod.store.toLowerCase().includes(searchTerm) ||
                prod.supplier.toLowerCase().includes(searchTerm)
            ).slice(0, 5);

            if (productResults.length > 0) {
                results.push({
                    category: 'New Products',
                    icon: 'fa-box-open',
                    page: 'newstuff',
                    items: productResults.map(prod => ({
                        id: prod.id,
                        title: prod.name,
                        subtitle: `${prod.category} - ${prod.store}`,
                        status: prod.status
                    }))
                });
            }

            // Search Inventory
            const inventoryResults = inventory.filter(item =>
                item.brand.toLowerCase().includes(searchTerm) ||
                item.productName.toLowerCase().includes(searchTerm) ||
                item.flavor.toLowerCase().includes(searchTerm) ||
                item.store.toLowerCase().includes(searchTerm)
            ).slice(0, 5);

            if (inventoryResults.length > 0) {
                results.push({
                    category: 'Inventory',
                    icon: 'fa-warehouse',
                    page: 'restock',
                    items: inventoryResults.map(item => ({
                        id: item.id,
                        title: `${item.brand} ${item.productName}`,
                        subtitle: `${item.flavor} - ${item.store} (${item.stock} in stock)`,
                        status: item.stock <= item.minStock ? 'low' : 'ok'
                    }))
                });
            }

            // Search Announcements
            const announcementResults = announcements.filter(ann =>
                ann.title.toLowerCase().includes(searchTerm) ||
                ann.content.toLowerCase().includes(searchTerm) ||
                ann.author.toLowerCase().includes(searchTerm)
            ).slice(0, 5);

            if (announcementResults.length > 0) {
                results.push({
                    category: 'Announcements',
                    icon: 'fa-bullhorn',
                    page: 'announcements',
                    items: announcementResults.map(ann => ({
                        id: ann.id,
                        title: ann.title,
                        subtitle: `${ann.date} - ${ann.author}`,
                        status: 'info'
                    }))
                });
            }

            // Render results
            renderSearchResults(results, resultsList, dropdown);
        }

        function renderSearchResults(results, resultsList, dropdown) {
            if (results.length === 0) {
                resultsList.innerHTML = `
                    <div class="search-empty">
                        <i class="fas fa-search"></i>
                        <p>No results found</p>
                    </div>
                `;
                dropdown.classList.add('show');
                return;
            }

            let html = '';

            results.forEach(category => {
                html += `<div class="search-category">${category.category}</div>`;

                category.items.forEach(item => {
                    const statusClass = getStatusClass(item.status);
                    html += `
                        <div class="search-result-item" onclick="navigateToSearchResult('${category.page}', ${item.id})">
                            <div class="search-result-icon">
                                <i class="fas ${category.icon}"></i>
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-title">${escapeHtml(item.title)}</div>
                                <div class="search-result-subtitle">${escapeHtml(item.subtitle)}</div>
                            </div>
                            <span class="search-result-status ${statusClass}">${item.status}</span>
                        </div>
                    `;
                });
            });

            html += `
                <div class="search-shortcut-hint">
                    <span><kbd></kbd><kbd></kbd> to navigate</span>
                    <span><kbd>Enter</kbd> to select</span>
                    <span><kbd>Esc</kbd> to close</span>
                </div>
            `;

            resultsList.innerHTML = html;
            dropdown.classList.add('show');
        }

        function getStatusClass(status) {
            const statusMap = {
                'active': 'status-active',
                'inactive': 'status-inactive',
                'banned': 'status-banned',
                'pending': 'status-pending',
                'paid': 'status-paid',
                'overdue': 'status-overdue',
                'arrived': 'status-arrived',
                'low': 'status-low',
                'ok': 'status-ok',
                'info': 'status-info'
            };
            return statusMap[status] || 'status-default';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function navigateToSearchResult(page, itemId) {
            // Hide search dropdown
            hideSearchResults();

            // Clear search input
            const searchInput = document.getElementById('global-search');
            if (searchInput) {
                searchInput.value = '';
            }

            // Navigate to the page
            navigateTo(page);

            // Optionally highlight or scroll to the item (future enhancement)
            console.log(`Navigated to ${page}, item ID: ${itemId}`);
        }

        function showSearchResults() {
            const dropdown = document.getElementById('search-results-dropdown');
            const searchInput = document.getElementById('global-search');

            if (searchInput && searchInput.value.trim().length >= 2) {
                performSearch(searchInput.value);
            }
        }

        function hideSearchResults() {
            const dropdown = document.getElementById('search-results-dropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // Close search dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-bar-container');
            if (searchContainer && !searchContainer.contains(e.target)) {
                hideSearchResults();
            }
        });

        // Keyboard shortcuts for search
        document.addEventListener('keydown', function(e) {
            // Ctrl+K or Cmd+K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('global-search');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }

            // Escape to close search dropdown
            if (e.key === 'Escape') {
                hideSearchResults();
                const searchInput = document.getElementById('global-search');
                if (searchInput) {
                    searchInput.blur();
                }
            }
        });

        // Load theme on page initialization
        loadTheme();

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Close mobile menu when clicking nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            const existingListener = item.onclick;
            item.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    sidebar.classList.remove('mobile-open');
                }
            });
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const mobileMenuBtn = document.querySelector('.mobile-menu-btn');

                // Check if sidebar is open and click is outside sidebar and menu button
                if (sidebar.classList.contains('mobile-open') &&
                    !sidebar.contains(event.target) &&
                    !mobileMenuBtn.contains(event.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });

        // Dropdown toggle functionality
        function toggleDropdown(event, dropdownId) {
            event.preventDefault();
            const dropdown = document.getElementById(`dropdown-${dropdownId}`);
            const navItem = event.currentTarget;
            const icon = navItem.querySelector('.dropdown-icon');

            // Close all other dropdowns
            document.querySelectorAll('.nav-dropdown').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('open');
                    const otherIcon = dd.previousElementSibling.querySelector('.dropdown-icon');
                    if (otherIcon) otherIcon.style.transform = '';
                }
            });

            // Toggle current dropdown
            dropdown.classList.toggle('open');
            if (dropdown.classList.contains('open')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = '';
            }
        }

        // Make toggleDropdown globally accessible
        window.toggleDropdown = toggleDropdown;

        // Drag and drop functionality for licenses
        let draggedLicenseId = null;
        let licensesEditMode = false;  // Edit mode toggle for drag and drop

        function handleLicenseDragStart(event, licenseId) {
            if (!licensesEditMode) {
                event.preventDefault();
                return;
            }
            draggedLicenseId = licenseId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleLicenseDragOver(event) {
            if (!licensesEditMode) return;
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const dropZone = event.currentTarget;
            dropZone.classList.add('drag-over');
        }

        function handleLicenseDragLeave(event) {
            const dropZone = event.currentTarget;
            dropZone.classList.remove('drag-over');
        }

        function handleLicenseDrop(event, targetStore) {
            if (!licensesEditMode) return;
            event.preventDefault();
            const dropZone = event.currentTarget;
            dropZone.classList.remove('drag-over');

            if (draggedLicenseId !== null) {
                const license = licenses.find(l => l.id === draggedLicenseId);
                if (license && license.store !== targetStore) {
                    license.store = targetStore;
                    renderLicenses();
                }
                draggedLicenseId = null;
            }
        }

        function toggleLicensesEditMode() {
            licensesEditMode = !licensesEditMode;
            renderLicenses();
        }

        function viewLicense(licenseId) {
            const license = licenses.find(l => l.id === licenseId || l.firestoreId === licenseId);
            if (!license) return;

            // If license has PDF data, open it
            if (license.fileData) {
                viewLicensePdf(licenseId);
            } else {
                // Show license details in a modal/alert
                alert(`License: ${license.name}\nStore: ${license.store}\nExpires: ${formatDate(license.expires)}\nStatus: ${license.status}\n${license.uploadedBy ? 'Uploaded by: ' + license.uploadedBy : ''}`);
            }
        }

        // Note: deleteLicense is defined earlier in the file with Firebase support

        // RISK NOTES FUNCTIONALITY
        const RISK_BEHAVIOR_TYPES = [
            { id: 'strange_questions', label: 'Strange Questions', icon: 'fa-question-circle', color: '#f59e0b' },
            { id: 'unusual_purchase', label: 'Unusual Purchase', icon: 'fa-shopping-cart', color: '#3b82f6' },
            { id: 'recording', label: 'Recording / Taking Photos', icon: 'fa-camera', color: '#8b5cf6' },
            { id: 'policy_violation', label: 'Policy Violation Attempt', icon: 'fa-ban', color: '#ef4444' },
            { id: 'suspicious_attitude', label: 'Suspicious Attitude', icon: 'fa-user-secret', color: '#ec4899' },
            { id: 'other', label: 'Other', icon: 'fa-ellipsis', color: '#6b7280' }
        ];

        const RISK_LEVELS = [
            { id: 'low', label: 'Low', color: '#22c55e', icon: 'fa-circle' },
            { id: 'medium', label: 'Medium', color: '#f59e0b', icon: 'fa-circle' },
            { id: 'high', label: 'High', color: '#ef4444', icon: 'fa-circle' }
        ];

        const RISK_STORES = [
            'Miramar',
            'Morena',
            'Kearny Mesa',
            'Chula Vista',
            'North Park',
            'Miramar Wine & Liquor'
        ];

        // IndexedDB setup for storing images
        let riskPhotoDB = null;
        const initRiskPhotoDB = async () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('RiskNotesDB', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    riskPhotoDB = request.result;
                    resolve(riskPhotoDB);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('photos')) {
                        db.createObjectStore('photos', { keyPath: 'id' });
                    }
                };
            });
        };

        const savePhotoToIndexedDB = async (noteId, photoData) => {
            if (!riskPhotoDB) await initRiskPhotoDB();
            return new Promise((resolve, reject) => {
                const tx = riskPhotoDB.transaction('photos', 'readwrite');
                const store = tx.objectStore('photos');
                store.put({ id: noteId, data: photoData });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        };

        const getPhotoFromIndexedDB = async (noteId) => {
            if (!riskPhotoDB) await initRiskPhotoDB();
            return new Promise((resolve, reject) => {
                const tx = riskPhotoDB.transaction('photos', 'readonly');
                const store = tx.objectStore('photos');
                const request = store.get(noteId);
                request.onsuccess = () => resolve(request.result?.data);
                request.onerror = () => reject(request.error);
            });
        };

        const deletePhotoFromIndexedDB = async (noteId) => {
            if (!riskPhotoDB) await initRiskPhotoDB();
            return new Promise((resolve, reject) => {
                const tx = riskPhotoDB.transaction('photos', 'readwrite');
                const store = tx.objectStore('photos');
                const request = store.delete(noteId);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        };

        // Initialize IndexedDB on page load
        initRiskPhotoDB().catch(err => {
            console.error('Failed to initialize IndexedDB:', err);
        });

        let riskNotesState = {
            notes: JSON.parse(localStorage.getItem('riskNotes')) || [],
            filterStore: 'all',
            filterLevel: 'all',
            filterType: 'all'
        };

        // Load risk notes from Firebase when available
        async function loadRiskNotesFromFirebase() {
            // Wait for firebaseSyncManager to be initialized
            if (typeof firebaseSyncManager === 'undefined') {
                console.log('FirebaseSyncManager not available');
                return;
            }

            // If not initialized yet, try to initialize
            if (!firebaseSyncManager.isInitialized) {
                try {
                    await firebaseSyncManager.initialize();
                } catch (err) {
                    console.error('Failed to initialize firebaseSyncManager:', err);
                    return;
                }
            }

            if (!firebaseSyncManager.isInitialized) {
                console.log('FirebaseSyncManager could not be initialized');
                return;
            }

            try {
                console.log(' Loading risk notes from Firebase...');
                const firebaseNotes = await firebaseSyncManager.loadRiskNotesFromFirestore();

                // Merge Firebase notes with local notes (Firebase takes priority)
                const localNotes = JSON.parse(localStorage.getItem('riskNotes')) || [];
                const mergedNotes = [...(firebaseNotes || [])];

                // Add local notes that don't have a firestoreId (not yet synced)
                for (const localNote of localNotes) {
                    if (!localNote.firestoreId && !mergedNotes.find(n => n.id === localNote.id)) {
                        mergedNotes.push(localNote);
                        // Sync this local note to Firebase
                        try {
                            const firestoreId = await firebaseSyncManager.saveRiskNoteToFirestore(localNote);
                            if (firestoreId) {
                                localNote.firestoreId = firestoreId;
                                // Update in mergedNotes
                                const noteInMerged = mergedNotes.find(n => n.id === localNote.id);
                                if (noteInMerged) noteInMerged.firestoreId = firestoreId;
                            }
                        } catch (syncErr) {
                            console.error('Error syncing local note to Firebase:', syncErr);
                        }
                    }
                }

                riskNotesState.notes = mergedNotes;
                saveRiskNotes();
                console.log(` Risk notes loaded: ${mergedNotes.length} total`);

                // Re-render if on risknotes page
                if (window.currentPage === 'risknotes') {
                    renderRiskNotes();
                }
            } catch (error) {
                console.error('Error loading risk notes from Firebase:', error);
            }
        }

        // Listen for Firebase sync ready event
        window.addEventListener('firebaseSyncReady', () => {
            console.log(' Firebase sync ready - loading risk notes');
            loadRiskNotesFromFirebase();
        });

        // Also try to load after a delay as fallback
        setTimeout(() => {
            if (riskNotesState.notes.length === 0 || !riskNotesState.notes.some(n => n.firestoreId)) {
                loadRiskNotesFromFirebase();
            }
        }, 2000);

        function saveRiskNotes() {
            // Store notes WITHOUT photo data in localStorage (only metadata)
            const notesForStorage = riskNotesState.notes.map(note => {
                const { photo, ...noteData } = note;
                return noteData;
            });
            localStorage.setItem('riskNotes', JSON.stringify(notesForStorage));
        }

        function renderRiskNotes() {
            const dashboard = document.querySelector('.dashboard');
            const currentMonth = new Date().toISOString().slice(0, 7);

            // Filter notes
            let filteredNotes = riskNotesState.notes.filter(note => {
                const storeMatch = riskNotesState.filterStore === 'all' || note.store === riskNotesState.filterStore;
                const levelMatch = riskNotesState.filterLevel === 'all' || note.level === riskNotesState.filterLevel;
                const typeMatch = riskNotesState.filterType === 'all' || note.behaviorType === riskNotesState.filterType;
                return storeMatch && levelMatch && typeMatch;
            });

            // Sort by date descending
            filteredNotes.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Monthly stats
            const monthlyNotes = riskNotesState.notes.filter(n => n.date && n.date.startsWith(currentMonth));
            const storeCounts = {};
            const typeCounts = {};

            monthlyNotes.forEach(note => {
                storeCounts[note.store] = (storeCounts[note.store] || 0) + 1;
                typeCounts[note.behaviorType] = (typeCounts[note.behaviorType] || 0) + 1;
            });

            const topStore = Object.entries(storeCounts).sort((a, b) => b[1] - a[1])[0];
            const topType = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0];

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">
                            <i class="fas fa-shield-halved" style="color: var(--accent-primary);"></i>
                            Risk Notes
                        </h2>
                        <p class="section-subtitle">Document unusual activity and stay alert</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-risknote')">
                            <i class="fas fa-plus"></i> New Risk Note
                        </button>
                    </div>
                </div>

                <!-- Safety Guidelines -->
                <div class="card" style="margin-bottom: 24px; border-left: 4px solid var(--warning); background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, var(--bg-secondary) 100%);">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: start; gap: 16px;">
                            <div style="font-size: 32px;">锔</div>
                            <div>
                                <h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">General Safety Recommendations</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; font-size: 13px; color: var(--text-secondary);">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Never sell to customers without a valid account</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Always verify ID for age-restricted products</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Trust your instincts - if something feels off, report it</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Document everything - dates, times, descriptions</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Alert manager immediately for high-risk situations</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Never confront suspicious individuals directly</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="card" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white;">
                        <div class="card-body" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700;">${monthlyNotes.length}</div>
                            <div style="font-size: 13px; opacity: 0.9;">Notes This Month</div>
                        </div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        <div class="card-body" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700;">${topStore ? topStore[1] : 0}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${topStore ? topStore[0] : 'No data'}</div>
                            <div style="font-size: 11px; opacity: 0.7;">Most Cases</div>
                        </div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white;">
                        <div class="card-body" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700;">${topType ? topType[1] : 0}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${topType ? RISK_BEHAVIOR_TYPES.find(t => t.id === topType[0])?.label || 'Unknown' : 'No data'}</div>
                            <div style="font-size: 11px; opacity: 0.7;">Most Common Type</div>
                        </div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                        <div class="card-body" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700;">${monthlyNotes.filter(n => n.level === 'high').length}</div>
                            <div style="font-size: 13px; opacity: 0.9;">High Risk</div>
                            <div style="font-size: 11px; opacity: 0.7;">Needs Attention</div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 13px; font-weight: 500;">Store:</label>
                                <select class="form-input" style="width: 160px;" onchange="filterRiskNotes('store', this.value)">
                                    <option value="all" ${riskNotesState.filterStore === 'all' ? 'selected' : ''}>All Stores</option>
                                    ${RISK_STORES.map(store => `
                                        <option value="${store}" ${riskNotesState.filterStore === store ? 'selected' : ''}>${store}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 13px; font-weight: 500;">Level:</label>
                                <select class="form-input" style="width: 140px;" onchange="filterRiskNotes('level', this.value)">
                                    <option value="all" ${riskNotesState.filterLevel === 'all' ? 'selected' : ''}>All Levels</option>
                                    ${RISK_LEVELS.map(level => `
                                        <option value="${level.id}" ${riskNotesState.filterLevel === level.id ? 'selected' : ''}>${level.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 13px; font-weight: 500;">Type:</label>
                                <select class="form-input" style="width: 180px;" onchange="filterRiskNotes('type', this.value)">
                                    <option value="all" ${riskNotesState.filterType === 'all' ? 'selected' : ''}>All Types</option>
                                    ${RISK_BEHAVIOR_TYPES.map(type => `
                                        <option value="${type.id}" ${riskNotesState.filterType === type.id ? 'selected' : ''}>${type.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <button class="btn-secondary" onclick="resetRiskNotesFilters()" style="margin-left: auto;">
                                <i class="fas fa-refresh"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Risk Notes List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i>
                            Recent Activity Notes
                        </h3>
                        <span class="badge" style="background: var(--accent-primary);">${filteredNotes.length} Notes</span>
                    </div>
                    <div class="card-body">
                        ${filteredNotes.length === 0 ? `
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <i class="fas fa-shield-halved" style="font-size: 56px; margin-bottom: 20px; display: block; opacity: 0.3;"></i>
                                <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No risk notes yet</div>
                                <div style="font-size: 14px;">Click "New Risk Note" to document unusual activity</div>
                            </div>
                        ` : `
                            <div style="display: grid; gap: 16px;">
                                ${filteredNotes.map(note => {
                                    const behaviorType = RISK_BEHAVIOR_TYPES.find(t => t.id === note.behaviorType) || RISK_BEHAVIOR_TYPES[5];
                                    const level = RISK_LEVELS.find(l => l.id === note.level) || RISK_LEVELS[0];
                                    const noteDate = new Date(note.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                                    return `
                                        <div style="background: var(--bg-secondary); border-radius: 16px; padding: 20px; border-left: 4px solid ${level.color}; transition: all 0.2s; cursor: pointer;" onclick="viewRiskNote('${note.id}')" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                <div style="display: flex; align-items: center; gap: 12px;">
                                                    <div style="width: 48px; height: 48px; background: ${behaviorType.color}20; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                                        <i class="fas ${behaviorType.icon}" style="color: ${behaviorType.color}; font-size: 20px;"></i>
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${behaviorType.label}</div>
                                                        <div style="font-size: 12px; color: var(--text-muted);">
                                                            <i class="fas fa-store"></i> ${note.store} 
                                                            <i class="fas fa-calendar"></i> ${noteDate}
                                                        </div>
                                                    </div>
                                                </div>
                                                <span style="background: ${level.color}20; color: ${level.color}; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                                    <i class="fas ${level.icon}" style="font-size: 8px;"></i> ${level.label} Risk
                                                </span>
                                            </div>
                                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                                ${note.description || 'No description'}
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                                <div style="font-size: 12px; color: var(--text-muted);">
                                                    <i class="fas fa-user"></i> ${note.reportedBy || 'Anonymous'}
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    ${note.hasPhoto ? '<i class="fas fa-image" style="color: var(--text-muted); font-size: 12px;" title="Has photo"></i>' : ''}
                                                    ${note.managerNote ? '<i class="fas fa-comment" style="color: var(--warning); font-size: 12px;" title="Has manager note"></i>' : ''}
                                                    <span style="font-size: 11px; color: var(--text-muted);">Click to view</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function filterRiskNotes(filterType, value) {
            if (filterType === 'store') riskNotesState.filterStore = value;
            if (filterType === 'level') riskNotesState.filterLevel = value;
            if (filterType === 'type') riskNotesState.filterType = value;
            renderRiskNotes();
        }

        function resetRiskNotesFilters() {
            riskNotesState.filterStore = 'all';
            riskNotesState.filterLevel = 'all';
            riskNotesState.filterType = 'all';
            renderRiskNotes();
        }

        function deleteRiskNote(noteId) {
            showConfirmModal({
                title: 'Delete Risk Note',
                message: 'Are you sure you want to delete this risk note? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    const note = riskNotesState.notes.find(n => n.id === noteId);

                    // Delete photo from Firebase Storage first if it exists
                    if (note && note.photoPath && typeof firebaseStorageHelper !== 'undefined') {
                        try {
                            await firebaseStorageHelper.deleteFile(note.photoPath);
                            console.log(' Risk note photo deleted from Storage');
                        } catch (storageErr) {
                            console.error('Error deleting photo from Storage:', storageErr);
                        }
                    }

                    // Delete from Firebase Firestore if it has a firestoreId
                    if (note && note.firestoreId && typeof firebaseSyncManager !== 'undefined' && firebaseSyncManager.isInitialized) {
                        try {
                            await firebaseSyncManager.deleteRiskNoteFromFirestore(note.firestoreId);
                            console.log(' Risk note deleted from Firestore');
                        } catch (error) {
                            console.error('Error deleting risk note from Firebase:', error);
                        }
                    }

                    riskNotesState.notes = riskNotesState.notes.filter(n => n.id !== noteId);

                    // Delete photo from IndexedDB if it exists (legacy fallback)
                    if (note && note.hasPhoto && !note.photoPath) {
                        deletePhotoFromIndexedDB(noteId).catch(err => {
                            console.error('Error deleting photo from IndexedDB:', err);
                        });
                    }

                    saveRiskNotes();
                    renderRiskNotes();

                    // Show success notification
                    if (typeof showNotification === 'function') {
                        showNotification('Risk note deleted successfully', 'success');
                    }
                }
            });
        }

        function saveRiskNote() {
            const date = document.getElementById('risknote-date').value || new Date().toISOString().split('T')[0];
            const store = document.getElementById('risknote-store').value;
            const behaviorType = document.getElementById('risknote-type').value;
            const description = document.getElementById('risknote-description').value.trim();
            const level = document.getElementById('risknote-level').value;
            const reportedBy = document.getElementById('risknote-reporter').value.trim();
            const managerNote = document.getElementById('risknote-manager-note')?.value.trim() || '';
            const photoInput = document.getElementById('risknote-photo');

            if (photoInput && photoInput.files && photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    createRiskNote(date, store, behaviorType, description, level, reportedBy, managerNote, e.target.result);
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                createRiskNote(date, store, behaviorType, description, level, reportedBy, managerNote, null);
            }
        }

        async function createRiskNote(date, store, behaviorType, description, level, reportedBy, managerNote, photo) {
            const noteId = Date.now().toString();

            // Upload photo to Firebase Storage if provided
            let photoUrl = null;
            let photoPath = null;
            if (photo) {
                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                try {
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        photo,
                        'risk-notes/photos',
                        noteId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading risk note photo to Storage:', err);
                    // Fallback to IndexedDB if Storage fails
                    try {
                        await savePhotoToIndexedDB(noteId, photo);
                    } catch (indexedErr) {
                        console.error('Error saving photo to IndexedDB:', indexedErr);
                    }
                }
            }

            const newNote = {
                id: noteId,
                date,
                store: store || 'Miramar',
                behaviorType: behaviorType || 'other',
                description: description || '',
                level: level || 'low',
                reportedBy: reportedBy || 'Staff',
                managerNote,
                hasPhoto: !!photo,
                photo: photoUrl,        // Firebase Storage URL
                photoPath: photoPath,   // For future deletion
                createdAt: new Date().toISOString()
            };

            // Save to Firebase first
            if (typeof firebaseSyncManager !== 'undefined') {
                // Initialize if needed
                if (!firebaseSyncManager.isInitialized) {
                    try {
                        await firebaseSyncManager.initialize();
                    } catch (initErr) {
                        console.error('Error initializing firebaseSyncManager:', initErr);
                    }
                }

                if (firebaseSyncManager.isInitialized) {
                    try {
                        const firestoreId = await firebaseSyncManager.saveRiskNoteToFirestore(newNote);
                        if (firestoreId) {
                            newNote.firestoreId = firestoreId;
                            console.log(' Risk note saved to Firebase:', firestoreId);
                        }
                    } catch (error) {
                        console.error('Error saving risk note to Firebase:', error);
                    }
                }
            }

            riskNotesState.notes.unshift(newNote);

            saveRiskNotes();
            closeModal();
            renderRiskNotes();

            // Show success notification
            if (typeof showNotification === 'function') {
                showNotification('Risk note created successfully!', 'success');
            }
        }

        function previewRiskNotePhoto(input) {
            const preview = document.getElementById('risknote-photo-preview');
            const img = document.getElementById('risknote-photo-img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        function selectRiskLevel(level) {
            document.getElementById('risknote-level').value = level;
            const buttons = document.querySelectorAll('.risk-level-btn');
            buttons.forEach(btn => {
                const btnLevel = RISK_LEVELS.find(l => l.id === btn.dataset.level);
                if (btn.dataset.level === level) {
                    btn.style.borderColor = btnLevel.color;
                    btn.style.background = btnLevel.color + '20';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'var(--bg-secondary)';
                }
            });
        }

        function viewRiskNote(noteId) {
            const note = riskNotesState.notes.find(n => n.id === noteId);
            if (!note) return;

            const behaviorType = RISK_BEHAVIOR_TYPES.find(t => t.id === note.behaviorType) || RISK_BEHAVIOR_TYPES[5];
            const level = RISK_LEVELS.find(l => l.id === note.level) || RISK_LEVELS[0];
            const noteDate = new Date(note.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const createdDate = note.createdAt ? new Date(note.createdAt).toLocaleString('en-US') : 'Unknown';

            const modal = document.getElementById('modal');

            // Load photo - prefer Firebase Storage URL, fallback to IndexedDB
            const loadPhotoAndRender = async () => {
                let photoUrl = null;

                // First check if we have a Firebase Storage URL
                if (note.photo) {
                    photoUrl = note.photo;
                } else if (note.hasPhoto) {
                    // Fallback to IndexedDB for older notes
                    try {
                        photoUrl = await getPhotoFromIndexedDB(noteId);
                    } catch (err) {
                        console.error('Error loading photo from IndexedDB:', err);
                    }
                }

                renderNoteModal(modal, note, behaviorType, level, noteDate, createdDate, photoUrl);
            };

            loadPhotoAndRender();
        }

        function renderNoteModal(modal, note, behaviorType, level, noteDate, createdDate, photoUrl) {
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, ${level.color}20 0%, var(--bg-secondary) 100%); border-bottom: 3px solid ${level.color};">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 56px; height: 56px; background: ${behaviorType.color}20; border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${behaviorType.icon}" style="color: ${behaviorType.color}; font-size: 24px;"></i>
                            </div>
                            <div>
                                <h2 style="margin: 0; font-size: 20px;">${behaviorType.label}</h2>
                                <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">
                                    <i class="fas fa-store"></i> ${note.store}
                                </div>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body" style="padding: 24px;">
                        <!-- Risk Level Badge -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <span style="background: ${level.color}20; color: ${level.color}; padding: 8px 20px; border-radius: 25px; font-size: 14px; font-weight: 600;">
                                <i class="fas ${level.icon}" style="font-size: 10px;"></i> ${level.label} Risk
                            </span>
                            <span style="font-size: 13px; color: var(--text-muted);">
                                <i class="fas fa-calendar"></i> ${noteDate}
                            </span>
                        </div>

                        <!-- Description -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Description</label>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; font-size: 14px; line-height: 1.7;">
                                ${note.description || 'No description provided'}
                            </div>
                        </div>

                        ${photoUrl ? `
                            <!-- Photo Evidence -->
                            <div style="margin-bottom: 20px;">
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Photo Evidence</label>
                                <div style="border-radius: 12px; overflow: hidden; background: var(--bg-secondary);">
                                    <img src="${photoUrl}" alt="Evidence" style="width: 100%; max-height: 350px; object-fit: contain; cursor: pointer;" onclick="window.open('${photoUrl}', '_blank')">
                                </div>
                                <div style="text-align: center; margin-top: 8px;">
                                    <span style="font-size: 11px; color: var(--text-muted);">Click image to view full size</span>
                                </div>
                            </div>
                        ` : ''}

                        ${note.managerNote ? `
                            <!-- Manager Note -->
                            <div style="margin-bottom: 20px;">
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Manager Note</label>
                                <div style="background: rgba(245, 158, 11, 0.1); padding: 16px; border-radius: 12px; border-left: 4px solid var(--warning);">
                                    <div style="font-size: 14px; line-height: 1.6;">${note.managerNote}</div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Meta Info -->
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Reported By</div>
                                <div style="font-size: 14px; font-weight: 500;"><i class="fas fa-user" style="margin-right: 8px; color: var(--accent-primary);"></i>${note.reportedBy || 'Anonymous'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Created</div>
                                <div style="font-size: 14px; font-weight: 500;"><i class="fas fa-clock" style="margin-right: 8px; color: var(--accent-primary);"></i>${createdDate}</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; justify-content: space-between;">
                        <button class="btn-secondary danger" onclick="closeModal(); deleteRiskNote('${note.id}');">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="btn-primary" onclick="closeModal()">
                            <i class="fas fa-check"></i> Close
                        </button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        // G FORCE FUNCTIONALITY
        function renderGForce() {
            const dashboard = document.querySelector('.dashboard');
            const quote = getDailyGForceQuote();
            const affirmations = getDailyGForceAffirmations(5);
            const philosophy = getDailyGForcePhilosophy();

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">
                            <i class="fas fa-bolt" style="color: var(--accent-primary);"></i>
                            G Force - Giselle's Daily Motivation
                        </h2>
                        <p class="section-subtitle">${getGForceDate()}</p>
                    </div>
                </div>

                <!-- Quote Card -->
                <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);">
                    <div class="card-body" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;"></div>
                        <div id="gforce-quote-text" style="font-size: 1.6rem; line-height: 1.7; margin-bottom: 20px; font-weight: 300; color: var(--text-primary);">"${quote.text}"</div>
                        <div id="gforce-quote-author" style="text-align: right; color: var(--accent-primary); font-size: 1.1rem; font-style: italic;"> ${quote.author}</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                    <!-- Affirmations Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-heart" style="color: #ec4899;"></i>
                                Today's Affirmations
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="gforce-affirmations-page">
                                ${affirmations.map(aff => `
                                    <div style="background: var(--bg-secondary); padding: 14px 18px; border-radius: 10px; margin-bottom: 12px; font-size: 14px; border-left: 4px solid var(--accent-primary); transition: transform 0.2s; cursor: default;" onmouseover="this.style.transform='translateX(6px)'" onmouseout="this.style.transform='translateX(0)'">
                                        <span style="color: var(--success); margin-right: 8px;"></span> ${aff}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Philosophy Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
                                Self-Care Philosophy
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="gforce-philosophy-page-text" style="font-size: 15px; line-height: 1.8; margin-bottom: 24px; color: var(--text-secondary);">${philosophy.text}</div>
                            <div id="gforce-tips-page">
                                ${philosophy.tips.map(tip => `
                                    <div style="background: var(--bg-secondary); padding: 16px 20px; border-radius: 12px; display: flex; align-items: flex-start; gap: 14px; margin-bottom: 12px; transition: all 0.2s; cursor: default;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="font-size: 1.8rem; flex-shrink: 0;">${tip.icon}</div>
                                        <div style="font-size: 14px; line-height: 1.6;">${tip.text}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Motivational Footer -->
                <div style="text-align: center; margin-top: 32px; padding: 24px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border-radius: 16px;">
                    <div style="font-size: 32px; margin-bottom: 12px;"></div>
                    <div style="font-size: 18px; font-weight: 500; color: var(--text-primary);">Remember: You are capable of amazing things!</div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Take a deep breath and embrace today with gratitude.</div>
                </div>
            `;
        }

        function refreshGForceQuote() {
            const quote = getRandomGForceQuote();
            document.getElementById('gforce-quote-text').textContent = '"' + quote.text + '"';
            document.getElementById('gforce-quote-author').textContent = ' ' + quote.author;
        }

        function refreshGForceAffirmations() {
            const affirmations = getRandomGForceAffirmations(5);
            const container = document.getElementById('gforce-affirmations-page');
            container.innerHTML = affirmations.map(aff => `
                <div style="background: var(--bg-secondary); padding: 14px 18px; border-radius: 10px; margin-bottom: 12px; font-size: 14px; border-left: 4px solid var(--accent-primary); transition: transform 0.2s; cursor: default;" onmouseover="this.style.transform='translateX(6px)'" onmouseout="this.style.transform='translateX(0)'">
                    <span style="color: var(--success); margin-right: 8px;"></span> ${aff}
                </div>
            `).join('');
        }

        function refreshGForcePhilosophy() {
            const philosophy = getRandomGForcePhilosophy();
            document.getElementById('gforce-philosophy-page-text').textContent = philosophy.text;
            const tipsContainer = document.getElementById('gforce-tips-page');
            tipsContainer.innerHTML = philosophy.tips.map(tip => `
                <div style="background: var(--bg-secondary); padding: 16px 20px; border-radius: 12px; display: flex; align-items: flex-start; gap: 14px; margin-bottom: 12px; transition: all 0.2s; cursor: default;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="font-size: 1.8rem; flex-shrink: 0;">${tip.icon}</div>
                    <div style="font-size: 14px; line-height: 1.6;">${tip.text}</div>
                </div>
            `).join('');
        }

        const gforceQuotes = [
            // Abundance & Prosperity
            { text: "Abundance is not something we acquire, it is something we tune into.", author: "Wayne Dyer" },
            { text: "The universe is always conspiring in your favor when you raise your vibration.", author: "G Force" },
            { text: "What you think, you create. What you feel, you attract. What you imagine, you become.", author: "Buddha" },
            { text: "Gratitude is the key that unlocks the door to infinite abundance.", author: "Melody Beattie" },
            { text: "You are a living magnet. What you attract into your life is in harmony with your dominant thoughts.", author: "Brian Tracy" },
            { text: "Money is energy, and energy flows where you put your attention.", author: "Deepak Chopra" },
            { text: "Don't look for happiness outside yourself. Abundance begins within.", author: "Rumi" },
            { text: "When you change the way you look at things, the things you look at change.", author: "Wayne Dyer" },
            { text: "The universe returns what you radiate. Be the energy you want to attract.", author: "G Force" },
            { text: "Prosperity is a state of mind before it becomes a physical reality.", author: "Napoleon Hill" },
            { text: "Every moment is an opportunity to align with universal abundance.", author: "G Force" },
            { text: "Your vibrational frequency determines your reality. Choose thoughts of abundance.", author: "G Force" },
            { text: "The universe doesn't give you what you ask for, it gives you what you are.", author: "G Force" },
            { text: "Gratitude transforms what you have into enough, and more.", author: "G Force" },
            { text: "You are not a drop in the ocean, you are the entire ocean in a drop.", author: "Rumi" },
            { text: "Energy flows where your focus goes. Focus on abundance.", author: "Tony Robbins" },
            { text: "Your intention creates your reality. Declare your prosperity now.", author: "G Force" },
            { text: "Success is not the key to happiness. Happiness is the key to success.", author: "Albert Schweitzer" },
            { text: "When you connect with your purpose, the universe supports you.", author: "G Force" },
            { text: "Abundance is your birthright. Claim it with confidence.", author: "Louise Hay" },
            // Self-Love & Inner Peace
            { text: "You yourself, as much as anybody in the entire universe, deserve your love and affection.", author: "Buddha" },
            { text: "The most powerful relationship you will ever have is the relationship with yourself.", author: "Steve Maraboli" },
            { text: "Self-care is not selfish. You cannot serve from an empty vessel.", author: "Eleanor Brown" },
            { text: "Be gentle with yourself. You're doing the best you can.", author: "G Force" },
            { text: "Your value doesn't decrease based on someone's inability to see your worth.", author: "G Force" },
            { text: "The way you speak to yourself matters. Choose words of love and encouragement.", author: "G Force" },
            { text: "Peace comes from within. Do not seek it without.", author: "Buddha" },
            { text: "In the midst of movement and chaos, keep stillness inside of you.", author: "Deepak Chopra" },
            { text: "You are enough just as you are. Each emotion, each moment, each experience.", author: "G Force" },
            { text: "Loving yourself isn't vanity; it's sanity.", author: "Katrina Mayer" },
            // Manifestation & Power
            { text: "Everything you can imagine is real.", author: "Pablo Picasso" },
            { text: "The only limit to our realization of tomorrow is our doubts of today.", author: "Franklin D. Roosevelt" },
            { text: "You have within you right now, everything you need to deal with whatever the world throws at you.", author: "Brian Tracy" },
            { text: "The mind is everything. What you think you become.", author: "Buddha" },
            { text: "Your thoughts are the architects of your destiny.", author: "David O. McKay" },
            { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
            { text: "Whatever the mind can conceive and believe, it can achieve.", author: "Napoleon Hill" },
            { text: "You are the creator of your own reality. Choose wisely.", author: "G Force" },
            { text: "The universe rearranges itself to accommodate your picture of reality.", author: "G Force" },
            { text: "Your imagination is your preview of life's coming attractions.", author: "Albert Einstein" },
            // Growth & Transformation
            { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { text: "Growth is painful. Change is painful. But nothing is as painful as staying stuck.", author: "G Force" },
            { text: "Every adversity carries with it the seed of an equal or greater benefit.", author: "Napoleon Hill" },
            { text: "Your current situation is not your final destination.", author: "G Force" },
            { text: "The butterfly counts not months but moments, and has time enough.", author: "Rabindranath Tagore" },
            { text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.", author: "Ralph Waldo Emerson" },
            { text: "The secret of change is to focus all your energy not on fighting the old, but on building the new.", author: "Socrates" },
            { text: "Every morning brings new potential, but if you dwell on yesterday's misfortunes, you tend to overlook today's opportunities.", author: "G Force" },
            { text: "Stars can't shine without darkness. Your struggles are preparing you for greatness.", author: "G Force" },
            { text: "Trust the timing of your life. Everything is unfolding exactly as it should.", author: "G Force" },
            // Courage & Strength
            { text: "She remembered who she was and the game changed.", author: "Lalah Delia" },
            { text: "You are braver than you believe, stronger than you seem, and smarter than you think.", author: "A.A. Milne" },
            { text: "Courage doesn't always roar. Sometimes it's the quiet voice saying 'I will try again tomorrow.'", author: "Mary Anne Radmacher" },
            { text: "You didn't come this far to only come this far.", author: "G Force" },
            { text: "The woman who doesn't require validation from anyone is the most feared individual on the planet.", author: "Mohadesa Najumi" },
            { text: "Don't be afraid to give up the good to go for the great.", author: "John D. Rockefeller" },
            { text: "Life shrinks or expands in proportion to one's courage.", author: "Ana茂s Nin" },
            { text: "You have been assigned this mountain to show others it can be moved.", author: "G Force" },
            { text: "The only person you are destined to become is the person you decide to be.", author: "Ralph Waldo Emerson" },
            { text: "Your wings already exist. All you have to do is fly.", author: "G Force" }
        ];

        const gforceAffirmations = [
            // Abundance & Prosperity
            "I am a magnet for infinite abundance and prosperity",
            "The universe is constantly working in my favor",
            "I deserve all the good things coming into my life",
            "My energy attracts wonderful opportunities every day",
            "I trust in the perfect process of the universe",
            "I am aligned with the frequency of abundance",
            "Money flows to me easily and naturally",
            "I am surrounded by love, light, and abundance",
            "My thoughts create my reality and I choose thoughts of abundance",
            "I am an open channel for universal prosperity",
            "Success and abundance are my natural state",
            "Wealth constantly flows into my life from expected and unexpected sources",
            "I am grateful for the abundance that surrounds me",
            "Every dollar I spend comes back to me multiplied",
            "I attract lucrative opportunities effortlessly",
            // Self-Love & Worth
            "I release everything that no longer serves me and embrace the new",
            "My mind is at peace, my heart is calm",
            "I am worthy of receiving everything I desire and more",
            "Every day I become more prosperous in all aspects of my life",
            "My present is full of blessings that I recognize with gratitude",
            "I have everything I need in this moment",
            "Each breath connects me more deeply with my inner peace",
            "I trust in my ability to create the life I desire",
            "I am exactly where I need to be in this moment",
            "I love and accept myself unconditionally",
            "I am deserving of happiness, love, and success",
            "My self-worth is not determined by others' opinions",
            "I honor my needs and take time for self-care",
            "I am complete and whole just as I am",
            "I forgive myself and release all guilt",
            // Power & Manifestation
            "I am the architect of my own destiny",
            "My dreams are manifesting into reality right now",
            "I have the power to create positive change in my life",
            "I am confident in my ability to achieve my goals",
            "Every challenge I face makes me stronger and wiser",
            "I attract the right people and circumstances into my life",
            "My potential is limitless",
            "I transform obstacles into opportunities",
            "I am creating the life of my dreams one day at a time",
            "The universe supports my highest good",
            // Peace & Gratitude
            "I choose peace over worry, love over fear",
            "I am grateful for this beautiful day and all it brings",
            "I release anxiety and embrace calm",
            "Today I choose joy and positivity",
            "I am blessed with an amazing support system",
            "Every experience teaches me something valuable",
            "I radiate positive energy wherever I go",
            "I am at peace with my past and excited for my future",
            "Happiness flows through me naturally",
            "I appreciate the small miracles in everyday life",
            // Strength & Courage
            "I am brave, bold, and unstoppable",
            "I face challenges with courage and determination",
            "My inner strength is greater than any obstacle",
            "I trust myself to make the right decisions",
            "I am resilient and bounce back from setbacks quickly",
            "Fear does not control me; I control my response to fear",
            "I embrace change as an opportunity for growth",
            "I am becoming the best version of myself every day",
            "My voice matters and deserves to be heard",
            "I stand in my power with grace and confidence"
        ];

        const gforcePhilosophies = [
            {
                text: "Self-love is not selfish; it's the foundation of all healthy relationships. When you fill your own cup first, you overflow with love and kindness for others. Remember that caring for yourself allows you to show up fully in the world.",
                tips: [
                    { icon: "", text: "Take a 20-minute break today just for you - no phone, no tasks, just pure presence with yourself" },
                    { icon: "", text: "Write down three things you appreciate about yourself right now, focusing on your inner qualities" },
                    { icon: "", text: "Practice saying 'no' to something that drains your energy, creating space for what nourishes you" }
                ]
            },
            {
                text: "Your body is a sacred temple that carries you through life. Treat it with reverence and gratitude. Every cell in your being responds to love and care, creating harmony from within that radiates outward.",
                tips: [
                    { icon: "", text: "Drink a full glass of water mindfully, thanking your body for all it does for you each day" },
                    { icon: "", text: "Spend 5 minutes stretching gently, breathing deeply into any areas of tension or discomfort" },
                    { icon: "", text: "Choose one meal today to eat slowly and mindfully, savoring each bite with appreciation" }
                ]
            },
            {
                text: "Emotional wellness begins with accepting all your feelings without judgment. Every emotion is a messenger bringing you important information. Welcome them, listen to them, and let them flow through you naturally.",
                tips: [
                    { icon: "", text: "Journal for 10 minutes about what you're feeling right now, without censoring or editing yourself" },
                    { icon: "", text: "Create a playlist that matches your current mood and let the music help you process your emotions" },
                    { icon: "", text: "Give yourself a gentle hug or place your hand on your heart, offering yourself compassion" }
                ]
            },
            {
                text: "Rest is not laziness; it's a sacred act of self-preservation. In a world that glorifies hustle, choosing rest is revolutionary. Your worth is not measured by productivity but by your inherent value as a human being.",
                tips: [
                    { icon: "", text: "Set a consistent bedtime tonight, creating a calming evening ritual that honors your need for rest" },
                    { icon: "", text: "Take a digital detox for one hour, allowing your mind to rest from constant stimulation" },
                    { icon: "", text: "Enjoy a warm beverage slowly, giving yourself permission to simply be without doing" }
                ]
            },
            {
                text: "Gratitude is the fastest path to contentment. What you appreciate, appreciates in value. When you focus on what you have rather than what you lack, abundance becomes your reality.",
                tips: [
                    { icon: "", text: "Write down 5 things you're grateful for right now, including the smallest blessings" },
                    { icon: "", text: "Send a message of appreciation to someone who has positively impacted your life" },
                    { icon: "", text: "Start each morning by naming three good things before checking your phone" }
                ]
            },
            {
                text: "Your thoughts shape your reality more than you realize. Every thought is a seed planted in the garden of your mind. Choose to plant flowers of positivity, hope, and possibility rather than weeds of doubt and fear.",
                tips: [
                    { icon: "", text: "Notice negative self-talk today and consciously replace it with a positive alternative" },
                    { icon: "", text: "Visualize your ideal day for 5 minutes this morning, feeling the emotions of success" },
                    { icon: "", text: "Look in the mirror and speak three kind affirmations to yourself out loud" }
                ]
            },
            {
                text: "Boundaries are not walls that keep people out; they are bridges that define where you end and others begin. Setting healthy boundaries is an act of self-respect that teaches others how to treat you.",
                tips: [
                    { icon: "", text: "Identify one area where you need stronger boundaries and commit to honoring it today" },
                    { icon: "", text: "Practice expressing your needs clearly and calmly without over-explaining or apologizing" },
                    { icon: "★", text: "Remember: 'No' is a complete sentence. You don't owe anyone an explanation for protecting your energy" }
                ]
            },
            {
                text: "Connection with nature is medicine for the soul. In the natural world, you remember that you are part of something greater than yourself. Let the earth ground you and the sky remind you of infinite possibilities.",
                tips: [
                    { icon: "", text: "Spend 10 minutes outside today, whether it's a walk, sitting in the sun, or tending to plants" },
                    { icon: "", text: "Listen to nature sounds while working or relaxing to bring calm energy into your space" },
                    { icon: "", text: "Bring a piece of nature indoors - a flower, a plant, or even a beautiful stone" }
                ]
            },
            {
                text: "Forgiveness is not about condoning what happened; it's about freeing yourself from carrying the weight of resentment. When you forgive, you release the chains that bind you to the past and step into freedom.",
                tips: [
                    { icon: "锔", text: "Write a letter of forgiveness to someone who hurt you (you don't need to send it)" },
                    { icon: "", text: "Forgive yourself for one past mistake. Say out loud: 'I release this and move forward with love'" },
                    { icon: "", text: "Recognize that holding onto anger hurts you more than anyone else - choose peace today" }
                ]
            },
            {
                text: "Your intuition is your inner compass, a gift that guides you toward your highest good. In a world full of noise, learning to listen to your inner voice is a superpower. Trust yourself - you know more than you think.",
                tips: [
                    { icon: "", text: "Before making a decision today, pause and ask yourself: 'What does my gut tell me?'" },
                    { icon: "锔", text: "Spend 5 minutes in silence, breathing deeply, and notice what thoughts or feelings arise" },
                    { icon: "", text: "Practice trusting a small intuitive nudge today and observe the outcome" }
                ]
            },
            {
                text: "Creativity is not reserved for artists; it is the essence of being human. Every time you solve a problem, cook a meal, or rearrange your space, you are creating. Honor your creative spirit by making time to play.",
                tips: [
                    { icon: "", text: "Do something creative today with no expectation of perfection - doodle, sing, write, dance" },
                    { icon: "", text: "Try something new that slightly scares you - creativity lives at the edge of comfort" },
                    { icon: "", text: "Give yourself permission to be a beginner at something. Mastery isn't the goal - joy is" }
                ]
            },
            {
                text: "Patience is the art of trusting the timing of your life. Like a seed beneath the soil, growth is happening even when you cannot see it. Have faith that everything is unfolding exactly as it should.",
                tips: [
                    { icon: "", text: "When feeling impatient today, take three deep breaths and say: 'Everything is working out for me'" },
                    { icon: "", text: "Reflect on a past situation that felt frustrating but eventually revealed its purpose" },
                    { icon: "", text: "Remember: the caterpillar doesn't know it will become a butterfly. Trust your transformation" }
                ]
            },
            {
                text: "Joy is not something to be pursued; it is something to be allowed. It already exists within you, waiting to be uncovered. Strip away the layers of worry and obligation, and you will find joy has been there all along.",
                tips: [
                    { icon: "", text: "Do one thing today purely because it brings you joy, with no productivity attached" },
                    { icon: "", text: "Celebrate a small win from this week - no achievement is too small to acknowledge" },
                    { icon: "", text: "Move your body in a way that feels good - dance, stretch, walk - and notice how joy follows" }
                ]
            },
            {
                text: "Vulnerability is not weakness; it is the birthplace of connection, creativity, and courage. When you allow yourself to be seen - truly seen - you open the door to authentic relationships and deep fulfillment.",
                tips: [
                    { icon: "", text: "Share something honest with a trusted person today, even if it feels uncomfortable" },
                    { icon: "", text: "Notice where you wear masks to hide your true self. Ask: 'What would happen if I took it off?'" },
                    { icon: "", text: "Embrace imperfection today. Done is better than perfect, and real is better than polished" }
                ]
            },
            {
                text: "Abundance is a mindset before it becomes a reality. When you shift from scarcity thinking to abundance thinking, you open yourself to receiving more of everything - love, opportunities, wealth, and happiness.",
                tips: [
                    { icon: "", text: "Replace 'I can't afford it' with 'How can I afford it?' to open your mind to possibilities" },
                    { icon: "", text: "Express gratitude for your current blessings, no matter how small - this attracts more" },
                    { icon: "", text: "Give something away today - generosity signals to the universe that you have plenty to share" }
                ]
            }
        ];

        // Get day of year for consistent daily content
        function getDayOfYear() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        function getGForceDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return new Date().toLocaleDateString('en-US', options);
        }

        // Daily functions - content changes each day but stays consistent throughout the day
        function getDailyGForceQuote() {
            const dayOfYear = getDayOfYear();
            const index = dayOfYear % gforceQuotes.length;
            return gforceQuotes[index];
        }

        function getDailyGForceAffirmations(count = 5) {
            const dayOfYear = getDayOfYear();
            const result = [];
            for (let i = 0; i < count; i++) {
                const index = (dayOfYear + i * 7) % gforceAffirmations.length;
                result.push(gforceAffirmations[index]);
            }
            return result;
        }

        function getDailyGForcePhilosophy() {
            const dayOfYear = getDayOfYear();
            const index = dayOfYear % gforcePhilosophies.length;
            return gforcePhilosophies[index];
        }

        // Keep random functions for backwards compatibility
        let currentGForceQuoteIndex = -1;
        let currentGForcePhilosophyIndex = -1;

        function getRandomGForceQuote() {
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * gforceQuotes.length);
            } while (newIndex === currentGForceQuoteIndex && gforceQuotes.length > 1);
            currentGForceQuoteIndex = newIndex;
            return gforceQuotes[currentGForceQuoteIndex];
        }

        function getRandomGForceAffirmations(count = 5) {
            const shuffled = [...gforceAffirmations].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }

        function getRandomGForcePhilosophy() {
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * gforcePhilosophies.length);
            } while (newIndex === currentGForcePhilosophyIndex && gforcePhilosophies.length > 1);
            currentGForcePhilosophyIndex = newIndex;
            return gforcePhilosophies[currentGForcePhilosophyIndex];
        }

        function displayGForceQuote(quote) {
            document.getElementById('gforce-quote-text').textContent = `"${quote.text}"`;
            document.getElementById('gforce-quote-author').textContent = ` ${quote.author}`;
        }

        function displayGForceAffirmations(affirmations) {
            const container = document.getElementById('gforce-affirmations');
            container.innerHTML = affirmations.map(aff =>
                `<div style="background: var(--bg-secondary); padding: 12px 16px; border-radius: 10px; margin-bottom: 10px; font-size: 14px; border-left: 3px solid var(--accent-primary); transition: transform 0.2s; cursor: default;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                     ${aff}
                </div>`
            ).join('');
        }

        function displayGForcePhilosophy(philosophy) {
            document.getElementById('gforce-philosophy-text').textContent = philosophy.text;
            const tipsContainer = document.getElementById('gforce-tips');
            tipsContainer.innerHTML = philosophy.tips.map(tip =>
                `<div style="background: var(--bg-secondary); padding: 14px 18px; border-radius: 10px; display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px; transition: all 0.2s; cursor: default;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="font-size: 1.5rem; flex-shrink: 0;">${tip.icon}</div>
                    <div style="font-size: 13px; line-height: 1.5; color: var(--text-secondary);">${tip.text}</div>
                </div>`
            ).join('');
        }

        function generateGForceQuote() {
            displayGForceQuote(getRandomGForceQuote());
        }

        function generateGForceAffirmations() {
            displayGForceAffirmations(getRandomGForceAffirmations(5));
        }

        function generateGForcePhilosophy() {
            displayGForcePhilosophy(getRandomGForcePhilosophy());
        }

        function openGForceModal() {
            document.getElementById('gforce-date').textContent = getGForceDate();
            generateGForceQuote();
            generateGForceAffirmations();
            generateGForcePhilosophy();
            document.getElementById('gforce-modal').classList.add('active');
        }

        function closeGForceModal() {
            document.getElementById('gforce-modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('gforce-modal').addEventListener('mousedown', function(e) {
            if (e.target === this) {
                closeGForceModal();
            }
        });

// =============================================================================
// GCONOMICS - Expense Planner
// =============================================================================

// Expense categories
const GCONOMICS_CATEGORIES = [
    { id: 'food', name: 'Food', icon: 'fa-utensils', color: '#f59e0b' },
    { id: 'home', name: 'Home', icon: 'fa-home', color: '#3b82f6' },
    { id: 'subscriptions', name: 'Subscriptions', icon: 'fa-credit-card', color: '#8b5cf6' },
    { id: 'health', name: 'Health', icon: 'fa-heart-pulse', color: '#ef4444' },
    { id: 'gifts', name: 'Gifts', icon: 'fa-gift', color: '#ec4899' },
    { id: 'other', name: 'Other', icon: 'fa-ellipsis', color: '#6b7280' }
];

// Gconomics state
let gconomicsState = {
    expenses: JSON.parse(localStorage.getItem('gconomicsExpenses')) || [],
    currentMonth: '2025-12', // December 2025
    selectedCategory: 'all',
    editingExpenseId: null
};

// Save expenses to localStorage
function saveGconomicsExpenses() {
    const expensesWithTimestamp = gconomicsState.expenses.map(exp => ({
        ...exp,
        updatedAt: exp.updatedAt || new Date().toISOString()
    }));
    localStorage.setItem('gconomicsExpenses', JSON.stringify(expensesWithTimestamp));
}

// Initialize Gconomics Firebase sync
async function initializeGconomicsFirebase(userId, userEmail) {
    if (!window.gconomicsFirebase) {
        console.warn('Gconomics Firebase module not loaded');
        return false;
    }

    try {
        const initialized = await window.gconomicsFirebase.initialize();
        if (!initialized) return false;

        window.gconomicsFirebase.setCurrentUser(userId, userEmail);
        
        // Sync existing local expenses to Firebase
        if (gconomicsState.expenses.length > 0) {
            await window.gconomicsFirebase.syncExpensesToFirestore(gconomicsState.expenses);
        }

        console.log(' Gconomics Firebase initialized successfully');
        return true;
    } catch (error) {
        console.error('Error initializing Gconomics Firebase:', error);
        return false;
    }
}

// Load Gconomics expenses from Firebase
async function loadGconomicsFromFirebase() {
    if (!window.gconomicsFirebase || !window.gconomicsFirebase.isInitialized) {
        console.warn('Gconomics Firebase not initialized');
        return false;
    }

    try {
        const firebaseExpenses = await window.gconomicsFirebase.loadExpensesFromFirestore();
        
        if (firebaseExpenses.length === 0) {
            console.log('No expenses found in Firebase');
            return true;
        }

        // Merge Firebase expenses with local expenses
        const mergedExpenses = await window.gconomicsFirebase.syncWithFirebase(gconomicsState.expenses);
        gconomicsState.expenses = mergedExpenses;
        saveGconomicsExpenses();
        
        console.log(` Loaded and merged ${mergedExpenses.length} expenses from Firebase`);
        return true;
    } catch (error) {
        console.error('Error loading expenses from Firebase:', error);
        return false;
    }
}

// Get expense statistics from Firebase
async function getGconomicsStatsFromFirebase(monthString) {
    if (!window.gconomicsFirebase || !window.gconomicsFirebase.isInitialized) {
        console.warn('Gconomics Firebase not initialized');
        return null;
    }

    try {
        const stats = await window.gconomicsFirebase.getMonthlyStats(monthString);
        return stats;
    } catch (error) {
        console.error('Error getting Firebase stats:', error);
        return null;
    }
}

// Get expenses for current month
function getMonthlyExpenses(month = gconomicsState.currentMonth) {
    return gconomicsState.expenses.filter(exp => exp.date.startsWith(month));
}

// Get total for current month
function getMonthlyTotal(month = gconomicsState.currentMonth) {
    return getMonthlyExpenses(month).reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
}

// Get total by category for current month
function getCategoryTotals(month = gconomicsState.currentMonth) {
    const expenses = getMonthlyExpenses(month);
    const totals = {};
    GCONOMICS_CATEGORIES.forEach(cat => {
        totals[cat.id] = expenses
            .filter(exp => exp.category === cat.id)
            .reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
    });
    return totals;
}

// Get available months from expenses
function getAvailableMonths() {
    const months = new Set();
    gconomicsState.expenses.forEach(exp => {
        months.add(exp.date.slice(0, 7));
    });
    // Add current month if not present
    months.add(gconomicsState.currentMonth);
    return Array.from(months).sort().reverse();
}

// Render Gconomics page
function renderGconomics() {
    const dashboard = document.querySelector('.dashboard');
    const monthlyExpenses = getMonthlyExpenses();
    const monthlyTotal = getMonthlyTotal();
    const categoryTotals = getCategoryTotals();
    const availableMonths = getAvailableMonths();

    // Filter expenses by category if selected
    let displayExpenses = monthlyExpenses;
    if (gconomicsState.selectedCategory !== 'all') {
        displayExpenses = monthlyExpenses.filter(exp => exp.category === gconomicsState.selectedCategory);
    }

    // Sort by date descending
    displayExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

    const currentMonthName = new Date(gconomicsState.currentMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    dashboard.innerHTML = `
        <div class="page-header gconomics-page-header">
            <div class="page-header-left">
                <h2 class="section-title">
                    <i class="fas fa-wallet" style="color: var(--accent-primary);"></i>
                    Gconomics
                </h2>
                <p class="section-subtitle">Personal Expense Tracker</p>
            </div>
            <div class="page-header-right" style="display: flex; gap: 12px; align-items: center;">
                <select class="form-input" style="width: 160px;" onchange="changeGconomicsMonth(this.value)">
                    ${availableMonths.map(month => {
                        const monthName = new Date(month + '-01').toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        return `<option value="${month}" ${month === gconomicsState.currentMonth ? 'selected' : ''}>${monthName}</option>`;
                    }).join('')}
                </select>
                <button class="btn-primary floating-add-btn" onclick="openAddExpenseModal()">
                    <i class="fas fa-plus"></i> New Expense
                </button>
            </div>
        </div>

        <!-- Monthly Summary Card -->
        <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%); color: white; overflow: hidden; position: relative;">
            <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
            <div class="card-body" style="padding: 32px; position: relative; z-index: 1;">
                <div class="gconomics-summary-content" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 24px;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">${currentMonthName}</div>
                        <div style="font-size: 42px; font-weight: 700;">${formatCurrencyGconomics(monthlyTotal)}</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 8px;">${displayExpenses.length} expense${displayExpenses.length !== 1 ? 's' : ''} this month</div>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        ${GCONOMICS_CATEGORIES.slice(0, 4).map(cat => {
                            const amount = categoryTotals[cat.id] || 0;
                            if (amount === 0) return '';
                            return `
                                <div style="background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 12px; text-align: center; min-width: 80px;">
                                    <div style="font-size: 20px; margin-bottom: 4px;"><i class="fas ${cat.icon}"></i></div>
                                    <div style="font-size: 14px; font-weight: 600;">${formatCurrencyGconomics(amount)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    Spending Breakdown
                </h3>
            </div>
            <div class="card-body">
                ${monthlyTotal === 0 ? `
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <i class="fas fa-chart-pie" style="font-size: 40px; opacity: 0.3; margin-bottom: 12px; display: block;"></i>
                        <p>No expenses to display</p>
                    </div>
                ` : `
                    <div class="gconomics-chart-grid" style="display: grid; grid-template-columns: 200px 1fr; gap: 32px; align-items: center;">
                        <!-- Donut Chart -->
                        <div style="position: relative; width: 180px; height: 180px; margin: 0 auto;">
                            <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                ${renderDonutChart(categoryTotals, monthlyTotal)}
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 10px; color: var(--text-muted);">Total</div>
                                <div style="font-size: 14px; font-weight: 700;">${formatCurrencyGconomics(monthlyTotal)}</div>
                            </div>
                        </div>
                        <!-- Legend with Bar Chart -->
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${GCONOMICS_CATEGORIES.map(cat => {
                                const amount = categoryTotals[cat.id] || 0;
                                if (amount === 0) return '';
                                const percentage = ((amount / monthlyTotal) * 100).toFixed(1);
                                return `
                                    <div style="cursor: pointer;" onclick="filterGconomicsByCategory('${cat.id}')">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="width: 10px; height: 10px; border-radius: 2px; background: ${cat.color};"></div>
                                                <span style="font-size: 13px; font-weight: 500;">${cat.name}</span>
                                            </div>
                                            <div style="font-size: 13px;">
                                                <span style="font-weight: 600;">${formatCurrencyGconomics(amount)}</span>
                                                <span style="color: var(--text-muted); margin-left: 8px;">${percentage}%</span>
                                            </div>
                                        </div>
                                        <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                            <div style="height: 100%; width: ${percentage}%; background: ${cat.color}; border-radius: 4px; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `}
            </div>
        </div>

        <!-- Category Filter Pills -->
        <div class="gconomics-category-pills" style="display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap;">
            <button onclick="filterGconomicsByCategory('all')" style="padding: 10px 20px; font-family: Outfit; border-radius: 25px; border: 2px solid ${gconomicsState.selectedCategory === 'all' ? 'var(--accent-primary)' : 'var(--border-color)'}; background: ${gconomicsState.selectedCategory === 'all' ? 'var(--accent-primary)' : 'var(--bg-secondary)'}; color: ${gconomicsState.selectedCategory === 'all' ? 'white' : 'var(--text-primary)'}; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                <i class="fas fa-th-large"></i> All
            </button>
            ${GCONOMICS_CATEGORIES.map(cat => `
                <button onclick="filterGconomicsByCategory('${cat.id}')" style="font-family: Outfit; padding: 10px 20px; border-radius: 25px; border: 2px solid ${gconomicsState.selectedCategory === cat.id ? cat.color : 'var(--border-color)'}; background: ${gconomicsState.selectedCategory === cat.id ? cat.color : 'var(--bg-secondary)'}; color: ${gconomicsState.selectedCategory === cat.id ? 'white' : 'var(--text-primary)'}; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                    <i class="fas ${cat.icon}"></i> ${cat.name}
                </button>
            `).join('')}
        </div>

        <!-- Expenses Grid -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-receipt"></i>
                    Recent Expenses
                    ${gconomicsState.selectedCategory !== 'all' ? `<span style="background: var(--accent-primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 8px;">${GCONOMICS_CATEGORIES.find(c => c.id === gconomicsState.selectedCategory)?.name}</span>` : ''}
                </h3>
            </div>
            <div class="card-body">
                ${displayExpenses.length === 0 ? `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-receipt" style="font-size: 56px; margin-bottom: 20px; display: block; opacity: 0.3;"></i>
                        <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No expenses yet</div>
                        <div style="font-size: 14px;">Click "New Expense" to start tracking</div>
                    </div>
                ` : `
                    <div class="gconomics-expenses-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                        ${displayExpenses.map(expense => {
                            const category = GCONOMICS_CATEGORIES.find(c => c.id === expense.category) || GCONOMICS_CATEGORIES[5];
                            const expenseDate = new Date(expense.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            return `
                                <div style="background: var(--bg-secondary); border-radius: 16px; padding: 20px; border-left: 4px solid ${category.color}; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" onclick="viewExpenseDetails('${expense.id}')">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 44px; height: 44px; background: ${category.color}20; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas ${category.icon}" style="color: ${category.color}; font-size: 18px;"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 2px;">${expense.description}</div>
                                                <div style="font-size: 12px; color: var(--text-muted);">${expenseDate}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 18px; font-weight: 700; color: ${category.color};">${formatCurrencyGconomics(expense.amount)}</div>
                                        </div>
                                    </div>
                                    ${expense.photo ? `
                                        <div style="margin-top: 12px; border-radius: 10px; overflow: hidden; max-height: 120px;">
                                            <img src="${expense.photo}" alt="Receipt" style="width: 100%; height: 120px; object-fit: cover;">
                                        </div>
                                    ` : ''}
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <span style="background: ${category.color}20; color: ${category.color}; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600;">${category.name}</span>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-icon" onclick="event.stopPropagation(); editExpense('${expense.id}')" title="Edit" style="width: 32px; height: 32px;">
                                                <i class="fas fa-pen" style="font-size: 12px;"></i>
                                            </button>
                                            <button class="btn-icon danger" onclick="event.stopPropagation(); deleteExpense('${expense.id}')" title="Delete" style="width: 32px; height: 32px;">
                                                <i class="fas fa-trash" style="font-size: 12px;"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
        </div>

        <!-- Add/Edit Expense Modal -->
        <div class="modal" id="expenseModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 id="expenseModalTitle">
                        <i class="fas fa-plus-circle"></i> Add Expense
                    </h2>
                    <button class="modal-close" onclick="closeExpenseModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm" onsubmit="saveExpense(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseDate">Date</label>
                                <input type="date" id="expenseDate" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="expenseAmount">Amount</label>
                                <input type="number" id="expenseAmount" class="form-input" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="expenseDescription">Description</label>
                            <input type="text" id="expenseDescription" class="form-input" placeholder="What did you spend on?">
                        </div>
                        <div class="form-group">
                            <label for="expenseCategory">Category</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;" id="categorySelector">
                                ${GCONOMICS_CATEGORIES.map(cat => `
                                    <button type="button" class="category-select-btn" data-category="${cat.id}" onclick="selectExpenseCategory('${cat.id}')" style="padding: 14px 10px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s; text-align: center;">
                                        <div style="font-size: 20px; margin-bottom: 4px; color: ${cat.color};"><i class="fas ${cat.icon}"></i></div>
                                        <div style="font-size: 11px; font-weight: 500;">${cat.name}</div>
                                    </button>
                                `).join('')}
                            </div>
                            <input type="hidden" id="expenseCategory" value="">
                        </div>
                        <div class="form-group">
                            <label>Receipt Photo</label>
                            <div style="border: 2px dashed var(--border-color); border-radius: 12px; padding: 20px; text-align: center; background: var(--bg-hover);">
                                <input type="file" id="expensePhoto" accept="image/*" onchange="previewExpensePhoto(this)" style="display: none;">
                                <div id="expense-photo-preview" style="display: none; margin-bottom: 12px;">
                                    <img id="expense-photo-img" style="max-width: 100%; max-height: 150px; border-radius: 8px; object-fit: cover;">
                                </div>
                                <button type="button" class="btn-secondary" onclick="document.getElementById('expensePhoto').click()" style="margin: 0;">
                                    <i class="fas fa-camera"></i> Upload Receipt
                                </button>
                                <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 12px;">Take a photo of your receipt (optional)</p>
                            </div>
                        </div>
                        <div id="expenseMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeExpenseModal()">Cancel</button>
                    <button type="submit" form="expenseForm" class="btn-primary">
                        <i class="fas fa-check"></i> Save Expense
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Preview expense photo
function previewExpensePhoto(input) {
    const preview = document.getElementById('expense-photo-preview');
    const img = document.getElementById('expense-photo-img');

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}

// Select expense category
function selectExpenseCategory(categoryId) {
    document.getElementById('expenseCategory').value = categoryId;
    const buttons = document.querySelectorAll('.category-select-btn');
    buttons.forEach(btn => {
        const cat = GCONOMICS_CATEGORIES.find(c => c.id === btn.dataset.category);
        if (btn.dataset.category === categoryId) {
            btn.style.borderColor = cat.color;
            btn.style.background = cat.color + '20';
        } else {
            btn.style.borderColor = 'var(--border-color)';
            btn.style.background = 'var(--bg-secondary)';
        }
    });
}

// View expense details
function viewExpenseDetails(expenseId) {
    const expense = gconomicsState.expenses.find(e => e.id === expenseId);
    if (!expense) return;

    const category = GCONOMICS_CATEGORIES.find(c => c.id === expense.category) || GCONOMICS_CATEGORIES[5];
    const expenseDate = new Date(expense.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    modalContent.innerHTML = `
        <div class="modal-header">
            <h2 style="display: flex; align-items: center; gap: 10px;">
                <i class="fas ${category.icon}" style="color: ${category.color};"></i>
                Expense Details
            </h2>
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            ${expense.photo ? `
                <div style="margin-bottom: 20px; border-radius: 12px; overflow: hidden;">
                    <img src="${expense.photo}" alt="Receipt" style="width: 100%; max-height: 250px; object-fit: cover; cursor: pointer;" onclick="window.open('${expense.photo}', '_blank')">
                </div>
            ` : ''}
            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 32px; font-weight: 700; color: ${category.color}; margin-bottom: 8px;">${formatCurrencyGconomics(expense.amount)}</div>
                <div style="font-size: 18px; font-weight: 500; margin-bottom: 4px;">${expense.description}</div>
                <div style="font-size: 14px; color: var(--text-muted);">${expenseDate}</div>
            </div>
            <div style="display: flex; gap: 12px;">
                <span style="background: ${category.color}20; color: ${category.color}; padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600;">
                    <i class="fas ${category.icon}"></i> ${category.name}
                </span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal(); editExpense('${expense.id}');">
                <i class="fas fa-pen"></i> Edit
            </button>
            <button class="btn-primary" onclick="closeModal();">
                <i class="fas fa-check"></i> Done
            </button>
        </div>
    `;
    modal.classList.add('active');
}

// Render donut chart SVG
function renderDonutChart(categoryTotals, total) {
    if (total === 0) return '';

    let accumulated = 0;
    return GCONOMICS_CATEGORIES.map(cat => {
        const amount = categoryTotals[cat.id] || 0;
        if (amount === 0) return '';
        const percentage = (amount / total) * 100;
        const dashArray = percentage + ' ' + (100 - percentage);
        const dashOffset = -accumulated;
        accumulated += percentage;
        return `<circle cx="18" cy="18" r="15.9" fill="none" stroke="${cat.color}" stroke-width="3.5" stroke-dasharray="${dashArray}" stroke-dashoffset="${dashOffset}" />`;
    }).join('');
}

// Render simple bar chart
function renderGconomicsChart(categoryTotals, total) {
    if (total === 0) {
        return '<p class="chart-empty">No expenses to display</p>';
    }

    return `
        <div class="gconomics-bar-chart">
            ${GCONOMICS_CATEGORIES.map(cat => {
                const amount = categoryTotals[cat.id] || 0;
                const percentage = total > 0 ? (amount / total * 100) : 0;
                if (amount === 0) return '';
                return `
                    <div class="chart-bar-item">
                        <div class="chart-bar-header">
                            <span class="chart-bar-label">
                                <i class="fas ${cat.icon}" style="color: ${cat.color};"></i>
                                ${cat.name}
                            </span>
                            <span class="chart-bar-value">${percentage.toFixed(0)}%</span>
                        </div>
                        <div class="chart-bar-track">
                            <div class="chart-bar-fill" style="width: ${percentage}%; background: ${cat.color};"></div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// Format currency
function formatCurrencyGconomics(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

// Filter by category
function filterGconomicsByCategory(categoryId) {
    gconomicsState.selectedCategory = categoryId;
    renderGconomics();
}

// Change month
function changeGconomicsMonth(month) {
    gconomicsState.currentMonth = month;
    gconomicsState.selectedCategory = 'all';
    renderGconomics();
}

// Open add expense modal
function openAddExpenseModal() {
    gconomicsState.editingExpenseId = null;
    document.getElementById('expenseModalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add Expense';
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('expenseMessage').style.display = 'none';
    document.getElementById('expenseModal').classList.add('active');
}

// Close expense modal
function closeExpenseModal(forceClose = false) {
    // Reset form protection before closing
    if (typeof formProtectionManager !== 'undefined') {
        formProtectionManager.resetProtection();
    }
    document.getElementById('expenseModal').classList.remove('active');
    gconomicsState.editingExpenseId = null;
}

// Edit expense
function editExpense(expenseId) {
    const expense = gconomicsState.expenses.find(e => e.id === expenseId);
    if (!expense) return;

    gconomicsState.editingExpenseId = expenseId;
    document.getElementById('expenseModalTitle').innerHTML = '<i class="fas fa-pen"></i> Edit Expense';
    document.getElementById('expenseDate').value = expense.date;
    document.getElementById('expenseDescription').value = expense.description;
    document.getElementById('expenseCategory').value = expense.category;
    document.getElementById('expenseAmount').value = expense.amount;
    document.getElementById('expenseMessage').style.display = 'none';
    document.getElementById('expenseModal').classList.add('active');
}

// Delete expense
function deleteExpense(expenseId) {
    showConfirmModal({
        title: 'Delete Expense',
        message: 'Are you sure you want to delete this expense? This action cannot be undone.',
        confirmText: 'Delete',
        type: 'danger',
        onConfirm: () => {
            gconomicsState.expenses = gconomicsState.expenses.filter(e => e.id !== expenseId);
            saveGconomicsExpenses();

            // Delete from Firebase if available
            if (window.gconomicsFirebase && window.gconomicsFirebase.isInitialized) {
                window.gconomicsFirebase.deleteExpenseFromFirestore(expenseId).catch(error => {
                    console.warn('Expense deleted locally but not from Firebase:', error);
                });
            }

            renderGconomics();
        }
    });
}

// Save expense
function saveExpense(event) {
    event.preventDefault();

    const date = document.getElementById('expenseDate').value || new Date().toISOString().split('T')[0];
    const description = document.getElementById('expenseDescription').value.trim();
    const category = document.getElementById('expenseCategory').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
    const photoInput = document.getElementById('expensePhoto');

    // Get photo if uploaded
    if (photoInput && photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const photoData = e.target.result;
            saveExpenseWithPhoto(date, description, category, amount, photoData);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        // Check if editing and preserve existing photo
        let existingPhoto = null;
        if (gconomicsState.editingExpenseId) {
            const existing = gconomicsState.expenses.find(e => e.id === gconomicsState.editingExpenseId);
            if (existing) existingPhoto = existing.photo;
        }
        saveExpenseWithPhoto(date, description, category, amount, existingPhoto);
    }
}

async function saveExpenseWithPhoto(date, description, category, amount, photo) {
    // Upload photo to Firebase Storage if provided
    let photoUrl = photo;
    let photoPath = null;

    if (photo && photo.startsWith('data:image')) {
        // Initialize storage helper if needed
        if (!firebaseStorageHelper.isInitialized) {
            firebaseStorageHelper.initialize();
        }

        try {
            const expenseId = gconomicsState.editingExpenseId || Date.now().toString();
            const uploadResult = await firebaseStorageHelper.uploadImage(
                photo,
                'expenses/receipts',
                expenseId
            );
            photoUrl = uploadResult.url;
            photoPath = uploadResult.path;
            console.log(' Expense receipt uploaded to Firebase Storage');
        } catch (error) {
            console.warn('Firebase Storage upload failed, using compressed base64:', error);
            try {
                photoUrl = await compressImage(photo, 700, 1200, 1200);
            } catch (compressError) {
                console.warn('Photo compression failed, using original:', compressError);
            }
        }
    }

    if (gconomicsState.editingExpenseId) {
        // Update existing expense
        const index = gconomicsState.expenses.findIndex(e => e.id === gconomicsState.editingExpenseId);
        if (index > -1) {
            // Delete old photo from Storage if replacing with new one
            if (photo && photo.startsWith('data:image') && gconomicsState.expenses[index].photoPath) {
                try {
                    await firebaseStorageHelper.deleteFile(gconomicsState.expenses[index].photoPath);
                } catch (err) {
                    console.error('Error deleting old expense photo:', err);
                }
            }

            gconomicsState.expenses[index] = {
                ...gconomicsState.expenses[index],
                date,
                description: description || 'Expense',
                category: category || 'other',
                amount,
                photo: photoUrl,       // Now stores URL instead of base64
                photoPath: photoPath || gconomicsState.expenses[index].photoPath,
                updatedAt: new Date().toISOString()
            };
        }
    } else {
        // Add new expense
        const newExpense = {
            id: Date.now().toString(),
            date,
            description: description || 'Expense',
            category: category || 'other',
            amount,
            photo: photoUrl,       // Now stores URL instead of base64
            photoPath: photoPath,  // For future deletion
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        gconomicsState.expenses.push(newExpense);
    }

    saveGconomicsExpenses();

    // Sync to Firebase if available
    if (window.gconomicsFirebase && window.gconomicsFirebase.isInitialized) {
        const expenseToSync = gconomicsState.editingExpenseId
            ? gconomicsState.expenses.find(e => e.id === gconomicsState.editingExpenseId)
            : gconomicsState.expenses[gconomicsState.expenses.length - 1];

        if (expenseToSync) {
            window.gconomicsFirebase.saveExpenseToFirestore(expenseToSync).catch(error => {
                console.warn('Expense saved locally but not synced to Firebase:', error);
            });
        }
    }

    closeExpenseModal();

    // Switch to the month of the expense if different
    const expenseMonth = date.slice(0, 7);
    if (expenseMonth !== gconomicsState.currentMonth) {
        gconomicsState.currentMonth = expenseMonth;
    }

    renderGconomics();
}

// ============================================
// PASSWORD MANAGER MODULE
// ============================================

// Firebase Password Manager
let firebasePasswords = [];

const firebasePasswordsManager = {
    isInitialized: false,
    db: null,

    async initialize() {
        try {
            if (typeof firebase === 'undefined' || !firebase.firestore) {
                console.warn('Firebase not available for Passwords');
                return false;
            }
            this.db = firebase.firestore();
            this.isInitialized = true;
            console.log('Password Manager Firebase initialized');
            return true;
        } catch (error) {
            console.error('Error initializing Password Manager Firebase:', error);
            return false;
        }
    },

    async loadPasswords() {
        if (!this.isInitialized || !this.db) {
            console.warn('Passwords Firebase not initialized');
            return [];
        }

        try {
            const collectionName = window.FIREBASE_COLLECTIONS?.passwords || 'passwords';
            const snapshot = await this.db.collection(collectionName)
                .orderBy('createdAt', 'desc')
                .get();

            const passwords = [];
            snapshot.forEach(doc => {
                passwords.push({
                    firestoreId: doc.id,
                    ...doc.data()
                });
            });

            console.log(`Loaded ${passwords.length} passwords from Firebase`);
            return passwords;
        } catch (error) {
            console.error('Error loading passwords:', error);
            return [];
        }
    },

    async addPassword(passwordData) {
        if (!this.isInitialized || !this.db) {
            throw new Error('Passwords Firebase not initialized');
        }

        try {
            const collectionName = window.FIREBASE_COLLECTIONS?.passwords || 'passwords';
            const docRef = await this.db.collection(collectionName).add({
                ...passwordData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('Password added with ID:', docRef.id);
            return docRef.id;
        } catch (error) {
            console.error('Error adding password:', error);
            throw error;
        }
    },

    async updatePassword(firestoreId, updateData) {
        if (!this.isInitialized || !this.db) {
            throw new Error('Passwords Firebase not initialized');
        }

        try {
            const collectionName = window.FIREBASE_COLLECTIONS?.passwords || 'passwords';
            await this.db.collection(collectionName).doc(firestoreId).update({
                ...updateData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('Password updated:', firestoreId);
            return true;
        } catch (error) {
            console.error('Error updating password:', error);
            throw error;
        }
    },

    async deletePassword(firestoreId) {
        if (!this.isInitialized || !this.db) {
            throw new Error('Passwords Firebase not initialized');
        }

        try {
            const collectionName = window.FIREBASE_COLLECTIONS?.passwords || 'passwords';
            await this.db.collection(collectionName).doc(firestoreId).delete();

            console.log('Password deleted:', firestoreId);
            return true;
        } catch (error) {
            console.error('Error deleting password:', error);
            throw error;
        }
    }
};

// Initialize Firebase Passwords
async function initializeFirebasePasswords() {
    try {
        await firebasePasswordsManager.initialize();
        firebasePasswords = await firebasePasswordsManager.loadPasswords();
        console.log('Firebase Passwords loaded:', firebasePasswords.length);
    } catch (error) {
        console.error('Error initializing Firebase Passwords:', error);
    }
}

// Password categories with icons and colors
const passwordCategories = {
    'gas': { label: 'Gas & Utilities', icon: 'fa-fire-flame-curved', color: '#f97316' },
    'suppliers': { label: 'Suppliers', icon: 'fa-truck', color: '#8b5cf6' },
    'email': { label: 'Email Accounts', icon: 'fa-envelope', color: '#3b82f6' },
    'banking': { label: 'Banking & Finance', icon: 'fa-building-columns', color: '#10b981' },
    'software': { label: 'Software & Apps', icon: 'fa-laptop-code', color: '#ec4899' },
    'social': { label: 'Social Media', icon: 'fa-share-nodes', color: '#06b6d4' },
    'pos': { label: 'POS & Sales', icon: 'fa-cash-register', color: '#eab308' },
    'security': { label: 'Security Systems', icon: 'fa-shield-halved', color: '#ef4444' },
    'other': { label: 'Other', icon: 'fa-ellipsis', color: '#71717a' }
};

// Generate random password
function generateRandomPassword(length = 16) {
    const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const lowercase = 'abcdefghijklmnopqrstuvwxyz';
    const numbers = '0123456789';
    const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
    const allChars = uppercase + lowercase + numbers + symbols;

    let password = '';
    // Ensure at least one of each type
    password += uppercase[Math.floor(Math.random() * uppercase.length)];
    password += lowercase[Math.floor(Math.random() * lowercase.length)];
    password += numbers[Math.floor(Math.random() * numbers.length)];
    password += symbols[Math.floor(Math.random() * symbols.length)];

    // Fill the rest randomly
    for (let i = password.length; i < length; i++) {
        password += allChars[Math.floor(Math.random() * allChars.length)];
    }

    // Shuffle the password
    return password.split('').sort(() => Math.random() - 0.5).join('');
}

// Copy to clipboard
async function copyPasswordToClipboard(text, fieldName = 'Text') {
    try {
        await navigator.clipboard.writeText(text);
        showPasswordToast(`${fieldName} copied to clipboard!`, 'success');
    } catch (error) {
        console.error('Failed to copy:', error);
        // Fallback method
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showPasswordToast(`${fieldName} copied to clipboard!`, 'success');
        } catch (err) {
            showPasswordToast('Failed to copy to clipboard', 'error');
        }
        document.body.removeChild(textArea);
    }
}

// Toggle password visibility
function togglePasswordVisibility(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Render Password Manager Page
async function renderPasswordManager() {
    const dashboard = document.querySelector('.dashboard');

    // Initialize if not already done
    if (!firebasePasswordsManager.isInitialized) {
        await initializeFirebasePasswords();
    }

    const categoryOptions = Object.entries(passwordCategories)
        .map(([value, cat]) => `<option value="${value}">${cat.label}</option>`)
        .join('');

    dashboard.innerHTML = `
        <div class="page-header" style="margin-bottom: 24px;">
            <div class="page-header-left">
                <h2 class="section-title" style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-key" style="color: white; font-size: 20px;"></i>
                    </div>
                    Password Manager
                </h2>
                <p class="section-subtitle">Securely store and manage all your business passwords</p>
            </div>
            <div class="page-header-right" style="display: flex; gap: 12px;">
                <button class="btn-primary" onclick="toggleAddPasswordInline()" style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-plus"></i>
                    Add Password
                </button>
            </div>
        </div>

        <!-- Inline Add Form (hidden by default) -->
        <div id="inline-add-password" style="display: none; margin-bottom: 24px;">
            <div class="card" style="border: 2px solid var(--accent-primary); background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, var(--bg-secondary) 100%);">
                <div class="card-header" style="background: transparent; border-bottom: 1px solid var(--border-color);">
                    <h3 class="card-title" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-plus-circle" style="color: var(--accent-primary);"></i>
                        Add New Password
                    </h3>
                    <button onclick="toggleAddPasswordInline()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 8px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="card-body" style="padding: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Service Name</label>
                            <input type="text" id="inline-pwd-name" class="form-input" placeholder="e.g., AT&T Business">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Category</label>
                            <select id="inline-pwd-category" class="form-input">
                                <option value="">Select category</option>
                                ${categoryOptions}
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Username</label>
                            <input type="text" id="inline-pwd-username" class="form-input" placeholder="Username or ID">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Email</label>
                            <input type="email" id="inline-pwd-email" class="form-input" placeholder="email@example.com">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Password</label>
                            <div style="display: flex; gap: 8px;">
                                <div style="flex: 1; position: relative;">
                                    <input type="password" id="inline-pwd-password" class="form-input" placeholder="Enter password" style="padding-right: 44px;">
                                    <button type="button" onclick="togglePasswordVisibility('inline-pwd-password', 'inline-pwd-toggle-icon')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted);">
                                        <i class="fas fa-eye" id="inline-pwd-toggle-icon"></i>
                                    </button>
                                </div>
                                <button type="button" onclick="generateInlinePassword()" class="btn-secondary" title="Generate">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Website URL</label>
                            <input type="url" id="inline-pwd-url" class="form-input" placeholder="https://example.com">
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Notes</label>
                        <textarea id="inline-pwd-notes" class="form-input" placeholder="Additional notes..." style="min-height: 60px; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 12px;">
                        <button class="btn-secondary" onclick="toggleAddPasswordInline()">Cancel</button>
                        <button class="btn-primary" onclick="saveInlinePassword()">
                            <i class="fas fa-save"></i> Save Password
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 12px; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                    <input type="text" id="password-search" class="form-input" placeholder="Search passwords..."
                        style="padding-left: 46px; height: 48px; font-size: 15px; border-radius: 12px;" oninput="filterPasswords()">
                </div>
                <select id="password-category-filter" class="form-input" onchange="filterPasswords()" style="width: 180px; height: 48px; border-radius: 12px;">
                    <option value="">All Categories</option>
                    ${categoryOptions}
                </select>
            </div>
        </div>

        <!-- Passwords List -->
        <div id="passwords-container">
            ${renderPasswordsList()}
        </div>
    `;
}

// Render passwords as expandable list
function renderPasswordsList() {
    if (firebasePasswords.length === 0) {
        return `
            <div class="card">
                <div class="card-body" style="text-align: center; padding: 60px 20px;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-key" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px;">No Passwords Yet</h3>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Start adding your business passwords to keep them organized and secure.</p>
                    <button class="btn-primary" onclick="toggleAddPasswordInline()">
                        <i class="fas fa-plus"></i> Add Your First Password
                    </button>
                </div>
            </div>
        `;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

    firebasePasswords.forEach(pwd => {
        const catInfo = passwordCategories[pwd.category] || passwordCategories.other;
        const escapedPassword = (pwd.password || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

        html += `
            <div class="password-list-item" data-id="${pwd.firestoreId}" style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.2s;">
                <!-- Main Row (always visible) -->
                <div onclick="togglePasswordExpand('${pwd.firestoreId}')" style="display: flex; align-items: center; padding: 16px 20px; gap: 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                    <!-- Icon -->
                    <div style="width: 48px; height: 48px; background: ${catInfo.color}15; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas ${catInfo.icon}" style="color: ${catInfo.color}; font-size: 20px;"></i>
                    </div>

                    <!-- Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 10px;">
                            ${pwd.name || 'Unnamed'}
                            ${pwd.url ? `<a href="${pwd.url}" target="_blank" onclick="event.stopPropagation()" style="color: var(--accent-primary); font-size: 12px;"><i class="fas fa-external-link-alt"></i></a>` : ''}
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            ${pwd.username ? `<span><i class="fas fa-user" style="margin-right: 4px; opacity: 0.6;"></i>${pwd.username}</span>` : ''}
                            ${pwd.email ? `<span><i class="fas fa-envelope" style="margin-right: 4px; opacity: 0.6;"></i>${pwd.email}</span>` : ''}
                        </div>
                    </div>

                    <!-- Category Badge -->
                    <div style="background: ${catInfo.color}15; color: ${catInfo.color}; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        ${catInfo.label}
                    </div>

                    <!-- Quick Actions -->
                    <div style="display: flex; gap: 6px;" onclick="event.stopPropagation()">
                        <button onclick="copyPasswordToClipboard('${escapedPassword}', 'Password')" style="width: 38px; height: 38px; border-radius: 10px; border: none; background: var(--accent-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s;" title="Copy Password">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>

                    <!-- Expand Arrow -->
                    <div style="color: var(--text-muted); transition: transform 0.3s;" id="arrow-${pwd.firestoreId}">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>

                <!-- Expanded Details (hidden by default) -->
                <div id="expand-${pwd.firestoreId}" style="display: none; padding: 0 20px 20px; border-top: 1px solid var(--border-color); margin-top: 0;">
                    <div style="padding-top: 20px;">
                        <!-- Password Display -->
                        <div style="background: var(--bg-primary); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Password</div>
                                    <div style="font-family: 'Space Mono', monospace; font-size: 16px; color: var(--text-primary);" id="pwd-display-${pwd.firestoreId}">⑩⑩⑩⑩⑩⑩⑩⑩⑩⑩⑩</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="togglePasswordDisplay('${pwd.firestoreId}', '${escapedPassword}')" style="width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);" title="Show/Hide">
                                        <i class="fas fa-eye" id="pwd-icon-${pwd.firestoreId}"></i>
                                    </button>
                                    <button onclick="copyPasswordToClipboard('${escapedPassword}', 'Password')" style="width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Details Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            ${pwd.username ? `
                                <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px;">
                                    <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Username</div>
                                    <div style="font-size: 14px; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between;">
                                        <span>${pwd.username}</span>
                                        <button onclick="copyPasswordToClipboard('${pwd.username}', 'Username')" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                            <i class="fas fa-copy" style="font-size: 12px;"></i>
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${pwd.email ? `
                                <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px;">
                                    <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Email</div>
                                    <div style="font-size: 14px; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between;">
                                        <span style="overflow: hidden; text-overflow: ellipsis;">${pwd.email}</span>
                                        <button onclick="copyPasswordToClipboard('${pwd.email}', 'Email')" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                            <i class="fas fa-copy" style="font-size: 12px;"></i>
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${pwd.url ? `
                                <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px;">
                                    <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Website</div>
                                    <div style="font-size: 14px;">
                                        <a href="${pwd.url}" target="_blank" style="color: var(--accent-primary); text-decoration: none; display: flex; align-items: center; gap: 6px;">
                                            <i class="fas fa-external-link-alt" style="font-size: 10px;"></i>
                                            Open Site
                                        </a>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        ${pwd.notes ? `
                            <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                                <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Notes</div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">${pwd.notes}</div>
                            </div>
                        ` : ''}

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <button onclick="startEditPasswordInline('${pwd.firestoreId}')" class="btn-secondary" style="font-size: 13px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deletePasswordConfirm('${pwd.firestoreId}')" class="btn-secondary" style="font-size: 13px; color: #ef4444; border-color: #ef444450;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    return html;
}

// For backwards compatibility
function renderPasswordsGrid() {
    return renderPasswordsList();
}

// Toggle password expand/collapse
function togglePasswordExpand(id) {
    const expandDiv = document.getElementById(`expand-${id}`);
    const arrow = document.getElementById(`arrow-${id}`);

    if (expandDiv.style.display === 'none') {
        // Collapse all others first
        document.querySelectorAll('[id^="expand-"]').forEach(el => {
            el.style.display = 'none';
        });
        document.querySelectorAll('[id^="arrow-"]').forEach(el => {
            el.style.transform = 'rotate(0deg)';
        });

        // Expand this one
        expandDiv.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        expandDiv.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Toggle add password inline form
function toggleAddPasswordInline() {
    const form = document.getElementById('inline-add-password');
    if (form.style.display === 'none') {
        form.style.display = 'block';
        document.getElementById('inline-pwd-name').focus();
    } else {
        form.style.display = 'none';
        // Clear form
        document.getElementById('inline-pwd-name').value = '';
        document.getElementById('inline-pwd-category').value = '';
        document.getElementById('inline-pwd-username').value = '';
        document.getElementById('inline-pwd-email').value = '';
        document.getElementById('inline-pwd-password').value = '';
        document.getElementById('inline-pwd-url').value = '';
        document.getElementById('inline-pwd-notes').value = '';
    }
}

// Generate password for inline form
function generateInlinePassword() {
    const password = generateRandomPassword(16);
    const input = document.getElementById('inline-pwd-password');
    input.value = password;
    input.type = 'text';
    document.getElementById('inline-pwd-toggle-icon').classList.remove('fa-eye');
    document.getElementById('inline-pwd-toggle-icon').classList.add('fa-eye-slash');
}

// Save password from inline form
async function saveInlinePassword() {
    const name = document.getElementById('inline-pwd-name').value.trim();
    const category = document.getElementById('inline-pwd-category').value;
    const username = document.getElementById('inline-pwd-username').value.trim();
    const email = document.getElementById('inline-pwd-email').value.trim();
    const password = document.getElementById('inline-pwd-password').value;
    const url = document.getElementById('inline-pwd-url').value.trim();
    const notes = document.getElementById('inline-pwd-notes').value.trim();

    if (!name) {
        showPasswordToast('Please enter a service name', 'error');
        return;
    }

    if (!password) {
        showPasswordToast('Please enter a password', 'error');
        return;
    }

    try {
        const newPassword = {
            name,
            category: category || 'other',
            username,
            email,
            password,
            url,
            notes
        };

        await firebasePasswordsManager.addPassword(newPassword);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        toggleAddPasswordInline();
        renderPasswordManager();
        showPasswordToast('Password saved successfully!', 'success');
    } catch (error) {
        console.error('Error saving password:', error);
        showPasswordToast('Error saving password. Please try again.', 'error');
    }
}

// Start inline edit
function startEditPasswordInline(firestoreId) {
    const pwd = firebasePasswords.find(p => p.firestoreId === firestoreId);
    if (!pwd) return;

    const categoryOptions = Object.entries(passwordCategories)
        .map(([value, cat]) => `<option value="${value}" ${pwd.category === value ? 'selected' : ''}>${cat.label}</option>`)
        .join('');

    const expandDiv = document.getElementById(`expand-${firestoreId}`);
    expandDiv.innerHTML = `
        <div style="padding-top: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Service Name</label>
                    <input type="text" id="edit-inline-name-${firestoreId}" class="form-input" value="${pwd.name || ''}">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Category</label>
                    <select id="edit-inline-category-${firestoreId}" class="form-input">
                        ${categoryOptions}
                    </select>
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Username</label>
                    <input type="text" id="edit-inline-username-${firestoreId}" class="form-input" value="${pwd.username || ''}">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Email</label>
                    <input type="email" id="edit-inline-email-${firestoreId}" class="form-input" value="${pwd.email || ''}">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Password</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="edit-inline-password-${firestoreId}" class="form-input" value="${pwd.password || ''}" style="flex: 1;">
                        <button type="button" onclick="document.getElementById('edit-inline-password-${firestoreId}').value = generateRandomPassword(16)" class="btn-secondary" title="Generate">
                            <i class="fas fa-wand-magic-sparkles"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Website URL</label>
                    <input type="url" id="edit-inline-url-${firestoreId}" class="form-input" value="${pwd.url || ''}">
                </div>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Notes</label>
                <textarea id="edit-inline-notes-${firestoreId}" class="form-input" style="min-height: 60px; resize: vertical;">${pwd.notes || ''}</textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="renderPasswordManager()" class="btn-secondary" style="font-size: 13px;">Cancel</button>
                <button onclick="saveEditPasswordInline('${firestoreId}')" class="btn-primary" style="font-size: 13px;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    `;
}

// Save inline edit
async function saveEditPasswordInline(firestoreId) {
    const name = document.getElementById(`edit-inline-name-${firestoreId}`).value.trim();
    const category = document.getElementById(`edit-inline-category-${firestoreId}`).value;
    const username = document.getElementById(`edit-inline-username-${firestoreId}`).value.trim();
    const email = document.getElementById(`edit-inline-email-${firestoreId}`).value.trim();
    const password = document.getElementById(`edit-inline-password-${firestoreId}`).value;
    const url = document.getElementById(`edit-inline-url-${firestoreId}`).value.trim();
    const notes = document.getElementById(`edit-inline-notes-${firestoreId}`).value.trim();

    if (!name) {
        showPasswordToast('Please enter a service name', 'error');
        return;
    }

    try {
        const updatedData = {
            name,
            category: category || 'other',
            username,
            email,
            password,
            url,
            notes
        };

        await firebasePasswordsManager.updatePassword(firestoreId, updatedData);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        renderPasswordManager();
        showPasswordToast('Password updated successfully!', 'success');
    } catch (error) {
        console.error('Error updating password:', error);
        showPasswordToast('Error updating password. Please try again.', 'error');
    }
}

// Toggle password display in list
function togglePasswordDisplay(id, password) {
    const display = document.getElementById(`pwd-display-${id}`);
    const icon = document.getElementById(`pwd-icon-${id}`);

    if (display.textContent === '⑩⑩⑩⑩⑩⑩⑩⑩⑩⑩⑩') {
        display.textContent = password;
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        display.textContent = '⑩⑩⑩⑩⑩⑩⑩⑩⑩⑩⑩';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Filter passwords
function filterPasswords() {
    const searchTerm = document.getElementById('password-search')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('password-category-filter')?.value || '';

    const items = document.querySelectorAll('.password-list-item');

    items.forEach(item => {
        const id = item.dataset.id;
        const pwd = firebasePasswords.find(p => p.firestoreId === id);
        if (!pwd) return;

        const matchesSearch = !searchTerm ||
            pwd.name?.toLowerCase().includes(searchTerm) ||
            pwd.username?.toLowerCase().includes(searchTerm) ||
            pwd.email?.toLowerCase().includes(searchTerm) ||
            pwd.url?.toLowerCase().includes(searchTerm) ||
            pwd.notes?.toLowerCase().includes(searchTerm);

        const matchesCategory = !categoryFilter || pwd.category === categoryFilter;

        if (matchesSearch && matchesCategory) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Open Add Password Modal
function openAddPasswordModal() {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    const categoryOptions = Object.entries(passwordCategories)
        .map(([value, cat]) => `<option value="${value}">${cat.label}</option>`)
        .join('');

    modalContent.innerHTML = `
        <div class="modal-header">
            <h2 style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-plus" style="color: white;"></i>
                </div>
                Add New Password
            </h2>
            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="add-password-form" style="display: grid; gap: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label">Service Name</label>
                        <input type="text" id="pwd-name" class="form-input" placeholder="e.g., AT&T Business">
                    </div>
                    <div>
                        <label class="form-label">Category</label>
                        <select id="pwd-category" class="form-input">
                            <option value="">Select category</option>
                            ${categoryOptions}
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label">Username</label>
                        <input type="text" id="pwd-username" class="form-input" placeholder="Username or account ID">
                    </div>
                    <div>
                        <label class="form-label">Email</label>
                        <input type="email" id="pwd-email" class="form-input" placeholder="Associated email">
                    </div>
                </div>

                <div>
                    <label class="form-label">Password</label>
                    <div style="display: flex; gap: 8px;">
                        <div style="flex: 1; position: relative;">
                            <input type="password" id="pwd-password" class="form-input" placeholder="Enter password" style="padding-right: 44px;">
                            <button type="button" onclick="togglePasswordVisibility('pwd-password', 'pwd-toggle-icon')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                <i class="fas fa-eye" id="pwd-toggle-icon"></i>
                            </button>
                        </div>
                        <button type="button" onclick="fillGeneratedPassword()" class="btn-secondary" style="white-space: nowrap;" title="Generate strong password">
                            <i class="fas fa-wand-magic-sparkles"></i> Generate
                        </button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Website URL</label>
                    <input type="url" id="pwd-url" class="form-input" placeholder="https://example.com">
                </div>

                <div>
                    <label class="form-label">Notes</label>
                    <textarea id="pwd-notes" class="form-input" placeholder="Additional notes, security questions, account number, etc." style="min-height: 80px; resize: vertical;"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="saveNewPassword()">
                <i class="fas fa-save"></i> Save Password
            </button>
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    `;

    modal.classList.add('active');
}

// Fill generated password
function fillGeneratedPassword() {
    const password = generateRandomPassword(16);
    const input = document.getElementById('pwd-password');
    input.value = password;
    input.type = 'text'; // Show the generated password
    document.getElementById('pwd-toggle-icon').classList.remove('fa-eye');
    document.getElementById('pwd-toggle-icon').classList.add('fa-eye-slash');
}

// Save new password
async function saveNewPassword() {
    const name = document.getElementById('pwd-name').value.trim();
    const category = document.getElementById('pwd-category').value;
    const username = document.getElementById('pwd-username').value.trim();
    const email = document.getElementById('pwd-email').value.trim();
    const password = document.getElementById('pwd-password').value;
    const url = document.getElementById('pwd-url').value.trim();
    const notes = document.getElementById('pwd-notes').value.trim();

    if (!name) {
        showPasswordToast('Please enter a service name', 'error');
        return;
    }

    if (!password) {
        showPasswordToast('Please enter a password', 'error');
        return;
    }

    try {
        const newPassword = {
            name,
            category: category || 'other',
            username,
            email,
            password,
            url,
            notes
        };

        await firebasePasswordsManager.addPassword(newPassword);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        closeModal();
        renderPasswordManager();
        showPasswordToast('Password saved successfully!', 'success');
    } catch (error) {
        console.error('Error saving password:', error);
        showPasswordToast('Error saving password. Please try again.', 'error');
    }
}

// Open Edit Password Modal
function openEditPasswordModal(firestoreId) {
    const pwd = firebasePasswords.find(p => p.firestoreId === firestoreId);
    if (!pwd) return;

    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    const categoryOptions = Object.entries(passwordCategories)
        .map(([value, cat]) => `<option value="${value}" ${pwd.category === value ? 'selected' : ''}>${cat.label}</option>`)
        .join('');

    modalContent.innerHTML = `
        <div class="modal-header">
            <h2 style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-edit" style="color: white;"></i>
                </div>
                Edit Password
            </h2>
            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="edit-password-form" style="display: grid; gap: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label">Service Name</label>
                        <input type="text" id="edit-pwd-name" class="form-input" value="${pwd.name || ''}" placeholder="e.g., AT&T Business">
                    </div>
                    <div>
                        <label class="form-label">Category</label>
                        <select id="edit-pwd-category" class="form-input">
                            <option value="">Select category</option>
                            ${categoryOptions}
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label">Username</label>
                        <input type="text" id="edit-pwd-username" class="form-input" value="${pwd.username || ''}" placeholder="Username or account ID">
                    </div>
                    <div>
                        <label class="form-label">Email</label>
                        <input type="email" id="edit-pwd-email" class="form-input" value="${pwd.email || ''}" placeholder="Associated email">
                    </div>
                </div>

                <div>
                    <label class="form-label">Password</label>
                    <div style="display: flex; gap: 8px;">
                        <div style="flex: 1; position: relative;">
                            <input type="password" id="edit-pwd-password" class="form-input" value="${pwd.password || ''}" placeholder="Enter password" style="padding-right: 44px;">
                            <button type="button" onclick="togglePasswordVisibility('edit-pwd-password', 'edit-pwd-toggle-icon')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                <i class="fas fa-eye" id="edit-pwd-toggle-icon"></i>
                            </button>
                        </div>
                        <button type="button" onclick="fillEditGeneratedPassword()" class="btn-secondary" style="white-space: nowrap;" title="Generate strong password">
                            <i class="fas fa-wand-magic-sparkles"></i> Generate
                        </button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Website URL</label>
                    <input type="url" id="edit-pwd-url" class="form-input" value="${pwd.url || ''}" placeholder="https://example.com">
                </div>

                <div>
                    <label class="form-label">Notes</label>
                    <textarea id="edit-pwd-notes" class="form-input" placeholder="Additional notes, security questions, account number, etc." style="min-height: 80px; resize: vertical;">${pwd.notes || ''}</textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <div style="display: flex; gap: 8px;">
                <button class="btn-primary" onclick="updatePassword('${firestoreId}')">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
            <button class="btn-danger" onclick="deletePasswordConfirm('${firestoreId}')" style="background: #ef4444; color: white; border: none;">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    `;

    modal.classList.add('active');
}

// Fill generated password for edit form
function fillEditGeneratedPassword() {
    const password = generateRandomPassword(16);
    const input = document.getElementById('edit-pwd-password');
    input.value = password;
    input.type = 'text';
    document.getElementById('edit-pwd-toggle-icon').classList.remove('fa-eye');
    document.getElementById('edit-pwd-toggle-icon').classList.add('fa-eye-slash');
}

// Update password
async function updatePassword(firestoreId) {
    const name = document.getElementById('edit-pwd-name').value.trim();
    const category = document.getElementById('edit-pwd-category').value;
    const username = document.getElementById('edit-pwd-username').value.trim();
    const email = document.getElementById('edit-pwd-email').value.trim();
    const password = document.getElementById('edit-pwd-password').value;
    const url = document.getElementById('edit-pwd-url').value.trim();
    const notes = document.getElementById('edit-pwd-notes').value.trim();

    if (!name) {
        showPasswordToast('Please enter a service name', 'error');
        return;
    }

    if (!password) {
        showPasswordToast('Please enter a password', 'error');
        return;
    }

    try {
        const updateData = {
            name,
            category: category || 'other',
            username,
            email,
            password,
            url,
            notes
        };

        await firebasePasswordsManager.updatePassword(firestoreId, updateData);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        closeModal();
        renderPasswordManager();
        showPasswordToast('Password updated successfully!', 'success');
    } catch (error) {
        console.error('Error updating password:', error);
        showPasswordToast('Error updating password. Please try again.', 'error');
    }
}

// Delete password confirmation
function deletePasswordConfirm(firestoreId) {
    const pwd = firebasePasswords.find(p => p.firestoreId === firestoreId);
    if (!pwd) return;

    if (confirm(`Are you sure you want to delete "${pwd.name}"?\n\nThis action cannot be undone.`)) {
        deletePassword(firestoreId);
    }
}

// Delete password
async function deletePassword(firestoreId) {
    try {
        await firebasePasswordsManager.deletePassword(firestoreId);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        closeModal();
        renderPasswordManager();
        showPasswordToast('Password deleted successfully!', 'success');
    } catch (error) {
        console.error('Error deleting password:', error);
        showPasswordToast('Error deleting password. Please try again.', 'error');
    }
}

// Toast notification for password manager
function showPasswordToast(message, type = 'info') {
    // Check if toast container exists
    let toastContainer = document.getElementById('password-toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'password-toast-container';
        toastContainer.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
        document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };

    toast.style.cssText = `
        padding: 14px 20px;
        background: ${colors[type] || colors.info};
        color: white;
        border-radius: 10px;
        font-weight: 500;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: pwdSlideIn 0.3s ease;
    `;

    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };

    toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i> ${message}`;
    toastContainer.appendChild(toast);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'pwdSlideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Add CSS animation for password toast
const pwdToastStyles = document.createElement('style');
pwdToastStyles.textContent = `
    @keyframes pwdSlideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes pwdSlideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    .password-item:hover {
        background: var(--bg-tertiary) !important;
    }
    .btn-icon:hover {
        background: var(--bg-tertiary) !important;
        transform: translateY(-1px);
    }
`;
document.head.appendChild(pwdToastStyles);

// =====================================================
// PROJECT ANALYTICS MODULE
// =====================================================

function renderProjectAnalytics() {
    const dashboard = document.querySelector('.dashboard');

    // Project statistics
    const projectStats = {
        totalLines: 42045,
        jsLines: 32165,
        htmlLines: 3059,
        cssLines: 6125,
        configLines: 696,
        totalFunctions: 557,
        totalFiles: 20,
        totalModules: 26,
        projectSize: '4.4 MB',
        stores: 5,
        lastUpdate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
    };

    // Module list with descriptions
    const modules = [
        { name: 'Dashboard', icon: 'fa-th-large', status: 'active', description: 'Overview & KPIs' },
        { name: 'Employees', icon: 'fa-users', status: 'active', description: 'Staff management & profiles' },
        { name: 'Schedule', icon: 'fa-calendar-alt', status: 'active', description: 'Shift scheduling system' },
        { name: 'Clock In/Out', icon: 'fa-clock', status: 'active', description: 'Time tracking' },
        { name: 'Training Center', icon: 'fa-graduation-cap', status: 'active', description: 'Video & document training' },
        { name: 'Licenses & Docs', icon: 'fa-folder-open', status: 'active', description: 'Compliance management' },
        { name: 'Sales Analytics', icon: 'fa-chart-line', status: 'active', description: 'Shopify integration' },
        { name: 'New Stuff', icon: 'fa-box', status: 'active', description: 'Incoming inventory' },
        { name: 'Restock Requests', icon: 'fa-boxes', status: 'active', description: 'Stock replenishment' },
        { name: 'Abundance Cloud', icon: 'fa-cloud', status: 'active', description: 'Order management engine' },
        { name: 'Announcements', icon: 'fa-bullhorn', status: 'active', description: 'Internal communications' },
        { name: 'Thieves Database', icon: 'fa-user-secret', status: 'active', description: 'Incident tracking' },
        { name: 'Invoices', icon: 'fa-file-invoice-dollar', status: 'active', description: 'Payment management' },
        { name: 'Issues Registry', icon: 'fa-exclamation-triangle', status: 'active', description: 'Customer complaints' },
        { name: 'Gconomics', icon: 'fa-wallet', status: 'active', description: 'Financial tracking' },
        { name: 'Vendors', icon: 'fa-truck', status: 'active', description: 'Supplier directory' },
        { name: 'Expenses Control', icon: 'fa-money-bill-wave', status: 'active', description: 'Cash out tracking' },
        { name: 'Treasury', icon: 'fa-vault', status: 'active', description: 'Asset collection' },
        { name: 'Change Records', icon: 'fa-coins', status: 'active', description: 'Cash flow between stores' },
        { name: 'Customer Care', icon: 'fa-gift', status: 'active', description: 'Gift tracking' },
        { name: 'Risk Notes', icon: 'fa-shield-halved', status: 'active', description: 'Security alerts' },
        { name: 'Password Manager', icon: 'fa-key', status: 'active', description: 'Credentials vault' },
        { name: 'G Force', icon: 'fa-bolt', status: 'active', description: 'Daily motivation' },
        { name: 'Store Management', icon: 'fa-store', status: 'active', description: 'Multi-location control' },
        { name: 'Authentication', icon: 'fa-lock', status: 'active', description: 'Role-based access' },
        { name: 'Project Analytics', icon: 'fa-code', status: 'active', description: 'This module!' }
    ];

    // Store locations
    const storeLocations = [
        { name: 'VSU Miramar', status: 'HQ', employees: 6 },
        { name: 'VSU Morena', status: 'Active', employees: 5 },
        { name: 'VSU Kearny Mesa', status: 'Active', employees: 5 },
        { name: 'VSU Chula Vista', status: 'Active', employees: 4 },
        { name: 'VSU North Park', status: 'Active', employees: 3 }
    ];

    // Build stores HTML
    const storesHtml = storeLocations.map(store =>
        '<div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid ' + (store.status === 'HQ' ? '#ef4444' : '#10b981') + ';">' +
            '<div style="font-weight: 600; margin-bottom: 4px;">' + store.name + '</div>' +
            '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                '<span style="font-size: 12px; padding: 4px 8px; background: ' + (store.status === 'HQ' ? '#fef2f2' : '#ecfdf5') + '; color: ' + (store.status === 'HQ' ? '#ef4444' : '#10b981') + '; border-radius: 6px; font-weight: 500;">' + store.status + '</span>' +
                '<span style="color: var(--text-muted); font-size: 13px;"><i class="fas fa-users"></i> ' + store.employees + '</span>' +
            '</div>' +
        '</div>'
    ).join('');

    // Build modules HTML
    const modulesHtml = modules.map(mod =>
        '<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\';" onmouseout="this.style.transform=\'none\'; this.style.boxShadow=\'none\';">' +
            '<div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">' +
                '<i class="fas ' + mod.icon + '" style="color: white; font-size: 14px;"></i>' +
            '</div>' +
            '<div style="flex: 1; min-width: 0;">' +
                '<div style="font-weight: 500; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + mod.name + '</div>' +
                '<div style="font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + mod.description + '</div>' +
            '</div>' +
            '<div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></div>' +
        '</div>'
    ).join('');

    dashboard.innerHTML =
        '<div class="page-header" style="margin-bottom: 24px;">' +
            '<div class="page-header-left">' +
                '<h2 class="section-title" style="display: flex; align-items: center; gap: 12px;">' +
                    '<div style="width: 48px; height: 48px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 14px; display: flex; align-items: center; justify-content: center;">' +
                        '<i class="fas fa-code" style="color: white; font-size: 20px;"></i>' +
                    '</div>' +
                    'Project Analytics' +
                '</h2>' +
                '<p class="section-subtitle">Ascendance Hub - Enterprise Management System Statistics</p>' +
            '</div>' +
        '</div>' +

        '<!-- Hero Stats -->' +
        '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">' +
            '<div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; padding: 24px; border-radius: 16px;">' +
                '<div style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">' + projectStats.totalLines.toLocaleString() + '</div>' +
                '<div style="opacity: 0.9; font-size: 14px;">Lines of Code</div>' +
            '</div>' +
            '<div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 24px; border-radius: 16px;">' +
                '<div style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">' + projectStats.totalFunctions + '</div>' +
                '<div style="opacity: 0.9; font-size: 14px;">Functions</div>' +
            '</div>' +
            '<div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 24px; border-radius: 16px;">' +
                '<div style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">' + projectStats.totalModules + '</div>' +
                '<div style="opacity: 0.9; font-size: 14px;">Modules</div>' +
            '</div>' +
            '<div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 24px; border-radius: 16px;">' +
                '<div style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">' + projectStats.projectSize + '</div>' +
                '<div style="opacity: 0.9; font-size: 14px;">Total Size</div>' +
            '</div>' +
            '<div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 24px; border-radius: 16px;">' +
                '<div style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">' + projectStats.stores + '</div>' +
                '<div style="opacity: 0.9; font-size: 14px;">Store Locations</div>' +
            '</div>' +
        '</div>' +

        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">' +
            '<!-- Code Breakdown -->' +
            '<div class="card">' +
                '<div class="card-header">' +
                    '<h3 class="card-title"><i class="fas fa-chart-pie"></i> Code Breakdown</h3>' +
                '</div>' +
                '<div class="card-body">' +
                    '<div style="display: flex; flex-direction: column; gap: 16px;">' +
                        '<div>' +
                            '<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">' +
                                '<span style="font-weight: 500;">JavaScript</span>' +
                                '<span style="color: var(--text-muted);">' + projectStats.jsLines.toLocaleString() + ' lines</span>' +
                            '</div>' +
                            '<div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">' +
                                '<div style="width: 76%; height: 100%; background: linear-gradient(90deg, #f7df1e, #f0d000); border-radius: 5px;"></div>' +
                            '</div>' +
                        '</div>' +
                        '<div>' +
                            '<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">' +
                                '<span style="font-weight: 500;">CSS</span>' +
                                '<span style="color: var(--text-muted);">' + projectStats.cssLines.toLocaleString() + ' lines</span>' +
                            '</div>' +
                            '<div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">' +
                                '<div style="width: 15%; height: 100%; background: linear-gradient(90deg, #264de4, #2965f1); border-radius: 5px;"></div>' +
                            '</div>' +
                        '</div>' +
                        '<div>' +
                            '<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">' +
                                '<span style="font-weight: 500;">HTML</span>' +
                                '<span style="color: var(--text-muted);">' + projectStats.htmlLines.toLocaleString() + ' lines</span>' +
                            '</div>' +
                            '<div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">' +
                                '<div style="width: 7%; height: 100%; background: linear-gradient(90deg, #e34f26, #f06529); border-radius: 5px;"></div>' +
                            '</div>' +
                        '</div>' +
                        '<div>' +
                            '<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">' +
                                '<span style="font-weight: 500;">Config</span>' +
                                '<span style="color: var(--text-muted);">' + projectStats.configLines.toLocaleString() + ' lines</span>' +
                            '</div>' +
                            '<div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">' +
                                '<div style="width: 2%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 5px;"></div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +

            '<!-- Tech Stack -->' +
            '<div class="card">' +
                '<div class="card-header">' +
                    '<h3 class="card-title"><i class="fas fa-layer-group"></i> Technology Stack</h3>' +
                '</div>' +
                '<div class="card-body">' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">' +
                        '<div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">' +
                            '<i class="fab fa-js" style="font-size: 32px; color: #f7df1e; margin-bottom: 8px;"></i>' +
                            '<div style="font-weight: 600;">Vanilla JS</div>' +
                            '<div style="font-size: 12px; color: var(--text-muted);">No frameworks</div>' +
                        '</div>' +
                        '<div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">' +
                            '<i class="fas fa-fire" style="font-size: 32px; color: #ffca28; margin-bottom: 8px;"></i>' +
                            '<div style="font-weight: 600;">Firebase</div>' +
                            '<div style="font-size: 12px; color: var(--text-muted);">Real-time sync</div>' +
                        '</div>' +
                        '<div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">' +
                            '<i class="fas fa-chart-bar" style="font-size: 32px; color: #ff6384; margin-bottom: 8px;"></i>' +
                            '<div style="font-weight: 600;">Chart.js</div>' +
                            '<div style="font-size: 12px; color: var(--text-muted);">Data visualization</div>' +
                        '</div>' +
                        '<div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">' +
                            '<i class="fab fa-font-awesome" style="font-size: 32px; color: #339af0; margin-bottom: 8px;"></i>' +
                            '<div style="font-weight: 600;">Font Awesome</div>' +
                            '<div style="font-size: 12px; color: var(--text-muted);">Icon library</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>' +

        '<!-- Store Locations -->' +
        '<div class="card" style="margin-bottom: 24px;">' +
            '<div class="card-header">' +
                '<h3 class="card-title"><i class="fas fa-store"></i> Store Network (' + storeLocations.length + ' Locations)</h3>' +
            '</div>' +
            '<div class="card-body">' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">' +
                    storesHtml +
                '</div>' +
            '</div>' +
        '</div>' +

        '<!-- All Modules -->' +
        '<div class="card">' +
            '<div class="card-header">' +
                '<h3 class="card-title"><i class="fas fa-puzzle-piece"></i> System Modules (' + modules.length + ')</h3>' +
            '</div>' +
            '<div class="card-body">' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px;">' +
                    modulesHtml +
                '</div>' +
            '</div>' +
        '</div>' +

        '<!-- Footer -->' +
        '<div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border-radius: 16px; text-align: center;">' +
            '<div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, #8b5cf6, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">' +
                'Ascendance Hub' +
            '</div>' +
            '<div style="color: var(--text-muted); font-size: 14px; margin-bottom: 12px;">' +
                'Enterprise-grade retail management built from scratch' +
            '</div>' +
            '<div style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap;">' +
                '<div style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary);">' +
                    '<i class="fas fa-code"></i> 100% Custom Code' +
                '</div>' +
                '<div style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary);">' +
                    '<i class="fas fa-rocket"></i> Zero Dependencies' +
                '</div>' +
                '<div style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary);">' +
                    '<i class="fas fa-cloud"></i> Real-time Sync' +
                '</div>' +
                '<div style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary);">' +
                    '<i class="fas fa-shield-alt"></i> Role-based Auth' +
                '</div>' +
            '</div>' +
        '</div>';
}
