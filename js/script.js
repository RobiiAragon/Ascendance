        // Page/View System
        const pages = {
            dashboard: document.getElementById('page-dashboard'),
            employees: null,
            training: null,
            licenses: null,
            analytics: null,
            newstuff: null,
            restock: null,
            abundancecloud: null,
            stores: null,
            announcements: null,
            tasks: null,
            schedule: null,
            settings: null,
            help: null,
            thieves: null,
            invoices: null,
            issues: null,
            gsuite: null,
            vendors: null,
            clockin: null,
            dailysales: null,
            cashout: null,
            change: null,
            projectanalytics: null,
            hrapplications: null
        };

        // Current state
        let currentPage = 'dashboard';
        let employees = [
            { id: 1, name: 'Marcus Rodriguez', initials: 'MR', role: 'Store Manager', store: 'Miramar', status: 'active', email: 'marcus@vsu.com', phone: '(619) 555-0101', emergencyContact: 'Maria Rodriguez - (619) 555-0102', allergies: 'None', hireDate: '2023-01-15', color: 'a' },
            { id: 2, name: 'Sarah Kim', initials: 'SK', role: 'Sales Associate', store: 'Morena', status: 'active', email: 'sarah@vsu.com', phone: '(619) 555-0103', emergencyContact: 'John Kim - (619) 555-0104', allergies: 'Peanuts', hireDate: '2023-03-20', color: 'b' },
            { id: 3, name: 'James Thompson', initials: 'JT', role: 'Shift Lead', store: 'Kearny Mesa', status: 'active', email: 'james@vsu.com', phone: '(619) 555-0105', emergencyContact: 'Lisa Thompson - (619) 555-0106', allergies: 'None', hireDate: '2023-02-10', color: 'c' },
            { id: 4, name: 'Amanda Lopez', initials: 'AL', role: 'Sales Associate', store: 'Chula Vista', status: 'inactive', email: 'amanda@vsu.com', phone: '(619) 555-0107', emergencyContact: 'Carlos Lopez - (619) 555-0108', allergies: 'Shellfish', hireDate: '2023-05-01', color: 'd' },
            { id: 5, name: 'David Nguyen', initials: 'DN', role: 'Inventory Specialist', store: 'Miramar', status: 'active', email: 'david@vsu.com', phone: '(619) 555-0109', emergencyContact: 'Linh Nguyen - (619) 555-0110', allergies: 'None', hireDate: '2023-04-15', color: 'e' }
        ];

        let trainings = [
            { id: 1, title: 'Product Knowledge 101', type: 'video', url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ', duration: '45 min', completion: 92, required: true },
            { id: 2, title: 'Customer Service Excellence', type: 'video', url: 'https://vimeo.com/148751763', duration: '30 min', completion: 78, required: true },
            { id: 3, title: 'Safety & Compliance', type: 'document', url: '#', duration: '20 min', completion: 85, required: true },
            { id: 4, title: 'POS System Training', type: 'video', url: 'https://www.youtube.com/watch?v=jNQXAC9IVRw', duration: '60 min', completion: 64, required: true }
        ];

        // Training view mode state
        let trainingViewMode = 'grid'; // 'grid' or 'list'

        let licenses = [
            { id: 1, name: 'Business License', store: 'Miramar', expires: '2025-12-31', status: 'valid', file: 'business_license_miramar.pdf' },
            { id: 2, name: 'Tobacco License', store: 'Morena', expires: '2026-01-15', status: 'expiring', file: 'tobacco_license_morena.pdf' },
            { id: 3, name: 'Health Permit', store: 'Kearny Mesa', expires: '2026-03-20', status: 'valid', file: 'health_permit_kearny.pdf' },
            { id: 4, name: 'Fire Safety Certificate', store: 'Chula Vista', expires: '2026-02-10', status: 'expiring', file: 'fire_safety_chula.pdf' },
            { id: 5, name: 'Business License', store: 'Morena', expires: '2025-11-30', status: 'valid', file: 'business_license_morena.pdf' },
            { id: 6, name: 'Business License', store: 'Kearny Mesa', expires: '2026-06-15', status: 'valid', file: 'business_license_kearny.pdf' }
        ];

        let announcements = [
            { id: 1, date: '2025-12-02', title: 'Holiday Schedule', content: 'Holiday schedule updates have been posted. Please check your shifts for the upcoming weeks.', author: 'VSU Admin' },
            { id: 2, date: '2025-11-28', title: 'New Product Line', content: 'New product line arriving next week - mandatory training session on Thursday.', author: 'VSU Admin' },
            { id: 3, date: '2025-11-25', title: 'Q4 Achievement', content: 'Congratulations to VSU Miramar for hitting Q4 sales targets! üéâ', author: 'VSU Admin' }
        ];

        // Track which announcements the current user has read
        let readAnnouncementIds = [];

        /**
         * Show a confirmation modal dialog
         * @param {Object} options - Configuration options
         * @param {string} options.title - Modal title
         * @param {string} options.message - Confirmation message
         * @param {string} options.confirmText - Text for confirm button (default: 'Delete')
         * @param {string} options.cancelText - Text for cancel button (default: 'Cancel')
         * @param {string} options.type - Type of modal: 'danger', 'warning', 'info' (default: 'danger')
         * @param {Function} options.onConfirm - Callback function when confirmed
         * @param {Function} options.onCancel - Callback function when cancelled (optional)
         */
        function showConfirmModal(options) {
            const {
                title = 'Confirm Action',
                message = 'Are you sure you want to proceed?',
                confirmText = 'Delete',
                cancelText = 'Cancel',
                type = 'danger',
                onConfirm,
                onCancel
            } = options;

            // Define colors based on type
            const typeColors = {
                danger: { bg: '#ef4444', icon: 'fa-trash-alt' },
                warning: { bg: '#f59e0b', icon: 'fa-exclamation-triangle' },
                info: { bg: '#3b82f6', icon: 'fa-info-circle' }
            };
            const colors = typeColors[type] || typeColors.danger;

            // Create modal HTML
            const modalHtml = `
                <div id="confirm-modal-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(4px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    animation: fadeIn 0.2s ease;
                ">
                    <div id="confirm-modal-content" style="
                        background: var(--bg-primary);
                        border-radius: 16px;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        max-width: 420px;
                        width: 90%;
                        overflow: hidden;
                        animation: slideUp 0.3s ease;
                    ">
                        <div style="
                            background: ${colors.bg};
                            padding: 24px;
                            text-align: center;
                        ">
                            <div style="
                                width: 64px;
                                height: 64px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 16px;
                            ">
                                <i class="fas ${colors.icon}" style="font-size: 28px; color: white;"></i>
                            </div>
                            <h3 style="color: white; margin: 0; font-size: 20px; font-weight: 600;">${title}</h3>
                        </div>
                        <div style="padding: 24px;">
                            <p style="
                                color: var(--text-secondary);
                                text-align: center;
                                margin: 0 0 24px 0;
                                font-size: 15px;
                                line-height: 1.6;
                            ">${message}</p>
                            <div style="display: flex; gap: 12px;">
                                <button id="confirm-modal-cancel" style="
                                    flex: 1;
                                    padding: 12px 20px;
                                    border: 1px solid var(--border-color);
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    font-family: Outfit, sans-serif;
                                ">${cancelText}</button>
                                <button id="confirm-modal-confirm" style="
                                    flex: 1;
                                    padding: 12px 20px;
                                    border: none;
                                    background: ${colors.bg};
                                    color: white;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    font-family: Outfit, sans-serif;
                                ">${confirmText}</button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    #confirm-modal-cancel:hover {
                        background: var(--bg-tertiary) !important;
                    }
                    #confirm-modal-confirm:hover {
                        filter: brightness(1.1);
                    }
                </style>
            `;

            // Remove any existing confirm modal
            const existingModal = document.getElementById('confirm-modal-overlay');
            if (existingModal) existingModal.remove();

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Get references
            const overlay = document.getElementById('confirm-modal-overlay');
            const cancelBtn = document.getElementById('confirm-modal-cancel');
            const confirmBtn = document.getElementById('confirm-modal-confirm');

            // Close modal function
            const closeConfirmModal = () => {
                overlay.style.animation = 'fadeIn 0.2s ease reverse';
                setTimeout(() => overlay.remove(), 150);
            };

            // Event listeners
            cancelBtn.addEventListener('click', () => {
                closeConfirmModal();
                if (onCancel) onCancel();
            });

            confirmBtn.addEventListener('click', () => {
                closeConfirmModal();
                if (onConfirm) onConfirm();
            });

            // Close on overlay click
            overlay.addEventListener('mousedown', (e) => {
                if (e.target === overlay) {
                    closeConfirmModal();
                    if (onCancel) onCancel();
                }
            });

            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeConfirmModal();
                    if (onCancel) onCancel();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        /**
         * Upload image to Firebase Storage (sin l√≠mite de tama√±o)
         * @param {string} base64String - The base64 encoded image string
         * @param {string} storagePath - Path in Firebase Storage (e.g., 'treasury/item1.jpg')
         * @returns {Promise<string>} - Download URL from Firebase Storage
         */
        async function uploadImageToFirebaseStorage(base64String, storagePath) {
            try {
                if (!firebase || !firebase.storage) {
                    throw new Error('Firebase Storage not initialized');
                }

                // Convert base64 to Blob
                const arr = base64String.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                const n = bstr.length;
                const u8arr = new Uint8Array(n);
                for (let i = 0; i < n; i++) {
                    u8arr[i] = bstr.charCodeAt(i);
                }
                const blob = new Blob([u8arr], { type: mime });

                // Upload to Firebase Storage
                const storage = firebase.storage();
                const fileRef = storage.ref(storagePath);
                const snapshot = await fileRef.put(blob);
                const downloadUrl = await snapshot.ref.getDownloadURL();

                return downloadUrl;
            } catch (error) {
                console.error('Error uploading image to Firebase Storage:', error);
                throw error;
            }
        }

        /**
         * Compress image to ensure it's under the specified max size
         * Uses canvas to resize and reduce quality
         * @param {string} base64String - The base64 encoded image string
         * @param {number} maxSizeKB - Maximum size in KB (default 700KB to be safe under Firestore 1MB limit)
         * @param {number} maxWidth - Maximum width in pixels (default 1200)
         * @param {number} maxHeight - Maximum height in pixels (default 1200)
         * @returns {Promise<string>} - Compressed base64 image string
         */
        async function compressImage(base64String, maxSizeKB = 700, maxWidth = 1200, maxHeight = 1200) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions while maintaining aspect ratio
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Start with high quality and reduce until under max size
                    let quality = 0.9;
                    let result = canvas.toDataURL('image/jpeg', quality);

                    // Iteratively reduce quality until under max size
                    while (result.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) { // 1.37 accounts for base64 overhead
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }

                    // If still too large, reduce dimensions further
                    if (result.length > maxSizeKB * 1024 * 1.37) {
                        const scaleFactor = 0.7;
                        canvas.width = Math.round(width * scaleFactor);
                        canvas.height = Math.round(height * scaleFactor);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.7);
                    }

                    console.log(`Image compressed: ${Math.round(base64String.length / 1024)}KB -> ${Math.round(result.length / 1024)}KB`);
                    resolve(result);
                };

                img.onerror = function() {
                    reject(new Error('Failed to load image for compression'));
                };

                img.src = base64String;
            });
        }

        /**
         * Generate optimized thumbnail for fast loading in grids/lists
         * @param {string} base64String - The base64 encoded image string
         * @param {number} maxSize - Maximum width/height in pixels (default 300)
         * @param {number} quality - JPEG quality 0-1 (default 0.7)
         * @returns {Promise<string>} - Thumbnail base64 image string
         */
        async function generateThumbnail(base64String, maxSize = 300, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions maintaining aspect ratio
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round(height * (maxSize / width));
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round(width * (maxSize / height));
                            height = maxSize;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    // Use better image smoothing for thumbnails
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    const result = canvas.toDataURL('image/jpeg', quality);
                    console.log(`üì∏ Thumbnail generated: ${width}x${height}, ${Math.round(result.length / 1024)}KB`);
                    resolve(result);
                };

                img.onerror = function() {
                    reject(new Error('Failed to load image for thumbnail generation'));
                };

                img.src = base64String;
            });
        }

        /**
         * Initialize Firebase and load announcements from Firestore
         */
        async function initializeFirebaseAnnouncements() {

            const initialized = await firebaseAnnouncementsManager.initialize();

            if (initialized) {
                try {
                    const firestoreAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();

                    if (firestoreAnnouncements && firestoreAnnouncements.length > 0) {
                        announcements = firestoreAnnouncements;
                    } else {
                        console.log('No announcements in Firestore, using fallback data and migrating...');
                        // Migrate fallback data to Firebase
                        for (const announcement of announcements) {
                            await firebaseAnnouncementsManager.addAnnouncement({
                                date: announcement.date,
                                title: announcement.title,
                                content: announcement.content,
                                author: announcement.author,
                                targetStores: 'all'
                            });
                        }
                        // Reload from Firestore to get IDs
                        const migratedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                        if (migratedAnnouncements && migratedAnnouncements.length > 0) {
                            announcements = migratedAnnouncements;
                        }
                        console.log('Migrated fallback announcements to Firestore');
                    }

                    // Load read announcements for current user
                    await loadReadAnnouncementsForUser();
                } catch (error) {
                    console.error('Error loading announcements from Firestore:', error);
                }
            } else {
                console.warn('Firebase not initialized, using fallback announcement data');
            }

            // Update badges after loading announcements
            updateAnnouncementsBadge();
            populateAnnouncementsDropdown();
        }

        /**
         * Load read announcements for the current user from Firebase
         */
        async function loadReadAnnouncementsForUser() {
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const userId = user?.userId || user?.id || user?.email;

            if (!userId) {
                console.warn('No user logged in, cannot load read announcements');
                return;
            }

            try {
                if (firebaseAnnouncementsManager.isInitialized) {
                    readAnnouncementIds = await firebaseAnnouncementsManager.getReadAnnouncements(userId);
                }
            } catch (error) {
                console.error('Error loading read announcements:', error);
            }
        }

        // Update announcement badge counts in sidebar and header (only unread)
        function updateAnnouncementsBadge() {
            // Count only unread announcements
            const unreadCount = announcements.filter(ann => {
                const annId = ann.firestoreId || ann.id;
                return !readAnnouncementIds.includes(annId) && !readAnnouncementIds.includes(String(annId));
            }).length;

            // Update sidebar badge
            const sidebarBadge = document.getElementById('announcements-badge');
            if (sidebarBadge) {
                sidebarBadge.textContent = unreadCount;
                sidebarBadge.style.display = unreadCount > 0 ? 'inline-flex' : 'none';
            }

            // Update header bell badge
            const headerBadge = document.getElementById('header-announcements-badge');
            if (headerBadge) {
                headerBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                headerBadge.style.display = unreadCount > 0 ? 'inline-flex' : 'none';
            }
        }

        // Populate the announcements dropdown in the header
        function populateAnnouncementsDropdown() {
            const dropdownList = document.getElementById('announcements-dropdown-list');
            if (!dropdownList) return;

            if (announcements.length === 0) {
                dropdownList.innerHTML = `
                    <div style="padding: 24px; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-bell-slash" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p style="margin: 0;">No announcements</p>
                    </div>
                `;
                return;
            }

            // Show latest 5 announcements
            const recentAnnouncements = announcements.slice(0, 5);

            dropdownList.innerHTML = recentAnnouncements.map(ann => `
                <div class="announcement-dropdown-item" style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="navigateTo('announcements'); closeAnnouncementsDropdown();">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                        <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${ann.title}</span>
                        <span style="font-size: 11px; color: var(--text-muted); white-space: nowrap; margin-left: 8px;">${formatDate(ann.date)}</span>
                    </div>
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                        ${ann.content}
                    </p>
                </div>
            `).join('');
        }

        // Toggle announcements dropdown visibility
        async function toggleAnnouncementsDropdown() {
            const dropdown = document.getElementById('announcements-dropdown');
            if (dropdown) {
                const isOpening = !dropdown.classList.contains('active');
                dropdown.classList.toggle('active');

                // Mark all announcements as read when opening the dropdown
                if (isOpening) {
                    await markAllAnnouncementsAsRead();
                }
            }
        }

        // Mark all announcements as read for the current user
        async function markAllAnnouncementsAsRead() {
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const userId = user?.userId || user?.id || user?.email;

            if (!userId) {
                console.warn('No user logged in, cannot mark announcements as read');
                return;
            }

            // Get all announcement IDs
            const allAnnouncementIds = announcements.map(ann => String(ann.firestoreId || ann.id));

            // Filter out already read ones
            const newlyReadIds = allAnnouncementIds.filter(id =>
                !readAnnouncementIds.includes(id) && !readAnnouncementIds.includes(String(id))
            );

            if (newlyReadIds.length === 0) {
                return; // Nothing new to mark as read
            }

            try {
                if (firebaseAnnouncementsManager.isInitialized) {
                    await firebaseAnnouncementsManager.markAnnouncementsAsRead(userId, newlyReadIds);
                }

                // Update local state
                readAnnouncementIds = [...new Set([...readAnnouncementIds, ...newlyReadIds])];

                // Update badge to reflect read status
                updateAnnouncementsBadge();
            } catch (error) {
                console.error('Error marking announcements as read:', error);
            }
        }

        // Close announcements dropdown
        function closeAnnouncementsDropdown() {
            const dropdown = document.getElementById('announcements-dropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('announcements-dropdown');
            const btn = document.querySelector('.header-notification-btn');
            if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Mobile touch support for announcements button
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBtn = document.querySelector('.header-notification-btn');
            if (notificationBtn) {
                // Add touchend event for mobile
                notificationBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleAnnouncementsDropdown();
                }, { passive: false });
            }

            // Close dropdown on touch outside (mobile)
            document.addEventListener('touchend', function(event) {
                const dropdown = document.getElementById('announcements-dropdown');
                const btn = document.querySelector('.header-notification-btn');
                if (dropdown && dropdown.classList.contains('active')) {
                    if (!dropdown.contains(event.target) && !btn.contains(event.target)) {
                        dropdown.classList.remove('active');
                    }
                }
            });
        });

        async function initializeFirebaseRestockRequests() {

            const initialized = await firebaseRestockRequestsManager.initialize();

            if (initialized) {
                try {
                    const firestoreRequests = await firebaseRestockRequestsManager.loadRestockRequests();

                    if (firestoreRequests && firestoreRequests.length > 0) {
                        restockRequests = firestoreRequests;
                    } else {
                        console.log('No restock requests in Firestore, using fallback data and migrating...');
                        // Migrate fallback data to Firebase
                        for (const request of restockRequests) {
                            await firebaseRestockRequestsManager.addRestockRequest({
                                productName: request.productName,
                                quantity: request.quantity,
                                store: request.store,
                                requestedBy: request.requestedBy,
                                requestDate: request.requestDate,
                                status: request.status,
                                priority: request.priority,
                                notes: request.notes
                            });
                        }
                        // Reload from Firestore to get IDs
                        const migratedRequests = await firebaseRestockRequestsManager.loadRestockRequests();
                        if (migratedRequests && migratedRequests.length > 0) {
                            restockRequests = migratedRequests;
                        }
                        console.log('Migrated fallback restock requests to Firestore');
                    }
                } catch (error) {
                    console.error('Error loading restock requests from Firestore:', error);
                }
            } else {
                console.warn('Firebase not initialized, using fallback restock requests data');
            }
        }

        async function initializeFirebaseChangeRecords() {

            const initialized = await firebaseChangeRecordsManager.initialize();

            if (initialized) {
                try {
                    const firestoreRecords = await firebaseChangeRecordsManager.loadChangeRecords();

                    if (firestoreRecords && firestoreRecords.length > 0) {
                        changeRecords = firestoreRecords;
                    } else {
                        console.log('No change records in Firestore, using fallback data and migrating...');
                        // Migrate fallback data to Firebase
                        for (const record of changeRecords) {
                            await firebaseChangeRecordsManager.addChangeRecord({
                                store: record.store,
                                amount: record.amount,
                                date: record.date,
                                leftBy: record.leftBy,
                                receivedBy: record.receivedBy,
                                notes: record.notes,
                                photo: record.photo || null
                            });
                        }
                        // Reload from Firestore to get IDs
                        const migratedRecords = await firebaseChangeRecordsManager.loadChangeRecords();
                        if (migratedRecords && migratedRecords.length > 0) {
                            changeRecords = migratedRecords;
                        }
                        console.log('Migrated fallback change records to Firestore');
                    }
                } catch (error) {
                    console.error('Error loading change records from Firestore:', error);
                }
            } else {
                console.warn('Firebase not initialized, using fallback change records data');
            }
        }

        async function initializeFirebaseCashOut() {

            const initialized = await firebaseCashOutManager.initialize();

            if (initialized) {
                try {
                    const firestoreRecords = await firebaseCashOutManager.loadCashOutRecords();

                    if (firestoreRecords && firestoreRecords.length > 0) {
                        cashOutRecords = firestoreRecords;
                    } else {
                        console.log('No cash out records in Firestore, using fallback data and migrating...');
                        // Migrate fallback data to Firebase
                        for (const record of cashOutRecords) {
                            await firebaseCashOutManager.addCashOutRecord({
                                name: record.name,
                                amount: record.amount,
                                reason: record.reason,
                                createdDate: record.createdDate,
                                createdBy: record.createdBy,
                                store: record.store || '',
                                status: record.status || 'open',
                                closedDate: record.closedDate || null,
                                receiptPhoto: record.receiptPhoto || null,
                                amountSpent: record.amountSpent || null,
                                moneyLeft: record.moneyLeft || null,
                                hasMoneyLeft: record.hasMoneyLeft || null
                            });
                        }
                        // Reload from Firestore to get IDs
                        const migratedRecords = await firebaseCashOutManager.loadCashOutRecords();
                        if (migratedRecords && migratedRecords.length > 0) {
                            cashOutRecords = migratedRecords;
                        }
                        console.log('Migrated fallback cash out records to Firestore');
                    }
                } catch (error) {
                    console.error('Error loading cash out records from Firestore:', error);
                }
            } else {
                console.warn('Firebase not initialized, using fallback cash out records data');
            }
        }

        let products = [
            { id: 1, name: 'JUUL Starter Kit', category: 'Vape Devices', quantity: 24, arrivalDate: '2025-12-10', store: 'Miramar', status: 'pending', supplier: 'JUUL Labs', price: 34.99, image: 'https://images.unsplash.com/photo-1560913210-fd4c0e4c3f75?w=400&h=300&fit=crop' },
            { id: 3, name: 'Elf Bar BC5000 - Mixed Flavors', category: 'Disposables', quantity: 120, arrivalDate: '2025-12-15', store: 'Kearny Mesa', status: 'pending', supplier: 'Elf Bar', price: 15.99, image: 'https://images.unsplash.com/photo-1530281700549-e82e7bf110d6?w=400&h=300&fit=crop' },
            { id: 4, name: 'Marlboro Red Box', category: 'Cigarettes', quantity: 200, arrivalDate: '2025-12-12', store: 'Chula Vista', status: 'pending', supplier: 'Philip Morris', price: 8.99, image: 'https://images.unsplash.com/photo-1571941736487-969c8e1d8e9f?w=400&h=300&fit=crop' },
            { id: 5, name: 'Puff Bar Plus', category: 'Disposables', quantity: 80, arrivalDate: '2025-12-07', store: 'Miramar', status: 'arrived', supplier: 'Puff Bar', price: 13.99, image: 'https://images.unsplash.com/photo-1606235727737-4c2b7a0ecab7?w=400&h=300&fit=crop' },
            { id: 6, name: 'SMOK Nord 4 Kit', category: 'Vape Devices', quantity: 15, arrivalDate: '2025-12-20', store: 'Morena', status: 'pending', supplier: 'SMOK', price: 42.99, image: 'https://images.unsplash.com/photo-1559813114-caa66ac94942?w=400&h=300&fit=crop' }
        ];

        let inventory = [
            { id: 1, brand: 'JUUL', productName: 'JUUL Starter Kit', flavor: 'Virginia Tobacco', volume: '0.7ml', nicotine: '5%', unitPrice: 34.99, minStock: 10, stock: 5, store: 'Miramar' },
            { id: 3, brand: 'Elf Bar', productName: 'BC5000', flavor: 'Blue Razz Ice', volume: '13ml', nicotine: '50mg', unitPrice: 15.99, minStock: 50, stock: 45, store: 'Kearny Mesa' },
            { id: 4, brand: 'Marlboro', productName: 'Red Box', flavor: 'Original', volume: 'N/A', nicotine: 'Full', unitPrice: 8.99, minStock: 100, stock: 80, store: 'Chula Vista' },
            { id: 5, brand: 'Puff Bar', productName: 'Puff Plus', flavor: 'Mango', volume: '3.2ml', nicotine: '50mg', unitPrice: 13.99, minStock: 30, stock: 12, store: 'Miramar' },
            { id: 6, brand: 'SMOK', productName: 'Nord 4 Kit', flavor: 'N/A', volume: 'N/A', nicotine: 'N/A', unitPrice: 42.99, minStock: 15, stock: 8, store: 'Morena' },
            { id: 7, brand: 'Newport', productName: 'Menthol', flavor: 'Menthol', volume: 'N/A', nicotine: 'Full', unitPrice: 9.49, minStock: 100, stock: 120, store: 'Miramar' },
            { id: 8, brand: 'Hyde', productName: 'Edge Rave', flavor: 'Strawberry Kiwi', volume: '10ml', nicotine: '50mg', unitPrice: 14.99, minStock: 40, stock: 25, store: 'Kearny Mesa' },
            { id: 9, brand: 'RELX', productName: 'Infinity', flavor: 'Classic Tobacco', volume: '1.9ml', nicotine: '3%', unitPrice: 39.99, minStock: 12, stock: 3, store: 'Chula Vista' },
            { id: 10, brand: 'Camel', productName: 'Blue', flavor: 'Light', volume: 'N/A', nicotine: 'Light', unitPrice: 8.49, minStock: 80, stock: 95, store: 'Morena' },
            { id: 11, brand: 'Lost Mary', productName: 'OS5000', flavor: 'Watermelon Ice', volume: '13ml', nicotine: '50mg', unitPrice: 16.99, minStock: 35, stock: 42, store: 'Miramar' },
            { id: 12, brand: 'Geek Bar', productName: 'Pulse', flavor: 'Fcuking Fab', volume: '16ml', nicotine: '50mg', unitPrice: 18.99, minStock: 25, stock: 18, store: 'Kearny Mesa' },
            { id: 13, brand: 'JUUL', productName: 'JUUL Starter Kit', flavor: 'Virginia Tobacco', volume: '0.7ml', nicotine: '5%', unitPrice: 34.99, minStock: 10, stock: 8, store: 'Morena' },
            { id: 14, brand: 'Elf Bar', productName: 'BC5000', flavor: 'Blue Razz Ice', volume: '13ml', nicotine: '50mg', unitPrice: 15.99, minStock: 50, stock: 52, store: 'Miramar' },
            { id: 15, brand: 'Marlboro', productName: 'Red Box', flavor: 'Original', volume: 'N/A', nicotine: 'Full', unitPrice: 8.99, minStock: 100, stock: 105, store: 'Miramar' },
            { id: 16, brand: 'VUSE', productName: 'Alto Pods', flavor: 'Menthol', volume: '1.8ml', nicotine: '5%', unitPrice: 12.99, minStock: 20, stock: 22, store: 'Chula Vista' }
        ];

        let restockRequests = [
            { id: 1, productName: 'JUUL Starter Kit', quantity: 20, store: 'Miramar', requestedBy: 'Marcus Rodriguez', requestDate: '2025-12-03', status: 'pending', priority: 'high', notes: 'Running low, high demand' },
            { id: 2, productName: 'Puff Bar Plus', quantity: 30, store: 'Morena', requestedBy: 'Sarah Kim', requestDate: '2025-12-02', status: 'approved', priority: 'medium', notes: 'Restock for weekend rush' },
            { id: 3, productName: 'RELX Infinity', quantity: 15, store: 'Kearny Mesa', requestedBy: 'James Thompson', requestDate: '2025-12-01', status: 'pending', priority: 'high', notes: 'Stock critically low' }
        ];

        // Treasury - Select Pieces Collection
        let treasuryItems = [
            {
                id: 1,
                artworkName: 'Vintage Tobacco Advertisement',
                artist: 'Unknown',
                acquisitionDate: '2024-03-15',
                value: 2500.00,
                location: 'VSU Kearny Mesa',
                photos: [],
                description: 'Original 1940s tobacco advertisement poster in excellent condition'
            },
            {
                id: 2,
                artworkName: 'Neon Sign Collection',
                artist: 'Custom Neon Works',
                acquisitionDate: '2023-11-20',
                value: 4800.00,
                location: 'VSU Miramar',
                photos: [],
                description: 'Set of three vintage neon signs from the 1960s'
            }
        ];

        // Cash Out Records
        let currentCashOutStoreFilter = 'all';
        let cashOutViewState = {
            viewType: 'month',
            expenseAnalysisExpanded: false,
            displayMode: 'list' // 'list' or 'grid'
        };
        let cashOutCharts = {};
        let cashOutRecords = [
            {
                id: 1,
                name: 'Office Supplies',
                amount: 150.00,
                reason: 'Printer paper and ink cartridges',
                createdDate: '2025-12-08',
                createdBy: 'VSU Admin',
                status: 'open',
                closedDate: null,
                receiptPhoto: null,
                amountSpent: null,
                moneyLeft: null,
                hasMoneyLeft: null
            },
            {
                id: 2,
                name: 'Store Maintenance',
                amount: 300.00,
                reason: 'Cleaning supplies and minor repairs',
                createdDate: '2025-12-05',
                createdBy: 'Marcus Rodriguez',
                status: 'closed',
                closedDate: '2025-12-06',
                receiptPhoto: null,
                amountSpent: 285.50,
                moneyLeft: 14.50,
                hasMoneyLeft: true
            },
            {
                id: 3,
                name: 'Team Lunch',
                amount: 200.00,
                reason: 'Employee appreciation lunch',
                createdDate: '2025-12-03',
                createdBy: 'Sarah Kim',
                status: 'closed',
                closedDate: '2025-12-03',
                receiptPhoto: null,
                amountSpent: 200.00,
                moneyLeft: 0.00,
                hasMoneyLeft: false
            }
        ];

        // Issues Database
        let issues = [
            {
                id: 1,
                customer: 'John Smith',
                phone: '5551234567',
                type: 'In Store',
                description: 'Customer received wrong product in their order',
                incidentDate: '2025-12-08',
                perception: 2,
                status: 'open',
                createdBy: 'Marcus Rodriguez',
                createdDate: '2025-12-08',
                solution: null,
                resolvedBy: null,
                resolutionDate: null
            },
            {
                id: 2,
                customer: 'Maria Garcia',
                phone: '5559876543',
                type: 'Online',
                description: 'Payment was charged twice for the same order',
                incidentDate: '2025-12-07',
                perception: 1,
                status: 'in_progress',
                createdBy: 'Sarah Kim',
                createdDate: '2025-12-07',
                solution: null,
                resolvedBy: null,
                resolutionDate: null
            },
            {
                id: 3,
                customer: 'Robert Johnson',
                phone: '5555551234',
                type: 'In Store',
                description: 'Product defective - vape device not working',
                incidentDate: '2025-12-05',
                perception: 4,
                status: 'resolved',
                createdBy: 'James Thompson',
                createdDate: '2025-12-05',
                solution: 'Replaced device with new unit and tested before customer left',
                resolvedBy: 'James Thompson',
                resolutionDate: '2025-12-05'
            }
        ];

        // Vendors Database
        let vendors = [
            {
                id: 1,
                name: 'VaporHub Distributors',
                category: 'Vape Products',
                contact: 'John Martinez',
                phone: '(800) 555-0101',
                email: 'sales@vaporhub.com',
                website: 'https://www.vaporhub.com',
                access: 'Online Portal - Account #VH12345',
                products: 'Disposable vapes, Pod systems, E-liquids, Accessories',
                orderMethods: 'Online portal, Phone orders, Email orders',
                notes: 'Net 30 payment terms, Free shipping over $500'
            },
            {
                id: 2,
                name: 'Premium Tobacco Supply',
                category: 'Tobacco Products',
                contact: 'Sarah Johnson',
                phone: '(800) 555-0202',
                email: 'orders@premiumtobacco.com',
                website: 'https://www.premiumtobacco.com',
                access: 'Account Manager: Sarah - Direct line (800) 555-0203',
                products: 'Cigarettes, Cigars, Rolling papers, Lighters',
                orderMethods: 'Phone orders (preferred), Email',
                notes: 'Minimum order $1000, Weekly deliveries on Thursdays'
            },
            {
                id: 3,
                name: 'Beverage Wholesale Direct',
                category: 'Beverages',
                contact: 'Mike Chen',
                phone: '(800) 555-0303',
                email: 'info@beveragewholesale.com',
                website: 'https://www.beveragewholesale.com',
                access: 'Online ordering system - Username: VSU_Admin',
                products: 'Energy drinks, Sodas, Water, Sports drinks, Coffee',
                orderMethods: 'Online portal (24/7), Phone (business hours)',
                notes: 'Next day delivery available, Volume discounts'
            },
            {
                id: 4,
                name: 'Snack Solutions Inc',
                category: 'Snacks & Candy',
                contact: 'Lisa Rodriguez',
                phone: '(800) 555-0404',
                email: 'sales@snacksolutions.com',
                website: 'https://www.snacksolutions.com',
                access: 'Rep visits monthly, Online catalog access',
                products: 'Chips, Candy bars, Gum, Cookies, Nuts',
                orderMethods: 'Mobile app, Website, Sales rep',
                notes: 'Flexible payment terms, Returns accepted'
            },
            {
                id: 5,
                name: 'General Supplies Co',
                category: 'Store Supplies',
                contact: 'David Park',
                phone: '(800) 555-0505',
                email: 'support@generalsupplies.com',
                website: 'https://www.generalsupplies.com',
                access: 'Amazon Business account linked',
                products: 'Bags, Receipt paper, Cleaning supplies, Office supplies',
                orderMethods: 'Amazon Business, Direct website, Phone',
                notes: 'Prime shipping available, Bulk discounts'
            }
        ];

        // Change Records - Cambio dejado en Campos
        let changeRecords = [
            {
                id: 1,
                store: 'Miramar',
                amount: 500.00,
                date: '2025-12-10',
                leftBy: 'Marcus Rodriguez',
                receivedBy: 'Sarah Kim',
                notes: 'Se dej√≥ en caja 1',
                photo: null
            },
            {
                id: 2,
                store: 'Morena',
                amount: 300.00,
                date: '2025-12-09',
                leftBy: 'James Thompson',
                receivedBy: 'Amanda Lopez',
                notes: 'Se meti√≥ extra por falta de cambio',
                photo: null
            },
            {
                id: 3,
                store: 'Kearny Mesa',
                amount: 400.00,
                date: '2025-12-08',
                leftBy: 'David Nguyen',
                receivedBy: 'Marcus Rodriguez',
                notes: '',
                photo: null
            }
        ];

        // Gifts Records - Control de Regalos en Especie
        let giftsCurrentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
        let giftsRecords = [
            {
                id: 1,
                product: 'Vape Pen SMOK Nord 4',
                quantity: 1,
                value: 45.99,
                recipient: 'Juan P√©rez',
                recipientType: 'customer',
                reason: 'Producto defectuoso - reemplazo por garant√≠a',
                store: 'Miramar',
                date: '2025-12-10',
                notes: 'Cliente habitual, su vape dej√≥ de funcionar despu√©s de 2 semanas',
                photo: null
            },
            {
                id: 2,
                product: 'E-Liquid 60ml Naked 100',
                quantity: 2,
                value: 39.98,
                recipient: 'Mar√≠a Garc√≠a',
                recipientType: 'customer',
                reason: 'Compensaci√≥n por error en pedido',
                store: 'Morena',
                date: '2025-12-09',
                notes: 'Se le envi√≥ sabor equivocado, se le regal√≥ el correcto + el err√≥neo',
                photo: null
            },
            {
                id: 3,
                product: 'Coils para Caliburn',
                quantity: 5,
                value: 24.95,
                recipient: 'Carlos L√≥pez',
                recipientType: 'vendor',
                reason: 'Regalo a proveedor por colaboraci√≥n',
                store: 'Kearny Mesa',
                date: '2025-12-08',
                notes: 'Proveedor nos ayud√≥ con entrega urgente',
                photo: null
            }
        ];

        /**
         * Initialize Firebase and load employees from Firestore
         * This function is called when the page loads
         */
        async function initializeFirebaseEmployees() {
            
            // Initialize Firebase manager
            const initialized = await firebaseEmployeeManager.initialize();
            
            if (initialized) {
                try {
                    // Load employees from Firestore
                    const firestoreEmployees = await firebaseEmployeeManager.loadEmployees();
                    
                    if (firestoreEmployees && firestoreEmployees.length > 0) {                        
                        // Map Firestore data to the local employees array
                        // This maintains compatibility with existing code while loading from Firebase
                        employees = firestoreEmployees.map(emp => ({
                            id: emp.firestoreId || emp.id,
                            firestoreId: emp.firestoreId || emp.id,
                            name: emp.name || '',
                            authEmail: emp.authEmail || '',
                            phone: emp.phone || '',
                            store: emp.store || 'Miramar',
                            status: emp.status || 'active',
                            role: emp.role || window.EMPLOYEE_ROLES?.EMPLOYEE || 'employee', // Role from Firestore
                            employeeType: emp.employeeType || 'regular', // admin, manager, employee
                            hireDate: emp.hireDate || new Date().toISOString().split('T')[0],
                            emergencyContact: emp.emergencyContact || '',
                            allergies: emp.allergies || 'None',
                            initials: (emp.name || 'X').split(' ').map(n => n[0]).join(''),
                            color: emp.color || ['a', 'b', 'c', 'd', 'e'][Math.floor(Math.random() * 5)]
                        }));
                        
                        // Update employee count badge in sidebar
                        if (typeof updateEmployeeCountBadge === 'function') {
                            updateEmployeeCountBadge();
                        }
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading employees from Firestore:', error);
                }
            } else {
                console.warn('Firebase not available. Using fallback data.');
            }

            return false;
        }

        /**
         * Save employee to Firebase
         */
        async function saveEmployeeToFirebase(employeeData) {
            if (!firebaseEmployeeManager.isInitialized) {
                console.warn('Firebase not initialized');
                return null;
            }

            try {
                if (employeeData.firestoreId) {
                    // Update existing
                    const success = await firebaseEmployeeManager.updateEmployee(
                        employeeData.firestoreId,
                        employeeData
                    );
                    return success ? employeeData.firestoreId : null;
                } else {
                    // Create new
                    const newId = await firebaseEmployeeManager.addEmployee(employeeData);
                    return newId;
                }
            } catch (error) {
                console.error('Error saving employee to Firebase:', error);
                return null;
            }
        }

        /**
         * Delete employee from Firebase
         */
        async function deleteEmployeeFromFirebase(firestoreId) {
            if (!firebaseEmployeeManager.isInitialized) {
                console.warn('Firebase not initialized');
                return false;
            }

            try {
                return await firebaseEmployeeManager.deleteEmployee(firestoreId);
            } catch (error) {
                console.error('Error deleting employee from Firebase:', error);
                return false;
            }
        }

        /**
         * Update employee role in Firebase
         */
        async function updateEmployeeRoleInFirebase(firestoreId, newRole) {
            if (!firebaseEmployeeManager.isInitialized) {
                console.warn('Firebase not initialized');
                return false;
            }

            try {
                return await firebaseEmployeeManager.updateEmployeeRole(firestoreId, newRole);
            } catch (error) {
                console.error('Error updating employee role in Firebase:', error);
                return false;
            }
        }

        // Navigation handler
        function navigateTo(page, addToHistory = true) {
            // Check if user has permission to access this page
            const user = getCurrentUser();
            const userRole = user.role || 'employee';
            const userPermissions = window.ROLE_PERMISSIONS[userRole] || window.ROLE_PERMISSIONS['employee'];
            const allowedPages = userPermissions.pages || [];

            // If page not in allowed list, silently deny access and return to current page
            if (!allowedPages.includes(page)) {
                console.warn(`‚ö†Ô∏è Access denied: ${userPermissions.label} role cannot access ${page}`);
                return;
            }

            currentPage = page;

            // Save current page to sessionStorage (persists on refresh, clears on tab close)
            sessionStorage.setItem('ascendance_current_page', page);

            // Update browser history for back/forward navigation
            if (addToHistory) {
                const url = new URL(window.location);
                url.searchParams.set('page', page);
                history.pushState({ page: page }, '', url);
            }
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });

            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                employees: 'Employees',
                training: 'Training Center',
                licenses: 'Licenses & Documents',
                analytics: 'Sales Analytics',
                stores: 'Store Management',
                announcements: 'Announcements',
                tasks: 'Tasks & Checklists',
                schedule: 'Schedule',
                settings: 'Settings',
                help: 'Help Center',
                thieves: 'Thief Database',
                invoices: 'Invoices',
                issues: 'Issues Registry',
                vendors: 'Vendors & Suppliers',
                clockin: 'Clock In/Out',
                dailysales: 'Daily Sales',
                cashout: 'Cash Control',
                treasury: 'Heady Pieces',
                gconomics: 'Gconomics',
                gforce: 'G Force',
                abundancecloud: 'Abundance Cloud Engine',
                newstuff: 'New Stuff',
                change: 'Change',
                customercare: 'Customer Care',
                risknotes: 'Risk Notes',
                passwords: 'Password Manager',
                projectanalytics: 'Project Analytics',
                restock: 'Product Requests',
                supplies: 'Supplies',
                dailychecklist: 'Daily Checklist',
                labels: 'Barcode Labels',
                celesteai: 'Celeste AI'
            };
            document.querySelector('.page-title').textContent = titles[page] || 'Dashboard';

            // Render page content
            renderPage(page);
        }

        // Expose navigateTo globally
        window.navigateTo = navigateTo;

        // Toggle nav category (collapsible menu sections)
        window.toggleNavCategory = function(categoryName) {
            const category = document.querySelector(`.nav-category[data-category="${categoryName}"]`);
            if (category) {
                category.classList.toggle('open');
                // Save state to localStorage
                const defaultOpen = '["team","inventory","finance","operations","security","system"]';
                const stored = localStorage.getItem('openNavCategories');
                const openCategories = (stored && stored !== '[]') ? JSON.parse(stored) : JSON.parse(defaultOpen);
                if (category.classList.contains('open')) {
                    if (!openCategories.includes(categoryName)) {
                        openCategories.push(categoryName);
                    }
                } else {
                    const index = openCategories.indexOf(categoryName);
                    if (index > -1) {
                        openCategories.splice(index, 1);
                    }
                }
                localStorage.setItem('openNavCategories', JSON.stringify(openCategories));
            }
        };

        // Restore nav category states from localStorage
        function restoreNavCategoryStates() {
            // Clear old localStorage value to fix initial state
            const stored = localStorage.getItem('openNavCategories');
            if (stored === '["team"]' || stored === '[]') {
                localStorage.removeItem('openNavCategories');
            }

            // All categories open by default - only close if user explicitly closed them
            const allCategories = ['team', 'inventory', 'finance', 'operations', 'security', 'system'];
            const openCategories = localStorage.getItem('openNavCategories')
                ? JSON.parse(localStorage.getItem('openNavCategories'))
                : allCategories;

            document.querySelectorAll('.nav-category').forEach(cat => {
                const categoryName = cat.dataset.category;
                if (openCategories.includes(categoryName)) {
                    cat.classList.add('open');
                } else {
                    cat.classList.remove('open');
                }
            });
        }

        // Call on load
        setTimeout(restoreNavCategoryStates, 50);

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.page) {
                // Navigate to the page from history without adding a new history entry
                navigateTo(event.state.page, false);
            } else {
                // Fallback: check URL for page parameter
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page') || 'dashboard';
                navigateTo(page, false);
            }
        });

        async function renderPage(page) {
            const dashboard = document.querySelector('.dashboard');

            // Stop clock in polling when navigating away from clockin page
            if (page !== 'clockin' && typeof stopClockInPolling === 'function') {
                stopClockInPolling();
            }

            // Cancel pending analytics requests when navigating away from analytics page
            if (page !== 'analytics' && typeof cancelAnalyticsRequest === 'function') {
                cancelAnalyticsRequest();
            }

            switch(page) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'employees':
                    renderEmployees();
                    break;
                case 'training':
                    renderTraining();
                    break;
                case 'licenses':
                    renderLicenses();
                    break;
                case 'analytics':
                    if (typeof renderAnalyticsPage === 'function') { renderAnalyticsPage(); } else if (typeof renderAnalyticsWithData === 'function') { renderAnalyticsWithData(); } else { renderAnalytics(); }
                    break;
                case 'newstuff':
                    renderNewStuff();
                    break;
                case 'restock':
                    renderRestockRequests();
                    break;
                case 'supplies':
                    renderSupplies();
                    break;
                case 'dailychecklist':
                    renderDailyChecklist();
                    break;
                case 'abundancecloud':
                    renderAbundanceCloud();
                    break;
                case 'stores':
                    renderStores();
                    break;
                case 'announcements':
                    renderAnnouncements();
                    break;
                case 'schedule':
                    renderSchedule();
                    break;
                case 'thieves':
                    renderThieves();
                    break;
                case 'invoices':
                    renderInvoices();
                    break;
                case 'issues':
                    await renderIssues();
                    break;
                case 'gconomics':
                    renderGconomics();
                    break;
                case 'vendors':
                    renderVendors();
                    break;
                case 'clockin':
                    renderClockIn();
                    break;
                case 'dailysales':
                    renderDailySales();
                    break;
                case 'cashout':
                    renderCashOut();
                    break;
                case 'treasury':
                    renderTreasury();
                    break;
                case 'change':
                    renderChange();
                    break;
                case 'customercare':
                    renderGifts();
                    break;
                case 'gforce':
                    renderGForce();
                    break;
                case 'risknotes':
                    renderRiskNotes();
                    break;
                case 'passwords':
                    await window.renderPasswordManager();
                    break;
                case 'projectanalytics':
                    window.renderProjectAnalytics();
                    break;
                case 'labels':
                    renderLabels();
                    break;
                case 'celesteai':
                    renderCelesteAIPage();
                    break;
                case 'transfers':
                    if (typeof initializeTransfersModule === 'function') {
                        initializeTransfersModule();
                    } else {
                        console.error('Transfers module not loaded');
                        render404(page);
                    }
                    break;
                case 'hrapplications':
                    if (typeof initializeHRApplications === 'function') {
                        initializeHRApplications();
                    } else {
                        console.error('HR Applications module not loaded');
                        render404(page);
                    }
                    break;
                case 'leases':
                    renderLeases();
                    break;
                case 'glabs':
                    renderGLabs();
                    break;
                default:
                    render404(page);
            }

            refreshFloatingAddButtons();
        }

        // Render 404 Page - Beautiful cosmic theme
        function render404(attemptedPage = '') {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <style>
                    .page-404 {
                        min-height: 70vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        position: relative;
                        overflow: hidden;
                    }

                    .page-404-bg {
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: radial-gradient(ellipse at center, rgba(102,126,234,0.1) 0%, transparent 70%);
                        pointer-events: none;
                    }

                    .page-404-stars {
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        overflow: hidden;
                        pointer-events: none;
                    }

                    .page-404-star {
                        position: absolute;
                        background: var(--accent-primary);
                        border-radius: 50%;
                        animation: twinkle404 var(--duration) ease-in-out infinite;
                    }

                    @keyframes twinkle404 {
                        0%, 100% { opacity: 0.2; transform: scale(1); }
                        50% { opacity: 0.8; transform: scale(1.3); }
                    }

                    .page-404-content {
                        position: relative;
                        z-index: 10;
                        text-align: center;
                        padding: 40px;
                        max-width: 500px;
                    }

                    .page-404-astronaut {
                        font-size: 80px;
                        margin-bottom: 24px;
                        animation: float404 4s ease-in-out infinite;
                        color: var(--accent-primary);
                        text-shadow: 0 0 40px rgba(168, 85, 247, 0.4);
                    }

                    @keyframes float404 {
                        0%, 100% { transform: translateY(0) rotate(-5deg); }
                        50% { transform: translateY(-15px) rotate(5deg); }
                    }

                    .page-404-code {
                        font-size: 120px;
                        font-weight: 800;
                        line-height: 1;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a855f7 100%);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        margin-bottom: 16px;
                        animation: glow404 3s ease-in-out infinite;
                    }

                    @keyframes glow404 {
                        0%, 100% { filter: drop-shadow(0 0 10px rgba(168, 85, 247, 0.3)); }
                        50% { filter: drop-shadow(0 0 25px rgba(168, 85, 247, 0.5)); }
                    }

                    .page-404-title {
                        font-size: 28px;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 12px;
                    }

                    .page-404-subtitle {
                        font-size: 16px;
                        color: var(--text-muted);
                        margin-bottom: 8px;
                    }

                    .page-404-quote {
                        font-size: 18px;
                        font-weight: 600;
                        font-style: italic;
                        background: linear-gradient(135deg, #667eea, #a855f7);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        margin: 24px 0 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 12px;
                    }

                    .page-404-quote i {
                        -webkit-text-fill-color: #a855f7;
                        font-size: 14px;
                    }

                    .page-404-buttons {
                        display: flex;
                        gap: 16px;
                        justify-content: center;
                        flex-wrap: wrap;
                    }

                    .page-404-btn {
                        display: inline-flex;
                        align-items: center;
                        gap: 10px;
                        padding: 14px 28px;
                        border-radius: 14px;
                        font-size: 15px;
                        font-weight: 600;
                        text-decoration: none;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        border: none;
                    }

                    .page-404-btn-primary {
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        box-shadow: 0 6px 24px rgba(102, 126, 234, 0.4);
                    }

                    .page-404-btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 10px 32px rgba(102, 126, 234, 0.5);
                    }

                    .page-404-btn-secondary {
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border: 1px solid var(--border-color);
                    }

                    .page-404-btn-secondary:hover {
                        border-color: var(--accent-primary);
                        background: rgba(168, 85, 247, 0.1);
                        transform: translateY(-2px);
                    }

                    .page-404-attempted {
                        margin-top: 24px;
                        font-size: 12px;
                        color: var(--text-muted);
                        opacity: 0.6;
                    }

                    .page-404-attempted code {
                        background: var(--bg-secondary);
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-family: monospace;
                    }

                    .page-404-orbit {
                        position: absolute;
                        width: 350px;
                        height: 350px;
                        border: 1px solid rgba(168, 85, 247, 0.15);
                        border-radius: 50%;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        animation: orbit404 25s linear infinite;
                        pointer-events: none;
                    }

                    .page-404-orbit::before {
                        content: '';
                        position: absolute;
                        width: 10px;
                        height: 10px;
                        background: linear-gradient(135deg, #667eea, #a855f7);
                        border-radius: 50%;
                        top: 0;
                        left: 50%;
                        transform: translateX(-50%);
                        box-shadow: 0 0 15px rgba(168, 85, 247, 0.6);
                    }

                    @keyframes orbit404 {
                        from { transform: translate(-50%, -50%) rotate(0deg); }
                        to { transform: translate(-50%, -50%) rotate(360deg); }
                    }
                </style>

                <div class="page-404">
                    <div class="page-404-bg"></div>
                    <div class="page-404-stars" id="stars-404"></div>
                    <div class="page-404-orbit"></div>

                    <div class="page-404-content">
                        <div class="page-404-astronaut">
                            <i class="fas fa-user-astronaut"></i>
                        </div>

                        <div class="page-404-code">404</div>

                        <h1 class="page-404-title">Lost in Space</h1>
                        <p class="page-404-subtitle">This page has drifted into another dimension</p>

                        <p class="page-404-quote">
                            <i class="fas fa-star"></i>
                            "Exploring the unknown, never truly lost"
                            <i class="fas fa-star"></i>
                        </p>

                        <div class="page-404-buttons">
                            <button class="page-404-btn page-404-btn-primary" onclick="if(typeof toggleCelesteChat === 'function') toggleCelesteChat(); else navigateTo('dashboard');">
                                <i class="fas fa-stars"></i>
                                Ask Celeste AI
                            </button>
                            <button class="page-404-btn page-404-btn-secondary" onclick="navigateTo('dashboard')">
                                <i class="fas fa-rocket"></i>
                                Return to Base
                            </button>
                        </div>

                        ${attemptedPage ? `<p class="page-404-attempted">Attempted route: <code>${attemptedPage}</code></p>` : ''}
                    </div>
                </div>
            `;

            // Generate stars
            setTimeout(() => {
                const starsContainer = document.getElementById('stars-404');
                if (starsContainer) {
                    for (let i = 0; i < 50; i++) {
                        const star = document.createElement('div');
                        star.className = 'page-404-star';
                        star.style.left = Math.random() * 100 + '%';
                        star.style.top = Math.random() * 100 + '%';
                        star.style.width = Math.random() * 3 + 1 + 'px';
                        star.style.height = star.style.width;
                        star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                        star.style.animationDelay = Math.random() * 3 + 's';
                        starsContainer.appendChild(star);
                    }
                }
            }, 100);
        }

        function renderDashboard() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card" style="cursor: pointer;" onclick="navigateTo('employees')">
                        <div class="stat-header">
                            <div class="stat-icon purple"><i class="fas fa-users"></i></div>
                            <div class="stat-trend up"><i class="fas fa-arrow-up"></i> +2</div>
                        </div>
                        <div class="stat-value">${employees.length}</div>
                        <div class="stat-label">Total Employees</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="navigateTo('analytics')" id="monthly-revenue-card">
                        <div class="stat-header">
                            <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
                            <div class="stat-trend up" id="revenue-trend"><i class="fas fa-sync fa-spin"></i> Loading...</div>
                        </div>
                        <div class="stat-value" id="revenue-value">--</div>
                        <div class="stat-label">Monthly Revenue</div>
                    </div>

                    <div class="stat-card" style="cursor: pointer;" onclick="navigateTo('licenses')">
                        <div class="stat-header">
                            <div class="stat-icon blue"><i class="fas fa-file-alt"></i></div>
                            <div class="stat-trend down"><i class="fas fa-exclamation"></i> 2 expiring</div>
                        </div>
                        <div class="stat-value">${licenses.length}</div>
                        <div class="stat-label">Active Licenses</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <a href="#" class="quick-action" onclick="navigateTo('employees'); setTimeout(() => openModal('add-employee'), 100); return false;">
                        <div class="quick-action-icon"><i class="fas fa-user-plus"></i></div>
                        <span class="quick-action-label">Add Employee</span>
                    </a>
                    <a href="#" class="quick-action" onclick="navigateTo('training'); setTimeout(() => openModal('add-training'), 100); return false;">
                        <div class="quick-action-icon"><i class="fas fa-video"></i></div>
                        <span class="quick-action-label">Upload Training</span>
                    </a>
                    <a href="#" class="quick-action" onclick="navigateTo('licenses'); setTimeout(() => openModal('add-license'), 100); return false;">
                        <div class="quick-action-icon"><i class="fas fa-file-upload"></i></div>
                        <span class="quick-action-label">Add License</span>
                    </a>
                    <a href="#" class="quick-action" onclick="navigateTo('analytics'); return false;">
                        <div class="quick-action-icon"><i class="fas fa-chart-bar"></i></div>
                        <span class="quick-action-label">View Reports</span>
                    </a>
                </div>

                <!-- Cards Grid -->
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-users"></i> Recent Employees</h3>
                            <button class="card-action" onclick="navigateTo('employees')">View All</button>
                        </div>
                        <div class="card-body">
                            <div class="employee-list">
                                ${employees.slice(0, 5).map(emp => `
                                    <div class="employee-item" onclick="viewEmployee('${emp.id}')">
                                        <div class="employee-avatar ${emp.color}">${emp.initials}</div>
                                        <div class="employee-info">
                                            <div class="employee-name">${emp.name}</div>
                                            <div class="employee-role">${emp.role}</div>
                                        </div>
                                        <span class="employee-store">${emp.store}</span>
                                        <div class="employee-status ${emp.status}"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    
                </div>

                <!-- Bottom Grid -->
                <div class="bottom-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-trophy"></i> Store Performance</h3>
                            <button class="card-action" onclick="navigateTo('analytics')">Details</button>
                        </div>
                        <div class="card-body">
                            <div class="store-performance" id="store-performance-container">
                                <div style="text-align: center; padding: 40px 20px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--accent-primary);"></i>
                                    <p style="color: var(--text-muted); margin-top: 12px; font-size: 13px;">Loading store data...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-file-certificate"></i> Licenses Status</h3>
                            <button class="card-action" onclick="navigateTo('licenses')">Upload</button>
                        </div>
                        <div class="card-body">
                            <div class="licenses-grid">
                                ${licenses.slice(0, 4).map(lic => `
                                    <div class="license-card">
                                        <div class="license-icon ${lic.status}">
                                            <i class="fas fa-${lic.status === 'valid' ? 'check-circle' : 'clock'}"></i>
                                        </div>
                                        <div class="license-info">
                                            <div class="license-name">${lic.name} - ${lic.store}</div>
                                            <div class="license-meta">Expires: ${formatDate(lic.expires)}</div>
                                        </div>
                                        <span class="license-status ${lic.status}">${lic.status.charAt(0).toUpperCase() + lic.status.slice(1)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bullhorn"></i> Recent Announcements</h3>
                            <button class="card-action" onclick="navigateTo('announcements')">Post New</button>
                        </div>
                        <div class="card-body">
                            <div class="announcement-list">
                                ${announcements.map(ann => `
                                    <div class="announcement-item">
                                        <div class="announcement-date">${formatDate(ann.date)}</div>
                                        <div class="announcement-text">${ann.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Dashboard Modules -->
                <div class="bottom-grid" style="margin-top: 24px;">
                    <!-- Employees Working Now -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-user-clock"></i> Working Now</h3>
                            <button class="card-action" onclick="navigateTo('clockin')">View All</button>
                        </div>
                        <div class="card-body">
                            <div id="working-now-container">
                                <div style="text-align: center; padding: 30px 20px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 20px; color: var(--accent-primary);"></i>
                                    <p style="color: var(--text-muted); margin-top: 8px; font-size: 12px;">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Tasks -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-tasks"></i> Pending Tasks</h3>
                            <button class="card-action" onclick="navigateTo('tasks')">View All</button>
                        </div>
                        <div class="card-body">
                            <div id="pending-tasks-container">
                                <div style="text-align: center; padding: 30px 20px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 20px; color: var(--accent-primary);"></i>
                                    <p style="color: var(--text-muted); margin-top: 8px; font-size: 12px;">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Goal -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bullseye"></i> Weekly Sales Goal</h3>
                            <button class="card-action" onclick="navigateTo('analytics')">Details</button>
                        </div>
                        <div class="card-body">
                            <div id="sales-goal-container">
                                <div style="text-align: center; padding: 30px 20px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 20px; color: var(--accent-primary);"></i>
                                    <p style="color: var(--text-muted); margin-top: 8px; font-size: 12px;">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Third Row -->
                <div class="bottom-grid" style="margin-top: 24px;">
                    <!-- Low Stock Alerts -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Low Stock</h3>
                            <button class="card-action" onclick="navigateTo('restock')">Restock</button>
                        </div>
                        <div class="card-body" style="padding-top: 8px;">
                            <!-- Simple tabs -->
                            <div style="display: flex; gap: 4px; margin-bottom: 10px;">
                                <button onclick="setLowStockTab('all')" id="low-stock-tab-all" style="padding: 4px 10px; font-size: 11px; border-radius: 5px; border: none; background: var(--accent-primary); color: white; cursor: pointer;">All</button>
                                <button onclick="setLowStockTab('critical')" id="low-stock-tab-critical" style="padding: 4px 10px; font-size: 11px; border-radius: 5px; border: none; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;">Critical</button>
                                <button onclick="setLowStockTab('low')" id="low-stock-tab-low" style="padding: 4px 10px; font-size: 11px; border-radius: 5px; border: none; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;">Low</button>
                            </div>
                            <div id="low-stock-container" style="max-height: 160px; overflow-y: auto;">
                                <div style="text-align: center; padding: 30px 20px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 20px; color: var(--accent-primary);"></i>
                                    <p style="color: var(--text-muted); margin-top: 8px; font-size: 12px;">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bell"></i> Recent Activity</h3>
                        </div>
                        <div class="card-body">
                            <div id="recent-activity-container">
                                <div style="text-align: center; padding: 30px 20px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 20px; color: var(--accent-primary);"></i>
                                    <p style="color: var(--text-muted); margin-top: 8px; font-size: 12px;">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Load monthly revenue from Shopify API (async, updates the card when ready)
            loadMonthlyRevenueFromShopify();

            // Load store performance from Shopify API (async)
            loadStorePerformance();

            // Load new dashboard modules
            loadWorkingNow();
            loadPendingTasks();
            loadSalesGoal();
            loadLowStockAlerts();
            loadRecentActivity();
        }

        /**
         * Load monthly revenue from Shopify API and update the dashboard card
         * Uses the same API as shopify-analytics.js
         */
        async function loadMonthlyRevenueFromShopify() {
            const revenueValue = document.getElementById('revenue-value');
            const revenueTrend = document.getElementById('revenue-trend');

            if (!revenueValue || !revenueTrend) return;

            try {
                // Check if fetchSalesAnalytics is available (from shopify-analytics.js)
                if (typeof fetchSalesAnalytics === 'function') {
                    console.log('[Dashboard] Loading monthly revenue from Shopify...');

                    // Fetch monthly sales data for VSU (default store)
                    const salesData = await fetchSalesAnalytics('vsu', null, 'month');

                    if (salesData && salesData.summary) {
                        const totalSales = parseFloat(salesData.summary.totalSales);
                        const totalOrders = salesData.summary.totalOrders;

                        // Format the revenue value
                        let displayValue;
                        if (totalSales >= 1000000) {
                            displayValue = '$' + (totalSales / 1000000).toFixed(1) + 'M';
                        } else if (totalSales >= 1000) {
                            displayValue = '$' + (totalSales / 1000).toFixed(1) + 'K';
                        } else {
                            displayValue = '$' + totalSales.toFixed(0);
                        }

                        // Update the card
                        revenueValue.textContent = displayValue;
                        revenueTrend.innerHTML = `<i class="fas fa-shopping-cart"></i> ${totalOrders} orders`;
                        revenueTrend.className = 'stat-trend up';

                    }
                } else {
                    // Fallback: fetchSalesAnalytics not available
                    console.warn('[Dashboard] fetchSalesAnalytics not available, showing placeholder');
                    revenueValue.textContent = '$--';
                    revenueTrend.innerHTML = `<i class="fas fa-exclamation-circle"></i> API unavailable`;
                    revenueTrend.className = 'stat-trend';
                }
            } catch (error) {
                console.error('[Dashboard] Error loading monthly revenue:', error);
                revenueValue.textContent = '$--';
                revenueTrend.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error`;
                revenueTrend.className = 'stat-trend down';
            }
        }

        /**
         * Load store performance data from Shopify (weekly sales by store)
         */
        async function loadStorePerformance() {
            const container = document.getElementById('store-performance-container');
            if (!container) return;

            try {
                // Check if analytics fetch functions are available
                const fetchFn = typeof fetchSalesAnalyticsSmart === 'function'
                    ? fetchSalesAnalyticsSmart
                    : (typeof fetchSalesAnalyticsBulk === 'function'
                        ? fetchSalesAnalyticsBulk
                        : (typeof fetchSalesAnalytics === 'function' ? fetchSalesAnalytics : null));

                if (!fetchFn) {
                    console.warn('[Dashboard] No sales analytics function available');
                    container.innerHTML = renderStorePerformanceFallback();
                    return;
                }

                console.log('[Dashboard] Loading weekly store performance...');

                // Fetch weekly sales data for each store in parallel
                const storeKeys = ['vsu', 'miramarwine', 'loyalvaper'];
                const storeNames = {
                    'vsu': 'VSU (All Locations)',
                    'miramarwine': 'Miramar Wine & Liquor',
                    'loyalvaper': 'Loyal Vaper'
                };

                const results = await Promise.allSettled(
                    storeKeys.map(key => fetchFn(key, null, 'week'))
                );

                // Process results
                const storeData = [];
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value?.summary) {
                        storeData.push({
                            name: storeNames[storeKeys[index]],
                            sales: parseFloat(result.value.summary.totalSales || 0),
                            orders: parseInt(result.value.summary.totalOrders || 0)
                        });
                    }
                });

                // Sort by sales descending
                storeData.sort((a, b) => b.sales - a.sales);

                if (storeData.length > 0) {
                    container.innerHTML = storeData.map((store, index) => {
                        const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : 'fourth';
                        const formattedSales = store.sales >= 1000
                            ? '$' + (store.sales / 1000).toFixed(1) + 'K'
                            : '$' + store.sales.toFixed(0);
                        return `
                            <div class="store-item">
                                <div class="store-rank ${rankClass}">${index + 1}</div>
                                <div class="store-details">
                                    <div class="store-name">${store.name}</div>
                                    <div class="store-sales">${store.orders} orders this week</div>
                                </div>
                                <div class="store-amount">${formattedSales}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = renderStorePerformanceFallback();
                }

            } catch (error) {
                console.error('[Dashboard] Error loading store performance:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px; color: var(--text-muted);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #ef4444; margin-bottom: 8px;"></i>
                        <p style="font-size: 13px;">Could not load store data</p>
                    </div>
                `;
            }
        }

        function renderStorePerformanceFallback() {
            return `
                <div style="text-align: center; padding: 30px 20px; color: var(--text-muted);">
                    <i class="fas fa-store" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <p style="font-size: 13px;">No sales data available</p>
                    <p style="font-size: 12px;">Check Analytics for details</p>
                </div>
            `;
        }

        /**
         * Load employees currently working (clocked in without clock out)
         */
        async function loadWorkingNow() {
            const container = document.getElementById('working-now-container');
            if (!container) return;

            try {
                // Get today's date
                const today = new Date().toISOString().split('T')[0];

                // Initialize firebase manager if needed
                if (typeof firebaseClockInManager !== 'undefined') {
                    if (!firebaseClockInManager.isInitialized) {
                        await firebaseClockInManager.initialize();
                    }

                    const records = await firebaseClockInManager.loadClockRecordsByDate(today);

                    // Filter employees who are clocked in but not clocked out
                    const workingNow = records.filter(r => r.clockIn && !r.clockOut);

                    if (workingNow.length > 0) {
                        container.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></div>
                                <span style="font-size: 13px; color: var(--text-muted);">${workingNow.length} employee${workingNow.length !== 1 ? 's' : ''} working</span>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${workingNow.slice(0, 4).map(record => {
                                    const emp = employees.find(e => e.id === record.employeeId || e.firestoreId === record.employeeId);
                                    const initials = emp?.initials || record.employeeName?.split(' ').map(n => n[0]).join('').toUpperCase() || '??';
                                    const name = emp?.name || record.employeeName || 'Unknown';
                                    const store = record.store || emp?.store || '';
                                    return `
                                        <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-primary); border-radius: 8px;">
                                            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">${initials}</div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-size: 13px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">${store} - Since ${record.clockIn}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${workingNow.length > 4 ? `<div style="text-align: center; font-size: 12px; color: var(--text-muted);">+${workingNow.length - 4} more</div>` : ''}
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                <i class="fas fa-moon" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                                <p style="font-size: 13px;">No one clocked in</p>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                            <i class="fas fa-user-clock" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                            <p style="font-size: 13px;">Clock-in not available</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[Dashboard] Error loading working now:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-exclamation-circle" style="font-size: 20px; color: #ef4444;"></i>
                        <p style="font-size: 12px; margin-top: 8px;">Error loading data</p>
                    </div>
                `;
            }
        }

        /**
         * Load pending tasks summary
         */
        async function loadPendingTasks() {
            const container = document.getElementById('pending-tasks-container');
            if (!container) return;

            try {
                // Try to get tasks from Firebase or local
                let allTasks = [];

                if (typeof firebaseTaskManager !== 'undefined' && firebaseTaskManager.isInitialized) {
                    allTasks = await firebaseTaskManager.loadTasks();
                } else if (typeof tasks !== 'undefined') {
                    allTasks = tasks;
                }

                const pendingTasks = allTasks.filter(t => t.status === 'pending' || t.status === 'in-progress');

                if (pendingTasks.length > 0) {
                    const highPriority = pendingTasks.filter(t => t.priority === 'high').length;

                    container.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${pendingTasks.length}</span>
                            ${highPriority > 0 ? `<span style="background: #ef444420; color: #ef4444; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${highPriority} High Priority</span>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${pendingTasks.slice(0, 3).map(task => `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                                    <i class="fas fa-circle" style="font-size: 6px; color: ${task.priority === 'high' ? '#ef4444' : task.priority === 'medium' ? '#f59e0b' : '#10b981'};"></i>
                                    <span style="font-size: 12px; color: var(--text-primary); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${task.title || task.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                            <i class="fas fa-check-circle" style="font-size: 24px; color: #10b981; margin-bottom: 8px;"></i>
                            <p style="font-size: 13px;">All tasks completed!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[Dashboard] Error loading tasks:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-tasks" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="font-size: 13px;">No tasks found</p>
                    </div>
                `;
            }
        }

        /**
         * Load weekly sales goal progress
         */
        async function loadSalesGoal() {
            const container = document.getElementById('sales-goal-container');
            if (!container) return;

            try {
                // Weekly goal (configurable)
                const weeklyGoal = 50000; // $50,000 weekly goal

                if (typeof fetchSalesAnalyticsSmart === 'function' || typeof fetchSalesAnalyticsBulk === 'function' || typeof fetchSalesAnalytics === 'function') {
                    const fetchFn = typeof fetchSalesAnalyticsSmart === 'function' ? fetchSalesAnalyticsSmart : (typeof fetchSalesAnalyticsBulk === 'function' ? fetchSalesAnalyticsBulk : fetchSalesAnalytics);
                    const salesData = await fetchFn('vsu', null, 'week');

                    if (salesData?.summary) {
                        const currentSales = parseFloat(salesData.summary.totalSales || 0);
                        const percentage = Math.min(Math.round((currentSales / weeklyGoal) * 100), 100);
                        const remaining = Math.max(weeklyGoal - currentSales, 0);

                        container.innerHTML = `
                            <div style="text-align: center; margin-bottom: 16px;">
                                <div style="font-size: 32px; font-weight: 700; color: ${percentage >= 100 ? '#10b981' : 'var(--text-primary)'};">${percentage}%</div>
                                <div style="font-size: 12px; color: var(--text-muted);">of weekly goal</div>
                            </div>
                            <div style="background: var(--bg-primary); border-radius: 8px; height: 12px; overflow: hidden; margin-bottom: 12px;">
                                <div style="height: 100%; width: ${percentage}%; background: linear-gradient(90deg, var(--accent-primary), ${percentage >= 100 ? '#10b981' : 'var(--accent-secondary)'}); border-radius: 8px; transition: width 0.5s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                <span style="color: var(--text-muted);">$${(currentSales/1000).toFixed(1)}K earned</span>
                                <span style="color: var(--text-muted);">$${(remaining/1000).toFixed(1)}K to go</span>
                            </div>
                        `;
                        return;
                    }
                }

                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-bullseye" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="font-size: 13px;">Sales data unavailable</p>
                    </div>
                `;
            } catch (error) {
                console.error('[Dashboard] Error loading sales goal:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-bullseye" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="font-size: 13px;">Could not load goal</p>
                    </div>
                `;
            }
        }

        /**
         * Load low stock alerts - Simple with tabs
         */
        window.lowStockData = { all: [], currentTab: 'all' };

        async function loadLowStockAlerts() {
            const container = document.getElementById('low-stock-container');
            if (!container) return;

            try {
                if (typeof fetchStoreInventory === 'function') {
                    const inventory = await fetchStoreInventory('vsu', 50);

                    if (inventory && inventory.length > 0) {
                        // Filter low stock items (<10 units), sort by qty
                        const lowStock = inventory.filter(item => {
                            const qty = item.inventoryQuantity || item.quantity || 0;
                            return qty >= 0 && qty < 10;
                        }).sort((a, b) => (a.inventoryQuantity || 0) - (b.inventoryQuantity || 0));

                        window.lowStockData.all = lowStock;
                        renderLowStockItems();
                        return;
                    }
                }

                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-check-circle" style="font-size: 24px; color: #10b981; margin-bottom: 8px;"></i>
                        <p style="font-size: 13px;">Stock levels OK</p>
                    </div>
                `;
            } catch (error) {
                console.error('[Dashboard] Error loading low stock:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-box" style="font-size: 20px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="font-size: 12px;">Unavailable</p>
                    </div>
                `;
            }
        }

        // Set active tab
        window.setLowStockTab = function(tab) {
            window.lowStockData.currentTab = tab;

            // Update tab styles
            ['all', 'critical', 'low'].forEach(t => {
                const btn = document.getElementById(`low-stock-tab-${t}`);
                if (btn) {
                    btn.style.background = (t === tab) ? 'var(--accent-primary)' : 'var(--bg-secondary)';
                    btn.style.color = (t === tab) ? 'white' : 'var(--text-secondary)';
                }
            });

            renderLowStockItems();
        };

        // Render items
        function renderLowStockItems() {
            const container = document.getElementById('low-stock-container');
            if (!container) return;

            const { all, currentTab } = window.lowStockData;

            // Filter by tab
            let filtered = all.filter(item => {
                const qty = item.inventoryQuantity || item.quantity || 0;
                if (currentTab === 'critical') return qty < 3;
                if (currentTab === 'low') return qty >= 3 && qty < 6;
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px; color: var(--text-muted);">
                        <i class="fas fa-check-circle" style="font-size: 20px; color: #10b981;"></i>
                        <p style="font-size: 12px; margin-top: 6px;">No ${currentTab === 'all' ? 'low stock' : currentTab} items</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    ${filtered.slice(0, 8).map(item => {
                        const qty = item.inventoryQuantity || item.quantity || 0;
                        const color = qty < 3 ? '#ef4444' : qty < 6 ? '#f59e0b' : '#3b82f6';

                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; background: var(--bg-primary); border-radius: 5px;">
                                <span style="font-size: 11px; color: var(--text-primary); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.title || item.name}</span>
                                <span style="font-size: 10px; font-weight: 600; color: ${color}; margin-left: 8px;">${qty}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        /**
         * Load recent activity/notifications
         */
        async function loadRecentActivity() {
            const container = document.getElementById('recent-activity-container');
            if (!container) return;

            try {
                const activities = [];

                // Get recent announcements
                if (announcements && announcements.length > 0) {
                    announcements.slice(0, 2).forEach(ann => {
                        activities.push({
                            type: 'announcement',
                            icon: 'bullhorn',
                            color: '#8b5cf6',
                            title: ann.title || 'Announcement',
                            description: (ann.content || '').substring(0, 50) + (ann.content && ann.content.length > 50 ? '...' : ''),
                            time: ann.date || ''
                        });
                    });
                }

                // Get recent clock ins
                const today = new Date().toISOString().split('T')[0];
                if (typeof firebaseClockInManager !== 'undefined' && firebaseClockInManager.isInitialized) {
                    const clockRecords = await firebaseClockInManager.loadClockRecordsByDate(today);
                    clockRecords.slice(0, 2).forEach(record => {
                        const action = record.clockOut ? 'clocked out' : 'clocked in';
                        activities.push({
                            type: 'clockin',
                            icon: 'user-clock',
                            color: '#10b981',
                            title: record.employeeName || 'Employee',
                            description: `${action} at ${record.store || 'store'}`,
                            time: record.clockOut || record.clockIn
                        });
                    });
                }

                // Sort by time (most recent first)
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));

                if (activities.length > 0) {
                    container.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${activities.slice(0, 5).map(activity => `
                                <div style="display: flex; align-items: flex-start; gap: 12px; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                                    <div style="width: 36px; height: 36px; background: ${activity.color}20; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="fas fa-${activity.icon}" style="color: ${activity.color}; font-size: 14px;"></i>
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 13px; font-weight: 500; color: var(--text-primary);">${activity.title}</div>
                                        <div style="font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${activity.description}</div>
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted); white-space: nowrap;">${activity.time}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px 20px; color: var(--text-muted);">
                            <i class="fas fa-bell-slash" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                            <p style="font-size: 13px;">No recent activity</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[Dashboard] Error loading recent activity:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px; color: var(--text-muted);">
                        <i class="fas fa-bell" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="font-size: 13px;">Activity unavailable</p>
                    </div>
                `;
            }
        }

        async function renderEmployees() {
            const dashboard = document.querySelector('.dashboard');

            // Show loading state first
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Employee Directory</h2>
                        <p class="section-subtitle">Manage your team across all stores</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="openInactiveEmployeesModal()" title="View Inactive Employees">
                            <i class="fas fa-user-slash"></i> Inactive
                        </button>
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-employee')">
                            <i class="fas fa-plus"></i> Add Employee
                        </button>
                    </div>
                </div>

                <div class="filters-bar">
                    <div class="search-filter">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search employees..." id="employee-search" onkeyup="filterEmployees()">
                    </div>
                    <select class="filter-select" id="store-filter" onchange="filterEmployees()">
                        <option value="">All Stores</option>
                        <option value="Miramar">VSU Miramar</option>
                        <option value="Morena">VSU Morena</option>
                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                        <option value="Chula Vista">VSU Chula Vista</option>
                        <option value="North Park">VSU North Park</option>
                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                    </select>
                    <select class="filter-select" id="status-filter" onchange="filterEmployees()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <button class="btn-secondary" onclick="refreshEmployeesFromFirebase()" title="Refresh from database">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div class="employees-grid" id="employees-grid">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading employees...</p>
                    </div>
                </div>
            `;

            // Load employees from Firebase
            await loadEmployeesFromFirebase();

            // Render employees grid
            const grid = document.getElementById('employees-grid');
            if (grid) {
                if (employees.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No employees yet</h3>
                            <p>Add your first employee to get started</p>
                            <button class="btn-primary" onclick="openModal('add-employee')">
                                <i class="fas fa-plus"></i> Add Employee
                            </button>
                        </div>
                    `;
                } else {
                    grid.innerHTML = employees.map(emp => renderEmployeeCard(emp)).join('');
                }
            }
        }

        /**
         * Load employees from Firebase and update local array
         */
        async function loadEmployeesFromFirebase() {
            if (!firebaseEmployeeManager.isInitialized) {
                await firebaseEmployeeManager.initialize();
            }

            if (firebaseEmployeeManager.isInitialized) {
                try {
                    const firestoreEmployees = await firebaseEmployeeManager.loadEmployees();
                    if (firestoreEmployees && firestoreEmployees.length > 0) {
                        employees = firestoreEmployees.map(emp => ({
                            id: emp.firestoreId || emp.id,
                            firestoreId: emp.firestoreId || emp.id,
                            name: emp.name || '',
                            authEmail: emp.authEmail || '',
                            phone: emp.phone || '',
                            store: emp.store || 'Miramar',
                            status: emp.status || 'active',
                            role: emp.role || 'Sales Associate',
                            employeeType: emp.employeeType || 'employee',
                            hireDate: emp.hireDate || new Date().toISOString().split('T')[0],
                            emergencyContact: emp.emergencyContact || '',
                            allergies: emp.allergies || 'None',
                            initials: (emp.name || 'XX').split(' ').map(n => n[0] || '').join('').substring(0, 2).toUpperCase(),
                            color: emp.color || ['a', 'b', 'c', 'd', 'e'][Math.floor(Math.random() * 5)],
                            offboarding: emp.offboarding || null,
                            photo: emp.photo || null,
                            photoPath: emp.photoPath || null
                        }));
                        // Update employee count badge in sidebar
                        updateEmployeeCountBadge();
                    }

                } catch (error) {
                    console.error('Error loading employees from Firebase:', error);
                }
            }
        }

        /**
         * Update the employee count badge in the sidebar
         */
        function updateEmployeeCountBadge() {
            const badge = document.getElementById('employees-count-badge');
            if (badge) {
                badge.textContent = employees.length;
                badge.style.display = employees.length > 0 ? 'inline-flex' : 'none';
            }
        }

        /**
         * Refresh employees from Firebase (manual refresh button)
         */
        async function refreshEmployeesFromFirebase() {
            const grid = document.getElementById('employees-grid');
            if (grid) {
                grid.innerHTML = `
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Refreshing...</p>
                    </div>
                `;
            }

            await loadEmployeesFromFirebase();

            if (grid) {
                grid.innerHTML = employees.map(emp => renderEmployeeCard(emp)).join('');
            }
        }

        function renderEmployeeCard(emp) {
            // Get role badge color based on employeeType
            const getRoleColor = () => {
                const colors = {
                    'admin': '#ef4444',      // Red
                    'manager': '#f59e0b',    // Amber
                    'employee': '#3b82f6'    // Blue
                };
                return colors[emp.employeeType] || '#6b7280';
            };

            const getRoleIcon = () => {
                const icons = {
                    'admin': 'crown',
                    'manager': 'chart-bar',
                    'employee': 'user'
                };
                return icons[emp.employeeType] || 'user';
            };

            const getRoleLabel = () => {
                const labels = {
                    'admin': 'Administrator',
                    'manager': 'Manager',
                    'employee': 'Employee'
                };
                return labels[emp.employeeType] || 'Employee';
            };

            const empId = emp.firestoreId || emp.id;
            return `
                <div class="employee-card" onclick="viewEmployee('${empId}')">
                    <div class="employee-card-header">
                        ${emp.photo
                            ? `<div class="employee-avatar-lg" style="background-image: url('${emp.photo}'); background-size: cover; background-position: center;"></div>`
                            : `<div class="employee-avatar-lg ${emp.color}">${emp.initials}</div>`
                        }
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div class="employee-status-badge ${emp.status}">${emp.status}</div>
                            <div class="badge" style="background: ${getRoleColor()}; color: white; font-size: 11px; padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-${getRoleIcon()}"></i>
                                ${getRoleLabel()}
                            </div>
                        </div>
                    </div>
                    <div class="employee-card-body">
                        <h3 class="employee-card-name">${emp.name}</h3>
                        <p class="employee-card-role">${emp.role}</p>
                        <div class="employee-card-store">
                            <i class="fas fa-store"></i> ${emp.store}
                        </div>
                        <div class="employee-card-meta">
                            <span><i class="fas fa-envelope"></i> ${emp.authEmail}</span>
                            <span><i class="fas fa-phone"></i> ${emp.phone}</span>
                        </div>
                        ${emp.certifications && emp.certifications.length > 0 ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-certificate" style="color: #f59e0b;"></i> Certifications (${emp.certifications.length})
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                ${emp.certifications.slice(0, 3).map(cert => {
                                    const isExpired = cert.expirationDate && new Date(cert.expirationDate) < new Date();
                                    const isExpiringSoon = cert.expirationDate && !isExpired && new Date(cert.expirationDate) < new Date(Date.now() + 30*24*60*60*1000);
                                    const color = isExpired ? '#ef4444' : isExpiringSoon ? '#f59e0b' : '#10b981';
                                    return `<span style="font-size: 10px; padding: 3px 8px; border-radius: 4px; background: ${color}20; color: ${color}; font-weight: 500; white-space: nowrap;">${cert.name.length > 15 ? cert.name.substring(0, 15) + '...' : cert.name}</span>`;
                                }).join('')}
                                ${emp.certifications.length > 3 ? `<span style="font-size: 10px; padding: 3px 6px; color: var(--text-muted);">+${emp.certifications.length - 3} more</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="employee-card-footer">
                        <button class="btn-icon" onclick="event.stopPropagation(); viewEmployeePaperwork('${empId}')" title="View Documents"><i class="fas fa-file-pdf"></i></button>
                        ${emp.status === 'inactive' && emp.offboarding ? `
                            <button class="btn-icon" onclick="event.stopPropagation(); viewOffboardingDetails('${empId}')" title="View Offboarding Info" style="color: #ef4444;"><i class="fas fa-user-minus"></i></button>
                        ` : ''}
                        <button class="btn-icon" onclick="event.stopPropagation(); editEmployee('${empId}')"><i class="fas fa-edit"></i></button>
                        ${emp.status === 'inactive' ? `
                            <button class="btn-icon success" onclick="event.stopPropagation(); activateEmployee('${empId}')" title="Activate Employee"><i class="fas fa-check"></i></button>
                        ` : `
                            <button class="btn-icon danger" onclick="event.stopPropagation(); deleteEmployee('${empId}')"><i class="fas fa-trash"></i></button>
                        `}
                    </div>
                </div>
            `;
        }

        /**
         * Get color for document type
         */
        function getDocumentColor(fileType) {
            if (!fileType) return '#6b7280';
            if (fileType.includes('pdf')) return '#ef4444';
            if (fileType.includes('word') || fileType.includes('doc')) return '#3b82f6';
            if (fileType.includes('image') || fileType.includes('jpg') || fileType.includes('jpeg') || fileType.includes('png')) return '#10b981';
            return '#6b7280';
        }

        /**
         * Download document
         */
        function downloadDocument(url, fileName) {
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function renderTraining() {
            const dashboard = document.querySelector('.dashboard');

            // Show loading state
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Training Center</h2>
                        <p class="section-subtitle">Videos, documents, and courses for your team</p>
                    </div>
                    <button class="btn-primary floating-add-btn no-float-mobile" onclick="openModal('add-training')">
                        <i class="fas fa-plus"></i> Add Training
                    </button>
                </div>
                <div style="text-align: center; padding: 60px 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--accent-primary);"></i>
                    <p style="color: var(--text-muted); margin-top: 16px;">Loading training materials...</p>
                </div>
            `;

            // Load trainings from Firebase
            await loadTrainingsFromFirebase();

            // Render the trainings grid
            dashboard.innerHTML = `
                <div class="page-header" style="margin-bottom: 24px;">
                    <div class="page-header-left">
                        <h2 class="section-title">Training Center</h2>
                        <p class="section-subtitle">Videos, documents, and courses for your team</p>
                    </div>
                    <div class="page-header-right" style="display: flex; gap: 12px; align-items: center;">
                        <!-- View Toggle -->
                        <div style="display: flex; background: var(--bg-secondary); border-radius: 10px; padding: 4px; border: 1px solid var(--border-color);">
                            <button onclick="setTrainingViewMode('grid')" id="training-view-grid-btn" style="width: 38px; height: 38px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${trainingViewMode === 'grid' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="Grid View">
                                <i class="fas fa-th-large"></i>
                            </button>
                            <button onclick="setTrainingViewMode('list')" id="training-view-list-btn" style="width: 38px; height: 38px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${trainingViewMode === 'list' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="List View">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                        <button class="btn-primary" onclick="openModal('add-training')">
                            <i class="fas fa-plus"></i> Add Training
                        </button>
                    </div>
                </div>

                ${trainings.length === 0 ? `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-graduation-cap" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 16px;">No training materials yet</div>
                        <div style="font-size: 14px; margin-top: 8px;">Click "Add Training" to create your first training material</div>
                    </div>
                ` : trainingViewMode === 'grid' ? `
                    <div class="training-grid">
                        ${trainings.map(t => {
                            const thumbnail = t.type === 'video' && t.url ? getVideoThumbnail(t.url) : null;
                            const isVimeo = thumbnail && thumbnail.startsWith('vimeo:');
                            const vimeoId = isVimeo ? thumbnail.replace('vimeo:', '') : null;
                            const thumbStyle = thumbnail && !isVimeo ? `style="background-image: url('${thumbnail}'); background-size: cover; background-position: center;"` : '';
                            const vimeoAttr = isVimeo ? `data-vimeo-id="${vimeoId}"` : '';
                            return `
                            <div class="training-card" onclick="${t.type === 'video' ? `playTrainingVideo('${t.id}')` : `viewTraining('${t.id}')`}" style="cursor: pointer;">
                                <div class="training-card-thumbnail ${t.type}" ${thumbStyle} ${vimeoAttr}>
                                    ${thumbnail ? `<div style="position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"><i class="fas fa-play-circle" style="font-size: 48px; color: white; text-shadow: 0 2px 8px rgba(0,0,0,0.5);"></i></div>` : `<i class="fas fa-${t.type === 'video' ? 'play-circle' : 'file-pdf'}"></i>`}
                                </div>
                                <div class="training-card-body">
                                    <div class="training-card-type">${(t.type || 'document').toUpperCase()}</div>
                                    <h3 class="training-card-title">${t.title}</h3>
                                    ${t.fileName ? `
                                        <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                                            <i class="fas fa-file-pdf"></i> ${t.fileName}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="training-card-footer">
                                    <button class="btn-secondary" onclick="event.stopPropagation(); viewTraining('${t.id}')">View Details</button>
                                    <button class="btn-icon" onclick="event.stopPropagation(); editTraining('${t.id}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn-icon danger" onclick="event.stopPropagation(); deleteTraining('${t.id}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                ` : `
                    <!-- List View -->
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${trainings.map(t => {
                            const thumbnail = t.type === 'video' && t.url ? getVideoThumbnail(t.url) : null;
                            const isVimeo = thumbnail && thumbnail.startsWith('vimeo:');
                            const vimeoId = isVimeo ? thumbnail.replace('vimeo:', '') : null;
                            const thumbUrl = thumbnail && !isVimeo ? thumbnail : null;
                            const vimeoAttr = isVimeo ? `data-vimeo-id="${vimeoId}"` : '';
                            const typeColor = t.type === 'video' ? '#ef4444' : '#3b82f6';
                            const typeIcon = t.type === 'video' ? 'play-circle' : 'file-pdf';
                            return `
                            <div class="training-list-item" onclick="${t.type === 'video' ? `playTrainingVideo('${t.id}')` : `viewTraining('${t.id}')`}" style="background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <div style="display: flex; align-items: center; padding: 16px; gap: 16px;">
                                    <!-- Thumbnail -->
                                    <div style="width: 120px; height: 68px; border-radius: 8px; flex-shrink: 0; position: relative; overflow: hidden; background: linear-gradient(135deg, ${typeColor} 0%, ${typeColor}dd 100%); display: flex; align-items: center; justify-content: center;" ${thumbUrl ? `style="background-image: url('${thumbUrl}'); background-size: cover; background-position: center;"` : ''} ${vimeoAttr}>
                                        ${thumbUrl ? `
                                            <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-play-circle" style="font-size: 28px; color: white;"></i>
                                            </div>
                                        ` : `
                                            <i class="fas fa-${typeIcon}" style="font-size: 24px; color: white;"></i>
                                        `}
                                    </div>

                                    <!-- Info -->
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                            <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t.title}</h3>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 16px; font-size: 13px; color: var(--text-muted);">
                                            <span style="display: flex; align-items: center; gap: 4px;">
                                                <i class="fas fa-${typeIcon}" style="color: ${typeColor};"></i>
                                                ${(t.type || 'document').charAt(0).toUpperCase() + (t.type || 'document').slice(1)}
                                            </span>
                                            ${t.fileName ? `
                                                <span style="display: flex; align-items: center; gap: 4px;">
                                                    <i class="fas fa-file"></i>
                                                    ${t.fileName}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div style="display: flex; gap: 8px;" onclick="event.stopPropagation()">
                                        <button class="btn-secondary" onclick="viewTraining('${t.id}')" style="padding: 8px 16px; font-size: 13px;">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn-icon" onclick="editTraining('${t.id}')" style="width: 36px; height: 36px;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon danger" onclick="deleteTraining('${t.id}')" style="width: 36px; height: 36px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                `}
            `;

            // Load Vimeo thumbnails after render
            setTimeout(() => loadVimeoThumbnails(), 100);
        }

        function renderLicenses() {
            const stores = ['Miramar', 'Miramar Wine & Liquor', 'Morena', 'Kearny Mesa', 'Chula Vista', 'North Park'];

            const dashboard = document.querySelector('.dashboard');

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Licenses & Documents</h2>
                        <p class="section-subtitle">Drag and drop documents between stores</p>
                        <div class="licenses-controls-row">
                            <div class="edit-mode-toggle">
                                <span class="edit-mode-label">Edit Mode:</span>
                                <button onclick="toggleLicensesEditMode()" style="background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center;">
                                    <div style="width: 44px; height: 24px; background: ${licensesEditMode ? '#10b981' : '#ef4444'}; border-radius: 12px; position: relative; transition: background 0.3s;">
                                        <div style="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; ${licensesEditMode ? 'right: 2px;' : 'left: 2px;'} transition: all 0.3s;"></div>
                                    </div>
                                </button>
                                <span class="edit-mode-status" style="color: ${licensesEditMode ? '#10b981' : '#ef4444'};">${licensesEditMode ? '‚úì EDITABLE' : '‚úó LOCKED'}</span>
                            </div>
                            <button class="btn-primary btn-add-document" onclick="openModal('add-license')">
                                <i class="fas fa-plus"></i> Add Document
                            </button>
                        </div>
                    </div>
                </div>

                <div class="license-summary">
                    <div class="license-summary-card valid">
                        <i class="fas fa-check-circle"></i>
                        <span class="count">${licenses.filter(l => l.status === 'valid').length}</span>
                        <span class="label">Valid</span>
                    </div>
                    <div class="license-summary-card expiring">
                        <i class="fas fa-clock"></i>
                        <span class="count">${licenses.filter(l => l.status === 'expiring').length}</span>
                        <span class="label">Expiring Soon</span>
                    </div>
                    <div class="license-summary-card expired">
                        <i class="fas fa-times-circle"></i>
                        <span class="count">${licenses.filter(l => l.status === 'expired').length}</span>
                        <span class="label">Expired</span>
                    </div>
                </div>

                <div class="license-stores-grid">
                    ${stores.map(store => {
                        const storeLicenses = licenses.filter(l => l.store === store);
                        return `
                            <div class="license-store-zone"
                                 data-store="${store}"
                                 ondrop="handleLicenseDrop(event, '${store}')"
                                 ondragover="handleLicenseDragOver(event)"
                                 ondragleave="handleLicenseDragLeave(event)">
                                <div class="license-store-header">
                                    <div class="license-store-title">
                                        <i class="fas fa-store"></i>
                                        <span>VSU ${store}</span>
                                    </div>
                                    <div class="license-store-count">
                                        <span class="count-badge">${storeLicenses.length}</span>
                                    </div>
                                </div>
                                <div class="license-drop-area">
                                    ${storeLicenses.length === 0 ? `
                                        <div class="license-empty-state">
                                            <i class="fas fa-file-upload"></i>
                                            <span>Drop documents here</span>
                                        </div>
                                    ` : ''}
                                    ${storeLicenses.map(lic => {
                                        const hasPdf = lic.fileUrl || lic.fileData;
                                        return `
                                        <div class="license-item"
                                             draggable="${licensesEditMode ? 'true' : 'false'}"
                                             data-license-id="${lic.id}"
                                             ondragstart="handleLicenseDragStart(event, '${lic.id}')"
                                             ondragend="handleLicenseDragEnd(event)"
                                             style="cursor: ${licensesEditMode ? 'grab' : 'default'};">
                                            <div class="license-item-header">
                                                <div class="license-item-name">
                                                    <i class="fas fa-file-pdf"></i>
                                                    <span>${lic.name}</span>
                                                </div>
                                                <div class="license-item-status">
                                                    <div class="status-dot ${lic.status}" title="${lic.status}"></div>
                                                </div>
                                            </div>
                                            <div class="license-item-footer">
                                                <span class="license-expires">
                                                    <i class="fas fa-calendar"></i>
                                                    ${formatDate(lic.expires)}
                                                </span>
                                                <div class="license-item-actions" style="pointer-events: auto;">
                                                    <button class="btn-icon-sm" onclick="event.stopPropagation(); viewLicense('${lic.id}')" title="View${hasPdf ? ' PDF' : ''}" style="pointer-events: auto;">
                                                        <i class="fas ${hasPdf ? 'fa-file-pdf' : 'fa-eye'}"></i>
                                                    </button>
                                                    <button class="btn-icon-sm" onclick="event.stopPropagation(); deleteLicense('${lic.id}')" title="Delete" style="${!licensesEditMode ? 'opacity: 0.4; pointer-events: none;' : 'pointer-events: auto;'}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Analytics date range state - Initialize with current month dates
        const analyticsNow = new Date();
        const analyticsMonthStart = new Date(analyticsNow.getFullYear(), analyticsNow.getMonth(), 1);
        const analyticsMonthEnd = new Date(analyticsNow.getFullYear(), analyticsNow.getMonth() + 1, 0); // Last day of current month

        let analyticsDateRange = {
            startDate: analyticsMonthStart,
            endDate: analyticsNow, // Today, not future date
            period: 'month', // 'today', 'week', 'month', 'quarter', 'year', 'custom'
            calendarMonth1: new Date(),
            calendarMonth2: new Date(analyticsNow.getFullYear(), analyticsNow.getMonth() + 1, 1),
            isSelecting: false,
            tempStartDate: null
        };

        // Analytics data cache (populated by bulk operations)
        let analyticsData = {
            isLoading: false,
            lastLoaded: null,
            storeKey: 'vsu', // Default store
            data: null,      // Holds the analytics result from fetchSalesAnalyticsBulk
            error: null
        };

        /**
         * Load analytics data using GraphQL Bulk Operations
         * This fetches real order data from Shopify without the 250/page limit
         */
        async function loadAnalyticsData() {
            // Don't reload if already loading
            if (analyticsData.isLoading) {
                console.log('[Analytics] Already loading, skipping...');
                return;
            }

            analyticsData.isLoading = true;
            analyticsData.error = null;

            // Show loading state in UI
            updateAnalyticsLoadingState(true, 'Starting bulk export...');

            try {
                // Always build custom range from selected dates for smart fetch to calculate days
                let customRange = null;
                if (analyticsDateRange.startDate && analyticsDateRange.endDate) {
                    customRange = {
                        startDate: analyticsDateRange.startDate,
                        endDate: analyticsDateRange.endDate
                    };
                }

                // Progress callback to update UI
                const onProgress = (percent, message) => {
                    updateAnalyticsLoadingState(true, message, percent);
                };

                // Fetch data using smart method (REST for short periods, Bulk for long)
                const fetchFn = typeof fetchSalesAnalyticsSmart === 'function'
                    ? fetchSalesAnalyticsSmart
                    : fetchSalesAnalyticsBulk;
                const data = await fetchFn(
                    analyticsData.storeKey,
                    null, // locationId
                    analyticsDateRange.period,
                    onProgress,
                    customRange
                );

                analyticsData.data = data;
                analyticsData.lastLoaded = new Date();
                analyticsData.error = null;

                console.log(`[Analytics] Loaded ${data.summary.totalOrders} orders via bulk operation`);

                // Re-render with real data
                renderAnalyticsWithData();

            } catch (error) {
                console.error('[Analytics] Failed to load data:', error);
                analyticsData.error = error.message;
                updateAnalyticsLoadingState(false, null);
                showAnalyticsError(error.message);
            } finally {
                analyticsData.isLoading = false;
            }
        }

        /**
         * Update the loading state UI in analytics page
         */
        function updateAnalyticsLoadingState(isLoading, message = '', percent = 0) {
            const loadingOverlay = document.getElementById('analytics-loading-overlay');
            if (!loadingOverlay) return;

            if (isLoading) {
                loadingOverlay.style.display = 'flex';
                const progressBar = loadingOverlay.querySelector('.analytics-progress-bar');
                const progressText = loadingOverlay.querySelector('.analytics-progress-text');
                if (progressBar) progressBar.style.width = `${percent}%`;
                if (progressText) progressText.textContent = message;
            } else {
                loadingOverlay.style.display = 'none';
            }
        }

        /**
         * Show error message in analytics page
         */
        function showAnalyticsError(message) {
            const errorContainer = document.getElementById('analytics-error');
            if (errorContainer) {
                errorContainer.style.display = 'block';
                errorContainer.textContent = `Error: ${message}`;
            }
        }

        /**
         * Render analytics page with real Shopify data
         */
        function renderAnalyticsWithData() {
            if (!analyticsData.data) {
                renderAnalytics(); // Fall back to placeholder
                return;
            }

            const data = analyticsData.data;
            const summary = data.summary;
            const dashboard = document.querySelector('.dashboard');

            // Calculate real totals from Cash Out records
            const totalCashOut = cashOutRecords.reduce((sum, r) => sum + (r.amount || 0), 0);

            // Use real data from bulk operation
            const totalIncome = parseFloat(summary.totalSales);
            const totalTax = parseFloat(summary.totalTax);
            const netSales = parseFloat(summary.netSales);
            const totalOrders = summary.totalOrders;
            const avgOrderValue = parseFloat(summary.avgOrderValue);
            const totalCecetTax = parseFloat(summary.totalCecetTax);
            const totalSalesTax = parseFloat(summary.totalSalesTax);

            // Build monthly data from real data
            const monthlyData = Object.entries(data.monthly).map(([month, stats]) => ({
                month: month,
                income: stats.sales,
                expenses: stats.tax, // Using tax as a proxy for now
                orders: stats.orders,
                cecetTax: stats.cecetTax,
                salesTax: stats.salesTax
            })).sort((a, b) => new Date(a.month) - new Date(b.month));

            // Find max for scaling
            const maxIncome = Math.max(...monthlyData.map(m => m.income), 1);

            // Format current date range display
            const formatDateDisplay = (date) => {
                if (!date) return '';
                return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
            };

            const dateRangeText = analyticsDateRange.startDate && analyticsDateRange.endDate
                ? `${formatDateDisplay(analyticsDateRange.startDate)} ‚Üí ${formatDateDisplay(analyticsDateRange.endDate)}`
                : data.dateRange ? `${formatDateDisplay(new Date(data.dateRange.since))} ‚Üí ${formatDateDisplay(new Date(data.dateRange.until))}` : 'Select date range';

            dashboard.innerHTML = `
                <!-- Loading Overlay -->
                <div id="analytics-loading-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                    <div style="background: var(--bg-card); padding: 30px; border-radius: 12px; text-align: center; min-width: 300px;">
                        <div class="analytics-progress-text" style="margin-bottom: 15px; color: var(--text-primary);">Loading...</div>
                        <div style="background: var(--bg-secondary); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div class="analytics-progress-bar" style="background: var(--accent-primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <!-- Error Container -->
                <div id="analytics-error" style="display: none; background: #fee; color: #c33; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>

                <!-- Clean Header -->
                <div class="page-header" style="margin-bottom: 24px;">
                    <div class="page-header-left">
                        <h2 class="section-title">Sales Analytics</h2>
                        <p class="section-subtitle">${dateRangeText}</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="analytics-period-select" onchange="setAnalyticsPeriodFromSelect(this.value)" class="form-input" style="min-width: 140px;">
                            <option value="today" ${analyticsDateRange.period === 'today' ? 'selected' : ''}>Today</option>
                            <option value="week" ${analyticsDateRange.period === 'week' ? 'selected' : ''}>This Week</option>
                            <option value="month" ${analyticsDateRange.period === 'month' ? 'selected' : ''}>This Month</option>
                            <option value="quarter" ${analyticsDateRange.period === 'quarter' ? 'selected' : ''}>Last 3 Months</option>
                            <option value="year" ${analyticsDateRange.period === 'year' ? 'selected' : ''}>This Year</option>
                            <option value="custom" ${analyticsDateRange.period === 'custom' ? 'selected' : ''}>Custom Range</option>
                        </select>
                        <button onclick="loadAnalyticsData()" class="btn-primary" style="padding: 10px 16px;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Custom Date Range (only shown when custom is selected) -->
                <div id="analytics-custom-range" style="display: ${analyticsDateRange.period === 'custom' ? 'flex' : 'none'}; gap: 16px; align-items: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%); border-radius: 16px; border: 1px solid var(--border-color); flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Start Date</span>
                            <button onclick="openCustomCalendar('start')" id="analytics-start-btn" style="width: 170px; padding: 12px 16px; padding-left: 40px; border-radius: 10px; font-weight: 600; background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); cursor: pointer; text-align: left; position: relative; transition: all 0.2s;">
                                <i class="fas fa-calendar" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--accent-primary); font-size: 14px;"></i>
                                ${analyticsDateRange.startDate ? analyticsDateRange.startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'Select date'}
                            </button>
                        </div>
                        <div style="width: 40px; height: 40px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: 20px;">
                            <i class="fas fa-arrow-right" style="color: white; font-size: 14px;"></i>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">End Date</span>
                            <button onclick="openCustomCalendar('end')" id="analytics-end-btn" style="width: 170px; padding: 12px 16px; padding-left: 40px; border-radius: 10px; font-weight: 600; background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); cursor: pointer; text-align: left; position: relative; transition: all 0.2s;">
                                <i class="fas fa-calendar-check" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #10b981; font-size: 14px;"></i>
                                ${analyticsDateRange.endDate ? analyticsDateRange.endDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'Select date'}
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-left: auto; flex-wrap: wrap;">
                        <button onclick="setQuickDateRange('today')" class="btn-secondary ${analyticsDateRange.period === 'today' ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">Today</button>
                        <button onclick="setQuickDateRange('yesterday')" class="btn-secondary ${analyticsDateRange.period === 'custom' && analyticsDateRange.startDate?.toDateString() === new Date(new Date().setDate(new Date().getDate()-1)).toDateString() ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">Yesterday</button>
                        <button onclick="setQuickDateRange('week')" class="btn-secondary ${analyticsDateRange.period === 'week' ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">This Week</button>
                        <button onclick="setQuickDateRange('month')" class="btn-secondary ${analyticsDateRange.period === 'month' ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">This Month</button>
                        <button onclick="setQuickDateRange('year')" class="btn-secondary ${analyticsDateRange.period === 'year' ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">This Year</button>
                    </div>
                </div>

                <!-- Real Data Summary Cards -->
                <div class="analytics-grid">
                    <div class="analytics-card revenue">
                        <div class="analytics-card-header">
                            <h3>Total Sales</h3>
                            <span class="trend up"><i class="fas fa-shopping-cart"></i></span>
                        </div>
                        <div class="analytics-value">$${totalIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="analytics-comparison">
                            <span>${totalOrders} orders</span>
                        </div>
                    </div>

                    <div class="analytics-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div class="analytics-card-header">
                            <h3 style="color: white;">Total Tax</h3>
                            <span class="trend" style="background: rgba(255,255,255,0.2); color: white;"><i class="fas fa-receipt"></i></span>
                        </div>
                        <div class="analytics-value" style="color: white;">$${totalTax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="analytics-comparison" style="color: rgba(255,255,255,0.8);">
                            <span>CECET: $${totalCecetTax.toFixed(2)} | Sales: $${totalSalesTax.toFixed(2)}</span>
                        </div>
                    </div>

                    <div class="analytics-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div class="analytics-card-header">
                            <h3 style="color: white;">Net Sales</h3>
                            <span class="trend" style="background: rgba(255,255,255,0.2); color: white;"><i class="fas fa-dollar-sign"></i></span>
                        </div>
                        <div class="analytics-value" style="color: white;">$${netSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="analytics-comparison" style="color: rgba(255,255,255,0.8);">
                            <span>After tax deductions</span>
                        </div>
                    </div>

                    <div class="analytics-card orders">
                        <div class="analytics-card-header">
                            <h3>Avg Order Value</h3>
                            <span class="trend up"><i class="fas fa-chart-line"></i></span>
                        </div>
                        <div class="analytics-value">$${avgOrderValue.toFixed(2)}</div>
                        <div class="analytics-breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Total Orders</span>
                                <span class="breakdown-value">${totalOrders}</span>
                            </div>
                        </div>
                    </div>
                </div>

                ${monthlyData.length > 0 ? `
                <!-- Sales by Period Chart -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Sales by ${monthlyData.length > 7 ? 'Month' : 'Day'}</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 24px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 4px;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Sales</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 4px;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Tax</span>
                            </div>
                        </div>

                        <div style="display: flex; align-items: flex-end; gap: 8px; height: 250px; padding: 20px 0; border-bottom: 2px solid var(--border-color); overflow-x: auto;">
                            ${monthlyData.slice(-12).map(m => {
                                const incomeHeight = (m.income / maxIncome) * 100;
                                const taxHeight = (m.expenses / maxIncome) * 100;
                                return `
                                    <div style="flex: 1; min-width: 50px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div style="font-size: 10px; color: var(--text-muted); max-width: 60px; overflow: hidden; text-overflow: ellipsis;">$${(m.income/1000).toFixed(1)}k</div>
                                        <div style="display: flex; gap: 2px; align-items: flex-end; height: 180px;">
                                            <div style="width: 18px; height: ${incomeHeight}%; background: linear-gradient(180deg, #6366f1, #8b5cf6); border-radius: 4px 4px 0 0; transition: height 0.3s;" title="Sales: $${m.income.toLocaleString()}"></div>
                                            <div style="width: 18px; height: ${Math.max(taxHeight, 2)}%; background: linear-gradient(180deg, #f59e0b, #d97706); border-radius: 4px 4px 0 0; transition: height 0.3s;" title="Tax: $${m.expenses.toLocaleString()}"></div>
                                        </div>
                                        <div style="font-size: 10px; color: var(--text-muted); font-weight: 500; white-space: nowrap;">${m.month.split(' ')[0].substring(0,3)}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Summary Table -->
                        <div style="margin-top: 20px; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: var(--bg-secondary);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Period</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Sales</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Orders</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Tax</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">CECET</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Sales Tax</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${monthlyData.slice(-12).map(m => `
                                        <tr>
                                            <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); font-weight: 500;">${m.month}</td>
                                            <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: var(--accent-primary);">$${m.income.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                            <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right;">${m.orders}</td>
                                            <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: #f59e0b;">$${m.expenses.toFixed(2)}</td>
                                            <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right;">$${m.cecetTax.toFixed(2)}</td>
                                            <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right;">$${m.salesTax.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                    <tr style="background: var(--bg-secondary); font-weight: 700;">
                                        <td style="padding: 12px;">TOTAL</td>
                                        <td style="padding: 12px; text-align: right; color: var(--accent-primary);">$${totalIncome.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td style="padding: 12px; text-align: right;">${totalOrders}</td>
                                        <td style="padding: 12px; text-align: right; color: #f59e0b;">$${totalTax.toFixed(2)}</td>
                                        <td style="padding: 12px; text-align: right;">$${totalCecetTax.toFixed(2)}</td>
                                        <td style="padding: 12px; text-align: right;">$${totalSalesTax.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : `
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body" style="text-align: center; padding: 40px;">
                        <i class="fas fa-chart-bar" style="font-size: 48px; color: var(--text-muted); margin-bottom: 15px;"></i>
                        <p style="color: var(--text-secondary);">No data available for the selected period</p>
                    </div>
                </div>
                `}

                <!-- Recent Orders -->
                ${data.recentOrders && data.recentOrders.length > 0 ? `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-list"></i> Recent Orders (${Math.min(data.recentOrders.length, 20)} of ${data.recentOrders.length})</h3>
                    </div>
                    <div class="card-body" style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: var(--bg-secondary);">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Order</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Date</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Customer</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Total</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Tax</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.recentOrders.slice(0, 20).map(order => `
                                    <tr>
                                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); font-weight: 500;">${order.name}</td>
                                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color);">${new Date(order.createdAt).toLocaleDateString()}</td>
                                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color);">${order.customer}</td>
                                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; font-weight: 500;">$${order.total.toFixed(2)}</td>
                                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: #f59e0b;">$${(order.cecetTax + order.salesTax).toFixed(2)}</td>
                                        <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: center;">
                                            <span style="padding: 4px 8px; background: ${order.status === 'PAID' ? '#10b98120' : '#f59e0b20'}; color: ${order.status === 'PAID' ? '#10b981' : '#f59e0b'}; border-radius: 12px; font-size: 11px; font-weight: 600;">${order.status}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
            `;

            // Hide loading overlay if visible
            updateAnalyticsLoadingState(false);
        }

        function renderAnalytics() {
            // If we already have data, render with data instead
            if (analyticsData.data) {
                renderAnalyticsWithData();
                return;
            }

            const dashboard = document.querySelector('.dashboard');

            // Format current date range display
            const formatDateDisplay = (date) => {
                if (!date) return '';
                return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
            };

            const dateRangeText = analyticsDateRange.startDate && analyticsDateRange.endDate
                ? `${formatDateDisplay(analyticsDateRange.startDate)} ‚Üí ${formatDateDisplay(analyticsDateRange.endDate)}`
                : 'Select date range';

            dashboard.innerHTML = `
                <!-- Loading Overlay -->
                <div id="analytics-loading-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                    <div style="background: var(--bg-card); padding: 30px; border-radius: 12px; text-align: center; min-width: 300px;">
                        <div class="analytics-progress-text" style="margin-bottom: 15px; color: var(--text-primary);">Loading...</div>
                        <div style="background: var(--bg-secondary); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div class="analytics-progress-bar" style="background: var(--accent-primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <!-- Error Container -->
                <div id="analytics-error" style="display: none; background: #fee; color: #c33; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>

                <!-- Clean Header -->
                <div class="page-header" style="margin-bottom: 24px;">
                    <div class="page-header-left">
                        <h2 class="section-title">Sales Analytics</h2>
                        <p class="section-subtitle">${dateRangeText}</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="analytics-period-select" onchange="setAnalyticsPeriodFromSelect(this.value)" class="form-input" style="min-width: 140px;">
                            <option value="today" ${analyticsDateRange.period === 'today' ? 'selected' : ''}>Today</option>
                            <option value="week" ${analyticsDateRange.period === 'week' ? 'selected' : ''}>This Week</option>
                            <option value="month" ${analyticsDateRange.period === 'month' ? 'selected' : ''}>This Month</option>
                            <option value="quarter" ${analyticsDateRange.period === 'quarter' ? 'selected' : ''}>Last 3 Months</option>
                            <option value="year" ${analyticsDateRange.period === 'year' ? 'selected' : ''}>This Year</option>
                            <option value="custom" ${analyticsDateRange.period === 'custom' ? 'selected' : ''}>Custom Range</option>
                        </select>
                        <button onclick="loadAnalyticsData()" class="btn-primary" style="padding: 10px 16px;">
                            <i class="fas fa-sync-alt"></i> Load Data
                        </button>
                    </div>
                </div>

                <!-- Custom Date Range (only shown when custom is selected) -->
                <div id="analytics-custom-range" style="display: ${analyticsDateRange.period === 'custom' ? 'flex' : 'none'}; gap: 16px; align-items: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%); border-radius: 16px; border: 1px solid var(--border-color); flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Start Date</span>
                            <button onclick="openCustomCalendar('start')" id="analytics-start-btn" style="width: 170px; padding: 12px 16px; padding-left: 40px; border-radius: 10px; font-weight: 600; background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); cursor: pointer; text-align: left; position: relative; transition: all 0.2s;">
                                <i class="fas fa-calendar" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--accent-primary); font-size: 14px;"></i>
                                ${analyticsDateRange.startDate ? analyticsDateRange.startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'Select date'}
                            </button>
                        </div>
                        <div style="width: 40px; height: 40px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: 20px;">
                            <i class="fas fa-arrow-right" style="color: white; font-size: 14px;"></i>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">End Date</span>
                            <button onclick="openCustomCalendar('end')" id="analytics-end-btn" style="width: 170px; padding: 12px 16px; padding-left: 40px; border-radius: 10px; font-weight: 600; background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); cursor: pointer; text-align: left; position: relative; transition: all 0.2s;">
                                <i class="fas fa-calendar-check" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #10b981; font-size: 14px;"></i>
                                ${analyticsDateRange.endDate ? analyticsDateRange.endDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'Select date'}
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-left: auto; flex-wrap: wrap;">
                        <button onclick="setQuickDateRange('today')" class="btn-secondary ${analyticsDateRange.period === 'today' ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">Today</button>
                        <button onclick="setQuickDateRange('yesterday')" class="btn-secondary" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">Yesterday</button>
                        <button onclick="setQuickDateRange('week')" class="btn-secondary ${analyticsDateRange.period === 'week' ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">This Week</button>
                        <button onclick="setQuickDateRange('month')" class="btn-secondary ${analyticsDateRange.period === 'month' ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">This Month</button>
                        <button onclick="setQuickDateRange('year')" class="btn-secondary ${analyticsDateRange.period === 'year' ? 'active' : ''}" style="padding: 10px 14px; border-radius: 10px; font-size: 12px;">This Year</button>
                    </div>
                </div>

                <!-- Annual Totals -->
                <div class="analytics-grid">
                    <div class="analytics-card revenue">
                        <div class="analytics-card-header">
                            <h3>Total Annual Revenue</h3>
                            <span class="trend up"><i class="fas fa-arrow-up"></i> 18.2%</span>
                        </div>
                        <div class="analytics-value">$${(totalIncome / 1000).toFixed(1)}K</div>
                        <div class="analytics-comparison">
                            <span>All stores combined</span>
                        </div>
                    </div>

                    <div class="analytics-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <div class="analytics-card-header">
                            <h3 style="color: white;">Total Expenses</h3>
                            <span class="trend" style="background: rgba(255,255,255,0.2); color: white;"><i class="fas fa-chart-line"></i></span>
                        </div>
                        <div class="analytics-value" style="color: white;">$${(totalExpenses / 1000).toFixed(1)}K</div>
                        <div class="analytics-comparison" style="color: rgba(255,255,255,0.8);">
                            <span>Cash outs: $${totalCashOut.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>

                    <div class="analytics-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div class="analytics-card-header">
                            <h3 style="color: white;">Net Profit</h3>
                            <span class="trend" style="background: rgba(255,255,255,0.2); color: white;"><i class="fas fa-arrow-up"></i> ${profitMargin}%</span>
                        </div>
                        <div class="analytics-value" style="color: white;">$${(netProfit / 1000).toFixed(1)}K</div>
                        <div class="analytics-comparison" style="color: rgba(255,255,255,0.8);">
                            <span>Profit margin: ${profitMargin}%</span>
                        </div>
                    </div>

                    <div class="analytics-card orders">
                        <div class="analytics-card-header">
                            <h3>Total Orders</h3>
                            <span class="trend up"><i class="fas fa-arrow-up"></i> 12.5%</span>
                        </div>
                        <div class="analytics-value">5,842</div>
                        <div class="analytics-breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Avg/Month</span>
                                <span class="breakdown-value">487</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Income vs Expenses Chart -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Income vs Expenses by Month</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 24px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 4px;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Income</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 4px;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Expenses</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 3px; background: #10b981; border-radius: 2px;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Net Profit</span>
                            </div>
                        </div>

                        <div style="display: flex; align-items: flex-end; gap: 12px; height: 250px; padding: 20px 0; border-bottom: 2px solid var(--border-color);">
                            ${monthlyData.map(m => {
                                const incomeHeight = (m.income / maxIncome) * 100;
                                const expenseHeight = (m.expenses / maxIncome) * 100;
                                const profit = m.income - m.expenses;
                                const profitPercent = ((profit / m.income) * 100).toFixed(0);
                                return `
                                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div style="font-size: 11px; color: #10b981; font-weight: 600;">+${profitPercent}%</div>
                                        <div style="display: flex; gap: 4px; align-items: flex-end; height: 180px;">
                                            <div style="width: 20px; height: ${incomeHeight}%; background: linear-gradient(180deg, #6366f1, #8b5cf6); border-radius: 4px 4px 0 0; transition: height 0.3s;" title="Income: $${m.income.toLocaleString()}"></div>
                                            <div style="width: 20px; height: ${expenseHeight}%; background: linear-gradient(180deg, #ef4444, #dc2626); border-radius: 4px 4px 0 0; transition: height 0.3s;" title="Expenses: $${m.expenses.toLocaleString()}"></div>
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-muted); font-weight: 500;">${m.month}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Monthly Summary Table -->
                        <div style="margin-top: 20px; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: var(--bg-secondary);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Month</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Income</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Expenses</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Net Profit</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">Margin</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${monthlyData.map(m => {
                                        const profit = m.income - m.expenses;
                                        const margin = ((profit / m.income) * 100).toFixed(1);
                                        return `
                                            <tr>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); font-weight: 500;">${m.month}</td>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: var(--accent-primary);">$${m.income.toLocaleString()}</td>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: #ef4444;">$${m.expenses.toLocaleString()}</td>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; color: #10b981; font-weight: 600;">$${profit.toLocaleString()}</td>
                                                <td style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right;">
                                                    <span style="padding: 4px 8px; background: ${parseFloat(margin) > 80 ? '#10b98120' : '#f59e0b20'}; color: ${parseFloat(margin) > 80 ? '#10b981' : '#f59e0b'}; border-radius: 12px; font-size: 12px; font-weight: 600;">${margin}%</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr style="background: var(--bg-secondary); font-weight: 700;">
                                        <td style="padding: 12px;">TOTAL</td>
                                        <td style="padding: 12px; text-align: right; color: var(--accent-primary);">$${totalIncome.toLocaleString()}</td>
                                        <td style="padding: 12px; text-align: right; color: #ef4444;">$${totalExpenses.toLocaleString()}</td>
                                        <td style="padding: 12px; text-align: right; color: #10b981;">$${netProfit.toLocaleString()}</td>
                                        <td style="padding: 12px; text-align: right;">${profitMargin}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="analytics-stores">
                    <h3 class="section-subtitle-alt">Store Performance Comparison (Annual)</h3>
                    <div class="store-bars">
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU Miramar</span>
                                <span>$185,040</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill miramar" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU Kearny Mesa</span>
                                <span>$154,680</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill kearny" style="width: 83%;"></div>
                            </div>
                        </div>
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU Chula Vista</span>
                                <span>$124,080</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill chula" style="width: 67%;"></div>
                            </div>
                        </div>
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU Morena</span>
                                <span>$114,600</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill morena" style="width: 62%;"></div>
                            </div>
                        </div>
                        <div class="store-bar-item">
                            <div class="store-bar-label">
                                <span>VSU North Park</span>
                                <span>$33,700</span>
                            </div>
                            <div class="store-bar-track">
                                <div class="store-bar-fill" style="width: 18%; background: linear-gradient(90deg, #14b8a6, #0d9488);"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shopify-connect">
                    <div class="shopify-icon"><i class="fab fa-shopify"></i></div>
                    <div class="shopify-text">
                        <h4>Load Shopify Data</h4>
                        <p>Fetch real sales data using GraphQL Bulk Operations (no order limit)</p>
                    </div>
                    <button class="btn-primary" onclick="loadAnalyticsData()">
                        <i class="fas fa-sync-alt"></i> Load Data
                    </button>
                </div>
            `;

            // NOTE: Auto-load disabled - user must click Apply button
            // The renderAnalyticsPage in api-client.js is now the primary entry point
        }

        // Analytics Calendar Functions
        window.toggleAnalyticsCalendar = function() {
            const container = document.getElementById('analytics-calendar-container');
            if (!container) return;

            const isVisible = container.style.display !== 'none';
            container.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                // Initialize calendar months
                analyticsDateRange.calendarMonth1 = new Date();
                analyticsDateRange.calendarMonth2 = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1);
                renderAnalyticsCalendars();
            }
        };

        window.setAnalyticsPeriod = function(period) {
            analyticsDateRange.period = period;

            // Calculate actual dates for the period
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            switch(period) {
                case 'today':
                    analyticsDateRange.startDate = new Date(today);
                    analyticsDateRange.endDate = new Date(today);
                    break;
                case 'week':
                    // Start of week (Sunday)
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    analyticsDateRange.startDate = startOfWeek;
                    analyticsDateRange.endDate = new Date(today);
                    break;
                case 'month':
                    // Start of current month
                    analyticsDateRange.startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    analyticsDateRange.endDate = new Date(today);
                    break;
                case 'quarter':
                    // Last 3 months
                    const threeMonthsAgo = new Date(today);
                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                    analyticsDateRange.startDate = threeMonthsAgo;
                    analyticsDateRange.endDate = new Date(today);
                    break;
                case 'year':
                    // Start of current year
                    analyticsDateRange.startDate = new Date(today.getFullYear(), 0, 1);
                    analyticsDateRange.endDate = new Date(today);
                    break;
                default:
                    analyticsDateRange.startDate = null;
                    analyticsDateRange.endDate = null;
            }

            // Close calendar if open
            const container = document.getElementById('analytics-calendar-container');
            if (container) container.style.display = 'none';

            // Re-render analytics with new period (don't auto-load)
            renderAnalytics();
            // NOTE: Auto-load removed - user must click Apply
        };

        // Handle period selection from dropdown
        window.setAnalyticsPeriodFromSelect = function(period) {
            analyticsDateRange.period = period;

            // Show/hide custom date range section
            const customRangeEl = document.getElementById('analytics-custom-range');
            if (customRangeEl) {
                customRangeEl.style.display = period === 'custom' ? 'flex' : 'none';
            }

            // If not custom, calculate dates and load data
            if (period !== 'custom') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                switch(period) {
                    case 'today':
                        analyticsDateRange.startDate = new Date(today);
                        analyticsDateRange.endDate = new Date(today);
                        break;
                    case 'week':
                        const startOfWeek = new Date(today);
                        startOfWeek.setDate(today.getDate() - today.getDay());
                        analyticsDateRange.startDate = startOfWeek;
                        analyticsDateRange.endDate = new Date(today);
                        break;
                    case 'month':
                        analyticsDateRange.startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        analyticsDateRange.endDate = new Date(today);
                        break;
                    case 'quarter':
                        const threeMonthsAgo = new Date(today);
                        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                        analyticsDateRange.startDate = threeMonthsAgo;
                        analyticsDateRange.endDate = new Date(today);
                        break;
                    case 'year':
                        analyticsDateRange.startDate = new Date(today.getFullYear(), 0, 1);
                        analyticsDateRange.endDate = new Date(today);
                        break;
                }

                // Update subtitle with new date range
                const subtitleEl = document.querySelector('.page-header .section-subtitle');
                if (subtitleEl && analyticsDateRange.startDate && analyticsDateRange.endDate) {
                    const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    subtitleEl.textContent = `${formatDate(analyticsDateRange.startDate)} - ${formatDate(analyticsDateRange.endDate)}`;
                }

                // NOTE: Auto-load removed - user must click Apply
            }
        };

        // Handle custom date range changes
        window.updateCustomDateRange = function() {
            const startInput = document.getElementById('analytics-start-date');
            const endInput = document.getElementById('analytics-end-date');

            if (startInput && startInput.value) {
                analyticsDateRange.startDate = new Date(startInput.value + 'T00:00:00');
            }
            if (endInput && endInput.value) {
                analyticsDateRange.endDate = new Date(endInput.value + 'T00:00:00');
            }

            // Update subtitle
            const subtitleEl = document.querySelector('.page-header .section-subtitle');
            if (subtitleEl && analyticsDateRange.startDate && analyticsDateRange.endDate) {
                const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                subtitleEl.textContent = `${formatDate(analyticsDateRange.startDate)} - ${formatDate(analyticsDateRange.endDate)}`;
            }
        };

        // Quick date range buttons for custom range
        window.setQuickDateRange = function(range) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;
            let period = range; // Map range to period for API

            switch(range) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    period = 'today';
                    break;
                case 'yesterday':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 1);
                    endDate = new Date(startDate);
                    period = 'custom'; // Yesterday uses custom range
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    endDate = new Date(today);
                    period = 'week';
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today);
                    period = 'month';
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today);
                    period = 'year';
                    break;
                default:
                    return;
            }

            // Update state
            analyticsDateRange.startDate = startDate;
            analyticsDateRange.endDate = endDate;
            analyticsDateRange.period = period;

            // Update the input fields
            const startInput = document.getElementById('analytics-start-date');
            const endInput = document.getElementById('analytics-end-date');
            if (startInput) startInput.value = startDate.toISOString().split('T')[0];
            if (endInput) endInput.value = endDate.toISOString().split('T')[0];

            // Update subtitle
            const subtitleEl = document.querySelector('.page-header .section-subtitle');
            if (subtitleEl) {
                const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                subtitleEl.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            }

            // Update buttons
            const startBtn = document.getElementById('analytics-start-btn');
            const endBtn = document.getElementById('analytics-end-btn');
            if (startBtn) startBtn.innerHTML = `<i class="fas fa-calendar" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--accent-primary); font-size: 14px;"></i>${startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            if (endBtn) endBtn.innerHTML = `<i class="fas fa-calendar-check" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #10b981; font-size: 14px;"></i>${endDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;

            // Update dropdown if exists
            const periodSelect = document.getElementById('analytics-period-select');
            if (periodSelect) {
                periodSelect.value = period;
            }

            // Log selection (don't auto-load - user must click Apply)
            console.log(`üìÖ [QUICK SELECT] ${range} -> period: ${period}, dates: ${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]}`);
            // NOTE: Auto-load removed - user must click Apply
        };

        // Custom Calendar Popup State
        let customCalendarState = {
            isOpen: false,
            type: 'start', // 'start' or 'end'
            viewMonth: new Date().getMonth(),
            viewYear: new Date().getFullYear()
        };

        // Open custom calendar popup
        window.openCustomCalendar = function(type) {
            customCalendarState.type = type;
            customCalendarState.isOpen = true;

            // Set view month based on current selection
            const currentDate = type === 'start' ? analyticsDateRange.startDate : analyticsDateRange.endDate;
            if (currentDate) {
                customCalendarState.viewMonth = currentDate.getMonth();
                customCalendarState.viewYear = currentDate.getFullYear();
            } else {
                customCalendarState.viewMonth = new Date().getMonth();
                customCalendarState.viewYear = new Date().getFullYear();
            }

            renderCustomCalendarPopup();
        };

        // Render the custom calendar popup
        function renderCustomCalendarPopup() {
            // Remove existing popup
            const existing = document.getElementById('custom-calendar-popup');
            if (existing) existing.remove();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            const year = customCalendarState.viewYear;
            const month = customCalendarState.viewMonth;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const selectedDate = customCalendarState.type === 'start' ? analyticsDateRange.startDate : analyticsDateRange.endDate;

            let daysHtml = '';
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                daysHtml += '<div style="width: 36px; height: 36px;"></div>';
            }
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.getTime() === today.getTime();
                const isSelected = selectedDate && date.getTime() === new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate()).getTime();
                const isFuture = date > today;
                const isDisabled = isFuture;

                daysHtml += `
                    <div onclick="${isDisabled ? '' : `selectCalendarDate(${year}, ${month}, ${day})`}"
                         style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
                                border-radius: 10px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'}; font-weight: 500; font-size: 14px;
                                background: ${isSelected ? 'linear-gradient(135deg, #6366f1, #8b5cf6)' : isToday ? 'rgba(99, 102, 241, 0.15)' : 'transparent'};
                                color: ${isSelected ? 'white' : isDisabled ? 'var(--text-muted)' : isToday ? '#6366f1' : 'var(--text-primary)'};
                                opacity: ${isDisabled ? '0.4' : '1'};
                                transition: all 0.15s;
                                ${!isDisabled && !isSelected ? 'hover: { background: var(--bg-hover); }' : ''}"
                         onmouseover="${!isDisabled && !isSelected ? "this.style.background='var(--bg-hover)'" : ''}"
                         onmouseout="${!isDisabled && !isSelected ? "this.style.background='transparent'" : ''}">
                        ${day}
                    </div>
                `;
            }

            const popup = document.createElement('div');
            popup.id = 'custom-calendar-popup';
            popup.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease;';
            popup.onclick = (e) => { if (e.target === popup) closeCustomCalendar(); };

            popup.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 20px; padding: 24px; min-width: 320px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: slideUp 0.3s ease;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">
                                Select ${customCalendarState.type === 'start' ? 'Start' : 'End'} Date
                            </div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--text-primary);">
                                ${monthNames[month]} ${year}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="navigateCalendar(-1)" style="width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-chevron-left" style="color: var(--text-secondary); font-size: 12px;"></i>
                            </button>
                            <button onclick="navigateCalendar(1)" style="width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-chevron-right" style="color: var(--text-secondary); font-size: 12px;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Day Names -->
                    <div style="display: grid; grid-template-columns: repeat(7, 36px); gap: 4px; margin-bottom: 8px; justify-content: center;">
                        ${dayNames.map(d => `<div style="width: 36px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">${d}</div>`).join('')}
                    </div>

                    <!-- Days Grid -->
                    <div style="display: grid; grid-template-columns: repeat(7, 36px); gap: 4px; justify-content: center;">
                        ${daysHtml}
                    </div>

                    <!-- Quick Actions -->
                    <div style="display: flex; gap: 8px; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                        <button onclick="selectCalendarToday()" style="flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-weight: 600; cursor: pointer; font-size: 13px;">
                            Today
                        </button>
                        <button onclick="closeCustomCalendar()" style="flex: 1; padding: 10px; border-radius: 10px; border: none; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-weight: 600; cursor: pointer; font-size: 13px;">
                            Done
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);
        }

        // Navigate calendar months
        window.navigateCalendar = function(direction) {
            customCalendarState.viewMonth += direction;
            if (customCalendarState.viewMonth > 11) {
                customCalendarState.viewMonth = 0;
                customCalendarState.viewYear++;
            } else if (customCalendarState.viewMonth < 0) {
                customCalendarState.viewMonth = 11;
                customCalendarState.viewYear--;
            }
            renderCustomCalendarPopup();
        };

        // Select a date from calendar
        window.selectCalendarDate = function(year, month, day) {
            const selectedDate = new Date(year, month, day);
            selectedDate.setHours(0, 0, 0, 0);

            if (customCalendarState.type === 'start') {
                analyticsDateRange.startDate = selectedDate;
                // Update button
                const btn = document.getElementById('analytics-start-btn');
                if (btn) btn.innerHTML = `<i class="fas fa-calendar" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--accent-primary); font-size: 14px;"></i>${selectedDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            } else {
                analyticsDateRange.endDate = selectedDate;
                // Update button
                const btn = document.getElementById('analytics-end-btn');
                if (btn) btn.innerHTML = `<i class="fas fa-calendar-check" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #10b981; font-size: 14px;"></i>${selectedDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            }

            // Update subtitle
            if (analyticsDateRange.startDate && analyticsDateRange.endDate) {
                const subtitleEl = document.querySelector('.page-header .section-subtitle');
                if (subtitleEl) {
                    const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    subtitleEl.textContent = `${formatDate(analyticsDateRange.startDate)} - ${formatDate(analyticsDateRange.endDate)}`;
                }
            }

            renderCustomCalendarPopup();
        };

        // Select today
        window.selectCalendarToday = function() {
            const today = new Date();
            selectCalendarDate(today.getFullYear(), today.getMonth(), today.getDate());
        };

        // Close calendar popup
        window.closeCustomCalendar = function() {
            customCalendarState.isOpen = false;
            const popup = document.getElementById('custom-calendar-popup');
            if (popup) popup.remove();
        };

        function renderAnalyticsCalendars() {
            const panel1 = document.getElementById('calendar-month-1');
            const panel2 = document.getElementById('calendar-month-2');
            if (!panel1 || !panel2) return;

            panel1.innerHTML = renderCalendarMonth(analyticsDateRange.calendarMonth1, 1);
            panel2.innerHTML = renderCalendarMonth(analyticsDateRange.calendarMonth2, 2);
        }

        function renderCalendarMonth(date, panelNum) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNames = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = `
                <div class="calendar-month-nav">
                    ${panelNum === 1 ? `<button class="calendar-nav-btn" onclick="navigateAnalyticsCalendar(-1)"><i class="fas fa-chevron-left"></i></button>` : '<div style="width: 28px;"></div>'}
                    <h4>${monthNames[month]} ${year}</h4>
                    ${panelNum === 2 ? `<button class="calendar-nav-btn" onclick="navigateAnalyticsCalendar(1)"><i class="fas fa-chevron-right"></i></button>` : '<div style="width: 28px;"></div>'}
                </div>
                <div class="calendar-weekdays">
                    ${dayNames.map(d => `<span class="calendar-weekday">${d}</span>`).join('')}
                </div>
                <div class="calendar-days">
            `;

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="calendar-day empty"></div>`;
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);

                let classes = ['calendar-day'];

                // Check if today
                if (currentDate.getTime() === today.getTime()) {
                    classes.push('today');
                }

                // Check if selected start
                if (analyticsDateRange.startDate && currentDate.getTime() === analyticsDateRange.startDate.getTime()) {
                    classes.push('selected', 'range-start');
                }

                // Check if selected end
                if (analyticsDateRange.endDate && currentDate.getTime() === analyticsDateRange.endDate.getTime()) {
                    classes.push('selected', 'range-end');
                }

                // Check if in range
                if (analyticsDateRange.startDate && analyticsDateRange.endDate &&
                    currentDate > analyticsDateRange.startDate && currentDate < analyticsDateRange.endDate) {
                    classes.push('in-range');
                }

                // Check if temp selection (while selecting)
                if (analyticsDateRange.isSelecting && analyticsDateRange.tempStartDate) {
                    if (currentDate.getTime() === analyticsDateRange.tempStartDate.getTime()) {
                        classes.push('selected', 'range-start');
                    }
                }

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                html += `<div class="${classes.join(' ')}" data-date="${dateStr}" onclick="selectAnalyticsDate('${dateStr}')">${day}</div>`;
            }

            html += `</div>`;
            return html;
        }

        window.navigateAnalyticsCalendar = function(direction) {
            // Move both months by direction
            analyticsDateRange.calendarMonth1 = new Date(
                analyticsDateRange.calendarMonth1.getFullYear(),
                analyticsDateRange.calendarMonth1.getMonth() + direction,
                1
            );
            analyticsDateRange.calendarMonth2 = new Date(
                analyticsDateRange.calendarMonth2.getFullYear(),
                analyticsDateRange.calendarMonth2.getMonth() + direction,
                1
            );
            renderAnalyticsCalendars();
        };

        window.selectAnalyticsDate = function(dateStr) {
            const selectedDate = new Date(dateStr + 'T00:00:00');

            if (!analyticsDateRange.startDate || (analyticsDateRange.startDate && analyticsDateRange.endDate)) {
                // Start new selection
                analyticsDateRange.startDate = selectedDate;
                analyticsDateRange.endDate = null;
                analyticsDateRange.isSelecting = true;
                analyticsDateRange.tempStartDate = selectedDate;
            } else if (analyticsDateRange.startDate && !analyticsDateRange.endDate) {
                // Complete selection
                if (selectedDate < analyticsDateRange.startDate) {
                    // If selected date is before start, swap
                    analyticsDateRange.endDate = analyticsDateRange.startDate;
                    analyticsDateRange.startDate = selectedDate;
                } else {
                    analyticsDateRange.endDate = selectedDate;
                }
                analyticsDateRange.isSelecting = false;
                analyticsDateRange.tempStartDate = null;
            }

            // Update display
            updateDateRangeDisplay();
            renderAnalyticsCalendars();
        };

        function updateDateRangeDisplay() {
            const display = document.getElementById('selected-range-display');
            if (!display) return;

            const formatDateDisplay = (date) => {
                if (!date) return '';
                return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
            };

            if (analyticsDateRange.startDate && analyticsDateRange.endDate) {
                display.textContent = `${formatDateDisplay(analyticsDateRange.startDate)} ‚Üí ${formatDateDisplay(analyticsDateRange.endDate)}`;
            } else if (analyticsDateRange.startDate) {
                display.textContent = `${formatDateDisplay(analyticsDateRange.startDate)} ‚Üí Select end date`;
            } else {
                display.textContent = 'Select date range';
            }
        }

        window.clearAnalyticsDateRange = function() {
            analyticsDateRange.startDate = null;
            analyticsDateRange.endDate = null;
            analyticsDateRange.isSelecting = false;
            analyticsDateRange.tempStartDate = null;
            updateDateRangeDisplay();
            renderAnalyticsCalendars();
        };

        window.applyAnalyticsDateRange = function() {
            if (!analyticsDateRange.startDate || !analyticsDateRange.endDate) {
                alert('Please select both start and end dates');
                return;
            }

            analyticsDateRange.period = 'custom';

            // Close calendar
            const container = document.getElementById('analytics-calendar-container');
            if (container) container.style.display = 'none';

            // Re-render analytics (don't auto-load - user must click Apply)
            renderAnalytics();
            // NOTE: Auto-load removed - user must click Apply
        };

        // Close calendar when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.getElementById('analytics-calendar-container');
            const customBtn = document.querySelector('.analytics-period-btn.custom');
            if (container && container.style.display !== 'none') {
                if (!container.contains(e.target) && e.target !== customBtn && !customBtn?.contains(e.target)) {
                    container.style.display = 'none';
                }
            }
        });

        function renderStores() {
            const stores = [
                { name: 'VSU Miramar', address: '8250 Camino Santa Fe, San Diego, CA 92121', manager: 'Marcus Rodriguez', employees: 6, status: 'open', isHQ: true },
                { name: 'VSU Morena', address: '5050 Morena Blvd, San Diego, CA 92117', manager: 'Sarah Kim', employees: 5, status: 'open', isHQ: false },
                { name: 'VSU Kearny Mesa', address: '4747 Convoy St, San Diego, CA 92111', manager: 'James Thompson', employees: 5, status: 'open', isHQ: false },
                { name: 'VSU Chula Vista', address: '555 Broadway, Chula Vista, CA 91910', manager: 'Amanda Lopez', employees: 4, status: 'open', isHQ: false },
                { name: 'VSU North Park', address: '3000 University Ave, San Diego, CA 92104', manager: 'Pending', employees: 3, status: 'open', isHQ: false }
            ];

            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Store Management</h2>
                        <p class="section-subtitle">Manage your VSU locations</p>
                    </div>
                </div>

                <div class="stores-grid">
                    ${stores.map(store => `
                        <div class="store-card ${store.isHQ ? 'hq' : ''}">
                            ${store.isHQ ? '<div class="hq-badge">HEADQUARTERS</div>' : ''}
                            <div class="store-card-header">
                                <h3>${store.name}</h3>
                                <span class="store-status ${store.status}">${store.status}</span>
                            </div>
                            <div class="store-card-body">
                                <div class="store-info-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${store.address}</span>
                                </div>
                                <div class="store-info-row">
                                    <i class="fas fa-user-tie"></i>
                                    <span>Manager: ${store.manager}</span>
                                </div>
                                <div class="store-info-row">
                                    <i class="fas fa-users"></i>
                                    <span>${store.employees} Employees</span>
                                </div>
                            </div>
                            <div class="store-card-footer">
                                <button class="btn-secondary">View Details</button>
                                <button class="btn-icon"><i class="fas fa-edit"></i></button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAnnouncements() {
            const dashboard = document.querySelector('.dashboard');

            // Get current user for author info
            const user = authManager.getCurrentUser();
            const authorName = user?.name || user?.email?.split('@')[0] || 'Unknown';
            const authorInitials = authorName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Announcements</h2>
                        <p class="section-subtitle">Company-wide communications</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-announcement')">
                            <i class="fas fa-plus"></i> New Announcement
                        </button>
                    </div>
                </div>

                <div class="announcements-list">
                    <div class="announcement-card" style="border: 2px dashed var(--border-color); background: var(--bg-secondary);">
                        <div class="announcement-card-header">
                            <div class="announcement-author">
                                <div class="author-avatar">${authorInitials}</div>
                                <div class="author-info">
                                    <span class="author-name">${authorName}</span>
                                    <span class="announcement-date">New Announcement</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <input type="text" class="form-input" id="new-announcement-title" placeholder="Announcement title..." style="font-size: 16px; font-weight: 600;">
                        </div>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <textarea class="form-input" id="new-announcement-content" placeholder="Write your announcement here..." style="min-height: 80px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; justify-content: flex-end;">
                            <button class="btn-primary" onclick="saveAnnouncementInline()">
                                <i class="fas fa-paper-plane"></i> Post Announcement
                            </button>
                        </div>
                    </div>

                    ${announcements.map(ann => {
                        const annAuthorInitials = (ann.author || 'UN').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        const annId = ann.firestoreId || ann.id;
                        return `
                        <div class="announcement-card" data-id="${annId}">
                            <div class="announcement-card-header">
                                <div class="announcement-author">
                                    <div class="author-avatar">${annAuthorInitials}</div>
                                    <div class="author-info">
                                        <span class="author-name">${ann.author}</span>
                                        <span class="announcement-date">${formatDate(ann.date)}</span>
                                    </div>
                                </div>
                                <div class="announcement-actions">
                                    <button class="btn-icon" onclick="editAnnouncement('${annId}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn-icon danger" onclick="deleteAnnouncement('${annId}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <h3 class="announcement-title">${ann.title}</h3>
                            <p class="announcement-content">${ann.content}</p>
                            ${ann.targetStores && ann.targetStores !== 'all' ? `<div class="announcement-stores" style="margin-top: 8px; font-size: 12px; color: var(--text-muted);"><i class="fas fa-store"></i> ${ann.targetStores}</div>` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        /**
         * Delete announcement from Firebase
         */
        function deleteAnnouncement(announcementId) {
            const announcement = announcements.find(a => a.id === announcementId || a.firestoreId === announcementId);
            const title = announcement?.title || 'this announcement';

            showConfirmModal({
                title: 'Delete Announcement',
                message: `Are you sure you want to delete "${title}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        if (firebaseAnnouncementsManager.isInitialized) {
                            const success = await firebaseAnnouncementsManager.deleteAnnouncement(announcementId);
                            if (success) {
                                // Reload announcements from Firebase
                                const updatedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                                announcements = updatedAnnouncements || [];
                                console.log('Announcement deleted from Firebase');
                            }
                        } else {
                            // Fallback to local deletion
                            announcements = announcements.filter(a => a.id !== announcementId && a.firestoreId !== announcementId);
                        }

                        renderAnnouncements();
                        updateAnnouncementsBadge();
                        populateAnnouncementsDropdown();
                    } catch (error) {
                        console.error('Error deleting announcement:', error);
                    }
                }
            });
        }

        /**
         * Edit announcement - opens modal with pre-filled data
         */
        function editAnnouncement(announcementId) {
            const announcement = announcements.find(a => a.id === announcementId || a.firestoreId === announcementId);
            if (!announcement) {
                alert('Announcement not found');
                return;
            }

            // Open modal with edit content
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Edit Announcement</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" class="form-input" id="edit-announcement-title" value="${announcement.title}" placeholder="Announcement title...">
                    </div>
                    <div class="form-group">
                        <label>Message *</label>
                        <textarea class="form-input" id="edit-announcement-content" rows="5" placeholder="Write your announcement...">${announcement.content}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Target Stores</label>
                        <select class="form-input" id="edit-announcement-stores">
                            <option value="all" ${announcement.targetStores === 'all' ? 'selected' : ''}>All Stores</option>
                            <option value="Miramar" ${announcement.targetStores === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                            <option value="Morena" ${announcement.targetStores === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                            <option value="Kearny Mesa" ${announcement.targetStores === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                            <option value="Chula Vista" ${announcement.targetStores === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                            <option value="North Park" ${announcement.targetStores === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                            <option value="Santee" ${announcement.targetStores === 'Santee' ? 'selected' : ''}>VSU Santee</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn-primary" onclick="updateAnnouncement('${announcementId}')">Update Announcement</button>
                </div>
            `;

            modal.classList.add('active');
        }

        /**
         * Update announcement in Firebase
         */
        async function updateAnnouncement(announcementId) {
            const title = document.getElementById('edit-announcement-title').value;
            const content = document.getElementById('edit-announcement-content').value;
            const targetStores = document.getElementById('edit-announcement-stores').value;

            if (!title || !content) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                if (firebaseAnnouncementsManager.isInitialized) {
                    const success = await firebaseAnnouncementsManager.updateAnnouncement(announcementId, {
                        title,
                        content,
                        targetStores
                    });
                    if (success) {
                        // Reload announcements from Firebase
                        const updatedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                        if (updatedAnnouncements && updatedAnnouncements.length > 0) {
                            announcements = updatedAnnouncements;
                        }
                        console.log('Announcement updated in Firebase');
                    }
                } else {
                    // Fallback to local update
                    const index = announcements.findIndex(a => a.id === announcementId || a.firestoreId === announcementId);
                    if (index !== -1) {
                        announcements[index] = { ...announcements[index], title, content, targetStores };
                    }
                }

                closeModal();
                renderAnnouncements();
                updateAnnouncementsBadge();
                populateAnnouncementsDropdown();
            } catch (error) {
                console.error('Error updating announcement:', error);
                alert('Failed to update announcement. Please try again.');
            }
        }

        // ==========================================
        // CLOCK IN/OUT FUNCTIONALITY
        // ==========================================

        // Clock In attendance records storage
        let clockinAttendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        let currentClockAction = '';
        let clockInterval = null;
        let clockPollingInterval = null; // For real-time AJAX polling

        // ==========================================
        // GEOFENCING FUNCTIONS FOR CLOCK IN/OUT
        // ==========================================

        /**
         * Get user's current location
         * @returns {Promise<{latitude: number, longitude: number, accuracy: number}>}
         */
        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by this browser'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        let errorMessage;
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location permission denied. Please enable location access.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information is unavailable.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out.';
                                break;
                            default:
                                errorMessage = 'An unknown error occurred getting location.';
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });
        }

        /**
         * Calculate distance between two coordinates using Haversine formula
         * @param {number} lat1 - Latitude of point 1
         * @param {number} lon1 - Longitude of point 1
         * @param {number} lat2 - Latitude of point 2
         * @param {number} lon2 - Longitude of point 2
         * @returns {number} Distance in meters
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        /**
         * Check if user is within store geofence
         * @param {string} storeName - Name of the store
         * @param {number} userLat - User's latitude
         * @param {number} userLon - User's longitude
         * @returns {{isWithinGeofence: boolean, distance: number, storeLocation: object}}
         */
        function checkGeofence(storeName, userLat, userLon) {
            const storeLocations = window.STORE_LOCATIONS || {};

            // Try to find the store location with flexible matching
            let storeLocation = storeLocations[storeName];
            let matchedStoreName = storeName;

            // If not found directly, try to match by partial name or variations
            if (!storeLocation) {
                const normalizedStoreName = storeName.toLowerCase().replace('vsu ', '').trim();

                for (const [key, location] of Object.entries(storeLocations)) {
                    const normalizedKey = key.toLowerCase().replace('vsu ', '').trim();
                    const normalizedLocationName = (location.name || '').toLowerCase().replace('vsu ', '').trim();

                    if (normalizedKey === normalizedStoreName ||
                        normalizedLocationName === normalizedStoreName ||
                        normalizedKey.includes(normalizedStoreName) ||
                        normalizedStoreName.includes(normalizedKey)) {
                        storeLocation = location;
                        matchedStoreName = key;
                        console.log(`üìç Matched store "${storeName}" to "${key}"`);
                        break;
                    }
                }
            }

            if (!storeLocation) {
                console.warn(`Store location not configured for: ${storeName}`);
                return {
                    isWithinGeofence: true, // Allow if store not configured
                    distance: 0,
                    storeLocation: null,
                    storeName: storeName,
                    error: 'Store location not configured'
                };
            }

            const distance = calculateDistance(
                userLat, userLon,
                storeLocation.latitude, storeLocation.longitude
            );

            const radius = storeLocation.radius || window.GEOFENCE_CONFIG?.defaultRadius || 100;
            const isWithinGeofence = distance <= radius;

            return {
                isWithinGeofence,
                distance: Math.round(distance),
                radius,
                storeLocation,
                storeName: matchedStoreName
            };
        }

        /**
         * Verify location for clock in/out
         * @param {string} storeName - Store to check against
         * @returns {Promise<{allowed: boolean, location: object, geofenceResult: object, message: string}>}
         */
        async function verifyClockLocation(storeName) {
            const geofenceConfig = window.GEOFENCE_CONFIG || { enabled: false };

            // If geofencing is disabled, still try to record location if configured
            if (!geofenceConfig.enabled && !geofenceConfig.recordLocationAlways) {
                return {
                    allowed: true,
                    location: null,
                    geofenceResult: null,
                    message: 'Geofencing disabled'
                };
            }

            try {
                const location = await getCurrentLocation();
                const geofenceResult = checkGeofence(storeName, location.latitude, location.longitude);

                // Get display name for store
                const displayStoreName = geofenceResult.storeLocation?.name || geofenceResult.storeName || storeName;

                if (geofenceResult.error === 'Store location not configured') {
                    // Store location not set up - allow but note it
                    return {
                        allowed: true,
                        location,
                        geofenceResult,
                        warning: true,
                        message: `Store "${displayStoreName}" location not configured. Location recorded.`
                    };
                }

                if (geofenceResult.isWithinGeofence) {
                    return {
                        allowed: true,
                        location,
                        geofenceResult,
                        message: `Location verified - you're at ${displayStoreName} (${geofenceResult.distance}m)`
                    };
                } else {
                    // Outside geofence
                    if (geofenceConfig.strictMode) {
                        return {
                            allowed: false,
                            location,
                            geofenceResult,
                            message: `You are ${geofenceResult.distance}m away from ${displayStoreName}. Must be within ${geofenceResult.radius}m to clock in.`
                        };
                    } else {
                        // Non-strict mode: warn but allow
                        return {
                            allowed: true,
                            location,
                            geofenceResult,
                            warning: true,
                            message: `Warning: You're ${geofenceResult.distance}m away from your assigned store (${displayStoreName}). This will be recorded.`
                        };
                    }
                }
            } catch (error) {
                console.error('Location error:', error);

                // If we can't get location
                if (geofenceConfig.strictMode) {
                    return {
                        allowed: false,
                        location: null,
                        geofenceResult: null,
                        message: `Location required: ${error.message}`
                    };
                } else {
                    return {
                        allowed: true,
                        location: null,
                        geofenceResult: null,
                        warning: true,
                        message: `Could not verify location: ${error.message}`
                    };
                }
            }
        }

        /**
         * Format location for display
         * @param {object} locationData - Location data from clock record
         * @returns {string} Formatted location string
         */
        function formatLocationDisplay(locationData) {
            if (!locationData) return 'No location data';

            let display = '';
            if (locationData.isWithinGeofence) {
                display = `<span style="color: var(--success);"><i class="fas fa-map-marker-alt"></i> At store (${locationData.distance}m)</span>`;
            } else {
                display = `<span style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Off-site (${locationData.distance}m away)</span>`;
            }
            return display;
        }

        function renderClockIn() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">
                            Clock In/Out
                            <span style="
                                display: inline-flex;
                                align-items: center;
                                gap: 6px;
                                padding: 4px 12px;
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                border-radius: 20px;
                                font-size: 12px;
                                font-weight: 600;
                                color: white;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-left: 12px;
                                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                            ">
                                <span style="
                                    width: 8px;
                                    height: 8px;
                                    background: white;
                                    border-radius: 50%;
                                    animation: pulse-live 2s infinite;
                                "></span>
                                Live
                            </span>
                        </h2>
                        <p class="section-subtitle">Real-time employee attendance tracking</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <div class="search-filter">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search employees..." id="attendanceSearch" onkeyup="filterAttendanceSearch()">
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes pulse-live {
                        0%, 100% {
                            opacity: 1;
                            transform: scale(1);
                        }
                        50% {
                            opacity: 0.5;
                            transform: scale(1.2);
                        }
                    }
                </style>

                <!-- Current Time Display -->
                <div class="time-display-card">
                    <div class="current-time">
                        <div class="time-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="time-info">
                            <div class="current-date" id="currentDate">Loading...</div>
                            <div class="current-clock" id="currentClock">00:00:00 AM</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Clock Actions -->
                <div class="clock-quick-actions">
                    <button class="clock-action-btn clock-in" onclick="showClockModal('in')">
                        <div class="action-icon">
                            <i class="fas fa-sign-in-alt"></i>
                        </div>
                        <span>Clock In</span>
                    </button>
                    <button class="clock-action-btn lunch-start" onclick="showClockModal('lunch-start')">
                        <div class="action-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <span>Start Lunch</span>
                    </button>
                    <button class="clock-action-btn lunch-end" onclick="showClockModal('lunch-end')">
                        <div class="action-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <span>End Lunch</span>
                    </button>
                    <button class="clock-action-btn clock-out" onclick="showClockModal('out')">
                        <div class="action-icon">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                        <span>Clock Out</span>
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="attendance-stats-grid">
                    <div class="attendance-stat-card">
                        <div class="stat-icon-container clocked-in">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="clockedInCount">0</div>
                            <div class="stat-label">Clocked In</div>
                        </div>
                    </div>
                    <div class="attendance-stat-card">
                        <div class="stat-icon-container on-lunch">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="onLunchCount">0</div>
                            <div class="stat-label">On Lunch</div>
                        </div>
                    </div>
                    <div class="attendance-stat-card">
                        <div class="stat-icon-container clocked-out">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="clockedOutCount">0</div>
                            <div class="stat-label">Clocked Out</div>
                        </div>
                    </div>
                    <div class="attendance-stat-card">
                        <div class="stat-icon-container total">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="totalEmployeesCount">0</div>
                            <div class="stat-label">Total Employees</div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-clipboard-list"></i>
                            Today's Attendance
                        </h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button class="btn-secondary" onclick="exportAttendance()">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                            <button class="card-action" onclick="refreshAttendance()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="loadingAttendance" class="loading-state">
                            <div class="spinner"></div>
                            <span>Loading attendance...</span>
                        </div>
                        <div id="attendanceTableContainer" style="display: none;">
                            <table class="attendance-table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Store</th>
                                        <th>Clock In</th>
                                        <th>Lunch Start</th>
                                        <th>Lunch End</th>
                                        <th>Clock Out</th>
                                        <th>Total Hours</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div id="emptyAttendanceState" class="empty-state" style="display: none;">
                            <i class="fas fa-clipboard"></i>
                            <h3>No attendance records today</h3>
                            <p>Records will appear here once employees clock in</p>
                        </div>
                    </div>
                </div>
            `;

            // Initialize clock and load data
            initializeClockIn();
        }

        function initializeClockIn() {
            updateClockDisplay();
            // Clear any existing intervals
            if (clockInterval) clearInterval(clockInterval);
            if (clockPollingInterval) clearInterval(clockPollingInterval);

            // Update clock display every second
            clockInterval = setInterval(updateClockDisplay, 1000);

            // Load initial data
            loadAttendanceData();

            // Start real-time polling for clock records (every 5 seconds)
            startClockInPolling();
        }

        /**
         * Start real-time AJAX polling to check for new clock in/out records
         */
        function startClockInPolling() {
            // Clear any existing polling interval
            if (clockPollingInterval) {
                clearInterval(clockPollingInterval);
            }

            // Poll every 5 seconds for real-time updates
            clockPollingInterval = setInterval(async () => {
                await pollForClockUpdates();
            }, 5000);

        }

        /**
         * Stop real-time polling
         */
        function stopClockInPolling() {
            if (clockPollingInterval) {
                clearInterval(clockPollingInterval);
                clockPollingInterval = null;
                console.log('‚èπÔ∏è Real-time clock in/out polling stopped');
            }
        }

        /**
         * Poll Firebase for clock record updates
         */
        async function pollForClockUpdates() {
            try {
                // Use local date (not UTC) for consistency
                const today = new Date();
                const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                // Initialize Firebase if needed
                if (!firebaseClockInManager.isInitialized) {
                    await firebaseClockInManager.initialize();
                }

                // Load latest records from Firebase
                const firebaseRecords = await firebaseClockInManager.loadClockRecordsByDate(dateString);

                if (firebaseRecords.length > 0) {
                    const today = new Date().toDateString();
                    let hasUpdates = false;

                    // Check if there are any new or updated records
                    firebaseRecords.forEach(fbRecord => {
                        const localRecord = clockinAttendanceRecords.find(r =>
                            r.employeeName === fbRecord.employeeName && r.date === today
                        );

                        // Check if record is new or has been updated
                        if (!localRecord ||
                            localRecord.clockIn !== fbRecord.clockIn ||
                            localRecord.lunchStart !== fbRecord.lunchStart ||
                            localRecord.lunchEnd !== fbRecord.lunchEnd ||
                            localRecord.clockOut !== fbRecord.clockOut) {
                            hasUpdates = true;
                        }
                    });

                    // If updates detected, refresh the display
                    if (hasUpdates) {
                        console.log('üîÑ New clock in/out updates detected, refreshing...');

                        // Update local records
                        const updatedRecords = [];
                        const processedNames = new Set();

                        firebaseRecords.forEach(rec => {
                            processedNames.add(rec.employeeName);
                            updatedRecords.push({
                                id: rec.id || Date.now(),
                                employeeId: rec.employeeId,
                                employeeName: rec.employeeName,
                                employeeRole: rec.employeeRole,
                                employeeInitials: rec.employeeName?.substring(0, 2).toUpperCase() || '',
                                store: rec.store,
                                date: today,
                                clockIn: rec.clockIn || null,
                                lunchStart: rec.lunchStart || null,
                                lunchEnd: rec.lunchEnd || null,
                                clockOut: rec.clockOut || null,
                                notes: rec.notes || ''
                            });
                        });

                        // Add any local-only records
                        clockinAttendanceRecords.forEach(localRec => {
                            if (!processedNames.has(localRec.employeeName) && localRec.date === today) {
                                updatedRecords.push(localRec);
                            }
                        });

                        clockinAttendanceRecords = updatedRecords;
                        localStorage.setItem('attendanceRecords', JSON.stringify(clockinAttendanceRecords));

                        // Update UI with visual feedback
                        showRealtimeUpdateNotification();
                        updateClockInUI();
                    }
                }
            } catch (error) {
                // Silently fail to avoid console spam
                console.debug('Polling update check failed:', error);
            }
        }

        /**
         * Update Clock In UI elements
         */
        function updateClockInUI() {
            const today = new Date().toDateString();
            const todayRecords = clockinAttendanceRecords.filter(r => r.date === today);

            const tableContainer = document.getElementById('attendanceTableContainer');
            const emptyState = document.getElementById('emptyAttendanceState');

            if (todayRecords.length === 0) {
                if (tableContainer) tableContainer.style.display = 'none';
                if (emptyState) emptyState.style.display = 'flex';
            } else {
                if (tableContainer) tableContainer.style.display = 'block';
                if (emptyState) emptyState.style.display = 'none';
                renderAttendanceTableRows(todayRecords);
            }

            updateAttendanceStats(todayRecords);
        }

        /**
         * Show real-time update notification
         */
        function showRealtimeUpdateNotification() {
            // Create a subtle notification indicator
            const refreshBtn = document.querySelector('.card-action');
            if (refreshBtn && refreshBtn.innerHTML.includes('Refresh')) {
                // Add a pulsing dot to indicate new data
                const originalHTML = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-sync" style="color: var(--accent-primary);"></i> Updated';
                refreshBtn.style.color = 'var(--accent-primary)';

                // Reset after 2 seconds
                setTimeout(() => {
                    refreshBtn.innerHTML = originalHTML;
                    refreshBtn.style.color = '';
                }, 2000);
            }
        }

        function updateClockDisplay() {
            const now = new Date();
            const dateEl = document.getElementById('currentDate');
            const clockEl = document.getElementById('currentClock');

            if (!dateEl || !clockEl) return;

            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateEl.textContent = now.toLocaleDateString('en-US', options);

            // Format time
            let hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;

            clockEl.textContent = `${padZeroTime(hours)}:${padZeroTime(minutes)}:${padZeroTime(seconds)} ${ampm}`;
        }

        function padZeroTime(num) {
            return num.toString().padStart(2, '0');
        }

        function showClockModal(action) {
            // No modal - directly submit with current user and time
            submitClockAction(action);
        }

        function closeClockModal() {
            // Not needed anymore, but kept for compatibility
        }

        async function submitClockAction(action = null) {
            // Use the action passed as parameter if available
            if (action) {
                currentClockAction = action;
            }

            // Get current logged-in user
            const currentUser = getCurrentUser();
            
            if (!currentUser || (!currentUser.userId && !currentUser.id)) {
                console.error('No user logged in');
                showNotification('Error: No user logged in', 'error');
                return;
            }

            // Get current time in HH:MM format
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const time = `${hours}:${minutes}`;

            // Get employee info from current user
            // Priority: Name (main identifier) -> ID -> Email -> Create fallback
            let employee = null;
            
            // 1. First try to find by NAME (this is the primary identifier to avoid duplicates)
            if (currentUser.name) {
                employee = employees.find(e => e.name === currentUser.name);
            }
            
            // 2. If not found by name, try by ID
            if (!employee) {
                const userId = currentUser.userId || currentUser.id;
                if (userId) {
                    employee = employees.find(e => String(e.id) === String(userId));
                }
            }

            // 3. If still not found, try by authEmail
            if (!employee && currentUser.email) {
                employee = employees.find(e => e.authEmail === currentUser.email);
            }

            // 4. If still not found, create a minimal employee object
            if (!employee) {
                const userId = currentUser.userId || currentUser.id;
                console.warn('‚ö†Ô∏è Employee not found in database, creating fallback record');
                employee = {
                    id: userId,
                    name: currentUser.name || 'Current User',
                    role: currentUser.role || 'Employee',
                    initials: (currentUser.name || 'CU')?.substring(0, 2).toUpperCase() || 'CU',
                    store: currentUser.store || 'VSU Miramar',
                    email: currentUser.email
                };
            }

            const store = employee.store || 'VSU Miramar';

            // ==========================================
            // GEOFENCE VERIFICATION (DISABLED)
            // ==========================================
            // Geofencing has been disabled for simplicity
            let locationData = null;

            // Format date as YYYY-MM-DD for consistency (use local date, not UTC)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`; // YYYY-MM-DD format (local time)
            const dateDisplayString = today.toDateString();

            // Find record by EMPLOYEE NAME (primary identifier to avoid duplicates)
            let record = clockinAttendanceRecords.find(r => r.employeeName === employee.name && r.date === dateDisplayString);

            // Create new record if doesn't exist
            if (!record) {
                record = {
                    id: Date.now(),
                    employeeId: employee.id,
                    employeeName: employee.name,
                    employeeRole: employee.role,
                    employeeInitials: employee.initials || employee.name?.substring(0, 2).toUpperCase() || '',
                    store: store,
                    date: dateDisplayString,
                    clockIn: null,
                    lunchStart: null,
                    lunchEnd: null,
                    clockOut: null,
                    notes: ''
                };
                clockinAttendanceRecords.push(record);
            } else {
                // Update existing record's store
                if (store) record.store = store;
            }

            // Update record based on action
            switch(currentClockAction) {
                case 'in':
                    if (record.clockIn) {
                        console.warn('Employee already clocked in today');
                        showNotification('You are already clocked in', 'warning');
                        return;
                    }
                    record.clockIn = time;
                    console.log('‚è±Ô∏è Clocking in:', record.employeeName, 'at', time);
                    break;
                case 'lunch-start':
                    if (!record.clockIn) {
                        console.warn('Lunch start attempted without clock in');
                        showNotification('Please clock in first', 'warning');
                        return;
                    }
                    if (record.lunchStart) {
                        console.warn('Lunch break already started');
                        showNotification('Lunch break already started', 'warning');
                        return;
                    }
                    record.lunchStart = time;
                    console.log('üçΩÔ∏è Lunch start:', record.employeeName, 'at', time);
                    break;
                case 'lunch-end':
                    if (!record.lunchStart) {
                        console.warn('Lunch break not started yet');
                        showNotification('Lunch break not started yet', 'warning');
                        return;
                    }
                    if (record.lunchEnd) {
                        console.warn('Lunch break already ended');
                        showNotification('Lunch break already ended', 'warning');
                        return;
                    }
                    record.lunchEnd = time;
                    console.log('üçΩÔ∏è Lunch end:', record.employeeName, 'at', time);
                    break;
                case 'out':
                    if (!record.clockIn) {
                        console.warn('Clock out attempted without clock in');
                        showNotification('Please clock in first', 'warning');
                        return;
                    }
                    if (record.clockOut) {
                        console.warn('Employee already clocked out today');
                        showNotification('You are already clocked out', 'warning');
                        return;
                    }
                    record.clockOut = time;
                    console.log('‚è±Ô∏è Clocking out:', record.employeeName, 'at', time);
                    break;
            }

            // Save to localStorage
            localStorage.setItem('attendanceRecords', JSON.stringify(clockinAttendanceRecords));

            // Save to Firebase
            try {
                // Initialize Firebase Clock In Manager if not already done
                if (!firebaseClockInManager.isInitialized) {
                    await firebaseClockInManager.initialize();
                }

                // Prepare clock record for Firebase
                // Use firestoreId if available for better matching with employees collection
                const firebaseRecord = {
                    employeeId: employee.firestoreId || employee.id,
                    employeeName: employee.name,
                    employeeRole: employee.role,
                    store: store,
                    date: dateString, // YYYY-MM-DD format (local time)
                    clockIn: record.clockIn,
                    lunchStart: record.lunchStart,
                    lunchEnd: record.lunchEnd,
                    clockOut: record.clockOut,
                    notes: record.notes || ''
                };

                // Add location data based on action type
                if (locationData) {
                    const actionLocationKey = `${currentClockAction}Location`;
                    firebaseRecord[actionLocationKey] = locationData;

                    // Also store the most recent location for easy access
                    firebaseRecord.lastLocation = locationData;
                    firebaseRecord.lastLocationAction = currentClockAction;
                }

                // Save to Firebase
                await firebaseClockInManager.saveClockRecord(firebaseRecord);
                
                // Reload from Firebase immediately to sync state across devices/reloads
                try {
                    const updatedRecords = await firebaseClockInManager.loadClockRecordsByDate(dateString);
                    
                    if (updatedRecords.length > 0) {
                        // Update local records with Firebase data
                        const today = new Date().toDateString();
                        const updatedArray = [];
                        const processedNames = new Set();
                        
                        updatedRecords.forEach(rec => {
                            processedNames.add(rec.employeeName);
                            updatedArray.push({
                                id: rec.id || Date.now(),
                                employeeId: rec.employeeId,
                                employeeName: rec.employeeName,
                                employeeRole: rec.employeeRole,
                                employeeInitials: rec.employeeName?.substring(0, 2).toUpperCase() || '',
                                store: rec.store,
                                date: today,
                                clockIn: rec.clockIn || null,
                                lunchStart: rec.lunchStart || null,
                                lunchEnd: rec.lunchEnd || null,
                                clockOut: rec.clockOut || null,
                                notes: rec.notes || ''
                            });
                        });
                        
                        // Add any local-only records
                        clockinAttendanceRecords.forEach(localRec => {
                            if (!processedNames.has(localRec.employeeName) && localRec.date === today) {
                                updatedArray.push(localRec);
                            }
                        });
                        
                        clockinAttendanceRecords = updatedArray;
                        localStorage.setItem('attendanceRecords', JSON.stringify(clockinAttendanceRecords));
                    }
                } catch (reloadError) {
                    console.warn('‚ö†Ô∏è Could not reload from Firebase after save:', reloadError);
                }
            } catch (error) {
                console.error('‚ö†Ô∏è Error saving to Firebase:', error);
                // Don't prevent saving to localStorage if Firebase fails
                // The user will still see success message but data is local only
            }

            // Show success message and reload
            showNotification('Action recorded successfully!', 'success');
            
            // Reload attendance table
            setTimeout(() => {
                loadAttendanceData();
            }, 500);
        }

        async function loadAttendanceData() {
            const todayDate = new Date();
            const today = todayDate.toDateString();
            // Use local date (not UTC) for consistency with Schedule page
            const dateString = `${todayDate.getFullYear()}-${String(todayDate.getMonth() + 1).padStart(2, '0')}-${String(todayDate.getDate()).padStart(2, '0')}`;
            
            const loadingDiv = document.getElementById('loadingAttendance');
            const tableContainer = document.getElementById('attendanceTableContainer');
            const emptyState = document.getElementById('emptyAttendanceState');

            if (!loadingDiv) return;

            // Show loading
            loadingDiv.style.display = 'flex';
            tableContainer.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                // Initialize Firebase Clock In Manager if not already done
                if (!firebaseClockInManager.isInitialized) {
                    await firebaseClockInManager.initialize();
                }

                // Try to load from Firebase first
                let firebaseRecords = [];
                try {
                    firebaseRecords = await firebaseClockInManager.loadClockRecordsByDate(dateString);
                    
                    // Merge Firebase records with local records intelligently
                    if (firebaseRecords.length > 0) {
                        // Create a map of Firebase records by EMPLOYEE NAME (primary identifier)
                        const firebaseMap = {};
                        firebaseRecords.forEach(rec => {
                            firebaseMap[rec.employeeName] = rec;
                        });
                        
                        // Update or add records
                        const updatedRecords = [];
                        const processedNames = new Set();
                        
                        // First, process Firebase records (they're latest)
                        firebaseRecords.forEach(rec => {
                            processedNames.add(rec.employeeName);
                            updatedRecords.push({
                                id: rec.id || Date.now(),
                                employeeId: rec.employeeId,
                                employeeName: rec.employeeName,
                                employeeRole: rec.employeeRole,
                                employeeInitials: rec.employeeName?.substring(0, 2).toUpperCase() || '',
                                store: rec.store,
                                date: today, // Use display format for local tracking
                                clockIn: rec.clockIn || null,
                                lunchStart: rec.lunchStart || null,
                                lunchEnd: rec.lunchEnd || null,
                                clockOut: rec.clockOut || null,
                                notes: rec.notes || ''
                            });
                        });
                        
                        // Then, add any local-only records
                        clockinAttendanceRecords.forEach(localRec => {
                            if (!processedNames.has(localRec.employeeName) && localRec.date === today) {
                                updatedRecords.push(localRec);
                            }
                        });
                        
                        clockinAttendanceRecords = updatedRecords;
                        // Save merged data to localStorage for fallback
                        localStorage.setItem('attendanceRecords', JSON.stringify(clockinAttendanceRecords));
                    }
                } catch (firebaseError) {
                    console.warn('‚ö†Ô∏è Could not load from Firebase, using local data:', firebaseError);
                    // Fall back to localStorage - filter only today's records
                    clockinAttendanceRecords = clockinAttendanceRecords.filter(r => r.date === today);
                }
            } catch (error) {
                console.error('Error in loadAttendanceData:', error);
            }

            // Get today's records
            const todayRecords = clockinAttendanceRecords.filter(r => r.date === today);

            // Simulate loading delay
            setTimeout(() => {
                loadingDiv.style.display = 'none';

                if (todayRecords.length === 0) {
                    emptyState.style.display = 'flex';
                } else {
                    tableContainer.style.display = 'block';
                    renderAttendanceTableRows(todayRecords);
                }

                updateAttendanceStats(todayRecords);
            }, 300);
        }

        function renderAttendanceTableRows(records) {
            const tableBody = document.getElementById('attendanceTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = records.map(record => {
                const status = getAttendanceStatus(record);
                const totalHours = calculateAttendanceTotalHours(record);
                const locationDisplay = getLocationDisplayForRecord(record);

                return `
                    <tr>
                        <td>
                            <div class="employee-table-info">
                                <div class="employee-table-avatar">${record.employeeInitials}</div>
                                <div class="employee-table-details">
                                    <div class="employee-table-name">${record.employeeName}</div>
                                    <div class="employee-table-role">${record.employeeRole}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="store-badge">${record.store}</span></td>
                        <td><span class="time-cell ${!record.clockIn ? 'empty' : ''}">${record.clockIn || '-'}</span></td>
                        <td><span class="time-cell ${!record.lunchStart ? 'empty' : ''}">${record.lunchStart || '-'}</span></td>
                        <td><span class="time-cell ${!record.lunchEnd ? 'empty' : ''}">${record.lunchEnd || '-'}</span></td>
                        <td><span class="time-cell ${!record.clockOut ? 'empty' : ''}">${record.clockOut || '-'}</span></td>
                        <td><span class="total-hours">${totalHours}</span></td>
                        <td>${locationDisplay}</td>
                        <td><span class="status-badge ${status.class}">${status.text}</span></td>
                        <td>
                            <button class="table-action-btn" onclick="viewAttendanceDetails('${record.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get location display HTML for attendance record
         * @param {object} record - Attendance record
         * @returns {string} HTML for location display
         */
        function getLocationDisplayForRecord(record) {
            // Check for location data (check inLocation first, then lastLocation)
            const locationData = record.inLocation || record.lastLocation;

            if (!locationData) {
                return '<span style="color: var(--text-muted); font-size: 12px;"><i class="fas fa-question-circle"></i> N/A</span>';
            }

            if (locationData.isWithinGeofence === true) {
                return `<span style="color: var(--success); font-size: 12px;" title="Distance: ${locationData.distance}m">
                    <i class="fas fa-map-marker-alt"></i> At store
                </span>`;
            } else if (locationData.isWithinGeofence === false) {
                return `<span style="color: var(--danger); font-size: 12px;" title="Distance: ${locationData.distance}m from store">
                    <i class="fas fa-exclamation-triangle"></i> Off-site (${locationData.distance}m)
                </span>`;
            } else if (locationData.latitude && locationData.longitude) {
                return `<span style="color: var(--warning); font-size: 12px;" title="Lat: ${locationData.latitude.toFixed(4)}, Lon: ${locationData.longitude.toFixed(4)}">
                    <i class="fas fa-map-pin"></i> Recorded
                </span>`;
            }

            return '<span style="color: var(--text-muted); font-size: 12px;"><i class="fas fa-question-circle"></i> Unknown</span>';
        }

        function getAttendanceStatus(record) {
            if (record.clockOut) {
                return { text: 'Clocked Out', class: 'clocked-out' };
            }
            if (record.lunchStart && !record.lunchEnd) {
                return { text: 'On Lunch', class: 'on-lunch' };
            }
            if (record.clockIn) {
                return { text: 'Clocked In', class: 'clocked-in' };
            }
            return { text: 'Not Started', class: 'not-started' };
        }

        function calculateAttendanceTotalHours(record) {
            if (!record.clockIn) return '-';

            const clockIn = parseAttendanceTime(record.clockIn);
            const clockOut = record.clockOut ? parseAttendanceTime(record.clockOut) : new Date();

            let totalMinutes = (clockOut - clockIn) / 1000 / 60;

            // Subtract lunch time if applicable
            if (record.lunchStart && record.lunchEnd) {
                const lunchStart = parseAttendanceTime(record.lunchStart);
                const lunchEnd = parseAttendanceTime(record.lunchEnd);
                const lunchMinutes = (lunchEnd - lunchStart) / 1000 / 60;
                totalMinutes -= lunchMinutes;
            }

            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);

            return `${hours}h ${minutes}m`;
        }

        function parseAttendanceTime(timeString) {
            const today = new Date();
            const [hours, minutes] = timeString.split(':');
            today.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return today;
        }

        function updateAttendanceStats(records) {
            const clockedInCount = records.filter(r => r.clockIn && !r.clockOut).length;
            const onLunchCount = records.filter(r => r.lunchStart && !r.lunchEnd).length;
            const clockedOutCount = records.filter(r => r.clockOut).length;

            const clockedInEl = document.getElementById('clockedInCount');
            const onLunchEl = document.getElementById('onLunchCount');
            const clockedOutEl = document.getElementById('clockedOutCount');
            const totalEl = document.getElementById('totalEmployeesCount');

            if (clockedInEl) clockedInEl.textContent = clockedInCount;
            if (onLunchEl) onLunchEl.textContent = onLunchCount;
            if (clockedOutEl) clockedOutEl.textContent = clockedOutCount;
            if (totalEl) totalEl.textContent = employees.length;
        }

        function viewAttendanceDetails(recordId) {
            const record = clockinAttendanceRecords.find(r => r.id === recordId);
            if (!record) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            const status = getAttendanceStatus(record);
            const totalHours = calculateAttendanceTotalHours(record);

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-clock" style="color: var(--accent-primary);"></i>
                        Attendance Details
                    </h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Employee Info Header -->
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700;">
                            ${record.employeeName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 4px; font-size: 18px; font-weight: 600;">${record.employeeName}</h3>
                            <div style="font-size: 14px; color: var(--text-muted);">
                                <span style="margin-right: 16px;"><i class="fas fa-briefcase"></i> ${record.employeeRole || 'Employee'}</span>
                                <span><i class="fas fa-store"></i> ${record.store}</span>
                            </div>
                        </div>
                        <span class="status-badge" style="background: ${status.color}20; color: ${status.color}; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
                            ${status.text}
                        </span>
                    </div>

                    <!-- Date and Total Hours -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                <i class="fas fa-calendar"></i> Date
                            </div>
                            <div style="font-size: 18px; font-weight: 600;">${record.date}</div>
                        </div>
                        <div style="padding: 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">
                                <i class="fas fa-hourglass-half"></i> Total Hours
                            </div>
                            <div style="font-size: 24px; font-weight: 700;">${totalHours}</div>
                        </div>
                    </div>

                    <!-- Time Details -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;">
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #10b981;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Clock In</div>
                            <div style="font-size: 16px; font-weight: 600; color: #10b981;">${record.clockIn || '-'}</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Lunch Start</div>
                            <div style="font-size: 16px; font-weight: 600; color: #f59e0b;">${record.lunchStart || '-'}</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Lunch End</div>
                            <div style="font-size: 16px; font-weight: 600; color: #f59e0b;">${record.lunchEnd || '-'}</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #ef4444;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Clock Out</div>
                            <div style="font-size: 16px; font-weight: 600; color: #ef4444;">${record.clockOut || '-'}</div>
                        </div>
                    </div>

                    ${record.notes ? `
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                                <i class="fas fa-sticky-note"></i> Notes
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">${record.notes}</div>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;

            modal.classList.add('active');
        }

        function refreshAttendance() {
            loadAttendanceData();
        }

        function exportAttendance() {
            const today = new Date().toDateString();
            const todayRecords = clockinAttendanceRecords.filter(r => r.date === today);

            if (todayRecords.length === 0) {
                alert('No attendance records to export');
                return;
            }

            // Create CSV content
            let csv = 'Employee,Role,Store,Clock In,Lunch Start,Lunch End,Clock Out,Total Hours,Status\n';

            todayRecords.forEach(record => {
                const status = getAttendanceStatus(record);
                const totalHours = calculateAttendanceTotalHours(record);

                csv += `"${record.employeeName}","${record.employeeRole}","${record.store}",`;
                csv += `"${record.clockIn || '-'}","${record.lunchStart || '-'}","${record.lunchEnd || '-'}",`;
                csv += `"${record.clockOut || '-'}","${totalHours}","${status.text}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function filterAttendanceSearch() {
            const searchInput = document.getElementById('attendanceSearch');
            if (!searchInput) return;

            const searchTerm = searchInput.value.toLowerCase();
            const today = new Date().toDateString();
            let records = clockinAttendanceRecords.filter(r => r.date === today);

            if (searchTerm) {
                records = records.filter(r =>
                    r.employeeName.toLowerCase().includes(searchTerm) ||
                    r.employeeRole.toLowerCase().includes(searchTerm) ||
                    r.store.toLowerCase().includes(searchTerm)
                );
            }

            renderAttendanceTableRows(records);
            updateAttendanceStats(records);
        }

        // ==========================================
        // END CLOCK IN/OUT FUNCTIONALITY
        // ==========================================

        function renderNewStuff() {
            const dashboard = document.querySelector('.dashboard');

            // Show loading state
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">New Stuff</h2>
                        <p class="section-subtitle">Incoming products and inventory</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-product')">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 16px;"></i>
                    <p>Loading products from Firebase...</p>
                </div>
            `;

            // Load products from Firebase
            loadProductsFromFirebase().then(() => {
                dashboard.innerHTML = `
                    <div class="page-header">
                        <div class="page-header-left">
                            <h2 class="section-title">New Stuff</h2>
                            <p class="section-subtitle">Incoming products</p>
                        </div>
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-product')">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>

                    ${products.length === 0 ? `
                        <div style="text-align: center; padding: 60px 20px; background: var(--bg-hover); border-radius: 12px;">
                            <i class="fas fa-box-open" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;"></i>
                            <h3 style="color: var(--text-secondary);">No Products Yet</h3>
                            <p style="color: var(--text-muted); margin-bottom: 20px;">Add your first product to get started</p>
                            <button class="btn-primary floating-add-btn" onclick="openModal('add-product')">
                                <i class="fas fa-plus"></i> Add First Product
                            </button>
                        </div>
                    ` : `
                        <div class="employees-grid">
                            ${products.map(product => `
                                <div class="card" onclick="viewProductDetails('${product.id}')" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
                                    ${product.image ? `
                                        <div class="product-image-container" style="position: relative; width: 100%; height: 180px; overflow: hidden; border-radius: 12px 12px 0 0;">
                                            <img src="${product.image}"
                                                 alt="${product.name}"
                                                 style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;"
                                                 onerror="this.parentElement.style.display='none'">
                                        </div>
                                    ` : ''}
                                    <div class="card-header" style="background: rgba(139, 92, 246, 0.1); border-radius: ${product.image ? '0' : '12px 12px 0 0'};">
                                        <h3 class="card-title" style="font-size: 16px; font-weight: 600;">
                                            ${product.name}
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                                <span style="color: var(--text-muted); font-size: 13px;">Category:</span>
                                                <span style="font-weight: 600; font-size: 13px;">${product.category || '-'}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                                <span style="color: var(--text-muted); font-size: 13px;">Est. Price:</span>
                                                <span style="font-weight: 600; font-size: 13px; color: var(--success);">$${product.price || 0}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                                <span style="color: var(--text-muted); font-size: 13px;">Est. Arrival:</span>
                                                <span style="font-weight: 600; font-size: 13px;">${product.arrivalDate ? formatDate(product.arrivalDate) : '-'}</span>
                                            </div>
                                            ${product.url ? `
                                                <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                                                    <span style="color: var(--text-muted); font-size: 13px;">More Info:</span>
                                                    <a href="${product.url}" target="_blank" onclick="event.stopPropagation();" style="font-weight: 600; font-size: 13px; color: var(--accent-primary); text-decoration: none;">
                                                        <i class="fas fa-external-link-alt"></i> View
                                                    </a>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="card-footer" style="padding: 12px 16px; border-top: 1px solid var(--border-color); text-align: center;">
                                        <span style="color: var(--text-muted); font-size: 12px;">
                                            <i class="fas fa-hand-pointer"></i> Click to view details
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                `;
            });
        }

        function viewProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; gap: 12px; margin: 0;">
                        <i class="fas fa-box" style="color: var(--accent-primary); font-size: 24px;"></i>
                        Product Details
                    </h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    ${product.image ? `
                        <div style="
                            margin-bottom: 24px;
                            border-radius: 16px;
                            overflow: hidden;
                            background: var(--bg-secondary);
                            position: relative;
                            aspect-ratio: 16 / 10;
                        ">
                            <img 
                                src="${product.image}" 
                                alt="${product.name}" 
                                style="
                                    width: 100%;
                                    height: 100%;
                                    object-fit: cover;
                                    display: block;
                                " 
                                onerror="this.style.display='none'">
                        </div>
                    ` : `
                        <div style="
                            margin-bottom: 24px;
                            border-radius: 16px;
                            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                            height: 200px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-image" style="font-size: 48px; color: rgba(255,255,255,0.5);"></i>
                        </div>
                    `}

                    <div style="margin-bottom: 24px;">
                        <h3 style="
                            margin: 0 0 8px 0;
                            font-size: 24px;
                            font-weight: 700;
                            color: var(--text-primary);
                        ">${product.name}</h3>
                        <p style="
                            margin: 0;
                            color: var(--text-muted);
                            font-size: 14px;
                        ">Product Reference ID: #${product.id}</p>
                    </div>

                    <div style="
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 16px;
                        margin-bottom: 24px;
                    ">
                        <!-- Category -->
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                            transition: all 0.2s ease;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">Category</div>
                            <div style="
                                font-weight: 600;
                                font-size: 15px;
                                color: var(--text-primary);
                            ">${product.category || '-'}</div>
                        </div>

                        <!-- Estimated Price -->
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                            transition: all 0.2s ease;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">Estimated Price</div>
                            <div style="
                                font-weight: 600;
                                font-size: 18px;
                                color: var(--success);
                            ">$${(product.price || 0).toFixed(2)}</div>
                        </div>

                        <!-- Estimated Arrival -->
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">
                                <i class="fas fa-calendar" style="margin-right: 6px; font-size: 12px;"></i>Estimated Arrival
                            </div>
                            <div style="
                                font-weight: 600;
                                font-size: 15px;
                                color: var(--text-primary);
                            ">${product.arrivalDate ? formatDate(product.arrivalDate) : '-'}</div>
                        </div>

                        <!-- Supplier -->
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">
                                <i class="fas fa-truck" style="margin-right: 6px; font-size: 12px;"></i>Supplier
                            </div>
                            <div style="
                                font-weight: 600;
                                font-size: 15px;
                                color: var(--text-primary);
                            ">${product.supplier || '-'}</div>
                        </div>
                    </div>

                    ${product.url ? `
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                            margin-bottom: 24px;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 8px;
                            ">
                                <i class="fas fa-link" style="margin-right: 6px; font-size: 12px;"></i>Product URL
                            </div>
                            <a href="${product.url}" target="_blank" style="
                                font-weight: 600;
                                font-size: 14px;
                                color: var(--accent-primary);
                                text-decoration: none;
                                word-break: break-all;
                            ">${product.url} <i class="fas fa-external-link-alt" style="margin-left: 6px; font-size: 12px;"></i></a>
                        </div>
                    ` : ''}

                    ${product.description ? `
                        <div style="
                            background: var(--bg-secondary);
                            border: 1px solid var(--border-color);
                            border-radius: 14px;
                            padding: 16px;
                            margin-bottom: 24px;
                        ">
                            <div style="
                                color: var(--text-muted);
                                font-size: 11px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 12px;
                            ">Description</div>
                            <p style="
                                margin: 0;
                                line-height: 1.6;
                                color: var(--text-secondary);
                                font-size: 14px;
                            ">${product.description}</p>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" style="
                            flex: 1;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            padding: 12px 16px;
                            border-radius: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            border: none;
                            transition: all 0.2s ease;
                        " onclick="closeModal(); editProduct('${product.id}');">
                            <i class="fas fa-edit"></i>
                            Edit Product
                        </button>
                        <button style="
                            flex: 1;
                            background: var(--danger);
                            color: white;
                            border: none;
                            padding: 12px 16px;
                            border-radius: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                        " onclick="deleteProductFromFirebase('${product.id}'); closeModal();" onhover="this.style.opacity='0.9'">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        // =====================================================
        // SUPPLIES MODULE
        // =====================================================

        let suppliesData = [];
        let suppliesCurrentStore = 'all';
        let suppliesCurrentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
        let suppliesViewMode = 'gallery'; // 'gallery' or 'list'

        async function initializeSupplies() {
            if (!firebaseStorageHelper.isInitialized) {
                firebaseStorageHelper.initialize();
            }
            await loadSuppliesFromFirebase();
        }

        async function loadSuppliesFromFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    const snapshot = await db.collection('supplies').get();
                    suppliesData = [];
                    snapshot.forEach(doc => {
                        suppliesData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading supplies:', error);
            }
        }

        async function saveSupplyToFirebase(supply) {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    const docRef = await db.collection('supplies').add({
                        ...supply,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return docRef.id;
                }
            } catch (error) {
                console.error('Error saving supply:', error);
                return null;
            }
        }

        async function updateSupplyInFirebase(id, data) {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    await db.collection('supplies').doc(id).update(data);
                    return true;
                }
            } catch (error) {
                console.error('Error updating supply:', error);
                return false;
            }
        }

        async function deleteSupplyFromFirebase(id) {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    await db.collection('supplies').doc(id).delete();
                    return true;
                }
            } catch (error) {
                console.error('Error deleting supply:', error);
                return false;
            }
        }

        window.renderSupplies = async function() {
            const dashboard = document.querySelector('.dashboard');

            // Show loading state
            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Supplies</h2>
                        <p class="section-subtitle">Track everyday supplies needed per store</p>
                    </div>
                </div>
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading supplies...</p>
                </div>
            `;

            // Load data
            await loadSuppliesFromFirebase();

            // Get stores list (VSU locations + other stores)
            const vsuStores = ['Miramar', 'Morena', 'Kearny Mesa', 'Chula Vista', 'North Park'];
            const otherStores = ['Loyal Vaper', 'Miramar Wine & Liquor'];

            // Filter supplies by store and month
            const filteredSupplies = suppliesData.filter(s => {
                const matchStore = suppliesCurrentStore === 'all' || s.store === suppliesCurrentStore;
                const itemMonth = s.createdAt?.toDate ? s.createdAt.toDate().toISOString().slice(0, 7) : s.month || suppliesCurrentMonth;
                const matchMonth = itemMonth === suppliesCurrentMonth;
                return matchStore && matchMonth;
            });

            // Separate pending and purchased
            const pendingSupplies = filteredSupplies.filter(s => s.status === 'pending');
            const purchasedSupplies = filteredSupplies.filter(s => s.status === 'purchased');

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Supplies</h2>
                        <p class="section-subtitle">Track everyday supplies needed per store</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('add-supply')">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>

                <!-- Filters -->
                <div class="filters-bar" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <select class="filter-select" id="supplies-store-filter" onchange="filterSuppliesByStore(this.value)">
                            <option value="all" ${suppliesCurrentStore === 'all' ? 'selected' : ''}>All Stores</option>
                            ${vsuStores.map(store => `
                                <option value="${store}" ${suppliesCurrentStore === store ? 'selected' : ''}>VSU ${store}</option>
                            `).join('')}
                            ${otherStores.map(store => `
                                <option value="${store}" ${suppliesCurrentStore === store ? 'selected' : ''}>${store}</option>
                            `).join('')}
                        </select>
                        <input type="month" class="form-input" id="supplies-month-filter" value="${suppliesCurrentMonth}" onchange="filterSuppliesByMonth(this.value)" style="width: auto;">
                    </div>
                    <div style="display: flex; gap: 4px; background: var(--bg-secondary); padding: 4px; border-radius: 8px;">
                        <button onclick="setSuppliesViewMode('gallery')" style="padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; background: ${suppliesViewMode === 'gallery' ? 'var(--accent-primary)' : 'transparent'}; color: ${suppliesViewMode === 'gallery' ? 'white' : 'var(--text-secondary)'}; transition: all 0.2s;">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button onclick="setSuppliesViewMode('list')" style="padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; background: ${suppliesViewMode === 'list' ? 'var(--accent-primary)' : 'transparent'}; color: ${suppliesViewMode === 'list' ? 'white' : 'var(--text-secondary)'}; transition: all 0.2s;">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value">${pendingSupplies.length}</span>
                            <span class="stat-label">Pending Items</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value">${purchasedSupplies.length}</span>
                            <span class="stat-label">Purchased This Month</span>
                        </div>
                    </div>
                </div>

                <!-- Pending Items -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-shopping-cart"></i> Pending Items (${pendingSupplies.length})</h3>
                    </div>
                    <div class="card-body">
                        ${pendingSupplies.length > 0 ? (suppliesViewMode === 'gallery' ? `
                            <!-- Gallery View -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                                ${pendingSupplies.map(item => `
                                    <div class="supply-card" style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                                        <div style="height: 100px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); display: flex; align-items: center; justify-content: center; position: relative;">
                                            <i class="fas fa-box-open" style="font-size: 40px; color: white; opacity: 0.9;"></i>
                                            <div style="position: absolute; top: 12px; right: 12px; background: #f59e0b; color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                                                <i class="fas fa-clock"></i> Pending
                                            </div>
                                            <div style="position: absolute; bottom: 12px; left: 12px; background: rgba(0,0,0,0.5); color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                                Qty: ${item.quantity}
                                            </div>
                                        </div>
                                        <div style="padding: 16px;">
                                            <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">${item.name}</h3>
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                                <span style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                                                    <i class="fas fa-store"></i> ${item.store}
                                                </span>
                                            </div>
                                            ${item.addedBy ? `<div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;"><i class="fas fa-user"></i> ${item.addedBy}</div>` : ''}
                                            <div style="display: flex; gap: 8px;">
                                                <button onclick="markSupplyPurchased('${item.id}')" style="flex: 1; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                                    <i class="fas fa-check"></i> Purchased
                                                </button>
                                                <button onclick="deleteSupply('${item.id}')" style="padding: 10px 14px; background: var(--bg-tertiary); color: #ef4444; border: none; border-radius: 8px; cursor: pointer;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <!-- List View -->
                            <div class="supplies-list">
                                ${pendingSupplies.map(item => `
                                    <div class="supply-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-box" style="color: white;"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">${item.name}</div>
                                                <div style="font-size: 12px; color: var(--text-muted);">
                                                    Qty: ${item.quantity} ‚Ä¢ ${item.store}
                                                    ${item.addedBy ? ` ‚Ä¢ Added by ${item.addedBy}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-icon" onclick="markSupplyPurchased('${item.id}')" title="Mark as Purchased" style="color: #10b981;">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn-icon" onclick="deleteSupply('${item.id}')" title="Delete" style="color: #ef4444;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `) : `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                                <p>No pending items. All caught up!</p>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Purchased History -->
                <div class="card">
                    <div class="card-header" style="cursor: pointer;" onclick="togglePurchasedHistory()">
                        <h3 class="card-title"><i class="fas fa-history"></i> Purchased History (${purchasedSupplies.length})</h3>
                        <i class="fas fa-chevron-down" id="purchased-history-chevron"></i>
                    </div>
                    <div class="card-body" id="purchased-history-body" style="display: none;">
                        ${purchasedSupplies.length > 0 ? `
                            <div class="supplies-list">
                                ${purchasedSupplies.map(item => `
                                    <div class="supply-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; opacity: 0.8;">
                                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                            <div style="width: 40px; height: 40px; background: #10b981; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-check" style="color: white;"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600; text-decoration: line-through; color: var(--text-muted);">${item.name}</div>
                                                <div style="font-size: 12px; color: var(--text-muted);">
                                                    Qty: ${item.quantity} ‚Ä¢ ${item.store}
                                                    ${item.purchasedAt ? ` ‚Ä¢ Purchased ${formatDate(item.purchasedAt.toDate ? item.purchasedAt.toDate() : item.purchasedAt)}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn-icon" onclick="deleteSupply('${item.id}')" title="Delete" style="color: var(--text-muted);">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                <p>No purchased items this month.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        window.togglePurchasedHistory = function() {
            const body = document.getElementById('purchased-history-body');
            const chevron = document.getElementById('purchased-history-chevron');
            if (body && chevron) {
                if (body.style.display === 'none') {
                    body.style.display = 'block';
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    body.style.display = 'none';
                    chevron.style.transform = 'rotate(0deg)';
                }
            }
        }

        window.filterSuppliesByStore = function(store) {
            suppliesCurrentStore = store;
            renderSupplies();
        }

        window.filterSuppliesByMonth = function(month) {
            suppliesCurrentMonth = month;
            renderSupplies();
        }

        window.setSuppliesViewMode = function(mode) {
            suppliesViewMode = mode;
            renderSupplies();
        }

        window.addSupply = async function() {
            const name = document.getElementById('supply-name').value.trim();
            const quantity = parseInt(document.getElementById('supply-quantity').value) || 1;
            const store = document.getElementById('supply-store').value;

            if (!name) {
                alert('Please enter an item name');
                return;
            }

            if (!store) {
                alert('Please select a store');
                return;
            }

            const user = getCurrentUser();
            const supply = {
                name,
                quantity,
                store,
                status: 'pending',
                month: suppliesCurrentMonth,
                addedBy: user?.name || 'Unknown'
            };

            const id = await saveSupplyToFirebase(supply);
            if (id) {
                supply.id = id;
                suppliesData.push(supply);
                closeModal();
                renderSupplies();
                showNotification('Item added successfully!', 'success');
            } else {
                alert('Error adding item. Please try again.');
            }
        }

        window.markSupplyPurchased = async function(id) {
            const success = await updateSupplyInFirebase(id, {
                status: 'purchased',
                purchasedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            if (success) {
                const item = suppliesData.find(s => s.id === id);
                if (item) {
                    item.status = 'purchased';
                    item.purchasedAt = new Date();
                }
                renderSupplies();
                showNotification('Item marked as purchased!', 'success');
            }
        }

        window.deleteSupply = async function(id) {
            if (!confirm('Delete this item?')) return;

            const success = await deleteSupplyFromFirebase(id);
            if (success) {
                suppliesData = suppliesData.filter(s => s.id !== id);
                renderSupplies();
                showNotification('Item deleted', 'success');
            }
        }

// =============================================================================
// DAILY CHECKLIST MODULE
// =============================================================================

let checklistData = {
    tasks: [],      // Task templates
    completions: [] // Today's completions
};
let checklistCurrentStore = 'Miramar';
let checklistCurrentShift = 'opening'; // 'opening' or 'closing'
let checklistSelectedDate = new Date().toISOString().split('T')[0]; // Selected date for viewing

// Default tasks template
const defaultChecklistTasks = {
    opening: [
        { id: 'open-1', task: 'Unlock store and disarm alarm', order: 1 },
        { id: 'open-2', task: 'Turn on all lights and signage', order: 2 },
        { id: 'open-3', task: 'Count opening cash drawer', order: 3 },
        { id: 'open-4', task: 'Check and restock displays', order: 4 },
        { id: 'open-5', task: 'Clean front entrance and windows', order: 5 },
        { id: 'open-6', task: 'Turn on POS systems', order: 6 },
        { id: 'open-7', task: 'Review daily promotions/announcements', order: 7 },
        { id: 'open-8', task: 'Check restroom supplies', order: 8 },
        { id: 'open-9', task: 'Check bathroom', order: 9 }
    ],
    closing: [
        { id: 'close-1', task: 'Count and close cash drawer', order: 1 },
        { id: 'close-2', task: 'Complete daily sales report', order: 2 },
        { id: 'close-3', task: 'Clean and organize store', order: 3 },
        { id: 'close-4', task: 'Take out trash', order: 4 },
        { id: 'close-5', task: 'Restock shelves for next day', order: 5 },
        { id: 'close-6', task: 'Turn off POS systems', order: 6 },
        { id: 'close-7', task: 'Turn off lights and signage', order: 7 },
        { id: 'close-8', task: 'Set alarm and lock store', order: 8 },
        { id: 'close-9', task: 'Clean bathroom', order: 9 }
    ]
};

// Get today's date string
function getTodayDateString() {
    return new Date().toISOString().split('T')[0];
}

// Get day name for selected date (used for midshift)
function getCurrentDayName() {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const date = new Date(checklistSelectedDate + 'T12:00:00');
    return days[date.getDay()];
}

// Get day key for selected date - Firebase (lowercase)
function getCurrentDayKey() {
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const date = new Date(checklistSelectedDate + 'T12:00:00');
    return days[date.getDay()];
}

// Load checklist tasks - default tasks + custom tasks from Firebase
async function loadChecklistTasks() {
    const today = getTodayDateString();

    // Start with hardcoded default tasks
    const defaultTasks = [
        { id: 'open-1', task: 'Unlock store and disarm alarm', order: 1, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'open-2', task: 'Turn on all lights and signage', order: 2, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'open-3', task: 'Count opening cash drawer', order: 3, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'open-4', task: 'Check and restock displays', order: 4, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'open-5', task: 'Clean front entrance and windows', order: 5, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'open-6', task: 'Turn on POS systems', order: 6, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'open-7', task: 'Review daily promotions/announcements', order: 7, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'open-8', task: 'Check restroom supplies', order: 8, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'open-9', task: 'Check bathroom', order: 9, shift: 'opening', store: 'all', duration: 'permanent' },
        { id: 'close-1', task: 'Count and close cash drawer', order: 1, shift: 'closing', store: 'all', duration: 'permanent' },
        { id: 'close-2', task: 'Complete daily sales report', order: 2, shift: 'closing', store: 'all', duration: 'permanent' },
        { id: 'close-3', task: 'Clean and organize store', order: 3, shift: 'closing', store: 'all', duration: 'permanent' },
        { id: 'close-4', task: 'Take out trash', order: 4, shift: 'closing', store: 'all', duration: 'permanent' },
        { id: 'close-5', task: 'Restock shelves for next day', order: 5, shift: 'closing', store: 'all', duration: 'permanent' },
        { id: 'close-6', task: 'Turn off POS systems', order: 6, shift: 'closing', store: 'all', duration: 'permanent' },
        { id: 'close-7', task: 'Turn off lights and signage', order: 7, shift: 'closing', store: 'all', duration: 'permanent' },
        { id: 'close-8', task: 'Set alarm and lock store', order: 8, shift: 'closing', store: 'all', duration: 'permanent' },
        { id: 'close-9', task: 'Clean bathroom', order: 9, shift: 'closing', store: 'all', duration: 'permanent' }
    ];

    // Load custom tasks from Firebase
    try {
        const db = firebase.firestore();
        const snapshot = await db.collection('checklistTasks').get();

        // Load midshift tasks for today's day of week
        const currentDay = getCurrentDayKey();
        const midshiftSnapshot = await db.collection('midshiftTasks').where('dayOfWeek', '==', currentDay).get();
        const midshiftTasks = midshiftSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            shift: 'midshift',
            store: 'all',
            duration: 'permanent'
        }));
        const customTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Load overrides (hidden/edited default tasks)
        const overridesSnapshot = await db.collection('checklistTaskOverrides').get();
        const overrides = {};
        overridesSnapshot.docs.forEach(doc => {
            overrides[doc.id] = doc.data();
        });

        // Get default task IDs to avoid duplicates
        const defaultTaskIds = defaultTasks.map(t => t.id);

        // Filter out hidden default tasks and get replacements
        const replacedDefaultIds = new Set();
        customTasks.forEach(task => {
            if (task.replacesDefault) {
                replacedDefaultIds.add(task.replacesDefault);
            }
        });

        // Filter default tasks - exclude those that are hidden or replaced
        const activeDefaultTasks = defaultTasks.filter(task => {
            if (overrides[task.id]?.hidden) return false;
            if (replacedDefaultIds.has(task.id)) return false;
            return true;
        });

        // Filter custom tasks:
        // - Only include tasks marked as custom (isCustom: true)
        // - Exclude any that match default task IDs
        // - For one-time tasks, only include if created today
        const validCustomTasks = customTasks.filter(task => {
            // Skip if it's a default task ID or not marked as custom
            if (defaultTaskIds.includes(task.id) || !task.isCustom) {
                return false;
            }
            if (task.duration === 'one-time') {
                return task.createdDate === today;
            }
            return true; // Include permanent tasks
        });

        // Clean up expired one-time tasks (older than today)
        const expiredTasks = customTasks.filter(task =>
            task.duration === 'one-time' && task.createdDate && task.createdDate < today
        );
        for (const task of expiredTasks) {
            try {
                await db.collection('checklistTasks').doc(task.id).delete();
                console.log(`[Checklist] Cleaned up expired one-time task: ${task.task}`);
            } catch (e) {
                console.error('Error cleaning up task:', e);
            }
        }

        // Combine active default + custom tasks + midshift tasks
        checklistData.tasks = [...activeDefaultTasks, ...validCustomTasks, ...midshiftTasks];
        console.log(`[Checklist] Loaded ${activeDefaultTasks.length} default + ${validCustomTasks.length} custom + ${midshiftTasks.length} midshift tasks`);

    } catch (error) {
        console.error('Error loading custom tasks:', error);
        checklistData.tasks = defaultTasks;
    }
}

// Load completions for a specific date from Firebase
async function loadCompletionsForDate(dateString) {
    try {
        const db = firebase.firestore();
        const snapshot = await db.collection('checklistCompletions')
            .where('date', '==', dateString)
            .get();

        checklistData.completions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
        console.error('Error loading completions:', error);
        checklistData.completions = [];
    }
}

// Load today's completions from Firebase (backwards compatible)
async function loadTodayCompletions() {
    await loadCompletionsForDate(checklistSelectedDate);
}

// Navigate to a specific date
window.navigateChecklistDate = async function(dateString) {
    checklistSelectedDate = dateString;
    // Reload tasks (to get midshift tasks for the correct day of week)
    await loadChecklistTasks();
    await loadCompletionsForDate(dateString);
    renderDailyChecklist();
}

// Navigate to previous day
window.checklistPrevDay = async function() {
    const date = new Date(checklistSelectedDate);
    date.setDate(date.getDate() - 1);
    await navigateChecklistDate(date.toISOString().split('T')[0]);
}

// Navigate to next day
window.checklistNextDay = async function() {
    const date = new Date(checklistSelectedDate);
    date.setDate(date.getDate() + 1);
    // Allow going up to 14 days in the future for planning downtime tasks
    const maxDate = new Date();
    maxDate.setDate(maxDate.getDate() + 14);
    if (date <= maxDate) {
        await navigateChecklistDate(date.toISOString().split('T')[0]);
    }
}

// Navigate to today
window.checklistGoToToday = async function() {
    await navigateChecklistDate(new Date().toISOString().split('T')[0]);
}

// Format date for display
function formatChecklistDate(dateString) {
    const date = new Date(dateString + 'T12:00:00');
    const today = new Date().toISOString().split('T')[0];

    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];

    if (dateString === today) {
        return 'Today';
    } else if (dateString === yesterdayStr) {
        return 'Yesterday';
    } else if (dateString === tomorrowStr) {
        return 'Tomorrow';
    } else if (dateString > today) {
        // Future date - show day name prominently
        return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
    } else {
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
}

// Check if selected date is in the future
function isChecklistDateFuture() {
    const today = new Date().toISOString().split('T')[0];
    return checklistSelectedDate > today;
}

// Reset checklist tasks to defaults (admin function)
window.resetChecklistTasks = async function() {
    try {
        const db = firebase.firestore();

        // Delete all existing tasks
        const snapshot = await db.collection('checklistTasks').get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        console.log('Deleted', snapshot.docs.length, 'old tasks');

        // Add default tasks
        checklistData.tasks = [];
        const openingTasks = defaultChecklistTasks.opening.map(t => ({ ...t, shift: 'opening', store: 'all' }));
        const closingTasks = defaultChecklistTasks.closing.map(t => ({ ...t, shift: 'closing', store: 'all' }));

        for (const task of openingTasks) {
            const docRef = await db.collection('checklistTasks').add(task);
            checklistData.tasks.push({ ...task, id: docRef.id });
        }
        for (const task of closingTasks) {
            const docRef = await db.collection('checklistTasks').add(task);
            checklistData.tasks.push({ ...task, id: docRef.id });
        }

        console.log('Reset complete! Added', checklistData.tasks.length, 'default tasks');
        showNotification('Checklist tasks reset to defaults!', 'success');
        renderDailyChecklist();
        return true;
    } catch (error) {
        console.error('Error resetting tasks:', error);
        showNotification('Error resetting tasks', 'error');
        return false;
    }
}

// Save completion to Firebase
async function saveChecklistCompletion(taskId, store, shift, photoUrl = null) {
    try {
        const db = firebase.firestore();
        const user = getCurrentUser();
        const completion = {
            taskId,
            store,
            shift,
            date: checklistSelectedDate, // Use selected date instead of always today
            completedBy: user?.name || 'Unknown',
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            photoUrl
        };

        const docRef = await db.collection('checklistCompletions').add(completion);
        completion.id = docRef.id;
        completion.completedAt = new Date();
        checklistData.completions.push(completion);
        return true;
    } catch (error) {
        console.error('Error saving completion:', error);
        return false;
    }
}

// Remove completion from Firebase
async function removeChecklistCompletion(completionId) {
    try {
        const db = firebase.firestore();
        await db.collection('checklistCompletions').doc(completionId).delete();
        checklistData.completions = checklistData.completions.filter(c => c.id !== completionId);
        return true;
    } catch (error) {
        console.error('Error removing completion:', error);
        return false;
    }
}

// Add new task to Firebase
async function addChecklistTask(task, shift, store = 'all', duration = 'permanent') {
    try {
        const db = firebase.firestore();
        const today = getTodayDateString();
        const newTask = {
            task,
            shift,
            store,
            duration, // 'permanent' or 'one-time'
            order: checklistData.tasks.filter(t => t.shift === shift).length + 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdDate: today, // For one-time tasks, used to filter by date
            isCustom: true // Mark as user-added task
        };

        const docRef = await db.collection('checklistTasks').add(newTask);
        newTask.id = docRef.id;
        checklistData.tasks.push(newTask);
        return newTask;
    } catch (error) {
        console.error('Error adding task:', error);
        return null;
    }
}

// Delete task from Firebase
async function deleteChecklistTask(taskId) {
    try {
        const db = firebase.firestore();

        // Check if this is a default task
        const isDefaultTask = taskId.startsWith('open-') || taskId.startsWith('close-');

        // Check if this is a midshift task
        const task = checklistData.tasks.find(t => t.id === taskId);
        const isMidshiftTask = task?.shift === 'midshift';

        if (isDefaultTask) {
            // For default tasks, mark as hidden in overrides collection
            await db.collection('checklistTaskOverrides').doc(taskId).set({
                hidden: true,
                deletedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else if (isMidshiftTask) {
            // For midshift tasks, delete from midshiftTasks collection
            await db.collection('midshiftTasks').doc(taskId).delete();
        } else {
            // For custom tasks, delete from Firebase
            await db.collection('checklistTasks').doc(taskId).delete();
        }

        checklistData.tasks = checklistData.tasks.filter(t => t.id !== taskId);
        return true;
    } catch (error) {
        console.error('Error deleting task:', error);
        return false;
    }
}

// Edit task in Firebase
async function editChecklistTask(taskId, newTaskText, newShift) {
    try {
        const db = firebase.firestore();
        const task = checklistData.tasks.find(t => t.id === taskId);

        if (!task) {
            console.error('Task not found:', taskId);
            return false;
        }

        // Check if this is a default task (not in Firebase yet)
        const isDefaultTask = taskId.startsWith('open-') || taskId.startsWith('close-');

        if (isDefaultTask) {
            // For default tasks, we need to create a new custom task and hide the default
            const newTask = {
                task: newTaskText,
                shift: newShift,
                store: 'all',
                duration: 'permanent',
                order: task.order,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdDate: getTodayDateString(),
                isCustom: true,
                replacesDefault: taskId // Track which default it replaces
            };

            const docRef = await db.collection('checklistTasks').add(newTask);
            newTask.id = docRef.id;

            // Also save a record that this default task is hidden
            await db.collection('checklistTaskOverrides').doc(taskId).set({
                hidden: true,
                replacedBy: docRef.id,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update local state
            const taskIndex = checklistData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                checklistData.tasks[taskIndex] = newTask;
            }
        } else {
            // For custom tasks, just update in Firebase
            await db.collection('checklistTasks').doc(taskId).update({
                task: newTaskText,
                shift: newShift,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update local state
            const taskIndex = checklistData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                checklistData.tasks[taskIndex].task = newTaskText;
                checklistData.tasks[taskIndex].shift = newShift;
            }
        }

        return true;
    } catch (error) {
        console.error('Error editing task:', error);
        return false;
    }
}

// Open edit task modal
window.openEditTaskModal = function(taskId) {
    const task = checklistData.tasks.find(t => t.id === taskId);
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }
    openModal('edit-checklist-task', { task });
};

// Save edited task from modal
window.saveEditedChecklistTask = async function() {
    const taskId = document.getElementById('edit-checklist-task-id')?.value;
    const newTaskText = document.getElementById('edit-checklist-task-description')?.value?.trim();
    const newShift = document.getElementById('edit-checklist-task-shift')?.value;

    if (!taskId || !newTaskText) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }

    const success = await editChecklistTask(taskId, newTaskText, newShift);
    if (success) {
        showNotification('Task updated successfully!', 'success');
        closeModal();
        renderDailyChecklist();
    } else {
        showNotification('Error updating task', 'error');
    }
};

// Render Daily Checklist
window.renderDailyChecklist = async function() {
    const dashboard = document.querySelector('.dashboard');
    const user = getCurrentUser();
    const userRole = user?.role || 'employee';
    const canManageTasks = userRole === 'admin' || userRole === 'manager';

    // Show loading
    dashboard.innerHTML = `
        <div class="page-header">
            <div class="page-header-left">
                <h2 class="section-title"><i class="fas fa-clipboard-check" style="color: var(--accent-primary); margin-right: 10px;"></i>Daily Checklist</h2>
                <p class="section-subtitle">Complete your shift tasks</p>
            </div>
        </div>
        <div style="display: flex; justify-content: center; padding: 60px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--accent-primary);"></i>
        </div>
    `;

    // Load data
    await loadChecklistTasks();
    await loadTodayCompletions();

    const stores = ['Miramar', 'Morena', 'Kearny Mesa', 'Chula Vista', 'North Park'];
    const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // Filter tasks by shift and store
    const getTasksForShift = (shift) => {
        const filtered = checklistData.tasks.filter(t => t.shift === shift);
        console.log('Tasks for shift', shift, ':', filtered.length);
        return filtered.sort((a, b) => (a.order || 0) - (b.order || 0));
    };

    // Check if task is completed for a store
    const isTaskCompleted = (taskId, store, shift) => {
        return checklistData.completions.find(c =>
            c.taskId === taskId &&
            c.store === store &&
            c.shift === shift &&
            c.date === checklistSelectedDate
        );
    };

    // Get completion percentage for a store and shift
    const getCompletionPercentage = (store, shift) => {
        const tasks = getTasksForShift(shift);
        if (tasks.length === 0) return 100;
        const completed = tasks.filter(t => isTaskCompleted(t.id, store, shift)).length;
        return Math.round((completed / tasks.length) * 100);
    };

    // Build tasks HTML for a shift
    const buildTasksHtml = (shift) => {
        const tasks = getTasksForShift(shift);
        const targetStore = checklistCurrentStore;

        if (tasks.length === 0) {
            // Special empty state for midshift with examples
            if (shift === 'midshift') {
                const dayName = getCurrentDayName();
                return `<div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="fas fa-mug-hot" style="font-size: 40px; margin-bottom: 16px; color: #10b981; opacity: 0.6;"></i>
                    <p style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No downtime tasks for ${dayName}</p>
                    <p style="font-size: 13px; margin-bottom: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
                        Add tasks that change each day of the week.<br>
                        Perfect for inventory counts and weekly duties!
                    </p>
                    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: left; max-width: 350px; margin-left: auto; margin-right: auto;">
                        <p style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px;">üí° Example tasks:</p>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                            <div>‚Ä¢ <strong>Monday:</strong> Count wraps, report low stock</div>
                            <div>‚Ä¢ <strong>Tuesday:</strong> Count cones & papers</div>
                            <div>‚Ä¢ <strong>Wednesday:</strong> Count grinders</div>
                            <div>‚Ä¢ <strong>Thursday:</strong> Count glass pieces</div>
                            <div>‚Ä¢ <strong>Friday:</strong> Count vapes & batteries</div>
                        </div>
                    </div>
                    ${canManageTasks ? `<button onclick="openAddTaskModal('${shift}')" class="btn-primary" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-plus"></i> Add ${dayName} Task</button>` : ''}
                </div>`;
            }
            return `<div style="text-align: center; padding: 40px; color: var(--text-muted);">
                <i class="fas fa-clipboard" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                <p>No tasks for this shift yet</p>
                ${canManageTasks ? `<button onclick="openAddTaskModal('${shift}')" class="btn-primary" style="margin-top: 12px;"><i class="fas fa-plus"></i> Add Task</button>` : ''}
            </div>`;
        }

        return tasks.map(task => {
            const completion = isTaskCompleted(task.id, targetStore, shift);
            const isCompleted = !!completion;
            const isOneTime = task.duration === 'one-time';
            const isCustom = task.isCustom === true;

            return `
                <div class="checklist-item" onclick="toggleChecklistTask('${task.id}', '${targetStore}', '${shift}', ${isCompleted ? `'${completion?.id}'` : 'null'})"
                    style="display: flex; align-items: center; gap: 16px; padding: 18px 20px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid ${isCompleted ? '#10b981' : isOneTime ? '#f59e0b' : 'var(--accent-primary)'}; transition: all 0.2s; cursor: pointer; user-select: none;"
                    onmouseover="this.style.background='var(--bg-tertiary)'; this.style.transform='translateX(4px)';"
                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='none';">
                    <div style="width: 32px; height: 32px; border-radius: 50%; border: 3px solid ${isCompleted ? '#10b981' : 'var(--border-color)'}; background: ${isCompleted ? '#10b981' : 'transparent'}; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;">
                        ${isCompleted ? '<i class="fas fa-check" style="color: white; font-size: 14px;"></i>' : '<span style="width: 12px; height: 12px; border-radius: 50%; background: var(--border-color); opacity: 0.3;"></span>'}
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span style="font-weight: 600; font-size: 15px; ${isCompleted ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${task.task}</span>
                            ${isOneTime ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">TODAY ONLY</span>' : ''}
                            ${isCustom && !isOneTime ? '<span style="background: var(--accent-primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">CUSTOM</span>' : ''}
                        </div>
                        ${isCompleted ? `
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px; font-weight: 500;">
                                <i class="fas fa-check-circle"></i>
                                ${completion.completedBy} ‚Ä¢ ${completion.completedAt?.toDate ? completion.completedAt.toDate().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : new Date(completion.completedAt).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                        ` : `<div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">Click to complete</div>`}
                    </div>
                    ${isCompleted ? '<i class="fas fa-check-double" style="color: #10b981; font-size: 18px;"></i>' : '<i class="fas fa-circle" style="color: var(--text-muted); font-size: 8px; opacity: 0.3;"></i>'}
                    ${canManageTasks ? `
                        <div style="display: flex; gap: 4px;">
                            <button onclick="event.stopPropagation(); openEditTaskModal('${task.id}')"
                                style="width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: opacity 0.2s;"
                                onmouseover="this.style.opacity='1';" onmouseout="this.style.opacity='0.5';" title="Edit task">
                                <i class="fas fa-pen" style="color: var(--accent-primary); font-size: 13px;"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteChecklistTaskUI('${task.id}')"
                                style="width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: opacity 0.2s;"
                                onmouseover="this.style.opacity='1';" onmouseout="this.style.opacity='0.5';" title="Delete task">
                                <i class="fas fa-trash" style="color: #ef4444; font-size: 13px;"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    };

    // Store icons and colors - representing San Diego neighborhoods
    const storeIcons = {
        'Miramar': { icon: 'fa-jet-fighter', color: '#3b82f6', bg: 'linear-gradient(135deg, #dbeafe, #bfdbfe)' },
        'Morena': { icon: 'fa-water', color: '#0891b2', bg: 'linear-gradient(135deg, #cffafe, #a5f3fc)' },
        'Kearny Mesa': { icon: 'fa-bowl-food', color: '#f97316', bg: 'linear-gradient(135deg, #ffedd5, #fed7aa)' },
        'Chula Vista': { icon: 'fa-leaf', color: '#16a34a', bg: 'linear-gradient(135deg, #dcfce7, #bbf7d0)' },
        'North Park': { icon: 'fa-beer-mug-empty', color: '#a855f7', bg: 'linear-gradient(135deg, #f3e8ff, #e9d5ff)' }
    };

    // Build store progress cards for overview
    const buildStoreProgressHtml = () => {
        return stores.map(store => {
            const openingPct = getCompletionPercentage(store, 'opening');
            const closingPct = getCompletionPercentage(store, 'closing');
            const totalPct = Math.round((openingPct + closingPct) / 2);
            const storeInfo = storeIcons[store] || { icon: 'fa-store', color: '#6b7280', bg: 'var(--bg-tertiary)', label: '' };

            return `
                <div onclick="filterChecklistByStore('${store}')" style="padding: 16px; background: ${checklistCurrentStore === store ? storeInfo.bg : 'var(--bg-secondary)'}; border-radius: 16px; cursor: pointer; transition: all 0.3s; border: 3px solid ${checklistCurrentStore === store ? storeInfo.color : 'transparent'}; min-width: 160px;"
                    onmouseover="this.style.transform='translateY(-4px) scale(1.02)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.15)';"
                    onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 44px; height: 44px; border-radius: 12px; background: ${storeInfo.color}; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px ${storeInfo.color}40;">
                            <i class="fas ${storeInfo.icon}" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="font-weight: 700; font-size: 14px; color: ${checklistCurrentStore === store ? storeInfo.color : 'var(--text-primary)'};">${store}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-size: 11px; color: var(--text-muted);">Progress</div>
                        <div style="font-size: 18px; font-weight: 800; color: ${totalPct === 100 ? '#10b981' : totalPct > 50 ? '#f59e0b' : storeInfo.color};">${totalPct}%</div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <div style="flex: 1;">
                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;"><i class="fas fa-sun" style="color: #f59e0b; margin-right: 3px;"></i>AM</div>
                            <div style="height: 5px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                                <div style="width: ${openingPct}%; height: 100%; background: ${openingPct === 100 ? '#10b981' : '#f59e0b'}; border-radius: 3px; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;"><i class="fas fa-moon" style="color: #8b5cf6; margin-right: 3px;"></i>PM</div>
                            <div style="height: 5px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                                <div style="width: ${closingPct}%; height: 100%; background: ${closingPct === 100 ? '#10b981' : '#8b5cf6'}; border-radius: 3px; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    };

    dashboard.innerHTML = `
        <style>
            @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
            @keyframes twinkle { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
            @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
            @keyframes steam-rise {
                0% { opacity: 0; transform: translateX(-50%) translateY(0) scale(1); }
                50% { opacity: 0.8; transform: translateX(-50%) translateY(-8px) scale(1.2); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-16px) scale(0.8); }
            }
            @keyframes steam { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
        </style>
        <div class="page-header" style="margin-bottom: 24px;">
            <div class="page-header-left">
                <h2 class="section-title" style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-clipboard-check" style="color: white; font-size: 20px;"></i>
                    </div>
                    Daily Checklist
                </h2>
                <!-- Date Navigator -->
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                    <button onclick="checklistPrevDay()" style="width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--accent-primary)';" onmouseout="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--border-color)';">
                        <i class="fas fa-chevron-left" style="color: var(--text-primary); font-size: 12px;"></i>
                    </button>
                    <div style="position: relative;">
                        <button onclick="document.getElementById('checklist-date-picker').showPicker()" style="padding: 8px 16px; border-radius: 10px; border: 2px solid ${checklistSelectedDate === new Date().toISOString().split('T')[0] ? '#10b981' : 'var(--border-color)'}; background: ${checklistSelectedDate === new Date().toISOString().split('T')[0] ? 'rgba(16, 185, 129, 0.1)' : 'var(--bg-secondary)'}; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--text-primary); transition: all 0.2s;">
                            <i class="fas fa-calendar-alt" style="color: ${checklistSelectedDate === new Date().toISOString().split('T')[0] ? '#10b981' : 'var(--accent-primary)'};"></i>
                            <span>${formatChecklistDate(checklistSelectedDate)}</span>
                            ${checklistSelectedDate !== new Date().toISOString().split('T')[0] ? `<span style="font-size: 11px; color: var(--text-muted);">(${checklistSelectedDate})</span>` : ''}
                        </button>
                        <input type="date" id="checklist-date-picker" value="${checklistSelectedDate}" max="${(() => { const d = new Date(); d.setDate(d.getDate() + 14); return d.toISOString().split('T')[0]; })()}" onchange="navigateChecklistDate(this.value)" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                    </div>
                    <button onclick="checklistNextDay()" style="width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--accent-primary)';" onmouseout="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--border-color)';">
                        <i class="fas fa-chevron-right" style="color: var(--text-primary); font-size: 12px;"></i>
                    </button>
                    ${checklistSelectedDate !== new Date().toISOString().split('T')[0] ? `
                        <button onclick="checklistGoToToday()" style="padding: 8px 12px; border-radius: 10px; border: none; background: linear-gradient(135deg, #10b981, #059669); color: white; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)';" onmouseout="this.style.transform='scale(1)';">
                            <i class="fas fa-calendar-day"></i> Today
                        </button>
                    ` : ''}
                </div>
            </div>
            <div class="page-header-right" style="display: flex; gap: 12px;">
                <button onclick="viewChecklistHistory()" class="btn-secondary">
                    <i class="fas fa-history"></i> History
                </button>
                ${canManageTasks ? `
                    <button onclick="openAddTaskModal(checklistCurrentShift)" class="btn-primary">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                ` : ''}
            </div>
        </div>

        <!-- Store Progress Overview -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-store"></i> Store Progress</h3>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    ${buildStoreProgressHtml()}
                </div>
            </div>
        </div>

        <!-- Shift Selector -->
        <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Select Shift</label>
                <div style="display: flex; gap: 12px;">
                    <!-- Opening / Day Shift -->
                    <button onclick="switchChecklistShift('opening')"
                        style="flex: 1; padding: 16px 20px; border-radius: 16px; border: 3px solid ${checklistCurrentShift === 'opening' ? '#f59e0b' : 'var(--border-color)'};
                        background: ${checklistCurrentShift === 'opening' ? 'linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fcd34d 100%)' : 'var(--bg-secondary)'};
                        cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 8px;
                        box-shadow: ${checklistCurrentShift === 'opening' ? '0 8px 24px rgba(245, 158, 11, 0.3), inset 0 -2px 8px rgba(0,0,0,0.1)' : 'none'};"
                        onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 12px 28px rgba(245, 158, 11, 0.25)';"
                        onmouseout="this.style.transform='none'; this.style.boxShadow='${checklistCurrentShift === 'opening' ? '0 8px 24px rgba(245, 158, 11, 0.3), inset 0 -2px 8px rgba(0,0,0,0.1)' : 'none'}';">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: ${checklistCurrentShift === 'opening' ? 'linear-gradient(135deg, #f59e0b, #fbbf24)' : 'var(--bg-tertiary)'};
                            display: flex; align-items: center; justify-content: center;
                            box-shadow: ${checklistCurrentShift === 'opening' ? '0 0 20px rgba(251, 191, 36, 0.6), 0 0 40px rgba(251, 191, 36, 0.3)' : 'none'};">
                            <i class="fas fa-sun" style="font-size: 22px; color: ${checklistCurrentShift === 'opening' ? 'white' : 'var(--text-muted)'}; ${checklistCurrentShift === 'opening' ? 'animation: spin-slow 10s linear infinite;' : ''}"></i>
                        </div>
                        <div style="font-weight: 700; font-size: 15px; color: ${checklistCurrentShift === 'opening' ? '#92400e' : 'var(--text-primary)'};">Opening</div>
                        <div style="font-size: 11px; color: ${checklistCurrentShift === 'opening' ? '#b45309' : 'var(--text-muted)'}; font-weight: 500;">
                            <i class="fas fa-clock" style="margin-right: 4px;"></i>Day Shift
                        </div>
                    </button>

                    <!-- Mid Shift / Downtime -->
                    <button onclick="switchChecklistShift('midshift')"
                        style="flex: 1; padding: 16px 20px; border-radius: 16px; border: 3px solid ${checklistCurrentShift === 'midshift' ? '#10b981' : 'var(--border-color)'};
                        background: ${checklistCurrentShift === 'midshift' ? 'linear-gradient(135deg, #d1fae5 0%, #6ee7b7 50%, #34d399 100%)' : 'var(--bg-secondary)'};
                        cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 8px;
                        box-shadow: ${checklistCurrentShift === 'midshift' ? '0 8px 24px rgba(16, 185, 129, 0.35), inset 0 -2px 8px rgba(0,0,0,0.1)' : 'none'};"
                        onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 12px 28px rgba(16, 185, 129, 0.3)';"
                        onmouseout="this.style.transform='none'; this.style.boxShadow='${checklistCurrentShift === 'midshift' ? '0 8px 24px rgba(16, 185, 129, 0.35), inset 0 -2px 8px rgba(0,0,0,0.1)' : 'none'}';">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: ${checklistCurrentShift === 'midshift' ? 'linear-gradient(135deg, #10b981, #059669)' : 'var(--bg-tertiary)'};
                            display: flex; align-items: center; justify-content: center; position: relative;
                            box-shadow: ${checklistCurrentShift === 'midshift' ? '0 0 20px rgba(16, 185, 129, 0.5), 0 0 40px rgba(16, 185, 129, 0.25)' : 'none'};">
                            <i class="fas fa-mug-hot" style="font-size: 20px; color: ${checklistCurrentShift === 'midshift' ? 'white' : 'var(--text-muted)'}; ${checklistCurrentShift === 'midshift' ? 'animation: steam 2s ease-in-out infinite;' : ''}"></i>
                            ${checklistCurrentShift === 'midshift' ? `
                                <span style="position: absolute; top: -2px; left: 50%; transform: translateX(-50%); width: 4px; height: 8px; background: rgba(255,255,255,0.6); border-radius: 4px; animation: steam-rise 1.5s ease-in-out infinite;"></span>
                                <span style="position: absolute; top: -4px; left: 35%; width: 3px; height: 6px; background: rgba(255,255,255,0.4); border-radius: 3px; animation: steam-rise 1.8s ease-in-out infinite 0.3s;"></span>
                                <span style="position: absolute; top: -3px; left: 65%; width: 3px; height: 6px; background: rgba(255,255,255,0.4); border-radius: 3px; animation: steam-rise 1.6s ease-in-out infinite 0.6s;"></span>
                            ` : ''}
                        </div>
                        <div style="font-weight: 700; font-size: 15px; color: ${checklistCurrentShift === 'midshift' ? '#065f46' : 'var(--text-primary)'};">Downtime</div>
                        <div style="font-size: 11px; color: ${checklistCurrentShift === 'midshift' ? '#047857' : 'var(--text-muted)'}; font-weight: 500;">
                            <i class="fas fa-clipboard-list" style="margin-right: 4px; font-size: 9px;"></i>${getCurrentDayName()}
                        </div>
                    </button>

                    <!-- Closing / Night Shift -->
                    <button onclick="switchChecklistShift('closing')"
                        style="flex: 1; padding: 16px 20px; border-radius: 16px; border: 3px solid ${checklistCurrentShift === 'closing' ? '#8b5cf6' : 'var(--border-color)'};
                        background: ${checklistCurrentShift === 'closing' ? 'linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%)' : 'var(--bg-secondary)'};
                        cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 8px;
                        box-shadow: ${checklistCurrentShift === 'closing' ? '0 8px 24px rgba(139, 92, 246, 0.4), inset 0 -2px 8px rgba(0,0,0,0.2)' : 'none'};"
                        onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 12px 28px rgba(139, 92, 246, 0.3)';"
                        onmouseout="this.style.transform='none'; this.style.boxShadow='${checklistCurrentShift === 'closing' ? '0 8px 24px rgba(139, 92, 246, 0.4), inset 0 -2px 8px rgba(0,0,0,0.2)' : 'none'}';">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: ${checklistCurrentShift === 'closing' ? 'linear-gradient(135deg, #6366f1, #8b5cf6)' : 'var(--bg-tertiary)'};
                            display: flex; align-items: center; justify-content: center; position: relative;
                            box-shadow: ${checklistCurrentShift === 'closing' ? '0 0 20px rgba(139, 92, 246, 0.5), 0 0 40px rgba(139, 92, 246, 0.2)' : 'none'};">
                            <i class="fas fa-moon" style="font-size: 20px; color: ${checklistCurrentShift === 'closing' ? '#fef3c7' : 'var(--text-muted)'};"></i>
                            ${checklistCurrentShift === 'closing' ? `
                                <span style="position: absolute; top: 2px; right: 6px; width: 6px; height: 6px; background: #fef3c7; border-radius: 50%; box-shadow: 0 0 6px #fef3c7; animation: twinkle 2s ease-in-out infinite;"></span>
                                <span style="position: absolute; bottom: 8px; left: 4px; width: 4px; height: 4px; background: #fef3c7; border-radius: 50%; box-shadow: 0 0 4px #fef3c7; animation: twinkle 2.5s ease-in-out infinite 0.5s;"></span>
                                <span style="position: absolute; top: 10px; left: 2px; width: 3px; height: 3px; background: #fef3c7; border-radius: 50%; box-shadow: 0 0 3px #fef3c7; animation: twinkle 1.8s ease-in-out infinite 1s;"></span>
                            ` : ''}
                        </div>
                        <div style="font-weight: 700; font-size: 15px; color: ${checklistCurrentShift === 'closing' ? 'white' : 'var(--text-primary)'};">Closing</div>
                        <div style="font-size: 11px; color: ${checklistCurrentShift === 'closing' ? '#c4b5fd' : 'var(--text-muted)'}; font-weight: 500;">
                            <i class="fas fa-star" style="margin-right: 4px; font-size: 9px;"></i>Night Shift
                        </div>
                    </button>
                </div>
        </div>

        <!-- Checklist Tasks -->
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title">
                    <i class="fas ${checklistCurrentShift === 'opening' ? 'fa-sun' : checklistCurrentShift === 'midshift' ? 'fa-mug-hot' : 'fa-moon'}" style="color: ${checklistCurrentShift === 'opening' ? '#f59e0b' : checklistCurrentShift === 'midshift' ? '#10b981' : '#8b5cf6'};"></i>
                    ${checklistCurrentShift === 'opening' ? 'Opening' : checklistCurrentShift === 'midshift' ? `Downtime - ${getCurrentDayName()}` : 'Closing'} Tasks
                </h3>
                <div style="font-size: 14px; color: var(--text-muted);">
                    ${getCompletionPercentage(checklistCurrentStore, checklistCurrentShift)}% complete
                </div>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${buildTasksHtml(checklistCurrentShift)}
                </div>
            </div>
        </div>

        <!-- Sticky Add Task Button -->
        ${canManageTasks ? `
            <div style="position: fixed; bottom: 24px; right: 24px; z-index: 100;">
                <button onclick="openAddTaskModal(checklistCurrentShift)"
                    style="width: 60px; height: 60px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--accent-primary), #7c3aed); color: white; font-size: 24px; cursor: pointer; box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4); display: flex; align-items: center; justify-content: center; transition: all 0.3s;"
                    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 12px 32px rgba(139, 92, 246, 0.5)';"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 24px rgba(139, 92, 246, 0.4)';"
                    title="Add New Task">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        ` : ''}
    `;
}

// Toggle task completion
window.toggleChecklistTask = async function(taskId, store, shift, completionId) {
    // Find the clicked element
    const clickedItem = event?.target?.closest('.checklist-item');

    if (completionId && completionId !== 'null') {
        // Uncomplete the task
        const success = await removeChecklistCompletion(completionId);
        if (success) {
            // Update UI without full reload
            updateChecklistItemUI(clickedItem, taskId, store, shift, false, null);
            updateChecklistProgress();
        }
    } else {
        // Complete the task
        const success = await saveChecklistCompletion(taskId, store, shift);
        if (success) {
            // Get the new completion from the array
            const newCompletion = checklistData.completions.find(c =>
                c.taskId === taskId && c.store === store && c.shift === shift && c.date === checklistSelectedDate
            );
            showNotification('Task completed!', 'success');
            // Update UI without full reload
            updateChecklistItemUI(clickedItem, taskId, store, shift, true, newCompletion);
            updateChecklistProgress();
        }
    }
}

// Update a single checklist item UI without reloading
function updateChecklistItemUI(element, taskId, store, shift, isCompleted, completion) {
    if (!element) return;

    const user = getCurrentUser();
    const canManageTasks = user && (user.role === 'admin' || user.role === 'supervisor');
    const task = checklistData.tasks.find(t => t.id === taskId);
    if (!task) return;

    const completionId = completion?.id || null;
    const timeStr = completion?.completedAt ?
        (completion.completedAt.toDate ? completion.completedAt.toDate() : new Date(completion.completedAt)).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})
        : '';

    // Update the element's onclick
    element.setAttribute('onclick', `toggleChecklistTask('${taskId}', '${store}', '${shift}', ${isCompleted ? `'${completionId}'` : 'null'})`);

    // Update border color
    element.style.borderLeftColor = isCompleted ? '#10b981' : 'var(--accent-primary)';

    // Update checkbox
    const checkbox = element.querySelector('div:first-child');
    if (checkbox) {
        checkbox.style.borderColor = isCompleted ? '#10b981' : 'var(--border-color)';
        checkbox.style.background = isCompleted ? '#10b981' : 'transparent';
        checkbox.innerHTML = isCompleted
            ? '<i class="fas fa-check" style="color: white; font-size: 14px;"></i>'
            : '<span style="width: 12px; height: 12px; border-radius: 50%; background: var(--border-color); opacity: 0.3;"></span>';
    }

    // Update task text area
    const textArea = element.querySelector('div:nth-child(2)');
    if (textArea) {
        const taskTitle = textArea.querySelector('div:first-child');
        if (taskTitle) {
            taskTitle.style.textDecoration = isCompleted ? 'line-through' : 'none';
            taskTitle.style.opacity = isCompleted ? '0.5' : '1';
        }

        // Update or add completion info
        let infoDiv = textArea.querySelector('div:nth-child(2)');
        if (isCompleted) {
            const infoHtml = `<i class="fas fa-check-circle"></i> ${completion?.completedBy || user?.name || 'Unknown'} ‚Ä¢ ${timeStr}`;
            if (infoDiv) {
                infoDiv.style.color = '#10b981';
                infoDiv.style.fontWeight = '500';
                infoDiv.innerHTML = infoHtml;
            } else {
                infoDiv = document.createElement('div');
                infoDiv.style.cssText = 'font-size: 12px; color: #10b981; margin-top: 4px; font-weight: 500;';
                infoDiv.innerHTML = infoHtml;
                textArea.appendChild(infoDiv);
            }
        } else {
            if (infoDiv) {
                infoDiv.style.color = 'var(--text-muted)';
                infoDiv.style.fontWeight = 'normal';
                infoDiv.innerHTML = 'Click to complete';
            }
        }
    }

    // Update trailing icon (before delete button)
    const icons = element.querySelectorAll(':scope > i.fas');
    icons.forEach(icon => {
        if (icon.classList.contains('fa-check-double') || icon.classList.contains('fa-circle')) {
            if (isCompleted) {
                icon.className = 'fas fa-check-double';
                icon.style.color = '#10b981';
                icon.style.fontSize = '18px';
                icon.style.opacity = '1';
            } else {
                icon.className = 'fas fa-circle';
                icon.style.color = 'var(--text-muted)';
                icon.style.fontSize = '8px';
                icon.style.opacity = '0.3';
            }
        }
    });
}

// Update the progress percentage display without full reload
function updateChecklistProgress() {
    const tasks = checklistData.tasks.filter(t => t.shift === checklistCurrentShift);
    if (tasks.length === 0) return;

    const completed = tasks.filter(t => {
        return checklistData.completions.find(c =>
            c.taskId === t.id &&
            c.store === checklistCurrentStore &&
            c.shift === checklistCurrentShift &&
            c.date === checklistSelectedDate
        );
    }).length;

    const percentage = Math.round((completed / tasks.length) * 100);

    // Update the percentage display in the card header
    const cardHeader = document.querySelector('.card-header > div:last-child');
    if (cardHeader && cardHeader.textContent.includes('% complete')) {
        cardHeader.textContent = `${percentage}% complete`;
    }

    // Update store progress cards if visible
    updateStoreProgressCards();
}

// Update store progress cards
function updateStoreProgressCards() {
    const stores = ['Miramar', 'Morena', 'Kearny Mesa', 'Chula Vista', 'North Park'];

    stores.forEach(store => {
        const getCompletionPct = (targetStore, shift) => {
            const tasks = checklistData.tasks.filter(t => t.shift === shift);
            if (tasks.length === 0) return 100;
            const completed = tasks.filter(t => {
                return checklistData.completions.find(c =>
                    c.taskId === t.id &&
                    c.store === targetStore &&
                    c.shift === shift &&
                    c.date === checklistSelectedDate
                );
            }).length;
            return Math.round((completed / tasks.length) * 100);
        };

        const openingPct = getCompletionPct(store, 'opening');
        const closingPct = getCompletionPct(store, 'closing');
        const totalPct = Math.round((openingPct + closingPct) / 2);

        // Find and update progress bars for this store
        const storeCards = document.querySelectorAll('[onclick*="filterChecklistByStore"]');
        storeCards.forEach(card => {
            if (card.getAttribute('onclick')?.includes(store)) {
                // Update total percentage text
                const pctText = card.querySelector('div[style*="font-weight: 800"]');
                if (pctText) {
                    pctText.textContent = `${totalPct}%`;
                }

                // Update progress bars
                const progressBars = card.querySelectorAll('div[style*="height: 6px"]');
                progressBars.forEach((bar, index) => {
                    const innerBar = bar.querySelector('div');
                    if (innerBar) {
                        innerBar.style.width = `${index === 0 ? openingPct : closingPct}%`;
                    }
                });
            }
        });
    });
}

// Filter by store
window.filterChecklistByStore = function(store) {
    checklistCurrentStore = store;
    renderDailyChecklist();
}

// Switch shift
window.switchChecklistShift = function(shift) {
    checklistCurrentShift = shift;
    renderDailyChecklist();
}

// Open add task modal
window.openAddTaskModal = function(shift) {
    openModal('add-checklist-task', { shift });
}

// Add task from modal
window.addChecklistTaskFromModal = async function() {
    const task = document.getElementById('checklist-task-description')?.value?.trim();
    const shift = document.getElementById('checklist-task-shift')?.value;

    if (!task) {
        alert('Please enter a task description');
        return;
    }

    // Handle midshift tasks differently - save to midshiftTasks collection
    if (shift === 'midshift') {
        const dayOfWeek = document.querySelector('input[name="midshift-day"]:checked')?.value;
        if (!dayOfWeek) {
            alert('Please select a day of the week');
            return;
        }

        const result = await addMidshiftTask(task, dayOfWeek);
        if (result) {
            closeModal();
            const dayName = dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1);
            showNotification(`Task added for ${dayName}!`, 'success');
            renderDailyChecklist();
        } else {
            alert('Error adding task. Please try again.');
        }
        return;
    }

    // Regular opening/closing tasks
    const duration = document.querySelector('input[name="checklist-task-duration"]:checked')?.value || 'permanent';
    const result = await addChecklistTask(task, shift, 'all', duration);
    if (result) {
        closeModal();
        showNotification(duration === 'one-time' ? 'Task added for today!' : 'Task added permanently!', 'success');
        renderDailyChecklist();
    } else {
        alert('Error adding task. Please try again.');
    }
}

// Add midshift task to Firebase
async function addMidshiftTask(task, dayOfWeek) {
    try {
        const db = firebase.firestore();
        const existingTasks = await db.collection('midshiftTasks').where('dayOfWeek', '==', dayOfWeek).get();
        const order = existingTasks.size + 1;

        const newTask = {
            task,
            dayOfWeek,
            order,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            isCustom: true
        };

        const docRef = await db.collection('midshiftTasks').add(newTask);
        newTask.id = docRef.id;
        newTask.shift = 'midshift';
        newTask.store = 'all';
        newTask.duration = 'permanent';

        // Add to local data if it's today's day
        if (dayOfWeek === getCurrentDayKey()) {
            checklistData.tasks.push(newTask);
        }

        return newTask;
    } catch (error) {
        console.error('Error adding midshift task:', error);
        return null;
    }
}

// Delete task
window.deleteChecklistTaskUI = async function(taskId) {
    if (!confirm('Delete this task? This will remove it for all stores.')) return;

    const success = await deleteChecklistTask(taskId);
    if (success) {
        showNotification('Task deleted', 'success');
        renderDailyChecklist();
    }
}

// Open photo capture for task
window.openPhotoForTask = function(taskId, store, shift) {
    // Store task info for after photo capture
    window.pendingChecklistPhoto = { taskId, store, shift };
    openCameraModal('checklist-photo-preview', 'checklist-photo-input');
}

// View checklist history
window.viewChecklistHistory = async function() {
    const modal = document.createElement('div');
    modal.id = 'checklist-history-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    modal.onmousedown = (e) => { if (e.target === modal) modal.remove(); };

    // Get last 7 days of completions
    const db = firebase.firestore();
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    let historyHtml = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

    modal.innerHTML = `
        <div style="background: var(--bg-primary); border-radius: 20px; max-width: 600px; width: 100%; max-height: 80vh; overflow: hidden; animation: modalSlideIn 0.3s ease;">
            <div style="padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;"><i class="fas fa-history" style="color: var(--accent-primary); margin-right: 8px;"></i> Checklist History</h3>
                <button onclick="document.getElementById('checklist-history-modal').remove()" style="background: none; border: none; cursor: pointer; padding: 8px;">
                    <i class="fas fa-times" style="color: var(--text-muted);"></i>
                </button>
            </div>
            <div id="history-content" style="padding: 16px; max-height: 500px; overflow-y: auto;">
                ${historyHtml}
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // Load history
    try {
        const snapshot = await db.collection('checklistCompletions')
            .orderBy('completedAt', 'desc')
            .limit(50)
            .get();

        const completions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Group by date
        const grouped = {};
        completions.forEach(c => {
            const date = c.date || 'Unknown';
            if (!grouped[date]) grouped[date] = [];
            grouped[date].push(c);
        });

        if (Object.keys(grouped).length === 0) {
            historyHtml = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No history yet</div>';
        } else {
            historyHtml = Object.entries(grouped).map(([date, items]) => `
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-muted); font-size: 13px; text-transform: uppercase;">${new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${items.map(item => {
                            const task = checklistData.tasks.find(t => t.id === item.taskId);
                            return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                    <div style="flex: 1;">
                                        <div style="font-size: 14px;">${task?.task || 'Unknown task'}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${item.store} - ${item.shift} - ${item.completedBy}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('history-content').innerHTML = historyHtml;
    } catch (error) {
        document.getElementById('history-content').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading history</div>';
    }
}

        let currentRestockTab = 'inventory';
        let selectedStoreFilter = 'all';
        let selectedRestockTypeFilter = 'all'; // 'all', 'product', 'supply'
        let inventorySearchQuery = ''; // Search query for inventory
        let shopifyInventory = []; // Loaded from Shopify API
        let isLoadingInventory = false;
        let inventoryLoadError = null;
        let inventorySortColumn = null; // Current sort column ('stock', 'price', 'brand', 'product', etc.)
        let inventorySortDirection = 'asc'; // 'asc' or 'desc'
        let inventoryStockChart = null; // Chart.js instance for inventory stock chart
        let stockLevelsExpanded = false; // Track if stock levels chart is expanded

        // Toggle the Stock Levels chart dropdown
        function toggleStockLevelsChart() {
            const content = document.getElementById('stockLevelsContent');
            const chevron = document.getElementById('stockLevelsChevron');

            if (!content || !chevron) return;

            stockLevelsExpanded = !stockLevelsExpanded;

            if (stockLevelsExpanded) {
                content.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
                // Initialize chart when expanded (if not already)
                displayInventoryStockChart();
            } else {
                content.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        // Load inventory from Shopify API
        async function loadShopifyInventory(forceRefresh = false) {
            // Check if already loaded and not forcing refresh
            if (shopifyInventory.length > 0 && !forceRefresh) {
                return shopifyInventory;
            }

            // Check if fetchAllStoresInventory is available
            if (typeof fetchAllStoresInventory !== 'function') {
                console.warn('[Restock] fetchAllStoresInventory not available, using fallback');
                return inventory; // Use local fallback
            }

            isLoadingInventory = true;
            inventoryLoadError = null;

            try {
                console.log('[Restock] Loading inventory from all Shopify stores...');
                shopifyInventory = await fetchAllStoresInventory();
                return shopifyInventory;
            } catch (error) {
                console.error('[Restock] Error loading inventory:', error);
                inventoryLoadError = error.message;
                return inventory; // Use local fallback on error
            } finally {
                isLoadingInventory = false;
            }
        }

        async function renderRestockRequests() {
            const dashboard = document.querySelector('.dashboard');
            const user = getCurrentUser();
            const canEditRequests = user && (user.role === 'administrator' || user.role === 'manager');

            // Get all requests sorted by date (newest first)
            const allRequests = [...restockRequests].sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Product Requests</h2>
                        <p class="section-subtitle">Request products for store inventory</p>
                    </div>
                    <button class="btn-primary" onclick="openNewRestockRequestModal()" style="padding: 12px 24px; border-radius: 10px;">
                        <i class="fas fa-plus"></i> New Request
                    </button>
                </div>

                <!-- Simple Stats -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px 12px; text-align: center; border: 1px solid var(--border-color);">
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-primary);">${allRequests.length}</div>
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Total</div>
                    </div>
                    <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px 12px; text-align: center; border: 1px solid var(--border-color);">
                        <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">${allRequests.filter(r => r.priority === 'high').length}</div>
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">High Priority</div>
                    </div>
                    <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px 12px; text-align: center; border: 1px solid var(--border-color);">
                        <div style="font-size: 24px; font-weight: 700; color: #10b981;">${allRequests.reduce((sum, r) => sum + (r.quantity || 0), 0)}</div>
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Total Units</div>
                    </div>
                </div>

                <!-- Purchased progress -->
                ${allRequests.length > 0 ? `
                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px 16px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 13px; color: var(--text-secondary);"><i class="fas fa-shopping-cart" style="color: #10b981; margin-right: 6px;"></i>Purchased: <strong>${allRequests.filter(r => r.purchased).length}</strong> / ${allRequests.length}</span>
                        ${allRequests.filter(r => r.purchased).length > 0 ? `
                            <button onclick="clearPurchasedRequests()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 12px; padding: 4px 8px;">
                                <i class="fas fa-broom"></i> Clear done
                            </button>
                        ` : ''}
                    </div>
                    <div style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: ${allRequests.length > 0 ? (allRequests.filter(r => r.purchased).length / allRequests.length * 100) : 0}%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 3px; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                ` : ''}

                <!-- Filter & Sort Row -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <!-- Priority Filters -->
                    <button onclick="setRequestPriorityFilter('all')" id="req-filter-all" style="padding: 12px 20px; font-size: 14px; border-radius: 10px; border: none; background: var(--accent-primary); color: white; cursor: pointer; font-weight: 600;">All (${allRequests.length})</button>
                    <button onclick="setRequestPriorityFilter('high')" id="req-filter-high" style="padding: 12px 20px; font-size: 14px; border-radius: 10px; border: none; background: var(--bg-secondary); color: #ef4444; cursor: pointer; font-weight: 600;">High</button>
                    <button onclick="setRequestPriorityFilter('medium')" id="req-filter-medium" style="padding: 12px 20px; font-size: 14px; border-radius: 10px; border: none; background: var(--bg-secondary); color: #f59e0b; cursor: pointer; font-weight: 600;">Medium</button>
                    <button onclick="setRequestPriorityFilter('low')" id="req-filter-low" style="padding: 12px 20px; font-size: 14px; border-radius: 10px; border: none; background: var(--bg-secondary); color: #10b981; cursor: pointer; font-weight: 600;">Low</button>
                    <button onclick="setRequestPriorityFilter('pending')" id="req-filter-pending" style="padding: 12px 20px; font-size: 14px; border-radius: 10px; border: none; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; font-weight: 600;">Pending</button>

                    <!-- Divider -->
                    <div style="width: 2px; height: 35px; background: var(--border-color); margin: 0 10px;"></div>

                    <!-- Store Filter Dropdown -->
                    <select id="req-store-filter" onchange="setRequestStoreFilter(this.value)" style="padding: 12px 16px; font-size: 14px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; font-weight: 600; min-width: 150px;">
                        <option value="all">All Stores</option>
                        ${[...new Set(allRequests.map(r => r.store).filter(s => s))].sort().map(store => `<option value="${store}">${store}</option>`).join('')}
                    </select>

                    <!-- Divider -->
                    <div style="width: 2px; height: 35px; background: var(--border-color); margin: 0 10px;"></div>

                    <!-- Sort Options -->
                    <button onclick="setRequestSort('alpha')" id="req-sort-alpha" style="padding: 12px 20px; font-size: 14px; border-radius: 10px; border: none; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; font-weight: 600;" title="Sort A-Z">
                        <i class="fas fa-sort-alpha-down"></i> A-Z
                    </button>
                    <button onclick="setRequestSort('qty')" id="req-sort-qty" style="padding: 12px 20px; font-size: 14px; border-radius: 10px; border: none; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; font-weight: 600;" title="Sort by Quantity">
                        <i class="fas fa-sort-amount-down"></i> Qty
                    </button>
                    <button onclick="setRequestSort('store')" id="req-sort-store" style="padding: 12px 20px; font-size: 14px; border-radius: 10px; border: none; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; font-weight: 600;" title="Sort by Store">
                        <i class="fas fa-store"></i> Store
                    </button>
                </div>

                <!-- Requests List -->
                <div style="background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden;">
                    <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: var(--text-primary); font-size: 14px;" id="requests-list-title">All Requests</span>
                        <span style="font-size: 12px; color: var(--text-muted);" id="requests-list-count">${allRequests.length} items</span>
                    </div>

                    ${allRequests.length === 0 ? `
                        <div style="padding: 60px 20px; text-align: center; color: var(--text-muted);">
                            <i class="fas fa-box-open" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p style="font-size: 15px; margin: 0;">No requests yet</p>
                            <p style="font-size: 13px; margin-top: 8px;">Click "New Request" to add a product request</p>
                        </div>
                    ` : `
                        <!-- Mobile-friendly card list -->
                        <div class="product-requests-list" style="display: flex; flex-direction: column;">
                            ${allRequests.map(request => {
                                const priorityColor = request.priority === 'high' ? '#ef4444' : request.priority === 'medium' ? '#f59e0b' : '#10b981';
                                const isPurchased = request.purchased || false;
                                const rowBg = isPurchased ? 'linear-gradient(90deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05))' : 'transparent';
                                const rowBorder = isPurchased ? '2px solid #10b981' : '1px solid var(--border-color)';
                                return `
                                    <div class="request-row" id="request-row-${request.firestoreId || request.id}" style="display: flex; align-items: center; padding: 12px 16px; border-bottom: ${rowBorder}; background: ${rowBg}; gap: 12px; transition: all 0.3s ease;">
                                        <!-- Checkbox palomita -->
                                        <div onclick="toggleRequestPurchased('${request.firestoreId || request.id}')" style="cursor: pointer; min-width: 32px; height: 32px; border-radius: 8px; border: 2px solid ${isPurchased ? '#10b981' : 'var(--border-color)'}; background: ${isPurchased ? '#10b981' : 'transparent'}; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                                            ${isPurchased ? '<i class="fas fa-check" style="color: white; font-size: 14px;"></i>' : ''}
                                        </div>

                                        <!-- Product info -->
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 600; color: ${isPurchased ? '#10b981' : 'var(--text-primary)'}; font-size: 14px; ${isPurchased ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${request.productName}</div>
                                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px; flex-wrap: wrap;">
                                                <span style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-store" style="margin-right: 4px;"></i>${request.store || '-'}</span>
                                                ${request.notes ? `<span style="font-size: 11px; color: var(--text-muted);">‚Ä¢ ${request.notes.substring(0, 30)}${request.notes.length > 30 ? '...' : ''}</span>` : ''}
                                            </div>
                                        </div>

                                        <!-- Quantity -->
                                        <div style="text-align: center; min-width: 40px;">
                                            <div style="font-weight: 700; font-size: 18px; color: ${isPurchased ? '#10b981' : 'var(--accent-primary)'};">${request.quantity}</div>
                                        </div>

                                        <!-- Priority badge -->
                                        <div>
                                            <span style="background: ${priorityColor}20; color: ${priorityColor}; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase;">${request.priority}</span>
                                        </div>

                                        <!-- Actions -->
                                        <div style="display: flex; gap: 4px;">
                                            ${canEditRequests ? `
                                                <button onclick="openEditRestockRequestModal('${request.firestoreId || request.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 6px; font-size: 14px;" title="Edit" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-muted)'">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            ` : ''}
                                            <button onclick="deleteRestockRequest('${request.firestoreId || request.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 6px; font-size: 14px;" title="Delete" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // Refresh inventory from Shopify
        async function refreshShopifyInventory() {
            const tabContent = document.getElementById('restock-tab-content');
            if (tabContent && currentRestockTab === 'inventory') {
                tabContent.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><p>Refreshing inventory from Shopify...</p></div>';
            }

            await loadShopifyInventory(true); // Force refresh

            if (tabContent && currentRestockTab === 'inventory') {
                tabContent.innerHTML = renderInventoryTab();
                displayInventoryStockChart();
            }
        }

        function renderInventoryTab() {
            // Use Shopify inventory if loaded, otherwise use local fallback
            const inventoryData = shopifyInventory.length > 0 ? shopifyInventory : inventory;

            // Filter by store
            let filteredInventory = selectedStoreFilter === 'all'
                ? inventoryData
                : inventoryData.filter(item => {
                    // Handle "Vape Smoke Universe" parent filter - show all VSU locations
                    if (selectedStoreFilter === 'VSU') {
                        return item.store.startsWith('VSU ') || item.storeKey === 'vsu';
                    }
                    // Handle specific VSU location filter
                    if (selectedStoreFilter.startsWith('VSU ')) {
                        return item.store === selectedStoreFilter;
                    }
                    // Handle store key or store name
                    return item.store === selectedStoreFilter || item.storeKey === selectedStoreFilter;
                });

            // Apply search filter
            if (inventorySearchQuery.trim()) {
                const query = inventorySearchQuery.toLowerCase().trim();
                filteredInventory = filteredInventory.filter(item => {
                    return (
                        (item.brand && item.brand.toLowerCase().includes(query)) ||
                        (item.productName && item.productName.toLowerCase().includes(query)) ||
                        (item.flavor && item.flavor.toLowerCase().includes(query)) ||
                        (item.sku && item.sku.toLowerCase().includes(query)) ||
                        (item.store && item.store.toLowerCase().includes(query)) ||
                        (item.productType && item.productType.toLowerCase().includes(query))
                    );
                });
            }

            // Apply sorting
            if (inventorySortColumn) {
                filteredInventory = [...filteredInventory].sort((a, b) => {
                    let aVal, bVal;

                    switch (inventorySortColumn) {
                        case 'stock':
                            aVal = parseInt(a.stock) || 0;
                            bVal = parseInt(b.stock) || 0;
                            break;
                        case 'price':
                            aVal = parseFloat(a.unitPrice) || 0;
                            bVal = parseFloat(b.unitPrice) || 0;
                            break;
                        case 'brand':
                            aVal = (a.brand || '').toLowerCase();
                            bVal = (b.brand || '').toLowerCase();
                            break;
                        case 'product':
                            aVal = (a.productName || '').toLowerCase();
                            bVal = (b.productName || '').toLowerCase();
                            break;
                        case 'store':
                            aVal = (a.store || '').toLowerCase();
                            bVal = (b.store || '').toLowerCase();
                            break;
                        default:
                            return 0;
                    }

                    // Compare values
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return inventorySortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        if (aVal < bVal) return inventorySortDirection === 'asc' ? -1 : 1;
                        if (aVal > bVal) return inventorySortDirection === 'asc' ? 1 : -1;
                        return 0;
                    }
                });
            }

            // Get unique stores for filter dropdown (dynamically from data)
            const stores = [...new Set(inventoryData.map(item => item.store))].sort();

            // Separate VSU locations from other stores
            const vsuLocations = stores.filter(s => s.startsWith('VSU '));
            const otherStores = stores.filter(s => !s.startsWith('VSU '));

            // Count all VSU items
            const vsuCount = inventoryData.filter(i => i.store.startsWith('VSU ') || i.storeKey === 'vsu').length;

            // Build store options with VSU as parent option + individual locations as sub-options
            let storeOptions = '';

            // Add VSU parent option if there are VSU locations
            if (vsuLocations.length > 0) {
                storeOptions += `<option value="VSU" ${selectedStoreFilter === 'VSU' ? 'selected' : ''}>Vape Smoke Universe (${vsuCount})</option>`;
                // Add individual VSU locations as indented sub-options
                vsuLocations.forEach(store => {
                    const count = inventoryData.filter(i => i.store === store).length;
                    storeOptions += `<option value="${store}" ${selectedStoreFilter === store ? 'selected' : ''}>&nbsp;&nbsp;&nbsp;‚îî ${store.replace('VSU ', '')} (${count})</option>`;
                });
            }

            // Add other stores
            otherStores.forEach(store => {
                const count = inventoryData.filter(i => i.store === store).length;
                storeOptions += `<option value="${store}" ${selectedStoreFilter === store ? 'selected' : ''}>${store} (${count})</option>`;
            });

            // Error message if loading failed
            const errorMessage = inventoryLoadError ? `
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 12px; margin-bottom: 16px; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i> Failed to load from Shopify: ${inventoryLoadError}. Showing local data.
                </div>
            ` : '';

            // Data source indicator
            const dataSource = shopifyInventory.length > 0
                ? `<span style="background: var(--success); color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;"><i class="fas fa-cloud"></i> Live from Shopify</span>`
                : `<span style="background: var(--warning); color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;"><i class="fas fa-database"></i> Local Data</span>`;

            return `
                ${errorMessage}
                <div style="background: var(--bg-secondary); border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border-color); overflow: hidden;">
                    <div onclick="toggleStockLevelsChart()" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; cursor: pointer; user-select: none;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                        <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-chart-bar" style="margin-right: 8px; color: var(--primary);"></i>
                            Stock Levels (Lowest 20)
                        </h4>
                        <i class="fas fa-chevron-down" id="stockLevelsChevron" style="color: var(--text-muted); transition: transform 0.3s; transform: rotate(-90deg);"></i>
                    </div>
                    <div id="stockLevelsContent" style="display: none; padding: 0 16px 16px 16px;">
                        <div style="position: relative; height: 200px; width: 100%;">
                            <canvas id="inventoryStockChart"></canvas>
                        </div>
                        <div id="inventoryChartImages" style="position: relative; height: 56px; margin-top: 8px;"></div>
                    </div>
                    <!-- Image hover popup -->
                    <div id="inventoryImagePopup" style="display: none; position: fixed; z-index: 9999; pointer-events: none; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 12px; padding: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        <img id="inventoryImagePopupImg" src="" style="width: 180px; height: 180px; object-fit: contain; border-radius: 8px; display: block;">
                        <div id="inventoryImagePopupText" style="text-align: center; margin-top: 8px; font-size: 12px; color: var(--text-primary); max-width: 180px; word-wrap: break-word;"></div>
                    </div>
                </div>
                <div class="restock-filter-header" style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <div style="position: relative;">
                            <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px;"></i>
                            <input type="text"
                                id="inventory-search"
                                class="form-input"
                                placeholder="Search by name, brand, SKU, variant..."
                                value="${inventorySearchQuery}"
                                oninput="searchInventory(this.value)"
                                style="width: 300px; padding-left: 36px;">
                        </div>
                        <select class="form-input" id="store-filter" onchange="filterInventoryByStore(this.value)" style="width: 200px;">
                            <option value="all" ${selectedStoreFilter === 'all' ? 'selected' : ''}>All Stores (${inventoryData.length})</option>
                            ${storeOptions}
                        </select>
                        ${inventorySearchQuery || selectedStoreFilter !== 'all' ? `
                            <button onclick="clearInventoryFilters()" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        ` : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted);">
                        Showing ${filteredInventory.length} ${filteredInventory.length === 1 ? 'item' : 'items'}
                        ${dataSource}
                    </div>
                </div>

                <div class="licenses-table-container" style="max-height: 600px; overflow-y: auto;">
                    <table class="data-table restock-inventory-table">
                        <thead style="position: sticky; top: 0; background: var(--bg-primary); z-index: 10;">
                            <tr>
                                <th onclick="sortInventoryBy('store')" style="cursor: pointer; user-select: none;" title="Click to sort by store">
                                    Store ${inventorySortColumn === 'store' ? (inventorySortDirection === 'asc' ? '<i class="fas fa-sort-up" style="margin-left: 4px;"></i>' : '<i class="fas fa-sort-down" style="margin-left: 4px;"></i>') : '<i class="fas fa-sort" style="margin-left: 4px; opacity: 0.3;"></i>'}
                                </th>
                                <th onclick="sortInventoryBy('brand')" style="cursor: pointer; user-select: none;" title="Click to sort by brand">
                                    Brand ${inventorySortColumn === 'brand' ? (inventorySortDirection === 'asc' ? '<i class="fas fa-sort-up" style="margin-left: 4px;"></i>' : '<i class="fas fa-sort-down" style="margin-left: 4px;"></i>') : '<i class="fas fa-sort" style="margin-left: 4px; opacity: 0.3;"></i>'}
                                </th>
                                <th onclick="sortInventoryBy('product')" style="cursor: pointer; user-select: none;" title="Click to sort by product">
                                    Product Name ${inventorySortColumn === 'product' ? (inventorySortDirection === 'asc' ? '<i class="fas fa-sort-up" style="margin-left: 4px;"></i>' : '<i class="fas fa-sort-down" style="margin-left: 4px;"></i>') : '<i class="fas fa-sort" style="margin-left: 4px; opacity: 0.3;"></i>'}
                                </th>
                                <th>Variant</th>
                                <th>SKU</th>
                                <th onclick="sortInventoryBy('price')" style="cursor: pointer; user-select: none;" title="Click to sort by price">
                                    Unit Price ${inventorySortColumn === 'price' ? (inventorySortDirection === 'asc' ? '<i class="fas fa-sort-up" style="margin-left: 4px;"></i>' : '<i class="fas fa-sort-down" style="margin-left: 4px;"></i>') : '<i class="fas fa-sort" style="margin-left: 4px; opacity: 0.3;"></i>'}
                                </th>
                                <th onclick="sortInventoryBy('stock')" style="cursor: pointer; user-select: none;" title="Click to sort by stock">
                                    Stock ${inventorySortColumn === 'stock' ? (inventorySortDirection === 'asc' ? '<i class="fas fa-sort-up" style="margin-left: 4px;"></i>' : '<i class="fas fa-sort-down" style="margin-left: 4px;"></i>') : '<i class="fas fa-sort" style="margin-left: 4px; opacity: 0.3;"></i>'}
                                </th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredInventory.length > 0 ? filteredInventory.map(item => {
                                // Highlight search matches
                                const highlightText = (text, query) => {
                                    if (!query || !text) return text || '';
                                    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                                    return text.replace(regex, '<mark style="background: var(--warning); color: var(--text-primary); padding: 0 2px; border-radius: 2px;">$1</mark>');
                                };
                                const q = inventorySearchQuery.toLowerCase().trim();

                                return `
                                <tr>
                                    <td data-label="Store">
                                        <span style="font-weight: 600; font-size: 11px; padding: 4px 8px; border-radius: 4px; background: ${getStoreColor(item.store)}; color: white;">
                                            ${item.store}
                                        </span>
                                    </td>
                                    <td data-label="Brand" style="font-weight: 600;">${q ? highlightText(item.brand, q) : item.brand}</td>
                                    <td data-label="Product">${q ? highlightText(item.productName, q) : item.productName}</td>
                                    <td data-label="Variant" style="font-size: 12px; color: var(--text-secondary);">${q ? highlightText(item.flavor || 'N/A', q) : (item.flavor || 'N/A')}</td>
                                    <td data-label="SKU" style="font-size: 11px; font-family: monospace; color: var(--text-muted);">${q ? highlightText(item.sku || '-', q) : (item.sku || '-')}</td>
                                    <td data-label="Price" style="font-weight: 600; color: var(--success);">$${parseFloat(item.unitPrice).toFixed(2)}</td>
                                    <td data-label="Stock">
                                        <span style="font-weight: 600; color: ${item.stock < item.minStock ? 'var(--danger)' : item.stock < item.minStock * 2 ? 'var(--warning)' : 'var(--success)'};">
                                            ${item.stock}
                                        </span>
                                        ${item.stock < item.minStock ? '<i class="fas fa-exclamation-triangle" style="color: var(--danger); margin-left: 4px;" title="Low stock"></i>' : ''}
                                    </td>
                                    <td data-label="Status">
                                        <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: ${item.status === 'ACTIVE' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(107, 114, 128, 0.15)'}; color: ${item.status === 'ACTIVE' ? 'var(--success)' : 'var(--text-muted)'};">
                                            ${item.status || 'Active'}
                                        </span>
                                    </td>
                                </tr>
                            `}).join('') : `
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                        <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                                        ${inventorySearchQuery ? `No items found matching "${inventorySearchQuery}"` : 'No inventory items found'}
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Dynamic search for inventory
        let inventorySearchTimeout = null;
        function searchInventory(query) {
            // Debounce search to avoid too many re-renders
            clearTimeout(inventorySearchTimeout);
            inventorySearchTimeout = setTimeout(() => {
                inventorySearchQuery = query;
                const tabContent = document.getElementById('restock-tab-content');
                if (tabContent && currentRestockTab === 'inventory') {
                    tabContent.innerHTML = renderInventoryTab();
                    displayInventoryStockChart();
                    // Restore focus to search input
                    const searchInput = document.getElementById('inventory-search');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.setSelectionRange(query.length, query.length);
                    }
                }
            }, 150);
        }

        // Clear all inventory filters
        function clearInventoryFilters() {
            inventorySearchQuery = '';
            selectedStoreFilter = 'all';
            inventorySortColumn = null;
            inventorySortDirection = 'asc';
            const tabContent = document.getElementById('restock-tab-content');
            if (tabContent && currentRestockTab === 'inventory') {
                tabContent.innerHTML = renderInventoryTab();
                displayInventoryStockChart();
            }
        }

        // Sort inventory by column
        function sortInventoryBy(column) {
            // If clicking the same column, toggle direction
            if (inventorySortColumn === column) {
                inventorySortDirection = inventorySortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to ascending (except stock defaults to ascending to show lowest first)
                inventorySortColumn = column;
                inventorySortDirection = 'asc';
            }

            // Re-render the table
            const tabContent = document.getElementById('restock-tab-content');
            if (tabContent && currentRestockTab === 'inventory') {
                tabContent.innerHTML = renderInventoryTab();
                displayInventoryStockChart();
            }
        }

        // Display inventory stock chart (shows lowest stock items)
        function displayInventoryStockChart() {
            const ctx = document.getElementById('inventoryStockChart');
            const imagesContainer = document.getElementById('inventoryChartImages');
            if (!ctx) return;

            // Get inventory data
            const inventoryData = shopifyInventory.length > 0 ? shopifyInventory : inventory;

            // Filter by current store filter
            let filteredData = selectedStoreFilter === 'all'
                ? inventoryData
                : inventoryData.filter(item => {
                    if (selectedStoreFilter === 'VSU') {
                        return item.store.startsWith('VSU ') || item.storeKey === 'vsu';
                    }
                    if (selectedStoreFilter.startsWith('VSU ')) {
                        return item.store === selectedStoreFilter;
                    }
                    return item.store === selectedStoreFilter || item.storeKey === selectedStoreFilter;
                });

            // Apply search filter if active
            if (inventorySearchQuery.trim()) {
                const query = inventorySearchQuery.toLowerCase().trim();
                filteredData = filteredData.filter(item => {
                    return (
                        (item.brand && item.brand.toLowerCase().includes(query)) ||
                        (item.productName && item.productName.toLowerCase().includes(query)) ||
                        (item.flavor && item.flavor.toLowerCase().includes(query)) ||
                        (item.sku && item.sku.toLowerCase().includes(query)) ||
                        (item.store && item.store.toLowerCase().includes(query))
                    );
                });
            }

            // Sort by stock ascending and take lowest 20
            const lowestStock = [...filteredData]
                .sort((a, b) => (parseInt(a.stock) || 0) - (parseInt(b.stock) || 0))
                .slice(0, 20);

            // Prepare chart data - use empty labels since we'll show images instead
            const labels = lowestStock.map(() => '');

            const stockData = lowestStock.map(item => parseInt(item.stock) || 0);

            // Calculate min/max for symmetric axis around 0
            const minStock = Math.min(...stockData);
            const maxStock = Math.max(...stockData);
            const absMax = Math.max(Math.abs(minStock), Math.abs(maxStock), 10); // At least 10 for visibility

            // Color based on stock level
            const backgroundColors = lowestStock.map(item => {
                const stock = parseInt(item.stock) || 0;
                const itemMinStock = item.minStock || 10;
                if (stock < 0) return 'rgba(248, 87, 87, 1)'; // Red - negative stock
                if (stock === 0) return 'rgba(255, 54, 54, 0.8)'; // Red - out of stock
                if (stock < itemMinStock) return 'rgba(245, 158, 11, 0.8)'; // Orange - low stock
                if (stock < itemMinStock * 2) return 'rgba(234, 179, 8, 0.8)'; // Yellow - getting low
                return 'rgba(34, 197, 94, 0.8)'; // Green - good stock
            });

            const borderColors = backgroundColors.map(c => c.replace('0.8', '1'));

            // Destroy existing chart
            if (inventoryStockChart) {
                inventoryStockChart.destroy();
            }

            // Create new chart
            inventoryStockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock Quantity',
                        data: stockData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 0,
                        borderRadius: 0,
                        barThickness: 48, // Same width as images (48px)
                        maxBarThickness: 48
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animation to prevent resize issues
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const idx = context[0].dataIndex;
                                    const item = lowestStock[idx];
                                    return item.productName + (item.flavor && item.flavor !== 'N/A' ? ` - ${item.flavor}` : '');
                                },
                                label: function(context) {
                                    return `Stock: ${context.raw} units`;
                                },
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const item = lowestStock[idx];
                                    return `Store: ${item.store}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                display: false // Hide x-axis labels - we'll show images instead
                            }
                        },
                        y: {
                            min: -absMax,
                            max: absMax,
                            grid: {
                                color: function(context) {
                                    // Make the zero line more visible
                                    if (context.tick.value === 0) {
                                        return 'rgba(255, 255, 255, 0.5)';
                                    }
                                    return 'rgba(255, 255, 255, 0.1)';
                                },
                                lineWidth: function(context) {
                                    return context.tick.value === 0 ? 2 : 1;
                                }
                            },
                            ticks: {
                                color: 'var(--text-muted)',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });

            // Render product images below the chart - positioned to match bar centers
            if (imagesContainer) {
                const defaultImage = 'data:image/svg+xml,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                        <rect fill="#374151" width="48" height="48" rx="6"/>
                        <text x="24" y="30" fill="#9CA3AF" font-size="14" text-anchor="middle" font-family="Arial">?</text>
                    </svg>
                `);

                // Debug: Log image URLs
                console.log('[Inventory Chart] Product images:');
                lowestStock.forEach((item, idx) => {
                    console.log(`  [${idx}] ${item.productName}: imageUrl =`, item.imageUrl);
                });

                // Wait for chart to render, then position images based on bar positions
                setTimeout(() => {
                    const chartArea = inventoryStockChart.chartArea;
                    const xScale = inventoryStockChart.scales.x;

                    if (!chartArea || !xScale) return;

                    // Get the container's position relative to the chart
                    const containerRect = imagesContainer.getBoundingClientRect();
                    const canvasRect = ctx.getBoundingClientRect();
                    const offsetLeft = canvasRect.left - containerRect.left;

                    imagesContainer.innerHTML = lowestStock.map((item, index) => {
                        const imgSrc = item.imageUrl || defaultImage;
                        const title = item.productName + (item.flavor && item.flavor !== 'N/A' ? ` - ${item.flavor}` : '');

                        // Get the x position of each bar from the chart scale
                        const barX = xScale.getPixelForValue(index);
                        const leftPos = barX + offsetLeft - 24; // Center the 48px image on the bar

                        return `
                            <div
                                style="position: absolute; left: ${leftPos}px; top: 0; width: 48px;"
                                onmouseenter="showInventoryImagePopup(event, '${imgSrc.replace(/'/g, "\\'")}', '${title.replace(/'/g, "\\'")}', ${item.stock}, '${item.store}')"
                                onmousemove="moveInventoryImagePopup(event)"
                                onmouseleave="hideInventoryImagePopup()"
                            >
                                <img
                                    src="${imgSrc}"
                                    alt="${title}"
                                    style="width: 48px; height: 48px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); cursor: pointer;"
                                    onerror="this.src='${defaultImage}'"
                                />
                            </div>
                        `;
                    }).join('');
                }, 100);
            }
        }

        // Show image popup on hover
        function showInventoryImagePopup(event, imgSrc, title, stock, store) {
            const popup = document.getElementById('inventoryImagePopup');
            const popupImg = document.getElementById('inventoryImagePopupImg');
            const popupText = document.getElementById('inventoryImagePopupText');

            if (!popup || !popupImg || !popupText) return;

            popupImg.src = imgSrc;
            popupText.innerHTML = `<strong>${title}</strong><br>Stock: ${stock}<br>Store: ${store}`;
            popup.style.display = 'block';

            moveInventoryImagePopup(event);
        }

        // Move popup with mouse
        function moveInventoryImagePopup(event) {
            const popup = document.getElementById('inventoryImagePopup');
            if (!popup) return;

            const x = event.clientX + 15;
            const y = event.clientY - 100;

            // Keep popup within viewport
            const rect = popup.getBoundingClientRect();
            const maxX = window.innerWidth - 220;
            const maxY = window.innerHeight - 250;

            popup.style.left = Math.min(x, maxX) + 'px';
            popup.style.top = Math.max(10, Math.min(y, maxY)) + 'px';
        }

        // Hide image popup
        function hideInventoryImagePopup() {
            const popup = document.getElementById('inventoryImagePopup');
            if (popup) {
                popup.style.display = 'none';
            }
        }

        // Get store color for badges
        function getStoreColor(storeName) {
            const colors = {
                'VSU': '#6366f1',
                'VSU Miramar': '#6366f1',
                'VSU Morena': '#8b5cf6',
                'VSU Kearny Mesa': '#3b82f6',
                'VSU Chula Vista': '#ec4899',
                'VSU North Park': '#14b8a6',
                'Loyal Vaper': '#10b981',
                'Miramar Wine & Liquor': '#f59e0b',
                'Miramar': '#6366f1',
                'Morena': '#8b5cf6',
                'Kearny Mesa': '#3b82f6',
                'Chula Vista': '#ec4899',
                'North Park': '#14b8a6'
            };
            return colors[storeName] || '#6b7280';
        }

        function renderRequestsTab() {
            // Filter requests by type
            const filteredRequests = selectedRestockTypeFilter === 'all'
                ? restockRequests
                : restockRequests.filter(r => (r.itemType || 'product') === selectedRestockTypeFilter);

            // Group by status for summary
            const pendingCount = restockRequests.filter(r => r.status === 'pending').length;
            const approvedCount = restockRequests.filter(r => r.status === 'approved').length;
            const rejectedCount = restockRequests.filter(r => r.status === 'rejected').length;

            // Summary cards and filters
            const headerSection = `
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 16px; color: white;">
                        <div style="font-size: 28px; font-weight: 700;">${pendingCount}</div>
                        <div style="font-size: 12px; opacity: 0.9; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-clock"></i> Pending
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 16px; color: white;">
                        <div style="font-size: 28px; font-weight: 700;">${approvedCount}</div>
                        <div style="font-size: 12px; opacity: 0.9; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-check-circle"></i> Approved
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; padding: 16px; color: white;">
                        <div style="font-size: 28px; font-weight: 700;">${rejectedCount}</div>
                        <div style="font-size: 12px; opacity: 0.9; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-times-circle"></i> Rejected
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); border-radius: 12px; padding: 16px; color: white;">
                        <div style="font-size: 28px; font-weight: 700;">${restockRequests.length}</div>
                        <div style="font-size: 12px; opacity: 0.9; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-list"></i> Total
                        </div>
                    </div>
                </div>

                <!-- Filter Buttons -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="filterRestockByType('all')" style="padding: 10px 20px; border-radius: 25px; border: 2px solid ${selectedRestockTypeFilter === 'all' ? 'var(--accent-primary)' : 'var(--border-color)'}; background: ${selectedRestockTypeFilter === 'all' ? 'var(--accent-primary)' : 'var(--bg-secondary)'}; color: ${selectedRestockTypeFilter === 'all' ? 'white' : 'var(--text-secondary)'}; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-layer-group" style="margin-right: 6px;"></i>All Requests
                        </button>
                        <button onclick="filterRestockByType('product')" style="padding: 10px 20px; border-radius: 25px; border: 2px solid ${selectedRestockTypeFilter === 'product' ? '#10b981' : 'var(--border-color)'}; background: ${selectedRestockTypeFilter === 'product' ? '#10b981' : 'var(--bg-secondary)'}; color: ${selectedRestockTypeFilter === 'product' ? 'white' : 'var(--text-secondary)'}; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-box" style="margin-right: 6px;"></i>Products
                        </button>
                        <button onclick="filterRestockByType('supply')" style="padding: 10px 20px; border-radius: 25px; border: 2px solid ${selectedRestockTypeFilter === 'supply' ? '#8b5cf6' : 'var(--border-color)'}; background: ${selectedRestockTypeFilter === 'supply' ? '#8b5cf6' : 'var(--bg-secondary)'}; color: ${selectedRestockTypeFilter === 'supply' ? 'white' : 'var(--text-secondary)'}; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-tools" style="margin-right: 6px;"></i>Supplies
                        </button>
                    </div>
                    <button onclick="askRestockAIRequests()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 10px 18px; border-radius: 25px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                        <i class="fas fa-robot"></i> Ask AI
                    </button>
                </div>

                <!-- AI Response Area -->
                <div id="restock-requests-ai-response" style="display: none; margin-bottom: 20px;"></div>
            `;

            if (filteredRequests.length === 0) {
                return `
                    ${headerSection}
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted); background: var(--bg-secondary); border-radius: 16px;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="font-size: 16px; margin: 0;">No ${selectedRestockTypeFilter === 'all' ? '' : selectedRestockTypeFilter + ' '}requests found</p>
                        <p style="font-size: 13px; margin-top: 8px;">Click "Create Restock Request" to add one</p>
                    </div>
                `;
            }

            // Sort: pending first, then by date
            const sortedRequests = [...filteredRequests].sort((a, b) => {
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                return new Date(b.requestDate) - new Date(a.requestDate);
            });

            return `
                ${headerSection}
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${sortedRequests.map(request => {
                        const itemType = request.itemType || 'product';
                        const typeColor = itemType === 'supply' ? '#8b5cf6' : '#10b981';
                        const typeIcon = itemType === 'supply' ? 'fa-tools' : 'fa-box';
                        const priorityColor = request.priority === 'high' ? '#ef4444' : request.priority === 'medium' ? '#f59e0b' : '#10b981';
                        const priorityBg = request.priority === 'high' ? '#ef444415' : request.priority === 'medium' ? '#f59e0b15' : '#10b98115';

                        // Status styling
                        let statusBg, statusColor, statusIcon, statusText, borderColor;
                        if (request.status === 'approved') {
                            statusBg = '#10b98120'; statusColor = '#10b981'; statusIcon = 'fa-check-circle'; statusText = 'Approved'; borderColor = '#10b981';
                        } else if (request.status === 'rejected') {
                            statusBg = '#ef444420'; statusColor = '#ef4444'; statusIcon = 'fa-times-circle'; statusText = 'Rejected'; borderColor = '#ef4444';
                        } else {
                            statusBg = '#f59e0b20'; statusColor = '#f59e0b'; statusIcon = 'fa-clock'; statusText = 'Pending Review'; borderColor = '#f59e0b';
                        }

                        return `
                        <div style="background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border-color); border-left: 4px solid ${borderColor}; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="padding: 20px;">
                                <!-- Top Row: Product Name, Type Badge, Status -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                            <h3 style="margin: 0; font-size: 17px; font-weight: 700; color: var(--text-primary);">${request.productName}</h3>
                                            <span style="background: ${typeColor}; color: white; font-size: 10px; font-weight: 600; padding: 4px 10px; border-radius: 20px; display: inline-flex; align-items: center; gap: 4px;">
                                                <i class="fas ${typeIcon}" style="font-size: 9px;"></i>
                                                ${itemType === 'supply' ? 'Supply' : 'Product'}
                                            </span>
                                            <span style="background: ${priorityBg}; color: ${priorityColor}; font-size: 10px; font-weight: 600; padding: 4px 10px; border-radius: 20px; text-transform: uppercase;">
                                                ${request.priority} Priority
                                            </span>
                                        </div>
                                        <p style="margin: 6px 0 0 0; font-size: 13px; color: var(--text-muted);">
                                            <i class="fas fa-user" style="margin-right: 4px;"></i>${request.requestedBy}
                                            <span style="margin: 0 8px;">‚Ä¢</span>
                                            <i class="fas fa-calendar" style="margin-right: 4px;"></i>${formatDate(request.requestDate)}
                                            <span style="margin: 0 8px;">‚Ä¢</span>
                                            <i class="fas fa-store" style="margin-right: 4px;"></i>${request.store}
                                        </p>
                                    </div>
                                    <div style="background: ${statusBg}; color: ${statusColor}; padding: 8px 16px; border-radius: 25px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                                        <i class="fas ${statusIcon}"></i>
                                        ${statusText}
                                    </div>
                                </div>

                                <!-- Info Grid -->
                                <div style="display: flex; gap: 24px; padding: 16px 20px; background: var(--bg-primary); border-radius: 12px; margin-bottom: 16px;">
                                    <div style="text-align: center; flex: 1;">
                                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-primary);">${request.quantity}</div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Units Needed</div>
                                    </div>
                                    <div style="width: 1px; background: var(--border-color);"></div>
                                    <div style="text-align: center; flex: 1;">
                                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${request.store.replace('VSU ', '')}</div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Store</div>
                                    </div>
                                    <div style="width: 1px; background: var(--border-color);"></div>
                                    <div style="text-align: center; flex: 1;">
                                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary); font-family: 'Space Mono', monospace;">#${String(request.id).padStart(4, '0')}</div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Request ID</div>
                                    </div>
                                </div>

                                ${request.notes ? `
                                    <div style="padding: 12px 16px; background: var(--bg-primary); border-radius: 10px; margin-bottom: 16px; border-left: 3px solid var(--accent-primary);">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Notes</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">${request.notes}</div>
                                    </div>
                                ` : ''}

                                <!-- Actions -->
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                    <div style="display: flex; gap: 8px;">
                                        ${request.status === 'pending' ? `
                                            <button onclick="approveRestockRequest('${request.firestoreId || request.id}')" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button onclick="rejectRestockRequest('${request.firestoreId || request.id}')" style="background: transparent; color: #ef4444; border: 2px solid #ef4444; padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#ef4444'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='#ef4444'">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                        ` : `
                                            <span style="font-size: 12px; color: var(--text-muted); font-style: italic;">
                                                ${request.status === 'approved' ? 'This request has been approved' : 'This request was rejected'}
                                            </span>
                                        `}
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn-icon" onclick="openEditRestockRequestModal('${request.firestoreId || request.id}')" title="Edit Request" style="width: 38px; height: 38px; border-radius: 10px;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon danger" onclick="deleteRestockRequest('${request.firestoreId || request.id}')" title="Delete Request" style="width: 38px; height: 38px; border-radius: 10px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;}).join('')}
                </div>
            `;
        }

        // State for approved tab month navigation
        let approvedMonthOffset = 0; // 0 = current month, -1 = last month, etc.

        // Render Approved Tab - List of all approved restock requests with month navigation
        function renderApprovedTab() {
            const allApprovedRequests = restockRequests.filter(r => r.status === 'approved');

            // Calculate the target month based on offset
            const now = new Date();
            const targetDate = new Date(now.getFullYear(), now.getMonth() + approvedMonthOffset, 1);
            const targetMonth = targetDate.getMonth();
            const targetYear = targetDate.getFullYear();

            // Filter by selected month
            const approvedRequests = allApprovedRequests.filter(req => {
                const reqDate = new Date(req.requestDate || req.approvedDate || Date.now());
                return reqDate.getMonth() === targetMonth && reqDate.getFullYear() === targetYear;
            });

            // Month names
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const currentMonthName = monthNames[targetMonth];

            // Header with month navigation
            const headerSection = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--text-primary);">
                            <i class="fas fa-check-circle" style="color: #10b981; margin-right: 8px;"></i>Approved Requests
                        </h3>
                        <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-muted);">
                            ${approvedRequests.length} items in ${currentMonthName} ${targetYear}
                        </p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <!-- Month Navigation -->
                        <div style="display: flex; align-items: center; gap: 8px; background: var(--bg-secondary); border-radius: 12px; padding: 6px; border: 1px solid var(--border-color);">
                            <button onclick="navigateApprovedMonth(-1)" style="width: 36px; height: 36px; border-radius: 8px; border: none; background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='var(--accent-primary)'; this.style.color='white'" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)'">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div style="min-width: 140px; text-align: center; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                                ${currentMonthName} ${targetYear}
                            </div>
                            <button onclick="navigateApprovedMonth(1)" ${approvedMonthOffset >= 0 ? 'disabled' : ''} style="width: 36px; height: 36px; border-radius: 8px; border: none; background: ${approvedMonthOffset >= 0 ? 'var(--bg-secondary)' : 'var(--bg-tertiary)'}; color: ${approvedMonthOffset >= 0 ? 'var(--text-muted)' : 'var(--text-primary)'}; cursor: ${approvedMonthOffset >= 0 ? 'not-allowed' : 'pointer'}; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" ${approvedMonthOffset < 0 ? `onmouseover="this.style.background='var(--accent-primary)'; this.style.color='white'" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)'"` : ''}>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button onclick="exportApprovedRequests()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            `;

            if (approvedRequests.length === 0) {
                return `
                    ${headerSection}
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted); background: var(--bg-secondary); border-radius: 16px;">
                        <i class="fas fa-clipboard-check" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="font-size: 16px; margin: 0;">No approved requests in ${currentMonthName} ${targetYear}</p>
                        <p style="font-size: 13px; margin-top: 8px;">Use the arrows to navigate to other months</p>
                    </div>
                `;
            }

            // Group approved items by store for summary
            const groupedByStore = {};
            approvedRequests.forEach(req => {
                const store = req.store || 'Unknown';
                if (!groupedByStore[store]) {
                    groupedByStore[store] = [];
                }
                groupedByStore[store].push(req);
            });

            // Sort by date (newest first)
            const sortedRequests = [...approvedRequests].sort((a, b) => {
                return new Date(b.requestDate) - new Date(a.requestDate);
            });

            return `
                ${headerSection}

                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 16px; color: white;">
                        <div style="font-size: 28px; font-weight: 700;">${approvedRequests.length}</div>
                        <div style="font-size: 12px; opacity: 0.9;"><i class="fas fa-check-circle" style="margin-right: 4px;"></i>Total Approved</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; padding: 16px; color: white;">
                        <div style="font-size: 28px; font-weight: 700;">${approvedRequests.reduce((sum, r) => sum + parseInt(r.quantity || 0), 0)}</div>
                        <div style="font-size: 12px; opacity: 0.9;"><i class="fas fa-boxes" style="margin-right: 4px;"></i>Total Units</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 16px; color: white;">
                        <div style="font-size: 28px; font-weight: 700;">${Object.keys(groupedByStore).length}</div>
                        <div style="font-size: 12px; opacity: 0.9;"><i class="fas fa-store" style="margin-right: 4px;"></i>Stores</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; padding: 16px; color: white;">
                        <div style="font-size: 28px; font-weight: 700;">${approvedRequests.filter(r => r.priority === 'high').length}</div>
                        <div style="font-size: 12px; opacity: 0.9;"><i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>High Priority</div>
                    </div>
                </div>

                <!-- Approved Items Table -->
                <div style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color);">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg-tertiary);">
                                <th style="padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Product</th>
                                <th style="padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Type</th>
                                <th style="padding: 14px 16px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Qty</th>
                                <th style="padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Store</th>
                                <th style="padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Priority</th>
                                <th style="padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Approved Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedRequests.map((req, index) => {
                                const itemType = req.itemType || 'product';
                                const typeColor = itemType === 'supply' ? '#8b5cf6' : '#10b981';
                                const typeIcon = itemType === 'supply' ? 'fa-tools' : 'fa-box';
                                const priorityColor = req.priority === 'high' ? '#ef4444' : req.priority === 'medium' ? '#f59e0b' : '#10b981';

                                return `
                                    <tr style="border-bottom: 1px solid var(--border-color);" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 14px 16px;">
                                            <div style="font-weight: 600; color: var(--text-primary);">${req.productName}</div>
                                            ${req.notes ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${req.notes.substring(0, 50)}${req.notes.length > 50 ? '...' : ''}</div>` : ''}
                                        </td>
                                        <td style="padding: 14px 16px;">
                                            <span style="background: ${typeColor}20; color: ${typeColor}; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; display: inline-flex; align-items: center; gap: 4px;">
                                                <i class="fas ${typeIcon}" style="font-size: 10px;"></i>
                                                ${itemType === 'supply' ? 'Supply' : 'Product'}
                                            </span>
                                        </td>
                                        <td style="padding: 14px 16px; text-align: center;">
                                            <span style="font-size: 18px; font-weight: 700; color: var(--accent-primary);">${req.quantity}</span>
                                        </td>
                                        <td style="padding: 14px 16px;">
                                            <span style="font-size: 13px; color: var(--text-secondary);">${req.store}</span>
                                        </td>
                                        <td style="padding: 14px 16px;">
                                            <span style="background: ${priorityColor}20; color: ${priorityColor}; font-size: 10px; font-weight: 600; padding: 4px 10px; border-radius: 20px; text-transform: uppercase;">
                                                ${req.priority}
                                            </span>
                                        </td>
                                        <td style="padding: 14px 16px;">
                                            <div style="font-size: 13px; color: var(--text-secondary);">${formatDate(req.requestDate)}</div>
                                            <div style="font-size: 11px; color: var(--text-muted);">by ${req.requestedBy}</div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

                <!-- Summary by Store -->
                <div style="margin-top: 24px;">
                    <h4 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">
                        <i class="fas fa-store" style="margin-right: 8px;"></i>Summary by Store
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        ${Object.entries(groupedByStore).map(([store, items]) => `
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color);">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${store}</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; color: var(--text-muted);">${items.length} items</span>
                                    <span style="font-size: 13px; font-weight: 600; color: var(--accent-primary);">${items.reduce((sum, i) => sum + parseInt(i.quantity || 0), 0)} units</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Navigate approved month
        function navigateApprovedMonth(direction) {
            // direction: -1 for previous month, +1 for next month
            const newOffset = approvedMonthOffset + direction;
            // Don't allow going into the future
            if (newOffset <= 0) {
                approvedMonthOffset = newOffset;
                const tabContent = document.getElementById('restock-tab-content');
                if (tabContent && currentRestockTab === 'approved') {
                    tabContent.innerHTML = renderApprovedTab();
                }
            }
        }

        // Export approved requests to CSV
        function exportApprovedRequests() {
            const approvedRequests = restockRequests.filter(r => r.status === 'approved');

            if (approvedRequests.length === 0) {
                showToast('No approved requests to export', 'warning');
                return;
            }

            const headers = ['Product Name', 'Type', 'Quantity', 'Store', 'Priority', 'Requested By', 'Request Date', 'Notes'];
            const rows = approvedRequests.map(req => [
                req.productName,
                req.itemType || 'product',
                req.quantity,
                req.store,
                req.priority,
                req.requestedBy,
                req.requestDate,
                req.notes || ''
            ]);

            const csvContent = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `approved_restock_requests_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            showToast('Exported approved requests to CSV', 'success');
        }

        // Call AI for restock analysis (uses OpenAI GPT-4)
        async function callRestockAI(prompt) {
            const openaiKey = celesteFirebaseSettings?.openai_api_key || getOpenAIKey();

            if (!openaiKey) {
                throw new Error('OpenAI API key not configured');
            }

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${openaiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    max_tokens: 500,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (response.ok) {
                const data = await response.json();
                return data.choices[0].message.content;
            }

            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'OpenAI API failed');
        }

        // AI Assistant for Requests Tab - helps prioritize and analyze pending requests
        async function askRestockAIRequests() {
            const responseDiv = document.getElementById('restock-requests-ai-response');
            if (!responseDiv) return;

            // Show loading state
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #8b5cf620 0%, #7c3aed20 100%); border-radius: 16px; padding: 20px; border: 1px solid #8b5cf640;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-robot" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">AI Analyzing Requests...</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Evaluating priorities and recommendations</div>
                        </div>
                        <i class="fas fa-spinner fa-spin" style="margin-left: auto; color: #8b5cf6; font-size: 20px;"></i>
                    </div>
                </div>
            `;

            try {
                // Gather data for AI analysis
                const pendingRequests = restockRequests.filter(r => r.status === 'pending');
                const approvedRequests = restockRequests.filter(r => r.status === 'approved');
                const highPriorityPending = pendingRequests.filter(r => r.priority === 'high');

                const dataContext = `
                    Pending Restock Requests (${pendingRequests.length}):
                    ${pendingRequests.map(r => `- ${r.productName}: ${r.quantity} units for ${r.store} (${r.priority} priority) - Requested by ${r.requestedBy} on ${r.requestDate}`).join('\n')}

                    High Priority Pending (${highPriorityPending.length}):
                    ${highPriorityPending.map(r => `- ${r.productName}: ${r.quantity} units for ${r.store}`).join('\n')}

                    Already Approved (${approvedRequests.length}):
                    ${approvedRequests.slice(0, 5).map(r => `- ${r.productName}: ${r.quantity} units`).join('\n')}
                `;

                const prompt = `You are a helpful inventory manager assistant. Analyze these pending restock requests and help the manager decide which ones to prioritize. Be concise and practical.

                ${dataContext}

                Provide:
                1. A quick assessment (1-2 sentences)
                2. Which requests should be approved first and why (top 3 if applicable)
                3. Any patterns or concerns you notice`;

                // Try to call the AI
                const response = await callRestockAI(prompt);

                responseDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #8b5cf620 0%, #7c3aed20 100%); border-radius: 16px; padding: 20px; border: 1px solid #8b5cf640;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-robot" style="color: white; font-size: 18px;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">AI Recommendations</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Priority analysis for pending requests</div>
                            </div>
                            <button onclick="document.getElementById('restock-requests-ai-response').style.display='none'" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap;">${response}</div>
                    </div>
                `;

            } catch (error) {
                console.error('AI Error:', error);
                responseDiv.innerHTML = `
                    <div style="background: #ef444420; border-radius: 16px; padding: 20px; border: 1px solid #ef444440;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-exclamation-circle" style="color: #ef4444; font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: 600; color: #ef4444;">AI Unavailable</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Could not connect to AI service. Check API settings in Project Analytics.</div>
                            </div>
                            <button onclick="document.getElementById('restock-requests-ai-response').style.display='none'" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; margin-left: auto;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        async function switchRestockTab(tab) {
            currentRestockTab = tab;
            await renderRestockRequests();
        }

        function filterInventoryByStore(store) {
            selectedStoreFilter = store;
            // Just update the tab content without re-rendering the whole page
            const tabContent = document.getElementById('restock-tab-content');
            if (tabContent && currentRestockTab === 'inventory') {
                tabContent.innerHTML = renderInventoryTab();
                displayInventoryStockChart();
            }
        }

        function filterRestockByType(type) {
            selectedRestockTypeFilter = type;
            // Just update the tab content without re-rendering the whole page
            const tabContent = document.getElementById('restock-tab-content');
            if (tabContent && currentRestockTab === 'requests') {
                tabContent.innerHTML = renderRequestsTab();
            }
        }

        function approveRestockRequest(requestId) {
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);
            if (request) {
                request.status = 'approved';
                
                // Update in Firebase if initialized
                if (firebaseRestockRequestsManager.isInitialized) {
                    firebaseRestockRequestsManager.updateRestockRequest(request.firestoreId || requestId, {
                        status: 'approved'
                    }).then(success => {
                        if (success) {
                            console.log('Request approved in Firebase:', requestId);
                            renderRestockRequests();
                        }
                    }).catch(error => {
                        console.error('Error approving request in Firebase:', error);
                        renderRestockRequests();
                    });
                } else {
                    renderRestockRequests();
                }
            }
        }

        function rejectRestockRequest(requestId) {
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);
            if (request) {
                request.status = 'rejected';
                
                // Update in Firebase if initialized
                if (firebaseRestockRequestsManager.isInitialized) {
                    firebaseRestockRequestsManager.updateRestockRequest(request.firestoreId || requestId, {
                        status: 'rejected'
                    }).then(success => {
                        if (success) {
                            console.log('Request rejected in Firebase:', requestId);
                            renderRestockRequests();
                        }
                    }).catch(error => {
                        console.error('Error rejecting request in Firebase:', error);
                        renderRestockRequests();
                    });
                } else {
                    renderRestockRequests();
                }
            }
        }

        // Current priority filter, store filter, and sort
        let currentRequestPriorityFilter = 'all';
        let currentRequestStoreFilter = 'all';
        let currentRequestSort = 'none'; // none, alpha, qty, store

        // Set priority filter for requests
        window.setRequestPriorityFilter = function(filter) {
            currentRequestPriorityFilter = filter;

            // Update tab styles
            ['all', 'high', 'medium', 'low', 'pending'].forEach(f => {
                const btn = document.getElementById(`req-filter-${f}`);
                if (btn) {
                    if (f === filter) {
                        if (f === 'high') {
                            btn.style.background = '#ef4444';
                            btn.style.color = 'white';
                        } else if (f === 'medium') {
                            btn.style.background = '#f59e0b';
                            btn.style.color = 'white';
                        } else if (f === 'low') {
                            btn.style.background = '#10b981';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = 'var(--accent-primary)';
                            btn.style.color = 'white';
                        }
                    } else {
                        btn.style.background = 'var(--bg-secondary)';
                        if (f === 'high') btn.style.color = '#ef4444';
                        else if (f === 'medium') btn.style.color = '#f59e0b';
                        else if (f === 'low') btn.style.color = '#10b981';
                        else btn.style.color = 'var(--text-secondary)';
                    }
                }
            });

            // Filter and re-render the list
            renderFilteredRequests();
        };

        // Set sort option for requests
        window.setRequestSort = function(sort) {
            // Toggle off if clicking same sort
            currentRequestSort = (currentRequestSort === sort) ? 'none' : sort;

            // Update sort button styles
            ['alpha', 'qty', 'store'].forEach(s => {
                const btn = document.getElementById(`req-sort-${s}`);
                if (btn) {
                    if (s === currentRequestSort) {
                        btn.style.background = 'var(--accent-primary)';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'var(--bg-secondary)';
                        btn.style.color = 'var(--text-secondary)';
                    }
                }
            });

            renderFilteredRequests();
        };

        // Set store filter for requests
        window.setRequestStoreFilter = function(store) {
            currentRequestStoreFilter = store;
            renderFilteredRequests();
        };

        // Render filtered requests without full page re-render
        function renderFilteredRequests() {
            const listContainer = document.querySelector('.product-requests-list');
            if (!listContainer) return;

            let filtered = [...restockRequests];

            // Apply priority filter
            if (currentRequestPriorityFilter === 'pending') {
                filtered = filtered.filter(r => !r.purchased);
            } else if (currentRequestPriorityFilter !== 'all') {
                filtered = filtered.filter(r => r.priority === currentRequestPriorityFilter);
            }

            // Apply store filter
            if (currentRequestStoreFilter !== 'all') {
                filtered = filtered.filter(r => r.store === currentRequestStoreFilter);
            }

            // Apply sorting
            if (currentRequestSort === 'alpha') {
                filtered.sort((a, b) => (a.productName || '').localeCompare(b.productName || ''));
            } else if (currentRequestSort === 'qty') {
                filtered.sort((a, b) => (b.quantity || 0) - (a.quantity || 0));
            } else if (currentRequestSort === 'store') {
                filtered.sort((a, b) => (a.store || '').localeCompare(b.store || ''));
            }

            // Update title and count
            const titleEl = document.getElementById('requests-list-title');
            const countEl = document.getElementById('requests-list-count');
            const sortLabel = currentRequestSort !== 'none' ? ` (${currentRequestSort === 'alpha' ? 'A-Z' : currentRequestSort === 'qty' ? 'by Qty' : 'by Store'})` : '';
            if (titleEl) {
                const titles = { all: 'All Requests', high: 'High Priority', medium: 'Medium Priority', low: 'Low Priority', pending: 'Pending' };
                titleEl.textContent = (titles[currentRequestPriorityFilter] || 'All Requests') + sortLabel;
            }
            if (countEl) countEl.textContent = `${filtered.length} items`;

            // Re-render list
            if (filtered.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-filter" style="font-size: 32px; opacity: 0.3; margin-bottom: 12px;"></i>
                        <p style="font-size: 13px; margin: 0;">No ${currentRequestPriorityFilter} requests</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filtered.map(request => {
                const priorityColor = request.priority === 'high' ? '#ef4444' : request.priority === 'medium' ? '#f59e0b' : '#10b981';
                const isPurchased = request.purchased || false;
                const rowBg = isPurchased ? 'linear-gradient(90deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05))' : 'transparent';
                const rowBorder = isPurchased ? '2px solid #10b981' : '1px solid var(--border-color)';
                return `
                    <div class="request-row" id="request-row-${request.firestoreId || request.id}" style="display: flex; align-items: center; padding: 12px 16px; border-bottom: ${rowBorder}; background: ${rowBg}; gap: 12px; transition: all 0.3s ease;">
                        <div onclick="toggleRequestPurchased('${request.firestoreId || request.id}')" style="cursor: pointer; min-width: 32px; height: 32px; border-radius: 8px; border: 2px solid ${isPurchased ? '#10b981' : 'var(--border-color)'}; background: ${isPurchased ? '#10b981' : 'transparent'}; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            ${isPurchased ? '<i class="fas fa-check" style="color: white; font-size: 14px;"></i>' : ''}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: ${isPurchased ? '#10b981' : 'var(--text-primary)'}; font-size: 14px; ${isPurchased ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${request.productName}</div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px; flex-wrap: wrap;">
                                <span style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-store" style="margin-right: 4px;"></i>${request.store || '-'}</span>
                            </div>
                        </div>
                        <div style="text-align: center; min-width: 40px;">
                            <div style="font-weight: 700; font-size: 18px; color: ${isPurchased ? '#10b981' : 'var(--accent-primary)'};">${request.quantity}</div>
                        </div>
                        <div>
                            <span style="background: ${priorityColor}20; color: ${priorityColor}; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase;">${request.priority}</span>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="deleteRestockRequest('${request.firestoreId || request.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 6px; font-size: 14px;" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Clear all purchased requests
        window.clearPurchasedRequests = function() {
            const purchasedCount = restockRequests.filter(r => r.purchased).length;
            if (purchasedCount === 0) return;

            showConfirmModal({
                title: 'Clear Purchased Items',
                message: `Delete ${purchasedCount} purchased item${purchasedCount > 1 ? 's' : ''} from the list?`,
                confirmText: 'Clear',
                type: 'danger',
                onConfirm: async () => {
                    const purchasedIds = restockRequests.filter(r => r.purchased).map(r => r.firestoreId || r.id);

                    // Delete from Firebase
                    if (firebaseRestockRequestsManager.isInitialized) {
                        for (const id of purchasedIds) {
                            try {
                                await firebaseRestockRequestsManager.deleteRestockRequest(id);
                            } catch (e) {
                                console.error('Error deleting:', e);
                            }
                        }
                    }

                    // Remove from local array
                    restockRequests = restockRequests.filter(r => !r.purchased);
                    renderRestockRequests();
                    showNotification(`${purchasedCount} items cleared`, 'success');
                }
            });
        };

        // Toggle purchased status for a request (palomita)
        window.toggleRequestPurchased = async function(requestId) {
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);
            if (!request) return;

            // Toggle the purchased status
            request.purchased = !request.purchased;

            // Update the row visually immediately
            const row = document.getElementById(`request-row-${requestId}`);
            if (row) {
                if (request.purchased) {
                    row.style.background = 'linear-gradient(90deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05))';
                    row.style.borderBottom = '2px solid #10b981';
                } else {
                    row.style.background = 'transparent';
                    row.style.borderBottom = '1px solid var(--border-color)';
                }
            }

            // Save to Firebase
            if (firebaseRestockRequestsManager.isInitialized) {
                try {
                    await firebaseRestockRequestsManager.updateRestockRequest(requestId, { purchased: request.purchased });
                } catch (error) {
                    console.error('Error updating purchased status:', error);
                }
            }

            // Re-render to update all visuals
            renderRestockRequests();
        };

        function deleteRestockRequest(requestId) {
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);
            const productName = request?.productName || 'this request';

            showConfirmModal({
                title: 'Delete Restock Request',
                message: `Are you sure you want to delete the restock request for "${productName}"?`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: () => {
                    // Remove from local array
                    const index = restockRequests.findIndex(r => r.firestoreId === requestId || r.id === requestId);
                    if (index > -1) {
                        restockRequests.splice(index, 1);
                    }

                    // Delete from Firebase if initialized
                    if (firebaseRestockRequestsManager.isInitialized) {
                        firebaseRestockRequestsManager.deleteRestockRequest(requestId).then(success => {
                            if (success) {
                                console.log('Request deleted from Firebase:', requestId);
                                renderRestockRequests();
                            }
                        }).catch(error => {
                            console.error('Error deleting request from Firebase:', error);
                            renderRestockRequests();
                        });
                    } else {
                        renderRestockRequests();
                    }
                }
            });
        }

        let editingRestockRequestId = null;

        function openEditRestockRequestModal(requestId) {
            editingRestockRequestId = requestId;
            const request = restockRequests.find(r => r.firestoreId === requestId || r.id === requestId);

            if (!request) {
                alert('Request not found');
                return;
            }

            openModal('edit-restock-request');

            // Populate form with current values
            setTimeout(() => {
                // Set form values directly - no need to parse brand/flavor
                document.getElementById('edit-restock-product').value = request.productName || '';
                document.getElementById('edit-restock-quantity').value = request.quantity || '';
                document.getElementById('edit-restock-priority').value = request.priority || 'medium';
                document.getElementById('edit-restock-store').value = request.store || '';
                document.getElementById('edit-restock-notes').value = request.notes || '';

                // Populate and set employee dropdown
                populateEmployeeDropdown('edit-restock-requested-by', request.requestedBy || '');
            }, 100);
        }

        function submitEditRestockRequest() {
            const productName = document.getElementById('edit-restock-product').value.trim();
            const quantity = document.getElementById('edit-restock-quantity').value;
            const priority = document.getElementById('edit-restock-priority').value;
            const store = document.getElementById('edit-restock-store').value;
            const requestedByEl = document.getElementById('edit-restock-requested-by');
            const requestedBy = requestedByEl ? requestedByEl.value : '';
            const notes = document.getElementById('edit-restock-notes').value;

            // Validation
            if (!productName || !quantity || !store) {
                alert('Please fill in Product Name, Quantity, and Store');
                return;
            }

            // Find and update the request
            const request = restockRequests.find(r => r.firestoreId === editingRestockRequestId || r.id === editingRestockRequestId);
            if (!request) {
                alert('Request not found');
                return;
            }

            // Update local request
            request.productName = productName;
            request.quantity = parseInt(quantity);
            request.priority = priority || 'medium';
            request.store = store;
            if (requestedBy) request.requestedBy = requestedBy;
            request.notes = notes;

            // Update in Firebase if initialized
            if (firebaseRestockRequestsManager.isInitialized) {
                const updateData = {
                    productName: productName,
                    quantity: parseInt(quantity),
                    priority: priority || 'medium',
                    store: store,
                    notes: notes
                };
                if (requestedBy) updateData.requestedBy = requestedBy;

                firebaseRestockRequestsManager.updateRestockRequest(editingRestockRequestId, updateData).then(success => {
                    if (success) {
                        console.log('Request updated in Firebase:', editingRestockRequestId);
                        closeModal();
                        showNotification('Request updated successfully!', 'success');
                        renderRestockRequests();
                    } else {
                        alert('Error updating request. Please try again.');
                    }
                }).catch(error => {
                    console.error('Error updating request in Firebase:', error);
                    alert('Error updating request: ' + error.message);
                });
            } else {
                // Fallback to local storage only
                closeModal();
                showNotification('Request updated successfully!', 'success');
                renderRestockRequests();
            }

            editingRestockRequestId = null;
        }

        // Product name autocomplete - get unique product names from previous requests
        function getUniqueProductNames() {
            const productNames = restockRequests.map(r => r.productName).filter(Boolean);
            // Get unique names and sort alphabetically
            return [...new Set(productNames)].sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
        }

        // Show product suggestions dropdown
        window.showProductSuggestions = function(inputValue, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            const query = inputValue.toLowerCase().trim();

            // Hide if query is too short
            if (query.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            // Get matching products
            const allProducts = getUniqueProductNames();
            const matches = allProducts.filter(name =>
                name.toLowerCase().includes(query)
            ).slice(0, 10); // Limit to 10 suggestions

            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            // Build dropdown HTML
            dropdown.innerHTML = matches.map(name => {
                // Highlight the matching part
                const lowerName = name.toLowerCase();
                const matchIndex = lowerName.indexOf(query);
                let displayName = name;
                if (matchIndex >= 0) {
                    displayName = name.substring(0, matchIndex) +
                        '<strong style="color: var(--accent-primary);">' +
                        name.substring(matchIndex, matchIndex + query.length) +
                        '</strong>' +
                        name.substring(matchIndex + query.length);
                }

                return `
                    <div onclick="selectProductSuggestion('${name.replace(/'/g, "\\'")}', '${dropdownId}')"
                        style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s; display: flex; align-items: center; gap: 10px;"
                        onmouseover="this.style.background='var(--bg-secondary)'"
                        onmouseout="this.style.background='transparent'">
                        <i class="fas fa-history" style="color: var(--text-muted); font-size: 12px;"></i>
                        <span style="flex: 1;">${displayName}</span>
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';
        };

        // Select a product suggestion
        window.selectProductSuggestion = function(productName, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            // Find the input associated with this dropdown
            const inputId = dropdownId.replace('-suggestions', '-product');
            const input = document.getElementById(inputId);

            if (input) {
                input.value = productName;
                input.focus();
            }

            dropdown.style.display = 'none';
        };

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.form-group')) {
                document.querySelectorAll('.product-suggestions-dropdown').forEach(d => d.style.display = 'none');
            }
        });

        function renderAbundanceCloud() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <!-- Quick Actions -->
                <div class="abundance-quick-actions">
                    <button class="abundance-action-btn shipping" onclick="showMarkAsSection('shipping')">
                        <div class="action-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <span>Mark as Prepared</span>
                    </button>
                    <button class="abundance-action-btn pickup" onclick="showMarkAsSection('pickup')">
                        <div class="action-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <span>Mark Ready for Pickup</span>
                    </button>
                    <button class="abundance-action-btn delivered" onclick="showMarkAsSection('delivered')">
                        <div class="action-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <span>Mark Delivered</span>
                    </button>
                    <a href="https://admin.shopify.com/store/k1xm3v-v0/orders" target="_blank" rel="noopener noreferrer" class="abundance-action-btn shopify">
                        <div class="action-icon">
                            <i class="fab fa-shopify"></i>
                        </div>
                        <span>Go to Shopify Admin</span>
                    </a>
                </div>

                <!-- Filter Tabs -->
                <div class="abundance-filter-tabs">
                    <button class="filter-tab active" data-filter="all" onclick="filterOrders('all')">
                        <i class="fas fa-border-all"></i>
                        <span>All</span>
                    </button>
                    <button class="filter-tab" data-filter="shipping" onclick="filterOrders('shipping')">
                        <i class="fas fa-truck"></i>
                        <span>Shipping</span>
                    </button>
                    <button class="filter-tab" data-filter="pickup" onclick="filterOrders('pickup')">
                        <i class="fas fa-store"></i>
                        <span>Pickup</span>
                    </button>
                    <button class="filter-tab" data-filter="manual" onclick="filterOrders('manual')">
                        <i class="fas fa-file-pdf"></i>
                        <span>Manual</span>
                    </button>
                </div>

                <!-- Orders Table Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i>
                            Orders
                        </h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span id="selectedCount" class="text-muted" style="font-size: 13px; display: none;">
                                <span id="selectedNum">0</span> selected
                            </span>
                            <button class="btn-secondary" id="printSelectedBtn" onclick="printSelected()" style="display: none;">
                                <i class="fas fa-print"></i>
                                Print Selected
                            </button>
                            <button class="card-action" onclick="refreshOrders()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="loadingOrders" class="loading-state">
                            <div class="spinner"></div>
                            <span>Loading orders...</span>
                        </div>
                        <div id="ordersTableContainer" style="display: none;">
                            <table class="abundance-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                        </th>
                                        <th>#</th>
                                        <th>Customer</th>
                                        <th>Line Items</th>
                                        <th>Status</th>
                                        <th>Pickup / Shipping</th>
                                        <th>Taxes</th>
                                        <th>Total</th>
                                        <th style="width: 120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <!-- Orders will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="emptyState" class="empty-state" style="display: none;">
                            <i class="fas fa-inbox"></i>
                            <h3>No orders found</h3>
                            <p>Orders will appear here once they are available</p>
                        </div>
                    </div>
                </div>
            `;

            // Initialize Abundance Cloud after rendering
            if (typeof initializeAbundanceCloud === 'function') {
                setTimeout(() => {
                    initializeAbundanceCloud();
                }, 100);
            }
        }

        function renderTaskCard(task) {
            return `
                <div class="task-card priority-${task.priority}">
                    <div class="task-priority ${task.priority}">${task.priority}</div>
                    <h4 class="task-title">${task.title}</h4>
                    <div class="task-meta">
                        <span><i class="fas fa-user"></i> ${task.assignee}</span>
                        <span><i class="fas fa-calendar"></i> ${formatDate(task.due)}</span>
                    </div>
                </div>
            `;
        }

        // Schedules data array
        let schedules = [];
        let daysOff = []; // Array to store employee days off: { employeeId, date, store }
        let currentWeekStart = getWeekStart(new Date());
        let draggedShift = null;

        // Shift types configuration
        const SHIFT_TYPES = {
            opening: {
                name: 'Opening',
                icon: 'fa-sun',
                color: '#f59e0b',
                gradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                defaultStart: '09:00',
                defaultEnd: '17:00'
            },
            closing: {
                name: 'Closing',
                icon: 'fa-moon',
                color: '#6366f1',
                gradient: 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)',
                defaultStart: '14:00',
                defaultEnd: '22:00'
            }
        };

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            // Adjust so week starts on Monday (day 1) instead of Sunday (day 0)
            // If today is Sunday (0), go back 6 days to Monday
            // Otherwise, go back (day - 1) days to Monday
            const diff = d.getDate() - (day === 0 ? 6 : day - 1);
            return new Date(d.setDate(diff));
        }

        function getWeekDates(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function formatDateKey(date) {
            // Use local date components to avoid timezone offset issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Convert number to ordinal (1st, 2nd, 3rd, etc.)
         */
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function renderSchedule() {
            const dashboard = document.querySelector('.dashboard');
            const weekDates = getWeekDates(currentWeekStart);
            const weekRangeText = `${weekDates[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekDates[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            dashboard.innerHTML = `
                <style>
                    /* Schedule Header */
                    .schedule-header-bar {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 24px;
                        flex-wrap: wrap;
                        gap: 16px;
                    }
                    .schedule-title-section h2 {
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 4px;
                    }
                    .schedule-title-section p {
                        color: var(--text-muted);
                        font-size: 14px;
                    }
                    .schedule-controls {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    .schedule-controls-row {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .week-nav {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        background: var(--bg-card);
                        padding: 6px;
                        border-radius: 12px;
                        border: 1px solid var(--border-color);
                    }
                    .week-nav-btn {
                        background: transparent;
                        border: none;
                        width: 36px;
                        height: 36px;
                        border-radius: 8px;
                        cursor: pointer;
                        color: var(--text-secondary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    .week-nav-btn:hover {
                        background: var(--accent-primary);
                        color: white;
                    }
                    .week-display {
                        font-size: 15px;
                        font-weight: 600;
                        min-width: 180px;
                        text-align: center;
                        color: var(--text-primary);
                    }
                    .store-filter-select {
                        background: var(--bg-card);
                        border: 1px solid var(--border-color);
                        border-radius: 10px;
                        padding: 10px 16px;
                        color: var(--text-primary);
                        font-size: 14px;
                        cursor: pointer;
                        min-width: 160px;
                    }

                    /* Mobile Schedule Controls */
                    @media (max-width: 768px) {
                        .schedule-header-bar {
                            flex-direction: column;
                            align-items: stretch;
                        }
                        .schedule-controls {
                            flex-direction: column;
                            align-items: stretch;
                            gap: 10px;
                        }
                        .schedule-controls-row {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            width: 100%;
                        }
                        .week-nav {
                            width: 100%;
                            justify-content: center;
                        }
                        .week-display {
                            flex: 1;
                            min-width: auto;
                        }
                        .store-filter-select {
                            flex: 1;
                            min-width: auto;
                        }
                        .schedule-controls > .week-nav-btn {
                            margin-right: 0 !important;
                        }
                    }

                    /* Days Grid - Horizontal scroll for week */
                    .schedule-days-container {
                        display: flex;
                        gap: 12px;
                        overflow-x: auto;
                        padding-bottom: 12px;
                        scroll-snap-type: x mandatory;
                    }
                    .schedule-days-container::-webkit-scrollbar {
                        height: 6px;
                    }
                    .schedule-days-container::-webkit-scrollbar-track {
                        background: var(--bg-secondary);
                        border-radius: 3px;
                    }
                    .schedule-days-container::-webkit-scrollbar-thumb {
                        background: var(--border-color);
                        border-radius: 3px;
                    }

                    /* Day Card */
                    .schedule-day-card {
                        flex: 0 0 calc(14.28% - 10px);
                        min-width: 200px;
                        background: var(--bg-card);
                        border-radius: 16px;
                        border: 1px solid var(--border-color);
                        overflow: hidden;
                        scroll-snap-align: start;
                        transition: all 0.3s ease;
                    }
                    .schedule-day-card:hover {
                        border-color: var(--accent-primary);
                        box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1);
                    }
                    .schedule-day-card.today {
                        border-color: var(--accent-primary);
                        box-shadow: 0 0 0 2px var(--accent-glow);
                    }
                    .day-card-header {
                        padding: 16px;
                        text-align: center;
                        border-bottom: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                    }
                    .schedule-day-card.today .day-card-header {
                        background: var(--accent-gradient);
                    }
                    .schedule-day-card.today .day-card-header * {
                        color: white !important;
                    }
                    .day-card-header .day-name {
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        color: var(--text-muted);
                        font-weight: 600;
                    }
                    .day-card-header .day-number {
                        font-size: 28px;
                        font-weight: 700;
                        color: var(--text-primary);
                        line-height: 1.2;
                    }
                    .day-card-body {
                        padding: 12px;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    /* Shift Slot */
                    .shift-slot {
                        border-radius: 12px;
                        padding: 12px;
                        transition: all 0.2s;
                        position: relative;
                    }
                    .shift-slot.opening {
                        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%);
                        border: 1px solid rgba(245, 158, 11, 0.2);
                    }
                    .shift-slot.closing {
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(79, 70, 229, 0.05) 100%);
                        border: 1px solid rgba(99, 102, 241, 0.2);
                    }
                    .shift-slot-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 10px;
                    }
                    .shift-type-badge {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        font-size: 11px;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .shift-slot.opening .shift-type-badge {
                        color: #f59e0b;
                    }
                    .shift-slot.closing .shift-type-badge {
                        color: #6366f1;
                    }
                    .shift-time-display {
                        font-size: 12px;
                        color: var(--text-muted);
                        font-weight: 500;
                    }

                    /* Employee Drop Zone */
                    .employee-drop-zone {
                        min-height: 50px;
                        border: 2px dashed var(--border-color);
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s;
                        padding: 8px;
                    }
                    .employee-drop-zone:hover {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.05);
                    }
                    .employee-drop-zone.drag-over {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.1);
                        border-style: solid;
                    }
                    .employee-drop-zone.empty {
                        color: var(--text-muted);
                        font-size: 13px;
                    }
                    .employee-drop-zone.empty i {
                        margin-right: 6px;
                    }

                    /* Assigned Employee Card */
                    .assigned-employee {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 8px 12px;
                        background: var(--bg-secondary);
                        border-radius: 10px;
                        width: 100%;
                        cursor: grab;
                        transition: all 0.2s;
                        position: relative;
                    }
                    .assigned-employee:hover {
                        background: var(--bg-hover);
                        transform: translateY(-1px);
                    }
                    .assigned-employee:active {
                        cursor: grabbing;
                    }
                    .assigned-employee.dragging {
                        opacity: 0.5;
                        transform: scale(0.98);
                    }
                    .assigned-employee-avatar {
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 13px;
                        font-weight: 600;
                        color: white;
                        flex-shrink: 0;
                    }
                    .assigned-employee-info {
                        flex: 1;
                        min-width: 0;
                    }
                    .assigned-employee-name {
                        font-size: 14px;
                        font-weight: 600;
                        color: var(--text-primary);
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .assigned-employee-hours {
                        font-size: 12px;
                        color: var(--text-muted);
                    }
                    .assigned-employee-remove {
                        position: absolute;
                        top: -6px;
                        right: -6px;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: var(--danger);
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10px;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .assigned-employee:hover .assigned-employee-remove {
                        opacity: 1;
                    }
                    .assigned-employee-clone {
                        position: absolute;
                        top: -6px;
                        right: 18px;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: var(--accent-primary);
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 9px;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .assigned-employee:hover .assigned-employee-clone {
                        opacity: 1;
                    }
                    .assigned-employee-clone:hover {
                        background: var(--accent-secondary);
                        transform: scale(1.1);
                    }

                    /* Days Off Section */
                    .day-off-section {
                        margin-top: 12px;
                        border-top: 1px solid var(--border-color);
                        padding-top: 12px;
                    }
                    .day-off-header {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px 12px;
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.05) 100%);
                        border-radius: 8px;
                        font-size: 12px;
                        font-weight: 600;
                        color: var(--text-secondary);
                        cursor: pointer;
                        transition: all 0.2s;
                        border: 1px solid rgba(99, 102, 241, 0.15);
                    }
                    .day-off-header:hover {
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(139, 92, 246, 0.08) 100%);
                        border-color: var(--accent-primary);
                    }
                    .day-off-employees {
                        margin-top: 8px;
                        display: flex;
                        flex-direction: column;
                        gap: 6px;
                    }
                    .day-off-employee-badge {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 6px 10px;
                        background: var(--bg-secondary);
                        border-radius: 8px;
                        font-size: 13px;
                        position: relative;
                        transition: all 0.2s;
                    }
                    .day-off-employee-badge:hover {
                        background: var(--bg-hover);
                    }
                    .day-off-avatar {
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        font-weight: 600;
                        color: white;
                        flex-shrink: 0;
                    }
                    .day-off-name {
                        flex: 1;
                        color: var(--text-primary);
                        font-weight: 500;
                        font-size: 12px;
                    }
                    .day-off-remove {
                        width: 18px;
                        height: 18px;
                        border-radius: 50%;
                        background: var(--danger);
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 9px;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .day-off-employee-badge:hover .day-off-remove {
                        opacity: 1;
                    }
                    .day-off-remove:hover {
                        background: #dc2626;
                        transform: scale(1.1);
                    }
                    .day-off-empty {
                        padding: 12px;
                        text-align: center;
                        color: var(--text-muted);
                        font-size: 12px;
                        font-style: italic;
                    }

                    /* Time Slider */
                    .time-slider-container {
                        margin-top: 8px;
                        padding: 12px;
                        background: var(--bg-secondary);
                        border-radius: 10px;
                        display: none;
                    }
                    .time-slider-container.active {
                        display: block;
                    }
                    .time-slider-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                    }
                    .time-slider-label {
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        color: var(--text-muted);
                    }
                    .time-slider-value {
                        font-size: 14px;
                        font-weight: 700;
                        color: var(--text-primary);
                    }
                    .time-slider-track {
                        position: relative;
                        height: 40px;
                        background: var(--bg-card);
                        border-radius: 8px;
                        border: 1px solid var(--border-color);
                        overflow: hidden;
                    }
                    .time-slider-hours {
                        display: flex;
                        justify-content: space-between;
                        padding: 0 4px;
                        margin-top: 6px;
                    }
                    .time-slider-hours span {
                        font-size: 9px;
                        color: var(--text-muted);
                    }
                    .time-slider-range {
                        position: absolute;
                        top: 4px;
                        bottom: 4px;
                        border-radius: 6px;
                        cursor: move;
                        transition: background 0.2s;
                    }
                    .shift-slot.opening .time-slider-range {
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    }
                    .shift-slot.closing .time-slider-range {
                        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
                    }
                    .time-slider-handle {
                        position: absolute;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 16px;
                        height: 28px;
                        background: white;
                        border-radius: 4px;
                        cursor: ew-resize;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .time-slider-handle::after {
                        content: '';
                        width: 4px;
                        height: 12px;
                        background: var(--border-color);
                        border-radius: 2px;
                    }
                    .time-slider-handle.start {
                        left: -8px;
                    }
                    .time-slider-handle.end {
                        right: -8px;
                    }
                    .time-slider-actions {
                        display: flex;
                        gap: 8px;
                        margin-top: 12px;
                    }
                    .time-slider-btn {
                        flex: 1;
                        padding: 8px 12px;
                        border-radius: 8px;
                        border: none;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 600;
                        transition: all 0.2s;
                    }
                    .time-slider-btn.save {
                        background: var(--accent-primary);
                        color: white;
                    }
                    .time-slider-btn.save:hover {
                        background: var(--accent-secondary);
                    }
                    .time-slider-btn.cancel {
                        background: var(--bg-card);
                        color: var(--text-secondary);
                        border: 1px solid var(--border-color);
                    }

                    /* Employee Picker Modal */
                    .employee-picker-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        backdrop-filter: blur(4px);
                        z-index: 1000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0;
                        visibility: hidden;
                        transition: all 0.3s;
                    }
                    .employee-picker-overlay.active {
                        opacity: 1;
                        visibility: visible;
                    }
                    .employee-picker {
                        background: var(--bg-card);
                        border-radius: 20px;
                        width: 90%;
                        max-width: 400px;
                        max-height: 80vh;
                        overflow: hidden;
                        transform: scale(0.9);
                        transition: transform 0.3s;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }
                    .employee-picker-overlay.active .employee-picker {
                        transform: scale(1);
                    }
                    .employee-picker-header {
                        padding: 20px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .employee-picker-header h3 {
                        font-size: 18px;
                        font-weight: 600;
                    }
                    .employee-picker-close {
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        background: var(--bg-secondary);
                        border: none;
                        cursor: pointer;
                        color: var(--text-secondary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    .employee-picker-close:hover {
                        background: var(--danger);
                        color: white;
                    }
                    .employee-picker-search {
                        padding: 16px 20px;
                        border-bottom: 1px solid var(--border-color);
                    }
                    .employee-picker-search input {
                        width: 100%;
                        padding: 12px 16px;
                        border-radius: 10px;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        font-size: 14px;
                    }
                    .employee-picker-search input:focus {
                        outline: none;
                        border-color: var(--accent-primary);
                    }
                    .employee-picker-list {
                        padding: 12px;
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .employee-picker-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .employee-picker-item:hover {
                        background: var(--bg-hover);
                    }
                    .employee-picker-avatar {
                        width: 44px;
                        height: 44px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        font-weight: 600;
                        color: white;
                    }
                    .employee-picker-info {
                        flex: 1;
                    }
                    .employee-picker-name {
                        font-weight: 600;
                        font-size: 15px;
                    }
                    .employee-picker-store {
                        font-size: 13px;
                        color: var(--text-muted);
                    }

                    /* Time Editor Modal */
                    .time-editor-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.6);
                        backdrop-filter: blur(8px);
                        z-index: 1001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0;
                        visibility: hidden;
                        transition: all 0.3s;
                    }
                    .time-editor-overlay.active {
                        opacity: 1;
                        visibility: visible;
                    }
                    .time-editor-modal {
                        background: var(--bg-card);
                        border-radius: 24px;
                        width: 90%;
                        max-width: 480px;
                        overflow: hidden;
                        transform: scale(0.9) translateY(20px);
                        transition: transform 0.3s;
                        box-shadow: 0 25px 80px rgba(0,0,0,0.4);
                    }
                    .time-editor-overlay.active .time-editor-modal {
                        transform: scale(1) translateY(0);
                    }
                    .time-editor-header {
                        padding: 24px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .time-editor-header h3 {
                        font-size: 20px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .time-editor-close {
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        background: var(--bg-secondary);
                        border: none;
                        cursor: pointer;
                        color: var(--text-secondary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        transition: all 0.2s;
                    }
                    .time-editor-close:hover {
                        background: var(--danger);
                        color: white;
                    }
                    .time-editor-body {
                        padding: 24px;
                    }
                    .time-editor-info {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        padding: 16px;
                        background: var(--bg-secondary);
                        border-radius: 16px;
                        margin-bottom: 24px;
                    }
                    .time-editor-avatar {
                        width: 56px;
                        height: 56px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        font-weight: 700;
                        color: white;
                    }
                    .time-editor-details h4 {
                        font-size: 18px;
                        font-weight: 600;
                        margin-bottom: 4px;
                    }
                    .time-editor-details p {
                        font-size: 14px;
                        color: var(--text-muted);
                    }
                    .time-editor-current {
                        text-align: center;
                        margin-bottom: 24px;
                    }
                    .time-editor-current-label {
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        color: var(--text-muted);
                        margin-bottom: 8px;
                    }
                    .time-editor-current-value {
                        font-size: 32px;
                        font-weight: 700;
                        color: var(--text-primary);
                    }
                    .time-editor-current-hours {
                        font-size: 14px;
                        color: var(--accent-primary);
                        margin-top: 4px;
                    }
                    .time-editor-slider-section {
                        margin-bottom: 24px;
                    }
                    .time-editor-slider-label {
                        font-size: 13px;
                        font-weight: 600;
                        color: var(--text-secondary);
                        margin-bottom: 12px;
                        display: flex;
                        justify-content: space-between;
                    }
                    .time-editor-slider-track {
                        position: relative;
                        height: 56px;
                        background: var(--bg-secondary);
                        border-radius: 12px;
                        border: 2px solid var(--border-color);
                        overflow: hidden;
                        margin-bottom: 8px;
                    }
                    .time-editor-slider-track:hover {
                        border-color: var(--accent-primary);
                    }
                    .time-editor-slider-range {
                        position: absolute;
                        top: 4px;
                        bottom: 4px;
                        border-radius: 8px;
                        cursor: grab;
                    }
                    .time-editor-slider-range:active {
                        cursor: grabbing;
                    }
                    .time-editor-slider-range.opening {
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    }
                    .time-editor-slider-range.closing {
                        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
                    }
                    .time-editor-handle {
                        position: absolute;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 24px;
                        height: 44px;
                        background: white;
                        border-radius: 8px;
                        cursor: ew-resize;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: box-shadow 0.2s;
                    }
                    .time-editor-handle:hover {
                        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
                    }
                    .time-editor-handle::after {
                        content: '';
                        width: 6px;
                        height: 20px;
                        background: linear-gradient(180deg, var(--border-color) 0%, var(--border-color) 33%, transparent 33%, transparent 66%, var(--border-color) 66%);
                        border-radius: 3px;
                    }
                    .time-editor-handle.start {
                        left: -12px;
                    }
                    .time-editor-handle.end {
                        right: -12px;
                    }
                    .time-editor-hours-ruler {
                        display: flex;
                        justify-content: space-between;
                        padding: 0 4px;
                    }
                    .time-editor-hours-ruler span {
                        font-size: 11px;
                        color: var(--text-muted);
                        font-weight: 500;
                    }
                    .time-editor-presets {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 10px;
                        margin-bottom: 24px;
                    }
                    .time-editor-preset {
                        padding: 12px;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.2s;
                    }
                    .time-editor-preset:hover {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.1);
                    }
                    .time-editor-preset.active {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.15);
                    }
                    .time-editor-preset-time {
                        font-size: 14px;
                        font-weight: 700;
                        color: var(--text-primary);
                    }
                    .time-editor-preset-label {
                        font-size: 11px;
                        color: var(--text-muted);
                        margin-top: 2px;
                    }
                    .time-editor-footer {
                        padding: 20px 24px;
                        border-top: 1px solid var(--border-color);
                        display: flex;
                        gap: 12px;
                    }
                    .time-editor-btn {
                        flex: 1;
                        padding: 14px 20px;
                        border-radius: 12px;
                        border: none;
                        cursor: pointer;
                        font-size: 15px;
                        font-weight: 600;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    }
                    .time-editor-btn.cancel {
                        background: var(--bg-secondary);
                        color: var(--text-secondary);
                        border: 1px solid var(--border-color);
                    }
                    .time-editor-btn.cancel:hover {
                        background: var(--bg-hover);
                    }
                    .time-editor-btn.save {
                        background: var(--accent-primary);
                        color: white;
                    }
                    .time-editor-btn.save:hover {
                        background: var(--accent-secondary);
                        transform: translateY(-1px);
                    }
                    .time-editor-btn.delete {
                        background: transparent;
                        color: var(--danger);
                        flex: 0;
                        padding: 14px;
                    }
                    .time-editor-btn.delete:hover {
                        background: rgba(239, 68, 68, 0.1);
                    }

                    /* Clone Modal */
                    .clone-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.6);
                        backdrop-filter: blur(8px);
                        z-index: 1001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0;
                        visibility: hidden;
                        transition: all 0.3s;
                    }
                    .clone-modal-overlay.active {
                        opacity: 1;
                        visibility: visible;
                    }
                    .clone-modal {
                        background: var(--bg-card);
                        border-radius: 20px;
                        width: 90%;
                        max-width: 400px;
                        overflow: hidden;
                        transform: scale(0.9);
                        transition: transform 0.3s;
                        box-shadow: 0 25px 80px rgba(0,0,0,0.4);
                    }
                    .clone-modal-overlay.active .clone-modal {
                        transform: scale(1);
                    }
                    .clone-modal-header {
                        padding: 20px 24px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .clone-modal-header h3 {
                        font-size: 18px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .clone-modal-body {
                        padding: 24px;
                    }
                    .clone-option {
                        padding: 16px;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        margin-bottom: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        gap: 14px;
                    }
                    .clone-option:hover {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.05);
                    }
                    .clone-option-icon {
                        width: 44px;
                        height: 44px;
                        border-radius: 10px;
                        background: var(--bg-secondary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        color: var(--accent-primary);
                    }
                    .clone-option-info h4 {
                        font-size: 15px;
                        font-weight: 600;
                        margin-bottom: 2px;
                    }
                    .clone-option-info p {
                        font-size: 13px;
                        color: var(--text-muted);
                    }
                    .clone-modal-footer {
                        padding: 16px 24px;
                        border-top: 1px solid var(--border-color);
                        display: flex;
                        justify-content: flex-end;
                    }

                    /* All Stores View */
                    .stores-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .store-schedule-card {
                        background: var(--bg-card);
                        border-radius: 16px;
                        border: 1px solid var(--border-color);
                        overflow: hidden;
                    }
                    .store-schedule-header {
                        padding: 16px 20px;
                        background: var(--bg-secondary);
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    }
                    .store-schedule-header h4 {
                        font-size: 16px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .store-schedule-header .store-icon {
                        width: 32px;
                        height: 32px;
                        border-radius: 8px;
                        background: var(--accent-gradient);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 14px;
                    }
                    .store-schedule-body {
                        padding: 12px;
                    }
                    .store-day-row {
                        display: flex;
                        align-items: stretch;
                        gap: 8px;
                        padding: 8px 0;
                        border-bottom: 1px solid var(--border-color);
                    }
                    .store-day-row:last-child {
                        border-bottom: none;
                    }
                    .store-day-label {
                        width: 60px;
                        font-size: 11px;
                        font-weight: 600;
                        color: var(--text-muted);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        white-space: nowrap;
                    }
                    .store-day-label.today {
                        color: var(--accent-primary);
                    }
                    .store-shifts {
                        flex: 1;
                        display: flex;
                        gap: 6px;
                    }
                    .store-shift-slot {
                        flex: 1;
                        min-height: 40px;
                        border-radius: 8px;
                        padding: 6px 8px;
                        font-size: 11px;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .store-shift-slot.opening {
                        background: rgba(245, 158, 11, 0.1);
                        border: 1px solid rgba(245, 158, 11, 0.2);
                    }
                    .store-shift-slot.closing {
                        background: rgba(99, 102, 241, 0.1);
                        border: 1px solid rgba(99, 102, 241, 0.2);
                    }
                    .store-shift-slot.empty {
                        background: var(--bg-secondary);
                        border: 1px dashed var(--border-color);
                        align-items: center;
                        color: var(--text-muted);
                    }
                    .store-shift-slot:hover {
                        transform: scale(1.02);
                    }
                    .store-shift-slot.filled {
                        cursor: grab;
                        position: relative;
                    }
                    .store-shift-slot.filled:active {
                        cursor: grabbing;
                    }
                    .store-shift-slot.filled.dragging {
                        opacity: 0.5;
                        transform: scale(0.95);
                    }
                    .store-shift-slot.empty.drag-over {
                        background: rgba(99, 102, 241, 0.2);
                        border: 2px solid var(--accent-primary);
                        border-style: solid;
                    }
                    .store-shift-name {
                        font-weight: 600;
                        color: var(--text-primary);
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .store-shift-time {
                        color: var(--text-muted);
                        font-size: 10px;
                    }
                    .store-shift-clone {
                        position: absolute;
                        top: 2px;
                        right: 2px;
                        width: 18px;
                        height: 18px;
                        border-radius: 4px;
                        background: rgba(255,255,255,0.9);
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 9px;
                        color: var(--accent-primary);
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .store-shift-slot:hover .store-shift-clone {
                        opacity: 1;
                    }
                    .store-shift-clone:hover {
                        background: var(--accent-primary);
                        color: white;
                    }

                    /* Days Off Section for All Stores View */
                    .store-days-off-section {
                        padding: 16px;
                        border-top: 1px solid var(--border-color);
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.02) 100%);
                    }
                    .store-days-off-header {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 12px;
                        color: var(--text-secondary);
                    }
                    .store-days-off-header.clickable {
                        cursor: pointer;
                        padding: 8px 12px;
                        background: rgba(99, 102, 241, 0.05);
                        border-radius: 8px;
                        border: 1px solid rgba(99, 102, 241, 0.15);
                        transition: all 0.2s;
                    }
                    .store-days-off-header.clickable:hover {
                        background: rgba(99, 102, 241, 0.1);
                        border-color: var(--accent-primary);
                        transform: translateY(-1px);
                    }
                    .store-days-off-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    .store-day-off-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 8px 12px;
                        background: var(--bg-card);
                        border-radius: 8px;
                        border: 1px solid var(--border-color);
                        transition: all 0.2s;
                        position: relative;
                    }
                    .store-day-off-item:hover {
                        background: var(--bg-hover);
                        border-color: var(--accent-primary);
                    }
                    .store-day-off-avatar {
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        font-weight: 600;
                        color: white;
                        flex-shrink: 0;
                    }
                    .store-day-off-info {
                        flex: 1;
                        min-width: 0;
                    }
                    .store-day-off-name {
                        font-size: 13px;
                        font-weight: 600;
                        color: var(--text-primary);
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .store-day-off-date {
                        font-size: 11px;
                        color: var(--text-muted);
                    }
                    .store-day-off-remove {
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: var(--danger);
                        color: white;
                        border: none;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10px;
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .store-day-off-item:hover .store-day-off-remove {
                        opacity: 1;
                    }
                    .store-day-off-remove:hover {
                        background: #dc2626;
                        transform: scale(1.1);
                    }
                    .store-days-off-empty {
                        padding: 16px;
                        text-align: center;
                        color: var(--text-muted);
                        font-size: 12px;
                        font-style: italic;
                    }

                    /* Date Picker Modal for All Stores View */
                    .date-picker-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        backdrop-filter: blur(4px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }
                    .date-picker-modal-overlay.active {
                        opacity: 1;
                    }
                    .date-picker-modal {
                        background: var(--bg-card);
                        border-radius: 16px;
                        border: 1px solid var(--border-color);
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        transform: scale(0.9);
                        transition: transform 0.3s ease;
                    }
                    .date-picker-modal-overlay.active .date-picker-modal {
                        transform: scale(1);
                    }
                    .date-picker-header {
                        padding: 20px 24px;
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        background: var(--bg-secondary);
                    }
                    .date-picker-header h3 {
                        margin: 0;
                        font-size: 18px;
                        font-weight: 600;
                        color: var(--text-primary);
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .close-modal-btn {
                        width: 32px;
                        height: 32px;
                        border-radius: 8px;
                        background: transparent;
                        border: none;
                        color: var(--text-muted);
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    .close-modal-btn:hover {
                        background: var(--bg-hover);
                        color: var(--text-primary);
                    }
                    .date-picker-body {
                        padding: 24px;
                    }
                    .date-picker-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                    }
                    .date-picker-option {
                        padding: 16px;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.2s;
                        background: var(--bg-secondary);
                        position: relative;
                    }
                    .date-picker-option:hover {
                        border-color: var(--accent-primary);
                        background: rgba(99, 102, 241, 0.05);
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
                    }
                    .date-picker-option.today {
                        border-color: var(--accent-primary);
                        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
                    }
                    .date-picker-day {
                        font-size: 14px;
                        font-weight: 600;
                        color: var(--text-primary);
                        margin-bottom: 4px;
                    }
                    .date-picker-date {
                        font-size: 12px;
                        color: var(--text-muted);
                    }
                    .date-picker-today-badge {
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: var(--accent-primary);
                        color: white;
                        font-size: 9px;
                        font-weight: 600;
                        padding: 2px 6px;
                        border-radius: 4px;
                        text-transform: uppercase;
                    }
                </style>

                <div class="schedule-header-bar">
                    <div class="schedule-title-section">
                        <h2><i class="fas fa-calendar-alt" style="color: var(--accent-primary); margin-right: 10px;"></i>Schedule</h2>
                        <p>Drag employees to Opening or Closing shifts</p>
                    </div>
                    <div class="schedule-controls">
                        <div class="week-nav">
                            <button class="week-nav-btn" onclick="changeWeek(-1)" title="Previous week">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="week-display">${weekRangeText}</div>
                            <button class="week-nav-btn" onclick="changeWeek(1)" title="Next week">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="week-nav-btn" onclick="goToToday()" title="Today">
                                <i class="fas fa-calendar-day"></i>
                            </button>
                        </div>
                        <div class="schedule-controls-row">
                            <button class="week-nav-btn" onclick="openCloneModal()" title="Clone from previous week" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                                <i class="fas fa-clone"></i>
                            </button>
                            <select class="store-filter-select" id="schedule-store-filter" onchange="renderScheduleGrid()">
                                <option value="all">All Stores</option>
                                <option value="employees">Employees Hours</option>
                                <option value="Miramar">VSU Miramar</option>
                                <option value="Morena">VSU Morena</option>
                                <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                <option value="Chula Vista">VSU Chula Vista</option>
                                <option value="North Park">VSU North Park</option>
                                <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="schedule-container">
                    <div style="padding: 60px; text-align: center;">
                        <div class="loading-spinner"></div>
                        <p style="color: var(--text-muted); margin-top: 15px;">Loading schedules...</p>
                    </div>
                </div>

                <!-- Employee Picker Modal -->
                <div class="employee-picker-overlay" id="employeePickerOverlay" onmousedown="closeEmployeePicker(event)">
                    <div class="employee-picker" onclick="event.stopPropagation()">
                        <div class="employee-picker-header">
                            <h3><i class="fas fa-user-plus" style="margin-right: 8px; color: var(--accent-primary);"></i>Assign Employee</h3>
                            <button class="employee-picker-close" onclick="closeEmployeePicker()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="employee-picker-search">
                            <input type="text" id="employeePickerSearch" placeholder="Search employee..." oninput="filterEmployeePicker()">
                        </div>
                        <div class="employee-picker-list" id="employeePickerList">
                            <!-- Employees will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Time Editor Modal -->
                <div class="time-editor-overlay" id="timeEditorOverlay" onmousedown="closeTimeEditor(event)">
                    <div class="time-editor-modal" onclick="event.stopPropagation()">
                        <div class="time-editor-header">
                            <h3 id="timeEditorTitle"><i class="fas fa-clock"></i> Edit Shift</h3>
                            <button class="time-editor-close" onclick="closeTimeEditor()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="time-editor-body">
                            <div class="time-editor-info" id="timeEditorInfo">
                                <!-- Employee info will be loaded here -->
                            </div>
                            <div class="time-editor-current">
                                <div class="time-editor-current-label">Current Schedule</div>
                                <div class="time-editor-current-value" id="timeEditorCurrentValue">9:00a - 5:00p</div>
                                <div class="time-editor-current-hours" id="timeEditorCurrentHours">8.0 hours</div>
                            </div>
                            <div class="time-editor-presets">
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('06:00', '14:00')">
                                    <div class="time-editor-preset-time">6a - 2p</div>
                                    <div class="time-editor-preset-label">Early</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('09:00', '17:00')">
                                    <div class="time-editor-preset-time">9a - 5p</div>
                                    <div class="time-editor-preset-label">Standard</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('10:00', '18:00')">
                                    <div class="time-editor-preset-time">10a - 6p</div>
                                    <div class="time-editor-preset-label">Mid</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('12:00', '20:00')">
                                    <div class="time-editor-preset-time">12p - 8p</div>
                                    <div class="time-editor-preset-label">Afternoon</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('14:00', '22:00')">
                                    <div class="time-editor-preset-time">2p - 10p</div>
                                    <div class="time-editor-preset-label">Evening</div>
                                </div>
                                <div class="time-editor-preset" onclick="setTimeEditorPreset('16:00', '00:00')">
                                    <div class="time-editor-preset-time">4p - 12a</div>
                                    <div class="time-editor-preset-label">Night</div>
                                </div>
                            </div>
                            <div class="time-editor-slider-section">
                                <div class="time-editor-slider-label">
                                    <span>Drag to adjust</span>
                                </div>
                                <div class="time-editor-slider-track" id="timeEditorTrack">
                                    <div class="time-editor-slider-range" id="timeEditorRange">
                                        <div class="time-editor-handle start" id="timeEditorHandleStart"></div>
                                        <div class="time-editor-handle end" id="timeEditorHandleEnd"></div>
                                    </div>
                                </div>
                                <div class="time-editor-hours-ruler">
                                    <span>6am</span>
                                    <span>9am</span>
                                    <span>12pm</span>
                                    <span>3pm</span>
                                    <span>6pm</span>
                                    <span>9pm</span>
                                    <span>12am</span>
                                </div>
                            </div>
                        </div>
                        <div class="time-editor-footer">
                            <button class="time-editor-btn delete" onclick="deleteFromTimeEditor()" title="Remove shift">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="time-editor-btn cancel" onclick="closeTimeEditor()">Cancel</button>
                            <button class="time-editor-btn save" onclick="saveTimeEditor()">
                                <i class="fas fa-check"></i> Save
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Clone Modal -->
                <div class="clone-modal-overlay" id="cloneModalOverlay" onmousedown="closeCloneModal(event)">
                    <div class="clone-modal" onclick="event.stopPropagation()">
                        <div class="clone-modal-header">
                            <h3><i class="fas fa-clone" style="color: var(--accent-primary);"></i> Clone Schedule</h3>
                            <button class="time-editor-close" onclick="closeCloneModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="clone-modal-body">
                            <div class="clone-option" onclick="cloneFromPreviousWeek()">
                                <div class="clone-option-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <div class="clone-option-info">
                                    <h4>Clone Previous Week</h4>
                                    <p>Copy all shifts from last week to this week</p>
                                </div>
                            </div>
                            <div class="clone-option" onclick="cloneToNextWeek()">
                                <div class="clone-option-icon">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <div class="clone-option-info">
                                    <h4>Clone to Next Week</h4>
                                    <p>Copy this week's shifts to next week</p>
                                </div>
                            </div>
                            <div class="clone-option" onclick="clearCurrentWeek()">
                                <div class="clone-option-icon" style="color: var(--danger);">
                                    <i class="fas fa-trash-alt"></i>
                                </div>
                                <div class="clone-option-info">
                                    <h4>Clear This Week</h4>
                                    <p>Remove all shifts from current week</p>
                                </div>
                            </div>
                        </div>
                        <div class="clone-modal-footer">
                            <button class="time-editor-btn cancel" onclick="closeCloneModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            loadScheduleData();
        }

        async function loadScheduleData() {
            const container = document.getElementById('schedule-container');
            if (!container) return;

            try {
                // Make sure employees are loaded first
                if (employees.length === 0) {
                    await loadEmployeesFromFirebase();
                }

                const db = firebase.firestore();

                // Load schedules
                const schedulesRef = db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules');
                const snapshot = await schedulesRef.get();

                schedules = [];
                snapshot.forEach(doc => {
                    schedules.push({ id: doc.id, ...doc.data() });
                });

                // Load days off
                const daysOffRef = db.collection(window.FIREBASE_COLLECTIONS.daysOff || 'daysOff');
                const daysOffSnapshot = await daysOffRef.get();

                daysOff = [];
                daysOffSnapshot.forEach(doc => {
                    daysOff.push({ id: doc.id, ...doc.data() });
                });

                renderScheduleGrid();
            } catch (error) {
                console.error('Error loading schedules:', error);
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                        <h2 style="color: var(--text-secondary); margin-bottom: 10px;">Connection Error</h2>
                        <p style="color: var(--text-muted);">Unable to load schedule data.</p>
                        <button class="btn-primary" style="margin-top: 20px;" onclick="loadScheduleData()"><i class="fas fa-sync"></i> Retry</button>
                    </div>
                `;
            }
        }

        function renderScheduleGrid() {
            const container = document.getElementById('schedule-container');
            if (!container) return;

            const storeFilter = document.getElementById('schedule-store-filter')?.value || 'all';
            const weekDates = getWeekDates(currentWeekStart);
            const today = formatDateKey(new Date());

            // If "All Stores" is selected, show the stores grid view
            if (storeFilter === 'all') {
                renderAllStoresView(container, weekDates, today);
                return;
            }

            // If "Employees Hours" is selected, show the employees worked hours view
            if (storeFilter === 'employees') {
                renderEmployeesHoursView(container, weekDates, today);
                return;
            }

            // Filter employees by store
            let filteredEmployees = [...employees];
            if (storeFilter !== 'all') {
                filteredEmployees = filteredEmployees.filter(e => e.store === storeFilter);
            }

            if (filteredEmployees.length === 0) {
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <i class="fas fa-users" style="font-size: 48px; color: var(--text-muted); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Employees</h3>
                        <p style="color: var(--text-muted);">No employees found for the selected store.</p>
                    </div>
                `;
                return;
            }

            // Build day cards HTML
            let html = '<div class="schedule-days-container">';

            weekDates.forEach(date => {
                const dateKey = formatDateKey(date);
                const isToday = dateKey === today;
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = date.getDate();

                html += `
                    <div class="schedule-day-card ${isToday ? 'today' : ''}" data-date="${dateKey}">
                        <div class="day-card-header">
                            <div class="day-name">${dayName}</div>
                            <div class="day-number">${dayNumber}</div>
                        </div>
                        <div class="day-card-body">
                `;

                // Render both shift slots (Opening and Closing)
                ['opening', 'closing'].forEach(shiftType => {
                    const shiftConfig = SHIFT_TYPES[shiftType];
                    // Find schedule for this day and shift type
                    const schedule = schedules.find(s =>
                        s.date === dateKey &&
                        s.shiftType === shiftType &&
                        (storeFilter === 'all' || s.store === storeFilter)
                    );

                    const emp = schedule ? employees.find(e => e.id === schedule.employeeId) : null;
                    const startTime = schedule?.startTime || shiftConfig.defaultStart;
                    const endTime = schedule?.endTime || shiftConfig.defaultEnd;
                    const hours = calculateHours(startTime, endTime);

                    html += `
                        <div class="shift-slot ${shiftType}" data-date="${dateKey}" data-shift-type="${shiftType}">
                            <div class="shift-slot-header">
                                <div class="shift-type-badge">
                                    <i class="fas ${shiftConfig.icon}"></i>
                                    ${shiftConfig.name}
                                </div>
                                <div class="shift-time-display" id="time-display-${dateKey}-${shiftType}">
                                    ${formatTimeShort(startTime)} - ${formatTimeShort(endTime)}
                                </div>
                            </div>
                            <div class="employee-drop-zone ${schedule ? '' : 'empty'}"
                                 data-date="${dateKey}"
                                 data-shift-type="${shiftType}"
                                 data-schedule-id="${schedule?.id || ''}"
                                 onclick="openEmployeePicker('${dateKey}', '${shiftType}', '${storeFilter}')"
                                 ondragover="handleShiftDragOver(event)"
                                 ondragleave="handleShiftDragLeave(event)"
                                 ondrop="handleShiftDrop(event, '${dateKey}', '${shiftType}')">
                    `;

                    if (schedule && emp) {
                        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
                        const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                        const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

                        html += `
                            <div class="assigned-employee"
                                 draggable="true"
                                 data-schedule-id="${schedule.id}"
                                 data-employee-id="${emp.id}"
                                 ondragstart="handleEmployeeDragStart(event, '${schedule.id}')"
                                 ondragend="handleEmployeeDragEnd(event)"
                                 onclick="event.stopPropagation(); openTimeEditor('${schedule.id}')">
                                <div class="assigned-employee-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                                <div class="assigned-employee-info">
                                    <div class="assigned-employee-name">${emp.name}</div>
                                    <div class="assigned-employee-hours">${hours}h</div>
                                </div>
                                <button class="assigned-employee-clone" onclick="event.stopPropagation(); cloneShift('${schedule.id}')" title="Clone shift">
                                    <i class="fas fa-clone"></i>
                                </button>
                                <button class="assigned-employee-remove" onclick="event.stopPropagation(); removeSchedule('${schedule.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        html += `<i class="fas fa-plus"></i> Assign`;
                    }

                    html += `</div>`;

                    html += `</div>`;
                });

                // Days off section for this date
                const dayOffEmployees = daysOff.filter(d =>
                    d.date === dateKey &&
                    (storeFilter === 'all' || d.store === storeFilter)
                );

                html += `
                    <div class="day-off-section">
                        <div class="day-off-header" onclick="openDayOffPicker('${dateKey}', '${storeFilter}')">
                            <i class="fas fa-umbrella-beach" style="color: var(--accent-primary);"></i>
                            <span>Days Off</span>
                            <i class="fas fa-plus" style="margin-left: auto; font-size: 12px;"></i>
                        </div>
                        <div class="day-off-employees">
                `;

                if (dayOffEmployees.length > 0) {
                    const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
                    dayOffEmployees.forEach(dayOff => {
                        const emp = employees.find(e => e.id === dayOff.employeeId);
                        if (emp) {
                            const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                            const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
                            html += `
                                <div class="day-off-employee-badge">
                                    <div class="day-off-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                                    <span class="day-off-name">${emp.name}</span>
                                    <button class="day-off-remove" onclick="event.stopPropagation(); removeDayOff('${dayOff.id}')" title="Remove day off">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                        }
                    });
                } else {
                    html += `<div class="day-off-empty">No days off</div>`;
                }

                html += `
                        </div>
                    </div>
                `;

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Time editor modal functions
        let currentTimeEditorContext = null;

        function timeToPercent(time) {
            if (!time) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            let totalMinutes = hours * 60 + minutes;
            // Handle midnight (00:00) as end of day
            if (totalMinutes < 360) totalMinutes += 1440;
            // Range: 6am (360) to 12am (1440) = 1080 minutes
            const minMinutes = 360; // 6am
            const maxMinutes = 1440; // 12am (midnight)
            return Math.max(0, Math.min(100, ((totalMinutes - minMinutes) / (maxMinutes - minMinutes)) * 100));
        }

        function percentToTime(percent) {
            const minMinutes = 360; // 6am
            const maxMinutes = 1440; // 12am
            const totalMinutes = Math.round((percent / 100) * (maxMinutes - minMinutes) + minMinutes);
            // Round to nearest 15 minutes
            const roundedMinutes = Math.round(totalMinutes / 15) * 15;
            const hours = Math.floor(roundedMinutes / 60) % 24;
            const minutes = roundedMinutes % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function openTimeEditor(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;

            const emp = employees.find(e => e.id === schedule.employeeId);
            const shiftConfig = SHIFT_TYPES[schedule.shiftType] || SHIFT_TYPES.opening;
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
            const colorIndex = emp?.name ? emp.name.charCodeAt(0) % colors.length : 0;
            const initials = emp?.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

            currentTimeEditorContext = {
                scheduleId,
                startTime: schedule.startTime,
                endTime: schedule.endTime,
                shiftType: schedule.shiftType
            };

            // Update modal content
            const titleEl = document.getElementById('timeEditorTitle');
            const infoEl = document.getElementById('timeEditorInfo');
            const currentValueEl = document.getElementById('timeEditorCurrentValue');
            const currentHoursEl = document.getElementById('timeEditorCurrentHours');
            const rangeEl = document.getElementById('timeEditorRange');

            if (titleEl) {
                const icon = shiftConfig.icon;
                titleEl.innerHTML = `<i class="fas ${icon}" style="color: ${shiftConfig.color};"></i> Edit ${shiftConfig.name} Shift`;
            }

            if (infoEl) {
                const dateObj = new Date(schedule.date + 'T12:00:00');
                const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                infoEl.innerHTML = `
                    <div class="time-editor-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                    <div class="time-editor-details">
                        <h4>${emp?.name || 'Unknown'}</h4>
                        <p>${dateStr} &bull; ${schedule.store || ''}</p>
                    </div>
                `;
            }

            // Set initial values
            updateTimeEditorDisplay();

            // Set slider position
            if (rangeEl) {
                rangeEl.className = `time-editor-slider-range ${schedule.shiftType}`;
                updateTimeEditorSlider();
            }

            // Setup slider drag handlers
            setupTimeEditorSlider();

            // Show modal
            document.getElementById('timeEditorOverlay').classList.add('active');
        }

        function closeTimeEditor(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('timeEditorOverlay').classList.remove('active');
            currentTimeEditorContext = null;
        }

        function updateTimeEditorDisplay() {
            if (!currentTimeEditorContext) return;

            const { startTime, endTime } = currentTimeEditorContext;
            const currentValueEl = document.getElementById('timeEditorCurrentValue');
            const currentHoursEl = document.getElementById('timeEditorCurrentHours');

            if (currentValueEl) {
                currentValueEl.textContent = `${formatTimeShort(startTime)} - ${formatTimeShort(endTime)}`;
            }

            if (currentHoursEl) {
                const hours = calculateHours(startTime, endTime);
                currentHoursEl.textContent = `${hours} hours`;
            }
        }

        function updateTimeEditorSlider() {
            if (!currentTimeEditorContext) return;

            const { startTime, endTime } = currentTimeEditorContext;
            const rangeEl = document.getElementById('timeEditorRange');

            if (rangeEl) {
                const startPercent = timeToPercent(startTime);
                const endPercent = timeToPercent(endTime);
                rangeEl.style.left = `${startPercent}%`;
                rangeEl.style.right = `${100 - endPercent}%`;
            }
        }

        function setupTimeEditorSlider() {
            const track = document.getElementById('timeEditorTrack');
            const range = document.getElementById('timeEditorRange');
            const handleStart = document.getElementById('timeEditorHandleStart');
            const handleEnd = document.getElementById('timeEditorHandleEnd');

            if (!track || !range) return;

            function startDrag(handleType) {
                return function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const trackRect = track.getBoundingClientRect();

                    function onMouseMove(e) {
                        if (!currentTimeEditorContext) return;

                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const x = Math.max(0, Math.min(clientX - trackRect.left, trackRect.width));
                        const percent = (x / trackRect.width) * 100;

                        let startPercent = timeToPercent(currentTimeEditorContext.startTime);
                        let endPercent = timeToPercent(currentTimeEditorContext.endTime);

                        if (handleType === 'start') {
                            startPercent = Math.min(percent, endPercent - 5);
                            currentTimeEditorContext.startTime = percentToTime(startPercent);
                        } else {
                            endPercent = Math.max(percent, startPercent + 5);
                            currentTimeEditorContext.endTime = percentToTime(endPercent);
                        }

                        updateTimeEditorDisplay();
                        updateTimeEditorSlider();
                    }

                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        document.removeEventListener('touchmove', onMouseMove);
                        document.removeEventListener('touchend', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    document.addEventListener('touchmove', onMouseMove);
                    document.addEventListener('touchend', onMouseUp);
                };
            }

            // Remove old listeners by cloning
            const newHandleStart = handleStart.cloneNode(true);
            const newHandleEnd = handleEnd.cloneNode(true);
            handleStart.parentNode.replaceChild(newHandleStart, handleStart);
            handleEnd.parentNode.replaceChild(newHandleEnd, handleEnd);

            newHandleStart.addEventListener('mousedown', startDrag('start'));
            newHandleStart.addEventListener('touchstart', startDrag('start'));
            newHandleEnd.addEventListener('mousedown', startDrag('end'));
            newHandleEnd.addEventListener('touchstart', startDrag('end'));
        }

        function setTimeEditorPreset(startTime, endTime) {
            if (!currentTimeEditorContext) return;

            currentTimeEditorContext.startTime = startTime;
            currentTimeEditorContext.endTime = endTime;

            updateTimeEditorDisplay();
            updateTimeEditorSlider();

            // Highlight active preset
            document.querySelectorAll('.time-editor-preset').forEach(p => p.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        async function saveTimeEditor() {
            if (!currentTimeEditorContext) return;

            const { scheduleId, startTime, endTime } = currentTimeEditorContext;

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).update({
                    startTime,
                    endTime,
                    updatedAt: new Date().toISOString()
                });

                // Update local data
                const schedule = schedules.find(s => s.id === scheduleId);
                if (schedule) {
                    schedule.startTime = startTime;
                    schedule.endTime = endTime;
                }

                showNotification('Schedule updated!', 'success');
                closeTimeEditor();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error updating schedule:', error);
                showNotification('Error updating schedule', 'error');
            }
        }

        async function deleteFromTimeEditor() {
            if (!currentTimeEditorContext) return;

            if (!confirm('Remove this employee from the shift?')) return;

            const { scheduleId } = currentTimeEditorContext;

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).delete();

                schedules = schedules.filter(s => s.id !== scheduleId);
                showNotification('Shift removed', 'success');
                closeTimeEditor();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error removing schedule:', error);
                showNotification('Error removing shift', 'error');
            }
        }

        // All Stores View
        function renderAllStoresView(container, weekDates, today) {
            const stores = ['Miramar', 'Morena', 'Kearny Mesa', 'Chula Vista', 'North Park', 'Miramar Wine & Liquor'];

            let html = '<div class="stores-grid">';

            stores.forEach(store => {
                html += `
                    <div class="store-schedule-card">
                        <div class="store-schedule-header">
                            <h4>
                                <div class="store-icon"><i class="fas fa-store"></i></div>
                                ${store}
                            </h4>
                        </div>
                        <div class="store-schedule-body">
                `;

                weekDates.forEach(date => {
                    const dateKey = formatDateKey(date);
                    const isToday = dateKey === today;
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayNumber = date.getDate();
                    const ordinalDay = getOrdinal(dayNumber);

                    html += `
                        <div class="store-day-row">
                            <div class="store-day-label ${isToday ? 'today' : ''}">${dayName} (${ordinalDay})</div>
                            <div class="store-shifts">
                    `;

                    ['opening', 'closing'].forEach(shiftType => {
                        const schedule = schedules.find(s =>
                            s.date === dateKey &&
                            s.shiftType === shiftType &&
                            s.store === store
                        );
                        const emp = schedule ? employees.find(e => e.id === schedule.employeeId) : null;

                        if (schedule && emp) {
                            const firstName = emp.name?.split(' ')[0] || 'Unknown';
                            html += `
                                <div class="store-shift-slot ${shiftType} filled"
                                     draggable="true"
                                     data-schedule-id="${schedule.id}"
                                     ondragstart="handleEmployeeDragStart(event, '${schedule.id}')"
                                     ondragend="handleEmployeeDragEnd(event)"
                                     onclick="openTimeEditor('${schedule.id}')">
                                    <div class="store-shift-name">${firstName}</div>
                                    <div class="store-shift-time">${formatTimeShort(schedule.startTime)}-${formatTimeShort(schedule.endTime)}</div>
                                    <button class="store-shift-clone" onclick="event.stopPropagation(); cloneShift('${schedule.id}')" title="Clone shift">
                                        <i class="fas fa-clone"></i>
                                    </button>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="store-shift-slot empty"
                                     data-date="${dateKey}"
                                     data-shift-type="${shiftType}"
                                     data-store="${store}"
                                     ondragover="handleStoreSlotDragOver(event)"
                                     ondragleave="handleStoreSlotDragLeave(event)"
                                     ondrop="handleStoreSlotDrop(event, '${dateKey}', '${shiftType}', '${store}')"
                                     onclick="openEmployeePicker('${dateKey}', '${shiftType}', '${store}')">
                                    <i class="fas fa-plus" style="font-size: 10px;"></i>
                                </div>
                            `;
                        }
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                // Days Off section for All Stores view
                html += `
                    <div class="store-days-off-section">
                        <div class="store-days-off-header clickable" onclick="openStoreDayOffPicker('${store}')">
                            <i class="fas fa-umbrella-beach" style="color: var(--accent-primary); font-size: 14px;"></i>
                            <span style="font-weight: 600; font-size: 13px;">Days Off This Week</span>
                            <i class="fas fa-plus" style="margin-left: auto; font-size: 12px; color: var(--accent-primary);"></i>
                        </div>
                        <div class="store-days-off-list">
                `;

                // Get all days off for this store in the current week
                const storeDaysOff = daysOff.filter(d => {
                    const dateInWeek = weekDates.some(date => formatDateKey(date) === d.date);
                    return d.store === store && dateInWeek;
                });

                if (storeDaysOff.length > 0) {
                    const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
                    storeDaysOff.forEach(dayOff => {
                        const emp = employees.find(e => e.id === dayOff.employeeId);
                        if (emp) {
                            const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                            const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
                            const dateObj = new Date(dayOff.date + 'T12:00:00');
                            const dayLabel = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                            html += `
                                <div class="store-day-off-item">
                                    <div class="store-day-off-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                                    <div class="store-day-off-info">
                                        <div class="store-day-off-name">${emp.name}</div>
                                        <div class="store-day-off-date">${dayLabel}</div>
                                    </div>
                                    <button class="store-day-off-remove" onclick="event.stopPropagation(); removeDayOff('${dayOff.id}')" title="Remove day off">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                        }
                    });
                } else {
                    html += `<div class="store-days-off-empty">No days off this week</div>`;
                }

                html += `
                        </div>
                    </div>
                `;

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Render Employees Hours View - shows worked hours from Clock In/Out data
        async function renderEmployeesHoursView(container, weekDates, today) {
            // Show loading state
            container.innerHTML = `
                <div style="padding: 60px; text-align: center;">
                    <div class="loading-spinner"></div>
                    <p style="color: var(--text-muted); margin-top: 15px;">Loading employee hours...</p>
                </div>
            `;

            try {
                // Initialize Firebase Clock In Manager if not already done
                if (!firebaseClockInManager.isInitialized) {
                    await firebaseClockInManager.initialize();
                }

                // Get all clock records for the week
                const weekClockRecords = {};
                for (const date of weekDates) {
                    const dateKey = formatDateKey(date);
                    // Use the same format as formatDateKey (local date, not UTC)
                    const dateString = dateKey;
                    try {
                        const records = await firebaseClockInManager.loadClockRecordsByDate(dateString);
                        weekClockRecords[dateKey] = records;
                        if (records.length > 0) {
                            console.log(`üìÖ Loaded ${records.length} clock records for ${dateString}`);
                        }
                    } catch (err) {
                        console.warn(`Could not load clock records for ${dateString}:`, err);
                        weekClockRecords[dateKey] = [];
                    }
                }

                // Calculate hours per employee per day
                const employeeHoursMap = {};

                employees.forEach(emp => {
                    employeeHoursMap[emp.id] = {
                        employee: emp,
                        dailyHours: {},
                        totalHours: 0,
                        totalMinutes: 0
                    };

                    weekDates.forEach(date => {
                        const dateKey = formatDateKey(date);
                        employeeHoursMap[emp.id].dailyHours[dateKey] = { hours: 0, minutes: 0, hasRecord: false };
                    });
                });

                // Process clock records
                for (const dateKey of Object.keys(weekClockRecords)) {
                    const records = weekClockRecords[dateKey];
                    records.forEach(record => {
                        // Find matching employee by multiple criteria for robust matching
                        const matchingEmp = employees.find(e => {
                            // Match by firestoreId (most reliable)
                            if (e.firestoreId && e.firestoreId === record.employeeId) return true;
                            // Match by id
                            if (e.id && e.id === record.employeeId) return true;
                            // Match by name (case-insensitive)
                            if (e.name && record.employeeName &&
                                e.name.toLowerCase().trim() === record.employeeName.toLowerCase().trim()) return true;
                            return false;
                        });

                        if (matchingEmp && employeeHoursMap[matchingEmp.id]) {
                            const workedTime = calculateWorkedTimeFromRecord(record);
                            // Show record even if no clock out yet (in progress)
                            if (workedTime.totalMinutes > 0 || record.clockIn) {
                                employeeHoursMap[matchingEmp.id].dailyHours[dateKey] = {
                                    hours: workedTime.hours,
                                    minutes: workedTime.minutes,
                                    hasRecord: true,
                                    clockIn: record.clockIn,
                                    clockOut: record.clockOut,
                                    inProgress: record.clockIn && !record.clockOut
                                };
                                if (workedTime.totalMinutes > 0) {
                                    employeeHoursMap[matchingEmp.id].totalMinutes += workedTime.totalMinutes;
                                }
                            }
                        }
                    });
                }

                // Calculate total hours for each employee
                Object.values(employeeHoursMap).forEach(empData => {
                    empData.totalHours = Math.floor(empData.totalMinutes / 60);
                    const remainingMinutes = Math.floor(empData.totalMinutes % 60);
                    // Show hours and minutes in a clean format
                    // e.g., "8h 30m" or just "45m" if less than an hour
                    if (empData.totalHours > 0) {
                        empData.totalHoursDisplay = `${empData.totalHours}h ${remainingMinutes}m`;
                    } else if (remainingMinutes > 0) {
                        empData.totalHoursDisplay = `${remainingMinutes}m`;
                    } else {
                        empData.totalHoursDisplay = '-';
                    }
                });

                // Build the HTML table
                let html = `
                    <div class="employees-hours-container">
                        <div class="employees-hours-header">
                            <h3><i class="fas fa-clock" style="color: var(--accent-primary); margin-right: 8px;"></i>Employee Worked Hours</h3>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">Based on Clock In/Out records for this week</p>
                        </div>
                        <div class="employees-hours-table-wrapper">
                            <table class="employees-hours-table">
                                <thead>
                                    <tr>
                                        <th class="employee-col">Employee</th>
                `;

                // Add day columns
                weekDates.forEach(date => {
                    const dateKey = formatDateKey(date);
                    const isToday = dateKey === today;
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayNumber = date.getDate();
                    html += `<th class="day-col ${isToday ? 'today' : ''}">${dayName}<br><span class="day-number">${dayNumber}</span></th>`;
                });

                html += `<th class="total-col">Total</th></tr></thead><tbody>`;

                // Add rows for each employee (sorted by name)
                const sortedEmployees = Object.values(employeeHoursMap)
                    .filter(empData => empData.employee.name)
                    .sort((a, b) => a.employee.name.localeCompare(b.employee.name));

                if (sortedEmployees.length === 0) {
                    html += `
                        <tr>
                            <td colspan="${weekDates.length + 2}" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-users" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                                No employees found
                            </td>
                        </tr>
                    `;
                } else {
                    sortedEmployees.forEach(empData => {
                        const emp = empData.employee;
                        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
                        const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                        const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

                        html += `
                            <tr>
                                <td class="employee-col">
                                    <div class="emp-info">
                                        <div class="emp-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                                        <div class="emp-details">
                                            <div class="emp-name">${emp.name}</div>
                                            <div class="emp-store">${emp.store || 'No Store'}</div>
                                        </div>
                                    </div>
                                </td>
                        `;

                        // Add hours for each day
                        weekDates.forEach(date => {
                            const dateKey = formatDateKey(date);
                            const isToday = dateKey === today;
                            const dayData = empData.dailyHours[dateKey];

                            if (dayData.hasRecord) {
                                let hoursDisplay;
                                let cellClass = 'has-hours';

                                if (dayData.inProgress) {
                                    // Employee clocked in but not out yet
                                    hoursDisplay = '<i class="fas fa-clock"></i> Active';
                                    cellClass = 'in-progress';
                                } else if (dayData.hours > 0 || dayData.minutes > 0) {
                                    // Show hours and minutes in a clean format
                                    // e.g., "1h 23m" or just "23m" if less than an hour
                                    if (dayData.hours > 0) {
                                        hoursDisplay = `${dayData.hours}h ${dayData.minutes}m`;
                                    } else {
                                        hoursDisplay = `${dayData.minutes}m`;
                                    }
                                } else {
                                    hoursDisplay = '-';
                                }

                                const tooltipText = dayData.clockIn && dayData.clockOut
                                    ? `${dayData.clockIn} - ${dayData.clockOut}`
                                    : (dayData.clockIn ? `Clocked in: ${dayData.clockIn} (still working)` : '');
                                html += `
                                    <td class="day-col ${isToday ? 'today' : ''} ${cellClass}" title="${tooltipText}">
                                        <span class="hours-value">${hoursDisplay}</span>
                                    </td>
                                `;
                            } else {
                                html += `<td class="day-col ${isToday ? 'today' : ''} no-hours">-</td>`;
                            }
                        });

                        // Add total
                        const hasAnyHours = empData.totalMinutes > 0;
                        html += `
                            <td class="total-col ${hasAnyHours ? 'has-total' : ''}">
                                <span class="total-value">${hasAnyHours ? empData.totalHoursDisplay : '-'}</span>
                            </td>
                        </tr>
                        `;
                    });
                }

                html += `</tbody></table></div></div>`;

                // Add styles for the table
                html += `
                    <style>
                        .employees-hours-container {
                            background: var(--bg-card);
                            border-radius: 16px;
                            padding: 24px;
                            box-shadow: var(--shadow-sm);
                        }
                        .employees-hours-header {
                            margin-bottom: 20px;
                        }
                        .employees-hours-header h3 {
                            font-size: 18px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                        }
                        .employees-hours-table-wrapper {
                            overflow-x: auto;
                        }
                        .employees-hours-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 14px;
                        }
                        .employees-hours-table th,
                        .employees-hours-table td {
                            padding: 12px 16px;
                            text-align: center;
                            border-bottom: 1px solid var(--border-color);
                        }
                        .employees-hours-table th {
                            background: var(--bg-secondary);
                            font-weight: 600;
                            color: var(--text-secondary);
                            font-size: 13px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        .employees-hours-table th.today {
                            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                            color: white;
                        }
                        .employees-hours-table th .day-number {
                            font-size: 16px;
                            font-weight: 700;
                        }
                        .employees-hours-table .employee-col {
                            text-align: left;
                            min-width: 200px;
                        }
                        .employees-hours-table .day-col {
                            min-width: 80px;
                        }
                        .employees-hours-table .total-col {
                            min-width: 100px;
                            background: var(--bg-secondary);
                            font-weight: 600;
                        }
                        .employees-hours-table td.today {
                            background: rgba(79, 70, 229, 0.05);
                        }
                        .employees-hours-table td.has-hours {
                            color: var(--success);
                            font-weight: 500;
                        }
                        .employees-hours-table td.in-progress {
                            color: var(--warning);
                            font-weight: 500;
                        }
                        .employees-hours-table td.in-progress .hours-value {
                            background: rgba(245, 158, 11, 0.15);
                            color: var(--warning);
                            animation: pulse-active 2s infinite;
                        }
                        @keyframes pulse-active {
                            0%, 100% { opacity: 1; }
                            50% { opacity: 0.7; }
                        }
                        .employees-hours-table td.no-hours {
                            color: var(--text-muted);
                        }
                        .employees-hours-table td.has-total {
                            color: var(--accent-primary);
                        }
                        .employees-hours-table .hours-value {
                            background: rgba(34, 197, 94, 0.1);
                            padding: 4px 8px;
                            border-radius: 6px;
                            font-size: 13px;
                        }
                        .employees-hours-table .total-value {
                            background: rgba(79, 70, 229, 0.1);
                            padding: 6px 12px;
                            border-radius: 8px;
                            font-weight: 600;
                        }
                        .emp-info {
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        }
                        .emp-avatar {
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 13px;
                            font-weight: 600;
                        }
                        .emp-details {
                            text-align: left;
                        }
                        .emp-name {
                            font-weight: 600;
                            color: var(--text-primary);
                        }
                        .emp-store {
                            font-size: 12px;
                            color: var(--text-muted);
                        }
                        .employees-hours-table tbody tr:hover {
                            background: var(--bg-hover);
                        }
                    </style>
                `;

                container.innerHTML = html;

            } catch (error) {
                console.error('Error rendering employees hours view:', error);
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">Error Loading Hours</h3>
                        <p style="color: var(--text-muted);">Unable to load employee hours data.</p>
                        <button class="btn-primary" style="margin-top: 20px;" onclick="renderScheduleGrid()">
                            <i class="fas fa-sync"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Calculate worked time from a clock record
        function calculateWorkedTimeFromRecord(record) {
            if (!record.clockIn) {
                return { hours: 0, minutes: 0, totalMinutes: 0 };
            }

            const clockIn = parseClockTime(record.clockIn);
            const clockOut = record.clockOut ? parseClockTime(record.clockOut) : null;

            if (!clockOut) {
                return { hours: 0, minutes: 0, totalMinutes: 0 };
            }

            let totalMinutes = (clockOut - clockIn) / 1000 / 60;

            // Subtract lunch time if applicable
            if (record.lunchStart && record.lunchEnd) {
                const lunchStart = parseClockTime(record.lunchStart);
                const lunchEnd = parseClockTime(record.lunchEnd);
                const lunchMinutes = (lunchEnd - lunchStart) / 1000 / 60;
                if (lunchMinutes > 0) {
                    totalMinutes -= lunchMinutes;
                }
            }

            // Handle negative or invalid values
            if (totalMinutes < 0) {
                totalMinutes = 0;
            }

            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);

            return { hours, minutes, totalMinutes: Math.floor(totalMinutes) };
        }

        // Parse clock time string to Date object
        function parseClockTime(timeString) {
            if (!timeString) return null;
            const today = new Date();
            const [hours, minutes] = timeString.split(':');
            today.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return today;
        }

        // Drag handlers for All Stores view
        function handleStoreSlotDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleStoreSlotDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleStoreSlotDrop(event, dateKey, shiftType, store) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (!draggedShift) return;

            const schedule = schedules.find(s => s.id === draggedShift);
            if (!schedule) return;

            const shiftConfig = SHIFT_TYPES[shiftType];

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(draggedShift).update({
                    date: dateKey,
                    shiftType,
                    store,
                    startTime: shiftConfig.defaultStart,
                    endTime: shiftConfig.defaultEnd,
                    updatedAt: new Date().toISOString()
                });

                schedule.date = dateKey;
                schedule.shiftType = shiftType;
                schedule.store = store;
                schedule.startTime = shiftConfig.defaultStart;
                schedule.endTime = shiftConfig.defaultEnd;

                showNotification('Shift moved!', 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error moving shift:', error);
                showNotification('Error moving shift', 'error');
            }
        }

        // Clone individual shift
        async function cloneShift(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;

            const weekDates = getWeekDates(currentWeekStart);
            const weekKeys = weekDates.map(d => formatDateKey(d));
            const currentDayIndex = weekKeys.indexOf(schedule.date);

            // Find next available day for same shift type in same store
            let targetDate = null;
            for (let i = currentDayIndex + 1; i < 7; i++) {
                const exists = schedules.find(s =>
                    s.date === weekKeys[i] &&
                    s.shiftType === schedule.shiftType &&
                    s.store === schedule.store
                );
                if (!exists) {
                    targetDate = weekKeys[i];
                    break;
                }
            }

            if (!targetDate) {
                // Try from beginning of week
                for (let i = 0; i < currentDayIndex; i++) {
                    const exists = schedules.find(s =>
                        s.date === weekKeys[i] &&
                        s.shiftType === schedule.shiftType &&
                        s.store === schedule.store
                    );
                    if (!exists) {
                        targetDate = weekKeys[i];
                        break;
                    }
                }
            }

            if (!targetDate) {
                showNotification('No empty slots available this week', 'warning');
                return;
            }

            const currentUser = getCurrentUser();

            try {
                const db = firebase.firestore();
                const newSchedule = {
                    employeeId: schedule.employeeId,
                    employeeName: schedule.employeeName,
                    store: schedule.store,
                    date: targetDate,
                    shiftType: schedule.shiftType,
                    startTime: schedule.startTime,
                    endTime: schedule.endTime,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.name || 'Unknown',
                    clonedFrom: scheduleId
                };

                const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(newSchedule);
                schedules.push({ id: docRef.id, ...newSchedule });

                const targetDay = new Date(targetDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short' });
                showNotification(`Shift cloned to ${targetDay}!`, 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error cloning shift:', error);
                showNotification('Error cloning shift', 'error');
            }
        }

        // Clone modal functions
        function openCloneModal() {
            document.getElementById('cloneModalOverlay').classList.add('active');
        }

        function closeCloneModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('cloneModalOverlay').classList.remove('active');
        }

        async function cloneFromPreviousWeek() {
            const previousWeekStart = new Date(currentWeekStart);
            previousWeekStart.setDate(previousWeekStart.getDate() - 7);
            const previousWeekDates = getWeekDates(previousWeekStart);
            const currentWeekDates = getWeekDates(currentWeekStart);

            // Get schedules from previous week
            const previousWeekKeys = previousWeekDates.map(d => formatDateKey(d));
            const previousSchedules = schedules.filter(s => previousWeekKeys.includes(s.date));

            if (previousSchedules.length === 0) {
                showNotification('No schedules found in previous week', 'warning');
                closeCloneModal();
                return;
            }

            const storeFilter = document.getElementById('schedule-store-filter')?.value || 'all';

            try {
                const db = firebase.firestore();
                const currentUser = getCurrentUser();
                let clonedCount = 0;

                for (const prevSchedule of previousSchedules) {
                    // Skip if filtering by store and doesn't match
                    if (storeFilter !== 'all' && prevSchedule.store !== storeFilter) continue;

                    // Calculate new date (same day of week, current week)
                    const prevDateIndex = previousWeekKeys.indexOf(prevSchedule.date);
                    const newDate = formatDateKey(currentWeekDates[prevDateIndex]);

                    // Check if schedule already exists for this slot
                    const exists = schedules.find(s =>
                        s.date === newDate &&
                        s.shiftType === prevSchedule.shiftType &&
                        s.store === prevSchedule.store
                    );

                    if (!exists) {
                        const newSchedule = {
                            employeeId: prevSchedule.employeeId,
                            employeeName: prevSchedule.employeeName,
                            store: prevSchedule.store,
                            date: newDate,
                            shiftType: prevSchedule.shiftType,
                            startTime: prevSchedule.startTime,
                            endTime: prevSchedule.endTime,
                            createdAt: new Date().toISOString(),
                            createdBy: currentUser?.name || 'Unknown',
                            clonedFrom: prevSchedule.id
                        };

                        const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(newSchedule);
                        schedules.push({ id: docRef.id, ...newSchedule });
                        clonedCount++;
                    }
                }

                showNotification(`Cloned ${clonedCount} shifts from previous week!`, 'success');
                closeCloneModal();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error cloning schedules:', error);
                showNotification('Error cloning schedules', 'error');
            }
        }

        async function cloneToNextWeek() {
            const nextWeekStart = new Date(currentWeekStart);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7);
            const nextWeekDates = getWeekDates(nextWeekStart);
            const currentWeekDates = getWeekDates(currentWeekStart);

            // Get schedules from current week
            const currentWeekKeys = currentWeekDates.map(d => formatDateKey(d));
            const currentSchedules = schedules.filter(s => currentWeekKeys.includes(s.date));

            if (currentSchedules.length === 0) {
                showNotification('No schedules in current week to clone', 'warning');
                closeCloneModal();
                return;
            }

            const storeFilter = document.getElementById('schedule-store-filter')?.value || 'all';

            try {
                const db = firebase.firestore();
                const currentUser = getCurrentUser();
                let clonedCount = 0;

                for (const currSchedule of currentSchedules) {
                    if (storeFilter !== 'all' && currSchedule.store !== storeFilter) continue;

                    const currDateIndex = currentWeekKeys.indexOf(currSchedule.date);
                    const newDate = formatDateKey(nextWeekDates[currDateIndex]);

                    const exists = schedules.find(s =>
                        s.date === newDate &&
                        s.shiftType === currSchedule.shiftType &&
                        s.store === currSchedule.store
                    );

                    if (!exists) {
                        const newSchedule = {
                            employeeId: currSchedule.employeeId,
                            employeeName: currSchedule.employeeName,
                            store: currSchedule.store,
                            date: newDate,
                            shiftType: currSchedule.shiftType,
                            startTime: currSchedule.startTime,
                            endTime: currSchedule.endTime,
                            createdAt: new Date().toISOString(),
                            createdBy: currentUser?.name || 'Unknown',
                            clonedFrom: currSchedule.id
                        };

                        const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(newSchedule);
                        schedules.push({ id: docRef.id, ...newSchedule });
                        clonedCount++;
                    }
                }

                showNotification(`Cloned ${clonedCount} shifts to next week!`, 'success');
                closeCloneModal();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error cloning schedules:', error);
                showNotification('Error cloning schedules', 'error');
            }
        }

        async function clearCurrentWeek() {
            if (!confirm('Are you sure you want to remove all shifts from the current week?')) return;

            const currentWeekDates = getWeekDates(currentWeekStart);
            const currentWeekKeys = currentWeekDates.map(d => formatDateKey(d));
            const storeFilter = document.getElementById('schedule-store-filter')?.value || 'all';

            const schedulesToDelete = schedules.filter(s =>
                currentWeekKeys.includes(s.date) &&
                (storeFilter === 'all' || s.store === storeFilter)
            );

            if (schedulesToDelete.length === 0) {
                showNotification('No schedules to clear', 'info');
                closeCloneModal();
                return;
            }

            try {
                const db = firebase.firestore();
                const batch = db.batch();

                schedulesToDelete.forEach(s => {
                    const docRef = db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(s.id);
                    batch.delete(docRef);
                });

                await batch.commit();

                schedules = schedules.filter(s => !schedulesToDelete.find(d => d.id === s.id));
                showNotification(`Cleared ${schedulesToDelete.length} shifts`, 'success');
                closeCloneModal();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error clearing schedules:', error);
                showNotification('Error clearing schedules', 'error');
            }
        }

        // Employee picker functions
        let currentPickerContext = null;

        function openEmployeePicker(dateKey, shiftType, storeFilter) {
            currentPickerContext = { dateKey, shiftType, storeFilter };

            const overlay = document.getElementById('employeePickerOverlay');
            const list = document.getElementById('employeePickerList');
            const search = document.getElementById('employeePickerSearch');

            if (search) search.value = '';
            renderEmployeePickerList();

            overlay.classList.add('active');
        }

        function closeEmployeePicker(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.getElementById('employeePickerOverlay');
            const title = overlay.querySelector('h3');

            // Reset title to default
            if (title) title.textContent = 'Select Employee';

            overlay.classList.remove('active');
            currentPickerContext = null;
            currentDayOffContext = null;
        }

        function filterEmployeePicker() {
            if (currentDayOffContext) {
                renderDayOffPickerList();
            } else {
                renderEmployeePickerList();
            }
        }

        function renderEmployeePickerList() {
            const list = document.getElementById('employeePickerList');
            const search = document.getElementById('employeePickerSearch')?.value?.toLowerCase() || '';

            if (!currentPickerContext) return;

            let filteredEmployees = [...employees];

            // REMOVED: Filter by store - Show ALL employees from Firebase regardless of store
            // This allows assigning any employee to any shift at any store
            // if (currentPickerContext.storeFilter !== 'all') {
            //     filteredEmployees = filteredEmployees.filter(e => e.store === currentPickerContext.storeFilter);
            //     console.log(`After store filter (${currentPickerContext.storeFilter}):`, filteredEmployees.length, 'employees');
            // }

            // Filter by search only
            if (search) {
                filteredEmployees = filteredEmployees.filter(e =>
                    e.name?.toLowerCase().includes(search)
                );
                console.log(`After search filter (${search}):`, filteredEmployees.length, 'employees');
            }

            // Filter out inactive employees
            filteredEmployees = filteredEmployees.filter(e => e.status === 'active');

            // Filter out employees who have a day off on this date
            if (currentPickerContext.dateKey) {
                console.log('üèñÔ∏è Checking days off for date:', currentPickerContext.dateKey);
                console.log('üèñÔ∏è All days off in memory:', daysOff);

                const daysOffOnThisDate = daysOff.filter(d => d.date === currentPickerContext.dateKey);
                console.log('üèñÔ∏è Days off matching this date:', daysOffOnThisDate);

                const employeesWithDayOff = daysOffOnThisDate.map(d => d.employeeId);
                console.log('üèñÔ∏è Employee IDs with day off:', employeesWithDayOff);

                const beforeFilter = filteredEmployees.length;
                filteredEmployees = filteredEmployees.filter(e => !employeesWithDayOff.includes(e.id));
                console.log(`üèñÔ∏è Filtered out ${beforeFilter - filteredEmployees.length} employees with days off`);
            }

            console.log('Final filtered employees:', filteredEmployees);

            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];

            list.innerHTML = filteredEmployees.map(emp => {
                const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

                return `
                    <div class="employee-picker-item" onclick="assignEmployee('${emp.id}')">
                        <div class="employee-picker-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                        <div class="employee-picker-info">
                            <div class="employee-picker-name">${emp.name}</div>
                            <div class="employee-picker-store">${emp.store || ''}</div>
                        </div>
                    </div>
                `;
            }).join('') || '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No employees found</div>';
        }

        async function assignEmployee(employeeId) {
            if (!currentPickerContext) return;

            const { dateKey, shiftType, storeFilter } = currentPickerContext;
            const emp = employees.find(e => e.id === employeeId);
            const shiftConfig = SHIFT_TYPES[shiftType];
            const store = storeFilter !== 'all' ? storeFilter : emp?.store || '';

            // Check if employee has a day off on this date
            const hasDayOff = daysOff.some(d =>
                d.date === dateKey &&
                d.employeeId === employeeId
            );

            if (hasDayOff) {
                showNotification('This employee has a day off on this date', 'warning');
                return;
            }

            // Check if there's already a schedule for this slot
            const existingSchedule = schedules.find(s =>
                s.date === dateKey &&
                s.shiftType === shiftType &&
                s.store === store
            );

            const currentUser = getCurrentUser();

            try {
                const db = firebase.firestore();
                let assignedCount = 1;

                if (existingSchedule) {
                    // Update existing
                    await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(existingSchedule.id).update({
                        employeeId,
                        employeeName: emp?.name || '',
                        updatedAt: new Date().toISOString()
                    });
                    existingSchedule.employeeId = employeeId;
                    existingSchedule.employeeName = emp?.name || '';
                } else {
                    // Create new
                    const scheduleData = {
                        employeeId,
                        employeeName: emp?.name || '',
                        store,
                        date: dateKey,
                        shiftType,
                        startTime: shiftConfig.defaultStart,
                        endTime: shiftConfig.defaultEnd,
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.name || 'Unknown'
                    };
                    const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(scheduleData);
                    schedules.push({ id: docRef.id, ...scheduleData });

                    // Auto-assign to closing if opening shift ends at or after 2pm (14:00)
                    if (shiftType === 'opening' && shiftConfig.defaultEnd >= '14:00') {
                        const closingExists = schedules.find(s =>
                            s.date === dateKey &&
                            s.shiftType === 'closing' &&
                            s.store === store
                        );

                        if (!closingExists) {
                            const closingConfig = SHIFT_TYPES.closing;
                            const closingData = {
                                employeeId,
                                employeeName: emp?.name || '',
                                store,
                                date: dateKey,
                                shiftType: 'closing',
                                startTime: closingConfig.defaultStart,
                                endTime: closingConfig.defaultEnd,
                                createdAt: new Date().toISOString(),
                                createdBy: currentUser?.name || 'Unknown',
                                autoAssigned: true
                            };
                            const closingRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(closingData);
                            schedules.push({ id: closingRef.id, ...closingData });
                            assignedCount = 2;
                        }
                    }
                }

                showNotification(assignedCount > 1 ? 'Employee assigned to both shifts!' : 'Employee assigned!', 'success');
                closeEmployeePicker();
                renderScheduleGrid();
            } catch (error) {
                console.error('Error assigning employee:', error);
                showNotification('Error assigning employee', 'error');
            }
        }

        async function removeSchedule(scheduleId) {
            if (!confirm('Remove this employee from the shift?')) return;

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).delete();

                schedules = schedules.filter(s => s.id !== scheduleId);
                showNotification('Shift removed', 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error removing schedule:', error);
                showNotification('Error removing shift', 'error');
            }
        }

        // Days Off Management
        let currentDayOffContext = null;

        function openDayOffPicker(dateKey, storeFilter) {
            currentDayOffContext = { dateKey, storeFilter };

            const overlay = document.getElementById('employeePickerOverlay');
            const list = document.getElementById('employeePickerList');
            const search = document.getElementById('employeePickerSearch');
            const title = overlay.querySelector('h3');

            if (title) title.textContent = 'Select Employee for Day Off';
            if (search) search.value = '';
            renderDayOffPickerList();

            overlay.classList.add('active');
        }

        function renderDayOffPickerList() {
            const list = document.getElementById('employeePickerList');
            const search = document.getElementById('employeePickerSearch')?.value?.toLowerCase() || '';

            if (!currentDayOffContext) return;

            let filteredEmployees = [...employees];

            // Filter by search
            if (search) {
                filteredEmployees = filteredEmployees.filter(e =>
                    e.name?.toLowerCase().includes(search)
                );
            }

            // Filter out inactive employees
            filteredEmployees = filteredEmployees.filter(e => e.status === 'active');

            // Filter out employees who already have a day off on this date
            const existingDayOffs = daysOff.filter(d => d.date === currentDayOffContext.dateKey);
            filteredEmployees = filteredEmployees.filter(e =>
                !existingDayOffs.some(d => d.employeeId === e.id)
            );

            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];

            list.innerHTML = filteredEmployees.map(emp => {
                const colorIndex = emp.name ? emp.name.charCodeAt(0) % colors.length : 0;
                const initials = emp.name ? emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';

                return `
                    <div class="employee-picker-item" onclick="assignDayOff('${emp.id}')">
                        <div class="employee-picker-avatar" style="background: ${colors[colorIndex]};">${initials}</div>
                        <div class="employee-picker-info">
                            <div class="employee-picker-name">${emp.name}</div>
                            <div class="employee-picker-store">${emp.store || ''}</div>
                        </div>
                    </div>
                `;
            }).join('') || '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No employees available</div>';
        }

        async function assignDayOff(employeeId) {
            if (!currentDayOffContext) return;

            const { dateKey, storeFilter } = currentDayOffContext;
            const emp = employees.find(e => e.id === employeeId);
            const store = storeFilter !== 'all' ? storeFilter : emp?.store || '';

            // Check if employee already has a day off
            const existingDayOff = daysOff.find(d =>
                d.date === dateKey &&
                d.employeeId === employeeId
            );

            if (existingDayOff) {
                showNotification('Employee already has a day off on this date', 'warning');
                return;
            }

            const currentUser = getCurrentUser();

            try {
                const db = firebase.firestore();
                const dayOffData = {
                    employeeId,
                    employeeName: emp?.name || '',
                    store,
                    date: dateKey,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.name || 'Unknown'
                };

                const docRef = await db.collection(window.FIREBASE_COLLECTIONS.daysOff || 'daysOff').add(dayOffData);
                daysOff.push({ id: docRef.id, ...dayOffData });

                showNotification('Day off assigned!', 'success');
                closeEmployeePicker();
                currentDayOffContext = null;
                renderScheduleGrid();
            } catch (error) {
                console.error('Error assigning day off:', error);
                showNotification('Error assigning day off', 'error');
            }
        }

        async function removeDayOff(dayOffId) {
            if (!confirm('Remove this day off?')) return;

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.daysOff || 'daysOff').doc(dayOffId).delete();

                daysOff = daysOff.filter(d => d.id !== dayOffId);
                showNotification('Day off removed', 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error removing day off:', error);
                showNotification('Error removing day off', 'error');
            }
        }

        // Open day off picker for All Stores view - shows date selector modal
        function openStoreDayOffPicker(store) {
            // Create a modal to select the date for the day off
            const weekDates = getWeekDates(currentWeekStart);
            const today = formatDateKey(new Date());

            let modalHTML = `
                <div class="date-picker-modal-overlay" id="datePickerOverlay" onmousedown="closeDatePicker(event)">
                    <div class="date-picker-modal">
                        <div class="date-picker-header">
                            <h3><i class="fas fa-calendar-day" style="color: var(--accent-primary);"></i> Select Day Off Date</h3>
                            <button onclick="closeDatePicker()" class="close-modal-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="date-picker-body">
                            <p style="margin-bottom: 16px; color: var(--text-secondary);">Select a date for the day off at <strong>${store}</strong></p>
                            <div class="date-picker-grid">
            `;

            weekDates.forEach(date => {
                const dateKey = formatDateKey(date);
                const isToday = dateKey === today;
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const monthDay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                modalHTML += `
                    <div class="date-picker-option ${isToday ? 'today' : ''}" onclick="selectDayOffDate('${dateKey}', '${store}')">
                        <div class="date-picker-day">${dayName}</div>
                        <div class="date-picker-date">${monthDay}</div>
                        ${isToday ? '<div class="date-picker-today-badge">Today</div>' : ''}
                    </div>
                `;
            });

            modalHTML += `
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Insert modal into document
            const existingModal = document.getElementById('datePickerOverlay');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            setTimeout(() => {
                document.getElementById('datePickerOverlay').classList.add('active');
            }, 10);
        }

        function closeDatePicker(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.getElementById('datePickerOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function selectDayOffDate(dateKey, store) {
            closeDatePicker();
            // Now open the employee picker for this specific date and store
            openDayOffPicker(dateKey, store);
        }

        // Drag and drop for employees between shifts
        function handleEmployeeDragStart(event, scheduleId) {
            draggedShift = scheduleId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleEmployeeDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.employee-drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            draggedShift = null;
        }

        function handleShiftDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleShiftDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleShiftDrop(event, dateKey, shiftType) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (!draggedShift) return;

            const schedule = schedules.find(s => s.id === draggedShift);
            if (!schedule) return;

            const shiftConfig = SHIFT_TYPES[shiftType];

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(draggedShift).update({
                    date: dateKey,
                    shiftType,
                    startTime: shiftConfig.defaultStart,
                    endTime: shiftConfig.defaultEnd,
                    updatedAt: new Date().toISOString()
                });

                schedule.date = dateKey;
                schedule.shiftType = shiftType;
                schedule.startTime = shiftConfig.defaultStart;
                schedule.endTime = shiftConfig.defaultEnd;

                showNotification('Shift moved!', 'success');
                renderScheduleGrid();
            } catch (error) {
                console.error('Error moving shift:', error);
                showNotification('Error moving shift', 'error');
            }
        }

        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            renderSchedule();
        }

        function goToToday() {
            currentWeekStart = getWeekStart(new Date());
            renderSchedule();
        }

        function formatTimeShort(time) {
            if (!time) return '--';
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'p' : 'a';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes}${ampm}`;
        }

        function calculateHours(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;
            const diff = endMinutes - startMinutes;
            return (diff / 60).toFixed(1);
        }

        function formatTime(time) {
            if (!time) return '--';
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }

        // Legacy function kept for modal compatibility
        async function saveSchedule(isQuick = false) {
            const employeeId = document.getElementById('schedule-employee')?.value;
            const store = document.getElementById('schedule-store')?.value;
            const date = document.getElementById('schedule-date')?.value;
            const startTime = document.getElementById('schedule-start')?.value;
            const endTime = document.getElementById('schedule-end')?.value;

            console.log('Saving schedule:', { employeeId, store, date, startTime, endTime });

            if (!employeeId || !store || !date || !startTime || !endTime) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const emp = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);

            const currentUser = getCurrentUser();
            const scheduleData = {
                employeeId,
                employeeName: emp ? emp.name : '',
                store,
                date,
                startTime,
                endTime,
                shiftType: startTime < '14:00' ? 'opening' : 'closing',
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.name || 'Unknown'
            };

            console.log('Schedule data to save:', scheduleData);

            try {
                const db = firebase.firestore();
                const docRef = await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').add(scheduleData);
                console.log('Schedule saved with ID:', docRef.id);

                showNotification('Shift added!', 'success');
                closeModal();
                loadScheduleData();
            } catch (error) {
                console.error('Error saving schedule:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function updateSchedule(scheduleId) {
            const employeeId = document.getElementById('schedule-employee').value;
            const store = document.getElementById('schedule-store').value;
            const date = document.getElementById('schedule-date').value;
            const startTime = document.getElementById('schedule-start').value;
            const endTime = document.getElementById('schedule-end').value;

            if (!employeeId || !store || !date || !startTime || !endTime) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const emp = employees.find(e => e.id === employeeId);

            try {
                const db = firebase.firestore();
                await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).update({
                    employeeId,
                    employeeName: emp ? emp.name : '',
                    store,
                    date,
                    startTime,
                    endTime,
                    updatedAt: new Date().toISOString()
                });

                showNotification('Shift updated!', 'success');
                closeModal();
                loadScheduleData();
            } catch (error) {
                console.error('Error updating schedule:', error);
                showNotification('Error updating schedule', 'error');
            }
        }

        async function deleteSchedule(scheduleId) {
            showConfirmModal({
                title: 'Delete Shift',
                message: 'Are you sure you want to delete this shift?',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        const db = firebase.firestore();
                        await db.collection(window.FIREBASE_COLLECTIONS.schedules || 'schedules').doc(scheduleId).delete();

                        showNotification('Shift deleted!', 'success');
                        loadScheduleData();
                    } catch (error) {
                        console.error('Error deleting schedule:', error);
                        showNotification('Error deleting schedule', 'error');
                    }
                }
            });
        }

        // Thieves database
        let thieves = [];

        /**
         * Initialize Firebase and load thieves from Firestore
         */
        async function initializeFirebaseThieves() {

            const initialized = await firebaseThievesManager.initialize();

            if (initialized) {
                try {
                    const firestoreThieves = await firebaseThievesManager.loadThieves();

                    if (firestoreThieves && firestoreThieves.length > 0) {
                        thieves = firestoreThieves;
                    } else {
                        thieves = [];
                        console.log('No thieves found in Firestore');
                    }
                    return true;
                } catch (error) {
                    console.error('Error loading thieves from Firestore:', error);
                }
            } else {
                console.warn('Firebase not available for thieves.');
            }

            return false;
        }

        /**
         * Save thief record to Firebase
         */
        async function saveThiefToFirebase(thiefData) {
            if (!firebaseThievesManager.isInitialized) {
                console.warn('Firebase Thieves Manager not initialized');
                return null;
            }

            try {
                if (thiefData.firestoreId) {
                    // Update existing
                    const success = await firebaseThievesManager.updateThief(
                        thiefData.firestoreId,
                        thiefData
                    );
                    return success ? thiefData.firestoreId : null;
                } else {
                    // Create new
                    const newId = await firebaseThievesManager.addThief(thiefData);
                    return newId;
                }
            } catch (error) {
                console.error('Error saving thief to Firebase:', error);
                return null;
            }
        }

        /**
         * Delete thief record from Firebase
         */
        async function deleteThiefFromFirebase(firestoreId) {
            if (!firebaseThievesManager.isInitialized) {
                console.warn('Firebase Thieves Manager not initialized');
                return false;
            }

            try {
                return await firebaseThievesManager.deleteThief(firestoreId);
            } catch (error) {
                console.error('Error deleting thief from Firebase:', error);
                return false;
            }
        }

        function renderThieves() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <div class="page-header thieves-page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Thief Database</h2>
                        <p class="section-subtitle">Track and manage theft incidents</p>
                        <select class="form-input thieves-filter-select" id="thieves-filter" onchange="filterThieves(this.value)">
                            <option value="all">All Stores</option>
                            <option value="Miramar">Miramar</option>
                            <option value="Morena">Morena</option>
                            <option value="Kearny Mesa">Kearny Mesa</option>
                            <option value="Chula Vista">Chula Vista</option>
                            <option value="North Park">North Park</option>
                            <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                        </select>
                    </div>
                    <button class="btn-primary floating-add-btn thieves-add-btn" onclick="openModal('add-thief')">
                        <i class="fas fa-plus"></i>
                        Add New Record
                    </button>
                </div>

                <div id="thievesCardsContainer">
                    ${renderThievesCards()}
                </div>
            `;
        }

        function renderThievesCards(filter = 'all') {
            const filteredThieves = filter === 'all' ? thieves : thieves.filter(t => t.store === filter);

            if (filteredThieves.length === 0) {
                return `
                    <div class="card" style="padding: 60px; text-align: center;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; color: var(--text-muted);"></i>
                        <p style="color: var(--text-muted);">No records found</p>
                    </div>
                `;
            }

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    ${filteredThieves.map(thief => `
                        <div class="card" style="overflow: hidden;">
                            <div style="width: 100%; height: 200px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                ${thief.photo ? `<img src="${thief.photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="${thief.name}">` : `<i class="fas fa-user" style="font-size: 64px; color: var(--text-muted);"></i>`}
                            </div>
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${thief.name}</h3>
                                        <span style="font-size: 12px; color: var(--text-muted);">${formatDate(thief.date)}</span>
                                    </div>
                                    ${thief.banned
                                        ? '<span class="badge" style="background: var(--error); color: var(--text-primary);">Banned</span>'
                                        : '<span class="badge" style="background: var(--warning); color: var(--text-primary);">Warning</span>'}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="color: var(--text-muted); font-size: 13px;">Store</span>
                                        <span style="font-weight: 600; font-size: 13px;">${thief.store}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="color: var(--text-muted); font-size: 13px;">Crime Type</span>
                                        <span style="font-weight: 600; font-size: 13px;">${thief.crimeType}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="color: var(--text-muted); font-size: 13px;">Items Stolen</span>
                                        <span style="font-weight: 600; font-size: 13px;">${thief.itemsStolen}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                        <span style="color: var(--text-muted); font-size: 13px;">Estimated Value</span>
                                        <span style="font-weight: 600; font-size: 13px; color: var(--error);">$${thief.estimatedValue.toFixed(2)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    <button class="btn-secondary" onclick="viewThief('${thief.firestoreId || thief.id}')" style="padding: 8px 16px; font-size: 13px;">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn-icon" onclick="editThief('${thief.firestoreId || thief.id}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon danger" onclick="deleteThief('${thief.firestoreId || thief.id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function filterThieves(store) {
            const container = document.getElementById('thievesCardsContainer');
            if (container) {
                container.innerHTML = renderThievesCards(store);
            }
        }

        function viewThief(id) {
            const thief = thieves.find(t => t.id === id || t.firestoreId === id);
            if (!thief) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Theft Record Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 120px 1fr; gap: 24px; margin-bottom: 24px;">
                        <div style="width: 120px; height: 120px; border-radius: 12px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            ${thief.photo ? `<img src="${thief.photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="${thief.name}">` : `<i class="fas fa-user" style="font-size: 48px; color: var(--text-muted);"></i>`}
                        </div>
                        <div>
                            <h3 style="margin: 0 0 8px;">${thief.name}</h3>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <span class="badge" style="background: var(--accent-primary);">${thief.store}</span>
                                ${thief.banned ? '<span class="badge" style="background: var(--error);">Banned</span>' : '<span class="badge" style="background: var(--warning);">Warning</span>'}
                            </div>
                            <p style="color: var(--text-muted); margin: 0;"><i class="fas fa-calendar"></i> ${formatDate(thief.date)}</p>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted);">Crime Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Crime Type</label>
                                    <div>${thief.crimeType}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Estimated Value</label>
                                    <div style="color: var(--error); font-weight: 600;">$${thief.estimatedValue.toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Items Stolen</label>
                                <div>${thief.itemsStolen}</div>
                            </div>
                            ${thief.policeReport ? `
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Police Report #</label>
                                    <div>${thief.policeReport}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted);">Description</h4>
                            <p style="margin: 0; line-height: 1.6;">${thief.description}</p>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        async function deleteThief(id) {
            showConfirmModal({
                title: 'Delete Record',
                message: 'Are you sure you want to delete this thief record? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    // Find the thief to get the firestoreId
                    const thief = thieves.find(t => t.id === id || t.firestoreId === id);

                    if (thief && thief.firestoreId) {
                        // Delete from Firebase
                        const deleted = await deleteThiefFromFirebase(thief.firestoreId);
                        if (deleted) {
                            console.log('Thief record deleted from Firebase:', thief.firestoreId);
                        } else {
                            console.warn('Failed to delete from Firebase, removing locally');
                        }
                    }

                    // Remove from local array
                    thieves = thieves.filter(t => t.id !== id && t.firestoreId !== id);
                    renderThieves();
                }
            });
        }

        function previewThiefPhoto(input) {
            const preview = document.getElementById('thief-photo-preview');
            const img = document.getElementById('thief-photo-img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        function previewEditThiefPhoto(input) {
            const preview = document.getElementById('edit-thief-photo-preview');
            const img = document.getElementById('edit-thief-photo-img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // Variable to store the thief being edited
        let editingThiefId = null;

        function editThief(id) {
            // Find thief by id or firestoreId
            const thief = thieves.find(t => t.id === id || t.firestoreId === id);
            if (!thief) {
                alert('Thief record not found');
                return;
            }

            // Store the thief being edited
            editingThiefId = thief.firestoreId || thief.id;

            // Open modal with edit form
            openModal('edit-thief', thief);
        }

        async function saveEditedThief() {
            if (!editingThiefId) {
                alert('No thief record selected for editing');
                return;
            }

            // Get the current thief data
            const currentThief = thieves.find(t => t.id === editingThiefId || t.firestoreId === editingThiefId);
            if (!currentThief) {
                alert('Thief record not found');
                return;
            }

            // Get form values (use current values as fallback if empty)
            const name = document.getElementById('edit-thief-name').value.trim() || currentThief.name;
            const date = document.getElementById('edit-thief-date').value || currentThief.date;
            const store = document.getElementById('edit-thief-store').value || currentThief.store;
            const crimeType = document.getElementById('edit-thief-crime-type').value || currentThief.crimeType;
            const items = document.getElementById('edit-thief-items').value.trim() || currentThief.itemsStolen;
            const value = document.getElementById('edit-thief-value').value;
            const description = document.getElementById('edit-thief-description').value.trim() || currentThief.description;
            const policeReport = document.getElementById('edit-thief-police-report').value.trim();
            const status = document.getElementById('edit-thief-status').value;
            const photoInput = document.getElementById('edit-thief-photo');

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Get photo - use new one if uploaded, otherwise keep current
                let photoUrl = currentThief.photo;
                let photoPath = currentThief.photoPath || null;
                const photoImg = document.getElementById('edit-thief-photo-img');

                // Check if a new photo was uploaded (it will be base64)
                if (photoInput.files && photoInput.files.length > 0 && photoImg && photoImg.src && photoImg.src.startsWith('data:')) {
                    if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading photo...';

                    // Initialize storage if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    // Delete old photo from storage if it exists
                    if (currentThief.photoPath) {
                        try {
                            await firebaseStorageHelper.deleteFile(currentThief.photoPath);
                        } catch (e) {
                            console.warn('Could not delete old photo:', e);
                        }
                    }

                    // Upload new photo
                    const tempId = currentThief.firestoreId || Date.now().toString();
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        photoImg.src,
                        'thieves/photos',
                        tempId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                }

                const updatedData = {
                    name: name,
                    photo: photoUrl,
                    photoPath: photoPath,
                    date: date,
                    store: store,
                    crimeType: crimeType,
                    itemsStolen: items,
                    estimatedValue: value ? parseFloat(value) : currentThief.estimatedValue,
                    description: description,
                    policeReport: policeReport || currentThief.policeReport || null,
                    banned: status === 'banned'
                };

                if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                // Update in Firebase
                if (firebaseThievesManager.isInitialized && currentThief.firestoreId) {
                    const success = await firebaseThievesManager.updateThief(currentThief.firestoreId, updatedData);
                    if (!success) {
                        throw new Error('Failed to update in Firebase');
                    }
                    console.log('Thief record updated in Firebase:', currentThief.firestoreId);
                }

                // Update local array
                const index = thieves.findIndex(t => t.id === editingThiefId || t.firestoreId === editingThiefId);
                if (index !== -1) {
                    thieves[index] = {
                        ...thieves[index],
                        ...updatedData
                    };
                }

                // Clear editing state
                editingThiefId = null;

                closeModal();
                renderThieves();

                // Show success notification if available
                if (typeof showNotification === 'function') {
                    showNotification('Thief record updated successfully!', 'success');
                }
            } catch (error) {
                console.error('Error updating thief record:', error);
                alert('Error updating thief record. Please try again.');

                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        async function saveThief() {
            const name = document.getElementById('thief-name').value.trim();
            const date = document.getElementById('thief-date').value;
            const store = document.getElementById('thief-store').value;
            const crimeType = document.getElementById('thief-crime-type').value;
            const items = document.getElementById('thief-items').value.trim();
            const value = document.getElementById('thief-value').value;
            const description = document.getElementById('thief-description').value.trim();
            const policeReport = document.getElementById('thief-police-report').value.trim();
            const status = document.getElementById('thief-status').value;
            const photoInput = document.getElementById('thief-photo');

            // Validation
            if (!name || !date || !store || !crimeType || !items || !value || !description) {
                alert('Please fill in all required fields');
                return;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('#add-thief-modal .btn-primary, .modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Get photo and upload to Firebase Storage if available
                let photoUrl = null;
                let photoPath = null;
                const photoImg = document.getElementById('thief-photo-img');
                if (photoImg && photoImg.src && photoInput.files.length > 0 && photoImg.src.startsWith('data:')) {
                    if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading photo...';

                    // Initialize storage if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    // Generate a temporary ID for the file name
                    const tempId = Date.now().toString();
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        photoImg.src,
                        'thieves/photos',
                        tempId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                }

                // Create thief data object with Storage URL instead of base64
                const thiefData = {
                    name: name,
                    photo: photoUrl,           // Now stores URL instead of base64
                    photoPath: photoPath,      // Store path for future deletion
                    date: date,
                    store: store,
                    crimeType: crimeType,
                    itemsStolen: items,
                    estimatedValue: parseFloat(value),
                    description: description,
                    policeReport: policeReport || null,
                    banned: status === 'banned'
                };

                if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving record...';

                // Try to save to Firebase
                const firestoreId = await saveThiefToFirebase(thiefData);

                if (firestoreId) {
                    // Successfully saved to Firebase
                    thiefData.id = firestoreId;
                    thiefData.firestoreId = firestoreId;
                    console.log('Thief record saved to Firebase with ID:', firestoreId);
                } else {
                    // Fallback to local ID
                    const newId = thieves.length > 0 ? Math.max(...thieves.map(t => typeof t.id === 'number' ? t.id : 0)) + 1 : 1;
                    thiefData.id = newId;
                    console.log('Thief record saved locally with ID:', newId);
                }

                // Add to local array
                thieves.unshift(thiefData);

                closeModal();
                renderThieves();
            } catch (error) {
                console.error('Error saving thief:', error);
                alert('Error saving record. Please try again.');
            } finally {
                // Restore button state
                if (saveBtn) {
                    saveBtn.innerHTML = originalText || '<i class="fas fa-save"></i> Save';
                    saveBtn.disabled = false;
                }
            }
        }

        // Invoices database
        let invoices = [
            {
                id: 1,
                invoiceNumber: 'INV-2025-001',
                vendor: 'Cloud Services Inc.',
                category: 'Technology',
                description: 'Cloud storage subscription',
                amount: 299.99,
                dueDate: '2025-12-15',
                paidDate: null,
                status: 'pending',
                recurring: true,
                notes: 'Monthly subscription'
            },
            {
                id: 2,
                invoiceNumber: 'INV-2025-002',
                vendor: 'Office Supplies Co.',
                category: 'Office',
                description: 'Office supplies and equipment',
                amount: 456.50,
                dueDate: '2025-12-10',
                paidDate: '2025-12-08',
                status: 'paid',
                recurring: false,
                notes: ''
            },
            {
                id: 3,
                invoiceNumber: 'INV-2025-003',
                vendor: 'Utilities Provider',
                category: 'Utilities',
                description: 'Monthly electricity bill',
                amount: 523.75,
                dueDate: '2025-12-20',
                paidDate: null,
                status: 'overdue',
                recurring: true,
                notes: 'Store: Miramar'
            }
        ];

        // Invoice filter state
        let invoiceFilters = {
            store: 'all',
            timePeriod: 'all',
            vendor: 'all',
            category: 'all',
            status: 'all',
            minAmount: null,
            maxAmount: null,
            activeTab: 'current' // 'current' or 'recurring'
        };

        // Default invoice categories
        const DEFAULT_INVOICE_CATEGORIES = [
            { id: 'utilities', name: 'Utilities', icon: 'fa-bolt' },
            { id: 'supplies', name: 'Supplies', icon: 'fa-box' },
            { id: 'services', name: 'Services', icon: 'fa-concierge-bell' },
            { id: 'equipment', name: 'Equipment', icon: 'fa-tools' },
            { id: 'marketing', name: 'Marketing', icon: 'fa-bullhorn' },
            { id: 'insurance', name: 'Insurance', icon: 'fa-shield-alt' },
            { id: 'taxes', name: 'Taxes', icon: 'fa-file-invoice-dollar' },
            { id: 'payroll', name: 'Payroll', icon: 'fa-users' },
            { id: 'other', name: 'Other', icon: 'fa-ellipsis-h' }
        ];

        // Custom invoice categories (loaded from Firebase)
        let customInvoiceCategories = [];

        // Load custom invoice categories from Firebase
        async function loadInvoiceCategories() {
            try {
                const snapshot = await db.collection('invoiceCategories').orderBy('name').get();
                customInvoiceCategories = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`[Invoices] Loaded ${customInvoiceCategories.length} custom categories`);
            } catch (error) {
                console.error('[Invoices] Error loading categories:', error);
                customInvoiceCategories = [];
            }
        }

        // Get all invoice categories (default + custom)
        function getAllInvoiceCategories() {
            return [...DEFAULT_INVOICE_CATEGORIES, ...customInvoiceCategories];
        }

        // Add new custom category
        async function addInvoiceCategory(name) {
            if (!name || name.trim() === '') return null;

            const trimmedName = name.trim();
            const categoryId = trimmedName.toLowerCase().replace(/[^a-z0-9]/g, '-');

            // Check if already exists
            const allCategories = getAllInvoiceCategories();
            if (allCategories.some(c => c.id === categoryId || c.name.toLowerCase() === trimmedName.toLowerCase())) {
                showToast('Category already exists', 'warning');
                return null;
            }

            try {
                const docRef = await db.collection('invoiceCategories').add({
                    name: trimmedName,
                    icon: 'fa-tag',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const newCategory = { id: docRef.id, name: trimmedName, icon: 'fa-tag' };
                customInvoiceCategories.push(newCategory);

                showToast(`Category "${trimmedName}" added`, 'success');
                return newCategory;
            } catch (error) {
                console.error('[Invoices] Error adding category:', error);
                showToast('Error adding category', 'error');
                return null;
            }
        }

        // Delete custom category
        async function deleteInvoiceCategory(categoryId) {
            // Prevent deleting default categories
            if (DEFAULT_INVOICE_CATEGORIES.some(c => c.id === categoryId)) {
                showToast('Cannot delete default categories', 'warning');
                return false;
            }

            try {
                await db.collection('invoiceCategories').doc(categoryId).delete();
                customInvoiceCategories = customInvoiceCategories.filter(c => c.id !== categoryId);
                showToast('Category deleted', 'success');
                return true;
            } catch (error) {
                console.error('[Invoices] Error deleting category:', error);
                showToast('Error deleting category', 'error');
                return false;
            }
        }

        // Show add category modal
        window.showAddInvoiceCategoryModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'add-category-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-plus-circle"></i> Add New Category</h3>
                        <button class="modal-close" onclick="closeAddCategoryModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Category Name</label>
                            <input type="text" class="form-input" id="new-category-name" placeholder="e.g., Marketing, Insurance, Taxes..." autofocus>
                        </div>
                        <div style="margin-top: 16px;">
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                <i class="fas fa-info-circle"></i> Custom categories you add will be available for all invoices.
                            </p>
                            ${customInvoiceCategories.length > 0 ? `
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Your custom categories:</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${customInvoiceCategories.map(c => `
                                            <span style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--bg-card); border-radius: 16px; font-size: 12px;">
                                                ${c.name}
                                                <button onclick="confirmDeleteCategory('${c.id}', '${c.name}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0; font-size: 14px;" title="Delete">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAddCategoryModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveNewInvoiceCategory()">
                            <i class="fas fa-plus"></i> Add Category
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Focus input and add enter key handler
            setTimeout(() => {
                const input = document.getElementById('new-category-name');
                if (input) {
                    input.focus();
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') saveNewInvoiceCategory();
                    });
                }
            }, 100);
        };

        window.closeAddCategoryModal = function() {
            const modal = document.getElementById('add-category-modal');
            if (modal) modal.remove();
        };

        window.confirmDeleteCategory = function(categoryId, categoryName) {
            if (confirm(`Delete category "${categoryName}"? Invoices using this category will keep their current category.`)) {
                deleteInvoiceCategory(categoryId).then(success => {
                    if (success) {
                        closeAddCategoryModal();
                        showAddInvoiceCategoryModal(); // Refresh the modal
                    }
                });
            }
        };

        window.saveNewInvoiceCategory = async function() {
            const input = document.getElementById('new-category-name');
            if (!input) return;

            const name = input.value.trim();
            if (!name) {
                showToast('Please enter a category name', 'warning');
                input.focus();
                return;
            }

            const newCategory = await addInvoiceCategory(name);
            if (newCategory) {
                closeAddCategoryModal();
                // Refresh the invoice form if open
                updateInvoiceCategorySelects();
            }
        };

        // Update all category selects in the page
        function updateInvoiceCategorySelects() {
            const allCategories = getAllInvoiceCategories();
            const selects = document.querySelectorAll('#invoice-category, #edit-invoice-category');

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">Select category...</option>
                    ${allCategories.map(c => `
                        <option value="${c.id}" ${currentValue === c.id ? 'selected' : ''}>${c.name}</option>
                    `).join('')}
                `;
            });
        }

        // Render invoice category checkboxes with custom category option
        function renderInvoiceCategoryCheckboxes(selectedCategories = [], containerId = 'invoice-categories-container') {
            const allCategories = getAllInvoiceCategories();
            // Normalize selectedCategories to array
            let selected = [];
            if (Array.isArray(selectedCategories)) {
                selected = selectedCategories;
            } else if (typeof selectedCategories === 'string' && selectedCategories) {
                selected = [selectedCategories];
            }

            return `
                <div id="${containerId}" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: var(--bg-hover); border-radius: 8px; border: 1px solid var(--border-color);">
                    ${allCategories.map(c => `
                        <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: var(--bg-card); border-radius: 8px; cursor: pointer; border: 2px solid ${selected.includes(c.id) || selected.includes(c.name) ? 'var(--accent-primary)' : 'var(--border-color)'}; transition: all 0.2s;">
                            <input type="checkbox" value="${c.name}" ${selected.includes(c.id) || selected.includes(c.name) ? 'checked' : ''} style="width: 16px; height: 16px; accent-color: var(--accent-primary);" onchange="updateInvoiceCategoryCheckboxStyle(this)">
                            <span style="font-size: 13px; font-weight: 500;">${c.name}</span>
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <input type="text" class="form-input" id="${containerId}-custom-input" placeholder="Add custom category..." style="flex: 1;">
                    <button type="button" class="btn-secondary" onclick="addInvoiceCustomCategoryCheckbox('${containerId}')" style="white-space: nowrap;">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            `;
        }

        // Update checkbox label style when checked/unchecked
        window.updateInvoiceCategoryCheckboxStyle = function(checkbox) {
            const label = checkbox.parentElement;
            if (checkbox.checked) {
                label.style.borderColor = 'var(--accent-primary)';
            } else {
                label.style.borderColor = 'var(--border-color)';
            }
        };

        // Add custom category checkbox
        window.addInvoiceCustomCategoryCheckbox = async function(containerId) {
            const input = document.getElementById(`${containerId}-custom-input`);
            const container = document.getElementById(containerId);
            const customCategory = input.value.trim();

            if (!customCategory) {
                showNotification('Please enter a category name', 'warning');
                return;
            }

            // Check if already exists
            const existingCheckbox = container.querySelector(`input[value="${customCategory}"]`);
            if (existingCheckbox) {
                existingCheckbox.checked = true;
                updateInvoiceCategoryCheckboxStyle(existingCheckbox);
                input.value = '';
                showNotification('Category already exists, selected it', 'info');
                return;
            }

            // Add to Firebase
            const newCategory = await addInvoiceCategory(customCategory);

            if (newCategory) {
                // Add new checkbox
                const newLabel = document.createElement('label');
                newLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: var(--bg-card); border-radius: 8px; cursor: pointer; border: 2px solid var(--accent-primary); transition: all 0.2s;';
                newLabel.innerHTML = `
                    <input type="checkbox" value="${customCategory}" checked style="width: 16px; height: 16px; accent-color: var(--accent-primary);" onchange="updateInvoiceCategoryCheckboxStyle(this)">
                    <span style="font-size: 13px; font-weight: 500;">${customCategory}</span>
                `;
                container.appendChild(newLabel);
                input.value = '';
            }
        };

        // Get selected invoice categories from checkboxes
        function getSelectedInvoiceCategories(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Legacy function for backwards compatibility
        function renderInvoiceCategorySelect(selectedValue = '', selectId = 'invoice-category') {
            // Convert to checkbox format
            return renderInvoiceCategoryCheckboxes(selectedValue ? [selectedValue] : [], selectId.replace('-category', '-categories-container'));
        }

        // Render invoice categories as badges (for display in tables/cards)
        function renderInvoiceCategoryBadges(invoice) {
            // Support both single category and multiple categories
            const cats = invoice.categories && invoice.categories.length > 0
                ? invoice.categories
                : (invoice.category ? [invoice.category] : []);

            if (cats.length === 0) {
                return '<span style="color: var(--text-muted); font-size: 11px;">No category</span>';
            }

            // Category colors for visual variety
            const categoryColors = {
                'Utilities': '#f59e0b',
                'Supplies': '#84cc16',
                'Services': '#10b981',
                'Equipment': '#8b5cf6',
                'Marketing': '#ec4899',
                'Insurance': '#14b8a6',
                'Taxes': '#f97316',
                'Payroll': '#06b6d4',
                'Other': '#6b7280'
            };

            return cats.map((cat, idx) => {
                const color = categoryColors[cat] || '#6366f1';
                const isFirst = idx === 0;
                return `<span class="badge" style="background: ${color}; color: #fff; font-size: ${isFirst ? '11px' : '10px'}; opacity: ${isFirst ? 1 : 0.85}; margin-right: 4px;">${cat}</span>`;
            }).join('');
        }

        // Chart instances (for cleanup)
        let invoiceCharts = {
            statusChart: null,
            timeChart: null,
            vendorChart: null,
            trendChart: null,
            categoryChart: null
        };

        // Helper function to get filtered invoices
        function getFilteredInvoices() {
            let filtered = [...invoices];

            // Filter by store
            if (invoiceFilters.store !== 'all') {
                filtered = filtered.filter(i => i.store === invoiceFilters.store);
            }

            // Filter by time period
            if (invoiceFilters.timePeriod !== 'all') {
                const now = new Date();
                const filterDate = new Date();

                switch (invoiceFilters.timePeriod) {
                    case '7days':
                        filterDate.setDate(now.getDate() - 7);
                        break;
                    case 'thisMonth':
                        filterDate.setDate(1);
                        break;
                    case 'lastMonth':
                        filterDate.setMonth(now.getMonth() - 1);
                        filterDate.setDate(1);
                        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                        filtered = filtered.filter(i => {
                            const date = new Date(i.dueDate);
                            return date >= filterDate && date <= lastMonthEnd;
                        });
                        return filtered;
                    case 'thisQuarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        filterDate.setMonth(quarter * 3);
                        filterDate.setDate(1);
                        break;
                    case 'thisYear':
                        filterDate.setMonth(0);
                        filterDate.setDate(1);
                        break;
                }

                filtered = filtered.filter(i => new Date(i.dueDate) >= filterDate);
            }

            // Filter by vendor
            if (invoiceFilters.vendor !== 'all') {
                filtered = filtered.filter(i => i.vendor === invoiceFilters.vendor);
            }

            // Filter by category (supports multiple categories)
            if (invoiceFilters.category !== 'all') {
                filtered = filtered.filter(i => {
                    const cats = i.categories && i.categories.length > 0 ? i.categories : (i.category ? [i.category] : []);
                    return cats.some(c => c.toLowerCase() === invoiceFilters.category.toLowerCase());
                });
            }

            // Filter by status
            if (invoiceFilters.status !== 'all') {
                filtered = filtered.filter(i => i.status === invoiceFilters.status);
            }

            // Filter by amount range
            if (invoiceFilters.minAmount !== null) {
                filtered = filtered.filter(i => i.amount >= invoiceFilters.minAmount);
            }
            if (invoiceFilters.maxAmount !== null) {
                filtered = filtered.filter(i => i.amount <= invoiceFilters.maxAmount);
            }

            return filtered;
        }

        // Update invoice filter and re-render
        function updateInvoiceFilter(filterKey, value) {
            invoiceFilters[filterKey] = value;
            renderInvoices();
        }

        // Reset all invoice filters
        function resetInvoiceFilters() {
            invoiceFilters = {
                store: 'all',
                timePeriod: 'all',
                vendor: 'all',
                category: 'all',
                status: 'all',
                minAmount: null,
                maxAmount: null,
                activeTab: invoiceFilters.activeTab
            };
            renderInvoices();
        }

        // Switch invoice tab
        function switchInvoiceTab(tab) {
            invoiceFilters.activeTab = tab;
            renderInvoices();
        }

        // Render current invoices table
        function renderCurrentInvoicesTable(filteredInvoices) {
            if (filteredInvoices.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 16px;">No invoices found</div>
                        <div style="font-size: 14px; margin-top: 8px;">Try adjusting your filters</div>
                    </div>
                `;
            }

            return `
                <table class="data-table invoices-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">File</th>
                            <th>Invoice #</th>
                            <th>Vendor</th>
                            <th>Category</th>
                            <th>Store</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th style="width: 140px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredInvoices.map(invoice => {
                            const statusStyles = {
                                paid: 'background: #10b981; color: #fff;',
                                pending: 'background: #f59e0b; color: #000;',
                                overdue: 'background: #ef4444; color: #fff;',
                                filed: 'background: #6366f1; color: #fff;'
                            };
                            const invoiceId = invoice.firestoreId || invoice.id;

                            return `
                                <tr>
                                    <td data-label="">
                                        ${invoice.photo ? (invoice.fileType === 'pdf' ? `
                                            <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="viewInvoice('${invoiceId}')" title="PDF">
                                                <i class="fas fa-file-pdf" style="font-size: 20px; color: #ef4444;"></i>
                                            </div>
                                        ` : `
                                            <img src="${invoice.photo}" alt="Invoice" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer;" onclick="viewInvoice('${invoiceId}')">
                                        `) : `
                                            <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-file-invoice" style="color: var(--text-muted);"></i>
                                            </div>
                                        `}
                                    </td>
                                    <td data-label="Invoice #"><strong>${invoice.invoiceNumber}</strong></td>
                                    <td data-label="Vendor">${invoice.vendor}</td>
                                    <td data-label="Category">${renderInvoiceCategoryBadges(invoice)}</td>
                                    <td data-label="Store">${invoice.store || '<span style="color: var(--text-muted);">Unassigned</span>'}</td>
                                    <td data-label="Amount" style="font-weight: 600;">$${invoice.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                    <td data-label="Due Date">${formatDate(invoice.dueDate)}</td>
                                    <td data-label="Status">
                                        <span class="badge" style="${statusStyles[invoice.status]}; font-size: 11px;">${invoice.status.toUpperCase()}</span>
                                        ${invoice.recurring ? '<i class="fas fa-sync-alt" style="margin-left: 6px; color: var(--text-muted); font-size: 12px;" title="Recurring"></i>' : ''}
                                    </td>
                                    <td data-label="">
                                        ${invoice.status !== 'paid' ? `<button class="btn-icon" onclick="markInvoicePaid('${invoiceId}')" title="Mark Paid"><i class="fas fa-check"></i></button>` : ''}
                                        <button class="btn-icon" onclick="viewInvoice('${invoiceId}')" title="View"><i class="fas fa-eye"></i></button>
                                        <button class="btn-icon" onclick="editInvoice('${invoiceId}')" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="btn-icon danger" onclick="deleteInvoice('${invoiceId}')" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Render recurring projections
        function renderRecurringProjections() {
            const recurringInvoices = invoices.filter(i => i.recurring);

            if (recurringInvoices.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-sync-alt" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 16px;">No recurring invoices found</div>
                        <div style="font-size: 14px; margin-top: 8px;">Mark invoices as recurring to see future projections</div>
                    </div>
                `;
            }

            // Generate next 6 months of projections
            const projections = [];
            const today = new Date();

            recurringInvoices.forEach(invoice => {
                for (let i = 1; i <= 6; i++) {
                    const projectionDate = new Date(today);
                    projectionDate.setMonth(today.getMonth() + i);

                    projections.push({
                        ...invoice,
                        projectedDate: projectionDate,
                        isProjection: true
                    });
                }
            });

            // Sort by date
            projections.sort((a, b) => a.projectedDate - b.projectedDate);

            return `
                <div style="padding: 20px;">
                    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i class="fas fa-info-circle" style="color: var(--accent-primary); font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Recurring Invoice Projections</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Showing projected invoices for the next 6 months based on monthly recurrence</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px;">
                            <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Total Projected (6mo)</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent-primary);">
                                    $${projections.reduce((sum, p) => sum + p.amount, 0).toLocaleString('en-US', {minimumFractionDigits: 2})}
                                </div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Recurring Invoices</div>
                                <div style="font-size: 20px; font-weight: 700;">${recurringInvoices.length}</div>
                            </div>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Projected Date</th>
                                <th>Invoice #</th>
                                <th>Vendor</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${projections.map(proj => `
                                <tr>
                                    <td><strong>${formatDate(proj.projectedDate)}</strong></td>
                                    <td>${proj.invoiceNumber} <span style="font-size: 11px; color: var(--text-muted);">(recurring)</span></td>
                                    <td>${proj.vendor}</td>
                                    <td><span class="badge" style="background: var(--accent-primary); color: #fff; font-size: 11px;">${proj.category}</span></td>
                                    <td>${proj.store || '<span style="color: var(--text-muted);">Unassigned</span>'}</td>
                                    <td style="font-weight: 600;">$${proj.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Initialize all invoice charts
        function initializeInvoiceCharts(filteredInvoices) {
            // Destroy existing charts
            Object.values(invoiceCharts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Status Breakdown (Donut Chart)
            const statusCtx = document.getElementById('invoice-status-chart');
            if (statusCtx) {
                const statusCounts = {
                    paid: filteredInvoices.filter(i => i.status === 'paid').length,
                    pending: filteredInvoices.filter(i => i.status === 'pending').length,
                    overdue: filteredInvoices.filter(i => i.status === 'overdue').length
                };

                invoiceCharts.statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Paid', 'Pending', 'Overdue'],
                        datasets: [{
                            data: [statusCounts.paid, statusCounts.pending, statusCounts.overdue],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Category Breakdown (Pie Chart)
            const categoryCtx = document.getElementById('invoice-category-chart');
            if (categoryCtx) {
                const categoryData = {};
                filteredInvoices.forEach(inv => {
                    const cat = inv.category || 'Other';
                    categoryData[cat] = (categoryData[cat] || 0) + inv.amount;
                });

                const categoryLabels = Object.keys(categoryData);
                const categoryValues = Object.values(categoryData);
                const categoryColors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444'];

                invoiceCharts.categoryChart = new Chart(categoryCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: categoryColors.slice(0, categoryLabels.length),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': $' + context.parsed.toLocaleString('en-US', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Amount Over Time (Bar Chart - Weekly)
            const timeCtx = document.getElementById('invoice-time-chart');
            if (timeCtx) {
                // Get last 8 weeks of data
                const weeks = [];
                const now = new Date();

                for (let i = 7; i >= 0; i--) {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (i * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    const weekInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.dueDate);
                        return invDate >= weekStart && invDate <= weekEnd;
                    });

                    const weekTotal = weekInvoices.reduce((sum, inv) => sum + inv.amount, 0);

                    weeks.push({
                        label: `${weekStart.getMonth() + 1}/${weekStart.getDate()}`,
                        total: weekTotal
                    });
                }

                invoiceCharts.timeChart = new Chart(timeCtx, {
                    type: 'bar',
                    data: {
                        labels: weeks.map(w => w.label),
                        datasets: [{
                            label: 'Amount',
                            data: weeks.map(w => w.total),
                            backgroundColor: '#6366f1',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Trend Analysis (Line Chart)
            const trendCtx = document.getElementById('invoice-trend-chart');
            if (trendCtx) {
                // Get last 12 weeks cumulative
                const trendWeeks = [];
                const now = new Date();
                let cumulative = 0;

                for (let i = 11; i >= 0; i--) {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (i * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    const weekInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.dueDate);
                        return invDate >= weekStart && invDate <= weekEnd;
                    });

                    const weekTotal = weekInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                    cumulative += weekTotal;

                    trendWeeks.push({
                        label: `${weekStart.getMonth() + 1}/${weekStart.getDate()}`,
                        cumulative: cumulative
                    });
                }

                invoiceCharts.trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: trendWeeks.map(w => w.label),
                        datasets: [{
                            label: 'Cumulative Amount',
                            data: trendWeeks.map(w => w.cumulative),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Top Vendors (Horizontal Bar Chart)
            const vendorCtx = document.getElementById('invoice-vendor-chart');
            if (vendorCtx) {
                const vendorData = {};
                filteredInvoices.forEach(inv => {
                    vendorData[inv.vendor] = (vendorData[inv.vendor] || 0) + inv.amount;
                });

                const sortedVendors = Object.entries(vendorData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                invoiceCharts.vendorChart = new Chart(vendorCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedVendors.map(v => v[0]),
                        datasets: [{
                            label: 'Total Amount',
                            data: sortedVendors.map(v => v[1]),
                            backgroundColor: '#8b5cf6',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '$' + context.parsed.x.toLocaleString('en-US', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        async function renderInvoices() {
            const dashboard = document.querySelector('.dashboard');

            // Load invoices and categories from Firebase
            await Promise.all([
                loadInvoicesFromFirebase(),
                loadInvoiceCategories()
            ]);

            // Get filtered invoices
            const filteredInvoices = getFilteredInvoices();

            // Calculate metrics - considering partial payments
            const totalAmount = filteredInvoices.reduce((sum, i) => sum + i.amount, 0);
            // Total paid = fully paid invoices + partial payments made
            const totalPaid = filteredInvoices.reduce((sum, i) => {
                if (i.status === 'paid') return sum + i.amount;
                return sum + (i.amountPaid || 0); // Add partial payments
            }, 0);
            // Total pending = balance remaining on pending, partial, and overdue invoices
            const totalPending = filteredInvoices.reduce((sum, i) => {
                if (i.status === 'pending' || i.status === 'overdue' || i.status === 'partial') {
                    return sum + (i.amount - (i.amountPaid || 0));
                }
                return sum;
            }, 0);
            const overdueCount = filteredInvoices.filter(i => i.status === 'overdue').length;

            // Get unique values for filters
            const stores = ['All Stores', ...new Set(invoices.filter(i => i.store).map(i => i.store))];
            const vendors = [...new Set(invoices.map(i => i.vendor))].sort();
            const categories = getAllInvoiceCategories();

            // Calculate pending payments for tab badge
            const pendingPaymentsCount = invoices.filter(i => i.status === 'pending' || i.status === 'overdue' || (i.status === 'partial' && (i.amountPaid || 0) < i.amount)).length;

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Invoices & Payments</h2>
                        <p class="section-subtitle">Track and manage all your invoices and payments</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="exportInvoicesToExcel()" style="padding: 10px 16px; border-radius: 8px; border: 1px solid #10b981; background: rgba(16, 185, 129, 0.1); color: #10b981; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#10b981'; this.style.color='white';" onmouseout="this.style.background='rgba(16, 185, 129, 0.1)'; this.style.color='#10b981';">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button onclick="exportInvoicesToPDF()" style="padding: 10px 16px; border-radius: 8px; border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.1); color: #ef4444; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#ef4444'; this.style.color='white';" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.color='#ef4444';">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-invoice')">
                            <i class="fas fa-plus"></i> Add Invoice
                        </button>
                    </div>
                </div>

                <!-- MAIN TABS NAVIGATION -->
                <div style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;">
                    <button onclick="switchInvoiceMainTab('all')" class="invoice-main-tab ${!invoiceFilters.mainTab || invoiceFilters.mainTab === 'all' ? 'active' : ''}" style="padding: 12px 24px; border-radius: 12px; border: 2px solid ${!invoiceFilters.mainTab || invoiceFilters.mainTab === 'all' ? '#6366f1' : 'var(--border-color)'}; background: ${!invoiceFilters.mainTab || invoiceFilters.mainTab === 'all' ? 'linear-gradient(135deg, #6366f1, #8b5cf6)' : 'var(--bg-card)'}; color: ${!invoiceFilters.mainTab || invoiceFilters.mainTab === 'all' ? 'white' : 'var(--text-primary)'}; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                        <i class="fas fa-file-invoice"></i> Invoices
                    </button>
                    <button onclick="switchInvoiceMainTab('pending')" class="invoice-main-tab ${invoiceFilters.mainTab === 'pending' ? 'active' : ''}" style="padding: 12px 24px; border-radius: 12px; border: 2px solid ${invoiceFilters.mainTab === 'pending' ? '#f59e0b' : 'var(--border-color)'}; background: ${invoiceFilters.mainTab === 'pending' ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 'var(--bg-card)'}; color: ${invoiceFilters.mainTab === 'pending' ? 'white' : 'var(--text-primary)'}; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                        <i class="fas fa-clock"></i> Pending Payments
                        ${pendingPaymentsCount > 0 ? `<span style="background: ${invoiceFilters.mainTab === 'pending' ? 'rgba(255,255,255,0.3)' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${pendingPaymentsCount}</span>` : ''}
                    </button>
                    <button onclick="switchInvoiceMainTab('recurring')" class="invoice-main-tab ${invoiceFilters.mainTab === 'recurring' ? 'active' : ''}" style="padding: 12px 24px; border-radius: 12px; border: 2px solid ${invoiceFilters.mainTab === 'recurring' ? '#8b5cf6' : 'var(--border-color)'}; background: ${invoiceFilters.mainTab === 'recurring' ? 'linear-gradient(135deg, #8b5cf6, #a855f7)' : 'var(--bg-card)'}; color: ${invoiceFilters.mainTab === 'recurring' ? 'white' : 'var(--text-primary)'}; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                        <i class="fas fa-sync-alt"></i> Recurring
                    </button>
                    <button onclick="switchInvoiceMainTab('analytics')" class="invoice-main-tab ${invoiceFilters.mainTab === 'analytics' ? 'active' : ''}" style="padding: 12px 24px; border-radius: 12px; border: 2px solid ${invoiceFilters.mainTab === 'analytics' ? '#10b981' : 'var(--border-color)'}; background: ${invoiceFilters.mainTab === 'analytics' ? 'linear-gradient(135deg, #10b981, #059669)' : 'var(--bg-card)'}; color: ${invoiceFilters.mainTab === 'analytics' ? 'white' : 'var(--text-primary)'}; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                        <i class="fas fa-chart-pie"></i> Analytics
                    </button>

                    <!-- Store Quick Filters -->
                    <div style="display: flex; gap: 6px; margin-left: auto; flex-wrap: wrap;">
                        <button onclick="filterInvoicesByStore('all')" style="padding: 8px 12px; border-radius: 8px; border: none; background: ${invoiceFilters.store === 'all' ? '#10b981' : '#e5e7eb'}; color: ${invoiceFilters.store === 'all' ? 'white' : '#374151'}; font-weight: 600; font-size: 11px; cursor: pointer; text-transform: uppercase;">Cash Expense</button>
                        <button onclick="filterInvoicesByStore('Miramar')" style="padding: 8px 12px; border-radius: 8px; border: none; background: ${invoiceFilters.store === 'Miramar' ? '#8b5cf6' : '#e5e7eb'}; color: ${invoiceFilters.store === 'Miramar' ? 'white' : '#374151'}; font-weight: 600; font-size: 11px; cursor: pointer; text-transform: uppercase;">MM Expenses</button>
                        <button onclick="filterInvoicesByStore('Chula Vista')" style="padding: 8px 12px; border-radius: 8px; border: none; background: ${invoiceFilters.store === 'Chula Vista' ? '#ec4899' : '#e5e7eb'}; color: ${invoiceFilters.store === 'Chula Vista' ? 'white' : '#374151'}; font-weight: 600; font-size: 11px; cursor: pointer; text-transform: uppercase;">CV Expenses</button>
                        <button onclick="filterInvoicesByStore('North Park')" style="padding: 8px 12px; border-radius: 8px; border: none; background: ${invoiceFilters.store === 'North Park' ? '#f59e0b' : '#e5e7eb'}; color: ${invoiceFilters.store === 'North Park' ? 'white' : '#374151'}; font-weight: 600; font-size: 11px; cursor: pointer; text-transform: uppercase;">NP Expenses</button>
                        <button onclick="filterInvoicesByStore('Morena')" style="padding: 8px 12px; border-radius: 8px; border: none; background: ${invoiceFilters.store === 'Morena' ? '#3b82f6' : '#e5e7eb'}; color: ${invoiceFilters.store === 'Morena' ? 'white' : '#374151'}; font-weight: 600; font-size: 11px; cursor: pointer; text-transform: uppercase;">MB Expenses</button>
                        <button onclick="filterInvoicesByStore('Kearny Mesa')" style="padding: 8px 12px; border-radius: 8px; border: none; background: ${invoiceFilters.store === 'Kearny Mesa' ? '#14b8a6' : '#e5e7eb'}; color: ${invoiceFilters.store === 'Kearny Mesa' ? 'white' : '#374151'}; font-weight: 600; font-size: 11px; cursor: pointer; text-transform: uppercase;">KM Expenses</button>
                        <button onclick="filterInvoicesByStore('Miramar Wine & Liquor')" style="padding: 8px 12px; border-radius: 8px; border: none; background: ${invoiceFilters.store === 'Miramar Wine & Liquor' ? '#7c3aed' : '#e5e7eb'}; color: ${invoiceFilters.store === 'Miramar Wine & Liquor' ? 'white' : '#374151'}; font-weight: 600; font-size: 11px; cursor: pointer; text-transform: uppercase;">Liquor Expenses</button>
                    </div>
                </div>

                <!-- Summary Cards - Always visible -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; padding: 16px; color: white; display: flex; align-items: center; gap: 12px;">
                        <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 11px; opacity: 0.9;">Total</div>
                            <div style="font-size: 20px; font-weight: 700;">$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 16px; color: white; display: flex; align-items: center; gap: 12px;">
                        <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-check-circle" style="font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 11px; opacity: 0.9;">Paid</div>
                            <div style="font-size: 20px; font-weight: 700;">$${totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 16px; color: white; display: flex; align-items: center; gap: 12px;">
                        <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-clock" style="font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 11px; opacity: 0.9;">Pending</div>
                            <div style="font-size: 20px; font-weight: 700;">$${totalPending.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; padding: 16px; color: white; display: flex; align-items: center; gap: 12px;">
                        <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 11px; opacity: 0.9;">Overdue</div>
                            <div style="font-size: 20px; font-weight: 700;">${overdueCount}</div>
                        </div>
                    </div>
                </div>

                <!-- TAB CONTENT -->
                <div id="invoice-main-tab-content">
                    ${renderInvoiceTabContent(invoiceFilters.mainTab || 'pending', filteredInvoices, stores, vendors, categories)}
                </div>
            `;

            // Initialize charts if on analytics tab
            if (invoiceFilters.mainTab === 'analytics') {
                setTimeout(() => initializeInvoiceCharts(filteredInvoices), 100);
            }
        }

        // Function to render tab content based on active tab
        function renderInvoiceTabContent(tab, filteredInvoices, stores, vendors, categories) {
            if (tab === 'pending') {
                return renderPendingPaymentsTab();
            } else if (tab === 'all') {
                return renderAllInvoicesTab(filteredInvoices, stores, vendors, categories);
            } else if (tab === 'recurring') {
                return renderRecurringTab();
            } else if (tab === 'analytics') {
                return renderAnalyticsTab(filteredInvoices);
            }
            return renderPendingPaymentsTab();
        }

        // Pending Payments Tab Content
        function renderPendingPaymentsTab() {
            // First filter by store if a store filter is active
            let filteredInvoices = invoices;
            if (invoiceFilters.store && invoiceFilters.store !== 'all') {
                filteredInvoices = invoices.filter(i => i.store === invoiceFilters.store);
            }
            // Then filter for pending/overdue/partial
            const pendingPayments = filteredInvoices.filter(i => i.status === 'pending' || i.status === 'overdue' || (i.status === 'partial' && (i.amountPaid || 0) < i.amount));
            const totalOwed = pendingPayments.reduce((sum, i) => sum + (i.amount - (i.amountPaid || 0)), 0);
            const overduePayments = pendingPayments.filter(i => {
                const dueDate = i.dueDate ? new Date(i.dueDate) : null;
                return dueDate && dueDate < new Date();
            });
            const overdueAmount = overduePayments.reduce((sum, i) => sum + (i.amount - (i.amountPaid || 0)), 0);

            if (pendingPayments.length === 0) return `
                <div class="card" style="border: 2px solid #10b981; background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(5,150,105,0.05) 100%);">
                    <div class="card-body" style="text-align: center; padding: 60px;">
                        <i class="fas fa-check-circle" style="font-size: 64px; color: #10b981; margin-bottom: 20px;"></i>
                        <h3 style="color: #10b981; margin-bottom: 8px; font-size: 24px;">All Caught Up!</h3>
                        <p style="color: var(--text-muted); font-size: 16px;">No pending payments at this time.</p>
                    </div>
                </div>
            `;

            return `
                <div class="card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, rgba(245,158,11,0.08) 0%, rgba(217,119,6,0.03) 100%); overflow: hidden;">
                    <!-- Header Banner -->
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-clock" style="font-size: 28px; color: white;"></i>
                            </div>
                            <div>
                                <h3 style="color: white; font-size: 22px; font-weight: 700; margin: 0;">Pending Payments</h3>
                                <p style="color: rgba(255,255,255,0.85); font-size: 14px; margin: 4px 0 0 0;">${pendingPayments.length} invoice${pendingPayments.length !== 1 ? 's' : ''} awaiting payment</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 11px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 1px;">Total Owed</div>
                                <div style="font-size: 24px; font-weight: 800; color: white;">$${totalOwed.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            </div>
                            ${overduePayments.length > 0 ? `
                            <div style="background: rgba(239,68,68,0.9); padding: 12px 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 11px; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 1px;">Overdue</div>
                                <div style="font-size: 24px; font-weight: 800; color: white;">$${overdueAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="card-body" style="padding: 0; max-height: 500px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: rgba(245,158,11,0.1); position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th style="padding: 14px 16px; text-align: left; font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Vendor</th>
                                    <th style="padding: 14px 16px; text-align: left; font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Invoice #</th>
                                    <th style="padding: 14px 16px; text-align: left; font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Store</th>
                                    <th style="padding: 14px 16px; text-align: right; font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Amount</th>
                                    <th style="padding: 14px 16px; text-align: right; font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Balance</th>
                                    <th style="padding: 14px 16px; text-align: center; font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Due Date</th>
                                    <th style="padding: 14px 16px; text-align: center; font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Status</th>
                                    <th style="padding: 14px 16px; text-align: center; font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pendingPayments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)).map(inv => {
                                    const balance = inv.amount - (inv.amountPaid || 0);
                                    const dueDate = inv.dueDate ? new Date(inv.dueDate) : null;
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);
                                    const daysUntilDue = dueDate ? Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)) : null;
                                    const isOverdue = daysUntilDue !== null && daysUntilDue < 0;
                                    const isDueSoon = daysUntilDue !== null && daysUntilDue >= 0 && daysUntilDue <= 7;

                                    let statusColor, statusText, statusBg;
                                    if (isOverdue) {
                                        statusColor = '#ef4444';
                                        statusBg = 'rgba(239,68,68,0.15)';
                                        statusText = Math.abs(daysUntilDue) + 'd overdue';
                                    } else if (inv.status === 'partial') {
                                        statusColor = '#8b5cf6';
                                        statusBg = 'rgba(139,92,246,0.15)';
                                        statusText = 'Partial';
                                    } else if (isDueSoon) {
                                        statusColor = '#f59e0b';
                                        statusBg = 'rgba(245,158,11,0.15)';
                                        statusText = daysUntilDue === 0 ? 'Due today' : daysUntilDue + 'd left';
                                    } else {
                                        statusColor = '#6366f1';
                                        statusBg = 'rgba(99,102,241,0.15)';
                                        statusText = 'Pending';
                                    }

                                    return `
                                <tr style="border-bottom: 1px solid var(--border-color); ${isOverdue ? 'background: rgba(239,68,68,0.05);' : ''}" onmouseover="this.style.background='${isOverdue ? 'rgba(239,68,68,0.1)' : 'rgba(99,102,241,0.05)'}'" onmouseout="this.style.background='${isOverdue ? 'rgba(239,68,68,0.05)' : 'transparent'}'">
                                    <td style="padding: 14px 16px;"><div style="font-weight: 600; color: var(--text-primary);">${inv.vendor || 'Unknown'}</div></td>
                                    <td style="padding: 14px 16px; color: var(--text-secondary); font-family: monospace; font-size: 13px;">${inv.invoiceNumber || '-'}</td>
                                    <td style="padding: 14px 16px; color: var(--text-secondary); font-size: 13px;">${inv.store || '-'}</td>
                                    <td style="padding: 14px 16px; text-align: right; color: var(--text-primary); font-weight: 500;">$${inv.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                    <td style="padding: 14px 16px; text-align: right; font-weight: 700; color: ${isOverdue ? '#ef4444' : '#f59e0b'};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                    <td style="padding: 14px 16px; text-align: center; color: ${isOverdue ? '#ef4444' : 'var(--text-secondary)'}; font-size: 13px; font-weight: ${isOverdue ? '600' : '400'};">
                                        ${inv.dueDate ? new Date(inv.dueDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : '-'}
                                    </td>
                                    <td style="padding: 14px 16px; text-align: center;">
                                        <span style="background: ${statusBg}; color: ${statusColor}; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${statusText}</span>
                                    </td>
                                    <td style="padding: 14px 16px; text-align: center;">
                                        <button onclick="openRecordPaymentModal('${inv.id || inv.firestoreId}')" style="background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                                            <i class="fas fa-credit-card"></i> Pay
                                        </button>
                                    </td>
                                </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // All Invoices Tab Content
        function renderAllInvoicesTab(filteredInvoices, stores, vendors, categories) {
            const storeOptions = stores.map(s => `<option value="${s === 'All Stores' ? 'all' : s}" ${invoiceFilters.store === (s === 'All Stores' ? 'all' : s) ? 'selected' : ''}>${s}</option>`).join('');
            const vendorOptions = vendors.map(v => `<option value="${v}">${v}</option>`).join('');

            return `
                <!-- Filters Bar -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; align-items: end;">
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Store</label>
                                <select class="form-input" onchange="updateInvoiceFilter('store', this.value)">
                                    ${storeOptions}
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Period</label>
                                <select class="form-input" onchange="updateInvoiceFilter('timePeriod', this.value)">
                                    <option value="all">All Time</option>
                                    <option value="thisMonth">This Month</option>
                                    <option value="lastMonth">Last Month</option>
                                    <option value="thisYear">This Year</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Vendor</label>
                                <select class="form-input" onchange="updateInvoiceFilter('vendor', this.value)">
                                    <option value="all">All Vendors</option>
                                    ${vendorOptions}
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Status</label>
                                <select class="form-input" onchange="updateInvoiceFilter('status', this.value)">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="filed">Filed</option>
                                </select>
                            </div>
                            <button class="btn-secondary" onclick="resetInvoiceFilters()" style="height: 40px;">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Invoices Table -->
                <div class="card">
                    <div class="card-body" style="padding: 0; overflow-x: auto;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>File</th>
                                    <th>Invoice #</th>
                                    <th>Vendor</th>
                                    <th>Category</th>
                                    <th>Store</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderInvoicesTable('all')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Recurring Tab Content
        function renderRecurringTab() {
            return renderRecurringProjections();
        }

        // Analytics Tab Content
        function renderAnalyticsTab(filteredInvoices) {
            return `
                <!-- Charts Section -->
                <div class="charts-grid-2col" style="margin-bottom: 24px;">
                    <!-- Status Breakdown (Donut) -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-pie"></i> Payment Status</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="invoice-status-chart" height="250"></canvas>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-tags"></i> By Category</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="invoice-category-chart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <div class="charts-grid-2col" style="margin-bottom: 24px;">
                    <!-- Amount Over Time (Bar) -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-bar"></i> Amount Over Time</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="invoice-time-chart" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Trend Line Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-line"></i> Trend Analysis</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="invoice-trend-chart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Vendors -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Top Vendors by Amount</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="invoice-vendor-chart" height="150"></canvas>
                    </div>
                </div>
            `;
        }

        // Switch main invoice tab
        function switchInvoiceMainTab(tab) {
            invoiceFilters.mainTab = tab;
            renderInvoices();
        }

        // Filter invoices by store (quick filter buttons)
        function filterInvoicesByStore(store) {
            invoiceFilters.store = store;
            renderInvoices();
        }

        function renderInvoicesTable(filter = 'all') {
            // First apply store filter from invoiceFilters
            let baseInvoices = invoices;
            if (invoiceFilters.store && invoiceFilters.store !== 'all') {
                baseInvoices = invoices.filter(i => i.store === invoiceFilters.store);
            }
            // Then apply status filter if specified
            const filteredInvoices = filter === 'all' ? baseInvoices : baseInvoices.filter(i => i.status === filter);

            if (filteredInvoices.length === 0) {
                return `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            No invoices found
                        </td>
                    </tr>
                `;
            }

            return filteredInvoices.map(invoice => {
                const statusStyles = {
                    paid: 'background: var(--success); color: #fff;',
                    pending: 'background: var(--warning); color: #000;',
                    overdue: 'background: var(--danger); color: #fff;',
                    filed: 'background: #6366f1; color: #fff;'
                };

                const invoiceId = invoice.firestoreId || invoice.id;

                return `
                    <tr>
                        <td data-label="">
                            ${invoice.photo ? (invoice.fileType === 'pdf' ? `
                                <div style="width: 50px; height: 50px; background: var(--bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="viewInvoice('${invoiceId}')" title="Click to view PDF">
                                    <i class="fas fa-file-pdf" style="font-size: 24px; color: #ef4444;"></i>
                                </div>
                            ` : `
                                <img src="${invoice.photo}" alt="Invoice" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; cursor: pointer;" onclick="viewInvoice('${invoiceId}')" title="Click to view details">
                            `) : `
                                <div style="width: 50px; height: 50px; background: var(--bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-file-invoice" style="color: var(--text-muted);"></i>
                                </div>
                            `}
                        </td>
                        <td data-label="Invoice #"><strong>${invoice.invoiceNumber}</strong></td>
                        <td data-label="Vendor">${invoice.vendor}</td>
                        <td data-label="Category">
                            ${renderInvoiceCategoryBadges(invoice)}
                        </td>
                        <td data-label="Store">${invoice.store || '-'}</td>
                        <td data-label="Amount" style="font-weight: 600;">$${invoice.amount.toFixed(2)}</td>
                        <td data-label="Due Date">${formatDate(invoice.dueDate)}</td>
                        <td data-label="Status">
                            <span class="badge" style="${statusStyles[invoice.status]}">${invoice.status.toUpperCase()}</span>
                            ${invoice.recurring ? '<i class="fas fa-sync-alt" style="margin-left: 8px; color: var(--text-muted);" title="Recurring"></i>' : ''}
                        </td>
                        <td data-label="">
                            ${invoice.status !== 'paid' ? `<button class="btn-icon" onclick="markInvoicePaid('${invoiceId}')" title="Mark Paid"><i class="fas fa-check"></i></button>` : ''}
                            <button class="btn-icon" onclick="viewInvoice('${invoiceId}')" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="btn-icon" onclick="editInvoice('${invoiceId}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon" onclick="deleteInvoice('${invoiceId}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterInvoices(status) {
            const tbody = document.getElementById('invoicesTableBody');
            if (tbody) {
                tbody.innerHTML = renderInvoicesTable(status);
            }
        }

        async function markInvoicePaid(id) {
            const numericId = !isNaN(id) ? parseInt(id, 10) : id;
            const invoice = invoices.find(i => i.id === id || i.id === numericId || i.firestoreId === id);
            if (invoice) {
                // Update in Firebase
                if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized) {
                    const firestoreId = invoice.firestoreId || id;
                    const success = await firebaseInvoiceManager.markInvoicePaid(firestoreId);
                    if (success) {
                        // Update local state
                        invoice.status = 'paid';
                        invoice.paidDate = new Date().toISOString().split('T')[0];
                        renderInvoices();
                    } else {
                        alert('Error marking invoice as paid');
                    }
                } else {
                    // Fallback to local only
                    invoice.status = 'paid';
                    invoice.paidDate = new Date().toISOString().split('T')[0];
                    renderInvoices();
                }
            }
        }

        function viewInvoice(id) {
            // Convert id to number if it's a numeric string for comparison with numeric IDs
            const numericId = !isNaN(id) ? parseInt(id, 10) : id;
            const invoice = invoices.find(i => i.id === id || i.id === numericId || i.firestoreId === id);

            if (!invoice) {
                console.error('Invoice not found with ID:', id);
                return;
            }

            const invoiceId = invoice.firestoreId || invoice.id;
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Invoice Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                <div>
                                    <h3 style="margin: 0 0 8px;">${invoice.invoiceNumber}</h3>
                                    <div style="display: flex; gap: 8px;">
                                        <span class="badge" style="background: ${invoice.status === 'paid' ? 'var(--success)' : invoice.status === 'pending' ? 'var(--warning)' : 'var(--error)'};">${invoice.status.toUpperCase()}</span>
                                        ${invoice.recurring ? '<span class="badge" style="background: var(--accent-primary);"><i class="fas fa-sync-alt"></i> Recurring</span>' : ''}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">$${invoice.amount.toFixed(2)}</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Vendor</label>
                                    <div>${invoice.vendor}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Categories</label>
                                    <div>${renderInvoiceCategoryBadges(invoice)}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Due Date</label>
                                    <div>${formatDate(invoice.dueDate)}</div>
                                </div>
                                ${invoice.paidDate ? `
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Paid Date</label>
                                        <div style="color: var(--success);">${formatDate(invoice.paidDate)}</div>
                                    </div>
                                ` : ''}
                            </div>

                            ${invoice.description ? `
                                <div style="margin-top: 20px;">
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Description</label>
                                    <div>${invoice.description}</div>
                                </div>
                            ` : ''}

                            ${invoice.notes ? `
                                <div style="margin-top: 20px;">
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Notes</label>
                                    <div style="color: var(--text-secondary);">${invoice.notes}</div>
                                </div>
                            ` : ''}

                            ${invoice.photo ? `
                                <div style="margin-top: 20px;">
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px;">Invoice File</label>
                                    ${invoice.fileType === 'pdf' ? `
                                        <div style="border-radius: 8px; overflow: hidden; background: var(--bg-tertiary);">
                                            <div style="padding: 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                                                <div style="display: flex; align-items: center; gap: 12px;">
                                                    <i class="fas fa-file-pdf" style="font-size: 24px; color: #ef4444;"></i>
                                                    <span style="font-weight: 500;">${invoice.fileName || 'Invoice.pdf'}</span>
                                                </div>
                                                <div style="display: flex; gap: 8px;">
                                                    <button class="btn-secondary" onclick="openPdfInNewTab('${invoice.photo.replace(/'/g, "\\'")}')" style="padding: 6px 12px;">
                                                        <i class="fas fa-external-link-alt"></i> Open in Tab
                                                    </button>
                                                    <button class="btn-primary" onclick="downloadPdf('${invoice.photo.replace(/'/g, "\\'")}', '${(invoice.fileName || 'Invoice.pdf').replace(/'/g, "\\'")}')" style="padding: 6px 12px;">
                                                        <i class="fas fa-download"></i> Download
                                                    </button>
                                                </div>
                                            </div>
                                            <div style="width: 100%; height: 600px; position: relative; background: #525659; border-radius: 0 0 8px 8px; overflow: hidden;">
                                                <iframe
                                                    src="${invoice.photo}#toolbar=0&navpanes=0&scrollbar=0"
                                                    type="application/pdf"
                                                    style="width: 100%; height: 100%; border: none; display: block;"
                                                    frameborder="0"
                                                    allowfullscreen>
                                                </iframe>
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="border-radius: 8px; overflow: hidden; background: var(--bg-tertiary);">
                                            <!-- Zoom Controls -->
                                            <div style="padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <i class="fas fa-image" style="color: var(--text-muted);"></i>
                                                    <span style="font-size: 13px; color: var(--text-secondary);">Invoice Image</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <button class="btn-icon" onclick="zoomInvoiceImage(-0.25)" title="Zoom Out" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-search-minus"></i>
                                                    </button>
                                                    <span id="invoice-zoom-level" style="font-size: 12px; color: var(--text-muted); min-width: 45px; text-align: center;">100%</span>
                                                    <button class="btn-icon" onclick="zoomInvoiceImage(0.25)" title="Zoom In" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-search-plus"></i>
                                                    </button>
                                                    <button class="btn-icon" onclick="resetInvoiceZoom()" title="Reset Zoom" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-compress-arrows-alt"></i>
                                                    </button>
                                                    <button class="btn-icon" onclick="openInvoiceImageFullSize()" title="Open Full Size" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-external-link-alt"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <!-- Image Container with Zoom -->
                                            <div id="invoice-image-container" style="overflow: hidden; max-height: 400px; position: relative;">
                                                <img id="invoice-zoom-image" src="${invoice.photo}" alt="Invoice Photo" style="width: 100%; transform-origin: top left; transition: transform 0.15s ease; cursor: default; user-select: none;" ondragstart="return false;" onmousedown="startImageDrag(event)">
                                            </div>
                                        </div>
                                    `}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${invoice.status !== 'paid' ? `
                        <button class="btn-primary" style="width: 100%;" onclick="markInvoicePaid('${invoiceId}'); closeModal();">
                            <i class="fas fa-check"></i>
                            Mark as Paid
                        </button>
                    ` : ''}
                </div>
            `;

            modal.classList.add('active');

            // Reset zoom level for new invoice
            invoiceZoomLevel = 1;
        }

        async function deleteInvoice(id) {
            showConfirmModal({
                title: 'Delete Invoice',
                message: 'Are you sure you want to delete this invoice? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    const numericId = !isNaN(id) ? parseInt(id, 10) : id;
                    // Delete from Firebase
                    if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized) {
                        const success = await firebaseInvoiceManager.deleteInvoice(id);
                        if (success) {
                            // Update local state
                            invoices = invoices.filter(i => i.id !== id && i.id !== numericId && i.firestoreId !== id);
                            renderInvoices();
                        } else {
                            showNotification('Error deleting invoice', 'error');
                        }
                    } else {
                        // Fallback to local only
                        invoices = invoices.filter(i => i.id !== id && i.id !== numericId && i.firestoreId !== id);
                        renderInvoices();
                    }
                }
            });
        }

        async function saveInvoice() {
            const invoiceNumber = document.getElementById('invoice-number').value.trim();
            const vendor = document.getElementById('invoice-vendor').value.trim();
            const categories = getSelectedInvoiceCategories('invoice-categories-container');
            const category = categories.length > 0 ? categories[0] : ''; // Primary category for backwards compatibility
            const store = document.getElementById('invoice-store').value || null;
            const amount = document.getElementById('invoice-amount').value;
            const description = document.getElementById('invoice-description').value.trim();
            const dueDate = document.getElementById('invoice-due-date').value;
            const status = document.getElementById('invoice-status').value;
            const paymentAccount = document.getElementById('invoice-payment-account').value;
            const recurring = document.getElementById('invoice-recurring').checked;
            const notes = document.getElementById('invoice-notes').value.trim();

            // Validate required fields - only invoice number OR image required
            const fileInput = document.getElementById('invoice-photo');
            const hasFile = fileInput && fileInput.files && fileInput.files[0];
            if (!invoiceNumber && !hasFile) {
                alert('Please enter an Invoice # or upload an image');
                return;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Get file if uploaded - upload to Firebase Storage
                let fileUrl = null;
                let filePath = null;
                let fileType = null;
                let fileName = null;

                if (fileInput && fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];

                    // Validate file size (max 10MB for Storage)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File is too large. Please use a file smaller than 10MB.');
                        if (saveBtn) {
                            saveBtn.innerHTML = originalText;
                            saveBtn.disabled = false;
                        }
                        return;
                    }

                    if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading file...';

                    // Initialize storage if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    // Determine file type
                    const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                    fileType = isPdf ? 'pdf' : 'image';
                    fileName = file.name;

                    // Upload to Firebase Storage
                    const uploadResult = await firebaseStorageHelper.uploadDocument(
                        file,
                        'invoices/attachments',
                        invoiceNumber.replace(/[^a-zA-Z0-9]/g, '_') + '_'
                    );
                    fileUrl = uploadResult.url;
                    filePath = uploadResult.path;
                }

                if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving invoice...';

                await createInvoiceRecord(invoiceNumber, vendor, category, categories, store, amount, description, dueDate, status, paymentAccount, recurring, notes, fileUrl, fileType, fileName, filePath);
            } catch (error) {
                console.error('Error saving invoice:', error);
                alert('Error saving invoice. Please try again.');
            } finally {
                if (saveBtn) {
                    saveBtn.innerHTML = originalText || 'Save Invoice';
                    saveBtn.disabled = false;
                }
            }
        }

        async function createInvoiceRecord(invoiceNumber, vendor, category, categories, store, amount, description, dueDate, status, paymentAccount, recurring, notes, photo, fileType = null, fileName = null, filePath = null) {
            // Create invoice data object
            const invoiceData = {
                invoiceNumber: invoiceNumber || '',
                vendor: vendor || '',
                category: category || '', // Primary category for backwards compatibility
                categories: categories || [], // All selected categories
                store: store || null,
                description: description || '',
                amount: parseFloat(amount) || 0,
                dueDate: dueDate || '',
                paidDate: status === 'paid' ? new Date().toISOString().split('T')[0] : null,
                status: status || 'pending',
                paymentAccount: paymentAccount || '',
                recurring: recurring,
                notes: notes || '',
                photo: photo,           // Now stores URL instead of base64
                filePath: filePath,     // Storage path for deletion
                fileType: fileType,     // 'pdf' or 'image' or null
                fileName: fileName      // Original filename for PDFs
            };

            // Save to Firebase
            if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized) {
                const docId = await firebaseInvoiceManager.addInvoice(invoiceData);
                if (docId) {
                    // Add to local array with Firebase ID
                    invoiceData.id = docId;
                    invoiceData.firestoreId = docId;
                    invoices.unshift(invoiceData);
                    closeModal();
                    renderInvoices();
                } else {
                    alert('Error saving invoice to Firebase');
                }
            } else {
                // Fallback to local only
                const newId = invoices.length > 0 ? Math.max(...invoices.map(i => typeof i.id === 'number' ? i.id : 0)) + 1 : 1;
                invoiceData.id = newId;
                invoices.unshift(invoiceData);
                closeModal();
                renderInvoices();
            }
        }

        function previewInvoiceFile(input) {
            const photoPreview = document.getElementById('invoice-photo-preview');
            const pdfPreview = document.getElementById('invoice-pdf-preview');
            const img = document.getElementById('invoice-photo-img');
            const pdfName = document.getElementById('invoice-pdf-name');
            const pdfSize = document.getElementById('invoice-pdf-size');

            // Hide both previews initially
            if (photoPreview) photoPreview.style.display = 'none';
            if (pdfPreview) pdfPreview.style.display = 'none';

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Check if it's a PDF
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    // Show PDF preview
                    if (pdfPreview && pdfName && pdfSize) {
                        pdfName.textContent = file.name;
                        pdfSize.textContent = formatFileSize(file.size);
                        pdfPreview.style.display = 'block';
                    }
                } else {
                    // Show image preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (img && photoPreview) {
                            img.src = e.target.result;
                            photoPreview.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Keep old function name for backwards compatibility
        function previewInvoicePhoto(input) {
            previewInvoiceFile(input);
        }

        // =====================================================
        // PAYMENT RECORDING SYSTEM
        // =====================================================

        function openRecordPaymentModal(invoiceId) {
            const invoice = invoices.find(i => (i.id === invoiceId || i.firestoreId === invoiceId));
            if (!invoice) {
                alert('Invoice not found');
                return;
            }

            const balance = invoice.amount - (invoice.amountPaid || 0);
            const payments = invoice.payments || [];

            const modal = document.createElement('div');
            modal.className = 'lease-modal-overlay';
            modal.id = 'record-payment-modal';
            modal.innerHTML = `
                <div class="lease-modal" style="max-width: 550px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h3 style="color: white; margin: 0;"><i class="fas fa-dollar-sign"></i> Record Payment</h3>
                        <button class="modal-close" onclick="closeLeaseModal('record-payment-modal')" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Invoice Summary -->
                        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 16px; color: var(--text-primary);">${invoice.vendor}</div>
                                    <div style="font-size: 13px; color: var(--text-muted);">Invoice #${invoice.invoiceNumber || 'N/A'}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Amount</div>
                                    <div style="font-size: 18px; font-weight: 700; color: var(--text-primary);">$${invoice.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-muted);">Paid</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #10b981;">$${(invoice.amountPaid || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-muted);">Balance</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #ef4444;">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-muted);">Payments</div>
                                    <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${payments.length}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Form -->
                        <div class="form-group">
                            <label class="form-label">Payment Amount *</label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">$</span>
                                <input type="number" class="form-input" id="payment-amount" placeholder="0.00" step="0.01" max="${balance}" style="padding-left: 28px;" value="${balance.toFixed(2)}">
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button type="button" class="btn-secondary" style="flex: 1; font-size: 12px;" onclick="document.getElementById('payment-amount').value = '${balance.toFixed(2)}'">
                                    Pay Full Balance
                                </button>
                                <button type="button" class="btn-secondary" style="flex: 1; font-size: 12px;" onclick="document.getElementById('payment-amount').value = '${(balance / 2).toFixed(2)}'">
                                    Pay 50%
                                </button>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">Payment Date *</label>
                                <input type="date" class="form-input" id="payment-date" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select class="form-input" id="payment-method">
                                    <option value="check">Check</option>
                                    <option value="cash">Cash</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="transfer">Bank Transfer</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Reference # (Check #, Confirmation, etc.)</label>
                            <input type="text" class="form-input" id="payment-reference" placeholder="Optional reference number">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="payment-notes" rows="2" placeholder="Optional payment notes..."></textarea>
                        </div>

                        <!-- Payment History -->
                        ${payments.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">
                                    <i class="fas fa-history"></i> Payment History
                                </div>
                                <div style="background: var(--bg-secondary); border-radius: 8px; overflow: hidden;">
                                    ${payments.map((p, idx) => `
                                        <div style="padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; ${idx < payments.length - 1 ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                                            <div>
                                                <div style="font-weight: 500; color: var(--text-primary);">$${p.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">${p.method || 'N/A'} ${p.reference ? '‚Ä¢ ' + p.reference : ''}</div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">${new Date(p.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeLeaseModal('record-payment-modal')">Cancel</button>
                        <button class="btn-primary" onclick="saveInvoicePayment('${invoiceId}')" style="background: #10b981;">
                            <i class="fas fa-check"></i> Record Payment
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('active'), 10);
        }

        async function saveInvoicePayment(invoiceId) {
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            const method = document.getElementById('payment-method').value;
            const reference = document.getElementById('payment-reference').value.trim();
            const notes = document.getElementById('payment-notes').value.trim();

            if (!amount || amount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }

            if (!date) {
                alert('Please select a payment date');
                return;
            }

            const invoice = invoices.find(i => (i.id === invoiceId || i.firestoreId === invoiceId));
            if (!invoice) {
                alert('Invoice not found');
                return;
            }

            const balance = invoice.amount - (invoice.amountPaid || 0);
            if (amount > balance + 0.01) {
                alert(`Payment amount ($${amount.toFixed(2)}) exceeds balance ($${balance.toFixed(2)})`);
                return;
            }

            // Create payment record
            const payment = {
                amount: amount,
                date: date,
                method: method,
                reference: reference,
                notes: notes,
                recordedAt: new Date().toISOString(),
                recordedBy: typeof getCurrentUser === 'function' ? (getCurrentUser()?.name || 'Unknown') : 'Unknown'
            };

            // Update invoice
            const payments = invoice.payments || [];
            payments.push(payment);

            const newAmountPaid = (invoice.amountPaid || 0) + amount;
            const newStatus = newAmountPaid >= invoice.amount ? 'paid' : 'partial';

            try {
                // Update in Firebase
                if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized && invoice.firestoreId) {
                    const db = firebase.firestore();
                    await db.collection('invoices').doc(invoice.firestoreId).update({
                        payments: payments,
                        amountPaid: newAmountPaid,
                        status: newStatus,
                        paidDate: newStatus === 'paid' ? date : null
                    });
                }

                // Update local
                invoice.payments = payments;
                invoice.amountPaid = newAmountPaid;
                invoice.status = newStatus;
                if (newStatus === 'paid') {
                    invoice.paidDate = date;
                }

                closeLeaseModal('record-payment-modal');
                showToast(`Payment of $${amount.toFixed(2)} recorded successfully!`, 'success');
                renderInvoices();
            } catch (error) {
                console.error('Error saving payment:', error);
                alert('Error recording payment. Please try again.');
            }
        }

        function viewPaymentHistory(invoiceId) {
            const invoice = invoices.find(i => (i.id === invoiceId || i.firestoreId === invoiceId));
            if (!invoice) return;

            const payments = invoice.payments || [];
            const balance = invoice.amount - (invoice.amountPaid || 0);

            const modal = document.createElement('div');
            modal.className = 'lease-modal-overlay';
            modal.id = 'payment-history-modal';
            modal.innerHTML = `
                <div class="lease-modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-history"></i> Payment History</h3>
                        <button class="modal-close" onclick="closeLeaseModal('payment-history-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">${invoice.vendor} - #${invoice.invoiceNumber || 'N/A'}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Total</div>
                                    <div style="font-weight: 600;">$${invoice.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Paid</div>
                                    <div style="font-weight: 600; color: #10b981;">$${(invoice.amountPaid || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--text-muted);">Balance</div>
                                    <div style="font-weight: 600; color: ${balance > 0 ? '#ef4444' : '#10b981'};">$${balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                </div>
                            </div>
                        </div>

                        ${payments.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-receipt" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <div>No payments recorded yet</div>
                            </div>
                        ` : `
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${payments.map((p, idx) => `
                                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 14px; margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div>
                                                <div style="font-size: 18px; font-weight: 700; color: #10b981;">$${p.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                                    <i class="fas fa-${p.method === 'check' ? 'money-check' : p.method === 'cash' ? 'money-bill' : p.method === 'card' ? 'credit-card' : 'university'}"></i>
                                                    ${p.method || 'Unknown'} ${p.reference ? '‚Ä¢ Ref: ' + p.reference : ''}
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 13px; color: var(--text-secondary);">${new Date(p.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">${p.recordedBy || ''}</div>
                                            </div>
                                        </div>
                                        ${p.notes ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">${p.notes}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeLeaseModal('payment-history-modal')">Close</button>
                        ${balance > 0 ? `
                            <button class="btn-primary" onclick="closeLeaseModal('payment-history-modal'); openRecordPaymentModal('${invoiceId}');" style="background: #10b981;">
                                <i class="fas fa-plus"></i> Add Payment
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('active'), 10);
        }

        // Handle camera capture for invoice
        function handleInvoiceCameraCapture(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const preview = document.getElementById('invoice-preview');
                const pdfPreview = document.getElementById('invoice-pdf-preview');

                // Show image preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">`;
                    if (pdfPreview) pdfPreview.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // OpenAI API for Invoice Image Analysis
        async function scanInvoiceWithAI() {
            // Check both file input and camera input
            const fileInput = document.getElementById('invoice-photo');
            const cameraInput = document.getElementById('invoice-camera');

            let file = null;
            if (fileInput && fileInput.files && fileInput.files[0]) {
                file = fileInput.files[0];
            } else if (cameraInput && cameraInput.files && cameraInput.files[0]) {
                file = cameraInput.files[0];
            }

            if (!file) {
                alert('Please upload an invoice image or take a photo first.');
                return;
            }
            const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

            if (isPdf) {
                alert('PDF scanning is not supported yet. Please upload an image file (JPG, PNG, etc.).');
                return;
            }

            // Show loading state
            const scanBtn = document.getElementById('ai-scan-btn');
            const originalText = scanBtn ? scanBtn.innerHTML : '';
            if (scanBtn) {
                scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
                scanBtn.disabled = true;
            }

            try {
                // Convert image to base64
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Get API key from settings
                const apiKey = getOpenAIKey();
                if (!apiKey) {
                    alert('Please configure your OpenAI API key in Project Analytics > Settings (key icon)');
                    return;
                }

                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: base64Image
                                        }
                                    },
                                    {
                                        type: 'text',
                                        text: `Analyze this invoice/bill image and extract the following information. Return ONLY a JSON object with these fields (use null for any field you cannot find):

{
    "invoiceNumber": "the invoice number, receipt number, or bill number",
    "total": "the total amount as a number (no currency symbols)",
    "date": "the date in YYYY-MM-DD format",
    "vendor": "the vendor, company, or seller name",
    "category": "one of: utilities, rent, supplies, inventory, services, equipment, other",
    "status": "paid or pending (based on whether it shows as paid/completed)",
    "description": "a brief description of what this invoice is for"
}

Return ONLY the JSON object, no additional text.`
                                    }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                // Parse the JSON response
                let invoiceData;
                try {
                    // Try to extract JSON from the response (in case there's extra text)
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        invoiceData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    throw new Error('Could not parse invoice data from AI response');
                }

                // Fill in the form fields
                if (invoiceData.invoiceNumber) {
                    document.getElementById('invoice-number').value = invoiceData.invoiceNumber;
                }
                if (invoiceData.vendor) {
                    document.getElementById('invoice-vendor').value = invoiceData.vendor;
                }
                if (invoiceData.category) {
                    const categorySelect = document.getElementById('invoice-category');
                    const categoryValue = invoiceData.category.toLowerCase();
                    // Find matching option
                    for (let option of categorySelect.options) {
                        if (option.value.toLowerCase() === categoryValue) {
                            categorySelect.value = option.value;
                            break;
                        }
                    }
                }
                if (invoiceData.total) {
                    const amount = parseFloat(invoiceData.total.toString().replace(/[^0-9.]/g, ''));
                    if (!isNaN(amount)) {
                        document.getElementById('invoice-amount').value = amount.toFixed(2);
                    }
                }
                if (invoiceData.date) {
                    document.getElementById('invoice-due-date').value = invoiceData.date;
                }
                if (invoiceData.status) {
                    const statusSelect = document.getElementById('invoice-status');
                    const statusValue = invoiceData.status.toLowerCase();
                    if (statusValue === 'paid') {
                        statusSelect.value = 'paid';
                    } else {
                        statusSelect.value = 'pending';
                    }
                }
                if (invoiceData.description) {
                    document.getElementById('invoice-description').value = invoiceData.description;
                }

                // Show success message
                alert('Invoice scanned successfully! Please review and adjust the extracted information as needed.');

            } catch (error) {
                console.error('Error scanning invoice:', error);
                alert('Error scanning invoice: ' + error.message);
            } finally {
                if (scanBtn) {
                    scanBtn.innerHTML = originalText || '<i class="fas fa-magic"></i> Scan with AI';
                    scanBtn.disabled = false;
                }
            }
        }

        // Open PDF in a new browser tab
        function openPdfInNewTab(base64Data) {
            // Create a blob from the base64 data
            try {
                const byteCharacters = atob(base64Data.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                const blobUrl = URL.createObjectURL(blob);
                window.open(blobUrl, '_blank');
            } catch (error) {
                console.error('Error opening PDF:', error);
                // Fallback to direct base64 URL
                window.open(base64Data, '_blank');
            }
        }

        // Download PDF file
        function downloadPdf(base64Data, fileName) {
            try {
                const byteCharacters = atob(base64Data.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });

                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName || 'invoice.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF. Please try the "Open in Tab" option instead.');
            }
        }

        // Invoice Image Zoom Controls
        let invoiceZoomLevel = 1;
        let isImageDragging = false;
        let imageDragStartX = 0;
        let imageDragStartY = 0;
        let imageTranslateX = 0;
        let imageTranslateY = 0;
        let imageStartTranslateX = 0;
        let imageStartTranslateY = 0;

        function zoomInvoiceImage(delta) {
            const img = document.getElementById('invoice-zoom-image');
            const zoomDisplay = document.getElementById('invoice-zoom-level');

            if (!img) return;

            // Calculate new zoom level (min 0.5, max 4)
            const newZoom = Math.max(0.5, Math.min(4, invoiceZoomLevel + delta));

            // If zooming out to 1 or less, reset position
            if (newZoom <= 1) {
                imageTranslateX = 0;
                imageTranslateY = 0;
            }

            invoiceZoomLevel = newZoom;

            // Apply zoom with transform
            img.style.transform = `scale(${invoiceZoomLevel}) translate(${imageTranslateX}px, ${imageTranslateY}px)`;

            // Update display
            if (zoomDisplay) {
                zoomDisplay.textContent = `${Math.round(invoiceZoomLevel * 100)}%`;
            }

            // Update cursor based on zoom level
            img.style.cursor = invoiceZoomLevel > 1 ? 'grab' : 'default';
        }

        function resetInvoiceZoom() {
            const img = document.getElementById('invoice-zoom-image');
            const zoomDisplay = document.getElementById('invoice-zoom-level');

            if (!img) return;

            invoiceZoomLevel = 1;
            imageTranslateX = 0;
            imageTranslateY = 0;
            img.style.transform = 'scale(1) translate(0px, 0px)';
            img.style.cursor = 'default';

            if (zoomDisplay) {
                zoomDisplay.textContent = '100%';
            }
        }

        function startImageDrag(event) {
            const img = document.getElementById('invoice-zoom-image');
            if (!img || invoiceZoomLevel <= 1) return;

            isImageDragging = true;
            img.style.cursor = 'grabbing';
            img.style.transition = 'none'; // Disable transition during drag for smooth movement
            imageDragStartX = event.clientX;
            imageDragStartY = event.clientY;
            imageStartTranslateX = imageTranslateX;
            imageStartTranslateY = imageTranslateY;
            event.preventDefault();

            // Add document-level listeners so dragging continues even outside the image
            document.addEventListener('mousemove', dragImage);
            document.addEventListener('mouseup', stopImageDrag);
        }

        function dragImage(event) {
            if (!isImageDragging) return;

            const img = document.getElementById('invoice-zoom-image');
            if (!img) return;

            // Calculate delta and apply to translate (divide by zoom to keep movement proportional)
            const deltaX = (event.clientX - imageDragStartX) / invoiceZoomLevel;
            const deltaY = (event.clientY - imageDragStartY) / invoiceZoomLevel;

            imageTranslateX = imageStartTranslateX + deltaX;
            imageTranslateY = imageStartTranslateY + deltaY;

            img.style.transform = `scale(${invoiceZoomLevel}) translate(${imageTranslateX}px, ${imageTranslateY}px)`;
        }

        function stopImageDrag() {
            const img = document.getElementById('invoice-zoom-image');
            if (img) {
                img.style.cursor = invoiceZoomLevel > 1 ? 'grab' : 'default';
                img.style.transition = 'transform 0.15s ease'; // Re-enable smooth transition
            }
            isImageDragging = false;

            // Remove document-level listeners
            document.removeEventListener('mousemove', dragImage);
            document.removeEventListener('mouseup', stopImageDrag);
        }

        function openInvoiceImageFullSize() {
            const img = document.getElementById('invoice-zoom-image');
            if (!img || !img.src) return;

            const base64Data = img.src;

            // Check if it's a base64 image
            if (base64Data.startsWith('data:image')) {
                // Convert base64 to blob and open in new tab
                try {
                    const parts = base64Data.split(',');
                    const mimeMatch = parts[0].match(/:(.*?);/);
                    const mimeType = mimeMatch ? mimeMatch[1] : 'image/png';
                    const byteString = atob(parts[1]);
                    const byteNumbers = new Array(byteString.length);

                    for (let i = 0; i < byteString.length; i++) {
                        byteNumbers[i] = byteString.charCodeAt(i);
                    }

                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: mimeType });
                    const blobUrl = URL.createObjectURL(blob);

                    // Open in new tab
                    const newTab = window.open(blobUrl, '_blank');

                    // Clean up blob URL after a delay
                    if (newTab) {
                        setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                    }
                } catch (error) {
                    console.error('Error opening image:', error);
                    // Fallback: try opening directly
                    window.open(base64Data, '_blank');
                }
            } else {
                // It's a regular URL, just open it
                window.open(base64Data, '_blank');
            }
        }

        function editInvoice(id) {
            const numericId = !isNaN(id) ? parseInt(id, 10) : id;
            const invoice = invoices.find(i => i.id === id || i.id === numericId || i.firestoreId === id);
            if (!invoice) return;

            const invoiceId = invoice.firestoreId || invoice.id;
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Edit Invoice</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <form id="edit-invoice-form" onsubmit="event.preventDefault(); saveInvoiceChanges('${invoiceId}');">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Invoice Number *</label>
                                <input type="text" class="form-input" id="edit-invoice-number" value="${invoice.invoiceNumber || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vendor *</label>
                                <input type="text" class="form-input" id="edit-invoice-vendor" value="${invoice.vendor || ''}" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categories <span style="font-weight: 400; color: var(--text-muted); font-size: 12px;">(select one or more)</span></label>
                            ${renderInvoiceCategoryCheckboxes(invoice.categories || (invoice.category ? [invoice.category] : []), 'edit-invoice-categories-container')}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Store</label>
                            <select class="form-input" id="edit-invoice-store">
                                <option value="" ${!invoice.store ? 'selected' : ''}>Unassigned</option>
                                <option value="Miramar" ${invoice.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                <option value="Morena" ${invoice.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                <option value="Kearny Mesa" ${invoice.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                <option value="Chula Vista" ${invoice.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                <option value="North Park" ${invoice.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                <option value="Miramar Wine & Liquor" ${invoice.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Amount *</label>
                                <input type="number" step="0.01" class="form-input" id="edit-invoice-amount" value="${invoice.amount || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-input" id="edit-invoice-due-date" value="${invoice.dueDate || ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="edit-invoice-description" value="${invoice.description || ''}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-input" id="edit-invoice-status">
                                    <option value="pending" ${invoice.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="overdue" ${invoice.status === 'overdue' ? 'selected' : ''}>Overdue</option>
                                    <option value="paid" ${invoice.status === 'paid' ? 'selected' : ''}>Paid</option>
                                    <option value="filed" ${invoice.status === 'filed' ? 'selected' : ''}>Filed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Account</label>
                                <select class="form-input" id="edit-invoice-payment-account">
                                    <option value="" ${!invoice.paymentAccount ? 'selected' : ''}>Select account...</option>
                                    <option value="Shop App" ${invoice.paymentAccount === 'Shop App' ? 'selected' : ''}>Shop App</option>
                                    <option value="Personal Account" ${invoice.paymentAccount === 'Personal Account' ? 'selected' : ''}>Personal Account</option>
                                    <option value="Business Account" ${invoice.paymentAccount === 'Business Account' ? 'selected' : ''}>Business Account</option>
                                    <option value="PayPal" ${invoice.paymentAccount === 'PayPal' ? 'selected' : ''}>PayPal</option>
                                    <option value="Credit Card" ${invoice.paymentAccount === 'Credit Card' ? 'selected' : ''}>Credit Card</option>
                                    <option value="Cash" ${invoice.paymentAccount === 'Cash' ? 'selected' : ''}>Cash</option>
                                    <option value="Other" ${invoice.paymentAccount === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="edit-invoice-recurring" ${invoice.recurring ? 'checked' : ''} style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                Recurring Invoice
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="edit-invoice-notes" rows="3">${invoice.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Invoice File (Photo or PDF)</label>
                            ${invoice.photo ? `
                                <div id="edit-invoice-current-file" style="margin-bottom: 10px;">
                                    ${invoice.fileType === 'pdf' ? `
                                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                            <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444;"></i>
                                            <div>
                                                <div style="font-weight: 500;">${invoice.fileName || 'Invoice.pdf'}</div>
                                                <p style="font-size: 12px; color: var(--text-muted); margin: 4px 0 0 0;">Current PDF (upload new to replace)</p>
                                            </div>
                                        </div>
                                    ` : `
                                        <img src="${invoice.photo}" alt="Current Invoice Photo" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: contain;">
                                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Current photo (upload new to replace)</p>
                                    `}
                                </div>
                            ` : ''}
                            <input type="file" class="form-input" id="edit-invoice-photo" accept="image/*,.pdf,application/pdf" onchange="previewEditInvoiceFile(this)">
                            <div id="edit-invoice-photo-preview" style="margin-top: 10px; display: none;">
                                <img id="edit-invoice-photo-img" src="" alt="New Photo Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: contain;">
                                <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">New photo preview</p>
                            </div>
                            <div id="edit-invoice-pdf-preview" style="margin-top: 10px; display: none;">
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444;"></i>
                                    <div>
                                        <div id="edit-invoice-pdf-name" style="font-weight: 500;"></div>
                                        <div id="edit-invoice-pdf-size" style="font-size: 12px; color: var(--text-muted);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions" style="margin-top: 24px;">
                            <button type="button" class="btn-secondary" onclick="closeModal()">Close</button>
                            <button type="button" class="btn-primary" onclick="saveInvoiceChanges('${invoiceId}')">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            `;

            modal.classList.add('active');
        }

        function previewEditInvoiceFile(input) {
            const photoPreview = document.getElementById('edit-invoice-photo-preview');
            const pdfPreview = document.getElementById('edit-invoice-pdf-preview');
            const img = document.getElementById('edit-invoice-photo-img');
            const pdfName = document.getElementById('edit-invoice-pdf-name');
            const pdfSize = document.getElementById('edit-invoice-pdf-size');

            // Hide both previews initially
            if (photoPreview) photoPreview.style.display = 'none';
            if (pdfPreview) pdfPreview.style.display = 'none';

            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Check if it's a PDF
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    // Show PDF preview
                    if (pdfPreview && pdfName && pdfSize) {
                        pdfName.textContent = file.name;
                        pdfSize.textContent = formatFileSize(file.size);
                        pdfPreview.style.display = 'block';
                    }
                } else {
                    // Show image preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (img && photoPreview) {
                            img.src = e.target.result;
                            photoPreview.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Keep old function name for backwards compatibility
        function previewEditInvoicePhoto(input) {
            previewEditInvoiceFile(input);
        }

        async function saveInvoiceChanges(invoiceId) {
            const invoiceNumber = document.getElementById('edit-invoice-number').value.trim();
            const vendor = document.getElementById('edit-invoice-vendor').value.trim();
            const categories = getSelectedInvoiceCategories('edit-invoice-categories-container');
            const category = categories.length > 0 ? categories[0] : ''; // Primary category for backwards compatibility
            const store = document.getElementById('edit-invoice-store').value || null;
            const amount = document.getElementById('edit-invoice-amount').value;
            const description = document.getElementById('edit-invoice-description').value.trim();
            const dueDate = document.getElementById('edit-invoice-due-date').value;
            const status = document.getElementById('edit-invoice-status').value;
            const paymentAccount = document.getElementById('edit-invoice-payment-account').value;
            const recurring = document.getElementById('edit-invoice-recurring').checked;
            const notes = document.getElementById('edit-invoice-notes').value.trim();

            // Validate required fields
            if (!invoiceNumber || !vendor || !amount) {
                showNotification('Please fill in all required fields (Invoice #, Vendor, Amount)', 'error');
                return;
            }

            // Find the invoice to get current file data
            const numericId = !isNaN(invoiceId) ? parseInt(invoiceId, 10) : invoiceId;
            const invoice = invoices.find(i => i.id === invoiceId || i.id === numericId || i.firestoreId === invoiceId);

            // Get new file if uploaded (Base64 encoding for both images and PDFs)
            const fileInput = document.getElementById('edit-invoice-photo');
            let fileData = invoice ? invoice.photo : null; // Keep existing file by default
            let fileType = invoice ? invoice.fileType : null;
            let fileName = invoice ? invoice.fileName : null;

            if (fileInput && fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];

                // Determine file type
                const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                fileType = isPdf ? 'pdf' : 'image';
                fileName = file.name;

                // Convert to Base64
                fileData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsDataURL(file);
                });
            }

            // Create update data object
            const updateData = {
                invoiceNumber: invoiceNumber || '',
                vendor: vendor || '',
                category: category || '', // Primary category for backwards compatibility
                categories: categories || [], // All selected categories
                store: store || null,
                description: description || '',
                amount: parseFloat(amount) || 0,
                dueDate: dueDate || '',
                paidDate: status === 'paid' ? (invoice && invoice.paidDate ? invoice.paidDate : new Date().toISOString().split('T')[0]) : null,
                status: status || 'pending',
                paymentAccount: paymentAccount || '',
                recurring: recurring,
                notes: notes || '',
                photo: fileData,
                fileType: fileType,
                fileName: fileName
            };

            try {
                // Update in Firebase
                if (typeof firebaseInvoiceManager !== 'undefined' && firebaseInvoiceManager.isInitialized) {
                    const success = await firebaseInvoiceManager.updateInvoice(invoiceId, updateData);
                    if (success) {
                        // Update local state
                        const idx = invoices.findIndex(i => i.id === invoiceId || i.firestoreId === invoiceId);
                        if (idx !== -1) {
                            invoices[idx] = { ...invoices[idx], ...updateData };
                        }
                        closeModal();
                        renderInvoices();
                        showNotification('Invoice updated successfully', 'success');
                    } else {
                        showNotification('Error updating invoice', 'error');
                    }
                } else {
                    // Fallback to local only
                    const idx = invoices.findIndex(i => i.id === invoiceId || i.firestoreId === invoiceId);
                    if (idx !== -1) {
                        invoices[idx] = { ...invoices[idx], ...updateData };
                    }
                    closeModal();
                    renderInvoices();
                    showNotification('Invoice updated locally', 'success');
                }
            } catch (error) {
                console.error('Error saving invoice changes:', error);
                showNotification('Error saving invoice changes', 'error');
            }
        }

        // Export Invoices to Excel (CSV)
        function exportInvoicesToExcel() {
            const filteredInvoices = getFilteredInvoices();
            if (filteredInvoices.length === 0) {
                alert('No invoices to export');
                return;
            }

            // Create CSV content
            const headers = ['Invoice #', 'Vendor', 'Category', 'Store', 'Amount', 'Amount Paid', 'Balance', 'Status', 'Due Date', 'Paid Date', 'Notes'];
            const rows = filteredInvoices.map(inv => [
                inv.invoiceNumber || '-',
                inv.vendor || '-',
                inv.category || '-',
                inv.store || '-',
                inv.amount?.toFixed(2) || '0.00',
                (inv.amountPaid || 0).toFixed(2),
                (inv.amount - (inv.amountPaid || 0)).toFixed(2),
                inv.status || '-',
                inv.dueDate || '-',
                inv.paidDate || '-',
                (inv.notes || '').replace(/,/g, ';').replace(/\n/g, ' ')
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            // Add summary
            const totalAmount = filteredInvoices.reduce((sum, i) => sum + i.amount, 0);
            const totalPaid = filteredInvoices.reduce((sum, i) => sum + (i.amountPaid || 0), 0);
            csv += '\n"TOTAL","","","","' + totalAmount.toFixed(2) + '","' + totalPaid.toFixed(2) + '","' + (totalAmount - totalPaid).toFixed(2) + '","","","",""';

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const date = new Date().toISOString().split('T')[0];
            link.download = `invoices_${invoiceFilters.store || 'all'}_${date}.csv`;
            link.click();
        }

        // Export Invoices to PDF
        function exportInvoicesToPDF() {
            const filteredInvoices = getFilteredInvoices();
            if (filteredInvoices.length === 0) {
                alert('No invoices to export');
                return;
            }

            // Calculate totals
            const totalAmount = filteredInvoices.reduce((sum, i) => sum + i.amount, 0);
            const totalPaid = filteredInvoices.reduce((sum, i) => sum + (i.amountPaid || 0), 0);
            const totalPending = totalAmount - totalPaid;

            // Create printable HTML
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoices Report</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; color: #1f2937; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #6366f1; padding-bottom: 20px; }
                        .header h1 { font-size: 28px; color: #1f2937; margin-bottom: 8px; }
                        .header p { color: #6b7280; font-size: 14px; }
                        .summary { display: flex; justify-content: space-around; margin-bottom: 30px; background: #f3f4f6; padding: 20px; border-radius: 8px; }
                        .summary-item { text-align: center; }
                        .summary-item .label { font-size: 12px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px; }
                        .summary-item .value { font-size: 24px; font-weight: bold; }
                        .summary-item .value.green { color: #10b981; }
                        .summary-item .value.red { color: #ef4444; }
                        .summary-item .value.blue { color: #6366f1; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th { background: #6366f1; color: white; padding: 12px 8px; text-align: left; font-weight: 600; }
                        td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; }
                        tr:nth-child(even) { background: #f9fafb; }
                        .status { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
                        .status.paid { background: #d1fae5; color: #065f46; }
                        .status.pending { background: #fef3c7; color: #92400e; }
                        .status.overdue { background: #fee2e2; color: #991b1b; }
                        .status.partial { background: #dbeafe; color: #1e40af; }
                        .footer { margin-top: 30px; text-align: center; color: #9ca3af; font-size: 11px; }
                        .amount { text-align: right; font-family: monospace; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Invoices Report</h1>
                        <p>${invoiceFilters.store && invoiceFilters.store !== 'all' ? invoiceFilters.store + ' - ' : ''}Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>

                    <div class="summary">
                        <div class="summary-item">
                            <div class="label">Total Invoices</div>
                            <div class="value blue">${filteredInvoices.length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Total Amount</div>
                            <div class="value">$${totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Total Paid</div>
                            <div class="value green">$${totalPaid.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Balance Due</div>
                            <div class="value red">$${totalPending.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Vendor</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th style="text-align: right;">Amount</th>
                                <th style="text-align: right;">Paid</th>
                                <th style="text-align: right;">Balance</th>
                                <th>Status</th>
                                <th>Due Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredInvoices.map(inv => `
                                <tr>
                                    <td>${inv.invoiceNumber || '-'}</td>
                                    <td>${inv.vendor || '-'}</td>
                                    <td>${inv.category || '-'}</td>
                                    <td>${inv.store || '-'}</td>
                                    <td class="amount">$${inv.amount?.toLocaleString('en-US', { minimumFractionDigits: 2 }) || '0.00'}</td>
                                    <td class="amount">$${(inv.amountPaid || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                                    <td class="amount">$${(inv.amount - (inv.amountPaid || 0)).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                                    <td><span class="status ${inv.status}">${inv.status}</span></td>
                                    <td>${inv.dueDate || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="footer">
                        <p>Ascendance - Invoice Management System</p>
                    </div>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.print();
            };
        }

        // Load invoices from Firebase
        async function loadInvoicesFromFirebase() {
            try {
                if (typeof firebaseInvoiceManager === 'undefined') {
                    console.log('Firebase Invoice Manager not available');
                    return;
                }

                if (!firebaseInvoiceManager.isInitialized) {
                    await firebaseInvoiceManager.initialize();
                }

                const firebaseInvoices = await firebaseInvoiceManager.loadInvoices();

                if (firebaseInvoices.length > 0) {
                    // Replace local invoices with Firebase data
                    invoices = firebaseInvoices;
                }
            } catch (error) {
                console.error('Error loading invoices from Firebase:', error);
            }
        }

        // Treasury Functions
        async function loadTreasuryItemsFromFirebase() {
            try {
                console.log('üîÑ Loading treasury from Firebase...');
                if (typeof firebase === 'undefined' || !firebase.firestore) {
                    console.warn('‚ö†Ô∏è Firebase not available for treasury');
                    return false;
                }

                const db = firebase.firestore();
                const treasuryCollection = window.FIREBASE_COLLECTIONS?.treasury || 'treasury';
                
                const snapshot = await db.collection(treasuryCollection).get();
                const items = [];
                
                snapshot.forEach(doc => {
                    items.push({
                        id: items.length > 0 ? Math.max(...items.map(i => i.id || 0)) + 1 : 1,
                        firestoreId: doc.id,
                        ...doc.data()
                    });
                });

                treasuryItems = items;
                return true;
            } catch (error) {
                console.error('‚ùå Error loading treasury items from Firebase:', error);
                return false;
            }
        }

        function renderTreasury() {
            console.log('üöÄ renderTreasury called');
            // Load from Firebase first
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                loadTreasuryItemsFromFirebase().then(() => {
                    console.log('üìä Firebase load complete, rendering content');
                    renderTreasuryContent();
                }).catch(error => {
                    console.error('‚ùå Error in renderTreasury:', error);
                    renderTreasuryContent(); // Still render even if Firebase fails
                });
            } else {
                console.warn('‚ö†Ô∏è Firebase not initialized, rendering with local data');
                // If Firebase not available, just render with existing data
                renderTreasuryContent();
            }
        }

        let treasuryViewMode = 'grid'; // 'grid' or 'list'
        let treasuryFilterLocation = 'all';
        let treasuryFilterArtist = 'all';

        function renderTreasuryContent() {
            console.log('üìù renderTreasuryContent called with', treasuryItems.length, 'items');
            const dashboard = document.querySelector('.dashboard');

            if (!dashboard) {
                console.error('‚ùå Dashboard element not found!');
                return;
            }

            const totalValue = treasuryItems.reduce((sum, item) => sum + (parseFloat(item.value) || 0), 0);
            const itemsByLocation = {
                'VSU Kearny Mesa': treasuryItems.filter(i => i.location === 'VSU Kearny Mesa').length,
                'VSU Miramar': treasuryItems.filter(i => i.location === 'VSU Miramar').length,
                'VSU Morena': treasuryItems.filter(i => i.location === 'VSU Morena').length,
                'VSU North Park': treasuryItems.filter(i => i.location === 'VSU North Park').length,
                'VSU Chula Vista': treasuryItems.filter(i => i.location === 'VSU Chula Vista').length
            };

            // Get unique artists
            const artists = [...new Set(treasuryItems.map(i => i.artist).filter(a => a && a.trim()))].sort();

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Heady Pieces - Select Collection</h2>
                        <p class="section-subtitle">Manage your valuable collection</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-treasury')">
                        <i class="fas fa-plus"></i>
                        Add Piece
                    </button>
                </div>

                <div class="treasury-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--accent-primary) 0%, #818cf8 100%); text-align: center; padding: 28px 20px;">
                        <div class="stat-icon" style="margin: 0 auto 12px; background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px;"><i class="fas fa-vault"></i></div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9);">Total Value</div>
                            <div class="stat-value" style="color: white; font-size: 24px;">$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); text-align: center; padding: 28px 20px;">
                        <div class="stat-icon" style="margin: 0 auto 12px; background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px;"><i class="fas fa-gem"></i></div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9);">Total Pieces</div>
                            <div class="stat-value" style="color: white; font-size: 24px;">${treasuryItems.length}</div>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); text-align: center; padding: 28px 20px;">
                        <div class="stat-icon" style="margin: 0 auto 12px; background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px;"><i class="fas fa-palette"></i></div>
                        <div class="stat-content">
                            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9);">Artists</div>
                            <div class="stat-value" style="color: white; font-size: 24px;">${artists.length}</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <h3 class="card-title">
                            <i class="fas fa-images"></i>
                            Collection Inventory
                        </h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                            <!-- View Toggle -->
                            <div style="display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                <button onclick="switchTreasuryView('grid')" id="treasury-grid-btn" style="padding: 8px 14px; border: none; background: ${treasuryViewMode === 'grid' ? 'var(--accent-primary)' : 'var(--bg-secondary)'}; color: ${treasuryViewMode === 'grid' ? 'white' : 'var(--text-primary)'}; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-th-large"></i>
                                </button>
                                <button onclick="switchTreasuryView('list')" id="treasury-list-btn" style="padding: 8px 14px; border: none; background: ${treasuryViewMode === 'list' ? 'var(--accent-primary)' : 'var(--bg-secondary)'}; color: ${treasuryViewMode === 'list' ? 'white' : 'var(--text-primary)'}; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                            <!-- Artist Filter -->
                            <select class="form-input" style="width: 180px;" onchange="filterTreasuryByArtist(this.value)" id="treasury-artist-filter">
                                <option value="all">All Artists</option>
                                ${artists.map(a => `<option value="${a}" ${treasuryFilterArtist === a ? 'selected' : ''}>${a}</option>`).join('')}
                            </select>
                            <!-- Location Filter -->
                            <select class="form-input" style="width: 180px;" onchange="filterTreasuryByLocation(this.value)" id="treasury-location-filter">
                                <option value="all">All Locations</option>
                                <option value="VSU Miramar" ${treasuryFilterLocation === 'VSU Miramar' ? 'selected' : ''}>VSU Miramar (${itemsByLocation['VSU Miramar']})</option>
                                <option value="VSU Morena" ${treasuryFilterLocation === 'VSU Morena' ? 'selected' : ''}>VSU Morena (${itemsByLocation['VSU Morena']})</option>
                                <option value="VSU Kearny Mesa" ${treasuryFilterLocation === 'VSU Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa (${itemsByLocation['VSU Kearny Mesa']})</option>
                                <option value="VSU Chula Vista" ${treasuryFilterLocation === 'VSU Chula Vista' ? 'selected' : ''}>VSU Chula Vista (${itemsByLocation['VSU Chula Vista']})</option>
                                <option value="VSU North Park" ${treasuryFilterLocation === 'VSU North Park' ? 'selected' : ''}>VSU North Park (${itemsByLocation['VSU North Park']})</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body" id="treasury-content-area">
                        ${treasuryViewMode === 'grid' ? renderTreasuryGrid() : renderTreasuryList()}
                    </div>
                </div>
            `;
        }

        function renderTreasuryGrid() {
            const filteredItems = getFilteredTreasuryItems();

            if (filteredItems.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                        <i class="fas fa-gem" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                        <p>No pieces found</p>
                    </div>
                `;
            }

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; padding: 20px;">
                    ${filteredItems.map(item => {
                        // Use thumbnail for grid (faster loading), fallback to full image if no thumbnail
                        const itemThumbnail = item.thumbnail || item.image || (item.photos && item.photos.length > 0 ? item.photos[0] : null);
                        const itemValue = parseFloat(item.value) || 0;
                        const itemName = item.artworkName || 'Unknown';
                        const itemArtist = item.artist || 'Unknown Artist';

                        return `
                            <div onclick="viewTreasuryItem('${item.firestoreId || item.id}')" style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;"
                                onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 16px 32px rgba(0,0,0,0.15)'; this.style.borderColor='var(--accent-primary)';"
                                onmouseout="this.style.transform='none'; this.style.boxShadow='none'; this.style.borderColor='transparent';">
                                <div style="height: 180px; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;">
                                    ${itemThumbnail
                                        ? `<div class="treasury-img-placeholder"></div><img src="${itemThumbnail}" loading="lazy" class="treasury-lazy-img" onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';" style="width: 100%; height: 100%; object-fit: cover;" alt="${itemName}">`
                                        : `<i class="fas fa-image" style="font-size: 48px; color: var(--text-muted); opacity: 0.3;"></i>`
                                    }
                                </div>
                                <div style="padding: 16px;">
                                    <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${itemName}</div>
                                    <div style="font-size: 13px; color: var(--accent-primary); margin-bottom: 8px;"><i class="fas fa-palette" style="margin-right: 6px;"></i>${itemArtist}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 18px; font-weight: 700; color: #10b981;">$${itemValue.toLocaleString()}</span>
                                        <span style="font-size: 11px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; color: var(--text-muted);">${item.location || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderTreasuryList() {
            const filteredItems = getFilteredTreasuryItems();

            if (filteredItems.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                        <i class="fas fa-gem" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                        <p>No pieces found</p>
                    </div>
                `;
            }

            return `
                <table class="data-table treasury-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Photo</th>
                            <th>Artwork Name</th>
                            <th>Artist</th>
                            <th>Acquisition Date</th>
                            <th>Value (USD)</th>
                            <th>Location</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredItems.map(item => {
                            // Use thumbnail for list (faster loading), fallback to full image if no thumbnail
                            const itemThumbnail = item.thumbnail || item.image || (item.photos && item.photos.length > 0 ? item.photos[0] : null);
                            const photoDisplay = itemThumbnail
                                ? `<div class="treasury-img-placeholder small"></div><img src="${itemThumbnail}" loading="lazy" class="treasury-lazy-img" onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';" style="width: 100%; height: 100%; object-fit: cover;" alt="${item.artworkName}">`
                                : `<i class="fas fa-gem" style="color: var(--text-muted); font-size: 24px;"></i>`;

                            const itemValue = parseFloat(item.value) || 0;
                            const itemName = item.artworkName || 'Unknown';
                            const itemArtist = item.artist || '-';
                            const itemDate = item.acquisitionDate || '-';
                            const itemLocation = item.location || 'Unknown';

                            return `
                                <tr>
                                    <td data-label="Photo">
                                        <div style="width: 60px; height: 60px; border-radius: 8px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--border-color); position: relative;">
                                            ${photoDisplay}
                                        </div>
                                    </td>
                                    <td data-label="Artwork Name"><strong>${itemName}</strong></td>
                                    <td data-label="Artist">${itemArtist}</td>
                                    <td data-label="Acquisition Date">${formatDate(itemDate)}</td>
                                    <td data-label="Value" style="font-weight: 600; color: var(--success);">$${itemValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td data-label="Location">
                                        <span class="badge" style="background: var(--accent-primary);">${itemLocation}</span>
                                    </td>
                                    <td data-label="Actions">
                                        <button class="btn-icon" onclick="viewTreasuryItem('${item.firestoreId || item.id}')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn-icon" onclick="editTreasuryItem('${item.firestoreId || item.id}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon" onclick="deleteTreasuryItem('${item.firestoreId || item.id}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function getFilteredTreasuryItems() {
            return treasuryItems.filter(item => {
                const locationMatch = treasuryFilterLocation === 'all' || item.location === treasuryFilterLocation;
                const artistMatch = treasuryFilterArtist === 'all' || item.artist === treasuryFilterArtist;
                return locationMatch && artistMatch;
            });
        }

        window.switchTreasuryView = function(mode) {
            treasuryViewMode = mode;
            const contentArea = document.getElementById('treasury-content-area');
            const gridBtn = document.getElementById('treasury-grid-btn');
            const listBtn = document.getElementById('treasury-list-btn');

            if (contentArea) {
                contentArea.innerHTML = mode === 'grid' ? renderTreasuryGrid() : renderTreasuryList();
            }
            if (gridBtn && listBtn) {
                gridBtn.style.background = mode === 'grid' ? 'var(--accent-primary)' : 'var(--bg-secondary)';
                gridBtn.style.color = mode === 'grid' ? 'white' : 'var(--text-primary)';
                listBtn.style.background = mode === 'list' ? 'var(--accent-primary)' : 'var(--bg-secondary)';
                listBtn.style.color = mode === 'list' ? 'white' : 'var(--text-primary)';
            }
        }

        window.filterTreasuryByLocation = function(location) {
            treasuryFilterLocation = location;
            const contentArea = document.getElementById('treasury-content-area');
            if (contentArea) {
                contentArea.innerHTML = treasuryViewMode === 'grid' ? renderTreasuryGrid() : renderTreasuryList();
            }
        }

        window.filterTreasuryByArtist = function(artist) {
            treasuryFilterArtist = artist;
            const contentArea = document.getElementById('treasury-content-area');
            if (contentArea) {
                contentArea.innerHTML = treasuryViewMode === 'grid' ? renderTreasuryGrid() : renderTreasuryList();
            }
        }

        function viewTreasuryItem(id) {
            const item = treasuryItems.find(t => t.firestoreId === id || t.id === id);
            if (!item) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            // Support both 'image' field and legacy 'photos' array
            const itemImage = item.image || (item.photos && item.photos.length > 0 ? item.photos[0] : null);
            const imageDisplay = itemImage
                ? `<div style="position: relative; min-height: 200px;"><div class="treasury-img-placeholder large"></div><img src="${itemImage}" loading="lazy" class="treasury-lazy-img" onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 12px;" alt="${item.artworkName}"></div>`
                : `<div style="text-align: center; padding: 60px; background: var(--bg-secondary); border-radius: 12px; color: var(--text-muted);">
                    <i class="fas fa-gem" style="font-size: 64px; margin-bottom: 16px; display: block;"></i>
                    No image available
                </div>`;

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-gem"></i> ${item.artworkName}</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 24px; text-align: center;">
                        ${imageDisplay}
                    </div>

                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <h4 style="margin: 0 0 16px; font-size: 14px; color: var(--text-muted);">Piece Information</h4>
                            <div class="treasury-info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-bottom: 16px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Artist</label>
                                    <div style="font-weight: 500;">${item.artist || 'Unknown'}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Acquisition Date</label>
                                    <div>${formatDate(item.acquisitionDate) || '-'}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Estimated Value</label>
                                    <div style="font-weight: 600; color: var(--success); font-size: 18px;">$${(parseFloat(item.value) || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Current Location</label>
                                    <div><span class="badge" style="background: var(--accent-primary);">${item.location || 'Unknown'}</span></div>
                                </div>
                            </div>

                            ${item.description ? `
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px;">Description</label>
                                    <p style="margin: 0; line-height: 1.6; color: var(--text-secondary);">${item.description}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="treasury-modal-actions" style="display: flex; gap: 12px;">
                        <button class="btn-secondary" style="flex: 1;" onclick="editTreasuryItem('${item.firestoreId || item.id}')">
                            <i class="fas fa-edit"></i>
                            Edit Piece
                        </button>
                        <button class="btn-secondary" style="flex: 1; background: var(--danger); color: white; border-color: var(--danger);" onclick="closeModal(); deleteTreasuryItem('${item.firestoreId || item.id}');">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function editTreasuryItem(id) {
            closeModal();
            setTimeout(() => openModal('edit-treasury', id), 100);
        }

        async function deleteTreasuryItem(id) {
            showConfirmModal({
                title: 'Delete Heady Piece',
                message: 'Are you sure you want to delete this piece from the collection? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        // Find the item to get firestoreId
                        const item = treasuryItems.find(t => t.firestoreId === id || t.id === id);

                        // Delete from Firebase if firestoreId exists
                        if (item && item.firestoreId && typeof firebase !== 'undefined' && firebase.firestore) {
                            const db = firebase.firestore();
                            const treasuryCollection = window.FIREBASE_COLLECTIONS?.treasury || 'treasury';
                            await db.collection(treasuryCollection).doc(item.firestoreId).delete();
                        }

                        // Remove from local array
                        treasuryItems = treasuryItems.filter(t => t.firestoreId !== id && t.id !== id);

                        await loadTreasuryItemsFromFirebase();
                        renderTreasuryContent();
                    } catch (error) {
                        console.error('Error deleting treasury item:', error);
                        showNotification('Error deleting item. Please try again.', 'error');
                    }
                }
            });
        }

        /**
         * Preview treasury image before upload
         */
        function previewTreasuryImage(input) {
            const preview = document.getElementById('treasury-image-preview');
            if (!preview) return;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    preview.removeAttribute('data-removed');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        /**
         * Remove treasury image from preview
         */
        function removeTreasuryImage() {
            const preview = document.getElementById('treasury-image-preview');
            const input = document.getElementById('treasury-image');

            if (preview) {
                preview.innerHTML = `<i class="fas fa-gem" style="font-size: 36px; color: var(--text-muted);"></i>`;
                preview.setAttribute('data-removed', 'true');
            }
            if (input) {
                input.value = '';
            }
        }

        async function saveTreasuryItem(isEdit = false, itemId = null) {
            const artworkName = document.getElementById('treasury-artwork-name').value.trim();
            const artist = document.getElementById('treasury-artist').value.trim();
            const acquisitionDate = document.getElementById('treasury-acquisition-date').value;
            const value = parseFloat(document.getElementById('treasury-value').value) || 0;
            const location = document.getElementById('treasury-location').value;
            const description = document.getElementById('treasury-description').value.trim();

            // Get the image
            const imageInput = document.getElementById('treasury-image');
            const imagePreview = document.getElementById('treasury-image-preview');

            // Determine image value - now with thumbnail support
            let imageUrl = null;
            let thumbnailUrl = null;
            const wasRemoved = imagePreview?.getAttribute('data-removed') === 'true';

            if (wasRemoved) {
                // Image was explicitly removed
                imageUrl = null;
                thumbnailUrl = null;
            } else if (imageInput?.files && imageInput.files.length > 0) {
                // New image uploaded - upload both original and thumbnail to Firebase Storage
                const rawBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageInput.files[0]);
                });
                try {
                    const baseFileName = `treasury-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                    // Generate thumbnail (300px, quality 0.7)
                    const thumbnailBase64 = await generateThumbnail(rawBase64, 300, 0.7);

                    // Upload both in parallel for speed
                    const [originalUrl, thumbUrl] = await Promise.all([
                        uploadImageToFirebaseStorage(rawBase64, `treasury/${baseFileName}.jpg`),
                        uploadImageToFirebaseStorage(thumbnailBase64, `treasury/thumbnails/${baseFileName}_thumb.jpg`)
                    ]);

                    imageUrl = originalUrl;
                    thumbnailUrl = thumbUrl;
                } catch (err) {
                    console.error('Error uploading treasury image:', err);
                    showNotification('Error uploading image to Firebase Storage', 'error');
                    return;
                }
            } else if (isEdit) {
                // Keep existing images
                const existingItem = treasuryItems.find(t => t.firestoreId === itemId || t.id === itemId);
                imageUrl = existingItem?.image || (existingItem?.photos && existingItem.photos.length > 0 ? existingItem.photos[0] : null);
                thumbnailUrl = existingItem?.thumbnail || null;
            }

            if (!artworkName || !location) {
                alert('Please fill in at least the artwork name and location');
                return;
            }

            try {
                if (isEdit) {
                    const item = treasuryItems.find(t => t.firestoreId === itemId || t.id === itemId);
                    if (item) {
                        item.artworkName = artworkName;
                        item.artist = artist;
                        item.acquisitionDate = acquisitionDate;
                        item.value = value;
                        item.location = location;
                        item.description = description;
                        item.image = imageUrl;
                        item.thumbnail = thumbnailUrl;

                        // Update in Firebase
                        if (typeof firebase !== 'undefined' && firebase.firestore) {
                            const db = firebase.firestore();
                            const treasuryCollection = window.FIREBASE_COLLECTIONS?.treasury || 'treasury';

                            // Use firestoreId if available, otherwise create new
                            if (item.firestoreId) {
                                await db.collection(treasuryCollection).doc(item.firestoreId).update({
                                    artworkName,
                                    artist,
                                    acquisitionDate,
                                    value,
                                    location,
                                    description,
                                    image: imageUrl,
                                    thumbnail: thumbnailUrl,
                                    updatedAt: new Date()
                                });
                            } else {
                                // If no firestoreId, save as new
                                const docRef = await db.collection(treasuryCollection).add({
                                    artworkName,
                                    artist,
                                    acquisitionDate,
                                    value,
                                    location,
                                    description,
                                    image: imageUrl,
                                    thumbnail: thumbnailUrl,
                                    createdAt: new Date(),
                                    updatedAt: new Date()
                                });
                                item.firestoreId = docRef.id;
                            }
                        }
                    }
                } else {
                    const newItem = {
                        id: treasuryItems.length > 0 ? Math.max(...treasuryItems.map(t => t.id)) + 1 : 1,
                        artworkName,
                        artist,
                        acquisitionDate,
                        value,
                        location,
                        description,
                        image: imageUrl,
                        thumbnail: thumbnailUrl
                    };

                    // Save to Firebase
                    if (typeof firebase !== 'undefined' && firebase.firestore) {
                        const db = firebase.firestore();
                        const treasuryCollection = window.FIREBASE_COLLECTIONS?.treasury || 'treasury';

                        const docRef = await db.collection(treasuryCollection).add({
                            artworkName,
                            artist,
                            acquisitionDate,
                            value,
                            location,
                            description,
                            image: imageUrl,
                            thumbnail: thumbnailUrl,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        newItem.firestoreId = docRef.id;
                    }

                    treasuryItems.push(newItem);
                }

                closeModal();
                await loadTreasuryItemsFromFirebase();
                renderTreasuryContent();
            } catch (error) {
                console.error('Error saving treasury item:', error);
                alert('Error saving treasury item. Please try again.');
            }
        }

        // Change Functions - Daily Change Register
        const CHANGE_DENOMINATIONS = {
            coins: [
                { id: 'pennies', label: 'Pennies', value: 0.01, icon: '1¬¢' },
                { id: 'nickels', label: 'Nickels', value: 0.05, icon: '5¬¢' },
                { id: 'dimes', label: 'Dimes', value: 0.10, icon: '10¬¢' },
                { id: 'quarters', label: 'Quarters', value: 0.25, icon: '25¬¢' },
                { id: 'dollars_coin', label: 'Dollar Coins', value: 1.00, icon: '$1' }
            ],
            bills: [
                { id: 'ones', label: '$1 Bills', value: 1, icon: '$1' },
                { id: 'fives', label: '$5 Bills', value: 5, icon: '$5' },
                { id: 'tens', label: '$10 Bills', value: 10, icon: '$10' },
                { id: 'twenties', label: '$20 Bills', value: 20, icon: '$20' },
                { id: 'fifties', label: '$50 Bills', value: 50, icon: '$50' },
                { id: 'hundreds', label: '$100 Bills', value: 100, icon: '$100' }
            ]
        };

        let changeFilterStore = 'all';
        let changeViewMode = 'list'; // 'list' or 'grid'

        function renderChange() {
            const dashboard = document.querySelector('.dashboard');
            const today = new Date().toISOString().split('T')[0];

            // Filter records
            const filteredRecords = changeFilterStore === 'all'
                ? changeRecords
                : changeRecords.filter(r => r.store === changeFilterStore);

            // Sort by date descending
            const sortedRecords = [...filteredRecords].sort((a, b) => new Date(b.date) - new Date(a.date));

            // Today's records
            const todayRecords = changeRecords.filter(r => r.date === today);
            const todayTotal = todayRecords.reduce((sum, r) => sum + (r.amount || 0), 0);

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title" style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-coins" style="color: white; font-size: 20px;"></i>
                            </div>
                            Daily Change Register
                        </h2>
                        <p class="section-subtitle">Record daily change by denomination</p>
                    </div>
                    <button class="btn-primary" onclick="openDailyChangeForm()">
                        <i class="fas fa-plus"></i> New Daily Record
                    </button>
                </div>

                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 16px; padding: 20px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Today's Total</div>
                        <div style="font-size: 28px; font-weight: 700;">$${todayTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">${todayRecords.length} record${todayRecords.length !== 1 ? 's' : ''}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 20px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Total Records</div>
                        <div style="font-size: 28px; font-weight: 700;">${changeRecords.length}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">All time</div>
                    </div>
                </div>

                <!-- Daily Change Form (hidden by default) -->
                <div id="daily-change-form" style="display: none; margin-bottom: 24px;"></div>

                <!-- Filter -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center;">
                    <select class="form-input" style="width: 200px;" onchange="filterChangeByStore(this.value)">
                        <option value="all" ${changeFilterStore === 'all' ? 'selected' : ''}>All Stores</option>
                        <option value="Miramar" ${changeFilterStore === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                        <option value="Morena" ${changeFilterStore === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                        <option value="Kearny Mesa" ${changeFilterStore === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                        <option value="Chula Vista" ${changeFilterStore === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                        <option value="Miramar Wine & Liquor" ${changeFilterStore === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                    </select>
                    <span style="font-size: 13px; color: var(--text-muted);">${filteredRecords.length} records</span>
                    <!-- View Toggle -->
                    <div style="display: flex; background: var(--bg-secondary); border-radius: 8px; padding: 3px; border: 1px solid var(--border-color); margin-left: auto;">
                        <button onclick="setChangeViewMode('list')" id="change-view-list-btn" style="width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${changeViewMode === 'list' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                        <button onclick="setChangeViewMode('grid')" id="change-view-grid-btn" style="width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${changeViewMode === 'grid' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="Grid View">
                            <i class="fas fa-th-large"></i>
                        </button>
                    </div>
                </div>

                <!-- Records List/Grid -->
                <div id="change-records-container">
                    ${sortedRecords.length === 0 ? `
                        <div class="card">
                            <div class="card-body" style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <i class="fas fa-coins" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.3;"></i>
                                <div style="font-size: 16px; margin-bottom: 8px;">No change records yet</div>
                                <div style="font-size: 13px;">Click "New Daily Record" to add one</div>
                            </div>
                        </div>
                    ` : changeViewMode === 'grid' ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                            ${sortedRecords.map(record => renderChangeRecordCard(record)).join('')}
                        </div>
                    ` : `
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${sortedRecords.map(record => renderChangeRecordRow(record)).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderDailyChangeForm() {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, var(--bg-secondary) 100%);">
                    <div class="card-header" style="background: transparent;">
                        <h3 class="card-title" style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-coins" style="color: #f59e0b;"></i>
                            New Daily Change Record
                        </h3>
                        <button onclick="closeDailyChangeForm()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 8px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body" style="padding: 24px;">
                        <!-- Basic Info -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Date</label>
                                <input type="date" id="change-date" class="form-input" value="${today}">
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Store</label>
                                <select id="change-store" class="form-input">
                                    <option value="Miramar">VSU Miramar</option>
                                    <option value="Morena">VSU Morena</option>
                                    <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                    <option value="Chula Vista">VSU Chula Vista</option>
                                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Recorded By</label>
                                <input type="text" id="change-recorded-by" class="form-input" placeholder="Your name">
                            </div>
                        </div>

                        <!-- Coins Section -->
                        <div style="margin-bottom: 24px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-circle" style="color: #f59e0b; font-size: 10px;"></i> Coins
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                ${CHANGE_DENOMINATIONS.coins.map(d => `
                                    <div style="background: var(--bg-primary); border-radius: 12px; padding: 14px; text-align: center;">
                                        <div style="font-size: 18px; font-weight: 700; color: #f59e0b; margin-bottom: 6px;">${d.icon}</div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">${d.label}</div>
                                        <input type="number" id="change-${d.id}" class="form-input" placeholder="0" min="0"
                                            style="text-align: center; font-weight: 600;" oninput="calculateDailyChangeTotal()">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Bills Section -->
                        <div style="margin-bottom: 24px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-money-bill" style="color: #10b981; font-size: 10px;"></i> Bills
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                ${CHANGE_DENOMINATIONS.bills.map(d => `
                                    <div style="background: var(--bg-primary); border-radius: 12px; padding: 14px; text-align: center;">
                                        <div style="font-size: 18px; font-weight: 700; color: #10b981; margin-bottom: 6px;">${d.icon}</div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">${d.label}</div>
                                        <input type="number" id="change-${d.id}" class="form-input" placeholder="0" min="0"
                                            style="text-align: center; font-weight: 600;" oninput="calculateDailyChangeTotal()">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Total -->
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 6px;">TOTAL</div>
                            <div id="change-total-display" style="font-size: 32px; font-weight: 700; color: white;">$0.00</div>
                        </div>

                        <!-- Photo Upload with AI Scan -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Photo of Money</label>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border: 2px dashed var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='var(--border-color)'">
                                            <i class="fas fa-camera" style="color: var(--text-muted);"></i>
                                            <span style="font-size: 13px; color: var(--text-muted);">Upload Photo</span>
                                            <input type="file" id="change-photo" accept="image/*" style="display: none;" onchange="previewChangePhoto(this)">
                                        </label>
                                        <button type="button" id="daily-change-ai-scan-btn" onclick="scanDailyChangeWithAI()" style="padding: 10px 16px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; color: white; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(139,92,246,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                                            <i class="fas fa-magic"></i> Scan with AI
                                        </button>
                                    </div>
                                    <p style="font-size: 11px; color: var(--text-muted); margin: 0;">Upload a photo of the money, then click "Scan with AI" to auto-count</p>
                                </div>
                                <div id="change-photo-preview" style="display: none; position: relative; width: 80px; height: 80px; border-radius: 10px; overflow: hidden; background: var(--bg-secondary); border: 2px solid var(--border-color);">
                                    <img id="change-photo-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
                                    <button onclick="removeChangePhoto()" style="position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border-radius: 50%; background: rgba(239, 68, 68, 0.9); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='#ef4444'" onmouseout="this.style.background='rgba(239, 68, 68, 0.9)'">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Notes (optional)</label>
                            <textarea id="change-notes" class="form-input" placeholder="Any additional notes..." style="min-height: 60px; resize: vertical;"></textarea>
                        </div>

                        <!-- Actions -->
                        <div style="display: flex; justify-content: flex-end; gap: 12px;">
                            <button class="btn-secondary" onclick="closeDailyChangeForm()">Cancel</button>
                            <button class="btn-primary" onclick="saveDailyChange()">
                                <i class="fas fa-save"></i> Save Record
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChangeRecordRow(record) {
            const recordId = record.firestoreId || record.id;
            const recordDate = new Date(record.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const isToday = record.date === new Date().toISOString().split('T')[0];

            return `
                <div class="card" style="border-radius: 12px; overflow: hidden; ${isToday ? 'border-left: 4px solid #f59e0b;' : ''}">
                    <div onclick="toggleChangeDetails('${recordId}')" style="display: flex; align-items: center; padding: 16px 20px; gap: 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                        <!-- Date -->
                        <div style="min-width: 80px;">
                            <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${recordDate}</div>
                            ${isToday ? '<div style="font-size: 10px; color: #f59e0b; font-weight: 600;">TODAY</div>' : ''}
                        </div>

                        <!-- Store -->
                        <div style="background: var(--accent-primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            ${record.store}
                        </div>

                        <!-- Amount -->
                        <div style="flex: 1; text-align: right;">
                            <div style="font-size: 20px; font-weight: 700; color: #10b981;">$${(record.amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>

                        <!-- Recorded By -->
                        <div style="font-size: 13px; color: var(--text-muted); min-width: 100px; display: flex; align-items: center; gap: 8px;">
                            <span><i class="fas fa-user" style="margin-right: 6px;"></i>${record.recordedBy || record.leftBy || 'Unknown'}</span>
                            ${record.photo ? '<i class="fas fa-image" style="color: #f59e0b;" title="Has photo"></i>' : ''}
                        </div>

                        <!-- Arrow -->
                        <div style="color: var(--text-muted);" id="change-arrow-${recordId}">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <!-- Expanded Details -->
                    <div id="change-details-${recordId}" style="display: none; padding: 0 20px 20px; border-top: 1px solid var(--border-color);">
                        <div style="padding-top: 16px;">
                            <!-- Denomination Breakdown -->
                            ${record.denominations && Object.keys(record.denominations).length > 0 ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <!-- Bills (left side, highest to lowest) -->
                                        <div>
                                            <div style="font-size: 12px; font-weight: 600; color: #10b981; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                                <i class="fas fa-money-bill"></i> Bills
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                ${[...CHANGE_DENOMINATIONS.bills].reverse().map(d => {
                                                    const count = record.denominations[d.id] || 0;
                                                    if (count === 0) return '';
                                                    const total = count * d.value;
                                                    return `
                                                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 10px; padding: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(16, 185, 129, 0.2);">
                                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                                <div style="font-size: 18px; font-weight: 700; color: #10b981;">${d.icon}</div>
                                                                <div style="font-size: 12px; color: var(--text-muted);">x${count}</div>
                                                            </div>
                                                            <div style="font-size: 14px; color: var(--text-primary); font-weight: 600;">$${total.toFixed(2)}</div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                        <!-- Coins (right side, highest to lowest) -->
                                        <div>
                                            <div style="font-size: 12px; font-weight: 600; color: #f59e0b; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                                <i class="fas fa-coins"></i> Coins
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                ${[...CHANGE_DENOMINATIONS.coins].reverse().map(d => {
                                                    const count = record.denominations[d.id] || 0;
                                                    if (count === 0) return '';
                                                    const total = count * d.value;
                                                    return `
                                                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 10px; padding: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(245, 158, 11, 0.2);">
                                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                                <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${d.icon}</div>
                                                                <div style="font-size: 12px; color: var(--text-muted);">x${count}</div>
                                                            </div>
                                                            <div style="font-size: 14px; color: var(--text-primary); font-weight: 600;">$${total.toFixed(2)}</div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 16px; margin-bottom: 16px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #10b981;">$${(record.amount || 0).toFixed(2)}</div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Total Amount</div>
                                </div>
                            `}

                            ${record.photo ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">
                                        <i class="fas fa-image"></i> Envelope Photo
                                    </div>
                                    <div style="border-radius: 10px; overflow: hidden; background: var(--bg-secondary);">
                                        <img src="${record.photo}" alt="Envelope" style="width: 100%; max-height: 200px; object-fit: contain; cursor: pointer;" onclick="window.open('${record.photo}', '_blank')">
                                    </div>
                                </div>
                            ` : ''}

                            ${record.notes ? `
                                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Notes</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">${record.notes}</div>
                                </div>
                            ` : ''}

                            <div style="display: flex; justify-content: flex-end; gap: 8px;">
                                <button onclick="event.stopPropagation(); deleteChangeRecord('${recordId}')" class="btn-secondary" style="font-size: 12px; color: #ef4444; border-color: #ef444450;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render change record as grid card
        function renderChangeRecordCard(record) {
            const recordId = record.firestoreId || record.id;
            const recordDate = new Date(record.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const isToday = record.date === new Date().toISOString().split('T')[0];

            // Count denominations
            let billsCount = 0;
            let coinsCount = 0;
            if (record.denominations) {
                CHANGE_DENOMINATIONS.bills.forEach(d => { billsCount += record.denominations[d.id] || 0; });
                CHANGE_DENOMINATIONS.coins.forEach(d => { coinsCount += record.denominations[d.id] || 0; });
            }

            return `
                <div class="change-grid-card" style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.2s; ${isToday ? 'border-top: 4px solid #f59e0b;' : ''}" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">${recordDate} ${isToday ? '‚Ä¢ TODAY' : ''}</div>
                                <div style="font-size: 28px; font-weight: 700;">$${(record.amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-coins" style="font-size: 20px;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Body -->
                    <div style="padding: 16px 20px;">
                        <!-- Store Badge -->
                        <div style="margin-bottom: 12px;">
                            <span style="background: var(--accent-primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                ${record.store}
                            </span>
                        </div>

                        <!-- Denominations Summary -->
                        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                            <div style="flex: 1; background: rgba(16, 185, 129, 0.1); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: #10b981;">${billsCount}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Bills</div>
                            </div>
                            <div style="flex: 1; background: rgba(245, 158, 11, 0.1); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${coinsCount}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Coins</div>
                            </div>
                        </div>

                        <!-- Recorded By -->
                        <div style="font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user"></i>
                            <span>${record.recordedBy || record.leftBy || 'Unknown'}</span>
                            ${record.photo ? '<i class="fas fa-image" style="color: #f59e0b; margin-left: auto;" title="Has photo"></i>' : ''}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="padding: 12px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; justify-content: flex-end;">
                        <button onclick="viewChangeRecord('${recordId}')" class="btn-icon" title="View Details" style="width: 32px; height: 32px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deleteChangeRecord('${recordId}')" class="btn-icon" title="Delete" style="width: 32px; height: 32px; color: var(--danger);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Set Change Records view mode (list or grid)
        function setChangeViewMode(mode) {
            changeViewMode = mode;

            // Update button styles
            const listBtn = document.getElementById('change-view-list-btn');
            const gridBtn = document.getElementById('change-view-grid-btn');

            if (listBtn && gridBtn) {
                if (mode === 'list') {
                    listBtn.style.background = 'var(--accent-primary)';
                    listBtn.style.color = 'white';
                    gridBtn.style.background = 'transparent';
                    gridBtn.style.color = 'var(--text-muted)';
                } else {
                    gridBtn.style.background = 'var(--accent-primary)';
                    gridBtn.style.color = 'white';
                    listBtn.style.background = 'transparent';
                    listBtn.style.color = 'var(--text-muted)';
                }
            }

            // Re-render the page
            renderChange();
        }

        function openDailyChangeForm() {
            const form = document.getElementById('daily-change-form');
            form.style.display = 'block';
            form.innerHTML = renderDailyChangeForm();
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function closeDailyChangeForm() {
            document.getElementById('daily-change-form').style.display = 'none';
            // Reset photo preview
            removeChangePhoto();
        }

        // AI scan for Daily Change Form - analyze money in photo
        async function scanDailyChangeWithAI() {
            const photoInput = document.getElementById('change-photo');

            if (!photoInput || !photoInput.files || !photoInput.files[0]) {
                alert('Please upload a photo of the money first.');
                return;
            }

            const file = photoInput.files[0];
            if (file.type === 'application/pdf') {
                alert('Please upload an image file (JPG, PNG), not a PDF.');
                return;
            }

            // Show loading state
            const scanBtn = document.getElementById('daily-change-ai-scan-btn');
            const originalText = scanBtn ? scanBtn.innerHTML : '';
            if (scanBtn) {
                scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
                scanBtn.disabled = true;
            }

            try {
                // Convert image to base64
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const apiKey = getOpenAIKey();

                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'image_url',
                                        image_url: { url: base64Image }
                                    },
                                    {
                                        type: 'text',
                                        text: `Analyze this image of money/cash and count the bills and coins visible. Return ONLY a JSON object with the count of each denomination (use 0 if not visible):

{
    "hundreds": 0,
    "fifties": 0,
    "twenties": 0,
    "tens": 0,
    "fives": 0,
    "ones": 0,
    "dollars_coin": 0,
    "quarters": 0,
    "dimes": 0,
    "nickels": 0,
    "pennies": 0,
    "notes": "any relevant observations about the money"
}

Count each bill/coin you can see clearly. If bills are stacked, try to estimate the count. Return ONLY the JSON object.`
                                    }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                // Parse the JSON response
                let moneyData;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        moneyData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    throw new Error('Could not parse money data from AI response');
                }

                // Fill in the denomination fields
                const fieldMappings = ['hundreds', 'fifties', 'twenties', 'tens', 'fives', 'ones', 'dollars_coin', 'quarters', 'dimes', 'nickels', 'pennies'];
                fieldMappings.forEach(field => {
                    if (moneyData[field]) {
                        const input = document.getElementById(`change-${field}`);
                        if (input) input.value = moneyData[field];
                    }
                });

                // Add notes if any
                if (moneyData.notes) {
                    const notesField = document.getElementById('change-notes');
                    if (notesField) {
                        notesField.value = moneyData.notes;
                    }
                }

                // Recalculate total
                calculateDailyChangeTotal();

                alert('Money counted successfully! Please review the values.');

            } catch (error) {
                console.error('Error scanning money with AI:', error);
                alert('Error scanning: ' + error.message);
            } finally {
                if (scanBtn) {
                    scanBtn.innerHTML = originalText || '<i class="fas fa-magic"></i> Scan with AI';
                    scanBtn.disabled = false;
                }
            }
        }

        // Calculate total for daily change form in real-time
        function calculateDailyChangeTotal() {
            let total = 0;
            [...CHANGE_DENOMINATIONS.coins, ...CHANGE_DENOMINATIONS.bills].forEach(d => {
                const count = parseInt(document.getElementById(`change-${d.id}`)?.value) || 0;
                total += count * d.value;
            });

            const displayEl = document.getElementById('change-total-display');
            if (displayEl) {
                displayEl.textContent = `$${total.toFixed(2)}`;
            }
            return total;
        }

        async function saveDailyChange() {
            const date = document.getElementById('change-date').value;
            const store = document.getElementById('change-store').value;
            const recordedBy = document.getElementById('change-recorded-by').value.trim();
            const notes = document.getElementById('change-notes').value.trim();
            const photoInput = document.getElementById('change-photo');

            if (!recordedBy) {
                alert('Please enter your name');
                return;
            }

            const denominations = {};
            let total = 0;
            [...CHANGE_DENOMINATIONS.coins, ...CHANGE_DENOMINATIONS.bills].forEach(d => {
                const count = parseInt(document.getElementById(`change-${d.id}`)?.value) || 0;
                if (count > 0) {
                    denominations[d.id] = count;
                    total += count * d.value;
                }
            });

            if (total === 0) {
                alert('Please enter at least one denomination');
                return;
            }

            // Upload photo to Firebase Storage if provided
            let photoUrl = null;
            let photoPath = null;
            if (photoInput && photoInput.files && photoInput.files[0]) {
                const rawBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(photoInput.files[0]);
                });

                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                try {
                    const tempId = Date.now().toString();
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        rawBase64,
                        'change-records/photos',
                        tempId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading change record photo to Storage:', err);
                    // Fallback to compressed base64
                    try {
                        photoUrl = await compressImage(rawBase64);
                    } catch (compressErr) {
                        console.error('Error compressing image:', compressErr);
                        photoUrl = rawBase64;
                    }
                }
            }

            const newRecord = {
                date,
                store,
                recordedBy,
                leftBy: recordedBy,
                receivedBy: recordedBy,
                amount: total,
                denominations,
                notes,
                photo: photoUrl,
                photoPath: photoPath,
                createdAt: new Date().toISOString()
            };

            try {
                // Save to Firebase
                if (typeof firebaseChangeRecordsManager !== 'undefined' && firebaseChangeRecordsManager.isInitialized) {
                    const docId = await firebaseChangeRecordsManager.addChangeRecord(newRecord);
                    if (docId) {
                        newRecord.id = docId;
                        newRecord.firestoreId = docId;
                        changeRecords.unshift(newRecord);
                        closeDailyChangeForm();
                        renderChange();
                    } else {
                        alert('Error saving record to Firebase');
                    }
                } else {
                    // Fallback to local storage
                    newRecord.id = Date.now().toString();
                    changeRecords.unshift(newRecord);
                    localStorage.setItem('changeRecords', JSON.stringify(changeRecords));
                    closeDailyChangeForm();
                    renderChange();
                }
            } catch (error) {
                console.error('Error saving change record:', error);
                alert('Error saving record. Please try again.');
            }
        }

        function toggleChangeDetails(id) {
            const details = document.getElementById(`change-details-${id}`);
            const arrow = document.getElementById(`change-arrow-${id}`);

            if (details.style.display === 'none') {
                // Collapse all others
                document.querySelectorAll('[id^="change-details-"]').forEach(el => el.style.display = 'none');
                document.querySelectorAll('[id^="change-arrow-"]').forEach(el => el.style.transform = 'rotate(0deg)');

                details.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function filterChangeByStore(store) {
            changeFilterStore = store;
            renderChange();
        }

        function filterChangeRecords(store) {
            filterChangeByStore(store);
        }

        function viewChangeRecord(id) {
            const record = changeRecords.find(r => r.id === id || r.firestoreId === id);
            if (!record) return;

            const recordId = record.firestoreId || record.id;
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const photoDisplay = record.photo
                ? `<img src="${record.photo}" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px;" alt="Change photo">`
                : `<div style="text-align: center; padding: 40px; background: var(--bg-secondary); border-radius: 8px; color: var(--text-muted);">
                    <i class="fas fa-image" style="font-size: 48px; margin-bottom: 12px; display: block;"></i>
                    No photo available
                </div>`;

            // Build denominations display if available
            let denominationsDisplay = '';
            if (record.denominations) {
                const d = record.denominations;
                const billsItems = [];
                const coinsItems = [];

                // Bills
                if (d.bills?.hundreds > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$100</strong> √ó ${d.bills.hundreds}</span>`);
                if (d.bills?.fifties > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$50</strong> √ó ${d.bills.fifties}</span>`);
                if (d.bills?.twenties > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$20</strong> √ó ${d.bills.twenties}</span>`);
                if (d.bills?.tens > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$10</strong> √ó ${d.bills.tens}</span>`);
                if (d.bills?.fives > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$5</strong> √ó ${d.bills.fives}</span>`);
                if (d.bills?.twos > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$2</strong> √ó ${d.bills.twos}</span>`);
                if (d.bills?.ones > 0) billsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$1</strong> √ó ${d.bills.ones}</span>`);

                // Coins
                if (d.coins?.dollars > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>$1</strong> √ó ${d.coins.dollars}</span>`);
                if (d.coins?.halfDollars > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>50¬¢</strong> √ó ${d.coins.halfDollars}</span>`);
                if (d.coins?.quarters > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>25¬¢</strong> √ó ${d.coins.quarters}</span>`);
                if (d.coins?.dimes > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>10¬¢</strong> √ó ${d.coins.dimes}</span>`);
                if (d.coins?.nickels > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>5¬¢</strong> √ó ${d.coins.nickels}</span>`);
                if (d.coins?.pennies > 0) coinsItems.push(`<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;"><strong>1¬¢</strong> √ó ${d.coins.pennies}</span>`);

                if (billsItems.length > 0 || coinsItems.length > 0) {
                    denominationsDisplay = `
                        <div style="margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
                                <i class="fas fa-money-bill-wave" style="color: var(--success);"></i> Currency Breakdown
                            </label>
                            ${billsItems.length > 0 ? `
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Bills</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">${billsItems.join('')}</div>
                                </div>
                            ` : ''}
                            ${coinsItems.length > 0 ? `
                                <div>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Coins</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">${coinsItems.join('')}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-coins"></i> Change Record Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        ${photoDisplay}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Store</label>
                            <p style="margin: 0; font-weight: 500;">VSU ${record.store}</p>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Total Amount</label>
                            <p style="margin: 0; font-weight: 600; color: var(--success); font-size: 20px;">$${record.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Date</label>
                            <p style="margin: 0; font-weight: 500;">${formatDate(record.date)}</p>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Left By</label>
                            <p style="margin: 0; font-weight: 500;">${record.leftBy}</p>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Received By</label>
                            <p style="margin: 0; font-weight: 500;">${record.receivedBy}</p>
                        </div>
                    </div>

                    ${denominationsDisplay}

                    ${record.changeInStore !== undefined && record.changeInStore !== null ? `
                        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #10b98115, #10b98108); border: 2px solid #10b98140; border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: #10b98120; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-cash-register" style="color: #10b981; font-size: 18px;"></i>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Change in Store</label>
                                    <p style="margin: 0; font-weight: 700; font-size: 24px; color: #10b981;">$${record.changeInStore.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${record.notes ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px;">Notes</label>
                            <p style="margin: 0; line-height: 1.6; color: var(--text-secondary);">${record.notes}</p>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                    <button class="btn-primary" style="background: var(--danger); border-color: var(--danger);" onclick="closeModal(); deleteChangeRecord('${recordId}');">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        function viewChangePhoto(id) {
            const record = changeRecords.find(r => r.id === id || r.firestoreId === id);
            if (!record || !record.photo) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-image"></i> Change Photo</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <img src="${record.photo}" style="width: 100%; height: auto; display: block;" alt="Change photo">
                </div>
            `;

            modal.classList.add('active');
        }

        async function deleteChangeRecord(id) {
            showConfirmModal({
                title: 'Delete Change Record',
                message: 'Are you sure you want to delete this change record? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        // Delete from Firebase
                        if (typeof firebaseChangeRecordsManager !== 'undefined' && firebaseChangeRecordsManager.isInitialized) {
                            const success = await firebaseChangeRecordsManager.deleteChangeRecord(id);
                            if (success) {
                                changeRecords = changeRecords.filter(r => r.id !== id && r.firestoreId !== id);
                                renderChange();
                            } else {
                                showNotification('Error deleting record from Firebase', 'error');
                            }
                        } else {
                            // Fallback to local deletion
                            changeRecords = changeRecords.filter(r => r.id !== id && r.firestoreId !== id);
                            renderChange();
                        }
                    } catch (error) {
                        console.error('Error deleting change record:', error);
                        showNotification('Error deleting record. Please try again.', 'error');
                    }
                }
            });
        }

        // Helper function to preview change photo
        function previewChangePhoto(input) {
            const preview = document.getElementById('change-photo-preview');
            const previewImg = document.getElementById('change-photo-img');
            if (!preview || !previewImg) return;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Helper function to remove change photo
        function removeChangePhoto() {
            const preview = document.getElementById('change-photo-preview');
            const previewImg = document.getElementById('change-photo-img');
            const input = document.getElementById('change-photo');

            if (preview) {
                preview.style.display = 'none';
            }
            if (previewImg) {
                previewImg.src = '';
            }
            if (input) {
                input.value = '';
            }
        }

        // Calculate total from currency breakdown
        function calculateChangeTotal() {
            let total = 0;

            // Bills
            const bills100 = parseInt(document.getElementById('change-bills-100')?.value) || 0;
            const bills50 = parseInt(document.getElementById('change-bills-50')?.value) || 0;
            const bills20 = parseInt(document.getElementById('change-bills-20')?.value) || 0;
            const bills10 = parseInt(document.getElementById('change-bills-10')?.value) || 0;
            const bills5 = parseInt(document.getElementById('change-bills-5')?.value) || 0;
            const bills2 = parseInt(document.getElementById('change-bills-2')?.value) || 0;
            const bills1 = parseInt(document.getElementById('change-bills-1')?.value) || 0;

            // Coins
            const coins100 = parseInt(document.getElementById('change-coins-100')?.value) || 0;
            const coins50 = parseInt(document.getElementById('change-coins-50')?.value) || 0;
            const coins25 = parseInt(document.getElementById('change-coins-25')?.value) || 0;
            const coins10 = parseInt(document.getElementById('change-coins-10')?.value) || 0;
            const coins5 = parseInt(document.getElementById('change-coins-5')?.value) || 0;
            const coins1 = parseInt(document.getElementById('change-coins-1')?.value) || 0;

            total = (bills100 * 100) + (bills50 * 50) + (bills20 * 20) + (bills10 * 10) +
                    (bills5 * 5) + (bills2 * 2) + (bills1 * 1) +
                    (coins100 * 1) + (coins50 * 0.50) + (coins25 * 0.25) +
                    (coins10 * 0.10) + (coins5 * 0.05) + (coins1 * 0.01);

            // Update display
            const displayEl = document.getElementById('change-total-display');
            if (displayEl) {
                displayEl.textContent = total.toFixed(2);
            }

            return total;
        }

        // Get currency breakdown object
        function getChangeDenominations() {
            return {
                bills: {
                    hundreds: parseInt(document.getElementById('change-bills-100')?.value) || 0,
                    fifties: parseInt(document.getElementById('change-bills-50')?.value) || 0,
                    twenties: parseInt(document.getElementById('change-bills-20')?.value) || 0,
                    tens: parseInt(document.getElementById('change-bills-10')?.value) || 0,
                    fives: parseInt(document.getElementById('change-bills-5')?.value) || 0,
                    twos: parseInt(document.getElementById('change-bills-2')?.value) || 0,
                    ones: parseInt(document.getElementById('change-bills-1')?.value) || 0
                },
                coins: {
                    dollars: parseInt(document.getElementById('change-coins-100')?.value) || 0,
                    halfDollars: parseInt(document.getElementById('change-coins-50')?.value) || 0,
                    quarters: parseInt(document.getElementById('change-coins-25')?.value) || 0,
                    dimes: parseInt(document.getElementById('change-coins-10')?.value) || 0,
                    nickels: parseInt(document.getElementById('change-coins-5')?.value) || 0,
                    pennies: parseInt(document.getElementById('change-coins-1')?.value) || 0
                }
            };
        }

        async function saveChangeRecord() {
            const store = document.getElementById('change-store').value;
            const date = document.getElementById('change-date').value;
            const leftBy = document.getElementById('change-left-by').value.trim();
            const receivedBy = document.getElementById('change-received-by').value.trim();
            const notes = document.getElementById('change-notes').value.trim();
            const changeInStore = parseFloat(document.getElementById('change-in-store')?.value) || 0;
            const photoInput = document.getElementById('change-photo');

            // Calculate amount from denominations
            const amount = calculateChangeTotal();
            const denominations = getChangeDenominations();

            if (!store || !date || !leftBy || !receivedBy) {
                alert('Please fill in all required fields');
                return;
            }

            if (amount <= 0) {
                alert('Please enter at least one denomination');
                return;
            }

            // Upload photo to Firebase Storage if provided
            let photoUrl = null;
            let photoPath = null;
            if (photoInput && photoInput.files && photoInput.files[0]) {
                const rawBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(photoInput.files[0]);
                });

                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                try {
                    const tempId = Date.now().toString();
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        rawBase64,
                        'change-records/photos',
                        tempId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading change record photo to Storage:', err);
                    // Fallback to compressed base64
                    try {
                        photoUrl = await compressImage(rawBase64);
                    } catch (compressErr) {
                        console.error('Error compressing image:', compressErr);
                        photoUrl = rawBase64;
                    }
                }
            }

            const newRecord = {
                store,
                amount,
                date,
                leftBy,
                receivedBy,
                notes,
                changeInStore,
                denominations,
                photo: photoUrl,      // Now stores URL instead of base64
                photoPath: photoPath  // For future deletion
            };

            try {
                // Save to Firebase
                if (typeof firebaseChangeRecordsManager !== 'undefined' && firebaseChangeRecordsManager.isInitialized) {
                    const docId = await firebaseChangeRecordsManager.addChangeRecord(newRecord);
                    if (docId) {
                        newRecord.id = docId;
                        newRecord.firestoreId = docId;
                        changeRecords.unshift(newRecord);
                        closeModal();
                        renderChange();
                    } else {
                        alert('Error saving record to Firebase');
                    }
                } else {
                    // Fallback to local storage
                    newRecord.id = Math.max(0, ...changeRecords.map(r => r.id || 0)) + 1;
                    changeRecords.unshift(newRecord);
                    closeModal();
                    renderChange();
                }
            } catch (error) {
                console.error('Error saving change record:', error);
                alert('Error saving record. Please try again.');
            }
        }

        // AI scan for Change Records - analyze money in photo
        async function scanChangeWithAI() {
            const photoInput = document.getElementById('change-photo');

            if (!photoInput || !photoInput.files || !photoInput.files[0]) {
                alert('Please upload a photo of the money first.');
                return;
            }

            const file = photoInput.files[0];
            const isPdf = file.type === 'application/pdf';
            if (isPdf) {
                alert('Please upload an image file (JPG, PNG), not a PDF.');
                return;
            }

            // Show loading state
            const scanBtn = document.getElementById('change-ai-scan-btn');
            const originalText = scanBtn ? scanBtn.innerHTML : '';
            if (scanBtn) {
                scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
                scanBtn.disabled = true;
            }

            try {
                // Convert image to base64
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const apiKey = getOpenAIKey();

                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'image_url',
                                        image_url: { url: base64Image }
                                    },
                                    {
                                        type: 'text',
                                        text: `Analyze this image of money/cash and count the bills and coins visible. Return ONLY a JSON object with the count of each denomination (use 0 if not visible):

{
    "bills_100": 0,
    "bills_50": 0,
    "bills_20": 0,
    "bills_10": 0,
    "bills_5": 0,
    "bills_2": 0,
    "bills_1": 0,
    "coins_100": 0,
    "coins_50": 0,
    "coins_25": 0,
    "coins_10": 0,
    "coins_5": 0,
    "coins_1": 0,
    "notes": "any relevant observations about the money"
}

Count each bill/coin you can see clearly. If bills are stacked, try to estimate the count. Return ONLY the JSON object.`
                                    }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                // Parse the JSON response
                let moneyData;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        moneyData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    throw new Error('Could not parse money data from AI response');
                }

                // Fill in the denomination fields
                if (moneyData.bills_100) document.getElementById('change-bills-100').value = moneyData.bills_100;
                if (moneyData.bills_50) document.getElementById('change-bills-50').value = moneyData.bills_50;
                if (moneyData.bills_20) document.getElementById('change-bills-20').value = moneyData.bills_20;
                if (moneyData.bills_10) document.getElementById('change-bills-10').value = moneyData.bills_10;
                if (moneyData.bills_5) document.getElementById('change-bills-5').value = moneyData.bills_5;
                if (moneyData.bills_2) document.getElementById('change-bills-2').value = moneyData.bills_2;
                if (moneyData.bills_1) document.getElementById('change-bills-1').value = moneyData.bills_1;
                if (moneyData.coins_100) document.getElementById('change-coins-100').value = moneyData.coins_100;
                if (moneyData.coins_50) document.getElementById('change-coins-50').value = moneyData.coins_50;
                if (moneyData.coins_25) document.getElementById('change-coins-25').value = moneyData.coins_25;
                if (moneyData.coins_10) document.getElementById('change-coins-10').value = moneyData.coins_10;
                if (moneyData.coins_5) document.getElementById('change-coins-5').value = moneyData.coins_5;
                if (moneyData.coins_1) document.getElementById('change-coins-1').value = moneyData.coins_1;

                // Add notes if any
                if (moneyData.notes) {
                    const notesField = document.getElementById('change-notes');
                    if (notesField) {
                        notesField.value = moneyData.notes;
                    }
                }

                // Recalculate total
                calculateChangeTotal();

                alert('Money counted successfully! Please review the values.');

            } catch (error) {
                console.error('Error scanning change with AI:', error);
                alert('Error scanning: ' + error.message);
            } finally {
                if (scanBtn) {
                    scanBtn.innerHTML = originalText || '<i class="fas fa-magic"></i> Scan with AI';
                    scanBtn.disabled = false;
                }
            }
        }

        /**
         * Initialize Firebase and load gifts from Firestore
         */
        async function initializeFirebaseGifts() {
            try {
                
                // Initialize Firebase manager
                const initialized = await firebaseGiftsManager.initialize();
                
                if (initialized) {
                    try {
                        // Load gifts from Firestore
                        const firestoreGifts = await firebaseGiftsManager.loadGifts();
                        
                        if (firestoreGifts && firestoreGifts.length > 0) {
                            
                            // Map Firestore data to the local giftsRecords array
                            giftsRecords = firestoreGifts.map(gift => ({
                                id: gift.firestoreId || gift.id,
                                firestoreId: gift.firestoreId || gift.id,
                                product: gift.product || '',
                                quantity: gift.quantity || 0,
                                value: gift.value || 0,
                                recipient: gift.recipient || '',
                                recipientType: gift.recipientType || 'customer',
                                reason: gift.reason || '',
                                store: gift.store || 'Miramar',
                                date: gift.date || new Date().toISOString().split('T')[0],
                                notes: gift.notes || '',
                                photo: gift.photo || null,
                                photoPath: gift.photoPath || null
                            }));
                            
                            return true;
                        }
                    } catch (error) {
                        console.error('Error loading gifts from Firestore:', error);
                    }
                } else {
                    console.warn('Firebase not available. Using fallback data.');
                }
            } catch (error) {
                console.error('Error initializing Firebase gifts:', error);
            }
            
            return false;
        }

        /**
         * Save gift to Firebase
         */
        async function saveGiftToFirebase(giftData) {
            if (!firebaseGiftsManager.isInitialized) {
                console.warn('Firebase Gifts Manager not initialized');
                return null;
            }

            try {
                if (giftData.firestoreId) {
                    // Update existing
                    const success = await firebaseGiftsManager.updateGift(
                        giftData.firestoreId,
                        giftData
                    );
                    return success ? giftData.firestoreId : null;
                } else {
                    // Create new
                    const newId = await firebaseGiftsManager.addGift(giftData);
                    return newId;
                }
            } catch (error) {
                console.error('Error saving gift to Firebase:', error);
                return null;
            }
        }

        /**
         * Delete gift record from Firebase
         */
        async function deleteGiftFromFirebase(firestoreId) {
            if (!firebaseGiftsManager.isInitialized) {
                console.warn('Firebase Gifts Manager not initialized');
                return false;
            }

            try {
                return await firebaseGiftsManager.deleteGift(firestoreId);
            } catch (error) {
                console.error('Error deleting gift from Firebase:', error);
                return false;
            }
        }

        /**
         * Initialize Firebase and load issues from Firestore
         */
        async function initializeFirebaseIssues() {
            try {

                // Initialize Firebase manager
                const initialized = await firebaseIssuesManager.initialize();

                if (initialized) {
                    try {
                        // Load issues from Firestore
                        const firestoreIssues = await firebaseIssuesManager.loadIssues();

                        // Replace local issues with Firestore data (even if empty, to clear dummy data)
                        if (firestoreIssues && firestoreIssues.length > 0) {

                            // Map Firestore data to the local issues array
                            issues = firestoreIssues.map(issue => ({
                                id: issue.firestoreId || issue.id,
                                firestoreId: issue.firestoreId || issue.id,
                                customer: issue.customer || 'Anonymous',
                                phone: issue.phone || '',
                                type: issue.type || 'In Store',
                                store: issue.store || '',
                                description: issue.description || '',
                                incidentDate: issue.incidentDate || '',
                                perception: issue.perception || null,
                                status: issue.status || 'open',
                                createdBy: issue.createdBy || '',
                                createdDate: issue.createdDate || '',
                                solution: issue.solution || null,
                                resolvedBy: issue.resolvedBy || null,
                                resolutionDate: issue.resolutionDate || null,
                                followUpNotes: issue.followUpNotes || '',
                                statusHistory: issue.statusHistory || []
                            }));

                        } else {
                            // Clear local dummy data if Firebase is connected but empty
                            issues = [];
                        }
                        return true;
                    } catch (error) {
                        console.error('Error loading issues from Firestore:', error);
                    }
                } else {
                    console.warn('Firebase not available. Using fallback data.');
                }
            } catch (error) {
                console.error('Error initializing Firebase issues:', error);
            }

            return false;
        }

        // Initialize Firebase Licenses
        async function initializeFirebaseLicenses() {
            try {
                // Initialize Firebase manager
                const initialized = await firebaseLicensesManager.initialize();

                if (initialized) {
                    try {
                        // Load licenses from Firestore
                        const firestoreLicenses = await firebaseLicensesManager.loadLicenses();

                        if (firestoreLicenses && firestoreLicenses.length > 0) {
                            // Map Firestore data to the local licenses array
                            licenses = firestoreLicenses.map(lic => ({
                                id: lic.firestoreId || lic.id,
                                firestoreId: lic.firestoreId || lic.id,
                                name: lic.name || '',
                                store: lic.store || '',
                                expires: lic.expires || '',
                                status: lic.status || 'valid',
                                file: lic.file || lic.fileName || null,
                                fileName: lic.fileName || null,
                                fileType: lic.fileType || null,
                                fileData: lic.fileData || null,
                                fileUrl: lic.fileUrl || null,
                                filePath: lic.filePath || null,
                                uploadedBy: lic.uploadedBy || null
                            }));

                            return true;
                        } else {
                            console.log('No licenses found in Firestore, using local data');
                        }
                    } catch (error) {
                        console.error('Error loading licenses from Firestore:', error);
                    }
                } else {
                    console.warn('Firebase Licenses not available. Using fallback data.');
                }
            } catch (error) {
                console.error('Error initializing Firebase licenses:', error);
            }

            return false;
        }

        // Function to view/download a license PDF with aesthetic modal preview
        function viewLicensePdf(licenseId) {
            const license = licenses.find(l => l.id === licenseId || l.firestoreId === licenseId);
            if (!license) {
                alert('License not found');
                return;
            }

            // Check for PDF in both fileUrl (Firebase Storage) and fileData (base64)
            const pdfSource = license.fileUrl || license.fileData;
            const hasPdf = !!pdfSource;

            // Determine status color and label
            const statusColors = {
                valid: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10b981', label: 'Valid' },
                expiring: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b', label: 'Expiring Soon' },
                expired: { bg: 'rgba(239, 68, 68, 0.15)', color: '#ef4444', label: 'Expired' }
            };
            const statusStyle = statusColors[license.status] || statusColors.valid;

            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'pdf-preview-modal';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(8px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
                animation: fadeIn 0.2s ease-out;
            `;

            modalOverlay.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { opacity: 0; transform: translateY(20px) scale(0.98); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                    #pdf-preview-modal .pdf-modal-container {
                        animation: slideUp 0.3s ease-out;
                    }
                    #pdf-preview-modal .action-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    }
                </style>
                <div class="pdf-modal-container" style="
                    background: var(--bg-primary);
                    border-radius: 20px;
                    width: 100%;
                    max-width: 1000px;
                    height: 90vh;
                    max-height: 900px;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                    border: 1px solid var(--border-color);
                ">
                    <!-- Header -->
                    <div style="
                        padding: 20px 24px;
                        background: var(--bg-secondary);
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 16px;
                    ">
                        <div style="display: flex; align-items: center; gap: 16px; flex: 1; min-width: 0;">
                            <div style="
                                width: 48px;
                                height: 48px;
                                background: linear-gradient(135deg, #ef4444, #dc2626);
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                flex-shrink: 0;
                            ">
                                <i class="fas fa-file-pdf" style="color: white; font-size: 20px;"></i>
                            </div>
                            <div style="min-width: 0; flex: 1;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${license.name}
                                </h3>
                                <div style="display: flex; align-items: center; gap: 12px; margin-top: 4px; flex-wrap: wrap;">
                                    <span style="font-size: 13px; color: var(--text-muted);">
                                        <i class="fas fa-store" style="margin-right: 4px;"></i>${license.store}
                                    </span>
                                    <span style="font-size: 13px; color: var(--text-muted);">
                                        <i class="fas fa-calendar" style="margin-right: 4px;"></i>Expires: ${formatDate(license.expires)}
                                    </span>
                                    <span style="
                                        font-size: 11px;
                                        font-weight: 600;
                                        padding: 4px 10px;
                                        border-radius: 20px;
                                        background: ${statusStyle.bg};
                                        color: ${statusStyle.color};
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                    ">${statusStyle.label}</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                            ${hasPdf ? `
                            <button class="action-btn" onclick="downloadLicensePdf('${licenseId}')" style="
                                padding: 10px 16px;
                                background: var(--accent-primary);
                                color: white;
                                border: none;
                                border-radius: 10px;
                                font-size: 13px;
                                font-weight: 500;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s;
                            ">
                                <i class="fas fa-download"></i>
                                Download
                            </button>
                            ` : ''}
                            <button onclick="closePdfPreviewModal()" style="
                                width: 40px;
                                height: 40px;
                                background: var(--bg-hover);
                                border: 1px solid var(--border-color);
                                border-radius: 10px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: var(--text-secondary);
                                transition: all 0.2s;
                            ">
                                <i class="fas fa-times" style="font-size: 16px;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- PDF Viewer or No PDF Message -->
                    ${hasPdf ? `
                    <div style="flex: 1; background: #525659; position: relative; overflow: hidden;">
                        <iframe
                            src="${pdfSource}#toolbar=0&navpanes=0&scrollbar=1"
                            style="width: 100%; height: 100%; border: none;"
                            title="PDF Preview"
                        ></iframe>
                    </div>
                    ` : `
                    <div style="flex: 1; background: var(--bg-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div style="
                            width: 120px;
                            height: 120px;
                            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
                            border-radius: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 24px;
                        ">
                            <i class="fas fa-file-circle-exclamation" style="font-size: 48px; color: #ef4444;"></i>
                        </div>
                        <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">No PDF Attached</h3>
                        <p style="margin: 0 0 32px 0; font-size: 14px; color: var(--text-muted); text-align: center; max-width: 400px;">
                            This document doesn't have a PDF file attached yet. You can upload one by editing the document.
                        </p>

                        <!-- Document Details Card -->
                        <div style="
                            background: var(--bg-primary);
                            border: 1px solid var(--border-color);
                            border-radius: 16px;
                            padding: 24px;
                            width: 100%;
                            max-width: 400px;
                        ">
                            <h4 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-info-circle" style="margin-right: 8px;"></i>Document Details
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; color: var(--text-muted);">Name</span>
                                    <span style="font-size: 14px; font-weight: 500; color: var(--text-primary);">${license.name}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; color: var(--text-muted);">Store</span>
                                    <span style="font-size: 14px; font-weight: 500; color: var(--text-primary);">${license.store}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; color: var(--text-muted);">Expires</span>
                                    <span style="font-size: 14px; font-weight: 500; color: var(--text-primary);">${formatDate(license.expires)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; color: var(--text-muted);">Status</span>
                                    <span style="
                                        font-size: 12px;
                                        font-weight: 600;
                                        padding: 4px 12px;
                                        border-radius: 20px;
                                        background: ${statusStyle.bg};
                                        color: ${statusStyle.color};
                                        text-transform: uppercase;
                                    ">${statusStyle.label}</span>
                                </div>
                                ${license.uploadedBy ? `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; color: var(--text-muted);">Uploaded by</span>
                                    <span style="font-size: 14px; font-weight: 500; color: var(--text-primary);">${license.uploadedBy}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    `}

                    <!-- Footer -->
                    <div style="
                        padding: 12px 24px;
                        background: var(--bg-secondary);
                        border-top: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    ">
                        <span style="font-size: 12px; color: var(--text-muted);">
                            ${license.uploadedBy ? `<i class="fas fa-user" style="margin-right: 4px;"></i>Uploaded by ${license.uploadedBy}` : ''}
                        </span>
                        <span style="font-size: 12px; color: var(--text-muted);">
                            Press <kbd style="padding: 2px 6px; background: var(--bg-hover); border-radius: 4px; font-family: monospace;">ESC</kbd> to close
                        </span>
                    </div>
                </div>
            `;

            document.body.appendChild(modalOverlay);

            // Close on overlay click
            modalOverlay.addEventListener('mousedown', (e) => {
                if (e.target === modalOverlay) {
                    closePdfPreviewModal();
                }
            });

            // Close on ESC key
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closePdfPreviewModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // Close PDF preview modal
        function closePdfPreviewModal() {
            const modal = document.getElementById('pdf-preview-modal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.2s ease-out';
                setTimeout(() => modal.remove(), 200);
            }
        }

        // Download license PDF
        function downloadLicensePdf(licenseId) {
            const license = licenses.find(l => l.id === licenseId || l.firestoreId === licenseId);
            const pdfSource = license?.fileUrl || license?.fileData;
            if (!license || !pdfSource) return;

            const link = document.createElement('a');
            link.href = pdfSource;
            link.download = license.fileName || `${license.name}.pdf`;
            link.target = '_blank'; // For Firebase Storage URLs
            link.click();
        }

        // Open license in new tab
        function openLicenseInNewTab(licenseId) {
            const license = licenses.find(l => l.id === licenseId || l.firestoreId === licenseId);
            const pdfSource = license?.fileUrl || license?.fileData;
            if (!license || !pdfSource) return;

            window.open(pdfSource, '_blank');
        }

        /**
         * Generic Document Preview Modal
         * Shows a beautiful preview modal for any document (PDF, images, etc.)
         * @param {Object} docInfo - Document information object
         * @param {string} docInfo.url - URL or base64 data of the document
         * @param {string} docInfo.fileName - Name of the file
         * @param {string} docInfo.fileType - MIME type of the file
         * @param {string} docInfo.fileSize - Size of the file (formatted string or number)
         * @param {string} docInfo.documentType - Type/category of document (e.g., "ID Document", "Contract")
         * @param {string} docInfo.uploadedBy - Who uploaded the document
         * @param {Date|string} docInfo.uploadedAt - When the document was uploaded
         */
        function showDocumentPreview(docInfo) {
            if (!docInfo || !docInfo.url) {
                alert('Document not found');
                return;
            }

            const isPdf = docInfo.fileType?.includes('pdf') || docInfo.fileName?.toLowerCase().endsWith('.pdf');
            const isImage = docInfo.fileType?.includes('image') || /\.(jpg|jpeg|png|gif|webp)$/i.test(docInfo.fileName || '');

            // Format file size if it's a number
            const fileSize = typeof docInfo.fileSize === 'number' ? formatFileSize(docInfo.fileSize) : (docInfo.fileSize || 'Unknown size');

            // Format date
            let uploadDate = '';
            if (docInfo.uploadedAt) {
                const date = docInfo.uploadedAt.toDate ? docInfo.uploadedAt.toDate() : new Date(docInfo.uploadedAt);
                uploadDate = formatDate(date);
            }

            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'document-preview-modal';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(8px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
                animation: docFadeIn 0.2s ease-out;
            `;

            // Get icon and color based on file type
            let iconClass = 'fa-file';
            let iconGradient = 'linear-gradient(135deg, #6366f1, #4f46e5)';
            if (isPdf) {
                iconClass = 'fa-file-pdf';
                iconGradient = 'linear-gradient(135deg, #ef4444, #dc2626)';
            } else if (isImage) {
                iconClass = 'fa-file-image';
                iconGradient = 'linear-gradient(135deg, #10b981, #059669)';
            } else if (docInfo.fileType?.includes('word') || docInfo.fileName?.includes('.doc')) {
                iconClass = 'fa-file-word';
                iconGradient = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            } else if (docInfo.fileType?.includes('excel') || docInfo.fileName?.includes('.xls')) {
                iconClass = 'fa-file-excel';
                iconGradient = 'linear-gradient(135deg, #22c55e, #16a34a)';
            }

            modalOverlay.innerHTML = `
                <style>
                    @keyframes docFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes docSlideUp {
                        from { opacity: 0; transform: translateY(20px) scale(0.98); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                    #document-preview-modal .doc-modal-container {
                        animation: docSlideUp 0.3s ease-out;
                    }
                    #document-preview-modal .doc-action-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    }
                </style>
                <div class="doc-modal-container" style="
                    background: var(--bg-primary);
                    border-radius: 20px;
                    width: 100%;
                    max-width: 1000px;
                    height: 90vh;
                    max-height: 900px;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                    border: 1px solid var(--border-color);
                ">
                    <!-- Header -->
                    <div style="
                        padding: 20px 24px;
                        background: var(--bg-secondary);
                        border-bottom: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 16px;
                    ">
                        <div style="display: flex; align-items: center; gap: 16px; flex: 1; min-width: 0;">
                            <div style="
                                width: 48px;
                                height: 48px;
                                background: ${iconGradient};
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                flex-shrink: 0;
                            ">
                                <i class="fas ${iconClass}" style="color: white; font-size: 20px;"></i>
                            </div>
                            <div style="min-width: 0; flex: 1;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${docInfo.fileName || 'Document'}
                                </h3>
                                <div style="display: flex; align-items: center; gap: 12px; margin-top: 4px; flex-wrap: wrap;">
                                    ${docInfo.documentType ? `<span style="font-size: 13px; color: var(--text-muted);"><i class="fas fa-tag" style="margin-right: 4px;"></i>${docInfo.documentType}</span>` : ''}
                                    <span style="font-size: 13px; color: var(--text-muted);">
                                        <i class="fas fa-file" style="margin-right: 4px;"></i>${fileSize}
                                    </span>
                                    ${uploadDate ? `<span style="font-size: 13px; color: var(--text-muted);"><i class="fas fa-calendar" style="margin-right: 4px;"></i>${uploadDate}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                            <button class="doc-action-btn" onclick="downloadDocument('${docInfo.url}', '${docInfo.fileName || 'document'}')" style="
                                padding: 10px 16px;
                                background: var(--accent-primary);
                                color: white;
                                border: none;
                                border-radius: 10px;
                                font-size: 13px;
                                font-weight: 500;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s;
                            ">
                                <i class="fas fa-download"></i>
                                Download
                            </button>
                            <button onclick="closeDocumentPreviewModal()" style="
                                width: 40px;
                                height: 40px;
                                background: var(--bg-hover);
                                border: 1px solid var(--border-color);
                                border-radius: 10px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: var(--text-secondary);
                                transition: all 0.2s;
                            ">
                                <i class="fas fa-times" style="font-size: 16px;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Document Viewer -->
                    ${isPdf ? `
                    <div style="flex: 1; background: #525659; position: relative; overflow: hidden;">
                        <iframe
                            src="${docInfo.url}#toolbar=0&navpanes=0&scrollbar=1"
                            style="width: 100%; height: 100%; border: none;"
                            title="Document Preview"
                        ></iframe>
                    </div>
                    ` : isImage ? `
                    <div style="flex: 1; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; padding: 20px; overflow: auto;">
                        <img src="${docInfo.url}" alt="${docInfo.fileName || 'Document'}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                    </div>
                    ` : `
                    <div style="flex: 1; background: var(--bg-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div style="
                            width: 120px;
                            height: 120px;
                            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(79, 70, 229, 0.1));
                            border-radius: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 24px;
                        ">
                            <i class="fas ${iconClass}" style="font-size: 48px; color: #6366f1;"></i>
                        </div>
                        <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">Preview Not Available</h3>
                        <p style="margin: 0 0 24px 0; font-size: 14px; color: var(--text-muted); text-align: center; max-width: 400px;">
                            This file type cannot be previewed in the browser. Click download to view the file.
                        </p>
                    </div>
                    `}

                    <!-- Footer -->
                    <div style="
                        padding: 12px 24px;
                        background: var(--bg-secondary);
                        border-top: 1px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    ">
                        <span style="font-size: 12px; color: var(--text-muted);">
                            ${docInfo.uploadedBy ? `<i class="fas fa-user" style="margin-right: 4px;"></i>Uploaded by ${docInfo.uploadedBy}` : ''}
                        </span>
                        <span style="font-size: 12px; color: var(--text-muted);">
                            Press <kbd style="padding: 2px 6px; background: var(--bg-hover); border-radius: 4px; font-family: monospace;">ESC</kbd> to close
                        </span>
                    </div>
                </div>
            `;

            document.body.appendChild(modalOverlay);

            // Close on overlay click
            modalOverlay.addEventListener('mousedown', (e) => {
                if (e.target === modalOverlay) {
                    closeDocumentPreviewModal();
                }
            });

            // Close on ESC key
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeDocumentPreviewModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // Close document preview modal
        function closeDocumentPreviewModal() {
            const modal = document.getElementById('document-preview-modal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.2s ease-out';
                setTimeout(() => modal.remove(), 200);
            }
        }

        // Download document helper
        function downloadDocument(url, fileName) {
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.target = '_blank';
            link.click();
        }

        // Function to delete a license (deletes immediately from Firebase)
        function deleteLicense(licenseId) {
            const license = licenses.find(l => l.id === licenseId || l.firestoreId === licenseId);
            if (!license) return;

            showConfirmModal({
                title: 'Delete License/Document',
                message: `Are you sure you want to delete "${license.name}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    const licenseName = license.name;
                    const firestoreId = license.firestoreId || license.id;

                    // Remove from local array immediately for UI feedback
                    licenses = licenses.filter(l => l.id !== licenseId && l.firestoreId !== licenseId);
                    renderLicenses();

                    // Delete from Firebase
                    try {
                        if (firebaseLicensesManager && firebaseLicensesManager.isInitialized) {
                            await firebaseLicensesManager.deleteLicense(firestoreId);
                            showToast(`"${licenseName}" deleted successfully`, 'success');
                        }
                    } catch (error) {
                        console.error('‚ùå Error deleting license from Firebase:', error);
                        showToast('Error deleting document. Please try again.', 'error');
                        // Reload licenses to restore state
                        await initializeFirebaseLicenses();
                        renderLicenses();
                    }
                }
            });
        }

        // Gifts Functions - Control de Regalos en Especie
    function getGiftsAvailableMonths() {
        if (!Array.isArray(giftsRecords) || giftsRecords.length === 0) {
            return [];
        }

        const monthsSet = new Set();
        giftsRecords.forEach(record => {
            if (!record.date) {
                return;
            }

            const monthKey = record.date.slice(0, 7);
            if (/^\d{4}-\d{2}$/.test(monthKey)) {
                monthsSet.add(monthKey);
            }
        });

        return Array.from(monthsSet).sort((a, b) => b.localeCompare(a));
    }

        const todayMonthKey = new Date().toISOString().slice(0, 7);
        const initialAvailableMonths = getGiftsAvailableMonths();

        if (initialAvailableMonths.length > 0) {
            giftsCurrentMonth = initialAvailableMonths.includes(todayMonthKey)
                ? todayMonthKey
                : initialAvailableMonths[0];
        } else {
            giftsCurrentMonth = todayMonthKey;
        }

        // Gifts view mode state
        let giftsViewMode = 'list'; // 'list' or 'grid'

        // Renderizar inicial
        renderGifts();

        function renderGifts() {
            const dashboard = document.querySelector('.dashboard');
            const availableMonths = getGiftsAvailableMonths();

            if (availableMonths.length > 0 && !availableMonths.includes(giftsCurrentMonth)) {
                giftsCurrentMonth = availableMonths[0];
            }

            // Filter by current month
            const monthlyRecords = giftsRecords.filter(r => r.date && r.date.startsWith(giftsCurrentMonth));
            const monthlyTotal = monthlyRecords.reduce((sum, r) => sum + r.value, 0);
            const monthlyItems = monthlyRecords.reduce((sum, r) => sum + r.quantity, 0);
            const monthName = new Date(giftsCurrentMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Gift Tracking</h2>
                        <p class="section-subtitle">In-Kind Gifts & Product Giveaways</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openModal('add-gift')">
                        <i class="fas fa-plus"></i>
                        Register Gift
                    </button>
                </div>

                <!-- Monthly Total Card -->
                <div style="background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); border-radius: 16px; padding: 30px 40px; margin-bottom: 24px; position: relative; overflow: hidden;">
                    <div style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); width: 180px; height: 180px; border-radius: 50%; background: rgba(255,255,255,0.1);"></div>
                    <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 12px; font-weight: 600; letter-spacing: 1px; margin-bottom: 8px;">${monthName}</div>
                            <div style="color: white; font-size: 42px; font-weight: 700; margin-bottom: 4px;">$${monthlyTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 14px;">${monthlyRecords.length} gift${monthlyRecords.length !== 1 ? 's' : ''} (${monthlyItems} items) this month</div>
                        </div>
                        <select class="form-input" style="width: 150px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;" onchange="changeGiftsMonth(this.value)">
                            ${availableMonths.map(month => {
                                const [year, monthNum] = month.split('-');
                                const date = new Date(parseInt(year), parseInt(monthNum) - 1, 1);
                                const displayMonth = date.toLocaleDateString('en-US', { month: 'short' });
                                const displayYear = date.getFullYear();
                                const label = `${displayMonth} - ${displayYear}`;
                                return `<option value="${month}" ${month === giftsCurrentMonth ? 'selected' : ''} style="color: black;">${label}</option>`;
                            }).join('')}
                        </select>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body" style="padding: 12px 16px;">
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; color: var(--text-secondary);">Store:</label>
                                <select class="form-input" id="gifts-store-filter" style="width: 180px;" onchange="filterGiftsTable()">
                                    <option value="all">All Stores</option>
                                    <option value="Miramar">Miramar</option>
                                    <option value="Morena">Morena</option>
                                    <option value="Kearny Mesa">Kearny Mesa</option>
                                    <option value="Chula Vista">Chula Vista</option>
                                    <option value="North Park">North Park</option>
                                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; color: var(--text-secondary);">Recipient:</label>
                                <select class="form-input" id="gifts-type-filter" style="width: 150px;" onchange="filterGiftsTable()">
                                    <option value="all">All Types</option>
                                    <option value="customer">Customer</option>
                                    <option value="vendor">Vendor</option>
                                    <option value="employee">Employee</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <!-- View Toggle -->
                            <div style="display: flex; background: var(--bg-primary); border-radius: 8px; padding: 3px; border: 1px solid var(--border-color); margin-left: auto;">
                                <button onclick="setGiftsViewMode('list')" id="gifts-view-list-btn" style="width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${giftsViewMode === 'list' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="List View">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button onclick="setGiftsViewMode('grid')" id="gifts-view-grid-btn" style="width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${giftsViewMode === 'grid' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="Grid View">
                                    <i class="fas fa-th-large"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gifts Table/Grid -->
                <div class="card">
                    <div class="card-body" style="padding: ${giftsViewMode === 'grid' ? '20px' : '0'};" id="gifts-container">
                        ${monthlyRecords.length === 0 ? `
                            <div style="padding: 60px; text-align: center; color: var(--text-muted);">
                                <i class="fas fa-gift" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                                <h3 style="margin-bottom: 8px; color: var(--text-secondary);">No Gifts This Month</h3>
                                <p>Click "Register Gift" to add a new record</p>
                            </div>
                        ` : giftsViewMode === 'grid' ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;" id="giftsGridContainer">
                                ${renderGiftsGridCards(monthlyRecords)}
                            </div>
                        ` : `
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Product</th>
                                        <th>Qty</th>
                                        <th>Value</th>
                                        <th>Recipient</th>
                                        <th>Type</th>
                                        <th>Details</th>
                                        <th>Store</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="giftsTableBody">
                                    ${renderGiftsTableRows(monthlyRecords)}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;
        }

        function changeGiftsMonth(monthKey) {
            if (!monthKey) {
                return;
            }

            giftsCurrentMonth = monthKey;
            renderGifts();
        }

        function renderGiftsTableRows(records) {
            if (records.length === 0) return '';

            return records.map(gift => `
                <tr>
                    <td>${new Date(gift.date).toLocaleDateString()}</td>
                    <td>
                        <div style="font-weight: 500;">${gift.product}</div>
                        ${gift.notes ? `<div style="font-size: 11px; color: var(--text-muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${gift.notes}</div>` : ''}
                    </td>
                    <td style="text-align: center;">${gift.quantity}</td>
                    <td style="font-weight: 600; color: var(--danger);">$${gift.value.toFixed(2)}</td>
                    <td>${gift.recipient}</td>
                    <td>
                        <span class="status-badge ${gift.recipientType === 'customer' ? 'active' : gift.recipientType === 'vendor' ? 'warning' : 'inactive'}">
                            ${gift.recipientType.charAt(0).toUpperCase() + gift.recipientType.slice(1)}
                        </span>
                    </td>
                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${gift.reason}">${gift.reason}</td>
                    <td>
                        <span style="background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${gift.store}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-icon" onclick="viewGiftDetails('${String(gift.id).replace(/'/g, "\\'")}');" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon" onclick="editGift('${String(gift.id).replace(/'/g, "\\'")}');" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteGift('${String(gift.id).replace(/'/g, "\\'")}');" title="Delete" style="color: var(--danger);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterGiftsTable() {
            const storeFilter = document.getElementById('gifts-store-filter')?.value || 'all';
            const typeFilter = document.getElementById('gifts-type-filter')?.value || 'all';

            // Start with monthly records
            let filteredRecords = giftsRecords.filter(r => r.date && r.date.startsWith(giftsCurrentMonth));

            // Apply store filter
            if (storeFilter !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.store === storeFilter);
            }

            // Apply type filter
            if (typeFilter !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.recipientType === typeFilter);
            }

            // Update based on current view mode
            if (giftsViewMode === 'grid') {
                const gridContainer = document.getElementById('giftsGridContainer');
                if (gridContainer) {
                    gridContainer.innerHTML = renderGiftsGridCards(filteredRecords);
                }
            } else {
                const tbody = document.getElementById('giftsTableBody');
                if (tbody) {
                    tbody.innerHTML = renderGiftsTableRows(filteredRecords);
                }
            }
        }

        // Render gifts as grid cards
        function renderGiftsGridCards(records) {
            if (records.length === 0) return '';

            return records.map(gift => {
                const typeColors = {
                    customer: { bg: '#10b98120', color: '#10b981' },
                    vendor: { bg: '#f59e0b20', color: '#f59e0b' },
                    employee: { bg: '#6366f120', color: '#6366f1' },
                    other: { bg: '#64748b20', color: '#64748b' }
                };
                const typeStyle = typeColors[gift.recipientType] || typeColors.other;

                return `
                    <div class="gift-grid-card" style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.2s; display: flex; flex-direction: column;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); padding: 16px 20px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">${new Date(gift.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                                    <div style="font-size: 24px; font-weight: 700;">$${gift.value.toFixed(2)}</div>
                                </div>
                                <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-gift" style="font-size: 20px;"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Body -->
                        <div style="padding: 16px 20px; flex: 1;">
                            <!-- Product -->
                            <div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${gift.product}</span>
                                <span style="background: var(--bg-primary); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 500; color: var(--text-muted);">√ó${gift.quantity}</span>
                            </div>

                            <!-- Recipient Info -->
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                                <span style="background: ${typeStyle.bg}; color: ${typeStyle.color}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                    ${gift.recipientType}
                                </span>
                                <span style="background: var(--bg-primary); padding: 4px 10px; border-radius: 12px; font-size: 11px; color: var(--text-secondary);">
                                    ${gift.store}
                                </span>
                            </div>

                            <!-- Recipient Name -->
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                <i class="fas fa-user" style="margin-right: 6px; opacity: 0.6;"></i>${gift.recipient}
                            </div>

                            <!-- Reason -->
                            ${gift.reason ? `
                                <div style="font-size: 12px; color: var(--text-muted); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    ${gift.reason}
                                </div>
                            ` : ''}
                        </div>

                        <!-- Footer -->
                        <div style="padding: 12px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn-icon" onclick="viewGiftDetails('${String(gift.id).replace(/'/g, "\\'")}');" title="View Details" style="width: 32px; height: 32px;">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon" onclick="editGift('${String(gift.id).replace(/'/g, "\\'")}');" title="Edit" style="width: 32px; height: 32px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteGift('${String(gift.id).replace(/'/g, "\\'")}');" title="Delete" style="width: 32px; height: 32px; color: var(--danger);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Set Gifts view mode (list or grid)
        function setGiftsViewMode(mode) {
            giftsViewMode = mode;

            // Update button styles
            const listBtn = document.getElementById('gifts-view-list-btn');
            const gridBtn = document.getElementById('gifts-view-grid-btn');

            if (listBtn && gridBtn) {
                if (mode === 'list') {
                    listBtn.style.background = 'var(--accent-primary)';
                    listBtn.style.color = 'white';
                    gridBtn.style.background = 'transparent';
                    gridBtn.style.color = 'var(--text-muted)';
                } else {
                    gridBtn.style.background = 'var(--accent-primary)';
                    gridBtn.style.color = 'white';
                    listBtn.style.background = 'transparent';
                    listBtn.style.color = 'var(--text-muted)';
                }
            }

            // Re-render the page
            renderGifts();
        }

        function viewGiftDetails(id) {
            // Convert to number if it's a numeric string
            const giftId = typeof id === 'string' && !isNaN(id) ? parseInt(id) : id;
            const gift = giftsRecords.find(r => r.id === giftId);
            if (!gift) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-gift" style="color: var(--accent-primary);"></i>
                        Gift Details
                    </h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 16px;">
                        <div class="card" style="background: var(--bg-tertiary);">
                            <div class="card-body">
                                <h3 style="margin: 0 0 12px 0; color: var(--text-primary);">${gift.product}</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Quantity</div>
                                        <div style="font-weight: 600;">${gift.quantity}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Value</div>
                                        <div style="font-weight: 600; color: var(--danger);">$${gift.value.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Date</div>
                                        <div style="font-weight: 500;">${new Date(gift.date).toLocaleDateString()}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Store</div>
                                        <div style="font-weight: 500;">${gift.store}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="background: var(--bg-tertiary);">
                            <div class="card-body">
                                <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
                                    <i class="fas fa-user" style="margin-right: 8px;"></i>Recipient
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Name</div>
                                        <div style="font-weight: 600;">${gift.recipient}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 12px;">Type</div>
                                        <span class="status-badge ${gift.recipientType === 'customer' ? 'active' : gift.recipientType === 'vendor' ? 'warning' : 'inactive'}">
                                            ${gift.recipientType.charAt(0).toUpperCase() + gift.recipientType.slice(1)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="background: var(--bg-tertiary);">
                            <div class="card-body">
                                <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
                                    <i class="fas fa-clipboard-list" style="margin-right: 8px;"></i>Reason
                                </h4>
                                <p style="margin: 0; line-height: 1.6; color: var(--text-secondary);">${gift.reason}</p>
                            </div>
                        </div>

                        ${gift.notes ? `
                            <div class="card" style="background: var(--bg-tertiary);">
                                <div class="card-body">
                                    <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
                                        <i class="fas fa-sticky-note" style="margin-right: 8px;"></i>Notes
                                    </h4>
                                    <p style="margin: 0; line-height: 1.6; color: var(--text-secondary);">${gift.notes}</p>
                                </div>
                            </div>
                        ` : ''}

                        ${gift.photo ? `
                            <div class="card" style="background: var(--bg-tertiary);">
                                <div class="card-body">
                                    <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
                                        <i class="fas fa-camera" style="margin-right: 8px;"></i>Photo
                                    </h4>
                                    <div style="text-align: center;">
                                        <img src="${gift.photo}" alt="Gift photo" style="max-width: 100%; max-height: 300px; border-radius: 8px; object-fit: contain; cursor: pointer;" onclick="showImageModal('${gift.photo}', '${gift.product.replace(/'/g, "\\'")} - Gift Photo')">
                                        <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">Click to view full size</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn-secondary" style="flex: 1;" onclick="editGift('${String(gift.id).replace(/'/g, "\\'")}'); closeModal();">
                            <i class="fas fa-edit"></i>
                            Edit Gift
                        </button>
                        <button class="btn-secondary" style="flex: 1; background: var(--danger); color: white; border-color: var(--danger);" onclick="closeModal(); deleteGift('${String(gift.id).replace(/'/g, "\\'")}');">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function editGift(id) {
            // Convert to number if it's a numeric string
            const giftId = typeof id === 'string' && !isNaN(id) ? parseInt(id) : id;
            closeModal();
            setTimeout(() => openModal('edit-gift', giftId), 100);
        }

        function deleteGift(id) {
            // Convert to number if it's a numeric string
            const giftId = typeof id === 'string' && !isNaN(id) ? parseInt(id) : id;
            const gift = giftsRecords.find(r => r.id === giftId);
            const productName = gift?.product || 'this gift record';

            showConfirmModal({
                title: 'Delete Gift Record',
                message: `Are you sure you want to delete "${productName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    if (gift) {
                        // Try to delete from Firebase
                        if (gift.firestoreId) {
                            const success = await deleteGiftFromFirebase(gift.firestoreId);
                            if (!success) {
                                console.warn('Failed to delete from Firebase, but deleting locally');
                            }
                        }
                    }
                    giftsRecords = giftsRecords.filter(r => r.id !== giftId);
                    renderGifts();
                }
            });
        }

        async function saveGift(isEdit = false, giftId = null) {
            const product = document.getElementById('gift-product').value.trim();
            const quantity = parseInt(document.getElementById('gift-quantity').value);
            const value = parseFloat(document.getElementById('gift-value').value);
            const recipient = document.getElementById('gift-recipient').value.trim();
            const recipientType = document.getElementById('gift-recipient-type').value;
            const reason = document.getElementById('gift-reason').value.trim();
            const store = document.getElementById('gift-store').value;
            const date = document.getElementById('gift-date').value;
            const notes = document.getElementById('gift-notes').value.trim();
            const photoInput = document.getElementById('gift-photo');

            if (!product) {
                alert('Please enter a product name');
                return;
            }

            try {
                if (isEdit && giftId) {
                    // Convert giftId to number if it's a string
                    const numericGiftId = typeof giftId === 'string' && !isNaN(giftId) ? parseInt(giftId) : giftId;
                    const gift = giftsRecords.find(r => r.id === numericGiftId);
                    if (gift) {
                        const giftData = {
                            product,
                            quantity,
                            value,
                            recipient,
                            recipientType,
                            reason,
                            store,
                            date,
                            notes,
                            photo: gift.photo || null,
                            photoPath: gift.photoPath || null
                        };

                        // Upload photo to Firebase Storage if new one provided
                        if (photoInput && photoInput.files.length > 0) {
                            const rawBase64 = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.readAsDataURL(photoInput.files[0]);
                            });

                            // Initialize storage helper if needed
                            if (!firebaseStorageHelper.isInitialized) {
                                firebaseStorageHelper.initialize();
                            }

                            // Delete old photo from Storage if exists
                            if (gift.photoPath) {
                                try {
                                    await firebaseStorageHelper.deleteFile(gift.photoPath);
                                } catch (err) {
                                    console.error('Error deleting old gift photo from Storage:', err);
                                }
                            }

                            try {
                                const uploadResult = await firebaseStorageHelper.uploadImage(
                                    rawBase64,
                                    'gifts/photos',
                                    gift.firestoreId || numericGiftId.toString()
                                );
                                giftData.photo = uploadResult.url;
                                giftData.photoPath = uploadResult.path;
                            } catch (err) {
                                console.error('Error uploading gift photo to Storage:', err);
                                // Fallback to compressed base64
                                try {
                                    giftData.photo = await compressImage(rawBase64);
                                } catch (compressErr) {
                                    giftData.photo = rawBase64;
                                }
                            }
                        }

                        // Update Firebase if it has a firestoreId
                        if (gift.firestoreId) {
                            giftData.firestoreId = gift.firestoreId;
                            const result = await saveGiftToFirebase(giftData);
                            if (!result) {
                                console.error('Failed to update gift in Firebase');
                            }
                        }

                        gift.product = product;
                        gift.quantity = quantity;
                        gift.value = value;
                        gift.recipient = recipient;
                        gift.recipientType = recipientType;
                        gift.reason = reason;
                        gift.store = store;
                        gift.date = date;
                        gift.notes = notes;
                        gift.photo = giftData.photo;
                        gift.photoPath = giftData.photoPath;
                    } else {
                        alert('Gift record not found');
                        return;
                    }
                } else {
                    // Upload photo to Firebase Storage if provided
                    let photoUrl = null;
                    let photoPath = null;
                    if (photoInput && photoInput.files.length > 0) {
                        const rawBase64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(photoInput.files[0]);
                        });

                        // Initialize storage helper if needed
                        if (!firebaseStorageHelper.isInitialized) {
                            firebaseStorageHelper.initialize();
                        }

                        try {
                            const tempId = Date.now().toString();
                            const uploadResult = await firebaseStorageHelper.uploadImage(
                                rawBase64,
                                'gifts/photos',
                                tempId
                            );
                            photoUrl = uploadResult.url;
                            photoPath = uploadResult.path;
                        } catch (err) {
                            console.error('Error uploading gift photo to Storage:', err);
                            // Fallback to compressed base64
                            try {
                                photoUrl = await compressImage(rawBase64);
                            } catch (compressErr) {
                                photoUrl = rawBase64;
                            }
                        }
                    }

                    const giftData = {
                        product,
                        quantity,
                        value,
                        recipient,
                        recipientType,
                        reason,
                        store,
                        date,
                        notes,
                        photo: photoUrl,       // Now stores URL instead of base64
                        photoPath: photoPath   // For future deletion
                    };

                    // Save to Firebase
                    const firestoreId = await saveGiftToFirebase(giftData);

                    const newGift = {
                        id: Math.max(0, ...giftsRecords.map(r => r.id)) + 1,
                        firestoreId: firestoreId || undefined,
                        ...giftData
                    };
                    giftsRecords.unshift(newGift);
                }

                closeModal();
                renderGifts();
            } catch (error) {
                console.error('Error saving gift:', error);
                alert('Error saving gift. Please try again.');
            }
        }

        // Cash Out Functions
        function renderCashOut() {
            const dashboard = document.querySelector('.dashboard');

            // Filter by store first
            let filteredRecords = [...cashOutRecords];
            if (currentCashOutStoreFilter !== 'all') {
                filteredRecords = cashOutRecords.filter(r => r.store === currentCashOutStoreFilter);
            }

            // Calculate monthly total (from filtered records)
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthlyRecords = filteredRecords.filter(r => {
                const date = new Date(r.createdDate);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            const monthlyTotal = monthlyRecords.reduce((sum, r) => sum + r.amount, 0);
            const monthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Cash Control</h2>
                        <p class="section-subtitle">Track and manage store cash flow</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('create-cashout')">
                        <i class="fas fa-plus"></i>
                        Add Expense
                    </button>
                </div>

                <!-- Monthly Total Card -->
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border-radius: 16px; padding: 30px 40px; margin-bottom: 24px; position: relative; overflow: hidden;">
                    <div style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); width: 180px; height: 180px; border-radius: 50%; background: rgba(255,255,255,0.1);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 12px; font-weight: 600; letter-spacing: 1px; margin-bottom: 8px;">
                            ${monthName} ${currentCashOutStoreFilter !== 'all' ? `¬∑ ${currentCashOutStoreFilter}` : ''}
                        </div>
                        <div style="color: white; font-size: 42px; font-weight: 700; margin-bottom: 4px;">$${monthlyTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 14px;">${monthlyRecords.length} expense${monthlyRecords.length !== 1 ? 's' : ''} this month</div>
                    </div>
                </div>

                <!-- Store Filter -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-store" style="color: var(--text-muted);"></i>
                                <span style="font-weight: 500; color: var(--text-secondary);">Filter by Store:</span>
                            </div>
                            <select id="cashout-store-filter" class="form-input" onchange="filterCashOutByStore(this.value)" style="width: 220px;">
                                <option value="all" ${currentCashOutStoreFilter === 'all' ? 'selected' : ''}>All Stores</option>
                                <option value="Miramar" ${currentCashOutStoreFilter === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                <option value="Morena" ${currentCashOutStoreFilter === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                <option value="Kearny Mesa" ${currentCashOutStoreFilter === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                <option value="Chula Vista" ${currentCashOutStoreFilter === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                <option value="North Park" ${currentCashOutStoreFilter === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                <option value="Miramar Wine & Liquor" ${currentCashOutStoreFilter === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                            </select>
                            ${currentCashOutStoreFilter !== 'all' ? `
                                <button onclick="filterCashOutByStore('all')" class="btn-secondary" style="padding: 8px 12px;">
                                    <i class="fas fa-times"></i> Clear Filter
                                </button>
                                <span style="margin-left: auto; font-size: 13px; color: var(--text-muted);">
                                    Showing ${filteredRecords.length} of ${cashOutRecords.length} records
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Money Flying Animation Container -->
                <div id="money-flying-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden;"></div>

                <!-- Charts Card -->
                <div class="card" style="margin-bottom: 24px; ${cashOutViewState.expenseAnalysisExpanded ? 'border: 2px solid var(--accent-primary); box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);' : ''}">
                    <div class="card-header" style="cursor: pointer; user-select: none; ${cashOutViewState.expenseAnalysisExpanded ? 'background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);' : ''}" onclick="toggleCashOutExpenseAnalysisWithEffect()">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div style="width: 40px; height: 40px; background: ${cashOutViewState.expenseAnalysisExpanded ? 'linear-gradient(135deg, #8b5cf6, #ec4899)' : 'var(--bg-secondary)'}; border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                                <i class="fas fa-chart-line" style="color: ${cashOutViewState.expenseAnalysisExpanded ? 'white' : 'var(--accent-primary)'}; font-size: 16px;"></i>
                            </div>
                            <div>
                                <h3 class="card-title" style="margin: 0; font-size: 16px;">Expense Analysis</h3>
                                <span style="font-size: 12px; color: var(--text-muted);">${cashOutViewState.expenseAnalysisExpanded ? 'Click to collapse' : 'Click to expand charts & insights'}</span>
                            </div>
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                                ${!cashOutViewState.expenseAnalysisExpanded ? '<span style="background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">VIEW CHARTS</span>' : ''}
                                <i class="fas fa-chevron-down" style="transition: transform 0.3s ease; transform: ${cashOutViewState.expenseAnalysisExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}; color: var(--text-muted);"></i>
                            </div>
                        </div>
                    </div>

                    ${cashOutViewState.expenseAnalysisExpanded ? `
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                            <!-- View Toggle Buttons -->
                            <button class="cashout-filter-btn ${cashOutViewState.viewType === 'week' ? 'active' : ''}"
                                    onclick="switchCashOutView('week')"
                                    id="cashout-week-btn">
                                <i class="fas fa-calendar-week"></i> Week
                            </button>
                            <button class="cashout-filter-btn ${cashOutViewState.viewType === 'month' ? 'active' : ''}"
                                    onclick="switchCashOutView('month')"
                                    id="cashout-month-btn">
                                <i class="fas fa-calendar"></i> Month
                            </button>
                        </div>

                        ${cashOutRecords.length === 0 ? `
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                                <p>No expense data available yet</p>
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <!-- Daily/Weekly Expenses Chart -->
                                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                                        ${cashOutViewState.viewType === 'week' ? 'Daily Expenses This Week' : 'Daily Expenses This Month'}
                                    </div>
                                    <canvas id="cashout-daily-chart" style="max-height: 200px;"></canvas>
                                </div>

                                <!-- Store Breakdown Chart -->
                                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                                        Expenses by Store
                                    </div>
                                    <canvas id="cashout-store-chart" style="max-height: 200px;"></canvas>
                                </div>
                            </div>

                            <!-- Trend Chart (Full Width) -->
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">
                                    Expense Trend
                                </div>
                                <canvas id="cashout-trend-chart" style="max-height: 250px;"></canvas>
                            </div>
                        `}
                    </div>
                    ` : ''}
                </div>

                <!-- Data Table/Grid Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">
                        <i class="fas fa-receipt" style="margin-right: 8px; color: var(--accent-primary);"></i>
                        Expense Records
                    </h3>
                    <!-- View Toggle -->
                    <div style="display: flex; background: var(--bg-secondary); border-radius: 8px; padding: 3px; border: 1px solid var(--border-color);">
                        <button onclick="setCashOutDisplayMode('list')" id="cashout-view-list-btn" style="width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${cashOutViewState.displayMode === 'list' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                        <button onclick="setCashOutDisplayMode('grid')" id="cashout-view-grid-btn" style="width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${cashOutViewState.displayMode === 'grid' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="Grid View">
                            <i class="fas fa-th-large"></i>
                        </button>
                    </div>
                </div>

                <!-- Data Table/Grid Card -->
                <div class="card">
                    <div class="card-body" style="padding: ${cashOutViewState.displayMode === 'grid' ? '20px' : '0'};">
                        ${filteredRecords.length === 0 ? `
                            <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                                <i class="fas fa-money-bill-wave" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                <h3 style="margin-bottom: 8px; color: var(--text-secondary);">No Expenses Yet</h3>
                                <p>Click "Add Expense" to create a new record</p>
                            </div>
                        ` : cashOutViewState.displayMode === 'grid' ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                                ${filteredRecords.map(record => renderCashOutCard(record)).join('')}
                            </div>
                        ` : `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Store</th>
                                        <th>Created By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredRecords.map(record => {
                                        const recordId = record.firestoreId || record.id;
                                        return `
                                        <tr>
                                            <td>${formatDate(record.createdDate)}</td>
                                            <td>
                                                <strong>${record.name}</strong>
                                                ${record.reason ? `<div style="font-size: 12px; color: var(--text-muted);">${record.reason}</div>` : ''}
                                            </td>
                                            <td style="font-weight: 600; color: var(--danger);">
                                                $${record.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                            </td>
                                            <td><span class="status-badge">${record.store || 'N/A'}</span></td>
                                            <td>${record.createdBy}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn-icon" onclick="viewCashOutDetails('${recordId}')" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn-icon" onclick="editCashOut('${recordId}')" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn-icon btn-danger" onclick="deleteCashOut('${recordId}')" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;

            // Initialize charts after DOM is rendered
            setTimeout(() => initializeCashOutCharts(), 100);
        }

        // Filter cash out by store
        function filterCashOutByStore(store) {
            currentCashOutStoreFilter = store;
            renderCashOut();
        }

        // Switch cash out view between week and month
        function switchCashOutView(viewType) {
            cashOutViewState.viewType = viewType;
            renderCashOut();
        }

        // Toggle expense analysis expansion
        function toggleCashOutExpenseAnalysis() {
            cashOutViewState.expenseAnalysisExpanded = !cashOutViewState.expenseAnalysisExpanded;
            renderCashOut();

            // Initialize charts after expansion if needed
            if (cashOutViewState.expenseAnalysisExpanded) {
                setTimeout(() => initializeCashOutCharts(), 100);
            }
        }

        // Toggle expense analysis with flying money effect
        function toggleCashOutExpenseAnalysisWithEffect() {
            // Trigger flying money effect
            createFlyingMoneyEffect();

            // Toggle after a small delay for effect
            setTimeout(() => {
                toggleCashOutExpenseAnalysis();
            }, 100);
        }

        // Create flying money effect
        function createFlyingMoneyEffect() {
            const container = document.getElementById('money-flying-container');
            if (!container) return;

            // Clear any existing money
            container.innerHTML = '';

            const moneyEmojis = ['üíµ', 'üí∏', 'üí∞', 'ü§ë', 'üí≤', 'ü™ô', 'üíé'];
            const numBills = 20;

            for (let i = 0; i < numBills; i++) {
                setTimeout(() => {
                    const money = document.createElement('div');
                    const emoji = moneyEmojis[Math.floor(Math.random() * moneyEmojis.length)];
                    const startX = 20 + Math.random() * 60; // Start from middle area
                    const endX = (Math.random() - 0.5) * 200; // Drift left or right
                    const duration = 1.5 + Math.random() * 1;
                    const size = 24 + Math.random() * 24;
                    const rotation = (Math.random() - 0.5) * 720;
                    const animId = `flyMoney_${Date.now()}_${i}`;

                    money.innerHTML = emoji;
                    money.style.cssText = `
                        position: fixed;
                        font-size: ${size}px;
                        left: ${startX}%;
                        top: 60%;
                        pointer-events: none;
                        z-index: 10000;
                        animation: ${animId} ${duration}s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
                        text-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    `;

                    // Create unique keyframes for each emoji
                    const keyframes = document.createElement('style');
                    keyframes.textContent = `
                        @keyframes ${animId} {
                            0% {
                                transform: translateY(0) translateX(0) rotate(0deg) scale(0.5);
                                opacity: 0;
                            }
                            10% {
                                opacity: 1;
                                transform: translateY(-50px) translateX(${endX * 0.1}px) rotate(${rotation * 0.1}deg) scale(1);
                            }
                            80% {
                                opacity: 1;
                            }
                            100% {
                                transform: translateY(-500px) translateX(${endX}px) rotate(${rotation}deg) scale(0.3);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(keyframes);

                    container.appendChild(money);

                    // Remove after animation
                    setTimeout(() => {
                        money.remove();
                        keyframes.remove();
                    }, duration * 1000 + 100);
                }, i * 80);
            }
        }

        // Set Cash Out display mode (list or grid)
        function setCashOutDisplayMode(mode) {
            cashOutViewState.displayMode = mode;
            renderCashOut();
        }

        // Render cash out record as grid card
        function renderCashOutCard(record) {
            const recordId = record.firestoreId || record.id;
            const recordDate = new Date(record.createdDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            return `
                <div class="cashout-grid-card" style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.2s; display: flex; flex-direction: column;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); padding: 20px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">${recordDate}</div>
                                <div style="font-size: 28px; font-weight: 700;">$${record.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-money-bill-wave" style="font-size: 20px;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Body -->
                    <div style="padding: 16px 20px; flex: 1;">
                        <!-- Name -->
                        <div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 8px;">
                            ${record.name}
                        </div>

                        <!-- Reason -->
                        ${record.reason ? `
                            <div style="font-size: 13px; color: var(--text-muted); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 12px;">
                                ${record.reason}
                            </div>
                        ` : ''}

                        <!-- Meta Info -->
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                            <span style="background: var(--accent-primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${record.store || 'N/A'}
                            </span>
                        </div>

                        <!-- Created By -->
                        <div style="font-size: 12px; color: var(--text-muted);">
                            <i class="fas fa-user" style="margin-right: 6px;"></i>${record.createdBy}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="padding: 12px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; justify-content: flex-end;">
                        <button onclick="viewCashOutDetails('${recordId}')" class="btn-icon" title="View Details" style="width: 32px; height: 32px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="editCashOut('${recordId}')" class="btn-icon" title="Edit" style="width: 32px; height: 32px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCashOut('${recordId}')" class="btn-icon" title="Delete" style="width: 32px; height: 32px; color: var(--danger);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Get date range based on view type
        function getCashOutDateRange() {
            const now = new Date();
            let startDate, endDate = new Date(now);

            if (cashOutViewState.viewType === 'week') {
                // Get start of current week (Sunday)
                const day = now.getDay();
                startDate = new Date(now);
                startDate.setDate(now.getDate() - day);
                startDate.setHours(0, 0, 0, 0);
            } else {
                // Get start of current month
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            }

            endDate.setHours(23, 59, 59, 999);
            return { startDate, endDate };
        }

        // Initialize cashout charts
        function initializeCashOutCharts() {
            // Destroy existing charts
            Object.values(cashOutCharts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Apply store filter
            let filtered = cashOutRecords;
            if (currentCashOutStoreFilter !== 'all') {
                filtered = cashOutRecords.filter(r => r.store === currentCashOutStoreFilter);
            }

            if (filtered.length === 0) return;

            const { startDate, endDate } = getCashOutDateRange();

            // Filter records by date range
            const rangeFiltered = filtered.filter(r => {
                const recordDate = new Date(r.createdDate);
                return recordDate >= startDate && recordDate <= endDate;
            });

            // 1. Daily Expenses Chart
            initializeDailyExpensesChart(rangeFiltered);

            // 2. Store Breakdown Chart (use all records for store breakdown, but respect store filter)
            initializeStoreBreakdownChart(filtered);

            // 3. Trend Chart
            initializeTrendChart(filtered);
        }

        // Daily expenses bar chart
        function initializeDailyExpensesChart(records) {
            const dailyCtx = document.getElementById('cashout-daily-chart');
            if (!dailyCtx) return;

            // Group by day
            const dailyData = {};
            records.forEach(r => {
                const dateStr = new Date(r.createdDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dailyData[dateStr] = (dailyData[dateStr] || 0) + r.amount;
            });

            const labels = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
            const data = labels.map(label => dailyData[label]);

            cashOutCharts.dailyChart = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Amount ($)',
                        data: data,
                        backgroundColor: '#8b5cf6',
                        borderColor: '#7c3aed',
                        borderWidth: 1,
                        borderRadius: 6,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            }
                        }
                    }
                }
            });
        }

        // Store breakdown pie chart
        function initializeStoreBreakdownChart(records) {
            const storeCtx = document.getElementById('cashout-store-chart');
            if (!storeCtx) return;

            // Group by store
            const storeData = {};
            records.forEach(r => {
                const store = r.store || 'Unknown';
                storeData[store] = (storeData[store] || 0) + r.amount;
            });

            const labels = Object.keys(storeData);
            const data = Object.values(storeData);

            // Color palette
            const colors = ['#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#06b6d4'];

            cashOutCharts.storeChart = new Chart(storeCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 12,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Trend line chart (last 30 days)
        function initializeTrendChart(records) {
            const trendCtx = document.getElementById('cashout-trend-chart');
            if (!trendCtx) return;

            // Get last 30 days
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            const trendData = {};
            for (let i = 29; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                trendData[dateStr] = 0;
            }

            records.forEach(r => {
                const recordDate = new Date(r.createdDate);
                if (recordDate >= thirtyDaysAgo) {
                    const dateStr = recordDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    if (trendData.hasOwnProperty(dateStr)) {
                        trendData[dateStr] += r.amount;
                    }
                }
            });

            const labels = Object.keys(trendData);
            const data = Object.values(trendData);

            // Calculate cumulative sum
            let cumulative = 0;
            const cumulativeData = data.map(val => cumulative += val);

            cashOutCharts.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Total ($)',
                        data: cumulativeData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            }
                        }
                    }
                }
            });
        }

        async function deleteCashOut(id) {
            showConfirmModal({
                title: 'Delete Cash Out',
                message: 'Are you sure you want to delete this cash out record? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        // Delete from Firebase
                        if (typeof firebaseCashOutManager !== 'undefined' && firebaseCashOutManager.isInitialized) {
                            const success = await firebaseCashOutManager.deleteCashOutRecord(id);
                            if (success) {
                                cashOutRecords = cashOutRecords.filter(r => r.id !== id && r.firestoreId !== id);
                                renderCashOut();
                                showNotification('Cash out deleted', 'success');
                            } else {
                                showNotification('Error deleting from Firebase', 'error');
                            }
                        } else {
                            // Fallback to local deletion
                            cashOutRecords = cashOutRecords.filter(r => r.id !== id && r.firestoreId !== id);
                            renderCashOut();
                            showNotification('Cash out deleted', 'success');
                        }
                    } catch (error) {
                        console.error('Error deleting cash out:', error);
                        showNotification('Error deleting cash out', 'error');
                    }
                }
            });
        }

        // AI scan for Cash Out - analyze receipt to auto-fill (photo not saved)
        async function scanCashOutWithAI() {
            const photoInput = document.getElementById('cashout-ai-photo');

            if (!photoInput || !photoInput.files || !photoInput.files[0]) {
                alert('Please upload a receipt image first.');
                return;
            }

            const file = photoInput.files[0];
            const isPdf = file.type === 'application/pdf';
            if (isPdf) {
                alert('Please upload an image file (JPG, PNG), not a PDF.');
                return;
            }

            // Show loading state
            const scanBtn = document.getElementById('cashout-ai-scan-btn');
            const originalText = scanBtn ? scanBtn.innerHTML : '';
            if (scanBtn) {
                scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
                scanBtn.disabled = true;
            }

            try {
                // Convert image to base64
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const apiKey = getOpenAIKey();

                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'image_url',
                                        image_url: { url: base64Image }
                                    },
                                    {
                                        type: 'text',
                                        text: `Analyze this receipt/expense image and extract the following information. Return ONLY a JSON object with these fields (use null for any field you cannot find):

{
    "total": "the total amount as a number (no currency symbols)",
    "date": "the date in YYYY-MM-DD format",
    "description": "the store name or a brief description of what was purchased",
    "notes": "any relevant details like items purchased, payment method, etc."
}

Return ONLY the JSON object, no additional text.`
                                    }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                // Parse the JSON response
                let receiptData;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        receiptData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    throw new Error('Could not parse receipt data from AI response');
                }

                // Fill in the form fields
                if (receiptData.description) {
                    document.getElementById('cashout-name').value = receiptData.description;
                }
                if (receiptData.total) {
                    const amount = parseFloat(receiptData.total.toString().replace(/[^0-9.]/g, ''));
                    if (!isNaN(amount)) {
                        document.getElementById('cashout-amount').value = amount.toFixed(2);
                    }
                }
                if (receiptData.date) {
                    document.getElementById('cashout-date').value = receiptData.date;
                }
                if (receiptData.notes) {
                    document.getElementById('cashout-reason').value = receiptData.notes;
                }

                // Clear the file input (photo won't be saved)
                photoInput.value = '';

                alert('Receipt scanned successfully! Please review the values.');

            } catch (error) {
                console.error('Error scanning receipt with AI:', error);
                alert('Error scanning: ' + error.message);
            } finally {
                if (scanBtn) {
                    scanBtn.innerHTML = originalText || '<i class="fas fa-magic"></i> Scan Receipt';
                    scanBtn.disabled = false;
                }
            }
        }

        async function createCashOut() {
            const name = document.getElementById('cashout-name').value.trim();
            const amount = parseFloat(document.getElementById('cashout-amount').value);
            const store = document.getElementById('cashout-store').value;
            const date = document.getElementById('cashout-date').value;
            const reason = document.getElementById('cashout-reason').value.trim();

            if (!name || !amount || !store) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be greater than zero', 'error');
                return;
            }

            // Get current user
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

            const newRecord = {
                name,
                amount,
                store,
                reason,
                createdDate: date || new Date().toISOString().split('T')[0],
                createdBy: user?.name || 'Unknown',
                status: 'open',
                closedDate: null,
                receiptPhoto: null,
                amountSpent: null,
                moneyLeft: null,
                hasMoneyLeft: null
            };

            try {
                // Save to Firebase
                if (typeof firebaseCashOutManager !== 'undefined' && firebaseCashOutManager.isInitialized) {
                    const docId = await firebaseCashOutManager.addCashOutRecord(newRecord);
                    if (docId) {
                        newRecord.id = docId;
                        newRecord.firestoreId = docId;
                        cashOutRecords.unshift(newRecord);
                        closeModal();
                        renderCashOut();
                        showNotification('Cash out added!', 'success');
                    } else {
                        showNotification('Error saving to Firebase', 'error');
                    }
                } else {
                    // Fallback to local storage
                    newRecord.id = cashOutRecords.length > 0 ? Math.max(...cashOutRecords.map(r => r.id || 0)) + 1 : 1;
                    cashOutRecords.unshift(newRecord);
                    closeModal();
                    renderCashOut();
                    showNotification('Cash out added!', 'success');
                }
            } catch (error) {
                console.error('Error creating cash out:', error);
                showNotification('Error creating cash out', 'error');
            }
        }

        async function closeCashOut(recordId) {
            const amountSpent = parseFloat(document.getElementById('cashout-amount-spent').value);
            const hasMoneyLeft = document.getElementById('cashout-money-left-yes').checked;
            const receiptInput = document.getElementById('cashout-receipt-photo');

            if (isNaN(amountSpent)) {
                showNotification('Please enter the amount spent', 'error');
                return;
            }

            const record = cashOutRecords.find(r => r.id === recordId || r.firestoreId === recordId);
            if (!record) return;

            // Check if amount exceeds and show warning modal
            if (amountSpent > record.amount) {
                showConfirmModal({
                    title: 'Amount Exceeds Original',
                    message: `Amount spent ($${amountSpent.toFixed(2)}) exceeds the original amount ($${record.amount.toFixed(2)}). Are you sure you want to continue?`,
                    confirmText: 'Continue',
                    type: 'warning',
                    onConfirm: () => {
                        processCloseCashOut(recordId, amountSpent, hasMoneyLeft, receiptInput, record);
                    }
                });
                return;
            }

            processCloseCashOut(recordId, amountSpent, hasMoneyLeft, receiptInput, record);
        }

        async function processCloseCashOut(recordId, amountSpent, hasMoneyLeft, receiptInput, record) {

            // Upload receipt to Firebase Storage if provided
            let receiptUrl = null;
            let receiptPath = null;
            if (receiptInput && receiptInput.files && receiptInput.files[0]) {
                const rawBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(receiptInput.files[0]);
                });

                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                try {
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        rawBase64,
                        'cashout/receipts',
                        recordId.toString()
                    );
                    receiptUrl = uploadResult.url;
                    receiptPath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading cash out receipt to Storage:', err);
                    // Fallback to compressed base64
                    try {
                        receiptUrl = await compressImage(rawBase64);
                    } catch (compressErr) {
                        console.error('Error compressing receipt image:', compressErr);
                        receiptUrl = rawBase64;
                    }
                }
            }

            const updateData = {
                status: 'closed',
                closedDate: new Date().toISOString().split('T')[0],
                amountSpent: amountSpent,
                moneyLeft: record.amount - amountSpent,
                hasMoneyLeft: hasMoneyLeft,
                receiptPhoto: receiptUrl,     // Now stores URL instead of base64
                receiptPath: receiptPath      // For future deletion
            };

            try {
                // Update in Firebase
                const firestoreId = record.firestoreId || record.id;
                if (typeof firebaseCashOutManager !== 'undefined' && firebaseCashOutManager.isInitialized) {
                    const success = await firebaseCashOutManager.updateCashOutRecord(firestoreId, updateData);
                    if (success) {
                        // Update local record
                        Object.assign(record, updateData);
                        closeModal();
                        renderCashOut();
                        showNotification('Cash out closed successfully', 'success');
                    } else {
                        showNotification('Error updating in Firebase', 'error');
                    }
                } else {
                    // Fallback to local update
                    Object.assign(record, updateData);
                    closeModal();
                    renderCashOut();
                    showNotification('Cash out closed successfully', 'success');
                }
            } catch (error) {
                console.error('Error closing cash out:', error);
                showNotification('Error closing cash out', 'error');
            }
        }

        // Edit Cash Out function
        function editCashOut(recordId) {
            const record = cashOutRecords.find(r => r.id === recordId || r.firestoreId === recordId || String(r.id) === String(recordId) || String(r.firestoreId) === String(recordId));

            if (!record) {
                console.error('Record not found for ID:', recordId);
                showNotification('Record not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            if (!modal || !modalContent) {
                console.error('Modal elements not found');
                return;
            }

            const firestoreId = record.firestoreId || record.id;

            modalContent.innerHTML = `
                <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; padding: 20px 24px; margin: -20px -24px 20px -24px; border-radius: 12px 12px 0 0;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-edit" style="font-size: 20px;"></i>
                        </div>
                        <div>
                            <h2 style="margin: 0; font-size: 20px;">Edit Expense</h2>
                            <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 13px;">Modify expense details</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()" style="color: white;"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <form id="edit-cashout-form" onsubmit="event.preventDefault(); saveCashOutChanges('${firestoreId}');">
                        <div class="form-group">
                            <label class="form-label">Expense Name / Description *</label>
                            <input type="text" class="form-input" id="edit-cashout-name" value="${record.name || ''}" required placeholder="e.g., Office Supplies">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Amount *</label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600;">$</span>
                                    <input type="number" step="0.01" class="form-input" id="edit-cashout-amount" value="${record.amount || ''}" required style="padding-left: 28px;" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input" id="edit-cashout-date" value="${record.createdDate || ''}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Store *</label>
                            <select class="form-input" id="edit-cashout-store" required>
                                <option value="">Select store...</option>
                                <option value="Miramar" ${record.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                <option value="Morena" ${record.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                <option value="Kearny Mesa" ${record.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                <option value="Chula Vista" ${record.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                <option value="North Park" ${record.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                <option value="Miramar Wine & Liquor" ${record.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Reason / Notes</label>
                            <textarea class="form-input" id="edit-cashout-reason" rows="3" placeholder="Describe the expense...">${record.reason || ''}</textarea>
                        </div>

                        <div class="form-actions" style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn-primary" style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border: none;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            `;

            modal.classList.add('active');
        }

        // Save Cash Out changes
        async function saveCashOutChanges(recordId) {
            const name = document.getElementById('edit-cashout-name').value.trim();
            const amount = parseFloat(document.getElementById('edit-cashout-amount').value);
            const store = document.getElementById('edit-cashout-store').value;
            const date = document.getElementById('edit-cashout-date').value;
            const reason = document.getElementById('edit-cashout-reason').value.trim();

            if (!name || !amount || !store) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be greater than zero', 'error');
                return;
            }

            const updateData = {
                name,
                amount,
                store,
                reason,
                createdDate: date || new Date().toISOString().split('T')[0]
            };

            try {
                // Update in Firebase
                if (typeof firebaseCashOutManager !== 'undefined' && firebaseCashOutManager.isInitialized) {
                    const success = await firebaseCashOutManager.updateCashOutRecord(recordId, updateData);
                    if (success) {
                        // Update local state
                        const idx = cashOutRecords.findIndex(r => r.id === recordId || r.firestoreId === recordId);
                        if (idx !== -1) {
                            cashOutRecords[idx] = { ...cashOutRecords[idx], ...updateData };
                        }
                        closeModal();
                        renderCashOut();
                        showNotification('Expense updated successfully!', 'success');
                    } else {
                        showNotification('Error updating expense', 'error');
                    }
                } else {
                    // Fallback to local only
                    const idx = cashOutRecords.findIndex(r => r.id === recordId || r.firestoreId === recordId);
                    if (idx !== -1) {
                        cashOutRecords[idx] = { ...cashOutRecords[idx], ...updateData };
                    }
                    closeModal();
                    renderCashOut();
                    showNotification('Expense updated locally', 'success');
                }
            } catch (error) {
                console.error('Error saving expense changes:', error);
                showNotification('Error saving changes', 'error');
            }
        }

        function viewCashOutDetails(recordId) {
            const record = cashOutRecords.find(r => r.id === recordId || r.firestoreId === recordId || String(r.id) === String(recordId) || String(r.firestoreId) === String(recordId));

            if (!record) {
                console.error('Record not found for ID:', recordId);
                showNotification('Record not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            if (!modal || !modalContent) {
                console.error('Modal elements not found');
                return;
            }

            const receiptDisplay = record.receiptPhoto
                ? `<img src="${record.receiptPhoto}" style="width: 100%; max-width: 400px; border-radius: 8px; margin-top: 8px;" alt="Receipt">`
                : '<div style="color: var(--text-muted); font-style: italic;">No receipt uploaded</div>';

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-info-circle"></i> Cash Out Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Cash Out Name</div>
                                <div style="font-size: 18px; font-weight: 600;">${record.name}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Store</div>
                                <span class="badge" style="background: var(--accent-primary);">
                                    <i class="fas fa-store"></i> ${record.store || 'N/A'}
                                </span>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Created By</div>
                                <div style="font-weight: 500;">${record.createdBy}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Created Date</div>
                                <div style="font-weight: 500;">${formatDate(record.createdDate)}</div>
                            </div>
                        </div>

                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Reason</div>
                            <div style="font-size: 14px;">${record.reason || 'No reason provided'}</div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Amount Given</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-primary);">
                                    $${record.amount ? record.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Status</div>
                                <span class="badge" style="background: ${record.status === 'open' ? 'var(--warning)' : 'var(--success)'}; font-size: 14px; padding: 8px 16px;">
                                    ${record.status === 'open' ? 'Open' : 'Closed'}
                                </span>
                            </div>
                        </div>

                        ${record.status === 'closed' ? `
                            <div style="border-top: 2px solid var(--border-color); padding-top: 16px; margin-top: 8px;">
                                <h3 style="font-size: 16px; margin-bottom: 16px;">Closure Details</h3>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Amount Spent</div>
                                        <div style="font-size: 20px; font-weight: 700; color: var(--danger);">
                                            $${(record.amountSpent || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                        </div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Money Left</div>
                                        <div style="font-size: 20px; font-weight: 700; color: ${record.hasMoneyLeft ? 'var(--success)' : 'var(--text-muted)'};">
                                            $${(record.moneyLeft || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                        </div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Closed Date</div>
                                        <div style="font-size: 14px; font-weight: 600;">
                                            ${formatDate(record.closedDate)}
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Receipt Photo</div>
                                    ${receiptDisplay}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    ${record.status === 'open' ? `
                        <button class="btn-primary" onclick="closeModal(); setTimeout(() => openModal('close-cashout', '${record.firestoreId || record.id}'), 100);">
                            <i class="fas fa-check"></i> Close Cash Out
                        </button>
                    ` : ''}
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Issues Functions
        // Issue status configuration
        const issueStatusConfig = {
            'open': { label: 'Open', icon: 'fa-circle-exclamation', color: '#ef4444', bg: '#ef444420' },
            'follow-up': { label: 'Need Follow Up', icon: 'fa-clock', color: '#f59e0b', bg: '#f59e0b20' },
            'resolved': { label: 'Resolved', icon: 'fa-circle-check', color: '#10b981', bg: '#10b98120' }
        };

        // Current filter for issues
        let currentIssueStatusFilter = 'all';
        let currentIssueStoreFilter = 'all';
        let issuesFirebaseInitialized = false;
        let issuesViewMode = 'gallery'; // 'gallery' or 'table'

        async function renderIssues() {
            // Initialize Firebase for issues on first render
            if (!issuesFirebaseInitialized) {
                issuesFirebaseInitialized = true;
                await initializeFirebaseIssues();
            }
            const dashboard = document.querySelector('.dashboard');

            // Filter issues based on store filter first (for accurate counts)
            let storeFilteredIssues = [...issues];
            if (currentIssueStoreFilter !== 'all') {
                storeFilteredIssues = issues.filter(i => i.store === currentIssueStoreFilter);
            }

            // Count issues by status (after store filter)
            const openCount = storeFilteredIssues.filter(i => !i.status || i.status === 'open').length;
            const followUpCount = storeFilteredIssues.filter(i => i.status === 'follow-up').length;
            const resolvedCount = storeFilteredIssues.filter(i => i.status === 'resolved').length;

            // Filter issues based on status filter
            let filteredIssues = [...storeFilteredIssues];
            if (currentIssueStatusFilter !== 'all') {
                if (currentIssueStatusFilter === 'open') {
                    filteredIssues = storeFilteredIssues.filter(i => !i.status || i.status === 'open');
                } else {
                    filteredIssues = storeFilteredIssues.filter(i => i.status === currentIssueStatusFilter);
                }
            }

            // Sort issues by date, most recent first
            const sortedIssues = filteredIssues.sort((a, b) => new Date(b.incidentDate) - new Date(a.incidentDate));

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Issues Registry</h2>
                        <p class="section-subtitle">Customer incident documentation & follow-up tracking</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('create-issue')">
                        <i class="fas fa-plus"></i>
                        New Issue
                    </button>
                </div>

                <!-- Status Summary Cards -->
                <div class="issues-status-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="card" onclick="filterIssuesByStatus('open')" style="cursor: pointer; transition: all 0.2s; ${currentIssueStatusFilter === 'open' ? 'border: 2px solid #ef4444;' : ''}">
                        <div class="card-body" style="padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="width: 50px; height: 50px; background: #ef444420; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-circle-exclamation" style="font-size: 24px; color: #ef4444;"></i>
                            </div>
                            <div>
                                <div style="font-size: 28px; font-weight: 700; color: #ef4444;">${openCount}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Open</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" onclick="filterIssuesByStatus('follow-up')" style="cursor: pointer; transition: all 0.2s; ${currentIssueStatusFilter === 'follow-up' ? 'border: 2px solid #f59e0b;' : ''}">
                        <div class="card-body" style="padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="width: 50px; height: 50px; background: #f59e0b20; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-clock" style="font-size: 24px; color: #f59e0b;"></i>
                            </div>
                            <div>
                                <div style="font-size: 28px; font-weight: 700; color: #f59e0b;">${followUpCount}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Need Follow Up</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" onclick="filterIssuesByStatus('resolved')" style="cursor: pointer; transition: all 0.2s; ${currentIssueStatusFilter === 'resolved' ? 'border: 2px solid #10b981;' : ''}">
                        <div class="card-body" style="padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="width: 50px; height: 50px; background: #10b98120; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-circle-check" style="font-size: 24px; color: #10b981;"></i>
                            </div>
                            <div>
                                <div style="font-size: 28px; font-weight: 700; color: #10b981;">${resolvedCount}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Resolved</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" onclick="filterIssuesByStatus('all')" style="cursor: pointer; transition: all 0.2s; ${currentIssueStatusFilter === 'all' ? 'border: 2px solid var(--accent-primary);' : ''}">
                        <div class="card-body" style="padding: 20px; display: flex; align-items: center; gap: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--accent-primary)20; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-list" style="font-size: 24px; color: var(--accent-primary);"></i>
                            </div>
                            <div>
                                <div style="font-size: 28px; font-weight: 700; color: var(--accent-primary);">${storeFilteredIssues.length}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">All Issues</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Perception Chart -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header issues-card-header" style="flex-wrap: wrap; gap: 12px;">
                        <div>
                            <h3 class="card-title">
                                <i class="fas fa-smile"></i>
                                Customer Perception
                            </h3>
                            <span style="font-size: 13px; color: var(--text-muted);">How customers felt when leaving</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                            <select id="issue-store-filter" class="form-input" onchange="filterIssuesByStore(this.value)" style="width: 200px; padding: 8px 12px; font-size: 13px;">
                                <option value="all" ${currentIssueStoreFilter === 'all' ? 'selected' : ''}>All Stores</option>
                                <option value="Miramar" ${currentIssueStoreFilter === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                <option value="Morena" ${currentIssueStoreFilter === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                <option value="Kearny Mesa" ${currentIssueStoreFilter === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                <option value="Chula Vista" ${currentIssueStoreFilter === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                <option value="North Park" ${currentIssueStoreFilter === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                <option value="Miramar Wine & Liquor" ${currentIssueStoreFilter === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body issues-perception-chart">
                        ${renderPerceptionGanttChart()}
                    </div>
                </div>

                <!-- All Issues List -->
                <div class="card">
                    <div class="card-header" style="justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <h3 class="card-title">
                                <i class="fas fa-${issuesViewMode === 'gallery' ? 'th' : 'list'}"></i>
                                ${currentIssueStatusFilter === 'all' ? 'All Issues' : issueStatusConfig[currentIssueStatusFilter]?.label || 'Issues'}
                            </h3>
                            <span class="badge" style="background: var(--accent-primary);">${sortedIssues.length} ${sortedIssues.length === 1 ? 'Issue' : 'Issues'}</span>
                        </div>
                        <div class="view-toggle" style="display: flex; gap: 4px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 4px;">
                            <button class="view-toggle-btn ${issuesViewMode === 'gallery' ? 'active' : ''}" onclick="toggleIssuesView('gallery')" title="Gallery View">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="view-toggle-btn ${issuesViewMode === 'table' ? 'active' : ''}" onclick="toggleIssuesView('table')" title="Table View">
                                <i class="fas fa-table"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: ${issuesViewMode === 'gallery' ? '20px' : '0'};">
                        ${sortedIssues.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                No issues ${currentIssueStatusFilter !== 'all' ? 'with this status' : 'recorded yet'}
                            </div>
                        ` : issuesViewMode === 'table' ? `
                            <table class="data-table issues-table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Store</th>
                                        <th>Customer</th>
                                        <th>Phone</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Perception</th>
                                        <th style="width: 180px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedIssues.map(issue => {
                                        const status = issue.status || 'open';
                                        const statusConfig = issueStatusConfig[status] || issueStatusConfig['open'];
                                        return `
                                        <tr onclick="viewIssueDetails('${issue.firestoreId || issue.id}')" style="cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                            <td data-label="Status">
                                                <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: ${statusConfig.bg}; color: ${statusConfig.color}; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                                    <i class="fas ${statusConfig.icon}"></i>
                                                    ${statusConfig.label}
                                                </span>
                                            </td>
                                            <td data-label="Date" style="white-space: nowrap;">${formatDate(issue.incidentDate)}</td>
                                            <td data-label="Store">
                                                ${issue.store ? `
                                                    <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-secondary);">
                                                        <i class="fas fa-store" style="color: var(--accent-primary);"></i>
                                                        ${issue.store}
                                                    </span>
                                                ` : '<span style="color: var(--text-muted);">-</span>'}
                                            </td>
                                            <td data-label="Customer"><strong>${issue.customer}</strong></td>
                                            <td data-label="Phone">
                                                ${issue.phone ? `<a href="tel:${issue.phone}" style="color: var(--accent-primary); text-decoration: none;"><i class="fas fa-phone"></i> ${issue.phone}</a>` : '-'}
                                            </td>
                                            <td data-label="Type">
                                                <span class="badge" style="background: ${issue.type === 'In Store' ? 'var(--accent-primary)' : 'var(--info)'};">
                                                    <i class="fas fa-${issue.type === 'In Store' ? 'store' : 'globe'}"></i>
                                                    ${issue.type}
                                                </span>
                                            </td>
                                            <td data-label="Description" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${issue.description || '-'}</td>
                                            <td data-label="Perception" style="text-align: center; font-size: 24px;">
                                                ${issue.perception ? getPerceptionEmoji(issue.perception) : '-'}
                                            </td>
                                            <td data-label="Actions" onclick="event.stopPropagation()">
                                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                                    ${status !== 'follow-up' ? `
                                                        <button class="btn-icon" onclick="event.stopPropagation(); updateIssueStatus('${issue.firestoreId || issue.id}', 'follow-up')" title="Mark as Need Follow Up" style="background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b50;">
                                                            <i class="fas fa-clock"></i>
                                                        </button>
                                                    ` : ''}
                                                    ${status !== 'resolved' ? `
                                                        <button class="btn-icon" onclick="event.stopPropagation(); updateIssueStatus('${issue.firestoreId || issue.id}', 'resolved')" title="Mark as Resolved" style="background: #10b98120; color: #10b981; border: 1px solid #10b98150;">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    ` : ''}
                                                    ${status !== 'open' ? `
                                                        <button class="btn-icon" onclick="event.stopPropagation(); updateIssueStatus('${issue.firestoreId || issue.id}', 'open')" title="Reopen Issue" style="background: #ef444420; color: #ef4444; border: 1px solid #ef444450;">
                                                            <i class="fas fa-rotate-left"></i>
                                                        </button>
                                                    ` : ''}
                                                    <button class="btn-icon" onclick="event.stopPropagation(); viewIssueDetails('${issue.firestoreId || issue.id}')" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn-icon danger" onclick="event.stopPropagation(); deleteIssue('${issue.firestoreId || issue.id}')" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <!-- Gallery View -->
                            <div class="issues-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                                ${sortedIssues.map(issue => {
                                    const status = issue.status || 'open';
                                    const statusConfig = issueStatusConfig[status] || issueStatusConfig['open'];
                                    return `
                                    <div class="issue-card" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden;" onclick="viewIssueDetails('${issue.firestoreId || issue.id}')">
                                        <!-- Status Badge -->
                                        <div style="position: absolute; top: 12px; right: 12px;">
                                            <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: ${statusConfig.bg}; color: ${statusConfig.color}; border-radius: 20px; font-size: 11px; font-weight: 600;">
                                                <i class="fas ${statusConfig.icon}"></i>
                                                ${statusConfig.label}
                                            </span>
                                        </div>

                                        <!-- Customer Info -->
                                        <div style="margin-bottom: 16px; padding-right: 80px;">
                                            <h4 style="font-size: 18px; font-weight: 600; margin: 0 0 4px 0; color: var(--text-primary);">${issue.customer}</h4>
                                            <div style="font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                                <span><i class="fas fa-calendar"></i> ${formatDate(issue.incidentDate)}</span>
                                                ${issue.store ? `<span><i class="fas fa-store"></i> ${issue.store}</span>` : ''}
                                            </div>
                                        </div>

                                        <!-- Issue Type -->
                                        <div style="margin-bottom: 12px;">
                                            <span class="badge" style="background: ${issue.type === 'In Store' ? 'var(--accent-primary)' : 'var(--info)'}; font-size: 11px;">
                                                <i class="fas fa-${issue.type === 'In Store' ? 'store' : 'globe'}"></i>
                                                ${issue.type}
                                            </span>
                                        </div>

                                        <!-- Description -->
                                        <div style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                            ${issue.description || 'No description provided'}
                                        </div>

                                        <!-- Customer Perception -->
                                        <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Customer Perception</div>
                                            <div style="font-size: 32px;">
                                                ${issue.perception ? getPerceptionEmoji(issue.perception) : '‚ùì'}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                                ${issue.perception ? getPerceptionLabel(issue.perception) : 'Not Set'}
                                            </div>
                                        </div>

                                        <!-- Contact Info -->
                                        ${issue.phone ? `
                                            <div style="margin-bottom: 16px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                                                <i class="fas fa-phone" style="color: var(--accent-primary);"></i>
                                                <a href="tel:${issue.phone}" style="color: var(--text-primary); text-decoration: none; font-size: 13px;" onclick="event.stopPropagation();">${issue.phone}</a>
                                            </div>
                                        ` : ''}

                                        <!-- Actions -->
                                        <div style="display: flex; gap: 6px; justify-content: space-between; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);" onclick="event.stopPropagation();">
                                            ${status !== 'follow-up' ? `
                                                <button class="btn-icon" onclick="updateIssueStatus('${issue.firestoreId || issue.id}', 'follow-up'); event.stopPropagation();" title="Mark as Need Follow Up" style="background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b50; flex: 1;">
                                                    <i class="fas fa-clock"></i>
                                                </button>
                                            ` : ''}
                                            ${status !== 'resolved' ? `
                                                <button class="btn-icon" onclick="updateIssueStatus('${issue.firestoreId || issue.id}', 'resolved'); event.stopPropagation();" title="Mark as Resolved" style="background: #10b98120; color: #10b981; border: 1px solid #10b98150; flex: 1;">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            ` : ''}
                                            ${status !== 'open' ? `
                                                <button class="btn-icon" onclick="updateIssueStatus('${issue.firestoreId || issue.id}', 'open'); event.stopPropagation();" title="Reopen Issue" style="background: #ef444420; color: #ef4444; border: 1px solid #ef444450; flex: 1;">
                                                    <i class="fas fa-rotate-left"></i>
                                                </button>
                                            ` : ''}
                                            <button class="btn-icon danger" onclick="deleteIssue('${issue.firestoreId || issue.id}'); event.stopPropagation();" title="Delete" style="flex: 1;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    `}).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;

            // Update sidebar badge
            updateIssuesSidebarBadge();
        }

        // Toggle issues view mode
        function toggleIssuesView(mode) {
            issuesViewMode = mode;
            renderIssues();
        }

        // Filter issues by status
        function filterIssuesByStatus(status) {
            currentIssueStatusFilter = status;
            renderIssues();
        }

        // Filter issues by store
        function filterIssuesByStore(store) {
            currentIssueStoreFilter = store;
            renderIssues();
        }

        // Update issue status
        async function updateIssueStatus(issueId, newStatus) {
            const issue = issues.find(i => i.firestoreId === issueId || i.id === issueId);
            if (!issue) return;

            try {
                // Update locally
                issue.status = newStatus;
                if (!issue.statusHistory) issue.statusHistory = [];
                issue.statusHistory.push({
                    status: newStatus,
                    timestamp: new Date().toISOString(),
                    updatedBy: getCurrentUser()?.name || 'Unknown'
                });

                // Update in Firebase
                if (firebaseIssuesManager && firebaseIssuesManager.isInitialized && issue.firestoreId) {
                    await firebaseIssuesManager.updateIssue(issue.firestoreId, {
                        status: newStatus,
                        statusHistory: issue.statusHistory
                    });
                }

                renderIssues();

                const statusLabel = issueStatusConfig[newStatus]?.label || newStatus;
                showIssueToast(`Issue marked as "${statusLabel}"`, 'success');
            } catch (error) {
                console.error('Error updating issue status:', error);
                showIssueToast('Error updating status', 'error');
            }
        }

        // Update sidebar badge for issues needing follow up
        function updateIssuesSidebarBadge() {
            const followUpCount = issues.filter(i => i.status === 'follow-up').length;
            const openCount = issues.filter(i => !i.status || i.status === 'open').length;
            const totalPending = followUpCount + openCount;

            // Find the issues nav item
            const issuesNavItem = document.querySelector('.nav-item[data-page="issues"]');
            if (issuesNavItem) {
                // Remove existing badge
                const existingBadge = issuesNavItem.querySelector('.issues-badge');
                if (existingBadge) existingBadge.remove();

                // Add badge if there are pending issues
                if (totalPending > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'issues-badge';
                    badge.style.cssText = `
                        position: absolute;
                        right: 8px;
                        background: ${followUpCount > 0 ? '#f59e0b' : '#ef4444'};
                        color: white;
                        font-size: 11px;
                        font-weight: 700;
                        padding: 2px 6px;
                        border-radius: 10px;
                        min-width: 18px;
                        text-align: center;
                    `;
                    badge.textContent = totalPending;
                    issuesNavItem.style.position = 'relative';
                    issuesNavItem.appendChild(badge);
                }
            }
        }

        // Toast notification for issues
        function showIssueToast(message, type = 'info') {
            let toastContainer = document.getElementById('issue-toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'issue-toast-container';
                toastContainer.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            const colors = { success: '#10b981', error: '#ef4444', warning: '#f59e0b', info: '#3b82f6' };
            toast.style.cssText = `
                padding: 14px 20px;
                background: ${colors[type] || colors.info};
                color: white;
                border-radius: 10px;
                font-weight: 500;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                animation: issueSlideIn 0.3s ease;
            `;
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i> ${message}`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'issueSlideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add CSS for issue toast animations
        const issueToastStyles = document.createElement('style');
        issueToastStyles.textContent = `
            @keyframes issueSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
            @keyframes issueSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        `;
        document.head.appendChild(issueToastStyles);

        function selectPerception(value) {
            // Update hidden input
            document.getElementById('issue-perception').value = value;

            // Update button styles
            const buttons = document.querySelectorAll('.perception-btn');
            buttons.forEach(btn => {
                const btnValue = parseInt(btn.dataset.value);
                if (btnValue === value) {
                    btn.style.borderColor = 'var(--accent-primary)';
                    btn.style.background = 'rgba(99, 102, 241, 0.1)';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'var(--bg-secondary)';
                    btn.style.transform = 'scale(1)';
                }
            });
        }

        function getPerceptionEmoji(value) {
            const emojis = {
                1: 'üò°',
                2: 'üò†',
                3: 'üòê',
                4: 'üôÇ',
                5: 'üòä'
            };
            return emojis[value] || '‚ùì';
        }

        function getPerceptionLabel(value) {
            const labels = {
                1: 'Very Upset',
                2: 'Upset',
                3: 'Neutral',
                4: 'Satisfied',
                5: 'Happy'
            };
            return labels[value] || 'Unknown';
        }

        function getPerceptionColor(value) {
            const colors = {
                1: '#ef4444',
                2: '#f97316',
                3: '#eab308',
                4: '#22c55e',
                5: '#10b981'
            };
            return colors[value] || '#6b7280';
        }

        function renderPerceptionGanttChart() {
            // Get issues with perception data, filtered by store
            let issuesWithPerception = issues
                .filter(i => i.perception !== null && i.perception !== undefined);

            // Apply store filter
            if (currentIssueStoreFilter !== 'all') {
                issuesWithPerception = issuesWithPerception.filter(i => i.store === currentIssueStoreFilter);
            }

            // Determine the store label for display
            const storeLabel = currentIssueStoreFilter === 'all' ? 'All Stores' : `VSU ${currentIssueStoreFilter}`;

            if (issuesWithPerception.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                        <p>No perception data recorded yet</p>
                        <p style="font-size: 13px;">Create issues with customer perception to see the chart</p>
                    </div>
                `;
            }

            // Calculate perception distribution for filtered issues
            const perceptionCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            let totalSum = 0;
            issuesWithPerception.forEach(i => {
                if (perceptionCounts[i.perception] !== undefined) {
                    perceptionCounts[i.perception]++;
                    totalSum += i.perception;
                }
            });

            const total = issuesWithPerception.length;
            const average = total > 0 ? (totalSum / total) : 0;
            const averageRounded = Math.round(average * 10) / 10; // Round to 1 decimal
            const averageColor = getPerceptionColor(Math.round(average));
            const averageEmoji = getPerceptionEmoji(Math.round(average));
            const averagePercentage = (average / 5) * 100;

            return `
                <!-- Average Score Display -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 24px; margin-bottom: 24px; padding: 24px; background: linear-gradient(135deg, ${averageColor}15, ${averageColor}08); border: 2px solid ${averageColor}40; border-radius: 16px;">
                    <div style="text-align: center;">
                        <div style="font-size: 64px; line-height: 1;">${averageEmoji}</div>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;">Average Score for ${storeLabel}</div>
                        <div style="font-size: 48px; font-weight: 800; color: ${averageColor}; line-height: 1;">${averageRounded}</div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">out of 5.0 ¬∑ ${total} interactions</div>
                    </div>
                    <div style="flex: 1; max-width: 300px;">
                        <div style="background: var(--bg-tertiary); border-radius: 12px; height: 24px; overflow: hidden; position: relative;">
                            <div style="width: ${averagePercentage}%; height: 100%; background: linear-gradient(90deg, ${averageColor}88, ${averageColor}); border-radius: 12px; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: var(--text-muted);">
                            <span>1.0</span>
                            <span>5.0</span>
                        </div>
                    </div>
                </div>

                <!-- Perception Distribution -->
                <div style="margin-bottom: 16px;">
                    <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">
                        <i class="fas fa-chart-pie"></i> Perception Distribution
                    </h4>
                </div>

                <div class="perception-distribution-grid">
                    ${[1, 2, 3, 4, 5].map(level => {
                        const count = perceptionCounts[level];
                        const barHeight = total > 0 ? Math.max((count / Math.max(...Object.values(perceptionCounts))) * 100, 5) : 5;
                        return `
                            <div class="perception-item" style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size: 32px; margin-bottom: 8px;">${getPerceptionEmoji(level)}</div>
                                <div style="height: 60px; display: flex; align-items: flex-end; justify-content: center; margin-bottom: 8px;">
                                    <div style="width: 40px; height: ${barHeight}%; background: ${getPerceptionColor(level)}; border-radius: 6px 6px 0 0; min-height: 4px;"></div>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; color: ${getPerceptionColor(level)};">${count}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function createIssue() {
            const customer = document.getElementById('issue-customer').value.trim();
            const phone = document.getElementById('issue-phone').value.trim();
            const type = document.getElementById('issue-type').value;
            const store = document.getElementById('issue-store').value;
            const description = document.getElementById('issue-description').value.trim();
            const incidentDate = document.getElementById('issue-incident-date').value;
            const perception = document.getElementById('issue-perception').value;

            // Get current user
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

            const newIssue = {
                customer: customer || 'Anonymous',
                phone: phone || '',
                type: type || 'In Store',
                store: store || '',
                description: description || '',
                incidentDate: incidentDate || new Date().toISOString().split('T')[0],
                perception: perception ? parseInt(perception) : null,
                status: 'open',
                createdBy: user?.name || 'Unknown',
                createdDate: new Date().toISOString().split('T')[0],
                solution: null,
                resolvedBy: null,
                resolutionDate: null
            };

            // Try to save to Firebase
            if (typeof firebaseIssuesManager !== 'undefined' && firebaseIssuesManager.isInitialized) {
                const firestoreId = await firebaseIssuesManager.addIssue(newIssue);
                if (firestoreId) {
                    newIssue.id = firestoreId;
                    newIssue.firestoreId = firestoreId;
                    issues.unshift(newIssue);
                    closeModal();
                    renderIssues();
                    return;
                }
            }

            // Fallback to local storage
            newIssue.id = issues.length > 0 ? Math.max(...issues.map(i => typeof i.id === 'number' ? i.id : 0)) + 1 : 1;
            issues.unshift(newIssue);
            closeModal();
            renderIssues();
        }

        function deleteIssue(issueId) {
            const issue = issues.find(i => String(i.id) === String(issueId) || i.firestoreId === issueId);
            const customerName = issue?.customer || 'this issue';

            showConfirmModal({
                title: 'Delete Issue',
                message: `Are you sure you want to delete the issue reported by "${customerName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    // Try to delete from Firebase using firestoreId
                    if (typeof firebaseIssuesManager !== 'undefined' && firebaseIssuesManager.isInitialized && issue?.firestoreId) {
                        const success = await firebaseIssuesManager.deleteIssue(issue.firestoreId);
                        if (success) {
                            issues = issues.filter(i => i.firestoreId !== issue.firestoreId);
                            showNotification('Issue deleted successfully', 'success');
                            renderIssues();
                            return;
                        } else {
                            showNotification('Failed to delete issue from Firebase', 'error');
                            return;
                        }
                    }

                    // Fallback to local deletion
                    issues = issues.filter(i => String(i.id) !== String(issueId) && i.firestoreId !== issueId);
                    showNotification('Issue deleted locally', 'success');
                    renderIssues();
                }
            });
        }

        async function resolveIssue(issueId) {
            const solution = document.getElementById('issue-solution').value.trim();
            const resolvedBy = document.getElementById('issue-resolved-by').value.trim();

            if (!solution || !resolvedBy) {
                alert('Please fill in all required fields');
                return;
            }

            const issue = issues.find(i => String(i.id) === String(issueId) || i.firestoreId === issueId);
            if (!issue) return;

            const updateData = {
                status: 'resolved',
                solution: solution,
                resolvedBy: resolvedBy,
                resolutionDate: new Date().toISOString().split('T')[0]
            };

            // Try to update in Firebase
            const firestoreId = issue.firestoreId || issueId;
            if (typeof firebaseIssuesManager !== 'undefined' && firebaseIssuesManager.isInitialized && firestoreId) {
                const success = await firebaseIssuesManager.updateIssue(firestoreId, updateData);
                if (success) {
                    // Update local data
                    Object.assign(issue, updateData);
                    closeModal();
                    renderIssues();
                    return;
                }
            }

            // Fallback to local update
            Object.assign(issue, updateData);
            closeModal();
            renderIssues();
        }

        function viewIssueDetails(issueId) {
            const issue = issues.find(i => String(i.id) === String(issueId) || i.firestoreId === issueId);
            if (!issue) {
                console.error('Issue not found:', issueId);
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const status = issue.status || 'open';
            const statusConfig = issueStatusConfig[status] || issueStatusConfig['open'];

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-info-circle"></i> Issue Details</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Customer Name</div>
                                <div style="font-size: 18px; font-weight: 600;">${issue.customer}</div>
                            </div>
                            <span style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: ${statusConfig.bg}; color: ${statusConfig.color}; border-radius: 20px; font-size: 14px; font-weight: 600;">
                                <i class="fas ${statusConfig.icon}"></i>
                                ${statusConfig.label}
                            </span>
                        </div>

                        <!-- Quick Status Actions -->
                        <div style="display: flex; gap: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <span style="color: var(--text-muted); font-size: 13px; display: flex; align-items: center;">Change Status:</span>
                            ${status !== 'open' ? `
                                <button onclick="updateIssueStatusFromModal('${issue.firestoreId || issue.id}', 'open')" style="padding: 6px 12px; background: #ef444420; color: #ef4444; border: 1px solid #ef444450; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-circle-exclamation"></i> Open
                                </button>
                            ` : ''}
                            ${status !== 'follow-up' ? `
                                <button onclick="updateIssueStatusFromModal('${issue.firestoreId || issue.id}', 'follow-up')" style="padding: 6px 12px; background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b50; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-clock"></i> Need Follow Up
                                </button>
                            ` : ''}
                            ${status !== 'resolved' ? `
                                <button onclick="updateIssueStatusFromModal('${issue.firestoreId || issue.id}', 'resolved')" style="padding: 6px 12px; background: #10b98120; color: #10b981; border: 1px solid #10b98150; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-circle-check"></i> Resolved
                                </button>
                            ` : ''}
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Phone Number</div>
                                <div style="font-weight: 500;">${issue.phone ? `<a href="tel:${issue.phone}" style="color: var(--accent-primary); text-decoration: none;"><i class="fas fa-phone"></i> ${issue.phone}</a>` : '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Store</div>
                                <div style="font-weight: 500;">
                                    ${issue.store ? `<span style="display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-store" style="color: var(--accent-primary);"></i> ${issue.store}</span>` : '-'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Issue Type</div>
                                <span class="badge" style="background: ${issue.type === 'In Store' ? 'var(--accent-primary)' : 'var(--info)'};">
                                    <i class="fas fa-${issue.type === 'In Store' ? 'store' : 'globe'}"></i>
                                    ${issue.type}
                                </span>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Incident Date</div>
                                <div style="font-weight: 500;">${formatDate(issue.incidentDate)}</div>
                            </div>
                        </div>

                        <!-- Editable Customer Perception -->
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-size: 13px; color: var(--text-muted);">Customer Perception</div>
                                <button onclick="togglePerceptionEdit('${issue.firestoreId || issue.id}')" class="btn-secondary" style="padding: 4px 10px; font-size: 12px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>

                            <!-- Current Perception Display -->
                            <div id="perception-display-${issue.firestoreId || issue.id}" style="text-align: center;">
                                ${issue.perception ? `
                                    <div style="font-size: 48px;">${getPerceptionEmoji(issue.perception)}</div>
                                    <div style="font-size: 14px; font-weight: 500; margin-top: 4px;">${getPerceptionLabel(issue.perception)}</div>
                                ` : `
                                    <div style="color: var(--text-muted); padding: 16px;">No perception recorded</div>
                                `}
                            </div>

                            <!-- Perception Editor (hidden by default) -->
                            <div id="perception-edit-${issue.firestoreId || issue.id}" style="display: none;">
                                <div style="display: flex; justify-content: space-between; gap: 8px; margin-bottom: 12px;">
                                    ${[1, 2, 3, 4, 5].map(level => `
                                        <button type="button"
                                            class="perception-edit-btn"
                                            data-issue-id="${issue.firestoreId || issue.id}"
                                            data-value="${level}"
                                            onclick="selectPerceptionForEdit('${issue.firestoreId || issue.id}', ${level})"
                                            style="flex: 1; padding: 12px 8px; border: 2px solid ${issue.perception === level ? 'var(--accent-primary)' : 'var(--border-color)'}; border-radius: 12px; background: ${issue.perception === level ? 'rgba(99, 102, 241, 0.1)' : 'var(--bg-tertiary)'}; cursor: pointer; transition: all 0.2s; transform: ${issue.perception === level ? 'scale(1.05)' : 'scale(1)'};">
                                            <div style="font-size: 28px; margin-bottom: 4px;">${getPerceptionEmoji(level)}</div>
                                            <div style="font-size: 10px; color: var(--text-muted);">${getPerceptionLabel(level)}</div>
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="perception-value-${issue.firestoreId || issue.id}" value="${issue.perception || ''}">
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <button onclick="savePerceptionEdit('${issue.firestoreId || issue.id}')" class="btn-primary" style="padding: 8px 16px;">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                    <button onclick="togglePerceptionEdit('${issue.firestoreId || issue.id}')" class="btn-secondary" style="padding: 8px 16px;">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Description</div>
                            <div style="font-size: 14px; line-height: 1.6;">${issue.description}</div>
                        </div>

                        <!-- Follow Up Notes Section -->
                        <div style="border: 2px solid ${status === 'follow-up' ? '#f59e0b' : 'var(--border-color)'}; border-radius: 8px; padding: 16px; ${status === 'follow-up' ? 'background: #f59e0b08;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-size: 14px; font-weight: 600; color: ${status === 'follow-up' ? '#f59e0b' : 'var(--text-primary)'};">
                                    <i class="fas fa-sticky-note"></i> Follow Up Notes
                                </div>
                            </div>
                            <textarea id="issue-followup-notes" class="form-input" placeholder="Add notes about follow-up actions, calls made, updates..." style="min-height: 80px; resize: vertical;">${issue.followUpNotes || ''}</textarea>
                            <button onclick="saveFollowUpNotes('${issue.firestoreId || issue.id}')" class="btn-secondary" style="margin-top: 8px;">
                                <i class="fas fa-save"></i> Save Notes
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Created By</div>
                                <div style="font-weight: 500;">${issue.createdBy}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Created Date</div>
                                <div style="font-weight: 500;">${formatDate(issue.createdDate)}</div>
                            </div>
                        </div>

                        ${issue.status === 'resolved' && issue.solution ? `
                            <div style="border-top: 2px solid var(--border-color); padding-top: 16px; margin-top: 8px;">
                                <h3 style="font-size: 16px; margin-bottom: 16px; color: var(--success);">
                                    <i class="fas fa-check-circle"></i> Resolution Details
                                </h3>

                                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">How it was resolved</div>
                                    <div style="font-size: 14px; line-height: 1.6;">${issue.solution}</div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Resolved By</div>
                                        <div style="font-weight: 600; color: var(--success);">${issue.resolvedBy || '-'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Resolution Date</div>
                                        <div style="font-weight: 600; color: var(--success);">${issue.resolutionDate ? formatDate(issue.resolutionDate) : '-'}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${issue.statusHistory && issue.statusHistory.length > 0 ? `
                            <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 8px;">
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                    <i class="fas fa-history"></i> Status History
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px; max-height: 150px; overflow-y: auto;">
                                    ${issue.statusHistory.slice().reverse().map(h => {
                                        const hConfig = issueStatusConfig[h.status] || issueStatusConfig['open'];
                                        return `
                                            <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 6px 10px; background: var(--bg-tertiary); border-radius: 6px;">
                                                <span style="color: ${hConfig.color};"><i class="fas ${hConfig.icon}"></i></span>
                                                <span style="font-weight: 500;">${hConfig.label}</span>
                                                <span style="color: var(--text-muted);">by ${h.updatedBy}</span>
                                                <span style="color: var(--text-muted); margin-left: auto;">${new Date(h.timestamp).toLocaleString()}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                    <button class="btn-primary" onclick="editIssueDetails('${issue.firestoreId || issue.id}')">
                        <i class="fas fa-edit"></i> Edit Issue
                    </button>
                    <button class="btn-primary" onclick="closeModal()" style="background: var(--success);">
                        <i class="fas fa-check"></i> Accept
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Edit issue details modal
        function editIssueDetails(issueId) {
            const issue = issues.find(i => String(i.id) === String(issueId) || i.firestoreId === issueId);
            if (!issue) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-edit"></i> Edit Issue</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-input" id="edit-issue-customer" value="${issue.customer || ''}" placeholder="Customer name">
                            </div>
                            <div>
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" id="edit-issue-phone" value="${issue.phone || ''}" placeholder="Phone number">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Store</label>
                                <select class="form-input" id="edit-issue-store">
                                    <option value="" ${!issue.store ? 'selected' : ''}>Select Store</option>
                                    <option value="Miramar" ${issue.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                    <option value="Morena" ${issue.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                    <option value="Kearny Mesa" ${issue.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                    <option value="Chula Vista" ${issue.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                    <option value="North Park" ${issue.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                    <option value="Miramar Wine & Liquor" ${issue.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Issue Type</label>
                                <select class="form-input" id="edit-issue-type">
                                    <option value="In Store" ${issue.type === 'In Store' ? 'selected' : ''}>In Store</option>
                                    <option value="Online" ${issue.type === 'Online' ? 'selected' : ''}>Online</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Incident Date</label>
                            <input type="date" class="form-input" id="edit-issue-incident-date" value="${issue.incidentDate || ''}">
                        </div>

                        <div>
                            <label class="form-label">Description</label>
                            <textarea class="form-input" id="edit-issue-description" rows="4" placeholder="Describe the issue...">${issue.description || ''}</textarea>
                        </div>

                        <div>
                            <label class="form-label">Customer Perception</label>
                            <div style="display: flex; justify-content: space-between; gap: 8px;">
                                ${[1, 2, 3, 4, 5].map(level => `
                                    <button type="button"
                                        class="edit-issue-perception-btn"
                                        data-value="${level}"
                                        onclick="selectEditIssuePerception(${level})"
                                        style="flex: 1; padding: 12px 8px; border: 2px solid ${issue.perception === level ? 'var(--accent-primary)' : 'var(--border-color)'}; border-radius: 12px; background: ${issue.perception === level ? 'rgba(99, 102, 241, 0.1)' : 'var(--bg-secondary)'}; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 28px; margin-bottom: 4px;">${getPerceptionEmoji(level)}</div>
                                        <div style="font-size: 10px; color: var(--text-muted);">${getPerceptionLabel(level)}</div>
                                    </button>
                                `).join('')}
                            </div>
                            <input type="hidden" id="edit-issue-perception" value="${issue.perception || ''}">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="viewIssueDetails('${issueId}')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn-primary" onclick="saveIssueEdit('${issue.firestoreId || issue.id}')">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Select perception in edit mode
        function selectEditIssuePerception(level) {
            document.getElementById('edit-issue-perception').value = level;
            document.querySelectorAll('.edit-issue-perception-btn').forEach(btn => {
                const btnLevel = parseInt(btn.dataset.value);
                if (btnLevel === level) {
                    btn.style.borderColor = 'var(--accent-primary)';
                    btn.style.background = 'rgba(99, 102, 241, 0.1)';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'var(--bg-secondary)';
                }
            });
        }

        // Save issue edit
        async function saveIssueEdit(issueId) {
            const customer = document.getElementById('edit-issue-customer').value.trim();
            const phone = document.getElementById('edit-issue-phone').value.trim();
            const store = document.getElementById('edit-issue-store').value;
            const type = document.getElementById('edit-issue-type').value;
            const incidentDate = document.getElementById('edit-issue-incident-date').value;
            const description = document.getElementById('edit-issue-description').value.trim();
            const perception = document.getElementById('edit-issue-perception').value;

            // Find the issue to get the firestoreId
            const issue = issues.find(i => String(i.id) === String(issueId) || i.firestoreId === issueId);
            if (!issue) {
                showNotification('Issue not found', 'error');
                return;
            }

            const updateData = {
                customer: customer || 'Anonymous',
                phone: phone || '',
                store: store || '',
                type: type || 'In Store',
                incidentDate: incidentDate || '',
                description: description || '',
                perception: perception ? parseInt(perception) : null
            };

            // Update in Firebase using firestoreId
            if (typeof firebaseIssuesManager !== 'undefined' && firebaseIssuesManager.isInitialized && issue.firestoreId) {
                const success = await firebaseIssuesManager.updateIssue(issue.firestoreId, updateData);
                if (success) {
                    // Update local array
                    Object.assign(issue, updateData);
                    showNotification('Issue updated successfully', 'success');
                    closeModal();
                    renderIssues();
                    return;
                } else {
                    showNotification('Failed to update issue in Firebase', 'error');
                    return;
                }
            }

            // Fallback to local update if no Firebase
            Object.assign(issue, updateData);
            showNotification('Issue updated locally', 'success');
            closeModal();
            renderIssues();
        }

        // Update issue status from modal
        async function updateIssueStatusFromModal(issueId, newStatus) {
            await updateIssueStatus(issueId, newStatus);
            viewIssueDetails(issueId); // Refresh modal
        }

        // Save follow up notes
        async function saveFollowUpNotes(issueId) {
            const issue = issues.find(i => i.firestoreId === issueId || i.id === issueId);
            if (!issue) return;

            const notes = document.getElementById('issue-followup-notes')?.value || '';

            try {
                issue.followUpNotes = notes;

                if (firebaseIssuesManager && firebaseIssuesManager.isInitialized && issue.firestoreId) {
                    await firebaseIssuesManager.updateIssue(issue.firestoreId, {
                        followUpNotes: notes
                    });
                }

                showIssueToast('Follow up notes saved!', 'success');
            } catch (error) {
                console.error('Error saving follow up notes:', error);
                showIssueToast('Error saving notes', 'error');
            }
        }

        // Toggle perception edit mode
        function togglePerceptionEdit(issueId) {
            const displayEl = document.getElementById(`perception-display-${issueId}`);
            const editEl = document.getElementById(`perception-edit-${issueId}`);

            if (displayEl && editEl) {
                if (editEl.style.display === 'none') {
                    displayEl.style.display = 'none';
                    editEl.style.display = 'block';
                } else {
                    displayEl.style.display = 'block';
                    editEl.style.display = 'none';
                }
            }
        }

        // Select perception value for editing
        function selectPerceptionForEdit(issueId, value) {
            // Update hidden input
            const hiddenInput = document.getElementById(`perception-value-${issueId}`);
            if (hiddenInput) {
                hiddenInput.value = value;
            }

            // Update button styles
            const buttons = document.querySelectorAll(`.perception-edit-btn[data-issue-id="${issueId}"]`);
            buttons.forEach(btn => {
                const btnValue = parseInt(btn.dataset.value);
                if (btnValue === value) {
                    btn.style.borderColor = 'var(--accent-primary)';
                    btn.style.background = 'rgba(99, 102, 241, 0.1)';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'var(--bg-tertiary)';
                    btn.style.transform = 'scale(1)';
                }
            });
        }

        // Save perception edit
        async function savePerceptionEdit(issueId) {
            const issue = issues.find(i => i.firestoreId === issueId || i.id === issueId);
            if (!issue) return;

            const hiddenInput = document.getElementById(`perception-value-${issueId}`);
            const newPerception = hiddenInput ? parseInt(hiddenInput.value) : null;

            if (!newPerception || newPerception < 1 || newPerception > 5) {
                showIssueToast('Please select a perception level', 'warning');
                return;
            }

            try {
                const oldPerception = issue.perception;
                issue.perception = newPerception;

                // Update in Firebase
                if (firebaseIssuesManager && firebaseIssuesManager.isInitialized && issue.firestoreId) {
                    await firebaseIssuesManager.updateIssue(issue.firestoreId, {
                        perception: newPerception
                    });
                }

                // Update the display
                const displayEl = document.getElementById(`perception-display-${issueId}`);
                if (displayEl) {
                    displayEl.innerHTML = `
                        <div style="font-size: 48px;">${getPerceptionEmoji(newPerception)}</div>
                        <div style="font-size: 14px; font-weight: 500; margin-top: 4px;">${getPerceptionLabel(newPerception)}</div>
                    `;
                }

                // Toggle back to display mode
                togglePerceptionEdit(issueId);

                // Re-render the issues list to update the chart
                renderIssues();

                // Re-open the modal to show updated data
                setTimeout(() => viewIssueDetails(issueId), 100);

                showIssueToast(`Perception updated: ${getPerceptionLabel(oldPerception || 0)} ‚Üí ${getPerceptionLabel(newPerception)}`, 'success');
            } catch (error) {
                console.error('Error saving perception:', error);
                showIssueToast('Error saving perception', 'error');
            }
        }

        // Vendors Functions
        let vendorSearchTerm = '';
        let vendorCategoryFilter = 'all';
        let vendorTypeFilter = 'all'; // 'all', 'vendor', 'service'
        let firebaseVendors = [];

        async function initVendors() {
            try {
                // Initialize Firebase if not already done
                if (!firebaseVendorsManager.isInitialized) {
                    console.log('Initializing Firebase Vendors Manager...');
                    await firebaseVendorsManager.initialize();
                }
                
                // Load vendors from Firebase
                if (firebaseVendorsManager.isInitialized) {
                    firebaseVendors = await firebaseVendorsManager.loadVendors();
                } else {
                    console.warn('‚ö†Ô∏è Firebase not initialized.');
                    firebaseVendors = [];
                }
            } catch (error) {
                console.error('Error loading vendors:', error);
                firebaseVendors = [];
            }
        }

        async function renderVendors() {
            const dashboard = document.querySelector('.dashboard');
            
            // Load vendors from Firebase
            try {
                await initVendors();
            } catch (error) {
                console.error('Error initializing vendors:', error);
            }

            const categories = [...new Set(firebaseVendors.map(v => v.category))];

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">Vendors & Suppliers</h2>
                        <p class="section-subtitle">Manage your supplier contacts and information</p>
                    </div>
                    <button class="btn-primary floating-add-btn" onclick="openAddVendorModal()">
                        <i class="fas fa-plus"></i>
                        Add Vendor
                    </button>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body">
                        <div class="vendor-type-filters" style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                            <button class="vendor-filter-btn ${vendorTypeFilter === 'all' ? 'active' : ''}" onclick="filterVendorsByType('all')">
                                <i class="fas fa-th-large"></i> All
                            </button>
                            <button class="vendor-filter-btn ${vendorTypeFilter === 'vendor' ? 'active' : ''}" onclick="filterVendorsByType('vendor')">
                                <i class="fas fa-truck"></i> Vendors
                            </button>
                            <button class="vendor-filter-btn ${vendorTypeFilter === 'service' ? 'active' : ''}" onclick="filterVendorsByType('service')">
                                <i class="fas fa-wrench"></i> Services
                            </button>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 250px;">
                                <div style="position: relative;">
                                    <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                                    <input
                                        type="text"
                                        class="form-input"
                                        placeholder="Search by vendor name..."
                                        style="padding-left: 40px;"
                                        oninput="searchVendors(this.value)"
                                        value="${vendorSearchTerm}"
                                    >
                                </div>
                            </div>
                            <div style="min-width: 200px;">
                                <select class="form-input" onchange="filterVendorsByCategory(this.value)">
                                    <option value="all" ${vendorCategoryFilter === 'all' ? 'selected' : ''}>All Categories</option>
                                    ${categories.map(cat => `
                                        <option value="${cat}" ${vendorCategoryFilter === cat ? 'selected' : ''}>${cat}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="vendors-list">
                    ${renderVendorsList()}
                </div>
            `;
        }

        function renderVendorsList() {
            let filteredVendors = firebaseVendors;

            // Apply type filter (vendor/service)
            if (vendorTypeFilter !== 'all') {
                filteredVendors = filteredVendors.filter(v => (v.type || 'vendor') === vendorTypeFilter);
            }

            // Apply category filter
            if (vendorCategoryFilter !== 'all') {
                filteredVendors = filteredVendors.filter(v => v.category === vendorCategoryFilter);
            }

            // Apply search filter
            if (vendorSearchTerm) {
                filteredVendors = filteredVendors.filter(v =>
                    v.name.toLowerCase().includes(vendorSearchTerm.toLowerCase()) ||
                    v.contact.toLowerCase().includes(vendorSearchTerm.toLowerCase()) ||
                    v.category.toLowerCase().includes(vendorSearchTerm.toLowerCase())
                );
            }

            if (filteredVendors.length === 0) {
                return `
                    <div class="card">
                        <div class="card-body" style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-search" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px; display: block;"></i>
                            <div style="font-size: 16px; color: var(--text-muted);">No vendors found</div>
                            <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Try adjusting your search or filter</div>
                        </div>
                    </div>
                `;
            }

            // Vibrant gradient colors for each category with better icons
            const categoryGradients = {
                'Vape Products': { from: '#667eea', to: '#764ba2', icon: 'fa-wind' },
                'Tobacco Products': { from: '#f093fb', to: '#f5576c', icon: 'fa-smoking' },
                'Beverages': { from: '#4facfe', to: '#00f2fe', icon: 'fa-bottle-water' },
                'Snacks & Candy': { from: '#fa709a', to: '#fee140', icon: 'fa-cookie-bite' },
                'Store Supplies': { from: '#38f9d7', to: '#43e97b', icon: 'fa-box-open' },
                'Glass & Accessories': { from: '#a855f7', to: '#6366f1', icon: 'fa-bong' },
                'CBD Products': { from: '#10b981', to: '#34d399', icon: 'fa-leaf' },
                'Delta Products': { from: '#f59e0b', to: '#fbbf24', icon: 'fa-cannabis' },
                'Kratom': { from: '#84cc16', to: '#a3e635', icon: 'fa-seedling' },
                'Electronics': { from: '#3b82f6', to: '#60a5fa', icon: 'fa-plug' },
                'Merchandise': { from: '#ec4899', to: '#f472b6', icon: 'fa-shirt' },
                'Services': { from: '#8b5cf6', to: '#a78bfa', icon: 'fa-wrench' },
                'Wholesale': { from: '#14b8a6', to: '#2dd4bf', icon: 'fa-warehouse' },
                'Distribution': { from: '#f97316', to: '#fb923c', icon: 'fa-truck-fast' },
                'Marketing': { from: '#06b6d4', to: '#22d3ee', icon: 'fa-bullhorn' },
                'Packaging': { from: '#78716c', to: '#a8a29e', icon: 'fa-box' },
                'Cleaning': { from: '#0ea5e9', to: '#38bdf8', icon: 'fa-spray-can-sparkles' },
                'Security': { from: '#dc2626', to: '#f87171', icon: 'fa-shield-halved' },
                'IT & Tech': { from: '#6366f1', to: '#818cf8', icon: 'fa-laptop-code' },
                'Legal': { from: '#475569', to: '#64748b', icon: 'fa-gavel' },
                'Accounting': { from: '#059669', to: '#34d399', icon: 'fa-calculator' },
                'Insurance': { from: '#7c3aed', to: '#a78bfa', icon: 'fa-umbrella' },
                'Products/Services': { from: '#8b5cf6', to: '#a78bfa', icon: 'fa-cubes' }
            };

            // Extra gradient colors for custom categories
            const customGradients = [
                { from: '#ff6b6b', to: '#feca57', icon: 'fa-store' },
                { from: '#5f27cd', to: '#48dbfb', icon: 'fa-gem' },
                { from: '#ff9ff3', to: '#ffeaa7', icon: 'fa-handshake' },
                { from: '#00d2d3', to: '#54a0ff', icon: 'fa-building' },
                { from: '#ff6b81', to: '#c44569', icon: 'fa-industry' },
                { from: '#a29bfe', to: '#6c5ce7', icon: 'fa-briefcase' },
                { from: '#fdcb6e', to: '#e17055', icon: 'fa-tags' }
            ];

            // Function to get gradient for any category (including custom)
            function getCategoryGradient(category) {
                if (categoryGradients[category]) return categoryGradients[category];
                // Generate consistent gradient for custom categories based on name
                const hash = category.split('').reduce((acc, char) => char.charCodeAt(0) + acc, 0);
                return customGradients[hash % customGradients.length];
            }

            // Simple color for backwards compatibility
            function getCategoryColor(category) {
                const gradient = getCategoryGradient(category);
                return gradient.from;
            }

            const typeColors = {
                'vendor': '#10b981',
                'service': '#8b5cf6'
            };

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    ${filteredVendors.map(vendor => {
                        const vendorType = vendor.type || 'vendor';
                        const typeLabel = vendorType === 'service' ? 'SERVICE PROVIDER' : 'VENDOR';
                        const typeColor = typeColors[vendorType] || typeColors['vendor'];
                        const vendorCategories = vendor.categories || (vendor.category ? [vendor.category] : ['General']);
                        const primaryCategory = vendorCategories[0] || 'General';
                        const gradient = getCategoryGradient(primaryCategory);
                        const categoryColor = gradient.from;
                        return `
                        <div class="card" style="cursor: pointer; transition: all 0.3s; overflow: hidden; border: none;" onclick="viewVendorDetails('${vendor.firestoreId}')" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px ${gradient.from}30';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                            <!-- Category/Service Banner - VIBRANT GRADIENT -->
                            <div style="background: linear-gradient(135deg, ${gradient.from}, ${gradient.to}); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; position: relative; overflow: hidden;">
                                <!-- Decorative circles -->
                                <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="position: absolute; bottom: -30px; right: 40px; width: 60px; height: 60px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>

                                <div style="flex: 1; z-index: 1;">
                                    <div style="font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.9); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px;">
                                        ${typeLabel}
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                        ${vendorCategories.map((cat, idx) => `
                                            <span style="font-size: ${idx === 0 ? '17px' : '11px'}; font-weight: ${idx === 0 ? '800' : '600'}; color: white; ${idx > 0 ? 'background: rgba(255,255,255,0.25); padding: 3px 10px; border-radius: 20px;' : ''} text-transform: uppercase; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                                ${cat}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; z-index: 1;">
                                    <i class="fas ${gradient.icon || (vendorType === 'service' ? 'fa-wrench' : 'fa-boxes-stacked')}" style="font-size: 22px; color: white;"></i>
                                </div>
                            </div>

                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 14px;">
                                    <div style="display: flex; align-items: center; gap: 14px; flex: 1;">
                                        <!-- Vendor Image -->
                                        <div style="width: 52px; height: 52px; border-radius: 12px; background: linear-gradient(135deg, ${gradient.from}20, ${gradient.to}20); border: 2px solid ${gradient.from}40; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${vendor.image
                                                ? `<img src="${vendor.image}" style="width: 100%; height: 100%; object-fit: cover;">`
                                                : `<i class="fas fa-building" style="font-size: 18px; color: ${gradient.from};"></i>`
                                            }
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 2px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                ${vendor.name}
                                            </h3>
                                            <div style="font-size: 13px; color: var(--text-muted);">
                                                ${vendor.products ? vendor.products.split(',').slice(0, 2).join(', ') + (vendor.products.split(',').length > 2 ? '...' : '') : 'Products/Services'}
                                            </div>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: var(--text-muted); font-size: 14px;"></i>
                                </div>

                                <div style="padding-top: 14px; border-top: 1px solid var(--border-color);">
                                    <div style="display: grid; gap: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <i class="fas fa-user" style="width: 16px; color: ${categoryColor};"></i>
                                            <span style="color: var(--text-secondary);">${vendor.contact || 'No contact'}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <i class="fas fa-phone" style="width: 16px; color: ${categoryColor};"></i>
                                            <span style="color: var(--text-secondary);">${vendor.phone || 'No phone'}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                            <i class="fas fa-envelope" style="width: 16px; color: ${categoryColor};"></i>
                                            <span style="color: var(--text-secondary);">${vendor.email || 'No email'}</span>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function searchVendors(searchTerm) {
            vendorSearchTerm = searchTerm;
            const vendorsList = document.getElementById('vendors-list');
            if (vendorsList) {
                vendorsList.innerHTML = renderVendorsList();
            }
        }

        function filterVendorsByCategory(category) {
            vendorCategoryFilter = category;
            const vendorsList = document.getElementById('vendors-list');
            if (vendorsList) {
                vendorsList.innerHTML = renderVendorsList();
            }
        }

        function filterVendorsByType(type) {
            vendorTypeFilter = type;
            // Update button active states
            document.querySelectorAll('.vendor-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            // Re-render the vendors list
            const vendorsList = document.getElementById('vendors-list');
            if (vendorsList) {
                vendorsList.innerHTML = renderVendorsList();
            }
        }

        function openAddVendorModal() {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-plus-circle"></i> Add New Vendor</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <!-- AI Scan Section -->
                    <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-wand-magic-sparkles" style="color: white; font-size: 14px;"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">AI Invoice Scanner</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Auto-fill vendor info from invoice/receipt</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <input type="file" id="vendorAiPhoto" accept="image/*" style="display: none;" onchange="scanVendorInvoiceWithAI(this)">
                                <button type="button" onclick="document.getElementById('vendorAiPhoto').click()" style="padding: 10px 16px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; color: white; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(139,92,246,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                                    <i class="fas fa-file-invoice"></i> Scan Invoice
                                </button>
                            </div>
                        </div>
                        <div id="vendor-ai-status" style="display: none; margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px;"></div>
                    </div>

                    <form id="add-vendor-form" style="display: grid; gap: 16px;">
                        <!-- Vendor Image Upload -->
                        <div>
                            <label class="form-label">Vendor Logo/Image</label>
                            <div style="display: flex; align-items: start; gap: 16px;">
                                <div id="vendor-image-preview" style="width: 100px; height: 100px; border-radius: 12px; border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden; flex-shrink: 0;">
                                    <i class="fas fa-building" style="font-size: 32px; color: var(--text-muted);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <input type="file" id="vendor-image" accept="image/*" style="display: none;" onchange="previewVendorImage(this, 'vendor-image-preview')">
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('vendor-image').click()" style="margin-bottom: 8px;">
                                        <i class="fas fa-upload"></i> Upload Image
                                    </button>
                                    <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Recommended: Square image, max 2MB</p>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Vendor Name</label>
                                <input type="text" id="vendor-name" class="form-input" placeholder="Enter vendor name">
                            </div>
                            <div>
                                <label class="form-label">Type</label>
                                <select id="vendor-type" class="form-input">
                                    <option value="vendor">Vendor</option>
                                    <option value="service">Service</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Categories (select all that apply)</label>
                            <div id="vendor-categories-container" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 14px;">
                                    <input type="checkbox" name="vendor-category" value="Vape Products"> Vape Products
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 14px;">
                                    <input type="checkbox" name="vendor-category" value="Tobacco Products"> Tobacco Products
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 14px;">
                                    <input type="checkbox" name="vendor-category" value="Beverages"> Beverages
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 14px;">
                                    <input type="checkbox" name="vendor-category" value="Snacks & Candy"> Snacks & Candy
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 14px;">
                                    <input type="checkbox" name="vendor-category" value="Store Supplies"> Store Supplies
                                </label>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="vendor-custom-category" class="form-input" placeholder="Add custom category..." style="flex: 1;">
                                <button type="button" class="btn-secondary" onclick="addCustomCategoryCheckbox('vendor-categories-container', 'vendor-custom-category')" style="white-space: nowrap;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Contact Person</label>
                            <input type="text" id="vendor-contact" class="form-input" placeholder="Enter contact name">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Phone</label>
                                <input type="tel" id="vendor-phone" class="form-input" placeholder="(800) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                            </div>
                            <div>
                                <label class="form-label">Email</label>
                                <input type="email" id="vendor-email" class="form-input" placeholder="contact@vendor.com">
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Website</label>
                            <input type="url" id="vendor-website" class="form-input" placeholder="https://www.vendor.com" pattern="https?://.+">
                        </div>

                        <div>
                            <label class="form-label">Access Information</label>
                            <textarea id="vendor-access" class="form-input" placeholder="Account details, login info, etc." style="min-height: 80px;"></textarea>
                        </div>

                        <div>
                            <label class="form-label">Products/Services</label>
                            <textarea id="vendor-products" class="form-input" placeholder="What products/services do you buy from this vendor?" style="min-height: 80px;"></textarea>
                        </div>

                        <div>
                            <label class="form-label">Order Methods</label>
                            <textarea id="vendor-order-methods" class="form-input" placeholder="How to order (phone, email, online, etc.)" style="min-height: 80px;"></textarea>
                        </div>

                        <div>
                            <label class="form-label">Additional Notes</label>
                            <textarea id="vendor-notes" class="form-input" placeholder="Payment terms, delivery schedule, discounts, etc." style="min-height: 80px;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" onclick="createVendor()">
                        <i class="fas fa-save"></i> Save Vendor
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;

            modal.classList.add('active');
        }

        /**
         * Preview vendor image before upload
         */
        function previewVendorImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (!preview) return;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Add custom category checkbox dynamically
        function addCustomCategoryCheckbox(containerId, inputId) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            const customCategory = input.value.trim();

            if (!customCategory) {
                alert('Please enter a category name');
                return;
            }

            // Check if category already exists
            const existingCheckboxes = container.querySelectorAll('input[type="checkbox"]');
            for (let cb of existingCheckboxes) {
                if (cb.value.toLowerCase() === customCategory.toLowerCase()) {
                    alert('This category already exists');
                    return;
                }
            }

            // Create new checkbox label
            const label = document.createElement('label');
            label.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 14px; border: 1px solid var(--accent-primary);';
            label.innerHTML = `
                <input type="checkbox" name="vendor-category" value="${customCategory}" checked> ${customCategory}
                <i class="fas fa-times" style="margin-left: 4px; color: var(--text-muted); cursor: pointer;" onclick="this.parentElement.remove(); event.stopPropagation();"></i>
            `;
            container.appendChild(label);
            input.value = '';
        }

        // Get all selected categories from checkboxes
        function getSelectedCategories(containerId) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function createVendor() {
            const name = document.getElementById('vendor-name').value.trim();
            const type = document.getElementById('vendor-type').value;

            // Get selected categories (multiple)
            const categories = getSelectedCategories('vendor-categories-container');
            // For backwards compatibility, also store first category as 'category'
            const category = categories.length > 0 ? categories[0] : '';

            if (categories.length === 0) {
                alert('Please select at least one category');
                return;
            }

            const contact = document.getElementById('vendor-contact').value.trim();
            const phone = document.getElementById('vendor-phone').value.trim();
            const email = document.getElementById('vendor-email').value.trim();
            const website = document.getElementById('vendor-website').value.trim();
            const access = document.getElementById('vendor-access').value.trim();
            const products = document.getElementById('vendor-products').value.trim();
            const orderMethods = document.getElementById('vendor-order-methods').value.trim();
            const notes = document.getElementById('vendor-notes').value.trim();
            const imageInput = document.getElementById('vendor-image');

            // Validate required field
            if (!name) {
                alert('Please enter a vendor name');
                return;
            }

            // Validate email format if provided
            if (email && !isValidEmail(email)) {
                alert('Please enter a valid email address (e.g., contact@company.com)');
                return;
            }

            // Validate website format if provided
            if (website && !isValidUrl(website)) {
                alert('Please enter a valid website URL (e.g., https://www.company.com)');
                return;
            }

            try {
                // Upload image to Firebase Storage if provided
                let imageUrl = null;
                let imagePath = null;
                if (imageInput.files && imageInput.files.length > 0) {
                    // Initialize storage helper if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    const rawBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageInput.files[0]);
                    });

                    try {
                        const tempId = Date.now().toString();
                        const uploadResult = await firebaseStorageHelper.uploadImage(
                            rawBase64,
                            'vendors/images',
                            tempId
                        );
                        imageUrl = uploadResult.url;
                        imagePath = uploadResult.path;
                    } catch (err) {
                        console.error('Error uploading vendor image to Storage:', err);
                        // Fallback to compressed base64 for Firestore
                        imageUrl = await compressImage(rawBase64);
                    }
                }

                const newVendor = {
                    name,
                    type,
                    category,           // First category for backwards compatibility
                    categories,         // Array of all selected categories
                    contact,
                    phone,
                    email,
                    website,
                    access,
                    products,
                    orderMethods,
                    notes,
                    image: imageUrl,      // Now stores URL instead of base64
                    imagePath: imagePath  // For future deletion
                };

                await firebaseVendorsManager.addVendor(newVendor);

                // Reload vendors
                firebaseVendors = await firebaseVendorsManager.loadVendors();
                closeModal();
                renderVendors();
            } catch (error) {
                console.error('Error creating vendor:', error);
                alert('Error creating vendor: ' + error.message);
            }
        }

        // Scan invoice/receipt with AI to auto-fill vendor information
        async function scanVendorInvoiceWithAI(input) {
            if (!input.files || !input.files[0]) return;

            const statusDiv = document.getElementById('vendor-ai-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #8b5cf6;"></i> <span style="color: var(--text-primary);">Analyzing invoice with AI...</span>';

            try {
                // Check for API key
                const apiKey = getOpenAIKey();
                if (!apiKey) {
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">Please configure your OpenAI API key in Project Analytics > Settings</span>';
                    return;
                }

                // Read the file as base64
                const file = input.files[0];
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: base64Image
                                        }
                                    },
                                    {
                                        type: 'text',
                                        text: `Analyze this invoice/receipt/bill image and extract vendor/supplier information. Return ONLY a JSON object with these fields (use null for any field you cannot find):

{
    "vendorName": "the company/vendor/supplier name",
    "contactPerson": "contact person name if visible",
    "phone": "phone number in format (XXX) XXX-XXXX",
    "email": "email address if visible",
    "website": "website URL if visible (include https://)",
    "category": "one of: Vape Products, Tobacco Products, Beverages, Snacks & Candy, Store Supplies",
    "type": "vendor or service",
    "products": "list of products/services mentioned on the invoice",
    "notes": "any relevant details like payment terms, account numbers, etc."
}

Category guidelines:
- Vape Products: vape supplies, e-liquids, vape hardware
- Tobacco Products: cigarettes, cigars, tobacco
- Beverages: drinks, sodas, energy drinks, water
- Snacks & Candy: food items, snacks, candy, chips
- Store Supplies: cleaning supplies, bags, equipment, office supplies

Type guidelines:
- vendor: sells physical products
- service: provides services (repairs, maintenance, utilities, etc.)

Return ONLY the JSON object, no additional text.`
                                    }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                // Parse the JSON response
                let vendorData;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        vendorData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    throw new Error('Could not parse vendor data from AI response');
                }

                // Fill in the form fields
                if (vendorData.vendorName) {
                    document.getElementById('vendor-name').value = vendorData.vendorName;
                }

                if (vendorData.type) {
                    const typeSelect = document.getElementById('vendor-type');
                    const typeValue = vendorData.type.toLowerCase();
                    if (typeValue === 'vendor' || typeValue === 'service') {
                        typeSelect.value = typeValue;
                    }
                }

                if (vendorData.category) {
                    const categorySelect = document.getElementById('vendor-category');
                    // Find matching option
                    for (let option of categorySelect.options) {
                        if (option.value.toLowerCase() === vendorData.category.toLowerCase() ||
                            option.value === vendorData.category) {
                            categorySelect.value = option.value;
                            break;
                        }
                    }
                }

                if (vendorData.contactPerson) {
                    document.getElementById('vendor-contact').value = vendorData.contactPerson;
                }

                if (vendorData.phone) {
                    document.getElementById('vendor-phone').value = vendorData.phone;
                }

                if (vendorData.email) {
                    document.getElementById('vendor-email').value = vendorData.email;
                }

                if (vendorData.website) {
                    document.getElementById('vendor-website').value = vendorData.website;
                }

                if (vendorData.products) {
                    document.getElementById('vendor-products').value = vendorData.products;
                }

                if (vendorData.notes) {
                    document.getElementById('vendor-notes').value = vendorData.notes;
                }

                // Auto-set the scanned image as the vendor logo
                const vendorImageInput = document.getElementById('vendor-image');
                const vendorImagePreview = document.getElementById('vendor-image-preview');

                if (vendorImageInput && file) {
                    // Create a new FileList with the scanned file
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    vendorImageInput.files = dataTransfer.files;

                    // Show preview in the container div
                    if (vendorImagePreview) {
                        vendorImagePreview.innerHTML = `<img src="${base64Image}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    }
                }

                // Show success message
                statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Vendor info extracted & image set as logo! Review and save.</span>';

            } catch (error) {
                console.error('Error scanning invoice with AI:', error);
                statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Error: ${error.message}</span>`;
            }

            // Don't clear the AI scan file input - keep it for reference
            // input.value = '';
        }

        async function viewVendorDetails(firestoreId) {
            const vendor = firebaseVendors.find(v => v.firestoreId === firestoreId);
            if (!vendor) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const categoryColors = {
                'Vape Products': '#6366f1',
                'Tobacco Products': '#8b5cf6',
                'Beverages': '#3b82f6',
                'Snacks & Candy': '#f59e0b',
                'Store Supplies': '#10b981'
            };

            const typeColors = {
                'vendor': '#10b981',
                'service': '#8b5cf6'
            };

            const vendorType = vendor.type || 'vendor';
            const typeLabel = vendorType === 'service' ? 'Service' : 'Vendor';
            const typeColor = typeColors[vendorType] || typeColors['vendor'];
            const typeIcon = vendorType === 'service' ? 'fa-wrench' : 'fa-truck';
            const vendorCategories = vendor.categories || (vendor.category ? [vendor.category] : ['General']);

            // Helper function for category colors in modal
            function getModalCategoryColor(category) {
                if (categoryColors[category]) return categoryColors[category];
                const customColors = ['#ef4444', '#ec4899', '#14b8a6', '#0ea5e9', '#84cc16', '#a855f7', '#f97316'];
                const hash = category.split('').reduce((acc, char) => char.charCodeAt(0) + acc, 0);
                return customColors[hash % customColors.length];
            }

            modalContent.innerHTML = `
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2><i class="fas ${typeIcon}"></i> ${vendor.name}</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn-primary" style="padding: 8px 14px; font-size: 13px;" onclick="closeModal(); setTimeout(() => editVendorModal('${vendor.firestoreId}'), 100);">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-danger" style="padding: 8px 14px; font-size: 13px;" onclick="deleteVendorConfirm('${vendor.firestoreId}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div style="display: grid; gap: 20px;">
                        <!-- Header with Image and Category -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                            <div style="width: 100px; height: 100px; border-radius: 16px; background: var(--bg-secondary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                ${vendor.image
                                    ? `<img src="${vendor.image}" style="width: 100%; height: 100%; object-fit: cover;">`
                                    : `<i class="fas fa-building" style="font-size: 40px; color: var(--text-muted);"></i>`
                                }
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                <span class="badge" style="background: ${typeColor}; font-size: 14px; padding: 8px 16px;">
                                    <i class="fas ${typeIcon}" style="margin-right: 6px;"></i>${typeLabel}
                                </span>
                                ${vendorCategories.map(cat => `
                                    <span class="badge" style="background: ${getModalCategoryColor(cat)}; font-size: 14px; padding: 8px 16px;">
                                        ${cat}
                                    </span>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                <i class="fas fa-address-book"></i> Contact Information
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-user" style="width: 20px; color: var(--text-muted);"></i>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Contact Person</div>
                                        <div style="font-weight: 500;">${vendor.contact}</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-phone" style="width: 20px; color: var(--text-muted);"></i>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Phone</div>
                                        <a href="tel:${vendor.phone}" style="font-weight: 500; color: var(--accent-primary); text-decoration: none;">${vendor.phone}</a>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-envelope" style="width: 20px; color: var(--text-muted);"></i>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Email</div>
                                        <a href="mailto:${vendor.email}" style="font-weight: 500; color: var(--accent-primary); text-decoration: none;">${vendor.email}</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Website & Access -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                <i class="fas fa-key"></i> Access Information
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                ${vendor.website ? `
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Website</div>
                                        <a href="${vendor.website}" target="_blank" style="color: var(--accent-primary); text-decoration: none; display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-external-link-alt"></i>
                                            ${vendor.website}
                                        </a>
                                    </div>
                                ` : ''}
                                ${vendor.access ? `
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Access Details</div>
                                        <div style="font-size: 14px; padding: 10px; background: var(--bg-primary); border-radius: 6px; font-family: monospace;">
                                            ${vendor.access}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Products -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                <i class="fas fa-boxes"></i> What We Buy
                            </h3>
                            <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                                ${vendor.products}
                            </div>
                        </div>

                        <!-- Order Methods -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                <i class="fas fa-shopping-cart"></i> How to Order
                            </h3>
                            <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                                ${vendor.orderMethods}
                            </div>
                        </div>

                        <!-- Notes -->
                        ${vendor.notes ? `
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                                <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 16px; color: var(--accent-primary);">
                                    <i class="fas fa-sticky-note"></i> Additional Notes
                                </h3>
                                <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                                    ${vendor.notes}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function editVendorModal(firestoreId) {
            const vendor = firebaseVendors.find(v => v.firestoreId === firestoreId);
            if (!vendor) return;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-edit"></i> Edit Vendor</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <form id="edit-vendor-form" style="display: grid; gap: 16px;">
                        <!-- Vendor Image Upload -->
                        <div>
                            <label class="form-label">Vendor Logo/Image</label>
                            <div style="display: flex; align-items: start; gap: 16px;">
                                <div id="edit-vendor-image-preview" style="width: 100px; height: 100px; border-radius: 12px; border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden; flex-shrink: 0;">
                                    ${vendor.image ? `<img src="${vendor.image}" style="width: 100%; height: 100%; object-fit: cover;">` : `<i class="fas fa-building" style="font-size: 32px; color: var(--text-muted);"></i>`}
                                </div>
                                <div style="flex: 1;">
                                    <input type="file" id="edit-vendor-image" accept="image/*" style="display: none;" onchange="previewVendorImage(this, 'edit-vendor-image-preview')">
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('edit-vendor-image').click()" style="margin-bottom: 8px;">
                                        <i class="fas fa-upload"></i> ${vendor.image ? 'Change Image' : 'Upload Image'}
                                    </button>
                                    ${vendor.image ? `<button type="button" class="btn-secondary" onclick="removeVendorImage('edit')" style="margin-left: 8px; margin-bottom: 8px;"><i class="fas fa-trash"></i></button>` : ''}
                                    <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Recommended: Square image, max 2MB</p>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Vendor Name</label>
                                <input type="text" id="edit-vendor-name" class="form-input" value="${vendor.name}" placeholder="Enter vendor name">
                            </div>
                            <div>
                                <label class="form-label">Type</label>
                                <select id="edit-vendor-type" class="form-input">
                                    <option value="vendor" ${vendor.type === 'vendor' || !vendor.type ? 'selected' : ''}>Vendor</option>
                                    <option value="service" ${vendor.type === 'service' ? 'selected' : ''}>Service</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Categories (select all that apply)</label>
                            ${(() => {
                                const predefinedCategories = ['Vape Products', 'Tobacco Products', 'Beverages', 'Snacks & Candy', 'Store Supplies'];
                                const vendorCategories = vendor.categories || (vendor.category ? [vendor.category] : []);
                                const customCategories = vendorCategories.filter(c => !predefinedCategories.includes(c));

                                return `
                                    <div id="edit-vendor-categories-container" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                                        ${predefinedCategories.map(cat => `
                                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 14px;">
                                                <input type="checkbox" name="edit-vendor-category" value="${cat}" ${vendorCategories.includes(cat) ? 'checked' : ''}> ${cat}
                                            </label>
                                        `).join('')}
                                        ${customCategories.map(cat => `
                                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: var(--bg-primary); border-radius: 6px; font-size: 14px; border: 1px solid var(--accent-primary);">
                                                <input type="checkbox" name="edit-vendor-category" value="${cat}" checked> ${cat}
                                                <i class="fas fa-times" style="margin-left: 4px; color: var(--text-muted); cursor: pointer;" onclick="this.parentElement.remove(); event.stopPropagation();"></i>
                                            </label>
                                        `).join('')}
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="text" id="edit-vendor-custom-category" class="form-input" placeholder="Add custom category..." style="flex: 1;">
                                        <button type="button" class="btn-secondary" onclick="addCustomCategoryCheckbox('edit-vendor-categories-container', 'edit-vendor-custom-category')" style="white-space: nowrap;">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                `;
                            })()}
                        </div>

                        <div>
                            <label class="form-label">Contact Person</label>
                            <input type="text" id="edit-vendor-contact" class="form-input" value="${vendor.contact}" placeholder="Enter contact name">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label class="form-label">Phone</label>
                                <input type="tel" id="edit-vendor-phone" class="form-input" value="${vendor.phone}" placeholder="(800) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                            </div>
                            <div>
                                <label class="form-label">Email</label>
                                <input type="email" id="edit-vendor-email" class="form-input" value="${vendor.email}" placeholder="contact@vendor.com">
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Website</label>
                            <input type="url" id="edit-vendor-website" class="form-input" value="${vendor.website || ''}" placeholder="https://www.vendor.com" pattern="https?://.+">
                        </div>

                        <div>
                            <label class="form-label">Access Information</label>
                            <textarea id="edit-vendor-access" class="form-input" placeholder="Account details, login info, etc." style="min-height: 80px;">${vendor.access || ''}</textarea>
                        </div>

                        <div>
                            <label class="form-label">Products/Services</label>
                            <textarea id="edit-vendor-products" class="form-input" placeholder="What products/services do you buy from this vendor?" style="min-height: 80px;">${vendor.products}</textarea>
                        </div>

                        <div>
                            <label class="form-label">Order Methods</label>
                            <textarea id="edit-vendor-order-methods" class="form-input" placeholder="How to order (phone, email, online, etc.)" style="min-height: 80px;">${vendor.orderMethods}</textarea>
                        </div>

                        <div>
                            <label class="form-label">Additional Notes</label>
                            <textarea id="edit-vendor-notes" class="form-input" placeholder="Payment terms, delivery schedule, discounts, etc." style="min-height: 80px;">${vendor.notes || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-primary" onclick="saveVendorChanges('${vendor.firestoreId}')">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                    <button class="btn-danger" onclick="deleteVendorConfirm('${vendor.firestoreId}')">
                        <i class="fas fa-trash"></i> Delete Vendor
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        /**
         * Remove vendor image from preview
         */
        function removeVendorImage(mode) {
            const previewId = mode === 'edit' ? 'edit-vendor-image-preview' : 'vendor-image-preview';
            const inputId = mode === 'edit' ? 'edit-vendor-image' : 'vendor-image';
            const preview = document.getElementById(previewId);
            const input = document.getElementById(inputId);

            if (preview) {
                preview.innerHTML = `<i class="fas fa-building" style="font-size: 32px; color: var(--text-muted);"></i>`;
                preview.setAttribute('data-removed', 'true');
            }
            if (input) {
                input.value = '';
            }
        }

        async function saveVendorChanges(firestoreId) {
            const name = document.getElementById('edit-vendor-name').value.trim();
            const type = document.getElementById('edit-vendor-type').value;

            // Get selected categories (multiple)
            const categories = getSelectedCategories('edit-vendor-categories-container');
            // For backwards compatibility, also store first category as 'category'
            const category = categories.length > 0 ? categories[0] : '';

            if (categories.length === 0) {
                alert('Please select at least one category');
                return;
            }

            const contact = document.getElementById('edit-vendor-contact').value.trim();
            const phone = document.getElementById('edit-vendor-phone').value.trim();
            const email = document.getElementById('edit-vendor-email').value.trim();
            const website = document.getElementById('edit-vendor-website').value.trim();
            const access = document.getElementById('edit-vendor-access').value.trim();
            const products = document.getElementById('edit-vendor-products').value.trim();
            const orderMethods = document.getElementById('edit-vendor-order-methods').value.trim();
            const notes = document.getElementById('edit-vendor-notes').value.trim();
            const imageInput = document.getElementById('edit-vendor-image');
            const imagePreview = document.getElementById('edit-vendor-image-preview');

            // Validate required field
            if (!name) {
                alert('Please enter a vendor name');
                return;
            }

            // Validate email format if provided
            if (email && !isValidEmail(email)) {
                alert('Please enter a valid email address (e.g., contact@company.com)');
                return;
            }

            // Validate website format if provided
            if (website && !isValidUrl(website)) {
                alert('Please enter a valid website URL (e.g., https://www.company.com)');
                return;
            }

            try {
                const existingVendor = firebaseVendors.find(v => v.firestoreId === firestoreId);

                // Determine image value
                let imageUrl = null;
                let imagePath = null;
                const wasRemoved = imagePreview?.getAttribute('data-removed') === 'true';

                if (wasRemoved) {
                    // Image was explicitly removed - delete from Storage if exists
                    if (existingVendor?.imagePath) {
                        try {
                            if (!firebaseStorageHelper.isInitialized) {
                                firebaseStorageHelper.initialize();
                            }
                            await firebaseStorageHelper.deleteFile(existingVendor.imagePath);
                        } catch (err) {
                            console.error('Error deleting old vendor image from Storage:', err);
                        }
                    }
                    imageUrl = null;
                    imagePath = null;
                } else if (imageInput?.files && imageInput.files.length > 0) {
                    // New image uploaded - upload to Firebase Storage
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    // Delete old image from Storage if exists
                    if (existingVendor?.imagePath) {
                        try {
                            await firebaseStorageHelper.deleteFile(existingVendor.imagePath);
                        } catch (err) {
                            console.error('Error deleting old vendor image from Storage:', err);
                        }
                    }

                    const rawBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageInput.files[0]);
                    });

                    try {
                        const uploadResult = await firebaseStorageHelper.uploadImage(
                            rawBase64,
                            'vendors/images',
                            firestoreId
                        );
                        imageUrl = uploadResult.url;
                        imagePath = uploadResult.path;
                    } catch (err) {
                        console.error('Error uploading vendor image to Storage:', err);
                        // Fallback to compressed base64
                        imageUrl = await compressImage(rawBase64);
                    }
                } else {
                    // Keep existing image
                    imageUrl = existingVendor?.image || null;
                    imagePath = existingVendor?.imagePath || null;
                }

                const updateData = {
                    name,
                    type,
                    category,           // First category for backwards compatibility
                    categories,         // Array of all selected categories
                    contact,
                    phone,
                    email,
                    website,
                    access,
                    products,
                    orderMethods,
                    notes,
                    image: imageUrl,
                    imagePath: imagePath
                };

                await firebaseVendorsManager.updateVendor(firestoreId, updateData);

                // Reload vendors
                firebaseVendors = await firebaseVendorsManager.loadVendors();
                closeModal();
                renderVendors();
            } catch (error) {
                console.error('Error updating vendor:', error);
                alert('Error updating vendor: ' + error.message);
            }
        }

        function deleteVendorConfirm(firestoreId) {
            const vendor = firebaseVendors.find(v => v.firestoreId === firestoreId);
            if (!vendor) return;

            showConfirmModal({
                title: 'Delete Vendor',
                message: `Are you sure you want to delete "${vendor.name}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: () => deleteVendor(firestoreId)
            });
        }

        async function deleteVendor(firestoreId) {
            try {
                await firebaseVendorsManager.deleteVendor(firestoreId);

                // Reload vendors
                firebaseVendors = await firebaseVendorsManager.loadVendors();
                closeModal();
                renderVendors();
            } catch (error) {
                console.error('Error deleting vendor:', error);
            }
        }

        // Helper functions
        function isValidUrl(string) {
            // Accept URLs with or without protocol
            // Valid: google.com, www.google.com, https://google.com
            const urlPattern = /^(https?:\/\/)?(www\.)?[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z]{2,})+([\/\w\-._~:?#[\]@!$&'()*+,;=]*)?$/;
            return urlPattern.test(string);
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function formatDate(dateStr) {
            // Format date string directly without using Date object to avoid timezone issues
            if (!dateStr) return '';

            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Handle Date objects
            if (dateStr instanceof Date) {
                const monthName = monthNames[dateStr.getMonth()];
                const dayNum = dateStr.getDate();
                const year = dateStr.getFullYear();
                return `${monthName} ${dayNum}, ${year}`;
            }

            // Handle Firestore Timestamp objects
            if (dateStr && typeof dateStr.toDate === 'function') {
                const date = dateStr.toDate();
                const monthName = monthNames[date.getMonth()];
                const dayNum = date.getDate();
                const year = date.getFullYear();
                return `${monthName} ${dayNum}, ${year}`;
            }

            // Handle string format "YYYY-MM-DD"
            if (typeof dateStr === 'string' && dateStr.includes('-')) {
                const [year, month, day] = dateStr.split('-');
                const monthIndex = parseInt(month, 10) - 1;
                const monthName = monthNames[monthIndex];
                const dayNum = parseInt(day, 10);
                return `${monthName} ${dayNum}, ${year}`;
            }

            return String(dateStr);
        }

        // Format phone number to US format (XXX) XXX-XXXX
        function formatPhoneNumber(input) {
            // Remove all non-digit characters
            let value = input.value.replace(/\D/g, '');

            // Limit to 10 digits
            if (value.length > 10) {
                value = value.substring(0, 10);
            }

            // Format the number
            if (value.length === 0) {
                input.value = '';
            } else if (value.length <= 3) {
                input.value = '(' + value;
            } else if (value.length <= 6) {
                input.value = '(' + value.substring(0, 3) + ') ' + value.substring(3);
            } else {
                input.value = '(' + value.substring(0, 3) + ') ' + value.substring(3, 6) + '-' + value.substring(6);
            }
        }

        // Helper function to extract emergency contact name from combined string
        function getEmergencyContactName(emergencyContact) {
            if (!emergencyContact) return '';
            // Format is typically "Name - (XXX) XXX-XXXX" or "Name - Phone"
            const parts = emergencyContact.split(' - ');
            return parts[0] || '';
        }

        // Helper function to extract emergency contact phone from combined string
        function getEmergencyContactPhone(emergencyContact) {
            if (!emergencyContact) return '';
            // Format is typically "Name - (XXX) XXX-XXXX" or "Name - Phone"
            const parts = emergencyContact.split(' - ');
            return parts[1] || '';
        }

        // Helper function to combine emergency contact name and phone
        function combineEmergencyContact(name, phone) {
            if (!name && !phone) return 'Not provided';
            if (!name) return phone;
            if (!phone) return name;
            return `${name} - ${phone}`;
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;

            // Determine icon based on type
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'error') icon = 'fa-exclamation-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';

            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;

            // Add to body
            document.body.appendChild(toast);

            // Show toast with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Variable to track employee being edited
        let editingEmployeeId = null;

        // Variables to store selected files for employee paperwork
        let selectedEmployeePaperworkFiles = [];
        let editEmployeePaperworkFiles = [];

        // Helper function to render existing paperwork
        function renderExistingPaperwork(employeeData) {
            const paperwork = employeeData.paperwork || [];
            if (paperwork.length === 0) {
                return '<p style="color: var(--text-muted); font-size: 14px; padding: 12px; background: var(--surface-secondary); border-radius: 8px;">No documents uploaded yet</p>';
            }

            return `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${paperwork.map((doc, index) => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <i class="fas ${getFileIcon(doc.fileType)}" style="color: var(--accent-primary); font-size: 18px;"></i>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${doc.fileName}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">
                                        ${doc.documentType || 'Document'} ‚Ä¢ ${formatFileSize(doc.fileSize)} ‚Ä¢ ${formatDate(doc.uploadedAt.toDate ? doc.uploadedAt.toDate() : doc.uploadedAt)}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-icon" onclick="showDocumentPreview({ url: '${doc.downloadURL}', fileName: '${doc.fileName}', fileType: '${doc.fileType || ''}', fileSize: ${doc.fileSize || 0}, documentType: '${doc.documentType || 'Document'}', uploadedAt: '${doc.uploadedAt?.toDate ? doc.uploadedAt.toDate().toISOString() : doc.uploadedAt}' })" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon danger" onclick="deleteEmployeePaperwork('${employeeData.id || employeeData.firestoreId}', '${doc.storagePath}', ${index})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Helper function to get file icon based on file type
        function getFileIcon(fileType) {
            if (!fileType) return 'fa-file';
            if (fileType.includes('pdf')) return 'fa-file-pdf';
            if (fileType.includes('word') || fileType.includes('doc')) return 'fa-file-word';
            if (fileType.includes('image') || fileType.includes('jpg') || fileType.includes('jpeg') || fileType.includes('png')) return 'fa-file-image';
            return 'fa-file';
        }

        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Handle file selection for add employee paperwork
        function handleEmployeePaperworkSelect(input) {
            const files = Array.from(input.files);
            const maxSize = 10 * 1024 * 1024; // 10MB

            // Validate files
            const validFiles = files.filter(file => {
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return false;
                }
                return true;
            });

            // Add to selected files
            selectedEmployeePaperworkFiles = [...selectedEmployeePaperworkFiles, ...validFiles];

            // Update UI
            updateEmployeePaperworkList();
        }

        // Handle file selection for edit employee paperwork
        function handleEditEmployeePaperworkSelect(input) {
            const files = Array.from(input.files);
            const maxSize = 10 * 1024 * 1024; // 10MB

            // Validate files
            const validFiles = files.filter(file => {
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return false;
                }
                return true;
            });

            // Add to selected files
            editEmployeePaperworkFiles = [...editEmployeePaperworkFiles, ...validFiles];

            // Update UI
            updateEditEmployeePaperworkList();
        }

        // Update paperwork list display for add employee
        function updateEmployeePaperworkList() {
            const listContainer = document.getElementById('emp-paperwork-list');
            if (!listContainer) return;

            if (selectedEmployeePaperworkFiles.length === 0) {
                listContainer.innerHTML = '';
                return;
            }

            listContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${selectedEmployeePaperworkFiles.map((file, index) => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas ${getFileIcon(file.type)}" style="color: var(--accent-primary); font-size: 18px;"></i>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${file.name}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${formatFileSize(file.size)}</div>
                                </div>
                            </div>
                            <button class="btn-icon danger" onclick="removeEmployeePaperwork(${index})" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Update paperwork list display for edit employee
        function updateEditEmployeePaperworkList() {
            const listContainer = document.getElementById('edit-emp-paperwork-list');
            if (!listContainer) return;

            if (editEmployeePaperworkFiles.length === 0) {
                listContainer.innerHTML = '';
                return;
            }

            listContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${editEmployeePaperworkFiles.map((file, index) => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas ${getFileIcon(file.type)}" style="color: var(--accent-primary); font-size: 18px;"></i>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${file.name}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${formatFileSize(file.size)}</div>
                                </div>
                            </div>
                            <button class="btn-icon danger" onclick="removeEditEmployeePaperwork(${index})" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Remove file from add employee paperwork list
        function removeEmployeePaperwork(index) {
            selectedEmployeePaperworkFiles.splice(index, 1);
            updateEmployeePaperworkList();
        }

        // Remove file from edit employee paperwork list
        function removeEditEmployeePaperwork(index) {
            editEmployeePaperworkFiles.splice(index, 1);
            updateEditEmployeePaperworkList();
        }

        // Delete existing employee paperwork
        async function deleteEmployeePaperwork(employeeId, storagePath, index) {
            if (!confirm('Are you sure you want to delete this document?')) {
                return;
            }

            try {
                const success = await firebaseEmployeeManager.deletePaperwork(employeeId, storagePath);
                if (success) {
                    showNotification('Document deleted successfully', 'success');
                    // Refresh the modal with updated data
                    const emp = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);
                    if (emp) {
                        // Reload employee data from Firebase
                        const updatedEmp = await firebaseEmployeeManager.getEmployee(employeeId);
                        if (updatedEmp) {
                            // Update local array
                            const localIndex = employees.findIndex(e => e.id === employeeId || e.firestoreId === employeeId);
                            if (localIndex !== -1) {
                                employees[localIndex] = updatedEmp;
                            }
                            // Re-render the existing paperwork section
                            const existingPaperworkDiv = document.getElementById('edit-emp-existing-paperwork');
                            if (existingPaperworkDiv) {
                                existingPaperworkDiv.innerHTML = renderExistingPaperwork(updatedEmp);
                            }
                        }
                    }
                } else {
                    alert('Failed to delete document. Please try again.');
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                alert('Error deleting document. Please try again.');
            }
        }

        function openModal(type, data = null) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            let content = '';
            switch(type) {
                case 'edit-employee':
                    if (!data) {
                        alert('No employee data provided');
                        return;
                    }
                    // Split name into first and last
                    const nameParts = data.name.split(' ');
                    const firstName = nameParts[0] || '';
                    const lastName = nameParts.slice(1).join(' ') || '';

                    content = `
                        <div class="modal-header">
                            <h2>Edit Employee</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- Profile Photo Section -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>Profile Photo</label>
                                <div style="display: flex; align-items: flex-start; gap: 16px;">
                                    <div id="edit-emp-photo-preview" style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px ${data.photo ? 'solid var(--accent-primary)' : 'dashed var(--border-color)'}; cursor: pointer;" onclick="document.getElementById('edit-emp-photo').click()">
                                        ${data.photo ? `<img src="${data.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : `<i class="fas fa-user" style="font-size: 40px; color: var(--text-muted);"></i>`}
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="edit-emp-photo" accept="image/*" style="display: none;" onchange="previewEditEmployeePhoto(this)">
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                                            <button type="button" class="btn-secondary" onclick="document.getElementById('edit-emp-photo').click()">
                                                <i class="fas fa-upload"></i> Upload
                                            </button>
                                            <button type="button" class="btn-secondary" onclick="openCameraModal('edit-emp-photo-preview', 'edit-emp-photo')">
                                                <i class="fas fa-camera"></i> Camera
                                            </button>
                                            <button type="button" class="btn-secondary" onclick="removeEditEmployeePhoto()">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">JPG, PNG (max 5MB). Photo will be cropped to circle.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="form-divider"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>First Name *</label>
                                    <input type="text" class="form-input" id="edit-emp-first-name" value="${firstName}" placeholder="John">
                                </div>
                                <div class="form-group">
                                    <label>Last Name *</label>
                                    <input type="text" class="form-input" id="edit-emp-last-name" value="${lastName}" placeholder="Doe">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Login Email *</label>
                                    <input type="email" class="form-input" id="edit-emp-email" value="${data.authEmail || data.email || ''}" placeholder="john@vsu.com">
                                </div>
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" class="form-input" id="edit-emp-phone" value="${data.phone || ''}" placeholder="(619) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Reset Password</label>
                                    <input type="password" class="form-input" id="edit-emp-password" placeholder="Enter new password to send reset email">
                                    <small style="color: var(--text-muted); font-size: 11px; margin-top: 4px; display: block;">
                                        <i class="fas fa-info-circle"></i> Entering a password will send a reset email to the employee
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label>Confirm Password</label>
                                    <input type="password" class="form-input" id="edit-emp-confirm-password" placeholder="Confirm new password">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Job Title *</label>
                                    <input type="text" class="form-input" id="edit-emp-role" value="${data.role || ''}" placeholder="e.g., Store Manager, Sales Associate...">
                                </div>
                                <div class="form-group">
                                    <label>Permission Level *</label>
                                    <select class="form-input" id="edit-emp-employee-type">
                                        <option value="">Select permission level...</option>
                                        <option value="admin" ${data.employeeType === 'admin' ? 'selected' : ''}>üëë Admin - Full System Access</option>
                                        <option value="manager" ${data.employeeType === 'manager' ? 'selected' : ''}>üìä Manager - Employee Management</option>
                                        <option value="employee" ${data.employeeType === 'employee' ? 'selected' : ''}>üë§ Employee - Limited Access</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="edit-emp-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar" ${data.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                        <option value="Morena" ${data.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                        <option value="Kearny Mesa" ${data.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                        <option value="Chula Vista" ${data.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                        <option value="North Park" ${data.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                        <option value="Miramar Wine & Liquor" ${data.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Status *</label>
                                    <select class="form-input" id="edit-emp-status">
                                        <option value="active" ${data.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="inactive" ${data.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Hire Date</label>
                                <input type="date" class="form-input" id="edit-emp-hire-date" value="${data.hireDate || ''}">
                            </div>
                            <div class="form-divider"></div>
                            <h3 class="form-section-title">Emergency Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Emergency Contact Name</label>
                                    <input type="text" class="form-input" id="edit-emp-emergency-name" value="${getEmergencyContactName(data.emergencyContact)}" placeholder="Contact name">
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Phone</label>
                                    <input type="tel" class="form-input" id="edit-emp-emergency-phone" value="${getEmergencyContactPhone(data.emergencyContact)}" placeholder="(555) 555-5555" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Allergies / Medical Notes</label>
                                <textarea class="form-input" id="edit-emp-allergies" rows="2" placeholder="Any allergies or medical conditions...">${data.allergies || ''}</textarea>
                            </div>
                            <div class="form-divider"></div>
                            <h3 class="form-section-title">Employee Paperwork</h3>
                            <div class="form-group">
                                <label>Existing Documents</label>
                                <div id="edit-emp-existing-paperwork" style="margin-bottom: 12px;">
                                    ${renderExistingPaperwork(data)}
                                </div>
                                <label>Upload New Documents <span style="font-size: 12px; color: var(--text-muted);">(ID, contracts, certificates, etc.)</span></label>
                                <div class="file-upload-area" id="edit-emp-paperwork-upload" onclick="document.getElementById('edit-emp-paperwork-files').click()">
                                    <input type="file" id="edit-emp-paperwork-files" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;" onchange="handleEditEmployeePaperworkSelect(this)">
                                    <div class="file-upload-content">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--accent-primary); margin-bottom: 8px;"></i>
                                        <span style="color: var(--text-secondary);">Click to upload or drag and drop</span>
                                        <span style="color: var(--text-muted); font-size: 12px;">PDF, DOC, DOCX, JPG, PNG files (max 10MB each)</span>
                                    </div>
                                </div>
                                <div id="edit-emp-paperwork-list" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveEditedEmployee()">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'offboarding':
                    const offboardingEmp = data;
                    content = `
                        <div class="modal-header">
                            <h2 style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-user-minus" style="color: #ef4444;"></i>
                                Employee Offboarding
                            </h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-info-circle" style="color: #ef4444;"></i>
                                    <span style="font-size: 13px; color: #991b1b;">Documenting exit for <strong>${offboardingEmp.name}</strong></span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Reason for Leaving *</label>
                                <select class="form-input" id="offboard-reason" required>
                                    <option value="">Select reason...</option>
                                    <option value="resignation">Resignation</option>
                                    <option value="termination">Termination</option>
                                    <option value="contract_end">End of Contract</option>
                                    <option value="abandonment">Job Abandonment</option>
                                    <option value="mutual">Mutual Agreement</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group" id="offboard-other-reason-container" style="display: none;">
                                <label>Specify Reason *</label>
                                <input type="text" class="form-input" id="offboard-other-reason" placeholder="Please specify...">
                            </div>
                            <div class="form-group">
                                <label>Last Day Worked *</label>
                                <input type="date" class="form-input" id="offboard-last-day" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>

                            <div class="form-divider"></div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="offboard-keys" style="width: 18px; height: 18px;">
                                    <span><i class="fas fa-key" style="color: var(--accent-primary); margin-right: 4px;"></i> Keys Returned</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label>Received By *</label>
                                <input type="text" class="form-input" id="offboard-received-by" placeholder="Name of person who received items" required>
                            </div>

                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-input" id="offboard-notes" rows="2" placeholder="Any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="cancelOffboarding()">Cancel</button>
                            <button class="btn-primary" style="background: #ef4444; border-color: #ef4444;" onclick="confirmOffboarding()">
                                <i class="fas fa-check"></i> Complete
                            </button>
                        </div>
                    `;

                    // Add event listener for reason change after modal renders
                    setTimeout(() => {
                        const reasonSelect = document.getElementById('offboard-reason');
                        if (reasonSelect) {
                            reasonSelect.addEventListener('change', function() {
                                const otherContainer = document.getElementById('offboard-other-reason-container');
                                otherContainer.style.display = this.value === 'other' ? 'block' : 'none';
                            });
                        }
                    }, 100);
                    break;
                case 'inactive-employees':
                    const inactiveEmps = data || [];
                    content = `
                        <div class="modal-header">
                            <h2 style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-user-slash" style="color: #ef4444;"></i>
                                Inactive Employees
                            </h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                            ${inactiveEmps.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px; color: var(--success);"></i>
                                    <p>No inactive employees</p>
                                </div>
                            ` : `
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    ${inactiveEmps.map(emp => {
                                        const empId = emp.firestoreId || emp.id;
                                        const hasOffboarding = emp.offboarding && emp.offboarding.reason;
                                        return `
                                            <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                                    <div style="display: flex; align-items: center; gap: 12px;">
                                                        <div class="avatar avatar-${emp.color || 'a'}" style="width: 40px; height: 40px; font-size: 14px;">${emp.initials || 'XX'}</div>
                                                        <div>
                                                            <div style="font-weight: 600; color: var(--text-primary);">${emp.name || 'Unknown'}</div>
                                                            <div style="font-size: 12px; color: var(--text-muted);">${emp.role || 'N/A'} - ${emp.store || 'N/A'}</div>
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 8px;">
                                                        ${hasOffboarding ? `
                                                            <button class="btn-secondary" onclick="viewOffboardingDetails('${empId}')" style="font-size: 12px; padding: 6px 12px;">
                                                                <i class="fas fa-file-alt"></i> View Details
                                                            </button>
                                                        ` : `
                                                            <span style="font-size: 11px; color: var(--text-muted); padding: 6px 12px;">No offboarding data</span>
                                                        `}
                                                        <button class="btn-icon success" onclick="activateEmployee('${empId}'); closeModal();" title="Reactivate">
                                                            <i class="fas fa-user-check"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                ${hasOffboarding ? `
                                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary);">
                                                        <span style="background: #fef2f2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-weight: 500;">
                                                            ${emp.offboarding.reasonText || emp.offboarding.reason}
                                                        </span>
                                                        <span style="margin-left: 12px;">Last day: ${formatDate(emp.offboarding.lastDayWorked)}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Close</button>
                        </div>
                    `;
                    break;
                case 'offboarding-details':
                    const offEmp = data;
                    const offData = offEmp.offboarding || {};
                    content = `
                        <div class="modal-header">
                            <h2 style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-file-alt" style="color: var(--accent-primary);"></i>
                                Offboarding Details
                            </h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div class="avatar avatar-${offEmp.color || 'a'}" style="width: 48px; height: 48px; font-size: 16px;">${offEmp.initials || 'XX'}</div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 18px; color: var(--text-primary);">${offEmp.name || 'Unknown'}</div>
                                        <div style="font-size: 13px; color: var(--text-muted);">${offEmp.role || 'N/A'} - ${offEmp.store || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>

                            <div style="display: grid; gap: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Reason for Leaving</label>
                                        <div style="background: #fef2f2; color: #991b1b; padding: 8px 12px; border-radius: 6px; font-weight: 500;">
                                            ${offData.reasonText || offData.reason || 'Not specified'}
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Last Day Worked</label>
                                        <div style="background: var(--bg-secondary); padding: 8px 12px; border-radius: 6px; font-weight: 500;">
                                            ${offData.lastDayWorked ? formatDate(offData.lastDayWorked) : 'Not specified'}
                                        </div>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Keys Returned</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i class="fas ${offData.keysReturned ? 'fa-check-circle' : 'fa-times-circle'}" style="color: ${offData.keysReturned ? 'var(--success)' : 'var(--danger)'}; font-size: 18px;"></i>
                                            <span>${offData.keysReturned ? 'Yes' : 'No'}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Received By</label>
                                        <div style="background: var(--bg-secondary); padding: 8px 12px; border-radius: 6px;">
                                            ${offData.receivedBy || 'Not specified'}
                                        </div>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Offboarding Date</label>
                                        <div style="background: var(--bg-secondary); padding: 8px 12px; border-radius: 6px;">
                                            ${offData.offboardingDate ? formatDate(offData.offboardingDate.split('T')[0]) : 'Not specified'}
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Processed By</label>
                                        <div style="background: var(--bg-secondary); padding: 8px 12px; border-radius: 6px;">
                                            ${offData.offboardingBy || 'Not specified'}
                                        </div>
                                    </div>
                                </div>

                                ${offData.notes ? `
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Notes</label>
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; white-space: pre-wrap;">
                                            ${offData.notes}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="openInactiveEmployeesModal()">
                                <i class="fas fa-arrow-left"></i> Back to List
                            </button>
                            <button class="btn-danger" onclick="confirmDeleteEmployee('${offEmp.firestoreId || offEmp.id}', '${offEmp.name.replace(/'/g, "\\'")}');" style="background: #dc2626; color: white;">
                                <i class="fas fa-trash-alt"></i> Delete Employee
                            </button>
                            <button class="btn-primary" onclick="activateEmployee('${offEmp.firestoreId || offEmp.id}'); closeModal();">
                                <i class="fas fa-user-check"></i> Reactivate Employee
                            </button>
                        </div>
                    `;
                    break;
                case 'add-employee':
                    content = `
                        <div class="modal-header">
                            <h2>Add New Employee</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- Profile Photo Section -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>Profile Photo</label>
                                <div style="display: flex; align-items: flex-start; gap: 16px;">
                                    <div id="emp-photo-preview" style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px dashed var(--border-color); cursor: pointer;" onclick="document.getElementById('emp-photo').click()">
                                        <i class="fas fa-user" style="font-size: 40px; color: var(--text-muted);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="emp-photo" accept="image/*" style="display: none;" onchange="previewEmployeePhoto(this)">
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                                            <button type="button" class="btn-secondary" onclick="document.getElementById('emp-photo').click()">
                                                <i class="fas fa-upload"></i> Upload
                                            </button>
                                            <button type="button" class="btn-secondary" onclick="openCameraModal('emp-photo-preview', 'emp-photo')">
                                                <i class="fas fa-camera"></i> Camera
                                            </button>
                                            <button type="button" class="btn-secondary" onclick="removeEmployeePhoto()">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">JPG, PNG (max 5MB). Photo will be cropped to circle.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="form-divider"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>First Name *</label>
                                    <input type="text" class="form-input" id="emp-first-name" placeholder="John">
                                </div>
                                <div class="form-group">
                                    <label>Last Name *</label>
                                    <input type="text" class="form-input" id="emp-last-name" placeholder="Doe">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" class="form-input" id="emp-email" placeholder="john@vsu.com">
                                </div>
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" class="form-input" id="emp-phone" placeholder="(619) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Password *</label>
                                    <div style="position: relative;">
                                        <input type="password" class="form-input" id="emp-password" placeholder="Enter a secure password" style="padding-right: 40px;">
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('emp-password', 'emp-password-toggle')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 18px; padding: 8px;">
                                            <i class="fas fa-eye" id="emp-password-toggle"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Confirm Password *</label>
                                    <div style="position: relative;">
                                        <input type="password" class="form-input" id="emp-confirm-password" placeholder="Confirm password" style="padding-right: 40px;">
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('emp-confirm-password', 'emp-confirm-password-toggle')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 18px; padding: 8px;">
                                            <i class="fas fa-eye" id="emp-confirm-password-toggle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Job Title *</label>
                                    <input type="text" class="form-input" id="emp-role" placeholder="e.g., Store Manager, Sales Associate...">
                                </div>
                                <div class="form-group">
                                    <label>Permission Level * <i class="fas fa-info-circle" style="color: var(--accent-primary); font-size: 12px; cursor: help;" title="Admin: Full access | Manager: Can manage employees | Employee: Limited access"></i></label>
                                    <select class="form-input" id="emp-employee-type">
                                        <option value="">Select permission level...</option>
                                        <option value="admin">üëë Admin - Full System Access</option>
                                        <option value="manager">üìä Manager - Employee Management</option>
                                        <option value="employee">üë§ Employee - Limited Access</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="emp-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Hire Date *</label>
                                    <input type="date" class="form-input" id="emp-hire-date">
                                </div>
                            </div>
                            <div class="form-divider"></div>
                            <h3 class="form-section-title">Emergency Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Emergency Contact Name</label>
                                    <input type="text" class="form-input" id="emp-emergency-name" placeholder="Contact name">
                                </div>
                                <div class="form-group">
                                    <label>Emergency Contact Phone</label>
                                    <input type="tel" class="form-input" id="emp-emergency-phone" placeholder="(555) 555-5555" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Allergies / Medical Notes</label>
                                <textarea class="form-input" id="emp-allergies" rows="2" placeholder="Any allergies or medical conditions..."></textarea>
                            </div>
                            <div class="form-divider"></div>
                            <h3 class="form-section-title">Employee Paperwork</h3>
                            <div class="form-group">
                                <label>Upload Documents <span style="font-size: 12px; color: var(--text-muted);">(ID, contracts, certificates, etc.)</span></label>
                                <div class="file-upload-area" id="emp-paperwork-upload" onclick="document.getElementById('emp-paperwork-files').click()">
                                    <input type="file" id="emp-paperwork-files" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;" onchange="handleEmployeePaperworkSelect(this)">
                                    <div class="file-upload-content">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--accent-primary); margin-bottom: 8px;"></i>
                                        <span style="color: var(--text-secondary);">Click to upload or drag and drop</span>
                                        <span style="color: var(--text-muted); font-size: 12px;">PDF, DOC, DOCX, JPG, PNG files (max 10MB each)</span>
                                    </div>
                                </div>
                                <div id="emp-paperwork-list" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveEmployee()">Add Employee</button>
                        </div>
                    `;
                    break;
                case 'add-supply':
                    content = `
                        <div class="modal-header">
                            <h2>Add Supply Item</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Item Name *</label>
                                <input type="text" class="form-input" id="supply-name" placeholder="e.g., Paper towels, Cleaning supplies...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-input" id="supply-quantity" value="1" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="supply-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Loyal Vaper">Loyal Vaper</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="addSupply()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                    `;
                    break;
                case 'add-checklist-task':
                    const shiftForTask = data?.shift || 'opening';
                    const isMidshift = shiftForTask === 'midshift';
                    const shiftTitle = shiftForTask === 'midshift' ? 'Downtime' : shiftForTask.charAt(0).toUpperCase() + shiftForTask.slice(1);
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas ${shiftForTask === 'opening' ? 'fa-sun' : shiftForTask === 'midshift' ? 'fa-mug-hot' : 'fa-moon'}" style="margin-right: 8px; color: ${shiftForTask === 'opening' ? '#f59e0b' : shiftForTask === 'midshift' ? '#10b981' : '#8b5cf6'};"></i>Add ${shiftTitle} Task</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Task Description *</label>
                                <input type="text" class="form-input" id="checklist-task-description" placeholder="${isMidshift ? 'e.g., Count wraps and report low stock...' : 'e.g., Check inventory levels...'}">
                            </div>
                            <input type="hidden" id="checklist-task-shift" value="${shiftForTask}">

                            ${isMidshift ? `
                                <div class="form-group" style="margin-top: 16px;">
                                    <label>Day of Week *</label>
                                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">This task will only appear on the selected day</p>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;">
                                        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map((day, idx) => `
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="midshift-day" value="${day.toLowerCase()}" ${idx === 0 ? 'checked' : ''} style="display: none;">
                                                <div class="day-option" style="padding: 12px 8px; border: 2px solid ${idx === 0 ? '#10b981' : 'var(--border-color)'}; border-radius: 10px; background: ${idx === 0 ? 'rgba(16, 185, 129, 0.1)' : 'var(--bg-secondary)'}; text-align: center; transition: all 0.2s; font-size: 12px; font-weight: 600; color: ${idx === 0 ? '#10b981' : 'var(--text-primary)'};">
                                                    ${day.substring(0, 3)}
                                                </div>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div class="form-group" style="margin-top: 16px;">
                                    <label>Task Duration *</label>
                                    <div style="display: flex; gap: 12px; margin-top: 8px;">
                                        <label style="flex: 1; cursor: pointer;">
                                            <input type="radio" name="checklist-task-duration" value="permanent" checked style="display: none;">
                                            <div class="duration-option" style="padding: 16px; border: 2px solid var(--accent-primary); border-radius: 12px; background: var(--bg-secondary); text-align: center; transition: all 0.2s;">
                                                <i class="fas fa-infinity" style="font-size: 24px; color: var(--accent-primary); margin-bottom: 8px; display: block;"></i>
                                                <div style="font-weight: 600; margin-bottom: 4px;">Permanent</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">Shows every day</div>
                                            </div>
                                        </label>
                                        <label style="flex: 1; cursor: pointer;">
                                            <input type="radio" name="checklist-task-duration" value="one-time" style="display: none;">
                                            <div class="duration-option" style="padding: 16px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); text-align: center; transition: all 0.2s;">
                                                <i class="fas fa-calendar-day" style="font-size: 24px; color: var(--text-muted); margin-bottom: 8px; display: block;"></i>
                                                <div style="font-weight: 600; margin-bottom: 4px;">Just Today</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">One time only</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            `}
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="addChecklistTaskFromModal()">
                                <i class="fas fa-plus"></i> Add Task
                            </button>
                        </div>
                    `;

                    // Add event listeners after modal renders
                    setTimeout(() => {
                        // Duration option listeners (for opening/closing)
                        document.querySelectorAll('input[name="checklist-task-duration"]').forEach(radio => {
                            radio.addEventListener('change', function() {
                                document.querySelectorAll('.duration-option').forEach(opt => {
                                    opt.style.borderColor = 'var(--border-color)';
                                    opt.querySelector('i').style.color = 'var(--text-muted)';
                                });
                                const selected = this.closest('label').querySelector('.duration-option');
                                selected.style.borderColor = 'var(--accent-primary)';
                                selected.querySelector('i').style.color = 'var(--accent-primary)';
                            });
                        });
                        // Day option listeners (for midshift)
                        document.querySelectorAll('input[name="midshift-day"]').forEach(radio => {
                            radio.addEventListener('change', function() {
                                document.querySelectorAll('.day-option').forEach(opt => {
                                    opt.style.borderColor = 'var(--border-color)';
                                    opt.style.background = 'var(--bg-secondary)';
                                    opt.style.color = 'var(--text-primary)';
                                });
                                const selected = this.closest('label').querySelector('.day-option');
                                selected.style.borderColor = '#10b981';
                                selected.style.background = 'rgba(16, 185, 129, 0.1)';
                                selected.style.color = '#10b981';
                            });
                        });
                    }, 100);
                    break;
                case 'edit-checklist-task':
                    const taskToEdit = data?.task;
                    if (!taskToEdit) {
                        content = `<div class="modal-header"><h2>Error</h2></div><div class="modal-body"><p>Task not found</p></div>`;
                        break;
                    }
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-pen" style="margin-right: 8px; color: var(--accent-primary);"></i>Edit Task</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="edit-checklist-task-id" value="${taskToEdit.id}">
                            <div class="form-group">
                                <label>Task Description *</label>
                                <input type="text" class="form-input" id="edit-checklist-task-description" value="${taskToEdit.task.replace(/"/g, '&quot;')}" placeholder="e.g., Check inventory levels...">
                            </div>

                            <div class="form-group" style="margin-top: 16px;">
                                <label>Shift *</label>
                                <div style="display: flex; gap: 12px; margin-top: 8px;">
                                    <label style="flex: 1; cursor: pointer;">
                                        <input type="radio" name="edit-checklist-shift" value="opening" ${taskToEdit.shift === 'opening' ? 'checked' : ''} style="display: none;">
                                        <div class="shift-option" style="padding: 16px; border: 2px solid ${taskToEdit.shift === 'opening' ? '#f59e0b' : 'var(--border-color)'}; border-radius: 12px; background: var(--bg-secondary); text-align: center; transition: all 0.2s;">
                                            <i class="fas fa-sun" style="font-size: 24px; color: ${taskToEdit.shift === 'opening' ? '#f59e0b' : 'var(--text-muted)'}; margin-bottom: 8px; display: block;"></i>
                                            <div style="font-weight: 600; margin-bottom: 4px;">Opening</div>
                                            <div style="font-size: 11px; color: var(--text-muted);">Morning shift</div>
                                        </div>
                                    </label>
                                    <label style="flex: 1; cursor: pointer;">
                                        <input type="radio" name="edit-checklist-shift" value="closing" ${taskToEdit.shift === 'closing' ? 'checked' : ''} style="display: none;">
                                        <div class="shift-option" style="padding: 16px; border: 2px solid ${taskToEdit.shift === 'closing' ? '#8b5cf6' : 'var(--border-color)'}; border-radius: 12px; background: var(--bg-secondary); text-align: center; transition: all 0.2s;">
                                            <i class="fas fa-moon" style="font-size: 24px; color: ${taskToEdit.shift === 'closing' ? '#8b5cf6' : 'var(--text-muted)'}; margin-bottom: 8px; display: block;"></i>
                                            <div style="font-weight: 600; margin-bottom: 4px;">Closing</div>
                                            <div style="font-size: 11px; color: var(--text-muted);">Evening shift</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveEditedChecklistTask()">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    `;

                    // Add event listeners for shift selection after modal renders
                    setTimeout(() => {
                        document.querySelectorAll('input[name="edit-checklist-shift"]').forEach(radio => {
                            radio.addEventListener('change', function() {
                                document.querySelectorAll('.shift-option').forEach(opt => {
                                    opt.style.borderColor = 'var(--border-color)';
                                    opt.querySelector('i').style.color = 'var(--text-muted)';
                                });
                                const selected = this.closest('label').querySelector('.shift-option');
                                const color = this.value === 'opening' ? '#f59e0b' : '#8b5cf6';
                                selected.style.borderColor = color;
                                selected.querySelector('i').style.color = color;
                            });
                        });

                        // Also set hidden shift field
                        const shiftInput = document.getElementById('edit-checklist-task-shift');
                        if (!shiftInput) {
                            const hiddenShift = document.createElement('input');
                            hiddenShift.type = 'hidden';
                            hiddenShift.id = 'edit-checklist-task-shift';
                            hiddenShift.value = taskToEdit.shift;
                            document.querySelector('.modal-body').appendChild(hiddenShift);
                        }

                        document.querySelectorAll('input[name="edit-checklist-shift"]').forEach(radio => {
                            radio.addEventListener('change', function() {
                                document.getElementById('edit-checklist-task-shift').value = this.value;
                            });
                        });
                    }, 100);
                    break;
                case 'add-training':
                    content = `
                        <div class="modal-header">
                            <h2>Add Training Material</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Title *</label>
                                <input type="text" class="form-input" id="training-title" placeholder="Training name...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type *</label>
                                    <select class="form-input" id="training-type" onchange="toggleTrainingTypeFields()">
                                        <option value="video">Video (YouTube/Vimeo)</option>
                                        <option value="document">Document (PDF)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" id="training-url-group">
                                <label>Video URL *</label>
                                <input type="url" class="form-input" id="training-url" placeholder="https://youtube.com/watch?v=...">
                                <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">Supports YouTube and Vimeo links</small>
                            </div>
                            <div class="form-group" id="training-file-group" style="display: none;">
                                <label>PDF File *</label>
                                <div class="file-upload" id="training-file-upload" onclick="document.getElementById('training-file').click()">
                                    <input type="file" id="training-file" accept=".pdf" style="display: none;" onchange="handleTrainingFileSelect(this)">
                                    <div class="file-upload-content" id="training-file-content">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--accent-primary); margin-bottom: 8px;"></i>
                                        <span style="color: var(--text-secondary);">Click to upload or drag and drop</span>
                                        <span style="color: var(--text-muted); font-size: 12px;">PDF files only (max 50MB)</span>
                                    </div>
                                </div>
                                <div id="training-upload-progress" style="display: none; margin-top: 12px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="progress-bar" style="flex: 1; height: 8px;">
                                            <div class="progress-fill" id="training-progress-fill" style="width: 0%;"></div>
                                        </div>
                                        <span id="training-progress-text" style="font-size: 12px; color: var(--text-muted);">0%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="training-description" rows="3" placeholder="Brief description of the training content..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" id="save-training-btn" onclick="saveTraining()">
                                <span id="save-training-text">Add Training</span>
                                <i class="fas fa-spinner fa-spin" id="save-training-spinner" style="display: none;"></i>
                            </button>
                        </div>
                    `;
                    break;
                case 'add-license':
                    content = `
                        <div class="modal-header">
                            <h2>Add License / Document</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Document Name *</label>
                                <input type="text" class="form-input" id="license-name" placeholder="Business License">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="license-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Expiration Date *</label>
                                    <input type="date" class="form-input" id="license-expires">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Upload PDF</label>
                                <div class="file-upload">
                                    <input type="file" id="license-file" accept=".pdf">
                                    <div class="file-upload-content">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>Click to upload or drag and drop</span>
                                        <small>PDF files only (optional)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveLicense()">Upload License</button>
                        </div>
                    `;
                    break;
                case 'add-announcement':
                    content = `
                        <div class="modal-header">
                            <h2>New Announcement</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Title *</label>
                                <input type="text" class="form-input" id="announcement-title" placeholder="Announcement title...">
                            </div>
                            <div class="form-group">
                                <label>Message *</label>
                                <textarea class="form-input" id="announcement-content" rows="5" placeholder="Write your announcement..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Target Stores</label>
                                <select class="form-input" id="announcement-stores">
                                    <option value="all">All Stores</option>
                                    <option value="Miramar">VSU Miramar</option>
                                    <option value="Morena">VSU Morena</option>
                                    <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                    <option value="Chula Vista">VSU Chula Vista</option>
                                    <option value="North Park">VSU North Park</option>
                                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveAnnouncement()">Post Announcement</button>
                        </div>
                    `;
                    break;
                case 'add-product':
                    content = `
                        <div class="modal-header">
                            <h2>Add New Product</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Product Name *</label>
                                    <input type="text" class="form-input" id="new-product-name" placeholder="Enter product name...">
                                </div>
                                <div class="form-group">
                                    <label>Category</label>
                                    <select class="form-input" id="new-product-category">
                                        <option value="">Select category...</option>
                                        <option value="Vape Devices">Vape Devices</option>
                                        <option value="Vape Pods">Vape Pods</option>
                                        <option value="Disposables">Disposables</option>
                                        <option value="Cigarettes">Cigarettes</option>
                                        <option value="Accessories">Accessories</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Estimated Price</label>
                                    <input type="number" step="0.01" class="form-input" id="new-product-price" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Arrival</label>
                                    <input type="date" class="form-input" id="new-product-arrival">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Estimated Deals</label>
                                    <input type="text" class="form-input" id="new-product-deals" placeholder="e.g., 2x1, 20% off, Buy 3 get 1 free...">
                                </div>
                                <div class="form-group">
                                    <label>Product URL</label>
                                    <input type="url" class="form-input" id="new-product-url" placeholder="https://example.com/product">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Supplier</label>
                                <input type="text" class="form-input" id="new-product-supplier" placeholder="Enter supplier name...">
                            </div>
                            <div class="form-group">
                                <label>Product Image (optional)</label>
                                <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 16px; text-align: center; background: var(--bg-hover);">
                                    <input type="file" class="form-input" id="new-product-image" accept="image/*" onchange="previewProductImage(this)" style="display: none;">
                                    <div id="product-image-preview" style="display: none; margin-bottom: 12px;">
                                        <img id="product-image-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover;">
                                    </div>
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('new-product-image').click()" style="margin: 0;">
                                        <i class="fas fa-image"></i> Choose Photo
                                    </button>
                                    <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 12px;">Optional - Click to select an image</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" id="save-product-btn" onclick="saveProduct()">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                    `;
                    break;
                case 'add-thief':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-user-secret"></i> Add Theft Record</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" class="form-input" id="thief-name" placeholder="Enter name or description...">
                                </div>
                                <div class="form-group">
                                    <label>Date of Incident *</label>
                                    <input type="date" class="form-input" id="thief-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="thief-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Crime Type *</label>
                                    <select class="form-input" id="thief-crime-type">
                                        <option value="">Select type...</option>
                                        <option value="Shoplifting">Shoplifting</option>
                                        <option value="Attempted Theft">Attempted Theft</option>
                                        <option value="Robbery">Robbery</option>
                                        <option value="Fraud">Fraud</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Items Stolen *</label>
                                    <input type="text" class="form-input" id="thief-items" placeholder="e.g., Vape devices (2x)">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Value ($) *</label>
                                    <input type="number" step="0.01" class="form-input" id="thief-value" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <textarea class="form-input" id="thief-description" rows="3" placeholder="Describe the incident in detail..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Police Report #</label>
                                    <input type="text" class="form-input" id="thief-police-report" placeholder="e.g., PR-2025-12-10-001">
                                </div>
                                <div class="form-group">
                                    <label>Status *</label>
                                    <select class="form-input" id="thief-status">
                                        <option value="banned">Banned</option>
                                        <option value="warning">Warning</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Photo (Optional)</label>
                                <input type="file" class="form-input" id="thief-photo" accept="image/*" onchange="previewThiefPhoto(this)">
                                <div id="thief-photo-preview" style="margin-top: 10px; display: none;">
                                    <img id="thief-photo-img" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveThief()">
                                <i class="fas fa-plus"></i> Add Record
                            </button>
                        </div>
                    `;
                    break;
                case 'edit-thief':
                    if (!data) {
                        alert('No thief data provided');
                        return;
                    }
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-user-secret"></i> Edit Theft Record</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" class="form-input" id="edit-thief-name" value="${data.name || ''}" placeholder="Enter name or description...">
                                </div>
                                <div class="form-group">
                                    <label>Date of Incident</label>
                                    <input type="date" class="form-input" id="edit-thief-date" value="${data.date || ''}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="edit-thief-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar" ${data.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                        <option value="Morena" ${data.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                        <option value="Kearny Mesa" ${data.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                        <option value="Chula Vista" ${data.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                        <option value="North Park" ${data.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                        <option value="Miramar Wine & Liquor" ${data.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Crime Type</label>
                                    <select class="form-input" id="edit-thief-crime-type">
                                        <option value="">Select type...</option>
                                        <option value="Shoplifting" ${data.crimeType === 'Shoplifting' ? 'selected' : ''}>Shoplifting</option>
                                        <option value="Attempted Theft" ${data.crimeType === 'Attempted Theft' ? 'selected' : ''}>Attempted Theft</option>
                                        <option value="Robbery" ${data.crimeType === 'Robbery' ? 'selected' : ''}>Robbery</option>
                                        <option value="Fraud" ${data.crimeType === 'Fraud' ? 'selected' : ''}>Fraud</option>
                                        <option value="Other" ${data.crimeType === 'Other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Items Stolen</label>
                                    <input type="text" class="form-input" id="edit-thief-items" value="${data.itemsStolen || ''}" placeholder="e.g., Vape devices (2x)">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Value ($)</label>
                                    <input type="number" step="0.01" class="form-input" id="edit-thief-value" value="${data.estimatedValue || ''}" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="edit-thief-description" rows="3" placeholder="Describe the incident in detail...">${data.description || ''}</textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Police Report #</label>
                                    <input type="text" class="form-input" id="edit-thief-police-report" value="${data.policeReport || ''}" placeholder="e.g., PR-2025-12-10-001">
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select class="form-input" id="edit-thief-status">
                                        <option value="banned" ${data.banned ? 'selected' : ''}>Banned</option>
                                        <option value="warning" ${!data.banned ? 'selected' : ''}>Warning</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Photo (leave empty to keep current)</label>
                                <input type="file" class="form-input" id="edit-thief-photo" accept="image/*" onchange="previewEditThiefPhoto(this)">
                                <div id="edit-thief-photo-preview" style="margin-top: 10px; ${data.photo ? '' : 'display: none;'}">
                                    <img id="edit-thief-photo-img" src="${data.photo || ''}" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveEditedThief()">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    `;
                    break;
                case 'add-invoice':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-file-invoice-dollar"></i> Add Invoice</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Invoice Number</label>
                                    <input type="text" class="form-input" id="invoice-number" placeholder="e.g., INV-2025-004">
                                </div>
                                <div class="form-group">
                                    <label>Vendor</label>
                                    <input type="text" class="form-input" id="invoice-vendor" placeholder="Enter vendor name...">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Categories <span style="font-weight: 400; color: var(--text-muted); font-size: 12px;">(select one or more)</span></label>
                                ${renderInvoiceCategoryCheckboxes([], 'invoice-categories-container')}
                            </div>
                            <div class="form-group">
                                <label>Store</label>
                                <select class="form-input" id="invoice-store">
                                    <option value="" ${!invoiceFilters.store || invoiceFilters.store === 'all' ? 'selected' : ''}>Unassigned</option>
                                    <option value="Miramar" ${invoiceFilters.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                    <option value="Morena" ${invoiceFilters.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                    <option value="Kearny Mesa" ${invoiceFilters.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                    <option value="Chula Vista" ${invoiceFilters.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                    <option value="North Park" ${invoiceFilters.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                    <option value="Miramar Wine & Liquor" ${invoiceFilters.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Amount ($)</label>
                                    <input type="number" step="0.01" class="form-input" id="invoice-amount" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Due Date</label>
                                    <input type="date" class="form-input" id="invoice-due-date">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" class="form-input" id="invoice-description" placeholder="Enter description...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Status</label>
                                    <select class="form-input" id="invoice-status">
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                        <option value="overdue">Overdue</option>
                                        <option value="filed">Filed</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Payment Account</label>
                                    <select class="form-input" id="invoice-payment-account">
                                        <option value="">Select account...</option>
                                        <option value="Shop App">Shop App</option>
                                        <option value="Personal Account">Personal Account</option>
                                        <option value="Business Account">Business Account</option>
                                        <option value="PayPal">PayPal</option>
                                        <option value="Credit Card">Credit Card</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="invoice-recurring" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                    <span>Recurring Invoice</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Invoice File (Photo or PDF)</label>
                                <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 16px; text-align: center; background: var(--bg-hover);">
                                    <input type="file" class="form-input" id="invoice-photo" accept="image/*,.pdf,application/pdf" onchange="previewInvoiceFile(this)" style="display: none;">
                                    <div id="invoice-photo-preview" style="display: none; margin-bottom: 12px;">
                                        <img id="invoice-photo-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover;">
                                    </div>
                                    <div id="invoice-pdf-preview" style="display: none; margin-bottom: 12px;">
                                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                            <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444;"></i>
                                            <div style="text-align: left;">
                                                <div id="invoice-pdf-name" style="font-weight: 600;"></div>
                                                <div id="invoice-pdf-size" style="font-size: 12px; color: var(--text-muted);"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                        <button type="button" class="btn-secondary" onclick="document.getElementById('invoice-photo').click()" style="margin: 0;">
                                            <i class="fas fa-upload"></i> Upload File
                                        </button>
                                        <input type="file" id="invoice-camera" accept="image/*" capture="environment" style="display: none;" onchange="handleInvoiceCameraCapture(this)">
                                        <button type="button" class="btn-secondary" onclick="document.getElementById('invoice-camera').click()" style="margin: 0; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
                                            <i class="fas fa-camera"></i> Take Photo
                                        </button>
                                        <button type="button" id="ai-scan-btn" class="btn-secondary" onclick="scanInvoiceWithAI()" style="margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                                            <i class="fas fa-magic"></i> Scan with AI
                                        </button>
                                    </div>
                                    <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 12px;">Take a photo or upload a file, then click "Scan with AI" to auto-fill</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-input" id="invoice-notes" rows="2" placeholder="Add any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn-primary" onclick="saveInvoice()">
                                <i class="fas fa-plus"></i> Add Invoice
                            </button>
                        </div>
                    `;
                    break;
                case 'restock-request':
                    const itemId = modal.dataset.itemId;
                    const item = inventory.find(i => i.id == itemId);
                    content = `
                        <div class="modal-header">
                            <h2>New Restock Request</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Item *</label>
                                <input type="text" class="form-input" id="restock-item" value="${item.brand} ${item.productName} - ${item.flavor}" readonly style="background: var(--bg-hover);">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="restock-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="restock-modal-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Qty on Hand *</label>
                                    <input type="number" class="form-input" id="restock-qty-hand" placeholder="Current quantity in stock" value="${item.stock}">
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <input type="checkbox" id="customer-request" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                        <span>Customer Request</span>
                                    </label>
                                    <input type="text" class="form-input" id="customer-info" placeholder="Customer name or info..." disabled style="background: var(--bg-hover);">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea class="form-input" id="restock-modal-notes" rows="3" placeholder="Add any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="submitRestockFromModal('${itemId}')">Request</button>
                        </div>
                    `;
                    break;
                case 'new-restock-request':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-box"></i> New Product Request</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group" style="position: relative;">
                                <label>Product Name *</label>
                                <input type="text" class="form-input" id="new-restock-product" placeholder="Start typing to see suggestions..." autocomplete="off" oninput="showProductSuggestions(this.value, 'new-restock-suggestions')">
                                <div id="new-restock-suggestions" class="product-suggestions-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 8px 24px rgba(0,0,0,0.2);"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity *</label>
                                    <input type="number" class="form-input" id="new-restock-quantity" placeholder="0" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select class="form-input" id="new-restock-priority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="new-restock-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Requested By</label>
                                    <select class="form-input" id="new-restock-requested-by">
                                        <option value="">Select employee...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea class="form-input" id="new-restock-notes" rows="2" placeholder="Any additional details..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="submitNewRestockRequest()">Add Request</button>
                        </div>
                    `;
                    break;
                case 'edit-restock-request':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Request</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group" style="position: relative;">
                                <label>Product Name *</label>
                                <input type="text" class="form-input" id="edit-restock-product" placeholder="Start typing to see suggestions..." autocomplete="off" oninput="showProductSuggestions(this.value, 'edit-restock-suggestions')">
                                <div id="edit-restock-suggestions" class="product-suggestions-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 8px 24px rgba(0,0,0,0.2);"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity *</label>
                                    <input type="number" class="form-input" id="edit-restock-quantity" placeholder="0" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select class="form-input" id="edit-restock-priority">
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="edit-restock-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Requested By</label>
                                    <select class="form-input" id="edit-restock-requested-by">
                                        <option value="">Select employee...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea class="form-input" id="edit-restock-notes" rows="2" placeholder="Any additional details..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="submitEditRestockRequest()">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'create-cashout':
                    // Initialize voice assistant for cashout form
                    setTimeout(() => {
                        VoiceAssistant.init('cashout', {
                            title: 'AI Voice Assistant',
                            subtitle: 'Speak to auto-fill the expense form',
                            buttonColor: 'linear-gradient(135deg, #8b5cf6, #6366f1)',
                            listeningText: 'Listening... Describe the expense',
                            systemPrompt: 'You are an assistant helping to document cash out expenses at a retail store. Extract structured information from voice transcripts about expenses and cash withdrawals.',
                            prompt: `Analyze this voice transcript about an expense/cash out and extract the information. Return ONLY a JSON object with these fields (use null for any field you cannot determine):

Transcript: "{transcript}"

{
    "description": "clear description of the expense (e.g., Office Supplies from Staples, Bank Deposit, Cleaning Supplies)",
    "amount": "the amount as a number (no currency symbols)",
    "store": "one of: Miramar, Morena, Kearny Mesa, Chula Vista, North Park, Miramar Wine & Liquor (if mentioned)",
    "notes": "any additional relevant details"
}

Return ONLY the JSON object, no additional text.`,
                            onFill: (data) => {
                                if (data.description) document.getElementById('cashout-name').value = data.description;
                                else if (data._transcript) document.getElementById('cashout-name').value = data._transcript;
                                if (data.amount) {
                                    const amt = parseFloat(data.amount.toString().replace(/[^0-9.]/g, ''));
                                    if (!isNaN(amt)) document.getElementById('cashout-amount').value = amt.toFixed(2);
                                }
                                if (data.store) {
                                    const storeSelect = document.getElementById('cashout-store');
                                    for (let opt of storeSelect.options) {
                                        if (opt.value.toLowerCase().includes(data.store.toLowerCase()) || data.store.toLowerCase().includes(opt.value.toLowerCase())) {
                                            storeSelect.value = opt.value; break;
                                        }
                                    }
                                }
                                if (data.notes) document.getElementById('cashout-reason').value = data.notes;
                            }
                        });
                    }, 100);

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-money-bill-wave"></i> Add Cash Out</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- AI Tools Section -->
                            <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-wand-magic-sparkles" style="color: white; font-size: 14px;"></i>
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">AI Assistant</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">Scan receipt or speak to auto-fill</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <input type="file" id="cashout-ai-photo" accept="image/*" style="display: none;" onchange="scanCashOutWithAI()">
                                        <button type="button" id="cashout-ai-scan-btn" onclick="document.getElementById('cashout-ai-photo').click()" style="padding: 10px 16px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; color: white; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(139,92,246,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                                            <i class="fas fa-camera"></i> Scan
                                        </button>
                                        <button type="button" id="va-btn-cashout" onclick="VoiceAssistant.toggle('cashout')" style="padding: 10px 16px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; color: white; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(139,92,246,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                                            <i class="fas fa-microphone" id="va-icon-cashout"></i> <span id="va-text-cashout">Voice</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="va-status-cashout" style="display: none; margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px;"></div>
                                <div id="va-transcript-cashout" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">What you said:</div>
                                    <div id="va-transcript-text-cashout" style="font-size: 13px; color: var(--text-primary); line-height: 1.5;"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Description *</label>
                                    <input type="text" class="form-input" id="cashout-name" placeholder="e.g., Office Supplies, Bank Deposit... or use voice!">
                                </div>
                                <div class="form-group">
                                    <label>Amount *</label>
                                    <input type="number" step="0.01" class="form-input" id="cashout-amount" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="cashout-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-input" id="cashout-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-input" id="cashout-reason" rows="2" placeholder="Additional notes (optional)..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="createCashOut()">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    `;
                    break;
                case 'close-cashout':
                    const cashoutId = arguments[1];
                    const cashoutRecord = cashOutRecords.find(r => r.id === cashoutId || r.firestoreId === cashoutId);
                    if (!cashoutRecord) break;

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-check-circle"></i> Close Cash Out</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">Cash Out Name:</span>
                                    <strong>${cashoutRecord.name}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">Amount Given:</span>
                                    <strong style="color: var(--accent-primary); font-size: 18px;">$${cashoutRecord.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Receipt Photo *</label>
                                <div class="file-upload">
                                    <input type="file" id="cashout-receipt-photo" accept="image/*">
                                    <div class="file-upload-content">
                                        <i class="fas fa-camera"></i>
                                        <span>Click to upload receipt photo</span>
                                        <small>JPG, PNG, or GIF</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Amount Spent *</label>
                                <input type="number" step="0.01" class="form-input" id="cashout-amount-spent" placeholder="0.00" max="${cashoutRecord.amount}">
                                <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                                    Maximum: $${cashoutRecord.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </small>
                            </div>

                            <div class="form-group">
                                <label>Is there money left? *</label>
                                <div style="display: flex; gap: 24px; margin-top: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="money-left" id="cashout-money-left-yes" value="yes" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                        <span>Yes, there is money left</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="money-left" id="cashout-money-left-no" value="no" checked style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                        <span>No, all money was spent</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="closeCashOut('${cashoutRecord.firestoreId || cashoutRecord.id}')">
                                <i class="fas fa-check"></i>
                                Close Cash Out
                            </button>
                        </div>
                    `;
                    break;
                case 'create-issue':
                    // Initialize voice assistant for issue form
                    setTimeout(() => {
                        VoiceAssistant.init('issue', {
                            title: 'AI Voice Assistant',
                            subtitle: 'Speak to auto-fill the issue form',
                            buttonColor: 'linear-gradient(135deg, #ef4444, #f59e0b)',
                            listeningText: 'Listening... Describe the issue',
                            systemPrompt: 'You are an assistant helping to document customer issues at a retail store. Extract structured information from voice transcripts about customer complaints, returns, or service issues.',
                            prompt: `Analyze this voice transcript about a customer issue and extract the information. Return ONLY a JSON object with these fields (use null for any field you cannot determine):

Transcript: "{transcript}"

{
    "customerName": "the customer's name if mentioned",
    "phone": "phone number if mentioned",
    "issueType": "one of: In Store, Online",
    "store": "one of: Miramar, Morena, Kearny Mesa, Chula Vista, North Park, Miramar Wine & Liquor (if mentioned)",
    "description": "a clear description of the issue",
    "perception": "1-5 where 1=Very Upset, 2=Upset, 3=Neutral, 4=Satisfied, 5=Happy (based on how the customer left)"
}

Return ONLY the JSON object, no additional text.`,
                            onFill: (data) => {
                                if (data.customerName) document.getElementById('issue-customer').value = data.customerName;
                                if (data.phone) document.getElementById('issue-phone').value = data.phone;
                                if (data.issueType) {
                                    const typeSelect = document.getElementById('issue-type');
                                    for (let opt of typeSelect.options) {
                                        if (opt.value.toLowerCase() === data.issueType.toLowerCase()) { typeSelect.value = opt.value; break; }
                                    }
                                }
                                if (data.store) {
                                    const storeSelect = document.getElementById('issue-store');
                                    for (let opt of storeSelect.options) {
                                        if (opt.value.toLowerCase().includes(data.store.toLowerCase()) || data.store.toLowerCase().includes(opt.value.toLowerCase())) {
                                            storeSelect.value = opt.value; break;
                                        }
                                    }
                                }
                                if (data.description) document.getElementById('issue-description').value = data.description;
                                else if (data._transcript) document.getElementById('issue-description').value = data._transcript;
                                if (data.perception) {
                                    const p = parseInt(data.perception);
                                    if (p >= 1 && p <= 5) selectPerception(p);
                                }
                            }
                        });
                    }, 100);

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-exclamation-triangle"></i> Create Issue</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- AI Voice Assistant Section -->
                            ${VoiceAssistant.getHTML('issue', { title: 'AI Voice Assistant', subtitle: 'Speak to auto-fill the issue form', buttonColor: 'linear-gradient(135deg, #ef4444, #f59e0b)' })}

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Customer Name</label>
                                    <input type="text" class="form-input" id="issue-customer" placeholder="Enter customer name...">
                                </div>
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="tel" class="form-input" id="issue-phone" placeholder="(555) 555-5555" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Issue Type</label>
                                    <select class="form-input" id="issue-type">
                                        <option value="">Select type...</option>
                                        <option value="In Store">In Store</option>
                                        <option value="Online">Online</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="issue-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Incident Date</label>
                                <input type="date" class="form-input" id="issue-incident-date" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Brief Description</label>
                                <textarea class="form-input" id="issue-description" rows="3" placeholder="Describe the issue... or use voice above!"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Customer Perception When Leaving</label>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">How did the customer feel when leaving the store?</p>
                                <div id="perception-selector" style="display: flex; justify-content: space-between; gap: 8px;">
                                    <button type="button" class="perception-btn" data-value="1" onclick="selectPerception(1)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">üò°</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Very Upset</div>
                                    </button>
                                    <button type="button" class="perception-btn" data-value="2" onclick="selectPerception(2)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">üò†</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Upset</div>
                                    </button>
                                    <button type="button" class="perception-btn" data-value="3" onclick="selectPerception(3)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">üòê</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Neutral</div>
                                    </button>
                                    <button type="button" class="perception-btn" data-value="4" onclick="selectPerception(4)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">üôÇ</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Satisfied</div>
                                    </button>
                                    <button type="button" class="perception-btn" data-value="5" onclick="selectPerception(5)" style="flex: 1; padding: 16px 8px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">üòä</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Happy</div>
                                    </button>
                                </div>
                                <input type="hidden" id="issue-perception" value="">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="createIssue()">
                                <i class="fas fa-plus"></i>
                                Create Issue
                            </button>
                        </div>
                    `;
                    break;
                case 'resolve-issue':
                    const issueId = arguments[1];
                    const issue = issues.find(i => String(i.id) === String(issueId) || i.firestoreId === issueId);
                    if (!issue) break;

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-check-circle"></i> Resolve Issue</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">Customer:</span>
                                    <strong>${issue.customer}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">Type:</span>
                                    <span class="badge" style="background: ${issue.type === 'In Store' ? 'var(--accent-primary)' : 'var(--info)'};">
                                        ${issue.type}
                                    </span>
                                </div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Issue Description:</div>
                                    <div style="font-size: 14px;">${issue.description}</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>How was it resolved? *</label>
                                <textarea class="form-input" id="issue-solution" rows="4" placeholder="Describe how the issue was resolved..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Responsible Person *</label>
                                <input type="text" class="form-input" id="issue-resolved-by" placeholder="Who handled this issue?" value="VSU Admin">
                            </div>

                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-top: 16px;">
                                <div style="font-size: 13px; color: var(--text-muted);">
                                    <i class="fas fa-info-circle"></i>
                                    Resolution date will be set to today automatically
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="resolveIssue('${issueId}')">
                                <i class="fas fa-check"></i>
                                Mark as Resolved
                            </button>
                        </div>
                    `;
                    break;
                case 'create-vendor':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-truck"></i> Add Vendor</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Vendor Name *</label>
                                <input type="text" class="form-input" id="vendor-name" placeholder="Enter vendor name...">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select class="form-input" id="vendor-category">
                                        <option value="">Select category...</option>
                                        <option value="Vape Products">Vape Products</option>
                                        <option value="Tobacco Products">Tobacco Products</option>
                                        <option value="Beverages">Beverages</option>
                                        <option value="Snacks & Candy">Snacks & Candy</option>
                                        <option value="Store Supplies">Store Supplies</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Contact Person *</label>
                                    <input type="text" class="form-input" id="vendor-contact" placeholder="Contact name...">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" class="form-input" id="vendor-phone" placeholder="(800) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" class="form-input" id="vendor-email" placeholder="contact@vendor.com">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Website (Optional)</label>
                                    <input type="url" class="form-input" id="vendor-website" placeholder="https://www.vendor.com" pattern="https?://.+">
                                </div>
                                <div class="form-group">
                                    <label>Access Info (Optional)</label>
                                    <input type="text" class="form-input" id="vendor-access" placeholder="Account #, login details, etc.">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>What We Buy *</label>
                                <textarea class="form-input" id="vendor-products" rows="3" placeholder="List products purchased from this vendor..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>How to Order *</label>
                                <textarea class="form-input" id="vendor-order-methods" rows="2" placeholder="Online portal, phone, email, etc."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Additional Notes (Optional)</label>
                                <textarea class="form-input" id="vendor-notes" rows="2" placeholder="Payment terms, delivery schedules, etc."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="createVendor()">
                                <i class="fas fa-plus"></i>
                                Add Vendor
                            </button>
                        </div>
                    `;
                    break;
                case 'edit-vendor':
                    const editVendorId = arguments[1];
                    const editVendor = vendors.find(v => v.id === editVendorId);
                    if (!editVendor) break;

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Vendor</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Vendor Name *</label>
                                <input type="text" class="form-input" id="edit-vendor-name" placeholder="Enter vendor name..." value="${editVendor.name}">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select class="form-input" id="edit-vendor-category">
                                        <option value="">Select category...</option>
                                        <option value="Vape Products" ${editVendor.category === 'Vape Products' ? 'selected' : ''}>Vape Products</option>
                                        <option value="Tobacco Products" ${editVendor.category === 'Tobacco Products' ? 'selected' : ''}>Tobacco Products</option>
                                        <option value="Beverages" ${editVendor.category === 'Beverages' ? 'selected' : ''}>Beverages</option>
                                        <option value="Snacks & Candy" ${editVendor.category === 'Snacks & Candy' ? 'selected' : ''}>Snacks & Candy</option>
                                        <option value="Store Supplies" ${editVendor.category === 'Store Supplies' ? 'selected' : ''}>Store Supplies</option>
                                        <option value="Other" ${editVendor.category === 'Other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Contact Person *</label>
                                    <input type="text" class="form-input" id="edit-vendor-contact" placeholder="Contact name..." value="${editVendor.contact}">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone *</label>
                                    <input type="tel" class="form-input" id="edit-vendor-phone" placeholder="(800) 555-0000" oninput="formatPhoneNumber(this)" maxlength="14" value="${editVendor.phone}">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" class="form-input" id="edit-vendor-email" placeholder="contact@vendor.com" value="${editVendor.email}">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Website (Optional)</label>
                                    <input type="url" class="form-input" id="edit-vendor-website" placeholder="https://www.vendor.com" pattern="https?://.+" value="${editVendor.website || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Access Info (Optional)</label>
                                    <input type="text" class="form-input" id="edit-vendor-access" placeholder="Account #, login details, etc." value="${editVendor.access || ''}">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>What We Buy *</label>
                                <textarea class="form-input" id="edit-vendor-products" rows="3" placeholder="List products purchased from this vendor...">${editVendor.products}</textarea>
                            </div>

                            <div class="form-group">
                                <label>How to Order *</label>
                                <textarea class="form-input" id="edit-vendor-order-methods" rows="2" placeholder="Online portal, phone, email, etc.">${editVendor.orderMethods}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Additional Notes (Optional)</label>
                                <textarea class="form-input" id="edit-vendor-notes" rows="2" placeholder="Payment terms, delivery schedules, etc.">${editVendor.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="editVendor('${editVendorId}')">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                    `;
                    break;
                case 'add-expense':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-wallet"></i> New Expense</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Description *</label>
                                <input type="text" class="form-input" id="expense-description" placeholder="What did you spend on?">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Amount *</label>
                                    <input type="number" step="0.01" class="form-input" id="expense-amount" placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select class="form-input" id="expense-category">
                                        <option value="">Select category...</option>
                                        <option value="Food">üçî Food</option>
                                        <option value="Home">üè† Home</option>
                                        <option value="Subscriptions">üì∫ Subscriptions</option>
                                        <option value="Health">üíä Health</option>
                                        <option value="Gifts">üéÅ Gifts</option>
                                        <option value="Others">üì¶ Others</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" class="form-input" id="expense-date" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="addExpense()">
                                <i class="fas fa-plus"></i>
                                Add Expense
                            </button>
                        </div>
                    `;
                    break;
                case 'add-treasury':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-gem"></i> Add Heady Piece</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- Image Upload Section -->
                            <div class="form-group">
                                <label>Piece Image</label>
                                <div style="display: flex; align-items: start; gap: 16px;">
                                    <div id="treasury-image-preview" style="width: 120px; height: 120px; border-radius: 12px; border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden; flex-shrink: 0;">
                                        <i class="fas fa-gem" style="font-size: 36px; color: var(--text-muted);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="treasury-image" accept="image/*" style="display: none;" onchange="previewTreasuryImage(this)">
                                        <button type="button" class="btn-secondary" onclick="document.getElementById('treasury-image').click()" style="margin-bottom: 8px;">
                                            <i class="fas fa-upload"></i> Upload Image
                                        </button>
                                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Recommended: Square image, max 2MB</p>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Artwork Name *</label>
                                <input type="text" class="form-input" id="treasury-artwork-name" placeholder="Enter artwork name...">
                            </div>
                            <div class="form-group">
                                <label>Artist</label>
                                <input type="text" class="form-input" id="treasury-artist" placeholder="Artist name...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Acquisition Date</label>
                                    <input type="date" class="form-input" id="treasury-acquisition-date">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Value (USD)</label>
                                    <input type="number" step="0.01" class="form-input" id="treasury-value" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Current Location *</label>
                                <select class="form-input" id="treasury-location">
                                    <option value="">Select location...</option>
                                    <option value="VSU Miramar">VSU Miramar</option>
                                    <option value="VSU Morena">VSU Morena</option>
                                    <option value="VSU Kearny Mesa">VSU Kearny Mesa</option>
                                    <option value="VSU North Park">VSU North Park</option>
                                    <option value="VSU Chula Vista">VSU Chula Vista</option>
                                    <option value="VSU North Park">VSU North Park</option>
                                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="treasury-description" rows="4" placeholder="Add details about the piece..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveTreasuryItem(false)">
                                <i class="fas fa-save"></i>
                                Add Piece
                            </button>
                        </div>
                    `;
                    break;
                case 'edit-treasury':
                    const treasuryId = data;
                    const treasuryItem = treasuryItems.find(t => t.firestoreId === treasuryId || t.id === treasuryId);
                    if (!treasuryItem) break;

                    // Get the main image (first photo or image field)
                    const treasuryEditImage = treasuryItem.image || (treasuryItem.photos && treasuryItem.photos.length > 0 ? treasuryItem.photos[0] : null);

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Heady Piece</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- Image Upload Section -->
                            <div class="form-group">
                                <label>Piece Image</label>
                                <div style="display: flex; align-items: start; gap: 16px;">
                                    <div id="treasury-image-preview" style="width: 120px; height: 120px; border-radius: 12px; border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden; flex-shrink: 0;">
                                        ${treasuryEditImage ? `<img src="${treasuryEditImage}" style="width: 100%; height: 100%; object-fit: cover;">` : `<i class="fas fa-gem" style="font-size: 36px; color: var(--text-muted);"></i>`}
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="treasury-image" accept="image/*" style="display: none;" onchange="previewTreasuryImage(this)">
                                        <button type="button" class="btn-secondary" onclick="document.getElementById('treasury-image').click()" style="margin-bottom: 8px;">
                                            <i class="fas fa-upload"></i> ${treasuryEditImage ? 'Change Image' : 'Upload Image'}
                                        </button>
                                        ${treasuryEditImage ? `<button type="button" class="btn-secondary" onclick="removeTreasuryImage()" style="margin-left: 8px; margin-bottom: 8px;"><i class="fas fa-trash"></i></button>` : ''}
                                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Recommended: Square image, max 2MB</p>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Artwork Name *</label>
                                <input type="text" class="form-input" id="treasury-artwork-name" placeholder="Enter artwork name..." value="${treasuryItem.artworkName || ''}">
                            </div>
                            <div class="form-group">
                                <label>Artist</label>
                                <input type="text" class="form-input" id="treasury-artist" placeholder="Artist name..." value="${treasuryItem.artist || ''}">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Acquisition Date</label>
                                    <input type="date" class="form-input" id="treasury-acquisition-date" value="${treasuryItem.acquisitionDate || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Estimated Value (USD)</label>
                                    <input type="number" step="0.01" class="form-input" id="treasury-value" placeholder="0.00" value="${treasuryItem.value || ''}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Current Location *</label>
                                <select class="form-input" id="treasury-location">
                                    <option value="">Select location...</option>
                                    <option value="VSU Miramar" ${treasuryItem.location === 'VSU Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                    <option value="VSU Morena" ${treasuryItem.location === 'VSU Morena' ? 'selected' : ''}>VSU Morena</option>
                                    <option value="VSU Kearny Mesa" ${treasuryItem.location === 'VSU Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                    <option value="VSU North Park" ${treasuryItem.location === 'VSU North Park' ? 'selected' : ''}>VSU North Park</option>
                                    <option value="VSU Chula Vista" ${treasuryItem.location === 'VSU Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                    <option value="Miramar Wine & Liquor" ${treasuryItem.location === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="treasury-description" rows="4" placeholder="Add details about the piece...">${treasuryItem.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveTreasuryItem(true, '${treasuryId}')">
                                <i class="fas fa-save"></i>
                                Update Piece
                            </button>
                        </div>
                    `;
                    break;
                case 'add-change':
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-coins"></i> Add Change Record</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Photo of Money/Envelope</label>
                                <div style="display: flex; align-items: flex-start; gap: 16px;">
                                    <div id="change-photo-preview" style="width: 120px; height: 120px; border-radius: 12px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed var(--border-color); cursor: pointer;" onclick="document.getElementById('change-photo').click()">
                                        <i class="fas fa-coins" style="font-size: 36px; color: var(--text-muted);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="file" id="change-photo" accept="image/*" style="display: none;" onchange="previewChangePhoto(this)">
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                                            <button type="button" class="btn-secondary" onclick="document.getElementById('change-photo').click()">
                                                <i class="fas fa-upload"></i> Upload
                                            </button>
                                            <button type="button" id="change-ai-scan-btn" class="btn-secondary" onclick="scanChangeWithAI()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                                                <i class="fas fa-magic"></i> Scan with AI
                                            </button>
                                            <button type="button" class="btn-secondary" onclick="removeChangePhoto()">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Upload a photo of the money, then click "Scan with AI" to auto-count bills & coins</p>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store / Location *</label>
                                    <select class="form-input" id="change-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="change-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>

                            <!-- Currency Breakdown Section -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin: 16px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <label style="font-weight: 600; color: var(--text-primary); margin: 0;">
                                        <i class="fas fa-money-bill-wave" style="color: var(--success);"></i> Currency Breakdown *
                                    </label>
                                    <div style="font-size: 18px; font-weight: 700; color: var(--accent-primary);">
                                        Total: $<span id="change-total-display">0.00</span>
                                    </div>
                                </div>

                                <!-- Bills -->
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Bills</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$100</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="100" id="change-bills-100" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$50</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="50" id="change-bills-50" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$20</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="20" id="change-bills-20" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$10</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="10" id="change-bills-10" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$5</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="5" id="change-bills-5" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$2</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="2" id="change-bills-2" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$1</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="1" id="change-bills-1" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                    </div>
                                </div>

                                <!-- Coins -->
                                <div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Coins</div>
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">$1 coin</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="1" id="change-coins-100" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">50¬¢</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.50" id="change-coins-50" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">25¬¢</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.25" id="change-coins-25" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">10¬¢</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.10" id="change-coins-10" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">5¬¢</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.05" id="change-coins-5" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">1¬¢</div>
                                            <input type="number" min="0" class="form-input change-denomination" data-value="0.01" id="change-coins-1" placeholder="0" style="text-align: center; padding: 8px;" onchange="calculateChangeTotal()" oninput="calculateChangeTotal()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Change in Store Section -->
                            <div style="background: linear-gradient(135deg, #10b98115, #10b98108); border: 2px solid #10b98140; border-radius: 12px; padding: 16px; margin: 16px 0;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div style="width: 40px; height: 40px; background: #10b98120; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-cash-register" style="color: #10b981; font-size: 18px;"></i>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: var(--text-primary); margin: 0; display: block;">Change in Store</label>
                                        <span style="font-size: 12px; color: var(--text-muted);">Amount of change currently available in the register</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 24px; font-weight: 600; color: #10b981;">$</span>
                                    <input type="number" step="0.01" min="0" class="form-input" id="change-in-store" placeholder="0.00" style="font-size: 20px; font-weight: 600; text-align: center; max-width: 200px;">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Left By (Person who left the change) *</label>
                                    <input type="text" class="form-input" id="change-left-by" placeholder="Name of person...">
                                </div>
                                <div class="form-group">
                                    <label>Received By (Person who received it) *</label>
                                    <input type="text" class="form-input" id="change-received-by" placeholder="Name of person...">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea class="form-input" id="change-notes" rows="3" placeholder="e.g., 'Se dej√≥ en caja 1', 'Se meti√≥ extra por falta de cambio'..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveChangeRecord()">
                                <i class="fas fa-save"></i>
                                Save Record
                            </button>
                        </div>
                    `;
                    break;

                case 'add-risknote':
                    // Initialize voice assistant for risk note form
                    setTimeout(() => {
                        VoiceAssistant.init('risknote', {
                            title: 'AI Voice Assistant',
                            subtitle: 'Speak to auto-fill the form',
                            buttonColor: 'linear-gradient(135deg, #8b5cf6, #ec4899)',
                            listeningText: 'Listening... Describe the incident',
                            systemPrompt: 'You are a security assistant helping to document risk notes for a retail store. Extract structured information from voice transcripts about suspicious activity or policy violations.',
                            prompt: `Analyze this voice transcript about a risk/security incident and extract the information. Return ONLY a JSON object with these fields (use null for any field you cannot determine):

Transcript: "{transcript}"

{
    "store": "one of: Miramar, Morena, Kearny Mesa, Chula Vista, North Park, Miramar Wine & Liquor (if mentioned)",
    "behaviorType": "one of: strange_questions, unusual_purchase, recording, policy_violation, suspicious_attitude, other",
    "description": "a clear, professional description of what happened based on the transcript",
    "riskLevel": "low, medium, or high based on severity",
    "reportedBy": "name of the person reporting if mentioned"
}

Behavior type guidelines:
- strange_questions: asking unusual questions about security, schedules, or policies
- unusual_purchase: suspicious buying patterns, bulk purchases, specific combinations
- recording: taking photos/videos without permission
- policy_violation: attempting to violate store policies
- suspicious_attitude: nervous behavior, watching cameras, avoiding eye contact
- other: anything that doesn't fit above

Risk level guidelines:
- low: minor concern, document for awareness
- medium: notable concern, should monitor
- high: immediate concern, requires action

Return ONLY the JSON object, no additional text.`,
                            onFill: (data) => {
                                if (data.store) {
                                    const storeSelect = document.getElementById('risknote-store');
                                    for (let opt of storeSelect.options) {
                                        if (opt.value.toLowerCase().includes(data.store.toLowerCase()) || data.store.toLowerCase().includes(opt.value.toLowerCase())) {
                                            storeSelect.value = opt.value; break;
                                        }
                                    }
                                }
                                if (data.behaviorType) {
                                    const typeSelect = document.getElementById('risknote-type');
                                    const typeValue = data.behaviorType.toLowerCase().replace(/\s+/g, '_');
                                    for (let opt of typeSelect.options) {
                                        if (opt.value === typeValue) { typeSelect.value = opt.value; break; }
                                    }
                                }
                                if (data.description) document.getElementById('risknote-description').value = data.description;
                                else if (data._transcript) document.getElementById('risknote-description').value = data._transcript;
                                if (data.riskLevel) selectRiskLevel(data.riskLevel.toLowerCase());
                                if (data.reportedBy) document.getElementById('risknote-reporter').value = data.reportedBy;
                            }
                        });
                    }, 100);

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-shield-halved"></i> New Risk Note</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- AI Voice Assistant Section -->
                            ${VoiceAssistant.getHTML('risknote', { title: 'AI Voice Assistant', subtitle: 'Speak to auto-fill the form', buttonColor: 'linear-gradient(135deg, #8b5cf6, #ec4899)' })}

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-input" id="risknote-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="risknote-store">
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Type of Behavior</label>
                                <select class="form-input" id="risknote-type">
                                    <option value="strange_questions">Strange Questions</option>
                                    <option value="unusual_purchase">Unusual Purchase</option>
                                    <option value="recording">Recording / Taking Photos</option>
                                    <option value="policy_violation">Policy Violation Attempt</option>
                                    <option value="suspicious_attitude">Suspicious Attitude</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="risknote-description" rows="3" placeholder="Describe what happened... or use the voice assistant above!"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Risk Level</label>
                                <div style="display: flex; gap: 12px;">
                                    <button type="button" class="risk-level-btn" data-level="low" onclick="selectRiskLevel('low')" style="flex: 1; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 20px; margin-bottom: 4px; color: #22c55e;">üü¢</div>
                                        <div style="font-size: 12px; font-family: Outfit;">Low</div>
                                    </button>
                                    <button type="button" class="risk-level-btn" data-level="medium" onclick="selectRiskLevel('medium')" style="flex: 1; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 20px; margin-bottom: 4px; color: #f59e0b;">üü°</div>
                                        <div style="font-size: 12px; font-family: Outfit;">Medium</div>
                                    </button>
                                    <button type="button" class="risk-level-btn" data-level="high" onclick="selectRiskLevel('high')" style="flex: 1; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 20px; margin-bottom: 4px; color: #ef4444; font-family: Outfit;">üî¥</div>
                                        <div style="font-size: 12px; font-family: Outfit;">High</div>
                                    </button>
                                </div>
                                <input type="hidden" id="risknote-level" value="low">
                            </div>
                            <div class="form-group">
                                <label>Reported By</label>
                                <input type="text" class="form-input" id="risknote-reporter" placeholder="Your name...">
                            </div>
                            <div class="form-group">
                                <label>Photo (Optional)</label>
                                <div style="border: 2px dashed var(--border-color); border-radius: 12px; padding: 16px; text-align: center; background: var(--bg-hover);">
                                    <input type="file" id="risknote-photo" accept="image/*" onchange="previewRiskNotePhoto(this)" style="display: none;">
                                    <div id="risknote-photo-preview" style="display: none; margin-bottom: 12px;">
                                        <img id="risknote-photo-img" style="max-width: 100%; max-height: 150px; border-radius: 8px; object-fit: cover;">
                                    </div>
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('risknote-photo').click()" style="margin: 0;">
                                        <i class="fas fa-camera"></i> Upload Photo
                                    </button>
                                    <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 12px;">Add photo evidence if available</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Manager Note (Optional)</label>
                                <textarea class="form-input" id="risknote-manager-note" rows="2" placeholder="Internal notes for management..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveRiskNote()">
                                <i class="fas fa-save"></i> Save Note
                            </button>
                        </div>
                    `;
                    break;

                case 'add-gift':
                    // Initialize voice assistant for gift form
                    setTimeout(() => {
                        VoiceAssistant.init('gift', {
                            title: 'AI Voice Assistant',
                            subtitle: 'Speak to auto-fill the gift form',
                            buttonColor: 'linear-gradient(135deg, #ec4899, #f59e0b)',
                            listeningText: 'Listening... Describe the gift',
                            systemPrompt: 'You are an assistant helping to document gifts given at a retail store. Extract structured information from voice transcripts about gifts given to customers, vendors, or employees.',
                            prompt: `Analyze this voice transcript about a gift and extract the information. Return ONLY a JSON object with these fields (use null for any field you cannot determine):

Transcript: "{transcript}"

{
    "productName": "the product being given as a gift",
    "quantity": "number of items (default 1)",
    "value": "estimated value in dollars as a number",
    "recipientName": "name of person receiving the gift",
    "recipientType": "one of: customer, vendor, employee, other",
    "reason": "clear explanation of why the gift was given",
    "store": "one of: Miramar, Morena, Kearny Mesa, Chula Vista, North Park, Miramar Wine & Liquor (if mentioned)",
    "notes": "any additional relevant details"
}

Return ONLY the JSON object, no additional text.`,
                            onFill: (data) => {
                                if (data.productName) document.getElementById('gift-product').value = data.productName;
                                if (data.quantity) {
                                    const qty = parseInt(data.quantity);
                                    if (!isNaN(qty) && qty > 0) document.getElementById('gift-quantity').value = qty;
                                }
                                if (data.value) {
                                    const val = parseFloat(data.value.toString().replace(/[^0-9.]/g, ''));
                                    if (!isNaN(val)) document.getElementById('gift-value').value = val.toFixed(2);
                                }
                                if (data.recipientName) document.getElementById('gift-recipient').value = data.recipientName;
                                if (data.recipientType) {
                                    const typeSelect = document.getElementById('gift-recipient-type');
                                    for (let opt of typeSelect.options) {
                                        if (opt.value === data.recipientType.toLowerCase()) { typeSelect.value = opt.value; break; }
                                    }
                                }
                                if (data.reason) document.getElementById('gift-reason').value = data.reason;
                                else if (data._transcript) document.getElementById('gift-reason').value = data._transcript;
                                if (data.store) {
                                    const storeSelect = document.getElementById('gift-store');
                                    for (let opt of storeSelect.options) {
                                        if (opt.value.toLowerCase().includes(data.store.toLowerCase()) || data.store.toLowerCase().includes(opt.value.toLowerCase())) {
                                            storeSelect.value = opt.value; break;
                                        }
                                    }
                                }
                                if (data.notes) document.getElementById('gift-notes').value = data.notes;
                            }
                        });
                    }, 100);

                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-gift"></i> Register Gift</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <!-- AI Voice Assistant Section -->
                            ${VoiceAssistant.getHTML('gift', { title: 'AI Voice Assistant', subtitle: 'Speak to auto-fill the gift form', buttonColor: 'linear-gradient(135deg, #ec4899, #f59e0b)' })}

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Product Name</label>
                                    <input type="text" class="form-input" id="gift-product" placeholder="e.g., Vape Pen SMOK Nord 4">
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-input" id="gift-quantity" value="1" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Value ($)</label>
                                    <input type="number" step="0.01" class="form-input" id="gift-value" placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Recipient Name</label>
                                    <input type="text" class="form-input" id="gift-recipient" placeholder="Name of person receiving the gift">
                                </div>
                                <div class="form-group">
                                    <label>Recipient Type</label>
                                    <select class="form-input" id="gift-recipient-type">
                                        <option value="">Select type...</option>
                                        <option value="customer">Customer</option>
                                        <option value="vendor">Vendor</option>
                                        <option value="employee">Employee</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Reason for Gift</label>
                                <textarea class="form-input" id="gift-reason" rows="2" placeholder="e.g., Defective product replacement, compensation for error... or use voice above!"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="gift-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-input" id="gift-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea class="form-input" id="gift-notes" rows="2" placeholder="Any additional details..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Photo of Gift</label>
                                <div class="file-upload">
                                    <input type="file" id="gift-photo" accept="image/*">
                                    <div class="file-upload-content">
                                        <i class="fas fa-camera"></i>
                                        <span>Click to upload photo</span>
                                        <small>JPG, PNG, GIF accepted</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveGift()">
                                <i class="fas fa-save"></i>
                                Save Gift
                            </button>
                        </div>
                    `;
                    break;

                case 'edit-gift':
                    const editGiftRecord = giftsRecords.find(r => r.id === data);
                    if (!editGiftRecord) {
                        content = '<div class="modal-body"><p>Gift record not found</p></div>';
                        break;
                    }
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Gift</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Product Name</label>
                                    <input type="text" class="form-input" id="gift-product" value="${editGiftRecord.product || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-input" id="gift-quantity" value="${editGiftRecord.quantity || 1}" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Value ($)</label>
                                    <input type="number" step="0.01" class="form-input" id="gift-value" value="${editGiftRecord.value || ''}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Recipient Name</label>
                                    <input type="text" class="form-input" id="gift-recipient" value="${editGiftRecord.recipient || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Recipient Type</label>
                                    <select class="form-input" id="gift-recipient-type">
                                        <option value="">Select type...</option>
                                        <option value="customer" ${editGiftRecord.recipientType === 'customer' ? 'selected' : ''}>Customer</option>
                                        <option value="vendor" ${editGiftRecord.recipientType === 'vendor' ? 'selected' : ''}>Vendor</option>
                                        <option value="employee" ${editGiftRecord.recipientType === 'employee' ? 'selected' : ''}>Employee</option>
                                        <option value="other" ${editGiftRecord.recipientType === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Reason for Gift</label>
                                <textarea class="form-input" id="gift-reason" rows="2">${editGiftRecord.reason || ''}</textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Store</label>
                                    <select class="form-input" id="gift-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar" ${editGiftRecord.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                        <option value="Morena" ${editGiftRecord.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                        <option value="Kearny Mesa" ${editGiftRecord.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                        <option value="Chula Vista" ${editGiftRecord.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                        <option value="North Park" ${editGiftRecord.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                        <option value="Miramar Wine & Liquor" ${editGiftRecord.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-input" id="gift-date" value="${editGiftRecord.date || ''}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea class="form-input" id="gift-notes" rows="2">${editGiftRecord.notes || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Photo of Gift</label>
                                <div class="file-upload">
                                    <input type="file" id="gift-photo" accept="image/*">
                                    <div class="file-upload-content">
                                        <i class="fas fa-camera"></i>
                                        <span>Click to upload new photo</span>
                                        <small>JPG, PNG, GIF accepted</small>
                                    </div>
                                </div>
                                ${editGiftRecord.photo ? `<img src="${editGiftRecord.photo}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;">` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveGift(true, '${String(editGiftRecord.id).replace(/'/g, "\\'")}')">
                                <i class="fas fa-save"></i>
                                Update Gift
                            </button>
                        </div>
                    `;
                    break;

                case 'add-schedule':
                    const scheduleEmployeeOptions = employees.map(emp =>
                        `<option value="${emp.id}">${emp.name} - ${emp.store}</option>`
                    ).join('');
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-calendar-plus"></i> Add Schedule</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Employee *</label>
                                    <select class="form-input" id="schedule-employee">
                                        <option value="">Select employee...</option>
                                        ${scheduleEmployeeOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="schedule-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar">VSU Miramar</option>
                                        <option value="Morena">VSU Morena</option>
                                        <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                        <option value="Chula Vista">VSU Chula Vista</option>
                                        <option value="North Park">VSU North Park</option>
                                        <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="schedule-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Start Time *</label>
                                    <input type="time" class="form-input" id="schedule-start" value="09:00">
                                </div>
                                <div class="form-group">
                                    <label>End Time *</label>
                                    <input type="time" class="form-input" id="schedule-end" value="17:00">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveSchedule()">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                        </div>
                    `;
                    break;

                case 'quick-add-schedule':
                    const quickData = data || {};
                    const dayName = quickData.date ? new Date(quickData.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) : '';
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-clock"></i> Add Shift</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--bg-hover); padding: 12px 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--text-primary);">${quickData.employeeName || 'Employee'}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">${dayName} @ ${quickData.store || ''}</div>
                            </div>
                            <input type="hidden" id="schedule-employee" value="${quickData.employeeId || ''}">
                            <input type="hidden" id="schedule-store" value="${quickData.store || ''}">
                            <input type="hidden" id="schedule-date" value="${quickData.date || ''}">
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button type="button" class="shift-preset-btn" onclick="setShiftPreset('09:00', '17:00')" style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                                    <div style="font-weight: 600;">Morning</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">9am - 5pm</div>
                                </button>
                                <button type="button" class="shift-preset-btn" onclick="setShiftPreset('14:00', '22:00')" style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                                    <div style="font-weight: 600;">Evening</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">2pm - 10pm</div>
                                </button>
                                <button type="button" class="shift-preset-btn" onclick="setShiftPreset('10:00', '19:00')" style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); cursor: pointer; transition: all 0.2s;">
                                    <div style="font-weight: 600;">Mid</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">10am - 7pm</div>
                                </button>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Start Time</label>
                                    <input type="time" class="form-input" id="schedule-start" value="09:00" style="font-size: 18px; padding: 12px;">
                                </div>
                                <div class="form-group">
                                    <label>End Time</label>
                                    <input type="time" class="form-input" id="schedule-end" value="17:00" style="font-size: 18px; padding: 12px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveSchedule()" style="min-width: 120px;">
                                <i class="fas fa-plus"></i> Add Shift
                            </button>
                        </div>
                    `;
                    break;

                case 'edit-schedule':
                    const editSchedule = schedules.find(s => s.id === data);
                    if (!editSchedule) {
                        content = '<div class="modal-body"><p>Schedule not found</p></div>';
                        break;
                    }
                    const editScheduleEmployeeOptions = employees.map(emp =>
                        `<option value="${emp.id}" ${emp.id === editSchedule.employeeId ? 'selected' : ''}>${emp.name} - ${emp.store}</option>`
                    ).join('');
                    content = `
                        <div class="modal-header">
                            <h2><i class="fas fa-calendar-edit"></i> Edit Schedule</h2>
                            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Employee *</label>
                                    <select class="form-input" id="schedule-employee">
                                        <option value="">Select employee...</option>
                                        ${editScheduleEmployeeOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Store *</label>
                                    <select class="form-input" id="schedule-store">
                                        <option value="">Select store...</option>
                                        <option value="Miramar" ${editSchedule.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                        <option value="Morena" ${editSchedule.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                        <option value="Kearny Mesa" ${editSchedule.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                        <option value="Chula Vista" ${editSchedule.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                        <option value="North Park" ${editSchedule.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                        <option value="Miramar Wine & Liquor" ${editSchedule.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" class="form-input" id="schedule-date" value="${editSchedule.date || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Start Time *</label>
                                    <input type="time" class="form-input" id="schedule-start" value="${editSchedule.startTime || '09:00'}">
                                </div>
                                <div class="form-group">
                                    <label>End Time *</label>
                                    <input type="time" class="form-input" id="schedule-end" value="${editSchedule.endTime || '17:00'}">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="updateSchedule('${editSchedule.id}')">
                                <i class="fas fa-save"></i>
                                Update
                            </button>
                        </div>
                    `;
                    break;
            }

            modalContent.innerHTML = content;
            modal.classList.add('active');

            // Add event listener for customer request checkbox if it exists
            const customerCheckbox = document.getElementById('customer-request');
            if (customerCheckbox) {
                customerCheckbox.addEventListener('change', function() {
                    const customerInfo = document.getElementById('customer-info');
                    customerInfo.disabled = !this.checked;
                    if (!this.checked) {
                        customerInfo.value = '';
                        customerInfo.style.background = 'var(--bg-hover)';
                    } else {
                        customerInfo.style.background = 'var(--bg-card)';
                    }
                });
            }
        }

        function closeModal(forceClose = false) {
            // Reset form protection before closing
            if (typeof formProtectionManager !== 'undefined') {
                formProtectionManager.resetProtection();
            }

            document.getElementById('modal').classList.remove('active');
        }

        function viewEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Employee Profile</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="employee-profile">
                        <div class="profile-header">
                            ${emp.photo
                                ? `<div class="employee-avatar-xl" style="background-image: url('${emp.photo}'); background-size: cover; background-position: center; cursor: pointer;" onclick="showImageModal('${emp.photo}', '${emp.name}')"></div>`
                                : `<div class="employee-avatar-xl ${emp.color}">${emp.initials}</div>`
                            }
                            <div class="profile-info">
                                <h2>${emp.name}</h2>
                                <p>${emp.role} @ ${emp.store}</p>
                                <span class="status-badge ${emp.status}">${emp.status}</span>
                            </div>
                        </div>
                        <div class="profile-details">
                            <div class="detail-row">
                                <i class="fas fa-envelope"></i>
                                <span>${emp.authEmail}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-phone"></i>
                                <span>${emp.phone}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-calendar"></i>
                                <span>Hired: ${formatDate(emp.hireDate)}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-ambulance"></i>
                                <span>Emergency: ${emp.emergencyContact}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-allergies"></i>
                                <span>Allergies: ${emp.allergies}</span>
                            </div>
                        </div>
                        <!-- Certifications Section -->
                        <div class="form-divider"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 class="form-section-title" style="margin: 0;"><i class="fas fa-certificate" style="color: #f59e0b; margin-right: 8px;"></i>Certifications</h3>
                            <button class="btn-secondary" onclick="openAddCertificationModal('${emp.id}')" style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        ${emp.certifications && emp.certifications.length > 0 ? `
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${emp.certifications.map((cert, index) => {
                                const isExpired = cert.expirationDate && new Date(cert.expirationDate) < new Date();
                                const isExpiringSoon = cert.expirationDate && !isExpired && new Date(cert.expirationDate) < new Date(Date.now() + 30*24*60*60*1000);
                                const statusColor = isExpired ? '#ef4444' : isExpiringSoon ? '#f59e0b' : '#10b981';
                                const statusText = isExpired ? 'Expired' : isExpiringSoon ? 'Expiring Soon' : 'Valid';
                                return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); border-left: 3px solid ${statusColor};">
                                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                        <i class="fas fa-award" style="color: ${statusColor}; font-size: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${cert.name}</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">
                                                ${cert.issuedBy || 'N/A'} ‚Ä¢ ${cert.expirationDate ? 'Expires: ' + formatDate(cert.expirationDate) : 'No expiration'}
                                                <span style="margin-left: 8px; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: ${statusColor}20; color: ${statusColor};">${statusText}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 6px;">
                                        ${cert.fileURL ? `<button class="btn-icon" onclick="window.open('${cert.fileURL}', '_blank')" title="View Certificate"><i class="fas fa-eye"></i></button>` : ''}
                                        <button class="btn-icon danger" onclick="deleteCertification('${emp.id}', ${index})" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            `;}).join('')}
                        </div>
                        ` : `
                        <div style="text-align: center; padding: 20px; color: var(--text-muted); background: var(--bg-secondary); border-radius: 8px;">
                            <i class="fas fa-certificate" style="font-size: 24px; opacity: 0.3; margin-bottom: 8px;"></i>
                            <p style="margin: 0; font-size: 13px;">No certifications added yet</p>
                        </div>
                        `}

                        ${emp.paperwork && emp.paperwork.length > 0 ? `
                        <div class="form-divider"></div>
                        <h3 class="form-section-title">Employee Paperwork</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${emp.paperwork.map((doc, index) => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                        <i class="fas ${getFileIcon(doc.fileType)}" style="color: var(--accent-primary); font-size: 18px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${doc.fileName}</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">
                                                ${doc.documentType || 'Document'} ‚Ä¢ ${formatFileSize(doc.fileSize)} ‚Ä¢ ${formatDate(doc.uploadedAt.toDate ? doc.uploadedAt.toDate() : doc.uploadedAt)}
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn-icon" onclick="showDocumentPreview({ url: '${doc.downloadURL}', fileName: '${doc.fileName}', fileType: '${doc.fileType || ''}', fileSize: ${doc.fileSize || 0}, documentType: '${doc.documentType || 'Document'}', uploadedAt: '${doc.uploadedAt?.toDate ? doc.uploadedAt.toDate().toISOString() : doc.uploadedAt}' })" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                    <button class="btn-secondary" style="display:none;" onclick="requestDayOff('${emp.id}')"><i class="fas fa-calendar-xmark"></i> Day Off Request</button>
                    <button class="btn-primary" onclick="editEmployee('${emp.id}')"><i class="fas fa-edit"></i> Edit</button>
                </div>
            `;
            modal.classList.add('active');
        }

        // Certification Management Functions
        function openAddCertificationModal(employeeId) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-certificate" style="color: #f59e0b;"></i> Add Certification</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Certification Name *</label>
                        <input type="text" class="form-input" id="cert-name" placeholder="e.g., Alcohol Sales License, Food Handler's Permit">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Issued By</label>
                            <input type="text" class="form-input" id="cert-issued-by" placeholder="e.g., State of California, ABC Board">
                        </div>
                        <div class="form-group">
                            <label>Issue Date</label>
                            <input type="date" class="form-input" id="cert-issue-date">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Expiration Date</label>
                            <input type="date" class="form-input" id="cert-expiration-date">
                        </div>
                        <div class="form-group">
                            <label>Certificate Number</label>
                            <input type="text" class="form-input" id="cert-number" placeholder="Optional">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Upload Certificate (Optional)</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="file" id="cert-file" accept="image/*,.pdf" style="display: none;" onchange="previewCertFile(this)">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('cert-file').click()">
                                <i class="fas fa-upload"></i> Upload File
                            </button>
                            <input type="file" id="cert-camera" accept="image/*" capture="environment" style="display: none;" onchange="previewCertFile(this)">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('cert-camera').click()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
                                <i class="fas fa-camera"></i> Take Photo
                            </button>
                        </div>
                        <div id="cert-file-preview" style="margin-top: 12px;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="viewEmployee('${employeeId}')">Cancel</button>
                    <button class="btn-primary" onclick="saveCertification('${employeeId}')">
                        <i class="fas fa-save"></i> Save Certification
                    </button>
                </div>
            `;
            modal.classList.add('active');
        }

        function previewCertFile(input) {
            const preview = document.getElementById('cert-file-preview');
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const isImage = file.type.startsWith('image/');

                if (isImage) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <img src="${e.target.result}" style="max-width: 80px; max-height: 80px; border-radius: 6px; object-fit: cover;">
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${file.name}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${(file.size / 1024).toFixed(1)} KB</div>
                                </div>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444;"></i>
                            <div>
                                <div style="font-weight: 500; color: var(--text-primary);">${file.name}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${(file.size / 1024).toFixed(1)} KB</div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        async function saveCertification(employeeId) {
            const name = document.getElementById('cert-name').value.trim();
            const issuedBy = document.getElementById('cert-issued-by').value.trim();
            const issueDate = document.getElementById('cert-issue-date').value;
            const expirationDate = document.getElementById('cert-expiration-date').value;
            const certNumber = document.getElementById('cert-number').value.trim();
            const fileInput = document.getElementById('cert-file');
            const cameraInput = document.getElementById('cert-camera');

            if (!name) {
                alert('Please enter a certification name');
                return;
            }

            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;

            try {
                let fileURL = null;

                // Upload file if provided
                const file = (fileInput && fileInput.files[0]) || (cameraInput && cameraInput.files[0]);
                if (file) {
                    // Convert to base64
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });

                    // Initialize storage helper if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        base64,
                        'employees/certifications',
                        employeeId + '_' + Date.now()
                    );

                    if (uploadResult && uploadResult.url) {
                        fileURL = uploadResult.url;
                    }
                }

                // Create certification object
                const certification = {
                    name,
                    issuedBy: issuedBy || null,
                    issueDate: issueDate || null,
                    expirationDate: expirationDate || null,
                    certNumber: certNumber || null,
                    fileURL,
                    addedAt: new Date().toISOString()
                };

                // Find employee and add certification
                const emp = employees.find(e => e.id === employeeId);
                if (emp) {
                    if (!emp.certifications) emp.certifications = [];
                    emp.certifications.push(certification);

                    // Save to Firebase
                    if (firebaseEmployeeManager.isInitialized) {
                        await firebaseEmployeeManager.updateEmployee(employeeId, {
                            certifications: emp.certifications
                        });
                    }
                }

                // Refresh the employee view
                viewEmployee(employeeId);

            } catch (error) {
                console.error('Error saving certification:', error);
                alert('Error saving certification: ' + error.message);
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function deleteCertification(employeeId, certIndex) {
            if (!confirm('Are you sure you want to delete this certification?')) return;

            try {
                const emp = employees.find(e => e.id === employeeId);
                if (emp && emp.certifications) {
                    emp.certifications.splice(certIndex, 1);

                    // Save to Firebase
                    if (firebaseEmployeeManager.isInitialized) {
                        await firebaseEmployeeManager.updateEmployee(employeeId, {
                            certifications: emp.certifications
                        });
                    }

                    // Refresh the employee view
                    viewEmployee(employeeId);
                }
            } catch (error) {
                console.error('Error deleting certification:', error);
                alert('Error deleting certification: ' + error.message);
            }
        }

        /**
         * Get current user info (simulated - would come from Firebase Auth in production)
         */
        function getCurrentUser() {
            // Get user from authentication manager
            const user = authManager.getCurrentUser();
            
            if (user) {
                return user;
            }
            
            // Fallback if not authenticated (should redirect to login)
            return {
                id: null,
                name: 'Unknown',
                email: 'unknown@vsu.com',
                role: 'employee'
            };
        }

        /**
         * Check if current user has permission for an action
         */
        function checkPermission(permission) {
            const currentUser = getCurrentUser();
            const permissions = window.ROLE_PERMISSIONS?.[currentUser.role];
            
            if (!permissions) {
                console.warn('No permissions found for role:', currentUser.role);
                return false;
            }

            return permissions[permission] === true;
        }

        /**
         * Show permission denied message
         */
        function showPermissionDenied(action = 'perform this action') {
            const currentUser = getCurrentUser();
            const roleLabel = window.ROLE_PERMISSIONS?.[currentUser.role]?.label || currentUser.role;
            
            alert(`‚ùå Permission Denied\n\nYour role (${roleLabel}) does not have permission to ${action}.\n\nPlease contact an Administrator for assistance.`);
        }

        /**
         * Filter navigation menu based on user role
         * Show/hide menu items that user doesn't have access to
         */
        function filterNavigationByRole() {
            const user = getCurrentUser();
            const userRole = user.role || 'employee';
            const userPermissions = window.ROLE_PERMISSIONS[userRole] || window.ROLE_PERMISSIONS['employee'];
            const allowedPages = userPermissions.pages || [];

            // Hide all nav items first
            document.querySelectorAll('.nav-section a, .nav-section div').forEach(item => {
                if (!item.classList.contains('nav-label')) {
                    item.style.display = 'none';
                }
            });

            // Always show Celeste AI (it's available to all roles if in their permissions)
            if (allowedPages.includes('celesteai')) {
                const celesteItem = document.querySelector('.nav-item[data-page="celesteai"]');
                if (celesteItem) {
                    celesteItem.style.display = '';
                }
            }

            // Show only allowed pages using data-page attribute
            allowedPages.forEach(page => {
                document.querySelectorAll(`.nav-item[data-page="${page}"], .nav-dropdown-item[data-page="${page}"]`).forEach(item => {
                    item.style.display = '';

                    // Show parent div if it's a nav-item
                    if (item.classList.contains('nav-item') && item.parentElement.tagName === 'DIV') {
                        item.parentElement.style.display = '';
                    }

                    // If it's a dropdown item, show parent dropdown and parent nav-item
                    if (item.classList.contains('nav-dropdown-item')) {
                        const dropdownContainer = item.closest('.nav-dropdown');
                        if (dropdownContainer) {
                            dropdownContainer.style.display = '';
                            // Find and show the parent nav-item that triggers this dropdown
                            const parentNavItem = dropdownContainer.previousElementSibling;
                            if (parentNavItem && parentNavItem.classList.contains('nav-item')) {
                                parentNavItem.style.display = '';
                                if (parentNavItem.parentElement.tagName === 'DIV') {
                                    parentNavItem.parentElement.style.display = '';
                                }
                            }
                        }
                    }
                });
            });

            // Show parent divs that contain visible nav-items
            document.querySelectorAll('.nav-section > div').forEach(div => {
                const hasVisibleItems = div.querySelector('.nav-item:not([style*="display: none"])');
                if (hasVisibleItems) {
                    div.style.display = '';
                }
            });

            // Ensure only current page has active class
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === currentPage) {
                    item.classList.add('active');
                }
            });
        }

        function editEmployee(id) {
            // Check permission
            if (!checkPermission('canEditAllEmployees')) {
                showPermissionDenied('edit employees');
                return;
            }

            // Find employee by id or firestoreId
            const emp = employees.find(e => e.id === id || e.firestoreId === id);
            if (!emp) {
                alert('Employee not found');
                return;
            }

            // Store the employee being edited (using the global variable declared in openModal section)
            editingEmployeeId = emp.firestoreId || emp.id;

            // Open modal with edit form
            openModal('edit-employee', emp);
        }

        /**
         * Save edited employee to Firebase
         */
        async function saveEditedEmployee() {
            if (!editingEmployeeId) {
                alert('No employee selected for editing');
                return;
            }
            const employeeId = editingEmployeeId;

            // Get the current employee data
            const currentEmployee = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);
            if (!currentEmployee) {
                alert('Employee not found');
                return;
            }

            // Get current name parts for fallback
            const currentNameParts = (currentEmployee.name || '').split(' ');
            const currentFirstName = currentNameParts[0] || '';
            const currentLastName = currentNameParts.slice(1).join(' ') || '';

            const firstName = document.getElementById('edit-emp-first-name').value.trim() || currentFirstName;
            const lastName = document.getElementById('edit-emp-last-name').value.trim() || currentLastName;
            const authEmail = document.getElementById('edit-emp-email').value.trim() || currentEmployee.authEmail;
            const phone = document.getElementById('edit-emp-phone').value.trim() || currentEmployee.phone;
            const password = document.getElementById('edit-emp-password').value.trim();
            const confirmPassword = document.getElementById('edit-emp-confirm-password').value.trim();
            const role = document.getElementById('edit-emp-role').value || currentEmployee.role;
            const employeeType = document.getElementById('edit-emp-employee-type')?.value || currentEmployee.employeeType || 'employee';
            const store = document.getElementById('edit-emp-store').value || currentEmployee.store;
            const status = document.getElementById('edit-emp-status').value || currentEmployee.status;
            const hireDate = document.getElementById('edit-emp-hire-date').value || currentEmployee.hireDate;
            const emergencyName = document.getElementById('edit-emp-emergency-name').value.trim();
            const emergencyPhone = document.getElementById('edit-emp-emergency-phone').value.trim();
            const allergies = document.getElementById('edit-emp-allergies').value.trim();

            // Check if status is changing from active to inactive - trigger offboarding
            if (currentEmployee.status === 'active' && status === 'inactive') {
                // Store the pending update data temporarily
                window.pendingOffboardingData = {
                    employeeId,
                    currentEmployee,
                    updatedData: {
                        firstName, lastName, authEmail, phone, password, confirmPassword,
                        role, employeeType, store, status, hireDate, emergencyName, emergencyPhone, allergies
                    }
                };
                // Close current modal and open offboarding modal
                closeModal();
                setTimeout(() => {
                    openModal('offboarding', currentEmployee);
                }, 100);
                return;
            }

            // If new password is provided, validate it
            if (password && !confirmPassword) {
                alert('Please confirm the new password');
                return;
            }

            if (password && password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (password && password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            const updatedData = {
                name: `${firstName} ${lastName}`,
                initials: `${firstName[0]}${lastName[0]}`.toUpperCase(),
                authEmail,
                phone,
                role,
                employeeType,
                store,
                status,
                hireDate: hireDate || new Date().toISOString().split('T')[0],
                emergencyContact: combineEmergencyContact(emergencyName, emergencyPhone) || currentEmployee.emergencyContact || 'Not provided',
                allergies: allergies || currentEmployee.allergies || 'None'
            };

            // Only include password if it's being changed
            // Note: This will trigger a password reset email to be sent to the employee
            let passwordResetRequested = false;
            if (password) {
                updatedData.password = password;
                passwordResetRequested = true;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Update in Firebase
                if (firebaseEmployeeManager.isInitialized) {
                    // Handle profile photo upload/removal
                    const photoPreview = document.getElementById('edit-emp-photo-preview');
                    const photoInput = document.getElementById('edit-emp-photo');
                    const hasFilePhoto = photoInput && photoInput.files && photoInput.files[0];
                    const hasCapturedPhoto = window.capturedEmployeePhoto && window.capturedPhotoTarget === 'edit-emp-photo';

                    // Check if photo was removed
                    if (photoPreview && photoPreview.getAttribute('data-removed') === 'true') {
                        // Delete old photo from storage if exists
                        if (currentEmployee.photoPath) {
                            try {
                                await firebaseStorageHelper.deleteFile(currentEmployee.photoPath);
                            } catch (err) {
                                console.error('Error deleting old photo:', err);
                            }
                        }
                        updatedData.photo = null;
                        updatedData.photoPath = null;
                    }
                    // Check if new photo was uploaded (from file or camera)
                    else if (hasFilePhoto || hasCapturedPhoto) {
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading photo...';
                        try {
                            let photoBase64;
                            if (hasCapturedPhoto) {
                                photoBase64 = window.capturedEmployeePhoto;
                                // Clear captured photo
                                window.capturedEmployeePhoto = null;
                                window.capturedPhotoTarget = null;
                            } else {
                                const photoFile = photoInput.files[0];
                                const reader = new FileReader();
                                photoBase64 = await new Promise((resolve) => {
                                    reader.onload = (e) => resolve(e.target.result);
                                    reader.readAsDataURL(photoFile);
                                });
                            }

                            // Delete old photo from storage if exists
                            if (currentEmployee.photoPath) {
                                try {
                                    await firebaseStorageHelper.deleteFile(currentEmployee.photoPath);
                                } catch (err) {
                                    console.error('Error deleting old photo:', err);
                                }
                            }

                            // Initialize storage helper if needed
                            if (!firebaseStorageHelper.isInitialized) {
                                firebaseStorageHelper.initialize();
                            }

                            const uploadResult = await firebaseStorageHelper.uploadImage(
                                photoBase64,
                                'employees/photos',
                                employeeId,
                                500,  // maxSizeKB
                                false // showOverlay - we're showing our own spinner
                            );

                            if (uploadResult && uploadResult.url) {
                                updatedData.photo = uploadResult.url;
                                updatedData.photoPath = uploadResult.path;
                                console.log('Employee photo uploaded to Firebase Storage:', uploadResult.url);
                            }
                        } catch (photoError) {
                            console.error('Error uploading employee photo:', photoError);
                            showNotification('Error uploading photo', 'warning');
                        }
                    }

                    const success = await firebaseEmployeeManager.updateEmployee(employeeId, updatedData);
                    if (!success) {
                        throw new Error('Failed to update in Firebase');
                    }

                    // Upload new paperwork files if any
                    if (editEmployeePaperworkFiles.length > 0) {
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading documents...';

                        for (const file of editEmployeePaperworkFiles) {
                            try {
                                await firebaseEmployeeManager.uploadPaperwork(employeeId, file, 'Document');
                            } catch (uploadError) {
                                console.error('Error uploading file:', file.name, uploadError);
                                // Continue with other files even if one fails
                            }
                        }

                        // Clear the selected files after upload
                        editEmployeePaperworkFiles = [];
                    }
                }

                // Reload employee data to get latest paperwork
                let updatedEmployee = updatedData;
                if (firebaseEmployeeManager.isInitialized) {
                    const freshData = await firebaseEmployeeManager.getEmployee(employeeId);
                    if (freshData) {
                        updatedEmployee = freshData;
                    }
                }

                // Update local array
                const index = employees.findIndex(e => e.id === employeeId || e.firestoreId === employeeId);
                if (index !== -1) {
                    employees[index] = {
                        ...employees[index],
                        ...updatedEmployee
                    };
                }

                // Clear editing state
                editingEmployeeId = null;

                closeModal();
                renderPage(currentPage);

                // Show appropriate notification based on whether password reset was requested
                if (passwordResetRequested) {
                    showNotification('Employee updated! A password reset email has been sent to the employee.', 'success');
                } else {
                    showNotification('Employee updated successfully!', 'success');
                }
            } catch (error) {
                console.error('Error updating employee:', error);
                alert('Error updating employee. Please try again.');

                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        // Offboarding Functions
        function cancelOffboarding() {
            window.pendingOffboardingData = null;
            closeModal();
            showNotification('Offboarding cancelled. Employee status unchanged.', 'info');
        }

        async function confirmOffboarding() {
            const pendingData = window.pendingOffboardingData;
            if (!pendingData) {
                alert('No pending offboarding data found');
                closeModal();
                return;
            }

            // Validate required fields
            const reason = document.getElementById('offboard-reason').value;
            const lastDay = document.getElementById('offboard-last-day').value;
            const receivedBy = document.getElementById('offboard-received-by').value.trim();
            const otherReason = document.getElementById('offboard-other-reason')?.value || '';

            if (!reason) {
                alert('Please select a reason for leaving');
                return;
            }

            if (reason === 'other' && !otherReason.trim()) {
                alert('Please specify the reason for leaving');
                return;
            }

            if (!lastDay) {
                alert('Please enter the last day worked');
                return;
            }

            if (!receivedBy) {
                alert('Please enter who received the items');
                return;
            }

            // Collect offboarding data
            const offboardingData = {
                reason: reason,
                reasonText: reason === 'other' ? otherReason : getOffboardingReasonText(reason),
                lastDayWorked: lastDay,
                keysReturned: document.getElementById('offboard-keys').checked,
                receivedBy: receivedBy,
                notes: document.getElementById('offboard-notes').value.trim(),
                offboardingDate: new Date().toISOString(),
                offboardingBy: getCurrentUser().name || 'Admin'
            };

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                saveBtn.disabled = true;
            }

            try {
                const { employeeId, currentEmployee, updatedData } = pendingData;

                // Build the full update object
                const fullUpdatedData = {
                    name: `${updatedData.firstName} ${updatedData.lastName}`,
                    initials: `${updatedData.firstName[0]}${updatedData.lastName[0]}`.toUpperCase(),
                    authEmail: updatedData.authEmail || currentEmployee.authEmail,
                    phone: updatedData.phone,
                    role: updatedData.role,
                    employeeType: updatedData.employeeType,
                    store: updatedData.store,
                    status: 'inactive',
                    hireDate: updatedData.hireDate || new Date().toISOString().split('T')[0],
                    emergencyContact: combineEmergencyContact(updatedData.emergencyName, updatedData.emergencyPhone) || currentEmployee.emergencyContact || 'Not provided',
                    allergies: updatedData.allergies || currentEmployee.allergies || 'None',
                    offboarding: offboardingData
                };

                // Only include password if it's being changed
                if (updatedData.password) {
                    fullUpdatedData.password = updatedData.password;
                }

                // Update in Firebase
                if (firebaseEmployeeManager.isInitialized) {
                    const success = await firebaseEmployeeManager.updateEmployee(employeeId, fullUpdatedData);
                    if (!success) {
                        throw new Error('Failed to update in Firebase');
                    }
                }

                // Update local array
                const index = employees.findIndex(e => e.id === employeeId || e.firestoreId === employeeId);
                if (index !== -1) {
                    employees[index] = {
                        ...employees[index],
                        ...fullUpdatedData
                    };
                }

                // Clear pending data
                window.pendingOffboardingData = null;
                editingEmployeeId = null;

                closeModal();
                renderPage(currentPage);
                updateEmployeeCountBadge();
                showNotification(`${currentEmployee.name} has been deactivated and offboarding documented.`, 'success');
            } catch (error) {
                console.error('Error during offboarding:', error);
                alert('Error completing offboarding. Please try again.');

                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        function getOffboardingReasonText(reason) {
            const reasons = {
                'resignation': 'Resignation',
                'termination': 'Termination',
                'contract_end': 'End of Contract',
                'abandonment': 'Job Abandonment',
                'mutual': 'Mutual Agreement',
                'other': 'Other'
            };
            return reasons[reason] || reason;
        }

        function deleteEmployee(id) {
            // Check permission
            if (!checkPermission('canDeleteEmployees')) {
                showPermissionDenied('delete employees');
                return;
            }

            // Find employee by id or firestoreId
            const emp = employees.find(e => e.id === id || e.firestoreId === id);
            if (!emp) return;

            // Store pending offboarding data and open offboarding modal
            window.pendingOffboardingData = {
                employeeId: emp.firestoreId || emp.id,
                currentEmployee: emp,
                updatedData: {
                    firstName: emp.name?.split(' ')[0] || '',
                    lastName: emp.name?.split(' ').slice(1).join(' ') || '',
                    authEmail: emp.authEmail,
                    phone: emp.phone,
                    role: emp.role,
                    employeeType: emp.employeeType || 'employee',
                    store: emp.store,
                    status: 'inactive',
                    hireDate: emp.hireDate,
                    emergencyName: emp.emergencyContact?.split(' - ')[0] || '',
                    emergencyPhone: emp.emergencyContact?.split(' - ')[1] || '',
                    allergies: emp.allergies
                }
            };

            // Open offboarding modal
            openModal('offboarding', emp);
        }

        function activateEmployee(id) {
            // Check permission
            if (!checkPermission('canEditAllEmployees')) {
                showPermissionDenied('activate employees');
                return;
            }

            // Find employee by id or firestoreId
            const emp = employees.find(e => e.id === id || e.firestoreId === id);
            if (!emp) return;

            showConfirmModal({
                title: 'Activate Employee',
                message: `Are you sure you want to activate "${emp.name}"? The employee status will be changed to active.`,
                confirmText: 'Activate',
                type: 'info',
                onConfirm: async () => {
                    try {
                        // Mark as active in Firebase
                        const firestoreId = emp.firestoreId || emp.id;
                        if (firebaseEmployeeManager.isInitialized) {
                            const updated = await firebaseEmployeeManager.updateEmployee(firestoreId, { status: 'active' });
                            if (!updated) {
                                throw new Error('Failed to activate employee');
                            }
                        }

                        // Update in local array
                        const empIndex = employees.findIndex(e => e.id === id || e.firestoreId === id);
                        if (empIndex !== -1) {
                            employees[empIndex].status = 'active';
                        }

                        // Update employee count badge
                        updateEmployeeCountBadge();

                        // Re-render page
                        renderPage(currentPage);
                        showNotification('Employee activated successfully', 'success');
                    } catch (error) {
                        console.error('Error activating employee:', error);
                    }
                }
            });
        }

        function filterEmployees() {
            const search = document.getElementById('employee-search').value.toLowerCase();
            const store = document.getElementById('store-filter').value;
            const status = document.getElementById('status-filter').value;

            const filtered = employees.filter(emp => {
                const matchSearch = emp.name.toLowerCase().includes(search) || emp.role.toLowerCase().includes(search);
                const matchStore = !store || emp.store === store;
                const matchStatus = !status || emp.status === status;
                return matchSearch && matchStore && matchStatus;
            });

            document.getElementById('employees-grid').innerHTML = filtered.map(emp => renderEmployeeCard(emp)).join('');
        }

        /**
         * Open modal showing inactive employees with their offboarding details
         */
        function openInactiveEmployeesModal() {
            const inactiveEmployees = employees.filter(emp => emp.status === 'inactive');
            openModal('inactive-employees', inactiveEmployees);
        }

        /**
         * View offboarding details for a specific employee
         */
        function viewOffboardingDetails(employeeId) {
            const emp = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);
            if (!emp || !emp.offboarding) {
                showNotification('No offboarding information available', 'warning');
                return;
            }
            openModal('offboarding-details', emp);
        }

        /**
         * Confirm and permanently delete an employee
         */
        function confirmDeleteEmployee(employeeId, employeeName) {
            showConfirmModal({
                title: 'Delete Employee',
                message: `Are you sure you want to permanently delete "${employeeName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        // Delete from Firebase if initialized
                        if (firebaseEmployeeManager && firebaseEmployeeManager.isInitialized) {
                            const success = await firebaseEmployeeManager.deleteEmployee(employeeId);
                            if (success) {
                                // Remove from local array
                                employees = employees.filter(e => e.firestoreId !== employeeId && e.id !== employeeId);
                                showNotification(`${employeeName} has been permanently deleted.`, 'success');
                                closeModal();
                                renderEmployees();
                                return;
                            } else {
                                showNotification('Failed to delete employee from Firebase', 'error');
                                return;
                            }
                        }

                        // Fallback to local deletion if no Firebase
                        employees = employees.filter(e => e.firestoreId !== employeeId && e.id !== employeeId);
                        showNotification(`${employeeName} has been deleted locally.`, 'success');
                        closeModal();
                        renderEmployees();

                    } catch (error) {
                        console.error('Error deleting employee:', error);
                        showNotification('Error deleting employee. Please try again.', 'error');
                    }
                }
            });
        }

        /**
         * View employee paperwork/documents
         */
        async function viewEmployeePaperwork(employeeId) {
            const emp = employees.find(e => e.id === employeeId || e.firestoreId === employeeId);
            if (!emp) {
                showNotification('Employee not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            // Show loading state
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Employee Documents</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--accent-primary); margin-bottom: 16px;"></i>
                        <p style="color: var(--text-muted);">Loading documents...</p>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            try {
                // Get paperwork from Firebase
                let paperwork = [];
                if (firebaseEmployeeManager.isInitialized) {
                    paperwork = await firebaseEmployeeManager.getPaperwork(employeeId);
                }

                modalContent.innerHTML = `
                    <div class="modal-header">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div class="employee-avatar-lg ${emp.color}">${emp.initials}</div>
                            <div>
                                <h2 style="margin: 0; font-size: 20px;">${emp.name}</h2>
                                <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 13px;">${emp.role} @ ${emp.store}</p>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-file-contract" style="color: var(--accent-primary);"></i>
                                Employee Paperwork & Documents
                            </h3>
                            <p style="color: var(--text-muted); font-size: 13px; margin: 0;">
                                Registered documents: ${paperwork.length}
                            </p>
                        </div>

                        ${paperwork && paperwork.length > 0 ? `
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${paperwork.map((doc, index) => `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--surface-secondary); border-radius: 8px; border: 1px solid var(--border-color); transition: all 0.2s;">
                                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                            <div style="width: 48px; height: 48px; background: ${getDocumentColor(doc.fileType)}; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas ${getFileIcon(doc.fileType)}" style="color: white; font-size: 20px;"></i>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px;">
                                                    ${doc.fileName}
                                                </div>
                                                <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-muted);">
                                                    <span>${doc.documentType || 'Document'}</span>
                                                    <span>‚Ä¢</span>
                                                    <span>${formatFileSize(doc.fileSize)}</span>
                                                    <span>‚Ä¢</span>
                                                    <span>Uploaded ${formatDate(doc.uploadedAt?.toDate ? doc.uploadedAt.toDate() : doc.uploadedAt)}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-icon" onclick="showDocumentPreview({ url: '${doc.downloadURL}', fileName: '${doc.fileName}', fileType: '${doc.fileType || ''}', fileSize: ${doc.fileSize || 0}, documentType: '${doc.documentType || 'Document'}', uploadedAt: '${doc.uploadedAt?.toDate ? doc.uploadedAt.toDate().toISOString() : doc.uploadedAt}' })" title="View Document">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; background: var(--bg-secondary); border-radius: 8px;">
                                <i class="fas fa-inbox" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px; display: block;"></i>
                                <h3 style="color: var(--text-muted); font-size: 16px; margin-bottom: 8px;">No Documents Yet</h3>
                                <p style="color: var(--text-muted); font-size: 13px; margin: 0;">No paperwork has been uploaded for this employee yet.</p>
                            </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading documents:', error);
                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h2>Employee Documents</h2>
                        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"></i>
                            <p>Error loading documents</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                `;
            }
        }

        // Employee photo preview functions

        // Camera modal for taking photos
        function openCameraModal(targetPreviewId, targetInputId) {
            // Remove existing camera modal if any
            const existing = document.getElementById('camera-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'camera-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10001;
                padding: 20px;
                box-sizing: border-box;
            `;
            modal.innerHTML = `
                <div style="position: absolute; top: 20px; right: 20px;">
                    <button onclick="closeCameraModal()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="color: white; font-size: 18px; margin-bottom: 15px; text-align: center;">
                    <i class="fas fa-camera"></i> Take Photo
                </div>
                <div style="position: relative; max-width: 500px; width: 100%;">
                    <video id="camera-video" autoplay playsinline style="width: 100%; border-radius: 12px; transform: scaleX(-1);"></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 16px;">
                    <button onclick="capturePhoto('${targetPreviewId}', '${targetInputId}')" style="background: var(--accent-primary); color: white; border: none; padding: 16px 32px; border-radius: 50px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-camera"></i> Capture
                    </button>
                    <button onclick="switchCamera()" style="background: var(--bg-secondary); color: white; border: none; padding: 16px 20px; border-radius: 50px; font-size: 16px; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div style="color: var(--text-muted); font-size: 12px; margin-top: 12px;">
                    Click capture or press Space to take photo
                </div>
            `;

            document.body.appendChild(modal);

            // Start camera
            window.currentCameraFacing = 'user';
            startCamera();

            // Handle keyboard
            const handleKeydown = (e) => {
                if (e.code === 'Space' || e.key === ' ') {
                    e.preventDefault();
                    capturePhoto(targetPreviewId, targetInputId);
                } else if (e.key === 'Escape') {
                    closeCameraModal();
                }
            };
            document.addEventListener('keydown', handleKeydown);
            modal.setAttribute('data-keyhandler', 'true');
            window.cameraKeyHandler = handleKeydown;
        }

        async function startCamera() {
            try {
                const video = document.getElementById('camera-video');
                if (!video) return;

                // Stop any existing stream
                if (window.cameraStream) {
                    window.cameraStream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: {
                        facingMode: window.currentCameraFacing || 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                window.cameraStream = stream;
                video.srcObject = stream;
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Could not access camera. Please make sure you have granted camera permissions.');
                closeCameraModal();
            }
        }

        function switchCamera() {
            window.currentCameraFacing = window.currentCameraFacing === 'user' ? 'environment' : 'user';
            startCamera();
        }

        function capturePhoto(targetPreviewId, targetInputId) {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            if (!video || !canvas) return;

            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas (flip horizontally to match preview)
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);

            // Get image data
            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            // Update preview
            const preview = document.getElementById(targetPreviewId);
            if (preview) {
                preview.innerHTML = `<img src="${imageData}" style="width: 100%; height: 100%; object-fit: cover;">`;
                preview.style.border = '3px solid var(--accent-primary)';
                if (targetPreviewId.includes('edit')) {
                    preview.setAttribute('data-new-photo', 'true');
                }
            }

            // Store image data for later upload
            window.capturedEmployeePhoto = imageData;
            window.capturedPhotoTarget = targetInputId;

            closeCameraModal();
        }

        function closeCameraModal() {
            // Stop camera stream
            if (window.cameraStream) {
                window.cameraStream.getTracks().forEach(track => track.stop());
                window.cameraStream = null;
            }

            // Remove keyboard handler
            if (window.cameraKeyHandler) {
                document.removeEventListener('keydown', window.cameraKeyHandler);
                window.cameraKeyHandler = null;
            }

            // Remove modal
            const modal = document.getElementById('camera-modal');
            if (modal) modal.remove();
        }

        function previewEmployeePhoto(input) {
            const preview = document.getElementById('emp-photo-preview');
            if (!preview) return;

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('Photo must be less than 5MB');
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    preview.style.border = '3px solid var(--accent-primary)';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeEmployeePhoto() {
            const preview = document.getElementById('emp-photo-preview');
            const input = document.getElementById('emp-photo');
            if (preview) {
                preview.innerHTML = `<i class="fas fa-user" style="font-size: 40px; color: var(--text-muted);"></i>`;
                preview.style.border = '3px dashed var(--border-color)';
            }
            if (input) {
                input.value = '';
            }
            // Clear captured photo from camera
            if (window.capturedPhotoTarget === 'emp-photo') {
                window.capturedEmployeePhoto = null;
                window.capturedPhotoTarget = null;
            }
        }

        function togglePasswordVisibility(fieldId, iconId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(iconId);
            if (field && icon) {
                if (field.type === 'password') {
                    field.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    field.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }
        }

        function previewEditEmployeePhoto(input) {
            const preview = document.getElementById('edit-emp-photo-preview');
            if (!preview) return;

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('Photo must be less than 5MB');
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    preview.style.border = '3px solid var(--accent-primary)';
                    preview.setAttribute('data-new-photo', 'true');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeEditEmployeePhoto() {
            const preview = document.getElementById('edit-emp-photo-preview');
            const input = document.getElementById('edit-emp-photo');
            if (preview) {
                preview.innerHTML = `<i class="fas fa-user" style="font-size: 40px; color: var(--text-muted);"></i>`;
                preview.style.border = '3px dashed var(--border-color)';
                preview.setAttribute('data-removed', 'true');
            }
            if (input) {
                input.value = '';
            }
            // Clear captured photo from camera
            if (window.capturedPhotoTarget === 'edit-emp-photo') {
                window.capturedEmployeePhoto = null;
                window.capturedPhotoTarget = null;
            }
        }

        // Save functions
        async function saveEmployee() {
            const firstName = document.getElementById('emp-first-name').value.trim();
            const lastName = document.getElementById('emp-last-name').value.trim();
            const email = document.getElementById('emp-email').value.trim();
            const phone = document.getElementById('emp-phone').value.trim();
            const password = document.getElementById('emp-password').value.trim();
            const confirmPassword = document.getElementById('emp-confirm-password').value.trim();
            const role = document.getElementById('emp-role').value;
            const employeeType = document.getElementById('emp-employee-type')?.value || 'employee';
            const store = document.getElementById('emp-store').value;
            const hireDate = document.getElementById('emp-hire-date').value;
            const emergencyName = document.getElementById('emp-emergency-name').value.trim();
            const emergencyPhone = document.getElementById('emp-emergency-phone').value.trim();
            const allergies = document.getElementById('emp-allergies').value.trim();

            if (!firstName || !lastName || !email || !phone || !role || !store || !password) {
                alert('Please fill in all required fields');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            const newEmployee = {
                name: `${firstName} ${lastName}`,
                initials: `${firstName[0]}${lastName[0]}`.toUpperCase(),
                email,
                phone,
                role,                                    // Job position (Store Manager, Sales Associate, etc)
                employeeType: employeeType,              // Permission level (admin, manager, employee)
                store,
                hireDate: hireDate || new Date().toISOString().split('T')[0],
                emergencyContact: combineEmergencyContact(emergencyName, emergencyPhone),
                allergies: allergies || 'None',
                status: 'active',
                color: ['a', 'b', 'c', 'd', 'e'][Math.floor(Math.random() * 5)]
            };

            // Show saving indicator
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            try {
                // Initialize Firebase if needed
                if (!firebaseEmployeeManager.isInitialized) {
                    await firebaseEmployeeManager.initialize();
                }

                // Save to Firebase
                if (firebaseEmployeeManager.isInitialized) {
                    const firestoreId = await firebaseEmployeeManager.addEmployee(newEmployee, email, password);
                    if (firestoreId) {
                        newEmployee.id = firestoreId;
                        newEmployee.firestoreId = firestoreId;
                        console.log('Employee saved to Firebase:', firestoreId);

                        // Upload profile photo if provided (check file input or captured photo from camera)
                        const photoInput = document.getElementById('emp-photo');
                        const hasFilePhoto = photoInput && photoInput.files && photoInput.files[0];
                        const hasCapturedPhoto = window.capturedEmployeePhoto && window.capturedPhotoTarget === 'emp-photo';

                        if (hasFilePhoto || hasCapturedPhoto) {
                            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading photo...';
                            try {
                                let photoBase64;
                                if (hasCapturedPhoto) {
                                    photoBase64 = window.capturedEmployeePhoto;
                                    // Clear captured photo
                                    window.capturedEmployeePhoto = null;
                                    window.capturedPhotoTarget = null;
                                } else {
                                    const photoFile = photoInput.files[0];
                                    const reader = new FileReader();
                                    photoBase64 = await new Promise((resolve) => {
                                        reader.onload = (e) => resolve(e.target.result);
                                        reader.readAsDataURL(photoFile);
                                    });
                                }

                                // Initialize storage helper if needed
                                if (!firebaseStorageHelper.isInitialized) {
                                    firebaseStorageHelper.initialize();
                                }

                                const uploadResult = await firebaseStorageHelper.uploadImage(
                                    photoBase64,
                                    'employees/photos',
                                    firestoreId,
                                    500,  // maxSizeKB
                                    false // showOverlay - we're showing our own spinner
                                );

                                // Update employee with photo URL
                                if (uploadResult && uploadResult.url) {
                                    newEmployee.photo = uploadResult.url;
                                    newEmployee.photoPath = uploadResult.path;
                                    await firebaseEmployeeManager.updateEmployee(firestoreId, {
                                        photo: uploadResult.url,
                                        photoPath: uploadResult.path
                                    });
                                    console.log('Employee photo uploaded to Firebase Storage:', uploadResult.url);
                                }
                            } catch (photoError) {
                                console.error('Error uploading employee photo:', photoError);
                                showNotification('Error uploading photo, but employee was saved', 'warning');
                            }
                        }

                        // Upload paperwork files if any
                        if (selectedEmployeePaperworkFiles.length > 0) {
                            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading documents...';

                            for (const file of selectedEmployeePaperworkFiles) {
                                try {
                                    await firebaseEmployeeManager.uploadPaperwork(firestoreId, file, 'Document');
                                } catch (uploadError) {
                                    console.error('Error uploading file:', file.name, uploadError);
                                    // Continue with other files even if one fails
                                }
                            }

                            // Clear the selected files after upload
                            selectedEmployeePaperworkFiles = [];

                            // Reload employee data to get updated paperwork
                            const updatedEmployee = await firebaseEmployeeManager.getEmployee(firestoreId);
                            if (updatedEmployee) {
                                newEmployee.paperwork = updatedEmployee.paperwork;
                            }
                        }

                        // Add to local array
                        employees.push(newEmployee);

                        // Update employee count badge
                        updateEmployeeCountBadge();

                        closeModal();
                        renderPage(currentPage);

                        // Show success message
                        if (newEmployee.firebaseUid) {
                            showNotification('Employee added with login account created!', 'success');
                        } else {
                            showNotification('Employee added successfully!', 'success');
                        }
                    } else {
                        throw new Error('Failed to get Firestore ID');
                    }
                } else {
                    // Fallback: save locally only
                    newEmployee.id = Date.now().toString();
                    employees.push(newEmployee);

                    // Update employee count badge
                    updateEmployeeCountBadge();

                    closeModal();
                    renderPage(currentPage);
                    showNotification('Employee added (offline mode)', 'warning');
                }
            } catch (error) {
                console.error('Error saving employee:', error);
                
                // Show specific error message
                let errorMessage = error.message || 'Error saving employee. Please try again.';
                alert(errorMessage);

                // Reset button
                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        /**
         * Show image in fullscreen modal
         */
        function showImageModal(imageUrl, title = 'Image') {
            // Remove existing image modal if any
            const existing = document.getElementById('image-fullscreen-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'image-fullscreen-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                box-sizing: border-box;
            `;
            modal.innerHTML = `
                <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
                    <a href="${imageUrl}" download style="color: white; font-size: 24px; cursor: pointer; text-decoration: none;" title="Download">
                        <i class="fas fa-download"></i>
                    </a>
                    <span onclick="document.getElementById('image-fullscreen-modal').remove()" style="color: white; font-size: 28px; cursor: pointer;" title="Close">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
                <div style="color: white; font-size: 18px; margin-bottom: 15px; text-align: center;">${title}</div>
                <img src="${imageUrl}" alt="${title}" style="max-width: 90%; max-height: 80%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
            `;

            // Close on background click
            modal.addEventListener('mousedown', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);

            document.body.appendChild(modal);
        }

        /**
         * Show notification toast
         */
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelector('.notification-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Variable to store selected training file
        let selectedTrainingFile = null;

        // Toggle between video URL and PDF file upload fields
        function toggleTrainingTypeFields() {
            const type = document.getElementById('training-type').value;
            const urlGroup = document.getElementById('training-url-group');
            const fileGroup = document.getElementById('training-file-group');

            if (type === 'video') {
                urlGroup.style.display = 'block';
                fileGroup.style.display = 'none';
            } else {
                urlGroup.style.display = 'none';
                fileGroup.style.display = 'block';
            }
        }

        // Handle training file selection
        function handleTrainingFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            if (file.type !== 'application/pdf') {
                showToast('Please select a PDF file', 'error');
                input.value = '';
                return;
            }

            // Validate file size (max 50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showToast('File size exceeds 50MB limit', 'error');
                input.value = '';
                return;
            }

            selectedTrainingFile = file;

            // Update UI to show selected file
            const fileContent = document.getElementById('training-file-content');
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            fileContent.innerHTML = `
                <i class="fas fa-file-pdf" style="font-size: 32px; color: #ef4444; margin-bottom: 8px;"></i>
                <span style="color: var(--text-primary); font-weight: 500;">${file.name}</span>
                <span style="color: var(--text-muted); font-size: 12px;">${fileSize} MB</span>
            `;
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function saveTraining() {
            const title = document.getElementById('training-title').value.trim();
            const type = document.getElementById('training-type').value;
            const url = document.getElementById('training-url').value.trim();
            const description = document.getElementById('training-description')?.value.trim() || '';

            // Validation
            if (!title) {
                showToast('Please enter a training title', 'error');
                return;
            }

            if (type === 'video' && !url) {
                showToast('Please enter a video URL', 'error');
                return;
            }

            // Validate URL format
            if (type === 'video' && url) {
                if (!isValidUrl(url)) {
                    showToast('Please enter a valid URL (e.g., https://youtube.com/watch?v=...)', 'error');
                    return;
                }
            }

            if (type === 'document' && !selectedTrainingFile) {
                showToast('Please select a PDF file', 'error');
                return;
            }

            // Show loading state
            const saveBtn = document.getElementById('save-training-btn');
            const saveText = document.getElementById('save-training-text');
            const saveSpinner = document.getElementById('save-training-spinner');

            if (saveBtn) saveBtn.disabled = true;
            if (saveText) saveText.textContent = 'Saving...';
            if (saveSpinner) saveSpinner.style.display = 'inline-block';

            // Show upload progress for PDF files
            if (type === 'document') {
                const progressDiv = document.getElementById('training-upload-progress');
                if (progressDiv) progressDiv.style.display = 'block';

                // Listen for upload progress
                const progressHandler = (e) => {
                    const progress = e.detail.progress;
                    const progressFill = document.getElementById('training-progress-fill');
                    const progressText = document.getElementById('training-progress-text');
                    if (progressFill) progressFill.style.width = progress + '%';
                    if (progressText) progressText.textContent = Math.round(progress) + '%';
                };
                window.addEventListener('uploadProgress', progressHandler);

                try {
                    // Initialize Firebase Training Manager if not already
                    if (!firebaseTrainingManager.isInitialized) {
                        await firebaseTrainingManager.initialize();
                    }

                    // Prepare training data
                    const trainingData = {
                        title,
                        type,
                        url: type === 'video' ? url : '',
                        completion: 0,
                        description
                    };

                    // Save to Firebase with file
                    const newId = await firebaseTrainingManager.addTraining(trainingData, selectedTrainingFile);

                    if (newId) {
                        showToast('Training material added successfully!', 'success');
                        selectedTrainingFile = null;
                        closeModal();
                        await loadTrainingsFromFirebase();
                        renderPage(currentPage);
                    } else {
                        throw new Error('Failed to save training');
                    }

                    window.removeEventListener('uploadProgress', progressHandler);
                } catch (error) {
                    console.error('Error saving training:', error);
                    showToast('Error saving training: ' + error.message, 'error');
                    window.removeEventListener('uploadProgress', progressHandler);

                    // Reset button state
                    if (saveBtn) saveBtn.disabled = false;
                    if (saveText) saveText.textContent = 'Add Training';
                    if (saveSpinner) saveSpinner.style.display = 'none';
                }
            } else {
                // Video type - no file upload needed
                try {
                    if (!firebaseTrainingManager.isInitialized) {
                        await firebaseTrainingManager.initialize();
                    }

                    const trainingData = {
                        title,
                        type,
                        url,
                        completion: 0,
                        description
                    };

                    const newId = await firebaseTrainingManager.addTraining(trainingData);

                    if (newId) {
                        showToast('Training material added successfully!', 'success');
                        closeModal();
                        await loadTrainingsFromFirebase();
                        renderPage(currentPage);
                    } else {
                        throw new Error('Failed to save training');
                    }
                } catch (error) {
                    console.error('Error saving training:', error);
                    showToast('Error saving training: ' + error.message, 'error');

                    // Reset button state
                    if (saveBtn) saveBtn.disabled = false;
                    if (saveText) saveText.textContent = 'Add Training';
                    if (saveSpinner) saveSpinner.style.display = 'none';
                }
            }
        }

        // Load trainings from Firebase
        async function loadTrainingsFromFirebase() {
            try {
                if (!firebaseTrainingManager.isInitialized) {
                    await firebaseTrainingManager.initialize();
                }

                const firebaseTrainings = await firebaseTrainingManager.loadTrainings();

                if (firebaseTrainings.length > 0) {
                    trainings = firebaseTrainings;
                    console.log('Loaded trainings from Firebase:', trainings.length);
                } else {
                    console.log('No trainings in Firebase, using default data');
                }
            } catch (error) {
                console.error('Error loading trainings from Firebase:', error);
            }
        }

        async function saveLicense() {
            const name = document.getElementById('license-name').value;
            const store = document.getElementById('license-store').value;
            const expires = document.getElementById('license-expires').value;
            const fileInput = document.getElementById('license-file');

            if (!name || !store || !expires) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const expiresDate = new Date(expires);
            const today = new Date();
            const daysUntilExpiry = Math.ceil((expiresDate - today) / (1000 * 60 * 60 * 24));

            let status = 'valid';
            if (daysUntilExpiry < 0) status = 'expired';
            else if (daysUntilExpiry < 60) status = 'expiring';

            // Get current user info
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const uploadedBy = user?.name || user?.email || 'Unknown';

            try {
                // Initialize Firebase if needed
                if (!firebaseLicensesManager.isInitialized) {
                    await firebaseLicensesManager.initialize();
                }

                let file = null;
                if (fileInput && fileInput.files.length > 0) {
                    file = fileInput.files[0];

                    // Validate file type
                    if (file.type !== 'application/pdf') {
                        showToast('Please select a PDF file', 'error');
                        return;
                    }

                    // Check file size (max 50MB for Storage)
                    const maxSize = 50 * 1024 * 1024; // 50MB
                    if (file.size > maxSize) {
                        showToast('File size exceeds 50MB limit', 'error');
                        return;
                    }
                }

                const licenseData = {
                    name,
                    store,
                    expires,
                    status,
                    file: file ? file.name : null,
                    uploadedBy: uploadedBy
                };

                // Save to Firebase (with or without file)
                const docId = await firebaseLicensesManager.addLicense(licenseData, file);

                if (docId) {
                    showToast('License uploaded successfully!', 'success');

                    // Reload licenses from Firebase
                    const updatedLicenses = await firebaseLicensesManager.loadLicenses();
                    if (updatedLicenses && updatedLicenses.length > 0) {
                        licenses = updatedLicenses;
                    }

                    closeModal();
                    renderPage(currentPage);
                } else {
                    throw new Error('Failed to save license');
                }
            } catch (error) {
                console.error('Error saving license:', error);
                showToast('Error saving license: ' + error.message, 'error');
            }
        }

        // Legacy function kept for compatibility
        async function saveLicenseOld() {
            const name = document.getElementById('license-name').value;
            const store = document.getElementById('license-store').value;
            const expires = document.getElementById('license-expires').value;
            const fileInput = document.getElementById('license-file');

            if (!name || !store || !expires) {
                alert('Please fill in all required fields');
                return;
            }

            const expiresDate = new Date(expires);
            const today = new Date();
            const daysUntilExpiry = Math.ceil((expiresDate - today) / (1000 * 60 * 60 * 24));

            let status = 'valid';
            if (daysUntilExpiry < 0) status = 'expired';
            else if (daysUntilExpiry < 60) status = 'expiring';

            // Get current user info
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            const uploadedBy = user?.name || user?.email || 'Unknown';

            // No file uploaded
            const licenseData = {
                name,
                store,
                expires,
                status,
                file: null,
                fileName: null,
                fileType: null,
                fileData: null,
                uploadedBy: uploadedBy
            };

            // Save to Firebase
            if (firebaseLicensesManager && firebaseLicensesManager.isInitialized) {
                try {
                    const docId = await firebaseLicensesManager.addLicense(licenseData);
                    if (docId) {
                        // Reload licenses from Firebase
                        const updatedLicenses = await firebaseLicensesManager.loadLicenses();
                        if (updatedLicenses && updatedLicenses.length > 0) {
                            licenses = updatedLicenses;
                        }
                    }
                } catch (error) {
                    console.error('Error saving license to Firebase:', error);
                    // Fallback to local
                    licenses.push({
                        id: Date.now().toString(),
                        ...licenseData
                    });
                }
            } else {
                // Fallback to local storage
                licenses.push({
                    id: Date.now().toString(),
                    ...licenseData
                });
            }

            closeModal();
            renderPage(currentPage);
        }

        async function saveAnnouncement() {
            const title = document.getElementById('announcement-title').value;
            const content = document.getElementById('announcement-content').value;
            const targetStores = document.getElementById('announcement-stores')?.value || 'all';

            if (!title || !content) {
                alert('Please fill in all required fields');
                return;
            }

            // Get current user info for author
            const user = authManager.getCurrentUser();
            const authorName = user?.name || user?.email?.split('@')[0] || 'Unknown';

            const announcementData = {
                date: new Date().toISOString().split('T')[0],
                title,
                content,
                author: authorName,
                targetStores
            };

            try {
                // Save to Firebase
                if (firebaseAnnouncementsManager.isInitialized) {
                    const docId = await firebaseAnnouncementsManager.addAnnouncement(announcementData);
                    if (docId) {
                        // Reload announcements from Firebase
                        const updatedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                        if (updatedAnnouncements && updatedAnnouncements.length > 0) {
                            announcements = updatedAnnouncements;
                        }
                        console.log('Announcement saved to Firebase with ID:', docId);
                    }
                } else {
                    // Fallback to local storage
                    announcements.unshift({
                        id: announcements.length + 1,
                        ...announcementData
                    });
                }

                closeModal();
                renderPage(currentPage);
                updateAnnouncementsBadge();
                populateAnnouncementsDropdown();
            } catch (error) {
                console.error('Error saving announcement:', error);
                alert('Failed to save announcement. Please try again.');
            }
        }

        async function saveAnnouncementInline() {
            const title = document.getElementById('new-announcement-title').value;
            const content = document.getElementById('new-announcement-content').value;

            if (!title || !content) {
                alert('Please fill in both title and content');
                return;
            }

            // Get current user info for author
            const user = authManager.getCurrentUser();
            const authorName = user?.name || user?.email?.split('@')[0] || 'Unknown';

            const announcementData = {
                date: new Date().toISOString().split('T')[0],
                title,
                content,
                author: authorName,
                targetStores: 'all'
            };

            try {
                // Save to Firebase
                if (firebaseAnnouncementsManager.isInitialized) {
                    const docId = await firebaseAnnouncementsManager.addAnnouncement(announcementData);
                    if (docId) {
                        // Reload announcements from Firebase
                        const updatedAnnouncements = await firebaseAnnouncementsManager.loadAnnouncements();
                        if (updatedAnnouncements && updatedAnnouncements.length > 0) {
                            announcements = updatedAnnouncements;
                        }
                        console.log('Announcement saved to Firebase with ID:', docId);
                    }
                } else {
                    // Fallback to local storage
                    announcements.unshift({
                        id: announcements.length + 1,
                        ...announcementData
                    });
                }

                renderAnnouncements();
                updateAnnouncementsBadge();
                populateAnnouncementsDropdown();
            } catch (error) {
                console.error('Error saving announcement:', error);
                alert('Failed to save announcement. Please try again.');
            }
        }

        async function saveProduct() {
            const name = document.getElementById('new-product-name').value.trim();
            const category = document.getElementById('new-product-category').value;
            const price = document.getElementById('new-product-price').value;
            const arrivalDate = document.getElementById('new-product-arrival').value;
            const estimatedDeals = document.getElementById('new-product-deals')?.value || '';
            const url = document.getElementById('new-product-url')?.value.trim() || '';
            const supplier = document.getElementById('new-product-supplier')?.value.trim() || '';
            const imageInput = document.getElementById('new-product-image');

            if (!name) {
                alert('Please enter a product name');
                return;
            }

            // Validate URL format if provided
            if (url && !isValidUrl(url)) {
                alert('Please enter a valid URL (e.g., https://example.com)');
                return;
            }

            // Show loading state
            const saveBtn = document.getElementById('save-product-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                // Upload image to Firebase Storage if provided
                let imageUrl = null;
                let imagePath = null;
                const imageImg = document.getElementById('product-image-img');
                if (imageImg && imageImg.src && imageInput && imageInput.files && imageInput.files.length > 0 && imageImg.src.startsWith('data:')) {
                    // Initialize storage helper if needed
                    if (!firebaseStorageHelper.isInitialized) {
                        firebaseStorageHelper.initialize();
                    }

                    try {
                        const tempId = Date.now().toString();
                        const uploadResult = await firebaseStorageHelper.uploadImage(
                            imageImg.src,
                            'products/images',
                            tempId
                        );
                        imageUrl = uploadResult.url;
                        imagePath = uploadResult.path;
                    } catch (err) {
                        console.error('Error uploading product image to Storage:', err);
                        // Fallback to compressed base64
                        imageUrl = await compressImage(imageImg.src);
                    }
                }

                // Create product data object
                const productData = {
                    name,
                    category: category || '',
                    price: parseFloat(price) || 0,
                    arrivalDate: arrivalDate || '',
                    estimatedDeals: estimatedDeals || '',
                    url: url || '',
                    supplier: supplier || '',
                    image: imageUrl,      // Now stores URL instead of base64
                    imagePath: imagePath, // For future deletion
                    status: 'pending'
                };

                // Ensure Firebase Product Manager is initialized
                if (!firebaseProductManager.isInitialized) {
                    const initialized = await firebaseProductManager.initialize();
                    if (!initialized) {
                        throw new Error('Failed to initialize Firebase Product Manager');
                    }
                }

                // Save to Firebase Firestore
                console.log('üíæ Saving product to Firestore...');
                const savedProduct = await firebaseProductManager.saveProduct(productData);

                if (savedProduct) {
                    showToast('Product added successfully!', 'success');
                    closeModal();
                    // Reload products from Firebase and render
                    await loadProductsFromFirebase();
                    renderNewStuff();
                } else {
                    throw new Error('Failed to save product');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showToast('Error saving product: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        /**
         * Preview product image (converts to Base64 for direct Firestore storage)
         */
        function previewProductImage(input) {
            const preview = document.getElementById('product-image-preview');
            const img = document.getElementById('product-image-img');

            if (input.files && input.files[0]) {
                const file = input.files[0];

                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;  // Base64 DataURL
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }

        /**
         * View product image in a modal
         */
        function viewProductImage(imageUrl) {
            if (!imageUrl) {
                alert('No image available');
                return;
            }

            openModal('view-image');
            setTimeout(() => {
                const modal = document.getElementById('modal');
                const modalContent = modal.querySelector('.modal-content');
                modalContent.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <img src="${imageUrl}" alt="Product" style="max-width: 100%; max-height: 80vh; border-radius: 12px;">
                        <button class="btn-secondary" onclick="closeModal()" style="margin-top: 20px; width: 100%;">Close</button>
                    </div>
                `;
            }, 100);
        }

        /**
         * Load products from Firebase
         */
        async function loadProductsFromFirebase() {
            try {
                if (!firebaseProductManager.isInitialized) {
                    const initialized = await firebaseProductManager.initialize();
                    if (!initialized) {
                        console.warn('Firebase not initialized, using empty local products');
                        products = [];
                        return Promise.resolve();
                    }
                }

                console.log('üì¶ Loading products from Firebase...');
                const firebaseProducts = await firebaseProductManager.loadProducts();
                
                // Replace local products with Firebase products
                products = firebaseProducts || [];
                
                return Promise.resolve();
            } catch (error) {
                console.error('Error loading products from Firebase:', error);
                products = [];
                return Promise.resolve();
            }
        }

        /**
         * Delete product from Firebase
         */
        async function deleteProductFromFirebase(productId) {
            showConfirmModal({
                title: 'Delete Product',
                message: 'Are you sure you want to delete this product? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    try {
                        if (!firebaseProductManager.isInitialized) {
                            const initialized = await firebaseProductManager.initialize();
                            if (!initialized) {
                                showNotification('Firebase not initialized', 'error');
                                return;
                            }
                        }

                        console.log(`üóëÔ∏è Deleting product: ${productId}`);
                        const success = await firebaseProductManager.deleteProduct(productId);

                        if (success) {
                            // Remove from local array
                            products = products.filter(p => p.id !== productId);
                            renderNewStuff();
                        } else {
                            showNotification('Error deleting product', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showNotification('Error deleting product', 'error');
                    }
                }
            });
        }

        // Variable to store the product being edited
        let editingProductId = null;

        /**
         * Preview edit product image (converts to Base64)
         */
        function previewEditProductImage(input) {
            const preview = document.getElementById('edit-product-image-preview');
            const img = document.getElementById('edit-product-image-img');

            if (input.files && input.files[0]) {
                const file = input.files[0];

                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;  // Base64 DataURL
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        /**
         * Get unique supplier options from existing products
         */
        function getSupplierOptions(currentSupplier = '') {
            // Get unique suppliers from existing products
            const suppliers = [...new Set(products.map(p => p.supplier).filter(s => s && s.trim()))];

            // Add some default suppliers if not already in the list
            const defaultSuppliers = ['Direct Import', 'Local Vendor', 'Wholesale'];
            defaultSuppliers.forEach(s => {
                if (!suppliers.includes(s)) suppliers.push(s);
            });

            // Sort alphabetically
            suppliers.sort((a, b) => a.localeCompare(b));

            // Generate options HTML
            return suppliers.map(supplier =>
                `<option value="${supplier}" ${currentSupplier === supplier ? 'selected' : ''}>${supplier}</option>`
            ).join('');
        }

        /**
         * Edit product
         */
        function editProduct(productId) {
            const product = products.find(p => p.id === productId || p.firestoreId === productId);
            if (!product) {
                alert('Product not found');
                return;
            }

            editingProductId = productId;

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 style="display: flex; align-items: center; gap: 12px; margin: 0;">
                        <i class="fas fa-edit" style="color: var(--accent-primary); font-size: 24px;"></i>
                        Edit Product
                    </h2>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-product-form" style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Product Name</label>
                            <input type="text" id="edit-product-name" value="${product.name || ''}" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Category</label>
                                <select id="edit-product-category" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                                    <option value="">Select category...</option>
                                    <option value="Vape Devices" ${product.category === 'Vape Devices' ? 'selected' : ''}>Vape Devices</option>
                                    <option value="Vape Pods" ${product.category === 'Vape Pods' ? 'selected' : ''}>Vape Pods</option>
                                    <option value="Disposables" ${product.category === 'Disposables' ? 'selected' : ''}>Disposables</option>
                                    <option value="Cigarettes" ${product.category === 'Cigarettes' ? 'selected' : ''}>Cigarettes</option>
                                    <option value="Accessories" ${product.category === 'Accessories' ? 'selected' : ''}>Accessories</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Quantity</label>
                                <input type="number" id="edit-product-quantity" value="${product.quantity || 0}" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Price</label>
                                <input type="number" id="edit-product-price" value="${product.price || 0}" step="0.01" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Store</label>
                                <select id="edit-product-store" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                                    <option value="">Select store...</option>
                                    <option value="Miramar" ${product.store === 'Miramar' ? 'selected' : ''}>VSU Miramar</option>
                                    <option value="Morena" ${product.store === 'Morena' ? 'selected' : ''}>VSU Morena</option>
                                    <option value="Kearny Mesa" ${product.store === 'Kearny Mesa' ? 'selected' : ''}>VSU Kearny Mesa</option>
                                    <option value="Chula Vista" ${product.store === 'Chula Vista' ? 'selected' : ''}>VSU Chula Vista</option>
                                    <option value="North Park" ${product.store === 'North Park' ? 'selected' : ''}>VSU North Park</option>
                                    <option value="Miramar Wine & Liquor" ${product.store === 'Miramar Wine & Liquor' ? 'selected' : ''}>Miramar Wine & Liquor</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Arrival Date</label>
                                <input type="date" id="edit-product-arrival-date" value="${product.arrivalDate || ''}" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Supplier</label>
                                <select id="edit-product-supplier" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit;">
                                    <option value="">Select supplier...</option>
                                    ${getSupplierOptions(product.supplier)}
                                </select>
                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div>
                            <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Product Image (leave empty to keep current)</label>
                            <input type="file" class="form-input" id="edit-product-image" accept="image/*" onchange="previewEditProductImage(this)" style="display: none;">
                            <div id="edit-product-image-preview" style="margin-bottom: 12px; ${product.image ? '' : 'display: none;'}">
                                <img id="edit-product-image-img" src="${product.image || ''}" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover;">
                            </div>
                            <button type="button" class="btn-secondary" onclick="document.getElementById('edit-product-image').click()" style="margin: 0;">
                                <i class="fas fa-image"></i> ${product.image ? 'Change Image' : 'Select Image'}
                            </button>
                            <small style="display: block; margin-top: 8px; color: var(--text-muted);">Stored securely in cloud storage</small>
                        </div>

                        <div>
                            <label style="display: block; color: var(--text-muted); font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Description</label>
                            <textarea id="edit-product-description" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit; min-height: 100px; resize: vertical;">${product.description || ''}</textarea>
                        </div>
                    </form>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn-primary" style="
                            flex: 1;
                            padding: 12px 16px;
                            border-radius: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            border: none;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        " onclick="saveProductChanges('${productId}')">
                            <i class="fas fa-check"></i>
                            Save Changes
                        </button>
                        <button style="
                            flex: 1;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border: 1px solid var(--border-color);
                            padding: 12px 16px;
                            border-radius: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                        " onclick="closeModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        async function saveProductChanges(productId) {
            const product = products.find(p => p.id === productId || p.firestoreId === productId);
            if (!product) {
                showToast('Product not found', 'error');
                return;
            }

            const imageInput = document.getElementById('edit-product-image');

            // Upload image to Firebase Storage if new one provided
            let imageUrl = product.image;
            let imagePath = product.imagePath || null;
            const imageImg = document.getElementById('edit-product-image-img');
            if (imageInput && imageInput.files && imageInput.files.length > 0 && imageImg && imageImg.src && imageImg.src.startsWith('data:')) {
                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                // Delete old image from Storage if exists
                if (product.imagePath) {
                    try {
                        await firebaseStorageHelper.deleteFile(product.imagePath);
                    } catch (err) {
                        console.error('Error deleting old product image from Storage:', err);
                    }
                }

                try {
                    const firestoreId = product.firestoreId || productId;
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        imageImg.src,
                        'products/images',
                        firestoreId
                    );
                    imageUrl = uploadResult.url;
                    imagePath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading product image to Storage:', err);
                    // Fallback to compressed base64
                    imageUrl = await compressImage(imageImg.src);
                }
            }

            // Update product with new values
            const updatedData = {
                name: document.getElementById('edit-product-name').value.trim() || product.name,
                category: document.getElementById('edit-product-category').value.trim() || product.category,
                quantity: parseInt(document.getElementById('edit-product-quantity').value) || 0,
                price: parseFloat(document.getElementById('edit-product-price').value) || 0,
                store: document.getElementById('edit-product-store').value.trim() || product.store,
                arrivalDate: document.getElementById('edit-product-arrival-date').value || product.arrivalDate,
                supplier: document.getElementById('edit-product-supplier').value.trim() || product.supplier,
                description: document.getElementById('edit-product-description').value.trim() || '',
                image: imageUrl,      // Now stores URL instead of base64
                imagePath: imagePath  // For future deletion
            };

            // Update local product
            const productIndex = products.findIndex(p => p.id === productId || p.firestoreId === productId);
            if (productIndex !== -1) {
                products[productIndex] = {
                    ...products[productIndex],
                    ...updatedData
                };
            }

            // Save to Firebase
            try {
                if (firebaseProductManager && firebaseProductManager.isInitialized) {
                    const firestoreId = product.firestoreId || productId;
                    await firebaseProductManager.updateProduct(String(firestoreId), updatedData);
                    showToast('Product updated successfully!', 'success');
                } else {
                    console.warn('‚ö†Ô∏è Firebase not initialized, saving locally only');
                    showToast('Product updated locally', 'success');
                }
            } catch (error) {
                console.error('Error updating product in Firebase:', error);
                showToast('Error updating product: ' + error.message, 'error');
            }

            editingProductId = null;
            closeModal();
            renderNewStuff();
        }

        function openRestockModal(itemId) {
            const modal = document.getElementById('modal');
            modal.dataset.itemId = itemId;
            openModal('restock-request');
        }

        function submitRestockFromModal(itemId) {
            const item = inventory.find(i => i.id == itemId);
            const date = document.getElementById('restock-date').value;
            const store = document.getElementById('restock-modal-store').value;
            const qtyHand = document.getElementById('restock-qty-hand').value;
            const isCustomerRequest = document.getElementById('customer-request').checked;
            const customerInfo = document.getElementById('customer-info').value;
            const notes = document.getElementById('restock-modal-notes').value;

            if (!date || !store || !qtyHand) {
                alert('Please fill in all required fields');
                return;
            }

            if (isCustomerRequest && !customerInfo) {
                alert('Please provide customer information');
                return;
            }

            const productName = `${item.brand} ${item.productName} - ${item.flavor}`;
            const noteText = isCustomerRequest
                ? `Customer Request: ${customerInfo}${notes ? '\n' + notes : ''}`
                : notes;

            const newRequest = {
                productName: productName,
                quantity: item.minStock - parseInt(qtyHand),
                store,
                requestedBy: 'VSU Admin',
                requestDate: date,
                status: 'pending',
                priority: parseInt(qtyHand) < item.minStock * 0.3 ? 'high' : parseInt(qtyHand) < item.minStock * 0.6 ? 'medium' : 'low',
                notes: noteText
            };

            // Save to Firebase if initialized
            if (firebaseRestockRequestsManager.isInitialized) {
                firebaseRestockRequestsManager.addRestockRequest(newRequest).then(newId => {
                    if (newId) {
                        restockRequests.unshift({
                            id: newId,
                            firestoreId: newId,
                            ...newRequest
                        });
                        closeModal();
                        currentRestockTab = 'requests';
                        renderRestockRequests();
                    }
                }).catch(error => {
                    console.error('Error creating restock request in Firebase:', error);
                    alert('Error creating restock request: ' + error.message);
                });
            } else {
                // Fallback to local storage only
                restockRequests.unshift({
                    id: restockRequests.length + 1,
                    ...newRequest
                });
                closeModal();
                currentRestockTab = 'requests';
                renderRestockRequests();
            }
        }

        // Helper function to populate employee dropdown for restock requests
        function populateEmployeeDropdown(selectId, selectedValue = '') {
            const select = document.getElementById(selectId);
            if (!select) return;

            // Clear existing options except the first placeholder
            select.innerHTML = '<option value="">Select employee...</option>';

            // Add active employees from the employees array
            const activeEmployees = employees.filter(emp => emp.status === 'active');
            activeEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = `${emp.name} (${emp.store})`;
                if (emp.name === selectedValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function openNewRestockRequestModal() {
            openModal('new-restock-request');

            // Populate employee dropdown and enable/disable customer info field
            setTimeout(() => {
                // Populate employee dropdown
                populateEmployeeDropdown('new-restock-requested-by');

                const checkbox = document.getElementById('new-restock-customer-request');
                const customerInfo = document.getElementById('new-restock-customer-info');

                if (checkbox && customerInfo) {
                    checkbox.addEventListener('change', function() {
                        customerInfo.disabled = !this.checked;
                        customerInfo.style.background = this.checked ? 'var(--bg-primary)' : 'var(--bg-hover)';
                        if (!this.checked) customerInfo.value = '';
                    });
                }
            }, 100);
        }

        function toggleCustomBrandInput() {
            const brandSelect = document.getElementById('new-restock-brand');
            const customBrandInput = document.getElementById('new-restock-custom-brand');
            if (brandSelect && customBrandInput) {
                if (brandSelect.value === 'Other') {
                    customBrandInput.style.display = 'block';
                    customBrandInput.focus();
                } else {
                    customBrandInput.style.display = 'none';
                    customBrandInput.value = '';
                }
            }
        }

        function submitNewRestockRequest() {
            const product = document.getElementById('new-restock-product').value;
            const quantity = document.getElementById('new-restock-quantity').value;
            const priority = document.getElementById('new-restock-priority').value || 'medium';
            const store = document.getElementById('new-restock-store').value;
            const requestedByEl = document.getElementById('new-restock-requested-by');
            const requestedBy = requestedByEl ? requestedByEl.value : '';
            const notes = document.getElementById('new-restock-notes').value;

            // Validation
            if (!product || !quantity || !store) {
                alert('Please fill in Product, Quantity and Store');
                return;
            }

            // Create request object
            const newRequest = {
                productName: product,
                itemType: 'product',
                quantity: parseInt(quantity),
                store,
                requestedBy: requestedBy || 'Unknown',
                requestDate: new Date().toISOString().split('T')[0],
                status: 'approved',
                priority,
                notes: notes || ''
            };

            // Save to Firebase if initialized
            if (firebaseRestockRequestsManager.isInitialized) {
                firebaseRestockRequestsManager.addRestockRequest(newRequest).then(newId => {
                    if (newId) {
                        restockRequests.unshift({
                            id: newId,
                            firestoreId: newId,
                            ...newRequest
                        });
                        closeModal();
                        renderRestockRequests();
                    } else {
                        alert('Error creating request. Please try again.');
                    }
                }).catch(error => {
                    console.error('Error creating request:', error);
                    alert('Error: ' + error.message);
                });
            } else {
                restockRequests.unshift({
                    id: restockRequests.length + 1,
                    ...newRequest
                });
                closeModal();
                renderRestockRequests();
            }
        }

        // Initialize navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            const iconEl = item.querySelector('.nav-icon i');
            if (!iconEl) return; // Skip if no icon element found
            const page = iconEl.className.split(' ')[1].replace('fa-', '');
            const pageMap = {
                'th-large': 'dashboard',
                'users': 'employees',
                'graduation-cap': 'training',
                'folder-open': 'licenses',
                'chart-line': 'analytics',
                'box': 'newstuff',
                'boxes': 'restock',
                'shopping-basket': 'supplies',
                'cloud': 'abundancecloud',
                'store': 'stores',
                'bullhorn': 'announcements',
                'calendar-alt': 'schedule',
                'user-secret': 'thieves',
                'file-invoice-dollar': 'invoices',
                'exclamation-triangle': 'issues',
                'wallet': 'gconomics',
                'truck': 'vendors',
                'clock': 'clockin',
                'chart-bar': 'dailysales',
                'money-bill-wave': 'cashout',
                'vault': 'treasury',
                'coins': 'change',
                'gift': 'customercare',
                'shield-halved': 'risknotes',
                'key': 'passwords',
                'bolt': 'gforce',
                'code': 'projectanalytics'
            };
            // Only set data-page if not already set, to preserve existing values
            if (!item.dataset.page) {
                item.dataset.page = pageMap[page] || 'dashboard';
            }
            
            item.addEventListener('click', function(e) {
                // Allow external links (like Abundance Cloud) to navigate normally
                if (this.classList.contains('external-link') || this.getAttribute('href') !== '#') {
                    return; // Let the browser handle the navigation
                }
                e.preventDefault();
                navigateTo(this.dataset.page);
            });
        });

        // Check URL for page parameter and navigate if present
        const urlParams = new URLSearchParams(window.location.search);
        const pageFromUrl = urlParams.get('page');
        if (pageFromUrl) {
            // Small delay to ensure everything is initialized
            setTimeout(() => {
                navigateTo(pageFromUrl);
            }, 100);
        }

        // Close modal on background click
        const modal = document.getElementById('modal');
        if (modal) {
            modal.addEventListener('mousedown', function(e) {
                if (e.target === this) {
                    // Check form protection before closing
                    if (typeof formProtectionManager !== 'undefined' && formProtectionManager.shouldPreventClose()) {
                        formProtectionManager.showConfirmDialog();
                        return;
                    }
                    closeModal();
                }
            });
        }

        // Close expense modal on background click
        const expenseModal = document.getElementById('expenseModal');
        if (expenseModal) {
            expenseModal.addEventListener('mousedown', function(e) {
                if (e.target === this) {
                    // Check form protection before closing
                    if (typeof formProtectionManager !== 'undefined' && formProtectionManager.shouldPreventClose()) {
                        formProtectionManager.showConfirmDialog();
                        return;
                    }
                    closeExpenseModal();
                }
            });
        }

        // Training video player functions
        function getVideoEmbedUrl(url) {
            // Detect YouTube URLs
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const youtubeMatch = url.match(youtubeRegex);

            if (youtubeMatch) {
                return {
                    type: 'youtube',
                    videoId: youtubeMatch[1],
                    embedUrl: `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=1`
                };
            }

            // Detect Vimeo URLs
            const vimeoRegex = /vimeo\.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:$|\/|\?)/;
            const vimeoMatch = url.match(vimeoRegex);

            if (vimeoMatch) {
                return {
                    type: 'vimeo',
                    videoId: vimeoMatch[1],
                    embedUrl: `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1`
                };
            }

            return null;
        }

        // Set training view mode (grid or list)
        function setTrainingViewMode(mode) {
            trainingViewMode = mode;
            renderTraining();
        }

        // Get video thumbnail URL
        function getVideoThumbnail(url) {
            const videoInfo = getVideoEmbedUrl(url);
            if (!videoInfo) return null;

            if (videoInfo.type === 'youtube') {
                // YouTube thumbnail - hqdefault is more reliable
                return `https://img.youtube.com/vi/${videoInfo.videoId}/hqdefault.jpg`;
            }

            if (videoInfo.type === 'vimeo') {
                // Return vimeo ID to load async
                return `vimeo:${videoInfo.videoId}`;
            }

            return null;
        }

        // Load Vimeo thumbnails async after page renders
        async function loadVimeoThumbnails() {
            const vimeoElements = document.querySelectorAll('[data-vimeo-id]');
            for (const el of vimeoElements) {
                const vimeoId = el.dataset.vimeoId;
                try {
                    const response = await fetch(`https://vimeo.com/api/v2/video/${vimeoId}.json`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data[0] && data[0].thumbnail_large) {
                            el.style.backgroundImage = `url('${data[0].thumbnail_large}')`;
                            el.style.backgroundSize = 'cover';
                            el.style.backgroundPosition = 'center';
                        }
                    }
                } catch (error) {
                    console.log('Could not load Vimeo thumbnail:', vimeoId);
                }
            }
        }

        function playTrainingVideo(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.id === parseInt(trainingId));
            if (!training || training.type !== 'video') return;

            const videoInfo = getVideoEmbedUrl(training.url);
            if (!videoInfo) {
                showToast('Invalid video URL. Please use a YouTube or Vimeo link.', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>${training.title}</h2>
                    <button class="modal-close" onclick="closeVideoPlayer()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                        <iframe
                            src="${videoInfo.embedUrl}"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                            frameborder="0"
                            allow="autoplay; fullscreen; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px;">
                    <div style="display: flex; justify-content: flex-end; align-items: center; width: 100%;">
                        <button class="btn-primary" onclick="closeVideoPlayer()">Close</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        function closeVideoPlayer() {
            closeModal();
        }

        function viewTraining(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.id === parseInt(trainingId));
            if (!training) {
                showToast('Training not found', 'error');
                return;
            }

            if (training.type === 'video') {
                playTrainingVideo(trainingId);
            } else {
                // For document type, show PDF preview modal
                showTrainingDetailsModal(training);
            }
        }

        // Show training details modal with PDF preview
        function showTrainingDetailsModal(training) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const hasPdf = training.fileUrl && training.type === 'document';
            const fileSize = training.fileSize ? formatFileSize(training.fileSize) : 'N/A';

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-file-pdf" style="color: #ef4444; margin-right: 10px;"></i>${training.title}</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    ${hasPdf ? `
                        <div style="background: var(--bg-tertiary); border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
                            <iframe
                                src="${training.fileUrl}"
                                style="width: 100%; height: 500px; border: none;"
                                title="PDF Preview">
                            </iframe>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px; background: var(--bg-tertiary); border-radius: 12px; margin-bottom: 20px;">
                            <i class="fas fa-file-pdf" style="font-size: 64px; color: #ef4444; margin-bottom: 16px;"></i>
                            <p style="color: var(--text-muted);">No PDF file available for preview</p>
                        </div>
                    `}

                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Training Details</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Type</label>
                                    <span style="font-weight: 500; color: var(--text-primary);">${(training.type || 'Document').toUpperCase()}</span>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Completion</label>
                                    <span style="font-weight: 500; color: var(--text-primary);">${training.completion || 0}%</span>
                                </div>
                                ${training.fileName ? `
                                    <div style="grid-column: span 2;">
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">File</label>
                                        <span style="font-weight: 500; color: var(--text-primary);">
                                            <i class="fas fa-file-pdf" style="color: #ef4444;"></i> ${training.fileName} (${fileSize})
                                        </span>
                                    </div>
                                ` : ''}
                                ${training.description ? `
                                    <div style="grid-column: span 2;">
                                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Description</label>
                                        <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">${training.description}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div style="display: flex; gap: 8px;">
                            ${hasPdf ? `
                                <a href="${training.fileUrl}" target="_blank" class="btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-external-link-alt"></i> Open in New Tab
                                </a>
                                <a href="${training.fileUrl}" download="${training.fileName || 'training.pdf'}" class="btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            ` : ''}
                        </div>
                        <button class="btn-primary" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        // Edit training function
        function editTraining(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.id === parseInt(trainingId));
            if (!training) {
                showToast('Training not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>Edit Training Material</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" class="form-input" id="edit-training-title" value="${training.title || ''}" placeholder="Training name...">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <input type="text" class="form-input" value="${(training.type || 'document').toUpperCase()}" disabled style="background: var(--bg-tertiary);">
                    </div>
                    ${training.type === 'video' ? `
                        <div class="form-group">
                            <label>Video URL</label>
                            <input type="url" class="form-input" id="edit-training-url" value="${training.url || ''}" placeholder="https://youtube.com/watch?v=...">
                        </div>
                    ` : ''}
                    ${training.fileName ? `
                        <div class="form-group">
                            <label>Current File</label>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-file-pdf" style="font-size: 24px; color: #ef4444;"></i>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${training.fileName}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${training.fileSize ? formatFileSize(training.fileSize) : 'Unknown size'}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-input" id="edit-training-description" rows="3" placeholder="Brief description...">${training.description || ''}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn-primary" onclick="updateTraining('${trainingId}')">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            `;
            modal.classList.add('active');
        }

        // Update training in Firebase
        async function updateTraining(trainingId) {
            const title = document.getElementById('edit-training-title').value.trim();
            const urlInput = document.getElementById('edit-training-url');
            const url = urlInput ? urlInput.value.trim() : '';
            const description = document.getElementById('edit-training-description').value.trim();

            if (!title) {
                showToast('Please enter a title', 'error');
                return;
            }

            // Validate URL format if provided
            if (url && !isValidUrl(url)) {
                showToast('Please enter a valid URL (e.g., https://youtube.com/watch?v=...)', 'error');
                return;
            }

            // Check if this is a mock training (numeric ID like "1", "2", etc.)
            const isMockTraining = /^\d+$/.test(String(trainingId));

            if (isMockTraining) {
                showToast('Cannot edit demo training. Please delete it and create a new one in Firebase.', 'warning');
                closeModal();
                return;
            }

            try {
                if (!firebaseTrainingManager.isInitialized) {
                    await firebaseTrainingManager.initialize();
                }

                const updateData = {
                    title,
                    description
                };

                if (url) {
                    updateData.url = url;
                }

                const success = await firebaseTrainingManager.updateTraining(trainingId, updateData);

                if (success) {
                    showToast('Training updated successfully!', 'success');
                    closeModal();
                    await loadTrainingsFromFirebase();
                    renderPage(currentPage);
                } else {
                    throw new Error('Failed to update training');
                }
            } catch (error) {
                console.error('Error updating training:', error);

                // Check if error is "document not found"
                if (error.message && error.message.includes('No document to update')) {
                    showToast('This training does not exist in Firebase. Please create a new one.', 'warning');
                } else {
                    showToast('Error updating training: ' + error.message, 'error');
                }
            }
        }

        // Delete training from Firebase
        async function deleteTraining(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.id === parseInt(trainingId));
            if (!training) {
                showToast('Training not found', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${training.title}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                if (!firebaseTrainingManager.isInitialized) {
                    await firebaseTrainingManager.initialize();
                }

                        const success = await firebaseTrainingManager.deleteTraining(trainingId);

                if (success) {
                    showToast('Training deleted successfully!', 'success');
                    await loadTrainingsFromFirebase();
                    renderPage(currentPage);
                } else {
                    throw new Error('Failed to delete training');
                }
            } catch (error) {
                console.error('Error deleting training:', error);
                showToast('Error deleting training: ' + error.message, 'error');
            }
        }

        // Render training completion summary
        function renderTrainingCompletionSummary(training) {
            const completions = training.completions || [];
            const totalEmployees = employees.length;
            const completedCount = completions.length;
            const completionPercentage = totalEmployees > 0 ? Math.round((completedCount / totalEmployees) * 100) : 0;

            return `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 14px; color: var(--text-secondary);">Completion Progress</span>
                        <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${completedCount} / ${totalEmployees} employees (${completionPercentage}%)</span>
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; height: 12px; overflow: hidden;">
                        <div style="background: ${completionPercentage === 100 ? '#10b981' : '#6366f1'}; height: 100%; width: ${completionPercentage}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                ${completedCount > 0 ? `
                    <div style="max-height: 200px; overflow-y: auto;">
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Recently Completed:</div>
                        ${completions.slice(0, 5).map(c => {
                            const emp = employees.find(e => (e.firestoreId || e.id) === c.employeeId);
                            const completedDate = c.completedAt ? (c.completedAt.toDate ? c.completedAt.toDate() : new Date(c.completedAt)) : null;
                            return `
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 4px;">
                                    <span style="font-size: 13px; color: var(--text-primary);">
                                        <i class="fas fa-check-circle" style="color: #10b981;"></i> ${emp ? emp.name : 'Unknown Employee'}
                                    </span>
                                    <span style="font-size: 12px; color: var(--text-muted);">${completedDate ? formatDate(completedDate) : 'N/A'}</span>
                                </div>
                            `;
                        }).join('')}
                        ${completedCount > 5 ? `<div style="font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 8px;">+${completedCount - 5} more</div>` : ''}
                    </div>
                ` : '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 14px;">No employees have completed this training yet</div>'}
            `;
        }

        // Open training completion modal
        function openTrainingCompletionModal(trainingId) {
            const training = trainings.find(t => t.id === trainingId || t.firestoreId === trainingId);
            if (!training) {
                showToast('Training not found', 'error');
                return;
            }

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');

            const completions = training.completions || [];
            const employeesWithStatus = employees.map(emp => {
                const empId = emp.firestoreId || emp.id;
                const completion = completions.find(c => c.employeeId === empId);
                return {
                    ...emp,
                    completed: !!completion,
                    completedAt: completion ? (completion.completedAt.toDate ? completion.completedAt.toDate() : new Date(completion.completedAt)) : null
                };
            });

            const completedEmployees = employeesWithStatus.filter(e => e.completed);
            const pendingEmployees = employeesWithStatus.filter(e => !e.completed);

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-check-circle"></i> Manage Completions: ${training.title}</h2>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <div style="flex: 1; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
                                <div style="font-size: 28px; font-weight: 700;">${completedEmployees.length}</div>
                                <div style="font-size: 13px; opacity: 0.9;">Completed</div>
                            </div>
                            <div style="flex: 1; padding: 16px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; color: white;">
                                <div style="font-size: 28px; font-weight: 700;">${pendingEmployees.length}</div>
                                <div style="font-size: 13px; opacity: 0.9;">Pending</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <input type="text" id="completion-search" class="form-input" placeholder="Search employees..." oninput="filterCompletionList()">
                    </div>

                    <div id="completion-list" style="max-height: 400px; overflow-y: auto;">
                        ${employeesWithStatus.map(emp => `
                            <div class="completion-item" data-employee-name="${emp.name.toLowerCase()}">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: var(--text-primary);">${emp.name}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${emp.role} ‚Ä¢ ${emp.store}</div>
                                        ${emp.completed ? `<div style="font-size: 12px; color: #10b981; margin-top: 4px;"><i class="fas fa-check-circle"></i> Completed on ${formatDate(emp.completedAt)}</div>` : ''}
                                    </div>
                                    <div>
                                        ${emp.completed ? `
                                            <button class="btn-secondary" onclick="toggleEmployeeCompletion('${training.id}', '${emp.firestoreId || emp.id}', false)">
                                                <i class="fas fa-times"></i> Remove
                                            </button>
                                        ` : `
                                            <button class="btn-primary" onclick="toggleEmployeeCompletion('${training.id}', '${emp.firestoreId || emp.id}', true)">
                                                <i class="fas fa-check"></i> Mark Complete
                                            </button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;

            modal.classList.add('active');
        }

        // Filter completion list
        function filterCompletionList() {
            const search = document.getElementById('completion-search').value.toLowerCase();
            const items = document.querySelectorAll('.completion-item');

            items.forEach(item => {
                const name = item.dataset.employeeName;
                if (name.includes(search)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Toggle employee completion
        async function toggleEmployeeCompletion(trainingId, employeeId, markComplete) {
            try {
                if (!firebaseTrainingManager.isInitialized) {
                    await firebaseTrainingManager.initialize();
                }

                let success;
                if (markComplete) {
                    success = await firebaseTrainingManager.markEmployeeCompleted(trainingId, employeeId);
                } else {
                    success = await firebaseTrainingManager.removeEmployeeCompletion(trainingId, employeeId);
                }

                if (success) {
                    showToast(markComplete ? 'Employee marked as completed' : 'Completion removed', 'success');

                    // Reload trainings to get updated completion data
                    await loadTrainingsFromFirebase();

                    // Re-open the modal with updated data
                    openTrainingCompletionModal(trainingId);
                } else {
                    throw new Error('Failed to update completion status');
                }
            } catch (error) {
                console.error('Error toggling completion:', error);
                showToast('Error updating completion status', 'error');
            }
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');

            if (body.classList.contains('light-theme')) {
                // Switch to dark theme
                body.classList.remove('light-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                // Switch to light theme
                body.classList.add('light-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        }

        // Load theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');

            // Default to light theme if no saved preference
            if (!savedTheme || savedTheme === 'light') {
                document.body.classList.add('light-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                if (!savedTheme) {
                    localStorage.setItem('theme', 'light');
                }
            }
        }

        // User menu dropdown functionality
        function toggleUserMenu() {
            const container = document.querySelector('.user-menu-container');
            if (container) {
                container.classList.toggle('open');
            }
        }

        function closeUserMenu() {
            const container = document.querySelector('.user-menu-container');
            if (container) {
                container.classList.remove('open');
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.querySelector('.user-menu-container');
            if (container && !container.contains(e.target)) {
                container.classList.remove('open');
            }
        });

        // Logout functionality
        function logout() {
            // Clear auth data
            if (typeof authManager !== 'undefined') {
                authManager.logout();
            }
            
            // Clear all localStorage data for security
            localStorage.clear();
            
            // Also clear sessionStorage to ensure clean state
            sessionStorage.clear();

            // Redirect to login page
            window.location.href = 'login.html';
        }

        // Global Search Functionality
        let searchTimeout = null;

        function handleGlobalSearch(query) {
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // Debounce search for better performance
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 150);
        }

        function performSearch(query) {
            const dropdown = document.getElementById('search-results-dropdown');
            const resultsList = document.getElementById('search-results-list');

            if (!query || query.trim().length < 2) {
                dropdown.classList.remove('show');
                return;
            }

            const searchTerm = query.toLowerCase().trim();
            const results = [];

            // Search Employees
            const employeeResults = employees.filter(emp =>
                (emp.name && emp.name.toLowerCase().includes(searchTerm)) ||
                (emp.role && emp.role.toLowerCase().includes(searchTerm)) ||
                (emp.store && emp.store.toLowerCase().includes(searchTerm)) ||
                (emp.authEmail && emp.authEmail.toLowerCase().includes(searchTerm))
            ).slice(0, 5);

            if (employeeResults.length > 0) {
                results.push({
                    category: 'Employees',
                    icon: 'fa-users',
                    page: 'employees',
                    items: employeeResults.map(emp => ({
                        id: emp.id,
                        title: emp.name,
                        subtitle: `${emp.role} - ${emp.store}`,
                        status: emp.status
                    }))
                });
            }

            // Search Thieves Database
            const thiefResults = thieves.filter(thief =>
                (thief.name && thief.name.toLowerCase().includes(searchTerm)) ||
                (thief.store && thief.store.toLowerCase().includes(searchTerm)) ||
                (thief.crimeType && thief.crimeType.toLowerCase().includes(searchTerm)) ||
                (thief.itemsStolen && thief.itemsStolen.toLowerCase().includes(searchTerm))
            ).slice(0, 5);

            if (thiefResults.length > 0) {
                results.push({
                    category: 'Thief Database',
                    icon: 'fa-user-secret',
                    page: 'thieves',
                    items: thiefResults.map(thief => ({
                        id: thief.id,
                        title: thief.name,
                        subtitle: `${thief.crimeType} - ${thief.store}`,
                        status: thief.banned ? 'banned' : 'active'
                    }))
                });
            }

            // Search Invoices
            const invoiceResults = invoices.filter(inv =>
                (inv.invoiceNumber && inv.invoiceNumber.toLowerCase().includes(searchTerm)) ||
                (inv.vendor && inv.vendor.toLowerCase().includes(searchTerm)) ||
                (inv.category && inv.category.toLowerCase().includes(searchTerm)) ||
                (inv.description && inv.description.toLowerCase().includes(searchTerm))
            ).slice(0, 5);

            if (invoiceResults.length > 0) {
                results.push({
                    category: 'Invoices',
                    icon: 'fa-file-invoice-dollar',
                    page: 'invoices',
                    items: invoiceResults.map(inv => ({
                        id: inv.id,
                        title: inv.invoiceNumber,
                        subtitle: `${inv.vendor} - $${inv.amount.toFixed(2)}`,
                        status: inv.status
                    }))
                });
            }

            // Search Products (New Stuff)
            const productResults = products.filter(prod =>
                (prod.name && prod.name.toLowerCase().includes(searchTerm)) ||
                (prod.category && prod.category.toLowerCase().includes(searchTerm)) ||
                (prod.store && prod.store.toLowerCase().includes(searchTerm)) ||
                (prod.supplier && prod.supplier.toLowerCase().includes(searchTerm))
            ).slice(0, 5);

            if (productResults.length > 0) {
                results.push({
                    category: 'New Products',
                    icon: 'fa-box-open',
                    page: 'newstuff',
                    items: productResults.map(prod => ({
                        id: prod.id,
                        title: prod.name,
                        subtitle: `${prod.category} - ${prod.store}`,
                        status: prod.status
                    }))
                });
            }

            // Search Inventory
            const inventoryResults = inventory.filter(item =>
                (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                (item.flavor && item.flavor.toLowerCase().includes(searchTerm)) ||
                (item.store && item.store.toLowerCase().includes(searchTerm))
            ).slice(0, 5);

            if (inventoryResults.length > 0) {
                results.push({
                    category: 'Inventory',
                    icon: 'fa-warehouse',
                    page: 'restock',
                    items: inventoryResults.map(item => ({
                        id: item.id,
                        title: `${item.brand} ${item.productName}`,
                        subtitle: `${item.flavor} - ${item.store} (${item.stock} in stock)`,
                        status: item.stock <= item.minStock ? 'low' : 'ok'
                    }))
                });
            }

            // Search Announcements
            const announcementResults = announcements.filter(ann =>
                (ann.title && ann.title.toLowerCase().includes(searchTerm)) ||
                (ann.content && ann.content.toLowerCase().includes(searchTerm)) ||
                (ann.author && ann.author.toLowerCase().includes(searchTerm))
            ).slice(0, 5);

            if (announcementResults.length > 0) {
                results.push({
                    category: 'Announcements',
                    icon: 'fa-bullhorn',
                    page: 'announcements',
                    items: announcementResults.map(ann => ({
                        id: ann.id,
                        title: ann.title,
                        subtitle: `${ann.date} - ${ann.author}`,
                        status: 'info'
                    }))
                });
            }

            // Search Modules
            const modules = [
                { name: 'Dashboard', page: 'dashboard', icon: 'fa-th-large' },
                { name: 'Employees', page: 'employees', icon: 'fa-users' },
                { name: 'Schedule', page: 'schedule', icon: 'fa-calendar-alt' },
                { name: 'Clock In/Out', page: 'clockin', icon: 'fa-clock' },
                { name: 'Training Center', page: 'training', icon: 'fa-graduation-cap' },
                { name: 'Licenses & Docs', page: 'licenses', icon: 'fa-folder-open' },
                { name: 'Sales & Analytics', page: 'analytics', icon: 'fa-chart-line' },
                { name: 'Product Requests', page: 'restock', icon: 'fa-boxes' },
                { name: 'Supplies', page: 'supplies', icon: 'fa-shopping-basket' },
                { name: 'Daily Checklist', page: 'dailychecklist', icon: 'fa-clipboard-check' },
                { name: 'Abundance Cloud', page: 'abundancecloud', icon: 'fa-cloud' },
                { name: 'Announcements', page: 'announcements', icon: 'fa-bullhorn' },
                { name: 'Thief Database', page: 'thieves', icon: 'fa-user-secret' },
                { name: 'Invoices & Payments', page: 'invoices', icon: 'fa-file-invoice-dollar' },
                { name: 'Issues Registry', page: 'issues', icon: 'fa-exclamation-triangle' },
                { name: 'Gconomics', page: 'gconomics', icon: 'fa-wallet' },
                { name: 'Vendors & Suppliers', page: 'vendors', icon: 'fa-truck' },
                { name: 'Cash Control', page: 'cashout', icon: 'fa-money-bill-wave' },
                { name: 'Heady Pieces', page: 'treasury', icon: 'fa-vault' },
                { name: 'Change Records', page: 'change', icon: 'fa-coins' },
                { name: 'Customer Care', page: 'customercare', icon: 'fa-heart' },
                { name: 'Risk Notes', page: 'risknotes', icon: 'fa-shield-halved' },
                { name: 'Password Manager', page: 'passwords', icon: 'fa-key' },
                { name: 'G Force', page: 'gforce', icon: 'fa-bolt' },
                { name: 'Project Analytics', page: 'projectanalytics', icon: 'fa-code' }
            ];

            const moduleResults = modules.filter(mod =>
                mod.name.toLowerCase().includes(searchTerm)
            ).slice(0, 10);

            if (moduleResults.length > 0) {
                results.push({
                    category: 'Modules',
                    icon: 'fa-cube',
                    page: 'module',
                    items: moduleResults.map(mod => ({
                        id: mod.page,
                        title: mod.name,
                        subtitle: 'Navigate to module',
                        status: 'info',
                        moduleIcon: mod.icon
                    }))
                });
            }

            // Render results
            renderSearchResults(results, resultsList, dropdown);
        }

        function renderSearchResults(results, resultsList, dropdown) {
            if (results.length === 0) {
                resultsList.innerHTML = `
                    <div class="search-empty">
                        <i class="fas fa-search"></i>
                        <p>No results found</p>
                    </div>
                `;
                dropdown.classList.add('show');
                return;
            }

            let html = '';

            results.forEach(category => {
                html += `<div class="search-category">${category.category}</div>`;

                category.items.forEach(item => {
                    const statusClass = getStatusClass(item.status);
                    const iconClass = item.moduleIcon || category.icon;
                    html += `
                        <div class="search-result-item" onclick="navigateToSearchResult('${category.page}', ${typeof item.id === 'string' ? `'${item.id}'` : item.id})">
                            <div class="search-result-icon">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-title">${escapeHtml(item.title)}</div>
                                <div class="search-result-subtitle">${escapeHtml(item.subtitle)}</div>
                            </div>
                            <span class="search-result-status ${statusClass}">${item.status}</span>
                        </div>
                    `;
                });
            });

            html += `
                <div class="search-shortcut-hint" style="text-align: center;">
                    <span><kbd>Esc</kbd> to close</span>
                </div>
            `;

            resultsList.innerHTML = html;
            dropdown.classList.add('show');
        }

        function getStatusClass(status) {
            const statusMap = {
                'active': 'status-active',
                'inactive': 'status-inactive',
                'banned': 'status-banned',
                'pending': 'status-pending',
                'paid': 'status-paid',
                'overdue': 'status-overdue',
                'arrived': 'status-arrived',
                'low': 'status-low',
                'ok': 'status-ok',
                'info': 'status-info'
            };
            return statusMap[status] || 'status-default';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function navigateToSearchResult(page, itemId) {
            // Hide search dropdown
            hideSearchResults();

            // Clear both search inputs (desktop and mobile)
            const searchInput = document.getElementById('global-search');
            const mobileSearchInput = document.getElementById('mobile-global-search');
            if (searchInput) {
                searchInput.value = '';
            }
            if (mobileSearchInput) {
                mobileSearchInput.value = '';
            }

            // If it's a module search result, navigate directly to that module
            if (page === 'module') {
                navigateTo(itemId);
            } else {
                // Navigate to the page
                navigateTo(page);
            }

            // Optionally highlight or scroll to the item (future enhancement)
            console.log(`Navigated to ${page}, item ID: ${itemId}`);
        }

        function showSearchResults() {
            const dropdown = document.getElementById('search-results-dropdown');
            const searchInput = document.getElementById('global-search');
            const mobileSearchInput = document.getElementById('mobile-global-search');

            // Check both desktop and mobile inputs
            const desktopQuery = searchInput ? searchInput.value.trim() : '';
            const mobileQuery = mobileSearchInput ? mobileSearchInput.value.trim() : '';
            const query = desktopQuery || mobileQuery;

            if (query.length >= 2) {
                performSearch(query);
            }
        }

        function hideSearchResults() {
            const dropdown = document.getElementById('search-results-dropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // Close search dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-bar-container');
            const mobileSearchContainer = document.querySelector('.mobile-header-search');
            const clickedInSearch = (searchContainer && searchContainer.contains(e.target)) ||
                                   (mobileSearchContainer && mobileSearchContainer.contains(e.target));
            if (!clickedInSearch) {
                hideSearchResults();
            }
        });

        // Keyboard shortcuts for search
        document.addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('search-results-dropdown');
            const isDropdownVisible = dropdown && dropdown.classList.contains('show');
            
            // Ctrl+K or Cmd+K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                // Focus appropriate search based on screen size
                const mobileSearch = document.getElementById('mobile-global-search');
                const desktopSearch = document.getElementById('global-search');
                const isMobile = window.innerWidth <= 768;

                if (isMobile && mobileSearch) {
                    mobileSearch.focus();
                    mobileSearch.select();
                } else if (desktopSearch) {
                    desktopSearch.focus();
                    desktopSearch.select();
                }
            }

            // Escape to close search dropdown
            if (e.key === 'Escape') {
                hideSearchResults();
                const searchInput = document.getElementById('global-search');
                const mobileSearchInput = document.getElementById('mobile-global-search');
                if (searchInput) {
                    searchInput.blur();
                }
                if (mobileSearchInput) {
                    mobileSearchInput.blur();
                }
            }
        });

        // Load theme on page initialization
        loadTheme();

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Close mobile menu when clicking nav items (with delay for navigation to complete)
        document.querySelectorAll('.nav-item').forEach(item => {
            const existingListener = item.onclick;
            item.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    // Small delay to ensure navigation starts before closing
                    setTimeout(() => {
                        sidebar.classList.remove('mobile-open');
                    }, 150);
                }
            });

            // Add touch support for better mobile response
            item.addEventListener('touchend', function(e) {
                if (window.innerWidth <= 768) {
                    // Let the click handler do the navigation
                    // Just ensure the sidebar closes
                    const sidebar = document.querySelector('.sidebar');
                    setTimeout(() => {
                        sidebar.classList.remove('mobile-open');
                    }, 200);
                }
            }, { passive: true });
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const mobileMenuBtn = document.querySelector('.mobile-menu-btn');

                // Check if sidebar is open and click is outside sidebar and menu button
                if (sidebar.classList.contains('mobile-open') &&
                    !sidebar.contains(event.target) &&
                    !mobileMenuBtn.contains(event.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });

        // Dropdown toggle functionality
        function toggleDropdown(event, dropdownId) {
            event.preventDefault();
            const dropdown = document.getElementById(`dropdown-${dropdownId}`);
            const navItem = event.currentTarget;
            const icon = navItem.querySelector('.dropdown-icon');

            // Close all other dropdowns
            document.querySelectorAll('.nav-dropdown').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('open');
                    const otherIcon = dd.previousElementSibling.querySelector('.dropdown-icon');
                    if (otherIcon) otherIcon.style.transform = '';
                }
            });

            // Toggle current dropdown
            dropdown.classList.toggle('open');
            if (dropdown.classList.contains('open')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = '';
            }
        }

        // Make toggleDropdown globally accessible
        window.toggleDropdown = toggleDropdown;

        // Drag and drop functionality for licenses
        let draggedLicenseId = null;
        let licensesEditMode = false;  // Edit mode toggle for drag and drop

        function handleLicenseDragStart(event, licenseId) {
            if (!licensesEditMode) {
                event.preventDefault();
                return;
            }
            draggedLicenseId = licenseId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', licenseId);
        }

        function handleLicenseDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedLicenseId = null;
            // Remove drag-over class from all zones
            document.querySelectorAll('.license-store-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function handleLicenseDragOver(event) {
            if (!licensesEditMode) return;
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const dropZone = event.currentTarget;
            dropZone.classList.add('drag-over');
        }

        function handleLicenseDragLeave(event) {
            const dropZone = event.currentTarget;
            dropZone.classList.remove('drag-over');
        }

        async function handleLicenseDrop(event, targetStore) {
            if (!licensesEditMode) return;
            event.preventDefault();
            const dropZone = event.currentTarget;
            dropZone.classList.remove('drag-over');

            if (draggedLicenseId !== null) {
                const license = licenses.find(l => l.id === draggedLicenseId || l.firestoreId === draggedLicenseId);
                if (license && license.store !== targetStore) {
                    const oldStore = license.store;
                    const licenseName = license.name;
                    const licenseFirestoreId = license.firestoreId || license.id;

                    // Update local state immediately
                    license.store = targetStore;
                    renderLicenses();

                    // Save to Firebase immediately
                    try {
                        if (firebaseLicensesManager && firebaseLicensesManager.isInitialized) {
                            await firebaseLicensesManager.updateLicense(licenseFirestoreId, { store: targetStore });
                            showToast(`"${licenseName}" moved to ${targetStore}`, 'success');
                        }
                    } catch (error) {
                        console.error('‚ùå Error saving license move to Firebase:', error);
                        // Revert local change on error
                        license.store = oldStore;
                        renderLicenses();
                        showToast('Error saving change. Please try again.', 'error');
                    }
                }
                draggedLicenseId = null;
            }
        }

        function toggleLicensesEditMode() {
            licensesEditMode = !licensesEditMode;
            renderLicenses();
        }

        function viewLicense(licenseId) {
            const license = licenses.find(l => l.id === licenseId || l.firestoreId === licenseId);
            if (!license) return;

            // Always show the aesthetic modal preview
            viewLicensePdf(licenseId);
        }

        // Note: deleteLicense is defined earlier in the file with Firebase support

        // RISK NOTES FUNCTIONALITY
        const RISK_BEHAVIOR_TYPES = [
            { id: 'strange_questions', label: 'Strange Questions', icon: 'fa-question-circle', color: '#f59e0b' },
            { id: 'unusual_purchase', label: 'Unusual Purchase', icon: 'fa-shopping-cart', color: '#3b82f6' },
            { id: 'recording', label: 'Recording / Taking Photos', icon: 'fa-camera', color: '#8b5cf6' },
            { id: 'policy_violation', label: 'Policy Violation Attempt', icon: 'fa-ban', color: '#ef4444' },
            { id: 'suspicious_attitude', label: 'Suspicious Attitude', icon: 'fa-user-secret', color: '#ec4899' },
            { id: 'other', label: 'Other', icon: 'fa-ellipsis', color: '#6b7280' }
        ];

        const RISK_LEVELS = [
            { id: 'low', label: 'Low', color: '#22c55e', icon: 'fa-circle' },
            { id: 'medium', label: 'Medium', color: '#f59e0b', icon: 'fa-circle' },
            { id: 'high', label: 'High', color: '#ef4444', icon: 'fa-circle' }
        ];

        const RISK_STORES = [
            'Miramar',
            'Morena',
            'Kearny Mesa',
            'Chula Vista',
            'North Park',
            'Miramar Wine & Liquor'
        ];

        // IndexedDB setup for storing images
        let riskPhotoDB = null;
        const initRiskPhotoDB = async () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('RiskNotesDB', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    riskPhotoDB = request.result;
                    resolve(riskPhotoDB);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('photos')) {
                        db.createObjectStore('photos', { keyPath: 'id' });
                    }
                };
            });
        };

        const savePhotoToIndexedDB = async (noteId, photoData) => {
            if (!riskPhotoDB) await initRiskPhotoDB();
            return new Promise((resolve, reject) => {
                const tx = riskPhotoDB.transaction('photos', 'readwrite');
                const store = tx.objectStore('photos');
                store.put({ id: noteId, data: photoData });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        };

        const getPhotoFromIndexedDB = async (noteId) => {
            if (!riskPhotoDB) await initRiskPhotoDB();
            return new Promise((resolve, reject) => {
                const tx = riskPhotoDB.transaction('photos', 'readonly');
                const store = tx.objectStore('photos');
                const request = store.get(noteId);
                request.onsuccess = () => resolve(request.result?.data);
                request.onerror = () => reject(request.error);
            });
        };

        const deletePhotoFromIndexedDB = async (noteId) => {
            if (!riskPhotoDB) await initRiskPhotoDB();
            return new Promise((resolve, reject) => {
                const tx = riskPhotoDB.transaction('photos', 'readwrite');
                const store = tx.objectStore('photos');
                const request = store.delete(noteId);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        };

        // Initialize IndexedDB on page load
        initRiskPhotoDB().catch(err => {
            console.error('Failed to initialize IndexedDB:', err);
        });

        var riskNotesState = {
            notes: [], // Start empty, will be populated from Firebase
            filterStore: 'all',
            filterLevel: 'all',
            filterType: 'all',
            viewMode: 'list', // 'list' or 'grid'
            isLoading: true // Flag to show loading state
        };

        // Load from localStorage only as fallback until Firebase loads
        (function loadInitialRiskNotes() {
            const localNotes = JSON.parse(localStorage.getItem('riskNotes')) || [];
            if (localNotes.length > 0) {
                riskNotesState.notes = localNotes;
            }
        })();

        // Load risk notes from Firebase when available
        async function loadRiskNotesFromFirebase() {
            // Wait for firebaseSyncManager to be initialized
            if (typeof firebaseSyncManager === 'undefined') {
                console.log('FirebaseSyncManager not available');
                return;
            }

            // If not initialized yet, try to initialize
            if (!firebaseSyncManager.isInitialized) {
                try {
                    await firebaseSyncManager.initialize();
                } catch (err) {
                    console.error('Failed to initialize firebaseSyncManager:', err);
                    return;
                }
            }

            if (!firebaseSyncManager.isInitialized) {
                console.log('FirebaseSyncManager could not be initialized');
                return;
            }

            try {
                console.log('üì• Loading risk notes from Firebase...');
                const firebaseNotes = await firebaseSyncManager.loadRiskNotesFromFirestore();

                // Firebase is the SINGLE source of truth
                // Clear localStorage first to prevent zombie data
                localStorage.removeItem('riskNotes');

                if (firebaseNotes && firebaseNotes.length >= 0) {
                    // Use Firebase data directly (even if empty - that means all were deleted)
                    riskNotesState.notes = firebaseNotes;
                    riskNotesState.isLoading = false;
                    saveRiskNotes();
                    console.log(`‚úÖ Loaded ${firebaseNotes.length} risk notes from Firebase`);
                }

                // Re-render if on risknotes page
                if (window.currentPage === 'risknotes') {
                    renderRiskNotes();
                }
            } catch (error) {
                console.error('Error loading risk notes from Firebase:', error);
            }
        }

        // Listen for Firebase sync ready event
        window.addEventListener('firebaseSyncReady', () => {
            console.log('üî• Firebase sync ready - loading risk notes');
            loadRiskNotesFromFirebase();
        });

        // Also try to load after a delay as fallback
        setTimeout(() => {
            if (riskNotesState.notes.length === 0 || !riskNotesState.notes.some(n => n.firestoreId)) {
                loadRiskNotesFromFirebase();
            }
        }, 2000);

        function saveRiskNotes() {
            // Store notes WITHOUT photo data in localStorage (only metadata)
            const notesForStorage = riskNotesState.notes.map(note => {
                const { photo, ...noteData } = note;
                return noteData;
            });
            localStorage.setItem('riskNotes', JSON.stringify(notesForStorage));
        }

        function renderRiskNotes() {
            const dashboard = document.querySelector('.dashboard');
            const currentMonth = new Date().toISOString().slice(0, 7);

            // Filter notes
            let filteredNotes = riskNotesState.notes.filter(note => {
                const storeMatch = riskNotesState.filterStore === 'all' || note.store === riskNotesState.filterStore;
                const levelMatch = riskNotesState.filterLevel === 'all' || note.level === riskNotesState.filterLevel;
                const typeMatch = riskNotesState.filterType === 'all' || note.behaviorType === riskNotesState.filterType;
                return storeMatch && levelMatch && typeMatch;
            });

            // Sort by date descending
            filteredNotes.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Monthly stats
            const monthlyNotes = riskNotesState.notes.filter(n => n.date && n.date.startsWith(currentMonth));
            const storeCounts = {};
            const typeCounts = {};

            monthlyNotes.forEach(note => {
                storeCounts[note.store] = (storeCounts[note.store] || 0) + 1;
                typeCounts[note.behaviorType] = (typeCounts[note.behaviorType] || 0) + 1;
            });

            const topStore = Object.entries(storeCounts).sort((a, b) => b[1] - a[1])[0];
            const topType = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0];

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">
                            <i class="fas fa-shield-halved" style="color: var(--accent-primary);"></i>
                            Risk Notes
                        </h2>
                        <p class="section-subtitle">Document unusual activity and stay alert</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn-primary floating-add-btn" onclick="openModal('add-risknote')">
                            <i class="fas fa-plus"></i> New Risk Note
                        </button>
                    </div>
                </div>

                <!-- Safety Guidelines -->
                <div class="card" style="margin-bottom: 24px; border-left: 4px solid var(--warning); background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, var(--bg-secondary) 100%);">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: start; gap: 16px;">
                            <div style="font-size: 32px;">‚ö†Ô∏è</div>
                            <div>
                                <h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">General Safety Recommendations</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; font-size: 13px; color: var(--text-secondary);">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Never sell to customers without a valid account</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Always verify ID for age-restricted products</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Trust your instincts - if something feels off, report it</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Document everything - dates, times, descriptions</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Alert manager immediately for high-risk situations</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check" style="color: var(--success);"></i>
                                        <span>Never confront suspicious individuals directly</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="card" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white;">
                        <div class="card-body" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700;">${monthlyNotes.length}</div>
                            <div style="font-size: 13px; opacity: 0.9;">Notes This Month</div>
                        </div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        <div class="card-body" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700;">${topStore ? topStore[1] : 0}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${topStore ? topStore[0] : 'No data'}</div>
                            <div style="font-size: 11px; opacity: 0.7;">Most Cases</div>
                        </div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white;">
                        <div class="card-body" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700;">${topType ? topType[1] : 0}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${topType ? RISK_BEHAVIOR_TYPES.find(t => t.id === topType[0])?.label || 'Unknown' : 'No data'}</div>
                            <div style="font-size: 11px; opacity: 0.7;">Most Common Type</div>
                        </div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                        <div class="card-body" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700;">${monthlyNotes.filter(n => n.level === 'high').length}</div>
                            <div style="font-size: 13px; opacity: 0.9;">High Risk</div>
                            <div style="font-size: 11px; opacity: 0.7;">Needs Attention</div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 13px; font-weight: 500;">Store:</label>
                                <select class="form-input" style="width: 160px;" onchange="filterRiskNotes('store', this.value)">
                                    <option value="all" ${riskNotesState.filterStore === 'all' ? 'selected' : ''}>All Stores</option>
                                    ${RISK_STORES.map(store => `
                                        <option value="${store}" ${riskNotesState.filterStore === store ? 'selected' : ''}>${store}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 13px; font-weight: 500;">Level:</label>
                                <select class="form-input" style="width: 140px;" onchange="filterRiskNotes('level', this.value)">
                                    <option value="all" ${riskNotesState.filterLevel === 'all' ? 'selected' : ''}>All Levels</option>
                                    ${RISK_LEVELS.map(level => `
                                        <option value="${level.id}" ${riskNotesState.filterLevel === level.id ? 'selected' : ''}>${level.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 13px; font-weight: 500;">Type:</label>
                                <select class="form-input" style="width: 180px;" onchange="filterRiskNotes('type', this.value)">
                                    <option value="all" ${riskNotesState.filterType === 'all' ? 'selected' : ''}>All Types</option>
                                    ${RISK_BEHAVIOR_TYPES.map(type => `
                                        <option value="${type.id}" ${riskNotesState.filterType === type.id ? 'selected' : ''}>${type.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px; margin-left: auto; align-items: center;">
                                <button class="btn-secondary" onclick="resetRiskNotesFilters()">
                                    <i class="fas fa-refresh"></i> Reset
                                </button>
                                <!-- View Toggle -->
                                <div style="display: flex; background: var(--bg-primary); border-radius: 8px; padding: 3px; border: 1px solid var(--border-color);">
                                    <button onclick="setRiskNotesViewMode('list')" id="risk-view-list-btn" style="width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${riskNotesState.viewMode === 'list' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="List View">
                                        <i class="fas fa-list"></i>
                                    </button>
                                    <button onclick="setRiskNotesViewMode('grid')" id="risk-view-grid-btn" style="width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${riskNotesState.viewMode === 'grid' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="Grid View">
                                        <i class="fas fa-th-large"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Notes List/Grid -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-${riskNotesState.viewMode === 'grid' ? 'th-large' : 'list'}"></i>
                            Recent Activity Notes
                        </h3>
                        <span class="badge" style="background: var(--accent-primary);">${filteredNotes.length} Notes</span>
                    </div>
                    <div class="card-body" id="risk-notes-container">
                        ${filteredNotes.length === 0 ? `
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <i class="fas fa-shield-halved" style="font-size: 56px; margin-bottom: 20px; display: block; opacity: 0.3;"></i>
                                <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No risk notes yet</div>
                                <div style="font-size: 14px;">Click "New Risk Note" to document unusual activity</div>
                            </div>
                        ` : riskNotesState.viewMode === 'grid' ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                                ${filteredNotes.map(note => {
                                    const behaviorType = RISK_BEHAVIOR_TYPES.find(t => t.id === note.behaviorType) || RISK_BEHAVIOR_TYPES[5];
                                    const level = RISK_LEVELS.find(l => l.id === note.level) || RISK_LEVELS[0];
                                    const noteDate = new Date(note.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                    return `
                                        <div class="risk-grid-card" style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.2s; cursor: pointer; display: flex; flex-direction: column;" onclick="viewRiskNote('${note.id}')" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                            <!-- Header with level color -->
                                            <div style="height: 6px; background: ${level.color};"></div>

                                            <!-- Card Content -->
                                            <div style="padding: 20px; flex: 1; display: flex; flex-direction: column;">
                                                <!-- Icon and Type -->
                                                <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 16px;">
                                                    <div style="width: 52px; height: 52px; background: ${behaviorType.color}15; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                        <i class="fas ${behaviorType.icon}" style="color: ${behaviorType.color}; font-size: 22px;"></i>
                                                    </div>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 4px;">${behaviorType.label}</div>
                                                        <span style="background: ${level.color}20; color: ${level.color}; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase;">
                                                            <i class="fas ${level.icon}" style="font-size: 8px;"></i> ${level.label}
                                                        </span>
                                                    </div>
                                                </div>

                                                <!-- Description -->
                                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; flex: 1; margin-bottom: 16px;">
                                                    ${note.description || 'No description provided'}
                                                </div>

                                                <!-- Meta Info -->
                                                <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px; color: var(--text-muted); padding-top: 12px; border-top: 1px solid var(--border-color);">
                                                    <span><i class="fas fa-store" style="margin-right: 4px;"></i>${note.store}</span>
                                                    <span><i class="fas fa-calendar" style="margin-right: 4px;"></i>${noteDate}</span>
                                                    <span><i class="fas fa-user" style="margin-right: 4px;"></i>${note.reportedBy || 'Anonymous'}</span>
                                                </div>

                                                <!-- Indicators -->
                                                ${note.hasPhoto || note.managerNote ? `
                                                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                                                        ${note.hasPhoto ? '<span style="background: var(--bg-primary); padding: 4px 8px; border-radius: 6px; font-size: 11px; color: var(--text-muted);"><i class="fas fa-image"></i> Photo</span>' : ''}
                                                        ${note.managerNote ? '<span style="background: rgba(245, 158, 11, 0.15); padding: 4px 8px; border-radius: 6px; font-size: 11px; color: var(--warning);"><i class="fas fa-comment"></i> Note</span>' : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div style="display: grid; gap: 16px;">
                                ${filteredNotes.map(note => {
                                    const behaviorType = RISK_BEHAVIOR_TYPES.find(t => t.id === note.behaviorType) || RISK_BEHAVIOR_TYPES[5];
                                    const level = RISK_LEVELS.find(l => l.id === note.level) || RISK_LEVELS[0];
                                    const noteDate = new Date(note.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                                    return `
                                        <div class="risk-list-item" style="background: var(--bg-secondary); border-radius: 16px; padding: 20px; border-left: 4px solid ${level.color}; transition: all 0.2s; cursor: pointer;" onclick="viewRiskNote('${note.id}')" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                <div style="display: flex; align-items: center; gap: 12px;">
                                                    <div style="width: 48px; height: 48px; background: ${behaviorType.color}20; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                                        <i class="fas ${behaviorType.icon}" style="color: ${behaviorType.color}; font-size: 20px;"></i>
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${behaviorType.label}</div>
                                                        <div style="font-size: 12px; color: var(--text-muted);">
                                                            <i class="fas fa-store"></i> ${note.store} ‚Ä¢
                                                            <i class="fas fa-calendar"></i> ${noteDate}
                                                        </div>
                                                    </div>
                                                </div>
                                                <span style="background: ${level.color}20; color: ${level.color}; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                                    <i class="fas ${level.icon}" style="font-size: 8px;"></i> ${level.label} Risk
                                                </span>
                                            </div>
                                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                                ${note.description || 'No description'}
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                                <div style="font-size: 12px; color: var(--text-muted);">
                                                    <i class="fas fa-user"></i> ${note.reportedBy || 'Anonymous'}
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    ${note.hasPhoto ? '<i class="fas fa-image" style="color: var(--text-muted); font-size: 12px;" title="Has photo"></i>' : ''}
                                                    ${note.managerNote ? '<i class="fas fa-comment" style="color: var(--warning); font-size: 12px;" title="Has manager note"></i>' : ''}
                                                    <span style="font-size: 11px; color: var(--text-muted);">Click to view</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function filterRiskNotes(filterType, value) {
            if (filterType === 'store') riskNotesState.filterStore = value;
            if (filterType === 'level') riskNotesState.filterLevel = value;
            if (filterType === 'type') riskNotesState.filterType = value;
            renderRiskNotes();
        }

        // Set Risk Notes view mode (list or grid)
        function setRiskNotesViewMode(mode) {
            riskNotesState.viewMode = mode;

            // Update button styles
            const listBtn = document.getElementById('risk-view-list-btn');
            const gridBtn = document.getElementById('risk-view-grid-btn');

            if (listBtn && gridBtn) {
                if (mode === 'list') {
                    listBtn.style.background = 'var(--accent-primary)';
                    listBtn.style.color = 'white';
                    gridBtn.style.background = 'transparent';
                    gridBtn.style.color = 'var(--text-muted)';
                } else {
                    gridBtn.style.background = 'var(--accent-primary)';
                    gridBtn.style.color = 'white';
                    listBtn.style.background = 'transparent';
                    listBtn.style.color = 'var(--text-muted)';
                }
            }

            // Re-render the page
            renderRiskNotes();
        }

        function resetRiskNotesFilters() {
            riskNotesState.filterStore = 'all';
            riskNotesState.filterLevel = 'all';
            riskNotesState.filterType = 'all';
            renderRiskNotes();
        }

        function deleteRiskNote(noteId) {
            showConfirmModal({
                title: 'Delete Risk Note',
                message: 'Are you sure you want to delete this risk note? This action cannot be undone.',
                confirmText: 'Delete',
                type: 'danger',
                onConfirm: async () => {
                    const note = riskNotesState.notes.find(n => n.id === noteId);

                    // Delete photo from Firebase Storage first if it exists
                    if (note && note.photoPath && typeof firebaseStorageHelper !== 'undefined') {
                        try {
                            await firebaseStorageHelper.deleteFile(note.photoPath);
                        } catch (storageErr) {
                            console.error('Error deleting photo from Storage:', storageErr);
                        }
                    }

                    // Delete from Firebase Firestore if it has a firestoreId
                    if (note && note.firestoreId && typeof firebaseSyncManager !== 'undefined' && firebaseSyncManager.isInitialized) {
                        try {
                            await firebaseSyncManager.deleteRiskNoteFromFirestore(note.firestoreId);
                        } catch (error) {
                            console.error('Error deleting risk note from Firebase:', error);
                        }
                    }

                    riskNotesState.notes = riskNotesState.notes.filter(n => n.id !== noteId);

                    // Delete photo from IndexedDB if it exists (legacy fallback)
                    if (note && note.hasPhoto && !note.photoPath) {
                        deletePhotoFromIndexedDB(noteId).catch(err => {
                            console.error('Error deleting photo from IndexedDB:', err);
                        });
                    }

                    saveRiskNotes();
                    renderRiskNotes();

                    // Show success notification
                    if (typeof showNotification === 'function') {
                        showNotification('Risk note deleted successfully', 'success');
                    }
                }
            });
        }

        function saveRiskNote() {
            const date = document.getElementById('risknote-date').value || new Date().toISOString().split('T')[0];
            const store = document.getElementById('risknote-store').value;
            const behaviorType = document.getElementById('risknote-type').value;
            const description = document.getElementById('risknote-description').value.trim();
            const level = document.getElementById('risknote-level').value;
            const reportedBy = document.getElementById('risknote-reporter').value.trim();
            const managerNote = document.getElementById('risknote-manager-note')?.value.trim() || '';
            const photoInput = document.getElementById('risknote-photo');

            if (photoInput && photoInput.files && photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    createRiskNote(date, store, behaviorType, description, level, reportedBy, managerNote, e.target.result);
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                createRiskNote(date, store, behaviorType, description, level, reportedBy, managerNote, null);
            }
        }

        async function createRiskNote(date, store, behaviorType, description, level, reportedBy, managerNote, photo) {
            const noteId = Date.now().toString();

            // Upload photo to Firebase Storage if provided
            let photoUrl = null;
            let photoPath = null;
            if (photo) {
                // Initialize storage helper if needed
                if (!firebaseStorageHelper.isInitialized) {
                    firebaseStorageHelper.initialize();
                }

                try {
                    const uploadResult = await firebaseStorageHelper.uploadImage(
                        photo,
                        'risk-notes/photos',
                        noteId
                    );
                    photoUrl = uploadResult.url;
                    photoPath = uploadResult.path;
                } catch (err) {
                    console.error('Error uploading risk note photo to Storage:', err);
                    // Fallback to IndexedDB if Storage fails
                    try {
                        await savePhotoToIndexedDB(noteId, photo);
                    } catch (indexedErr) {
                        console.error('Error saving photo to IndexedDB:', indexedErr);
                    }
                }
            }

            const newNote = {
                id: noteId,
                date,
                store: store || 'Miramar',
                behaviorType: behaviorType || 'other',
                description: description || '',
                level: level || 'low',
                reportedBy: reportedBy || 'Staff',
                managerNote,
                hasPhoto: !!photo,
                photo: photoUrl,        // Firebase Storage URL
                photoPath: photoPath,   // For future deletion
                createdAt: new Date().toISOString()
            };

            // Save to Firebase first
            if (typeof firebaseSyncManager !== 'undefined') {
                // Initialize if needed
                if (!firebaseSyncManager.isInitialized) {
                    try {
                        await firebaseSyncManager.initialize();
                    } catch (initErr) {
                        console.error('Error initializing firebaseSyncManager:', initErr);
                    }
                }

                if (firebaseSyncManager.isInitialized) {
                    try {
                        const firestoreId = await firebaseSyncManager.saveRiskNoteToFirestore(newNote);
                        if (firestoreId) {
                            newNote.firestoreId = firestoreId;
                        }
                    } catch (error) {
                        console.error('Error saving risk note to Firebase:', error);
                    }
                }
            }

            riskNotesState.notes.unshift(newNote);

            saveRiskNotes();
            closeModal();
            renderRiskNotes();

            // Show success notification
            if (typeof showNotification === 'function') {
                showNotification('Risk note created successfully!', 'success');
            }
        }

        function previewRiskNotePhoto(input) {
            const preview = document.getElementById('risknote-photo-preview');
            const img = document.getElementById('risknote-photo-img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        function selectRiskLevel(level) {
            document.getElementById('risknote-level').value = level;
            const buttons = document.querySelectorAll('.risk-level-btn');
            buttons.forEach(btn => {
                const btnLevel = RISK_LEVELS.find(l => l.id === btn.dataset.level);
                if (btn.dataset.level === level) {
                    btn.style.borderColor = btnLevel.color;
                    btn.style.background = btnLevel.color + '20';
                } else {
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.background = 'var(--bg-secondary)';
                }
            });
        }

        // ========== Risk Note Voice Assistant ==========
        let riskNoteVoiceRecognition = null;
        let riskNoteIsRecording = false;
        let riskNoteTranscript = '';
        let riskNoteStoppedByUser = false;

        function toggleRiskNoteVoiceRecording() {
            if (riskNoteIsRecording) {
                stopRiskNoteVoiceRecording();
            } else {
                startRiskNoteVoiceRecording();
            }
        }

        function startRiskNoteVoiceRecording() {
            // Check for browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                const statusDiv = document.getElementById('risknote-voice-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Voice recognition not supported. Try Chrome or Edge.</span>';
                }
                return;
            }

            try {
                riskNoteVoiceRecognition = new SpeechRecognition();
                riskNoteVoiceRecognition.continuous = true;
                riskNoteVoiceRecognition.interimResults = true;
                riskNoteVoiceRecognition.lang = 'en-US';
                riskNoteVoiceRecognition.maxAlternatives = 1;

                const btn = document.getElementById('risknote-voice-btn');
                const icon = document.getElementById('risknote-voice-icon');
                const text = document.getElementById('risknote-voice-text');
                const statusDiv = document.getElementById('risknote-voice-status');
                const transcriptPreview = document.getElementById('risknote-transcript-preview');
                const transcriptText = document.getElementById('risknote-transcript-text');

                riskNoteTranscript = '';
                riskNoteStoppedByUser = false;

                riskNoteVoiceRecognition.onstart = () => {
                    riskNoteIsRecording = true;
                    if (btn) btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    if (icon) icon.className = 'fas fa-stop';
                    if (text) text.textContent = 'Stop Recording';
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = '<i class="fas fa-circle" style="color: #ef4444; animation: pulse 1s infinite;"></i> <span style="color: var(--text-primary);">Listening... Speak now</span>';
                    }
                    if (transcriptPreview) transcriptPreview.style.display = 'none';
                };

                riskNoteVoiceRecognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        riskNoteTranscript += finalTranscript;
                    }

                    // Show real-time transcript
                    if (transcriptPreview && transcriptText) {
                        transcriptPreview.style.display = 'block';
                        transcriptText.innerHTML = riskNoteTranscript + '<span style="color: var(--text-muted); font-style: italic;">' + interimTranscript + '</span>';
                    }
                };

                riskNoteVoiceRecognition.onerror = (event) => {
                    console.error('Voice recognition error:', event.error);
                    // Don't show error for 'aborted' or 'no-speech' - these are normal
                    if (event.error !== 'aborted' && event.error !== 'no-speech') {
                        if (statusDiv) {
                            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Error: ${event.error}. Try again.</span>`;
                        }
                    }
                };

                riskNoteVoiceRecognition.onend = () => {
                    // If user stopped it, processing is already handled in stopRiskNoteVoiceRecording
                    if (riskNoteStoppedByUser) {
                        return;
                    }

                    // Auto-restart if it ended unexpectedly (browser timeout) and still recording
                    if (riskNoteIsRecording) {
                        try {
                            riskNoteVoiceRecognition.start();
                            return;
                        } catch (e) {
                            console.log('Could not restart recognition:', e);
                        }
                    }
                    resetRiskNoteVoiceUI();
                };

                riskNoteVoiceRecognition.start();
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                const statusDiv = document.getElementById('risknote-voice-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Could not start voice recording. Check microphone permissions.</span>';
                }
            }
        }

        function stopRiskNoteVoiceRecording() {
            riskNoteStoppedByUser = true;
            riskNoteIsRecording = false;

            // Stop the recognition
            if (riskNoteVoiceRecognition) {
                try {
                    riskNoteVoiceRecognition.stop();
                } catch (e) {
                    console.log('Error stopping recognition:', e);
                }
            }

            // Reset the UI immediately
            const btn = document.getElementById('risknote-voice-btn');
            const icon = document.getElementById('risknote-voice-icon');
            const text = document.getElementById('risknote-voice-text');
            const statusDiv = document.getElementById('risknote-voice-status');

            if (btn) btn.style.background = 'linear-gradient(135deg, #8b5cf6, #ec4899)';
            if (icon) icon.className = 'fas fa-microphone';
            if (text) text.textContent = 'Start Recording';

            // If we have transcript, process it with AI
            if (riskNoteTranscript.trim()) {
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #8b5cf6;"></i> <span style="color: var(--text-primary);">Processing your voice note with AI...</span>';
                }
                processRiskNoteWithAI(riskNoteTranscript.trim());
            } else {
                if (statusDiv) {
                    statusDiv.innerHTML = '<i class="fas fa-info-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">No speech detected. Please try again.</span>';
                }
            }
        }

        function resetRiskNoteVoiceUI() {
            riskNoteIsRecording = false;
            const btn = document.getElementById('risknote-voice-btn');
            const icon = document.getElementById('risknote-voice-icon');
            const text = document.getElementById('risknote-voice-text');

            if (btn) {
                btn.style.background = 'linear-gradient(135deg, #8b5cf6, #ec4899)';
            }
            if (icon) {
                icon.className = 'fas fa-microphone';
            }
            if (text) {
                text.textContent = 'Start Recording';
            }
        }

        async function processRiskNoteWithAI(transcript) {
            const statusDiv = document.getElementById('risknote-voice-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #8b5cf6;"></i> <span style="color: var(--text-primary);">AI is processing your report...</span>';

            try {
                // Get API key - use window.getOpenAIKey or fallback to default
                const DEFAULT_KEY = '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';
                const apiKey = (typeof window.getOpenAIKey === 'function') ? window.getOpenAIKey() : (localStorage.getItem('openai_api_key') || DEFAULT_KEY);

                if (!apiKey) {
                    // If no API key, just put the transcript in description
                    document.getElementById('risknote-description').value = transcript;
                    statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Transcript added to description. Configure API key for AI auto-fill.</span>';
                    return;
                }

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'system',
                                content: `You are a security assistant helping to document risk notes for a retail store. Extract structured information from voice transcripts about suspicious activity or policy violations.`
                            },
                            {
                                role: 'user',
                                content: `Analyze this voice transcript about a risk/security incident and extract the information. Return ONLY a JSON object with these fields (use null for any field you cannot determine):

Transcript: "${transcript}"

{
    "store": "one of: Miramar, Morena, Kearny Mesa, Chula Vista, North Park, Miramar Wine & Liquor (if mentioned)",
    "behaviorType": "one of: strange_questions, unusual_purchase, recording, policy_violation, suspicious_attitude, other",
    "description": "a clear, professional description of what happened based on the transcript",
    "riskLevel": "low, medium, or high based on severity",
    "reportedBy": "name of the person reporting if mentioned"
}

Behavior type guidelines:
- strange_questions: asking unusual questions about security, schedules, or policies
- unusual_purchase: suspicious buying patterns, bulk purchases, specific combinations
- recording: taking photos/videos without permission
- policy_violation: attempting to violate store policies
- suspicious_attitude: nervous behavior, watching cameras, avoiding eye contact
- other: anything that doesn't fit above

Risk level guidelines:
- low: minor concern, document for awareness
- medium: notable concern, should monitor
- high: immediate concern, requires action

Return ONLY the JSON object, no additional text.`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                // Parse the JSON response
                let riskData;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        riskData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    // Fallback: just use transcript as description
                    document.getElementById('risknote-description').value = transcript;
                    statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">Transcript added. AI parsing failed.</span>';
                    return;
                }

                // Fill in the form fields
                if (riskData.store) {
                    const storeSelect = document.getElementById('risknote-store');
                    for (let option of storeSelect.options) {
                        if (option.value.toLowerCase().includes(riskData.store.toLowerCase()) ||
                            riskData.store.toLowerCase().includes(option.value.toLowerCase())) {
                            storeSelect.value = option.value;
                            break;
                        }
                    }
                }

                if (riskData.behaviorType) {
                    const typeSelect = document.getElementById('risknote-type');
                    const typeValue = riskData.behaviorType.toLowerCase().replace(/\s+/g, '_');
                    for (let option of typeSelect.options) {
                        if (option.value === typeValue) {
                            typeSelect.value = option.value;
                            break;
                        }
                    }
                }

                if (riskData.description) {
                    document.getElementById('risknote-description').value = riskData.description;
                } else {
                    document.getElementById('risknote-description').value = transcript;
                }

                if (riskData.riskLevel) {
                    selectRiskLevel(riskData.riskLevel.toLowerCase());
                }

                if (riskData.reportedBy) {
                    document.getElementById('risknote-reporter').value = riskData.reportedBy;
                }

                statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Form auto-filled! Review and save.</span>';

            } catch (error) {
                console.error('Error processing with AI:', error);
                // Fallback: just use transcript as description
                document.getElementById('risknote-description').value = transcript;
                statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">AI error. Transcript added to description.</span>`;
            }
        }
        // ========== End Risk Note Voice Assistant ==========

        // ========== Gift Voice Assistant ==========
        let giftVoiceRecognition = null;
        let giftIsRecording = false;
        let giftTranscript = '';
        let giftStoppedByUser = false;

        function toggleGiftVoiceRecording() {
            if (giftIsRecording) {
                stopGiftVoiceRecording();
            } else {
                startGiftVoiceRecording();
            }
        }

        function startGiftVoiceRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                const statusDiv = document.getElementById('gift-voice-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Voice recognition not supported. Try Chrome or Edge.</span>';
                }
                return;
            }

            try {
                giftVoiceRecognition = new SpeechRecognition();
                giftVoiceRecognition.continuous = true;
                giftVoiceRecognition.interimResults = true;
                giftVoiceRecognition.lang = 'en-US';
                giftVoiceRecognition.maxAlternatives = 1;

                const btn = document.getElementById('gift-voice-btn');
                const icon = document.getElementById('gift-voice-icon');
                const text = document.getElementById('gift-voice-text');
                const statusDiv = document.getElementById('gift-voice-status');
                const transcriptPreview = document.getElementById('gift-transcript-preview');
                const transcriptText = document.getElementById('gift-transcript-text');

                giftTranscript = '';
                giftStoppedByUser = false;

                giftVoiceRecognition.onstart = () => {
                    giftIsRecording = true;
                    if (btn) btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    if (icon) icon.className = 'fas fa-stop';
                    if (text) text.textContent = 'Stop Recording';
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = '<i class="fas fa-circle" style="color: #ef4444; animation: pulse 1s infinite;"></i> <span style="color: var(--text-primary);">Listening... Describe the gift</span>';
                    }
                    if (transcriptPreview) transcriptPreview.style.display = 'none';
                };

                giftVoiceRecognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        giftTranscript += finalTranscript;
                    }

                    if (transcriptPreview && transcriptText) {
                        transcriptPreview.style.display = 'block';
                        transcriptText.innerHTML = giftTranscript + '<span style="color: var(--text-muted); font-style: italic;">' + interimTranscript + '</span>';
                    }
                };

                giftVoiceRecognition.onerror = (event) => {
                    console.error('Gift voice recognition error:', event.error);
                    if (event.error !== 'aborted' && event.error !== 'no-speech') {
                        if (statusDiv) {
                            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Error: ${event.error}. Try again.</span>`;
                        }
                    }
                };

                giftVoiceRecognition.onend = () => {
                    if (giftStoppedByUser && giftTranscript.trim()) {
                        processGiftWithAI(giftTranscript.trim());
                    } else if (!giftStoppedByUser && giftIsRecording) {
                        try {
                            giftVoiceRecognition.start();
                            return;
                        } catch (e) {
                            console.log('Could not restart gift recognition:', e);
                        }
                    }
                    resetGiftVoiceUI();
                };

                giftVoiceRecognition.start();
            } catch (error) {
                console.error('Error starting gift voice recognition:', error);
                const statusDiv = document.getElementById('gift-voice-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Could not start voice recording. Check microphone permissions.</span>';
                }
            }
        }

        function stopGiftVoiceRecording() {
            giftStoppedByUser = true;
            giftIsRecording = false;
            if (giftVoiceRecognition) {
                try {
                    giftVoiceRecognition.stop();
                } catch (e) {
                    console.log('Error stopping gift recognition:', e);
                }
            }
            if (giftTranscript.trim()) {
                processGiftWithAI(giftTranscript.trim());
            }
        }

        function resetGiftVoiceUI() {
            giftIsRecording = false;
            const btn = document.getElementById('gift-voice-btn');
            const icon = document.getElementById('gift-voice-icon');
            const text = document.getElementById('gift-voice-text');

            if (btn) {
                btn.style.background = 'linear-gradient(135deg, #ec4899, #f59e0b)';
            }
            if (icon) {
                icon.className = 'fas fa-microphone';
            }
            if (text) {
                text.textContent = 'Start Recording';
            }
        }

        async function processGiftWithAI(transcript) {
            const statusDiv = document.getElementById('gift-voice-status');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #ec4899;"></i> <span style="color: var(--text-primary);">AI is processing your gift info...</span>';
            }

            try {
                const apiKey = getOpenAIKey();
                if (!apiKey) {
                    document.getElementById('gift-reason').value = transcript;
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Transcript added to reason. Configure API key for AI auto-fill.</span>';
                    }
                    return;
                }

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'system',
                                content: `You are an assistant helping to document gifts given at a retail store. Extract structured information from voice transcripts about gifts given to customers, vendors, or employees.`
                            },
                            {
                                role: 'user',
                                content: `Analyze this voice transcript about a gift and extract the information. Return ONLY a JSON object with these fields (use null for any field you cannot determine):

Transcript: "${transcript}"

{
    "productName": "the product being given as a gift",
    "quantity": "number of items (default 1)",
    "value": "estimated value in dollars as a number",
    "recipientName": "name of person receiving the gift",
    "recipientType": "one of: customer, vendor, employee, other",
    "reason": "clear explanation of why the gift was given",
    "store": "one of: Miramar, Morena, Kearny Mesa, Chula Vista, North Park, Miramar Wine & Liquor (if mentioned)",
    "notes": "any additional relevant details"
}

Recipient type guidelines:
- customer: regular customer, buyer
- vendor: supplier, sales rep
- employee: staff member, worker
- other: anyone else

Return ONLY the JSON object, no additional text.`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                let giftData;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        giftData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    document.getElementById('gift-reason').value = transcript;
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">Transcript added. AI parsing failed.</span>';
                    }
                    return;
                }

                // Fill in the form fields
                if (giftData.productName) {
                    document.getElementById('gift-product').value = giftData.productName;
                }

                if (giftData.quantity) {
                    const qty = parseInt(giftData.quantity);
                    if (!isNaN(qty) && qty > 0) {
                        document.getElementById('gift-quantity').value = qty;
                    }
                }

                if (giftData.value) {
                    const val = parseFloat(giftData.value.toString().replace(/[^0-9.]/g, ''));
                    if (!isNaN(val)) {
                        document.getElementById('gift-value').value = val.toFixed(2);
                    }
                }

                if (giftData.recipientName) {
                    document.getElementById('gift-recipient').value = giftData.recipientName;
                }

                if (giftData.recipientType) {
                    const typeSelect = document.getElementById('gift-recipient-type');
                    const typeValue = giftData.recipientType.toLowerCase();
                    for (let option of typeSelect.options) {
                        if (option.value === typeValue) {
                            typeSelect.value = option.value;
                            break;
                        }
                    }
                }

                if (giftData.reason) {
                    document.getElementById('gift-reason').value = giftData.reason;
                } else {
                    document.getElementById('gift-reason').value = transcript;
                }

                if (giftData.store) {
                    const storeSelect = document.getElementById('gift-store');
                    for (let option of storeSelect.options) {
                        if (option.value.toLowerCase().includes(giftData.store.toLowerCase()) ||
                            giftData.store.toLowerCase().includes(option.value.toLowerCase())) {
                            storeSelect.value = option.value;
                            break;
                        }
                    }
                }

                if (giftData.notes) {
                    document.getElementById('gift-notes').value = giftData.notes;
                }

                if (statusDiv) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Gift form auto-filled! Review and save.</span>';
                }

            } catch (error) {
                console.error('Error processing gift with AI:', error);
                document.getElementById('gift-reason').value = transcript;
                if (statusDiv) {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">AI error. Transcript added to reason.</span>`;
                }
            }
        }
        // ========== End Gift Voice Assistant ==========

        // ========== Cashout (Cash Control) Voice Assistant ==========
        let cashoutVoiceRecognition = null;
        let cashoutIsRecording = false;
        let cashoutTranscript = '';
        let cashoutStoppedByUser = false;

        function toggleCashoutVoiceRecording() {
            if (cashoutIsRecording) {
                stopCashoutVoiceRecording();
            } else {
                startCashoutVoiceRecording();
            }
        }

        function startCashoutVoiceRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                const statusDiv = document.getElementById('cashout-voice-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Voice recognition not supported. Try Chrome or Edge.</span>';
                }
                return;
            }

            try {
                cashoutVoiceRecognition = new SpeechRecognition();
                cashoutVoiceRecognition.continuous = true;
                cashoutVoiceRecognition.interimResults = true;
                cashoutVoiceRecognition.lang = 'en-US';
                cashoutVoiceRecognition.maxAlternatives = 1;

                const btn = document.getElementById('cashout-voice-btn');
                const icon = document.getElementById('cashout-voice-icon');
                const text = document.getElementById('cashout-voice-text');
                const statusDiv = document.getElementById('cashout-voice-status');
                const transcriptPreview = document.getElementById('cashout-transcript-preview');
                const transcriptText = document.getElementById('cashout-transcript-text');

                cashoutTranscript = '';
                cashoutStoppedByUser = false;

                cashoutVoiceRecognition.onstart = () => {
                    cashoutIsRecording = true;
                    if (btn) btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    if (icon) icon.className = 'fas fa-stop';
                    if (text) text.textContent = 'Stop';
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = '<i class="fas fa-circle" style="color: #ef4444; animation: pulse 1s infinite;"></i> <span style="color: var(--text-primary);">Listening... Describe the expense</span>';
                    }
                    if (transcriptPreview) transcriptPreview.style.display = 'none';
                };

                cashoutVoiceRecognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        cashoutTranscript += finalTranscript;
                    }

                    if (transcriptPreview && transcriptText) {
                        transcriptPreview.style.display = 'block';
                        transcriptText.innerHTML = cashoutTranscript + '<span style="color: var(--text-muted); font-style: italic;">' + interimTranscript + '</span>';
                    }
                };

                cashoutVoiceRecognition.onerror = (event) => {
                    console.error('Cashout voice recognition error:', event.error);
                    if (event.error !== 'aborted' && event.error !== 'no-speech') {
                        if (statusDiv) {
                            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Error: ${event.error}. Try again.</span>`;
                        }
                    }
                };

                cashoutVoiceRecognition.onend = () => {
                    if (cashoutStoppedByUser && cashoutTranscript.trim()) {
                        processCashoutWithAI(cashoutTranscript.trim());
                    } else if (!cashoutStoppedByUser && cashoutIsRecording) {
                        try {
                            cashoutVoiceRecognition.start();
                            return;
                        } catch (e) {
                            console.log('Could not restart cashout recognition:', e);
                        }
                    }
                    resetCashoutVoiceUI();
                };

                cashoutVoiceRecognition.start();
            } catch (error) {
                console.error('Error starting cashout voice recognition:', error);
                const statusDiv = document.getElementById('cashout-voice-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Could not start voice recording. Check microphone permissions.</span>';
                }
            }
        }

        function stopCashoutVoiceRecording() {
            cashoutStoppedByUser = true;
            cashoutIsRecording = false;
            if (cashoutVoiceRecognition) {
                try {
                    cashoutVoiceRecognition.stop();
                } catch (e) {
                    console.log('Error stopping cashout recognition:', e);
                }
            }
            if (cashoutTranscript.trim()) {
                processCashoutWithAI(cashoutTranscript.trim());
            }
        }

        function resetCashoutVoiceUI() {
            cashoutIsRecording = false;
            const btn = document.getElementById('cashout-voice-btn');
            const icon = document.getElementById('cashout-voice-icon');
            const text = document.getElementById('cashout-voice-text');

            if (btn) {
                btn.style.background = 'linear-gradient(135deg, #ec4899, #f59e0b)';
            }
            if (icon) {
                icon.className = 'fas fa-microphone';
            }
            if (text) {
                text.textContent = 'Voice';
            }
        }

        async function processCashoutWithAI(transcript) {
            const statusDiv = document.getElementById('cashout-voice-status');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #8b5cf6;"></i> <span style="color: var(--text-primary);">AI is processing your expense...</span>';
            }

            try {
                const apiKey = getOpenAIKey();
                if (!apiKey) {
                    document.getElementById('cashout-name').value = transcript;
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Transcript added. Configure API key for AI auto-fill.</span>';
                    }
                    return;
                }

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'system',
                                content: `You are an assistant helping to document cash out expenses at a retail store. Extract structured information from voice transcripts about expenses and cash withdrawals.`
                            },
                            {
                                role: 'user',
                                content: `Analyze this voice transcript about an expense/cash out and extract the information. Return ONLY a JSON object with these fields (use null for any field you cannot determine):

Transcript: "${transcript}"

{
    "description": "clear description of the expense (e.g., Office Supplies from Staples, Bank Deposit, Cleaning Supplies)",
    "amount": "the amount as a number (no currency symbols)",
    "store": "one of: Miramar, Morena, Kearny Mesa, Chula Vista, North Park, Miramar Wine & Liquor (if mentioned)",
    "notes": "any additional relevant details"
}

Return ONLY the JSON object, no additional text.`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                let cashoutData;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        cashoutData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    document.getElementById('cashout-name').value = transcript;
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">Transcript added. AI parsing failed.</span>';
                    }
                    return;
                }

                // Fill in the form fields
                if (cashoutData.description) {
                    document.getElementById('cashout-name').value = cashoutData.description;
                } else {
                    document.getElementById('cashout-name').value = transcript;
                }

                if (cashoutData.amount) {
                    const amount = parseFloat(cashoutData.amount.toString().replace(/[^0-9.]/g, ''));
                    if (!isNaN(amount)) {
                        document.getElementById('cashout-amount').value = amount.toFixed(2);
                    }
                }

                if (cashoutData.store) {
                    const storeSelect = document.getElementById('cashout-store');
                    for (let option of storeSelect.options) {
                        if (option.value.toLowerCase().includes(cashoutData.store.toLowerCase()) ||
                            cashoutData.store.toLowerCase().includes(option.value.toLowerCase())) {
                            storeSelect.value = option.value;
                            break;
                        }
                    }
                }

                if (cashoutData.notes) {
                    document.getElementById('cashout-reason').value = cashoutData.notes;
                }

                if (statusDiv) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Expense form auto-filled! Review and save.</span>';
                }

            } catch (error) {
                console.error('Error processing cashout with AI:', error);
                document.getElementById('cashout-name').value = transcript;
                if (statusDiv) {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">AI error. Transcript added to description.</span>`;
                }
            }
        }
        // ========== End Cashout Voice Assistant ==========

        // ========== Issue Voice Assistant ==========
        let issueVoiceRecognition = null;
        let issueIsRecording = false;
        let issueTranscript = '';
        let issueStoppedByUser = false;

        function toggleIssueVoiceRecording() {
            if (issueIsRecording) {
                stopIssueVoiceRecording();
            } else {
                startIssueVoiceRecording();
            }
        }

        function startIssueVoiceRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                const statusDiv = document.getElementById('issue-voice-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Voice recognition not supported. Try Chrome or Edge.</span>';
                }
                return;
            }

            try {
                issueVoiceRecognition = new SpeechRecognition();
                issueVoiceRecognition.continuous = true;
                issueVoiceRecognition.interimResults = true;
                issueVoiceRecognition.lang = 'en-US';
                issueVoiceRecognition.maxAlternatives = 1;

                const btn = document.getElementById('issue-voice-btn');
                const icon = document.getElementById('issue-voice-icon');
                const text = document.getElementById('issue-voice-text');
                const statusDiv = document.getElementById('issue-voice-status');
                const transcriptPreview = document.getElementById('issue-transcript-preview');
                const transcriptText = document.getElementById('issue-transcript-text');

                issueTranscript = '';
                issueStoppedByUser = false;

                issueVoiceRecognition.onstart = () => {
                    issueIsRecording = true;
                    if (btn) btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    if (icon) icon.className = 'fas fa-stop';
                    if (text) text.textContent = 'Stop Recording';
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = '<i class="fas fa-circle" style="color: #ef4444; animation: pulse 1s infinite;"></i> <span style="color: var(--text-primary);">Listening... Describe the issue</span>';
                    }
                    if (transcriptPreview) transcriptPreview.style.display = 'none';
                };

                issueVoiceRecognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        issueTranscript += finalTranscript;
                    }

                    if (transcriptPreview && transcriptText) {
                        transcriptPreview.style.display = 'block';
                        transcriptText.innerHTML = issueTranscript + '<span style="color: var(--text-muted); font-style: italic;">' + interimTranscript + '</span>';
                    }
                };

                issueVoiceRecognition.onerror = (event) => {
                    console.error('Issue voice recognition error:', event.error);
                    if (event.error !== 'aborted' && event.error !== 'no-speech') {
                        if (statusDiv) {
                            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Error: ${event.error}. Try again.</span>`;
                        }
                    }
                };

                issueVoiceRecognition.onend = () => {
                    if (issueStoppedByUser && issueTranscript.trim()) {
                        processIssueWithAI(issueTranscript.trim());
                    } else if (!issueStoppedByUser && issueIsRecording) {
                        try {
                            issueVoiceRecognition.start();
                            return;
                        } catch (e) {
                            console.log('Could not restart issue recognition:', e);
                        }
                    }
                    resetIssueVoiceUI();
                };

                issueVoiceRecognition.start();
            } catch (error) {
                console.error('Error starting issue voice recognition:', error);
                const statusDiv = document.getElementById('issue-voice-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Could not start voice recording. Check microphone permissions.</span>';
                }
            }
        }

        function stopIssueVoiceRecording() {
            issueStoppedByUser = true;
            issueIsRecording = false;
            if (issueVoiceRecognition) {
                try {
                    issueVoiceRecognition.stop();
                } catch (e) {
                    console.log('Error stopping issue recognition:', e);
                }
            }
            if (issueTranscript.trim()) {
                processIssueWithAI(issueTranscript.trim());
            }
        }

        function resetIssueVoiceUI() {
            issueIsRecording = false;
            const btn = document.getElementById('issue-voice-btn');
            const icon = document.getElementById('issue-voice-icon');
            const text = document.getElementById('issue-voice-text');

            if (btn) {
                btn.style.background = 'linear-gradient(135deg, #ef4444, #f59e0b)';
            }
            if (icon) {
                icon.className = 'fas fa-microphone';
            }
            if (text) {
                text.textContent = 'Start Recording';
            }
        }

        async function processIssueWithAI(transcript) {
            const statusDiv = document.getElementById('issue-voice-status');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">AI is processing your issue report...</span>';
            }

            try {
                const apiKey = getOpenAIKey();
                if (!apiKey) {
                    document.getElementById('issue-description').value = transcript;
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Transcript added. Configure API key for AI auto-fill.</span>';
                    }
                    return;
                }

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 1024,
                        messages: [
                            {
                                role: 'system',
                                content: `You are an assistant helping to document customer issues at a retail store. Extract structured information from voice transcripts about customer complaints, problems, or incidents.`
                            },
                            {
                                role: 'user',
                                content: `Analyze this voice transcript about a customer issue and extract the information. Return ONLY a JSON object with these fields (use null for any field you cannot determine):

Transcript: "${transcript}"

{
    "customerName": "name of the customer if mentioned",
    "phone": "phone number if mentioned (format: (XXX) XXX-XXXX)",
    "issueType": "In Store or Online",
    "store": "one of: Miramar, Morena, Kearny Mesa, Chula Vista, North Park, Miramar Wine & Liquor (if mentioned)",
    "description": "clear, professional description of the issue",
    "perception": "1-5 based on how upset the customer seemed (1=Very Upset, 2=Upset, 3=Neutral, 4=Satisfied, 5=Happy)"
}

Perception guidelines:
- 1 (Very Upset): Customer was extremely angry, yelling, threatening
- 2 (Upset): Customer was clearly frustrated or disappointed
- 3 (Neutral): Customer was calm, just reporting an issue
- 4 (Satisfied): Customer seemed okay after resolution
- 5 (Happy): Customer was pleased with how it was handled

Return ONLY the JSON object, no additional text.`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                let issueData;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        issueData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', content);
                    document.getElementById('issue-description').value = transcript;
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">Transcript added. AI parsing failed.</span>';
                    }
                    return;
                }

                // Fill in the form fields
                if (issueData.customerName) {
                    document.getElementById('issue-customer').value = issueData.customerName;
                }

                if (issueData.phone) {
                    document.getElementById('issue-phone').value = issueData.phone;
                }

                if (issueData.issueType) {
                    const typeSelect = document.getElementById('issue-type');
                    const typeValue = issueData.issueType;
                    for (let option of typeSelect.options) {
                        if (option.value.toLowerCase() === typeValue.toLowerCase()) {
                            typeSelect.value = option.value;
                            break;
                        }
                    }
                }

                if (issueData.store) {
                    const storeSelect = document.getElementById('issue-store');
                    for (let option of storeSelect.options) {
                        if (option.value.toLowerCase().includes(issueData.store.toLowerCase()) ||
                            issueData.store.toLowerCase().includes(option.value.toLowerCase())) {
                            storeSelect.value = option.value;
                            break;
                        }
                    }
                }

                if (issueData.description) {
                    document.getElementById('issue-description').value = issueData.description;
                } else {
                    document.getElementById('issue-description').value = transcript;
                }

                if (issueData.perception) {
                    const perceptionValue = parseInt(issueData.perception);
                    if (perceptionValue >= 1 && perceptionValue <= 5) {
                        selectPerception(perceptionValue);
                    }
                }

                if (statusDiv) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Issue form auto-filled! Review and save.</span>';
                }

            } catch (error) {
                console.error('Error processing issue with AI:', error);
                document.getElementById('issue-description').value = transcript;
                if (statusDiv) {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">AI error. Transcript added to description.</span>`;
                }
            }
        }
        // ========== End Issue Voice Assistant ==========

        function viewRiskNote(noteId) {
            const note = riskNotesState.notes.find(n => n.id === noteId);
            if (!note) return;

            const behaviorType = RISK_BEHAVIOR_TYPES.find(t => t.id === note.behaviorType) || RISK_BEHAVIOR_TYPES[5];
            const level = RISK_LEVELS.find(l => l.id === note.level) || RISK_LEVELS[0];
            const noteDate = new Date(note.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const createdDate = note.createdAt ? new Date(note.createdAt).toLocaleString('en-US') : 'Unknown';

            const modal = document.getElementById('modal');

            // Load photo - prefer Firebase Storage URL, fallback to IndexedDB
            const loadPhotoAndRender = async () => {
                let photoUrl = null;

                // First check if we have a Firebase Storage URL
                if (note.photo) {
                    photoUrl = note.photo;
                } else if (note.hasPhoto) {
                    // Fallback to IndexedDB for older notes
                    try {
                        photoUrl = await getPhotoFromIndexedDB(noteId);
                    } catch (err) {
                        console.error('Error loading photo from IndexedDB:', err);
                    }
                }

                renderNoteModal(modal, note, behaviorType, level, noteDate, createdDate, photoUrl);
            };

            loadPhotoAndRender();
        }

        function renderNoteModal(modal, note, behaviorType, level, noteDate, createdDate, photoUrl) {
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, ${level.color}20 0%, var(--bg-secondary) 100%); border-bottom: 3px solid ${level.color};">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 56px; height: 56px; background: ${behaviorType.color}20; border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${behaviorType.icon}" style="color: ${behaviorType.color}; font-size: 24px;"></i>
                            </div>
                            <div>
                                <h2 style="margin: 0; font-size: 20px;">${behaviorType.label}</h2>
                                <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">
                                    <i class="fas fa-store"></i> ${note.store}
                                </div>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body" style="padding: 24px;">
                        <!-- Risk Level Badge -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <span style="background: ${level.color}20; color: ${level.color}; padding: 8px 20px; border-radius: 25px; font-size: 14px; font-weight: 600;">
                                <i class="fas ${level.icon}" style="font-size: 10px;"></i> ${level.label} Risk
                            </span>
                            <span style="font-size: 13px; color: var(--text-muted);">
                                <i class="fas fa-calendar"></i> ${noteDate}
                            </span>
                        </div>

                        <!-- Description -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Description</label>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; font-size: 14px; line-height: 1.7;">
                                ${note.description || 'No description provided'}
                            </div>
                        </div>

                        ${photoUrl ? `
                            <!-- Photo Evidence -->
                            <div style="margin-bottom: 20px;">
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Photo Evidence</label>
                                <div style="border-radius: 12px; overflow: hidden; background: var(--bg-secondary);">
                                    <img src="${photoUrl}" alt="Evidence" style="width: 100%; max-height: 350px; object-fit: contain; cursor: pointer;" onclick="window.open('${photoUrl}', '_blank')">
                                </div>
                                <div style="text-align: center; margin-top: 8px;">
                                    <span style="font-size: 11px; color: var(--text-muted);">Click image to view full size</span>
                                </div>
                            </div>
                        ` : ''}

                        ${note.managerNote ? `
                            <!-- Manager Note -->
                            <div style="margin-bottom: 20px;">
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Manager Note</label>
                                <div style="background: rgba(245, 158, 11, 0.1); padding: 16px; border-radius: 12px; border-left: 4px solid var(--warning);">
                                    <div style="font-size: 14px; line-height: 1.6;">${note.managerNote}</div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Meta Info -->
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Reported By</div>
                                <div style="font-size: 14px; font-weight: 500;"><i class="fas fa-user" style="margin-right: 8px; color: var(--accent-primary);"></i>${note.reportedBy || 'Anonymous'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Created</div>
                                <div style="font-size: 14px; font-weight: 500;"><i class="fas fa-clock" style="margin-right: 8px; color: var(--accent-primary);"></i>${createdDate}</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; justify-content: space-between;">
                        <button class="btn-secondary danger" onclick="closeModal(); deleteRiskNote('${note.id}');">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="btn-primary" onclick="closeModal()">
                            <i class="fas fa-check"></i> Close
                        </button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        // G FORCE DATA - Must be declared before renderGForce
        var gforceQuotes = [
            // Abundance & Prosperity
            { text: "Abundance is not something we acquire, it is something we tune into.", author: "Wayne Dyer" },
            { text: "The universe is always conspiring in your favor when you raise your vibration.", author: "G Force" },
            { text: "What you think, you create. What you feel, you attract. What you imagine, you become.", author: "Buddha" },
            { text: "Gratitude is the key that unlocks the door to infinite abundance.", author: "Melody Beattie" },
            { text: "You are a living magnet. What you attract into your life is in harmony with your dominant thoughts.", author: "Brian Tracy" },
            { text: "Money is energy, and energy flows where you put your attention.", author: "Deepak Chopra" },
            { text: "Don't look for happiness outside yourself. Abundance begins within.", author: "Rumi" },
            { text: "When you change the way you look at things, the things you look at change.", author: "Wayne Dyer" },
            { text: "The universe returns what you radiate. Be the energy you want to attract.", author: "G Force" },
            { text: "Prosperity is a state of mind before it becomes a physical reality.", author: "Napoleon Hill" },
            { text: "Every moment is an opportunity to align with universal abundance.", author: "G Force" },
            { text: "Your vibrational frequency determines your reality. Choose thoughts of abundance.", author: "G Force" },
            { text: "The universe doesn't give you what you ask for, it gives you what you are.", author: "G Force" },
            { text: "Gratitude transforms what you have into enough, and more.", author: "G Force" },
            { text: "You are not a drop in the ocean, you are the entire ocean in a drop.", author: "Rumi" },
            { text: "Energy flows where your focus goes. Focus on abundance.", author: "Tony Robbins" },
            { text: "Your intention creates your reality. Declare your prosperity now.", author: "G Force" },
            { text: "Success is not the key to happiness. Happiness is the key to success.", author: "Albert Schweitzer" },
            { text: "When you connect with your purpose, the universe supports you.", author: "G Force" },
            { text: "Abundance is your birthright. Claim it with confidence.", author: "Louise Hay" },
            // Self-Love & Inner Peace
            { text: "You yourself, as much as anybody in the entire universe, deserve your love and affection.", author: "Buddha" },
            { text: "The most powerful relationship you will ever have is the relationship with yourself.", author: "Steve Maraboli" },
            { text: "Self-care is not selfish. You cannot serve from an empty vessel.", author: "Eleanor Brown" },
            { text: "Be gentle with yourself. You're doing the best you can.", author: "G Force" },
            { text: "Your value doesn't decrease based on someone's inability to see your worth.", author: "G Force" },
            { text: "The way you speak to yourself matters. Choose words of love and encouragement.", author: "G Force" },
            { text: "Peace comes from within. Do not seek it without.", author: "Buddha" },
            { text: "In the midst of movement and chaos, keep stillness inside of you.", author: "Deepak Chopra" },
            { text: "You are enough just as you are. Each emotion, each moment, each experience.", author: "G Force" },
            { text: "Loving yourself isn't vanity; it's sanity.", author: "Katrina Mayer" },
            // Manifestation & Power
            { text: "Everything you can imagine is real.", author: "Pablo Picasso" },
            { text: "The only limit to our realization of tomorrow is our doubts of today.", author: "Franklin D. Roosevelt" },
            { text: "You have within you right now, everything you need to deal with whatever the world throws at you.", author: "Brian Tracy" },
            { text: "The mind is everything. What you think you become.", author: "Buddha" },
            { text: "Your thoughts are the architects of your destiny.", author: "David O. McKay" },
            { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
            { text: "Whatever the mind can conceive and believe, it can achieve.", author: "Napoleon Hill" },
            { text: "You are the creator of your own reality. Choose wisely.", author: "G Force" },
            { text: "The universe rearranges itself to accommodate your picture of reality.", author: "G Force" },
            { text: "Your imagination is your preview of life's coming attractions.", author: "Albert Einstein" },
            // Growth & Transformation
            { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { text: "Growth is painful. Change is painful. But nothing is as painful as staying stuck.", author: "G Force" },
            { text: "Every adversity carries with it the seed of an equal or greater benefit.", author: "Napoleon Hill" },
            { text: "Your current situation is not your final destination.", author: "G Force" },
            { text: "The butterfly counts not months but moments, and has time enough.", author: "Rabindranath Tagore" },
            { text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.", author: "Ralph Waldo Emerson" },
            { text: "The secret of change is to focus all your energy not on fighting the old, but on building the new.", author: "Socrates" },
            { text: "Every morning brings new potential, but if you dwell on yesterday's misfortunes, you tend to overlook today's opportunities.", author: "G Force" },
            { text: "Stars can't shine without darkness. Your struggles are preparing you for greatness.", author: "G Force" },
            { text: "Trust the timing of your life. Everything is unfolding exactly as it should.", author: "G Force" },
            // Courage & Strength
            { text: "She remembered who she was and the game changed.", author: "Lalah Delia" },
            { text: "You are braver than you believe, stronger than you seem, and smarter than you think.", author: "A.A. Milne" },
            { text: "Courage doesn't always roar. Sometimes it's the quiet voice saying 'I will try again tomorrow.'", author: "Mary Anne Radmacher" },
            { text: "You didn't come this far to only come this far.", author: "G Force" },
            { text: "The woman who doesn't require validation from anyone is the most feared individual on the planet.", author: "Mohadesa Najumi" },
            { text: "Don't be afraid to give up the good to go for the great.", author: "John D. Rockefeller" },
            { text: "Life shrinks or expands in proportion to one's courage.", author: "Ana√Øs Nin" },
            { text: "You have been assigned this mountain to show others it can be moved.", author: "G Force" },
            { text: "The only person you are destined to become is the person you decide to be.", author: "Ralph Waldo Emerson" },
            { text: "Your wings already exist. All you have to do is fly.", author: "G Force" }
        ];

        var gforceAffirmations = [
            // Abundance & Prosperity
            "I am a magnet for infinite abundance and prosperity",
            "The universe is constantly working in my favor",
            "I deserve all the good things coming into my life",
            "My energy attracts wonderful opportunities every day",
            "I trust in the perfect process of the universe",
            "I am aligned with the frequency of abundance",
            "Money flows to me easily and naturally",
            "I am surrounded by love, light, and abundance",
            "My thoughts create my reality and I choose thoughts of abundance",
            "I am an open channel for universal prosperity",
            "Success and abundance are my natural state",
            "Wealth constantly flows into my life from expected and unexpected sources",
            "I am grateful for the abundance that surrounds me",
            "Every dollar I spend comes back to me multiplied",
            "I attract lucrative opportunities effortlessly",
            // Self-Love & Worth
            "I release everything that no longer serves me and embrace the new",
            "My mind is at peace, my heart is calm",
            "I am worthy of receiving everything I desire and more",
            "Every day I become more prosperous in all aspects of my life",
            "My present is full of blessings that I recognize with gratitude",
            "I have everything I need in this moment",
            "Each breath connects me more deeply with my inner peace",
            "I trust in my ability to create the life I desire",
            "I am exactly where I need to be in this moment",
            "I love and accept myself unconditionally",
            "I am deserving of happiness, love, and success",
            "My self-worth is not determined by others' opinions",
            "I honor my needs and take time for self-care",
            "I am complete and whole just as I am",
            "I forgive myself and release all guilt",
            // Power & Manifestation
            "I am the architect of my own destiny",
            "My dreams are manifesting into reality right now",
            "I have the power to create positive change in my life",
            "I am confident in my ability to achieve my goals",
            "Every challenge I face makes me stronger and wiser",
            "I attract the right people and circumstances into my life",
            "My potential is limitless",
            "I transform obstacles into opportunities",
            "I am creating the life of my dreams one day at a time",
            "The universe supports my highest good",
            // Peace & Gratitude
            "I choose peace over worry, love over fear",
            "I am grateful for this beautiful day and all it brings",
            "I release anxiety and embrace calm",
            "Today I choose joy and positivity",
            "I am blessed with an amazing support system",
            "Every experience teaches me something valuable",
            "I radiate positive energy wherever I go",
            "I am at peace with my past and excited for my future",
            "Happiness flows through me naturally",
            "I appreciate the small miracles in everyday life",
            // Strength & Courage
            "I am brave, bold, and unstoppable",
            "I face challenges with courage and determination",
            "My inner strength is greater than any obstacle",
            "I trust myself to make the right decisions",
            "I am resilient and bounce back from setbacks quickly",
            "Fear does not control me; I control my response to fear",
            "I embrace change as an opportunity for growth",
            "I am becoming the best version of myself every day",
            "My voice matters and deserves to be heard",
            "I stand in my power with grace and confidence"
        ];

        var gforcePhilosophies = [
            {
                text: "Self-love is not selfish; it's the foundation of all healthy relationships. When you fill your own cup first, you overflow with love and kindness for others. Remember that caring for yourself allows you to show up fully in the world.",
                tips: [
                    { icon: "üõÅ", text: "Take a 20-minute break today just for you - no phone, no tasks, just pure presence with yourself" },
                    { icon: "üí≠", text: "Write down three things you appreciate about yourself right now, focusing on your inner qualities" },
                    { icon: "üå∏", text: "Practice saying 'no' to something that drains your energy, creating space for what nourishes you" }
                ]
            },
            {
                text: "Your body is a sacred temple that carries you through life. Treat it with reverence and gratitude. Every cell in your being responds to love and care, creating harmony from within that radiates outward.",
                tips: [
                    { icon: "üíß", text: "Drink a full glass of water mindfully, thanking your body for all it does for you each day" },
                    { icon: "üßò", text: "Spend 5 minutes stretching gently, breathing deeply into any areas of tension or discomfort" },
                    { icon: "ü•ó", text: "Choose one meal today to eat slowly and mindfully, savoring each bite with appreciation" }
                ]
            },
            {
                text: "Emotional wellness begins with accepting all your feelings without judgment. Every emotion is a messenger bringing you important information. Welcome them, listen to them, and let them flow through you naturally.",
                tips: [
                    { icon: "üìî", text: "Journal for 10 minutes about what you're feeling right now, without censoring or editing yourself" },
                    { icon: "üéµ", text: "Create a playlist that matches your current mood and let the music help you process your emotions" },
                    { icon: "ü§ó", text: "Give yourself a gentle hug or place your hand on your heart, offering yourself compassion" }
                ]
            },
            {
                text: "Rest is not laziness; it's a sacred act of self-preservation. In a world that glorifies hustle, choosing rest is revolutionary. Your worth is not measured by productivity but by your inherent value as a human being.",
                tips: [
                    { icon: "üò¥", text: "Set a consistent bedtime tonight, creating a calming evening ritual that honors your need for rest" },
                    { icon: "üìµ", text: "Take a digital detox for one hour, allowing your mind to rest from constant stimulation" },
                    { icon: "‚òï", text: "Enjoy a warm beverage slowly, giving yourself permission to simply be without doing" }
                ]
            },
            {
                text: "Gratitude is the fastest path to contentment. What you appreciate, appreciates in value. When you focus on what you have rather than what you lack, abundance becomes your reality.",
                tips: [
                    { icon: "üìù", text: "Write down 5 things you're grateful for right now, including the smallest blessings" },
                    { icon: "üíå", text: "Send a message of appreciation to someone who has positively impacted your life" },
                    { icon: "üåÖ", text: "Start each morning by naming three good things before checking your phone" }
                ]
            },
            {
                text: "Your thoughts shape your reality more than you realize. Every thought is a seed planted in the garden of your mind. Choose to plant flowers of positivity, hope, and possibility rather than weeds of doubt and fear.",
                tips: [
                    { icon: "üß†", text: "Notice negative self-talk today and consciously replace it with a positive alternative" },
                    { icon: "‚ú®", text: "Visualize your ideal day for 5 minutes this morning, feeling the emotions of success" },
                    { icon: "ü™û", text: "Look in the mirror and speak three kind affirmations to yourself out loud" }
                ]
            },
            {
                text: "Boundaries are not walls that keep people out; they are bridges that define where you end and others begin. Setting healthy boundaries is an act of self-respect that teaches others how to treat you.",
                tips: [
                    { icon: "üöß", text: "Identify one area where you need stronger boundaries and commit to honoring it today" },
                    { icon: "üí¨", text: "Practice expressing your needs clearly and calmly without over-explaining or apologizing" },
                    { icon: "üõ°Ô∏è", text: "Remember: 'No' is a complete sentence. You don't owe anyone an explanation for protecting your energy" }
                ]
            },
            {
                text: "Connection with nature is medicine for the soul. In the natural world, you remember that you are part of something greater than yourself. Let the earth ground you and the sky remind you of infinite possibilities.",
                tips: [
                    { icon: "üå≥", text: "Spend 10 minutes outside today, whether it's a walk, sitting in the sun, or tending to plants" },
                    { icon: "üåä", text: "Listen to nature sounds while working or relaxing to bring calm energy into your space" },
                    { icon: "üåª", text: "Bring a piece of nature indoors - a flower, a plant, or even a beautiful stone" }
                ]
            },
            {
                text: "Forgiveness is not about condoning what happened; it's about freeing yourself from carrying the weight of resentment. When you forgive, you release the chains that bind you to the past and step into freedom.",
                tips: [
                    { icon: "üïäÔ∏è", text: "Write a letter of forgiveness to someone who hurt you (you don't need to send it)" },
                    { icon: "üíù", text: "Forgive yourself for one past mistake. Say out loud: 'I release this and move forward with love'" },
                    { icon: "üåà", text: "Recognize that holding onto anger hurts you more than anyone else - choose peace today" }
                ]
            },
            {
                text: "Your intuition is your inner compass, a gift that guides you toward your highest good. In a world full of noise, learning to listen to your inner voice is a superpower. Trust yourself - you know more than you think.",
                tips: [
                    { icon: "üîÆ", text: "Before making a decision today, pause and ask yourself: 'What does my gut tell me?'" },
                    { icon: "üßò‚Äç‚ôÄÔ∏è", text: "Spend 5 minutes in silence, breathing deeply, and notice what thoughts or feelings arise" },
                    { icon: "üìø", text: "Practice trusting a small intuitive nudge today and observe the outcome" }
                ]
            },
            {
                text: "Creativity is not reserved for artists; it is the essence of being human. Every time you solve a problem, cook a meal, or rearrange your space, you are creating. Honor your creative spirit by making time to play.",
                tips: [
                    { icon: "üé®", text: "Do something creative today with no expectation of perfection - doodle, sing, write, dance" },
                    { icon: "üé≠", text: "Try something new that slightly scares you - creativity lives at the edge of comfort" },
                    { icon: "üåà", text: "Give yourself permission to be a beginner at something. Mastery isn't the goal - joy is" }
                ]
            },
            {
                text: "Patience is the art of trusting the timing of your life. Like a seed beneath the soil, growth is happening even when you cannot see it. Have faith that everything is unfolding exactly as it should.",
                tips: [
                    { icon: "üå±", text: "When feeling impatient today, take three deep breaths and say: 'Everything is working out for me'" },
                    { icon: "‚è≥", text: "Reflect on a past situation that felt frustrating but eventually revealed its purpose" },
                    { icon: "ü¶ã", text: "Remember: the caterpillar doesn't know it will become a butterfly. Trust your transformation" }
                ]
            },
            {
                text: "Joy is not something to be pursued; it is something to be allowed. It already exists within you, waiting to be uncovered. Strip away the layers of worry and obligation, and you will find joy has been there all along.",
                tips: [
                    { icon: "üòä", text: "Do one thing today purely because it brings you joy, with no productivity attached" },
                    { icon: "üéâ", text: "Celebrate a small win from this week - no achievement is too small to acknowledge" },
                    { icon: "üíÉ", text: "Move your body in a way that feels good - dance, stretch, walk - and notice how joy follows" }
                ]
            },
            {
                text: "Vulnerability is not weakness; it is the birthplace of connection, creativity, and courage. When you allow yourself to be seen - truly seen - you open the door to authentic relationships and deep fulfillment.",
                tips: [
                    { icon: "üíó", text: "Share something honest with a trusted person today, even if it feels uncomfortable" },
                    { icon: "üé≠", text: "Notice where you wear masks to hide your true self. Ask: 'What would happen if I took it off?'" },
                    { icon: "üå∏", text: "Embrace imperfection today. Done is better than perfect, and real is better than polished" }
                ]
            },
            {
                text: "Abundance is a mindset before it becomes a reality. When you shift from scarcity thinking to abundance thinking, you open yourself to receiving more of everything - love, opportunities, wealth, and happiness.",
                tips: [
                    { icon: "üí∞", text: "Replace 'I can't afford it' with 'How can I afford it?' to open your mind to possibilities" },
                    { icon: "üôè", text: "Express gratitude for your current blessings, no matter how small - this attracts more" },
                    { icon: "üéÅ", text: "Give something away today - generosity signals to the universe that you have plenty to share" }
                ]
            }
        ];

        // G FORCE FUNCTIONALITY
        function renderGForce() {
            const dashboard = document.querySelector('.dashboard');
            const quote = getDailyGForceQuote();
            const affirmations = getDailyGForceAffirmations(5);
            const philosophy = getDailyGForcePhilosophy();

            dashboard.innerHTML = `
                <div class="page-header">
                    <div class="page-header-left">
                        <h2 class="section-title">
                            <i class="fas fa-bolt" style="color: var(--accent-primary);"></i>
                            G Force - Giselle's Daily Motivation
                        </h2>
                        <p class="section-subtitle">${getGForceDate()}</p>
                    </div>
                </div>

                <!-- Quote Card -->
                <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);">
                    <div class="card-body" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ú®</div>
                        <div id="gforce-quote-text" style="font-size: 1.6rem; line-height: 1.7; margin-bottom: 20px; font-weight: 300; color: var(--text-primary);">"${quote.text}"</div>
                        <div id="gforce-quote-author" style="text-align: right; color: var(--accent-primary); font-size: 1.1rem; font-style: italic;">‚Äî ${quote.author}</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                    <!-- Affirmations Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-heart" style="color: #ec4899;"></i>
                                Today's Affirmations
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="gforce-affirmations-page">
                                ${affirmations.map(aff => `
                                    <div style="background: var(--bg-secondary); padding: 14px 18px; border-radius: 10px; margin-bottom: 12px; font-size: 14px; border-left: 4px solid var(--accent-primary); transition: transform 0.2s; cursor: default;" onmouseover="this.style.transform='translateX(6px)'" onmouseout="this.style.transform='translateX(0)'">
                                        <span style="color: var(--success); margin-right: 8px;">‚úì</span> ${aff}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Philosophy Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
                                Self-Care Philosophy
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="gforce-philosophy-page-text" style="font-size: 15px; line-height: 1.8; margin-bottom: 24px; color: var(--text-secondary);">${philosophy.text}</div>
                            <div id="gforce-tips-page">
                                ${philosophy.tips.map(tip => `
                                    <div style="background: var(--bg-secondary); padding: 16px 20px; border-radius: 12px; display: flex; align-items: flex-start; gap: 14px; margin-bottom: 12px; transition: all 0.2s; cursor: default;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="font-size: 1.8rem; flex-shrink: 0;">${tip.icon}</div>
                                        <div style="font-size: 14px; line-height: 1.6;">${tip.text}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Motivational Footer -->
                <div style="text-align: center; margin-top: 32px; padding: 24px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border-radius: 16px;">
                    <div style="font-size: 32px; margin-bottom: 12px;">üåü</div>
                    <div style="font-size: 18px; font-weight: 500; color: var(--text-primary);">Remember: You are capable of amazing things!</div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Take a deep breath and embrace today with gratitude.</div>
                </div>
            `;
        }

        function refreshGForceQuote() {
            const quote = getRandomGForceQuote();
            document.getElementById('gforce-quote-text').textContent = '"' + quote.text + '"';
            document.getElementById('gforce-quote-author').textContent = '‚Äî ' + quote.author;
        }

        function refreshGForceAffirmations() {
            const affirmations = getRandomGForceAffirmations(5);
            const container = document.getElementById('gforce-affirmations-page');
            container.innerHTML = affirmations.map(aff => `
                <div style="background: var(--bg-secondary); padding: 14px 18px; border-radius: 10px; margin-bottom: 12px; font-size: 14px; border-left: 4px solid var(--accent-primary); transition: transform 0.2s; cursor: default;" onmouseover="this.style.transform='translateX(6px)'" onmouseout="this.style.transform='translateX(0)'">
                    <span style="color: var(--success); margin-right: 8px;">‚úì</span> ${aff}
                </div>
            `).join('');
        }

        function refreshGForcePhilosophy() {
            const philosophy = getRandomGForcePhilosophy();
            document.getElementById('gforce-philosophy-page-text').textContent = philosophy.text;
            const tipsContainer = document.getElementById('gforce-tips-page');
            tipsContainer.innerHTML = philosophy.tips.map(tip => `
                <div style="background: var(--bg-secondary); padding: 16px 20px; border-radius: 12px; display: flex; align-items: flex-start; gap: 14px; margin-bottom: 12px; transition: all 0.2s; cursor: default;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="font-size: 1.8rem; flex-shrink: 0;">${tip.icon}</div>
                    <div style="font-size: 14px; line-height: 1.6;">${tip.text}</div>
                </div>
            `).join('');
        }

        // Get day of year for consistent daily content
        function getDayOfYear() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        function getGForceDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return new Date().toLocaleDateString('en-US', options);
        }

        // Daily functions - content changes each day but stays consistent throughout the day
        function getDailyGForceQuote() {
            const dayOfYear = getDayOfYear();
            const index = dayOfYear % gforceQuotes.length;
            return gforceQuotes[index];
        }

        function getDailyGForceAffirmations(count = 5) {
            const dayOfYear = getDayOfYear();
            const result = [];
            for (let i = 0; i < count; i++) {
                const index = (dayOfYear + i * 7) % gforceAffirmations.length;
                result.push(gforceAffirmations[index]);
            }
            return result;
        }

        function getDailyGForcePhilosophy() {
            const dayOfYear = getDayOfYear();
            const index = dayOfYear % gforcePhilosophies.length;
            return gforcePhilosophies[index];
        }

        // Keep random functions for backwards compatibility
        let currentGForceQuoteIndex = -1;
        let currentGForcePhilosophyIndex = -1;

        function getRandomGForceQuote() {
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * gforceQuotes.length);
            } while (newIndex === currentGForceQuoteIndex && gforceQuotes.length > 1);
            currentGForceQuoteIndex = newIndex;
            return gforceQuotes[currentGForceQuoteIndex];
        }

        function getRandomGForceAffirmations(count = 5) {
            const shuffled = [...gforceAffirmations].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }

        function getRandomGForcePhilosophy() {
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * gforcePhilosophies.length);
            } while (newIndex === currentGForcePhilosophyIndex && gforcePhilosophies.length > 1);
            currentGForcePhilosophyIndex = newIndex;
            return gforcePhilosophies[currentGForcePhilosophyIndex];
        }

        function displayGForceQuote(quote) {
            document.getElementById('gforce-quote-text').textContent = `"${quote.text}"`;
            document.getElementById('gforce-quote-author').textContent = `‚Äî ${quote.author}`;
        }

        function displayGForceAffirmations(affirmations) {
            const container = document.getElementById('gforce-affirmations');
            container.innerHTML = affirmations.map(aff =>
                `<div style="background: var(--bg-secondary); padding: 12px 16px; border-radius: 10px; margin-bottom: 10px; font-size: 14px; border-left: 3px solid var(--accent-primary); transition: transform 0.2s; cursor: default;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                    ‚úì ${aff}
                </div>`
            ).join('');
        }

        function displayGForcePhilosophy(philosophy) {
            document.getElementById('gforce-philosophy-text').textContent = philosophy.text;
            const tipsContainer = document.getElementById('gforce-tips');
            tipsContainer.innerHTML = philosophy.tips.map(tip =>
                `<div style="background: var(--bg-secondary); padding: 14px 18px; border-radius: 10px; display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px; transition: all 0.2s; cursor: default;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="font-size: 1.5rem; flex-shrink: 0;">${tip.icon}</div>
                    <div style="font-size: 13px; line-height: 1.5; color: var(--text-secondary);">${tip.text}</div>
                </div>`
            ).join('');
        }

        window.generateGForceQuote = function() {
            displayGForceQuote(getRandomGForceQuote());
        }

        window.generateGForceAffirmations = function() {
            displayGForceAffirmations(getRandomGForceAffirmations(5));
        }

        window.generateGForcePhilosophy = function() {
            displayGForcePhilosophy(getRandomGForcePhilosophy());
        }

        window.openGForceModal = function() {
            document.getElementById('gforce-date').textContent = getGForceDate();
            generateGForceQuote();
            generateGForceAffirmations();
            generateGForcePhilosophy();
            document.getElementById('gforce-modal').classList.add('active');
        }

        window.closeGForceModal = function() {
            document.getElementById('gforce-modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('gforce-modal').addEventListener('mousedown', function(e) {
            if (e.target === this) {
                closeGForceModal();
            }
        });

// =============================================================================
// GCONOMICS - Expense Planner
// =============================================================================

// Expense categories
var GCONOMICS_CATEGORIES = [
    { id: 'food', name: 'Food', icon: 'fa-utensils', color: '#f59e0b' },
    { id: 'home', name: 'Home', icon: 'fa-home', color: '#3b82f6' },
    { id: 'subscriptions', name: 'Subscriptions', icon: 'fa-credit-card', color: '#8b5cf6' },
    { id: 'health', name: 'Health', icon: 'fa-heart-pulse', color: '#ef4444' },
    { id: 'gifts', name: 'Gifts', icon: 'fa-gift', color: '#ec4899' },
    { id: 'other', name: 'Other', icon: 'fa-ellipsis', color: '#6b7280' }
];

// Gconomics state
var gconomicsState = {
    expenses: JSON.parse(localStorage.getItem('gconomicsExpenses')) || [],
    currentMonth: '2025-12', // December 2025
    selectedCategory: 'all',
    editingExpenseId: null
};

// Save expenses to localStorage
function saveGconomicsExpenses() {
    const expensesWithTimestamp = gconomicsState.expenses.map(exp => ({
        ...exp,
        updatedAt: exp.updatedAt || new Date().toISOString()
    }));
    localStorage.setItem('gconomicsExpenses', JSON.stringify(expensesWithTimestamp));
}

// Initialize Gconomics Firebase sync
async function initializeGconomicsFirebase(userId, userEmail) {
    if (!window.gconomicsFirebase) {
        console.warn('Gconomics Firebase module not loaded');
        return false;
    }

    // Guard against gconomicsState not yet initialized
    if (typeof gconomicsState === 'undefined' || !gconomicsState) {
        console.warn('Gconomics state not yet initialized');
        return false;
    }

    try {
        const initialized = await window.gconomicsFirebase.initialize();
        if (!initialized) return false;

        window.gconomicsFirebase.setCurrentUser(userId, userEmail);

        // Sync existing local expenses to Firebase
        if (gconomicsState.expenses && gconomicsState.expenses.length > 0) {
            await window.gconomicsFirebase.syncExpensesToFirestore(gconomicsState.expenses);
        }

        return true;
    } catch (error) {
        console.error('Error initializing Gconomics Firebase:', error);
        return false;
    }
}

// Load Gconomics expenses from Firebase
async function loadGconomicsFromFirebase() {
    if (!window.gconomicsFirebase) {
        console.warn('Gconomics Firebase module not available');
        return false;
    }

    // Guard against gconomicsState not yet initialized
    if (typeof gconomicsState === 'undefined' || !gconomicsState) {
        console.warn('Gconomics state not yet initialized');
        return false;
    }

    // Initialize Firebase if not already done
    if (!window.gconomicsFirebase.isInitialized) {
        const initialized = await window.gconomicsFirebase.initialize();
        if (!initialized) {
            console.warn('Failed to initialize Gconomics Firebase');
            return false;
        }
    }

    try {
        const firebaseExpenses = await window.gconomicsFirebase.loadExpensesFromFirestore();

        if (firebaseExpenses.length === 0) {
            console.log('No expenses found in Firebase');
            return true;
        }

        // Create a map of existing local expenses by ID
        const localMap = new Map((gconomicsState.expenses || []).map(e => [String(e.id), e]));

        // Merge Firebase expenses - Firebase takes priority for existing items
        firebaseExpenses.forEach(fbExp => {
            const expId = String(fbExp.id);
            const localExp = localMap.get(expId);

            if (!localExp) {
                // New expense from Firebase
                gconomicsState.expenses.push(fbExp);
            } else {
                // Update existing if Firebase is newer
                const fbDate = new Date(fbExp.updatedAt || fbExp.syncedAt?.toDate?.() || 0);
                const localDate = new Date(localExp.updatedAt || 0);
                if (fbDate > localDate) {
                    const index = gconomicsState.expenses.findIndex(e => String(e.id) === expId);
                    if (index > -1) {
                        gconomicsState.expenses[index] = { ...localExp, ...fbExp };
                    }
                }
            }
        });

        saveGconomicsExpenses();
        return true;
    } catch (error) {
        console.error('Error loading expenses from Firebase:', error);
        return false;
    }
}

// Get expense statistics from Firebase
async function getGconomicsStatsFromFirebase(monthString) {
    if (!window.gconomicsFirebase || !window.gconomicsFirebase.isInitialized) {
        console.warn('Gconomics Firebase not initialized');
        return null;
    }

    try {
        const stats = await window.gconomicsFirebase.getMonthlyStats(monthString);
        return stats;
    } catch (error) {
        console.error('Error getting Firebase stats:', error);
        return null;
    }
}

// Get expenses for current month
function getMonthlyExpenses(month = gconomicsState.currentMonth) {
    return gconomicsState.expenses.filter(exp => exp.date.startsWith(month));
}

// Get total for current month
function getMonthlyTotal(month = gconomicsState.currentMonth) {
    return getMonthlyExpenses(month).reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
}

// Get total by category for current month
function getCategoryTotals(month = gconomicsState.currentMonth) {
    const expenses = getMonthlyExpenses(month);
    const totals = {};
    GCONOMICS_CATEGORIES.forEach(cat => {
        totals[cat.id] = expenses
            .filter(exp => exp.category === cat.id)
            .reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
    });
    return totals;
}

// Get available months from expenses
function getAvailableMonths() {
    const months = new Set();
    gconomicsState.expenses.forEach(exp => {
        months.add(exp.date.slice(0, 7));
    });
    // Add current month if not present
    months.add(gconomicsState.currentMonth);
    return Array.from(months).sort().reverse();
}

// Render Gconomics page
async function renderGconomics() {
    const dashboard = document.querySelector('.dashboard');

    // Ensure Firebase is initialized for Gconomics
    if (window.gconomicsFirebase && !window.gconomicsFirebase.currentUser) {
        const user = JSON.parse(localStorage.getItem('ascendance_user') || '{}');
        if (user && (user.userId || user.id)) {
            try {
                await initializeGconomicsFirebase(user.userId || user.id, user.email);
                // Load expenses from Firebase after initialization
                await loadGconomicsFromFirebase();
            } catch (error) {
                console.warn('Failed to initialize Gconomics Firebase:', error);
            }
        }
    }

    const monthlyExpenses = getMonthlyExpenses();
    const monthlyTotal = getMonthlyTotal();
    const categoryTotals = getCategoryTotals();
    const availableMonths = getAvailableMonths();

    // Filter expenses by category if selected
    let displayExpenses = monthlyExpenses;
    if (gconomicsState.selectedCategory !== 'all') {
        displayExpenses = monthlyExpenses.filter(exp => exp.category === gconomicsState.selectedCategory);
    }

    // Sort by date descending
    displayExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

    const currentMonthName = new Date(gconomicsState.currentMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    dashboard.innerHTML = `
        <div class="page-header gconomics-page-header">
            <div class="page-header-left">
                <h2 class="section-title">
                    <i class="fas fa-wallet" style="color: var(--accent-primary);"></i>
                    Gconomics
                </h2>
                <p class="section-subtitle">Personal Expense Tracker</p>
            </div>
            <div class="page-header-right" style="display: flex; gap: 12px; align-items: center;">
                <select class="form-input" style="width: 160px;" onchange="changeGconomicsMonth(this.value)">
                    ${availableMonths.map(month => {
                        const [year, monthNum] = month.split('-');
                        const date = new Date(parseInt(year), parseInt(monthNum) - 1, 1);
                        const displayMonth = date.toLocaleDateString('en-US', { month: 'short' });
                        const displayYear = date.getFullYear();
                        const label = `${displayMonth} ${displayYear}`;
                        return `<option value="${month}" ${month === gconomicsState.currentMonth ? 'selected' : ''}>${label}</option>`;
                    }).join('')}
                </select>
                <button class="btn-primary floating-add-btn" onclick="openAddExpenseModal()">
                    <i class="fas fa-plus"></i> New Expense
                </button>
            </div>
        </div>

        <!-- Monthly Summary Card -->
        <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%); color: white; overflow: hidden; position: relative;">
            <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
            <div class="card-body" style="padding: 32px; position: relative; z-index: 1;">
                <div class="gconomics-summary-content" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 24px;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">${currentMonthName}</div>
                        <div style="font-size: 42px; font-weight: 700;">${formatCurrencyGconomics(monthlyTotal)}</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 8px;">${displayExpenses.length} expense${displayExpenses.length !== 1 ? 's' : ''} this month</div>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        ${GCONOMICS_CATEGORIES.slice(0, 4).map(cat => {
                            const amount = categoryTotals[cat.id] || 0;
                            if (amount === 0) return '';
                            return `
                                <div style="background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 12px; text-align: center; min-width: 80px;">
                                    <div style="font-size: 20px; margin-bottom: 4px;"><i class="fas ${cat.icon}"></i></div>
                                    <div style="font-size: 14px; font-weight: 600;">${formatCurrencyGconomics(amount)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    Spending Breakdown
                </h3>
            </div>
            <div class="card-body">
                ${monthlyTotal === 0 ? `
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <i class="fas fa-chart-pie" style="font-size: 40px; opacity: 0.3; margin-bottom: 12px; display: block;"></i>
                        <p>No expenses to display</p>
                    </div>
                ` : `
                    <div class="gconomics-chart-grid" style="display: grid; grid-template-columns: 200px 1fr; gap: 32px; align-items: center;">
                        <!-- Donut Chart -->
                        <div style="position: relative; width: 180px; height: 180px; margin: 0 auto;">
                            <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                ${renderDonutChart(categoryTotals, monthlyTotal)}
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 10px; color: var(--text-muted);">Total</div>
                                <div style="font-size: 14px; font-weight: 700;">${formatCurrencyGconomics(monthlyTotal)}</div>
                            </div>
                        </div>
                        <!-- Legend with Bar Chart -->
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${GCONOMICS_CATEGORIES.map(cat => {
                                const amount = categoryTotals[cat.id] || 0;
                                if (amount === 0) return '';
                                const percentage = ((amount / monthlyTotal) * 100).toFixed(1);
                                return `
                                    <div style="cursor: pointer;" onclick="filterGconomicsByCategory('${cat.id}')">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="width: 10px; height: 10px; border-radius: 2px; background: ${cat.color};"></div>
                                                <span style="font-size: 13px; font-weight: 500;">${cat.name}</span>
                                            </div>
                                            <div style="font-size: 13px;">
                                                <span style="font-weight: 600;">${formatCurrencyGconomics(amount)}</span>
                                                <span style="color: var(--text-muted); margin-left: 8px;">${percentage}%</span>
                                            </div>
                                        </div>
                                        <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                            <div style="height: 100%; width: ${percentage}%; background: ${cat.color}; border-radius: 4px; transition: width 0.3s;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `}
            </div>
        </div>

        <!-- Category Filter Pills -->
        <div class="gconomics-category-pills" style="display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap;">
            <button onclick="filterGconomicsByCategory('all')" style="padding: 10px 20px; font-family: Outfit; border-radius: 25px; border: 2px solid ${gconomicsState.selectedCategory === 'all' ? 'var(--accent-primary)' : 'var(--border-color)'}; background: ${gconomicsState.selectedCategory === 'all' ? 'var(--accent-primary)' : 'var(--bg-secondary)'}; color: ${gconomicsState.selectedCategory === 'all' ? 'white' : 'var(--text-primary)'}; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                <i class="fas fa-th-large"></i> All
            </button>
            ${GCONOMICS_CATEGORIES.map(cat => `
                <button onclick="filterGconomicsByCategory('${cat.id}')" style="font-family: Outfit; padding: 10px 20px; border-radius: 25px; border: 2px solid ${gconomicsState.selectedCategory === cat.id ? cat.color : 'var(--border-color)'}; background: ${gconomicsState.selectedCategory === cat.id ? cat.color : 'var(--bg-secondary)'}; color: ${gconomicsState.selectedCategory === cat.id ? 'white' : 'var(--text-primary)'}; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                    <i class="fas ${cat.icon}"></i> ${cat.name}
                </button>
            `).join('')}
        </div>

        <!-- Expenses Grid -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-receipt"></i>
                    Recent Expenses
                    ${gconomicsState.selectedCategory !== 'all' ? `<span style="background: var(--accent-primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 8px;">${GCONOMICS_CATEGORIES.find(c => c.id === gconomicsState.selectedCategory)?.name}</span>` : ''}
                </h3>
            </div>
            <div class="card-body">
                ${displayExpenses.length === 0 ? `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <i class="fas fa-receipt" style="font-size: 56px; margin-bottom: 20px; display: block; opacity: 0.3;"></i>
                        <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No expenses yet</div>
                        <div style="font-size: 14px;">Click "New Expense" to start tracking</div>
                    </div>
                ` : `
                    <div class="gconomics-expenses-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                        ${displayExpenses.map(expense => {
                            const category = GCONOMICS_CATEGORIES.find(c => c.id === expense.category) || GCONOMICS_CATEGORIES[5];
                            const expenseDate = new Date(expense.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            return `
                                <div style="background: var(--bg-secondary); border-radius: 16px; padding: 20px; border-left: 4px solid ${category.color}; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" onclick="viewExpenseDetails('${expense.id}')">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 44px; height: 44px; background: ${category.color}20; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas ${category.icon}" style="color: ${category.color}; font-size: 18px;"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 2px;">${expense.description}</div>
                                                <div style="font-size: 12px; color: var(--text-muted);">${expenseDate}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 18px; font-weight: 700; color: ${category.color};">${formatCurrencyGconomics(expense.amount)}</div>
                                        </div>
                                    </div>
                                    ${expense.photo ? `
                                        <div style="margin-top: 12px; border-radius: 10px; overflow: hidden; max-height: 120px;">
                                            <img src="${expense.photo}" alt="Receipt" style="width: 100%; height: 120px; object-fit: cover;">
                                        </div>
                                    ` : ''}
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <span style="background: ${category.color}20; color: ${category.color}; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600;">${category.name}</span>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-icon" onclick="event.stopPropagation(); editExpense('${expense.id}')" title="Edit" style="width: 32px; height: 32px;">
                                                <i class="fas fa-pen" style="font-size: 12px;"></i>
                                            </button>
                                            <button class="btn-icon danger" onclick="event.stopPropagation(); deleteExpense('${expense.id}')" title="Delete" style="width: 32px; height: 32px;">
                                                <i class="fas fa-trash" style="font-size: 12px;"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
        </div>

        <!-- Add/Edit Expense Modal -->
        <div class="modal" id="expenseModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 id="expenseModalTitle">
                        <i class="fas fa-plus-circle"></i> Add Expense
                    </h2>
                    <button class="modal-close" onclick="closeExpenseModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- AI Scan Section -->
                    <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-wand-magic-sparkles" style="color: white; font-size: 14px;"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">AI Receipt Scanner</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Auto-fill from receipt photo</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <input type="file" id="gconomicsAiPhoto" accept="image/*" style="display: none;" onchange="scanGconomicsReceiptWithAI(this)">
                                <button type="button" onclick="document.getElementById('gconomicsAiPhoto').click()" style="padding: 10px 16px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; color: white; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(139,92,246,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                                    <i class="fas fa-camera"></i> Scan Receipt
                                </button>
                            </div>
                        </div>
                        <div id="gconomics-ai-status" style="display: none; margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px;"></div>
                    </div>

                    <form id="expenseForm" onsubmit="saveExpense(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseDate">Date</label>
                                <input type="date" id="expenseDate" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="expenseAmount">Amount</label>
                                <input type="number" id="expenseAmount" class="form-input" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="expenseDescription">Description</label>
                            <input type="text" id="expenseDescription" class="form-input" placeholder="What did you spend on?">
                        </div>
                        <div class="form-group">
                            <label for="expenseCategory">Category</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;" id="categorySelector">
                                ${GCONOMICS_CATEGORIES.map(cat => `
                                    <button type="button" class="category-select-btn" data-category="${cat.id}" onclick="selectExpenseCategory('${cat.id}')" style="padding: 14px 10px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s; text-align: center;">
                                        <div style="font-size: 20px; margin-bottom: 4px; color: ${cat.color};"><i class="fas ${cat.icon}"></i></div>
                                        <div style="font-family: Outfit; font-size: 11px; font-weight: 500;">${cat.name}</div>
                                    </button>
                                `).join('')}
                            </div>
                            <input type="hidden" id="expenseCategory" value="">
                        </div>
                        <div class="form-group">
                            <label>Receipt Photo</label>
                            <div style="border: 2px dashed var(--border-color); border-radius: 12px; padding: 20px; text-align: center; background: var(--bg-hover);">
                                <input type="file" id="expensePhoto" accept="image/*" onchange="previewExpensePhoto(this)" style="display: none;">
                                <div id="expense-photo-preview" style="display: none; margin-bottom: 12px;">
                                    <img id="expense-photo-img" style="max-width: 100%; max-height: 150px; border-radius: 8px; object-fit: cover;">
                                </div>
                                <button type="button" class="btn-secondary" onclick="document.getElementById('expensePhoto').click()" style="margin: 0;">
                                    <i class="fas fa-camera"></i> Upload Receipt
                                </button>
                                <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 12px;">Take a photo of your receipt (optional)</p>
                            </div>
                        </div>
                        <div id="expenseMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeExpenseModal()">Cancel</button>
                    <button type="submit" form="expenseForm" class="btn-primary">
                        <i class="fas fa-check"></i> Save Expense
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Preview expense photo
function previewExpensePhoto(input) {
    const preview = document.getElementById('expense-photo-preview');
    const img = document.getElementById('expense-photo-img');

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}

// Select expense category
function selectExpenseCategory(categoryId) {
    document.getElementById('expenseCategory').value = categoryId;
    const buttons = document.querySelectorAll('.category-select-btn');
    buttons.forEach(btn => {
        const cat = GCONOMICS_CATEGORIES.find(c => c.id === btn.dataset.category);
        if (btn.dataset.category === categoryId) {
            btn.style.borderColor = cat.color;
            btn.style.background = cat.color + '20';
        } else {
            btn.style.borderColor = 'var(--border-color)';
            btn.style.background = 'var(--bg-secondary)';
        }
    });
}

// View expense details
function viewExpenseDetails(expenseId) {
    const expense = gconomicsState.expenses.find(e => e.id === expenseId);
    if (!expense) return;

    const category = GCONOMICS_CATEGORIES.find(c => c.id === expense.category) || GCONOMICS_CATEGORIES[5];
    const expenseDate = new Date(expense.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    modalContent.innerHTML = `
        <div class="modal-header">
            <h2 style="display: flex; align-items: center; gap: 10px;">
                <i class="fas ${category.icon}" style="color: ${category.color};"></i>
                Expense Details
            </h2>
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            ${expense.photo ? `
                <div style="margin-bottom: 20px; border-radius: 12px; overflow: hidden;">
                    <img src="${expense.photo}" alt="Receipt" style="width: 100%; max-height: 250px; object-fit: cover; cursor: pointer;" onclick="window.open('${expense.photo}', '_blank')">
                </div>
            ` : ''}
            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 32px; font-weight: 700; color: ${category.color}; margin-bottom: 8px;">${formatCurrencyGconomics(expense.amount)}</div>
                <div style="font-size: 18px; font-weight: 500; margin-bottom: 4px;">${expense.description}</div>
                <div style="font-size: 14px; color: var(--text-muted);">${expenseDate}</div>
            </div>
            <div style="display: flex; gap: 12px;">
                <span style="background: ${category.color}20; color: ${category.color}; padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600;">
                    <i class="fas ${category.icon}"></i> ${category.name}
                </span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal(); editExpense('${expense.id}');">
                <i class="fas fa-pen"></i> Edit
            </button>
            <button class="btn-primary" onclick="closeModal();">
                <i class="fas fa-check"></i> Done
            </button>
        </div>
    `;
    modal.classList.add('active');
}

// Render donut chart SVG
function renderDonutChart(categoryTotals, total) {
    if (total === 0) return '';

    let accumulated = 0;
    return GCONOMICS_CATEGORIES.map(cat => {
        const amount = categoryTotals[cat.id] || 0;
        if (amount === 0) return '';
        const percentage = (amount / total) * 100;
        const dashArray = percentage + ' ' + (100 - percentage);
        const dashOffset = -accumulated;
        accumulated += percentage;
        return `<circle cx="18" cy="18" r="15.9" fill="none" stroke="${cat.color}" stroke-width="3.5" stroke-dasharray="${dashArray}" stroke-dashoffset="${dashOffset}" />`;
    }).join('');
}

// Render simple bar chart
function renderGconomicsChart(categoryTotals, total) {
    if (total === 0) {
        return '<p class="chart-empty">No expenses to display</p>';
    }

    return `
        <div class="gconomics-bar-chart">
            ${GCONOMICS_CATEGORIES.map(cat => {
                const amount = categoryTotals[cat.id] || 0;
                const percentage = total > 0 ? (amount / total * 100) : 0;
                if (amount === 0) return '';
                return `
                    <div class="chart-bar-item">
                        <div class="chart-bar-header">
                            <span class="chart-bar-label">
                                <i class="fas ${cat.icon}" style="color: ${cat.color};"></i>
                                ${cat.name}
                            </span>
                            <span class="chart-bar-value">${percentage.toFixed(0)}%</span>
                        </div>
                        <div class="chart-bar-track">
                            <div class="chart-bar-fill" style="width: ${percentage}%; background: ${cat.color};"></div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// Format currency
function formatCurrencyGconomics(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

// Filter by category
function filterGconomicsByCategory(categoryId) {
    gconomicsState.selectedCategory = categoryId;
    renderGconomics();
}

// Change month
function changeGconomicsMonth(month) {
    gconomicsState.currentMonth = month;
    gconomicsState.selectedCategory = 'all';
    renderGconomics();
}

// Open add expense modal
function openAddExpenseModal() {
    gconomicsState.editingExpenseId = null;
    document.getElementById('expenseModalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add Expense';
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('expenseMessage').style.display = 'none';
    // Reset AI status
    const aiStatus = document.getElementById('gconomics-ai-status');
    if (aiStatus) {
        aiStatus.style.display = 'none';
        aiStatus.innerHTML = '';
    }
    // Reset category selection
    document.querySelectorAll('.category-select-btn').forEach(btn => {
        btn.style.borderColor = 'var(--border-color)';
        btn.style.background = 'var(--bg-secondary)';
    });
    // Reset photo preview
    const preview = document.getElementById('expense-photo-preview');
    if (preview) preview.style.display = 'none';
    document.getElementById('expenseModal').classList.add('active');
}

// Scan receipt with AI for Gconomics
async function scanGconomicsReceiptWithAI(input) {
    if (!input.files || !input.files[0]) return;

    const statusDiv = document.getElementById('gconomics-ai-status');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #8b5cf6;"></i> <span style="color: var(--text-primary);">Analyzing receipt with AI...</span>';

    try {
        // Check for API key
        const apiKey = getOpenAIKey();
        if (!apiKey) {
            statusDiv.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">Please configure your OpenAI API key in Project Analytics > Settings</span>';
            return;
        }

        // Read the file as base64
        const file = input.files[0];
        const base64Image = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        // Also set the photo preview
        const previewDiv = document.getElementById('expense-photo-preview');
        const previewImg = document.getElementById('expense-photo-img');
        if (previewDiv && previewImg) {
            previewImg.src = base64Image;
            previewDiv.style.display = 'block';
        }

        // Copy the file to the main photo input for saving
        const mainPhotoInput = document.getElementById('expensePhoto');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        mainPhotoInput.files = dataTransfer.files;

        // Call OpenAI API
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                max_tokens: 1024,
                messages: [
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'image_url',
                                image_url: {
                                    url: base64Image
                                }
                            },
                            {
                                type: 'text',
                                text: `Analyze this receipt/expense image and extract the following information. Return ONLY a JSON object with these fields (use null for any field you cannot find):

{
    "total": "the total amount as a number (no currency symbols)",
    "date": "the date in YYYY-MM-DD format",
    "description": "a brief description of what was purchased (store name + main items)",
    "category": "one of: food, transport, shopping, entertainment, bills, other"
}

Category guidelines:
- food: restaurants, groceries, coffee shops, food delivery
- transport: gas, uber, parking, public transit
- shopping: clothes, electronics, personal items
- entertainment: movies, games, subscriptions, events
- bills: utilities, phone, internet, insurance
- other: anything that doesn't fit above

Return ONLY the JSON object, no additional text.`
                            }
                        ]
                    }
                ]
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'API request failed');
        }

        const data = await response.json();
        const content = data.choices[0].message.content;

        // Parse the JSON response
        let receiptData;
        try {
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                receiptData = JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('No JSON found in response');
            }
        } catch (parseError) {
            console.error('Error parsing AI response:', content);
            throw new Error('Could not parse receipt data from AI response');
        }

        // Fill in the form fields
        if (receiptData.total) {
            const amount = parseFloat(receiptData.total.toString().replace(/[^0-9.]/g, ''));
            if (!isNaN(amount)) {
                document.getElementById('expenseAmount').value = amount.toFixed(2);
            }
        }

        if (receiptData.date) {
            document.getElementById('expenseDate').value = receiptData.date;
        }

        if (receiptData.description) {
            document.getElementById('expenseDescription').value = receiptData.description;
        }

        if (receiptData.category) {
            const categoryId = receiptData.category.toLowerCase();
            // Map AI categories to Gconomics categories
            const categoryMap = {
                'food': 'food',
                'transport': 'transport',
                'shopping': 'shopping',
                'entertainment': 'entertainment',
                'bills': 'bills',
                'other': 'other'
            };
            const mappedCategory = categoryMap[categoryId] || 'other';
            selectExpenseCategory(mappedCategory);
        }

        // Show success message
        statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Receipt scanned successfully! Review and save.</span>';

    } catch (error) {
        console.error('Error scanning receipt with AI:', error);
        statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Error: ${error.message}</span>`;
    }

    // Clear the file input for next use
    input.value = '';
}

// Close expense modal
function closeExpenseModal(forceClose = false) {
    // Reset form protection before closing
    if (typeof formProtectionManager !== 'undefined') {
        formProtectionManager.resetProtection();
    }
    document.getElementById('expenseModal').classList.remove('active');
    gconomicsState.editingExpenseId = null;
}

// Edit expense
function editExpense(expenseId) {
    const expense = gconomicsState.expenses.find(e => e.id === expenseId);
    if (!expense) return;

    gconomicsState.editingExpenseId = expenseId;
    document.getElementById('expenseModalTitle').innerHTML = '<i class="fas fa-pen"></i> Edit Expense';
    document.getElementById('expenseDate').value = expense.date;
    document.getElementById('expenseDescription').value = expense.description;
    document.getElementById('expenseCategory').value = expense.category;
    document.getElementById('expenseAmount').value = expense.amount;
    document.getElementById('expenseMessage').style.display = 'none';
    document.getElementById('expenseModal').classList.add('active');
}

// Delete expense
function deleteExpense(expenseId) {
    showConfirmModal({
        title: 'Delete Expense',
        message: 'Are you sure you want to delete this expense? This action cannot be undone.',
        confirmText: 'Delete',
        type: 'danger',
        onConfirm: () => {
            gconomicsState.expenses = gconomicsState.expenses.filter(e => e.id !== expenseId);
            saveGconomicsExpenses();

            // Delete from Firebase if available
            if (window.gconomicsFirebase && window.gconomicsFirebase.isInitialized && window.gconomicsFirebase.currentUser) {
                window.gconomicsFirebase.deleteExpenseFromFirestore(expenseId).catch(error => {
                    console.warn('Expense deleted locally but not from Firebase:', error);
                });
            } else if (window.gconomicsFirebase && !window.gconomicsFirebase.currentUser) {
                // Try to initialize with current user if available
                const user = JSON.parse(localStorage.getItem('ascendance_user') || '{}');
                if (user && (user.userId || user.id)) {
                    initializeGconomicsFirebase(user.userId || user.id, user.email).then(() => {
                        window.gconomicsFirebase.deleteExpenseFromFirestore(expenseId).catch(error => {
                            console.warn('Expense deleted locally but not from Firebase:', error);
                        });
                    });
                }
            }

            renderGconomics();
        }
    });
}

// Save expense
function saveExpense(event) {
    event.preventDefault();
    console.log('saveExpense called');

    const date = document.getElementById('expenseDate').value || new Date().toISOString().split('T')[0];
    const description = document.getElementById('expenseDescription').value.trim();
    const category = document.getElementById('expenseCategory').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
    const photoInput = document.getElementById('expensePhoto');

    // Validation
    const messageDiv = document.getElementById('expenseMessage');
    messageDiv.style.display = 'none';

    console.log('Form values:', { date, description, category, amount });

    if (!date) {
        messageDiv.style.display = 'block';
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'Please select a date';
        return;
    }

    if (!description) {
        messageDiv.style.display = 'block';
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'Please enter a description';
        return;
    }

    if (!category) {
        messageDiv.style.display = 'block';
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'Please select a category';
        return;
    }

    if (amount <= 0) {
        messageDiv.style.display = 'block';
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'Please enter a valid amount';
        return;
    }

    console.log('Validation passed, processing photo...');

    // Get photo if uploaded
    if (photoInput && photoInput.files && photoInput.files[0]) {
        console.log('Photo file found, reading...');
        const reader = new FileReader();
        reader.onerror = function(e) {
            console.error('FileReader error:', e);
            saveExpenseWithPhoto(date, description, category, amount, null);
        };
        reader.onload = function(e) {
            console.log('Photo read complete');
            const photoData = e.target.result;
            // Call saveExpenseWithPhoto without awaiting
            saveExpenseWithPhoto(date, description, category, amount, photoData);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        console.log('No photo, saving without image');
        // Check if editing and preserve existing photo
        let existingPhoto = null;
        if (gconomicsState.editingExpenseId) {
            const existing = gconomicsState.expenses.find(e => e.id === gconomicsState.editingExpenseId);
            if (existing) existingPhoto = existing.photo;
        }
        saveExpenseWithPhoto(date, description, category, amount, existingPhoto);
    }
}

async function saveExpenseWithPhoto(date, description, category, amount, photo) {
    // Show saving indicator
    const saveBtn = document.querySelector('#expenseForm button[type="submit"]');
    const originalBtnText = saveBtn ? saveBtn.innerHTML : '';
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    }

    let photoUrl = photo;
    let photoPath = null;

    try {
        console.log('Entering saveExpenseWithPhoto try block');
        
        // Don't wait for photo operations - do them in background
        if (photo && photo.startsWith('data:image')) {
            console.log('Photo found, will process in background');
            // Fire and forget photo upload
            uploadExpensePhotoAsync(photo, gconomicsState.editingExpenseId || Date.now().toString());
        }

        // Create or update expense object
        let expenseToSync = null;

        if (gconomicsState.editingExpenseId) {
            // Update existing expense
            console.log('Updating existing expense');
            const index = gconomicsState.expenses.findIndex(e => e.id === gconomicsState.editingExpenseId);
            if (index > -1) {
                gconomicsState.expenses[index] = {
                    ...gconomicsState.expenses[index],
                    date,
                    description: description || 'Expense',
                    category: category || 'other',
                    amount,
                    photo: photo,
                    photoPath: photoPath || gconomicsState.expenses[index].photoPath,
                    updatedAt: new Date().toISOString()
                };
                expenseToSync = gconomicsState.expenses[index];
                console.log('Updated expense:', expenseToSync.id);
            }
        } else {
            // Add new expense
            console.log('Creating new expense');
            const newExpense = {
                id: Date.now().toString(),
                date,
                description: description || 'Expense',
                category: category || 'other',
                amount,
                photo: photo,
                photoPath: photoPath,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            gconomicsState.expenses.push(newExpense);
            expenseToSync = newExpense;
            console.log('New expense created:', newExpense.id);
        }

        // Save to localStorage immediately
        saveGconomicsExpenses();

        // Close modal and refresh UI immediately (don't wait for Firebase)
        closeExpenseModal();
        
        // Switch to the month of the expense if different
        const expenseMonth = date.slice(0, 7);
        if (expenseMonth !== gconomicsState.currentMonth) {
            gconomicsState.currentMonth = expenseMonth;
        }

        renderGconomics();

        // Show success message
        showNotification('Expense saved successfully', 'success');

        // Now sync to Firebase in background (don't wait)
        console.log('Starting background Firebase sync...');
        if (expenseToSync) {
            syncExpenseToFirebaseAsync(expenseToSync).catch(err => {
                console.warn('Firebase sync failed:', err);
            });
        }

    } catch (error) {
        console.error('Error saving expense:', error);
        const messageDiv = document.getElementById('expenseMessage');
        if (messageDiv) {
            messageDiv.style.display = 'block';
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = 'Error saving expense: ' + error.message;
        }
    } finally {
        // Restore button state
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText || '<i class="fas fa-check"></i> Save Expense';
        }
    }
}

/**
 * Upload expense photo to Firebase Storage (async, non-blocking)
 */
async function uploadExpensePhotoAsync(photoData, expenseId) {
    try {
        if (typeof firebaseStorageHelper === 'undefined') {
            console.warn('Firebase Storage Helper not available');
            return null;
        }

        if (!firebaseStorageHelper.isInitialized) {
            console.log('Initializing Firebase Storage Helper...');
            firebaseStorageHelper.initialize();
        }

        if (!firebaseStorageHelper.storage) {
            console.error('Firebase Storage not available');
            return null;
        }

        const uploadId = expenseId || Date.now().toString();
        console.log('Starting photo upload for expense:', uploadId);

        const uploadResult = await firebaseStorageHelper.uploadImage(
            photoData,
            'expenses/receipts',
            uploadId,
            500,
            false // Don't show overlay since we already closed the modal
        );
        
        return uploadResult;
    } catch (error) {
        console.error('‚ùå Error uploading expense photo to Storage:', error);
        console.error('Error details:', error.message);
        return null;
    }
}

/**
 * Sync expense to Firebase Firestore (async, non-blocking)
 */
async function syncExpenseToFirebaseAsync(expenseToSync) {
    try {
        if (typeof window.gconomicsFirebase === 'undefined' || !window.gconomicsFirebase) {
            console.warn('Gconomics Firebase not available');
            return false;
        }

        // Initialize Firebase if needed
        if (!window.gconomicsFirebase.isInitialized) {
            console.log('Initializing Gconomics Firebase...');
            const initialized = await window.gconomicsFirebase.initialize();
            if (!initialized) {
                console.error('Failed to initialize Gconomics Firebase');
                return false;
            }
        }

        // Set current user if not set
        if (!window.gconomicsFirebase.currentUser) {
            const user = JSON.parse(localStorage.getItem('ascendance_user') || '{}');
            if (user && (user.userId || user.id)) {
                window.gconomicsFirebase.setCurrentUser(user.userId || user.id, user.email);
            } else {
                console.warn('No user found in localStorage');
                return false;
            }
        }

        // Sync to Firestore
        if (window.gconomicsFirebase.isInitialized && expenseToSync) {
            const success = await window.gconomicsFirebase.saveExpenseToFirestore(expenseToSync);
            if (success) {
                return true;
            } else {
                console.warn('Firestore sync returned false');
                return false;
            }
        }
    } catch (error) {
        console.error('Error syncing to Firebase:', error);
        return false;
    }
}

// ============================================
// PASSWORD MANAGER MODULE
// ============================================

// Password Manager View State
let passwordViewMode = 'list'; // 'list' or 'grid'

// Firebase Password Manager
var firebasePasswords = [];

var firebasePasswordsManager = {
    isInitialized: false,
    db: null,

    async initialize() {
        try {
            if (typeof firebase === 'undefined' || !firebase.firestore) {
                console.warn('Firebase not available for Passwords');
                return false;
            }
            this.db = firebase.firestore();
            this.isInitialized = true;
            return true;
        } catch (error) {
            console.error('Error initializing Password Manager Firebase:', error);
            return false;
        }
    },

    async loadPasswords() {
        if (!this.isInitialized || !this.db) {
            console.warn('Passwords Firebase not initialized');
            return [];
        }

        try {
            const collectionName = window.FIREBASE_COLLECTIONS?.passwords || 'passwords';
            const snapshot = await this.db.collection(collectionName)
                .orderBy('createdAt', 'desc')
                .get();

            const passwords = [];
            snapshot.forEach(doc => {
                passwords.push({
                    firestoreId: doc.id,
                    ...doc.data()
                });
            });
            return passwords;
        } catch (error) {
            console.error('Error loading passwords:', error);
            return [];
        }
    },

    async addPassword(passwordData) {
        if (!this.isInitialized || !this.db) {
            throw new Error('Passwords Firebase not initialized');
        }

        try {
            const collectionName = window.FIREBASE_COLLECTIONS?.passwords || 'passwords';
            const docRef = await this.db.collection(collectionName).add({
                ...passwordData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('Password added with ID:', docRef.id);
            return docRef.id;
        } catch (error) {
            console.error('Error adding password:', error);
            throw error;
        }
    },

    async updatePassword(firestoreId, updateData) {
        if (!this.isInitialized || !this.db) {
            throw new Error('Passwords Firebase not initialized');
        }

        try {
            const collectionName = window.FIREBASE_COLLECTIONS?.passwords || 'passwords';
            await this.db.collection(collectionName).doc(firestoreId).update({
                ...updateData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('Password updated:', firestoreId);
            return true;
        } catch (error) {
            console.error('Error updating password:', error);
            throw error;
        }
    },

    async deletePassword(firestoreId) {
        if (!this.isInitialized || !this.db) {
            throw new Error('Passwords Firebase not initialized');
        }

        try {
            const collectionName = window.FIREBASE_COLLECTIONS?.passwords || 'passwords';
            await this.db.collection(collectionName).doc(firestoreId).delete();

            console.log('Password deleted:', firestoreId);
            return true;
        } catch (error) {
            console.error('Error deleting password:', error);
            throw error;
        }
    }
};

// Initialize Firebase Passwords
async function initializeFirebasePasswords() {
    // Guard against firebasePasswordsManager not yet initialized
    if (typeof firebasePasswordsManager === 'undefined' || !firebasePasswordsManager) {
        console.warn('Firebase Passwords Manager not yet initialized');
        return;
    }

    try {
        await firebasePasswordsManager.initialize();
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

    } catch (error) {
        console.error('Error initializing Firebase Passwords:', error);
    }
}

// Password categories with icons and colors
var passwordCategories = {
    'gas': { label: 'Gas & Utilities', icon: 'fa-fire-flame-curved', color: '#f97316' },
    'suppliers': { label: 'Suppliers', icon: 'fa-truck', color: '#8b5cf6' },
    'email': { label: 'Email Accounts', icon: 'fa-envelope', color: '#3b82f6' },
    'banking': { label: 'Banking & Finance', icon: 'fa-building-columns', color: '#10b981' },
    'software': { label: 'Software & Apps', icon: 'fa-laptop-code', color: '#ec4899' },
    'social': { label: 'Social Media', icon: 'fa-share-nodes', color: '#06b6d4' },
    'pos': { label: 'POS & Sales', icon: 'fa-cash-register', color: '#eab308' },
    'security': { label: 'Security Systems', icon: 'fa-shield-halved', color: '#ef4444' },
    'other': { label: 'Other', icon: 'fa-ellipsis', color: '#71717a' }
};

// Generate random password
function generateRandomPassword(length = 16) {
    const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const lowercase = 'abcdefghijklmnopqrstuvwxyz';
    const numbers = '0123456789';
    const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
    const allChars = uppercase + lowercase + numbers + symbols;

    let password = '';
    // Ensure at least one of each type
    password += uppercase[Math.floor(Math.random() * uppercase.length)];
    password += lowercase[Math.floor(Math.random() * lowercase.length)];
    password += numbers[Math.floor(Math.random() * numbers.length)];
    password += symbols[Math.floor(Math.random() * symbols.length)];

    // Fill the rest randomly
    for (let i = password.length; i < length; i++) {
        password += allChars[Math.floor(Math.random() * allChars.length)];
    }

    // Shuffle the password
    return password.split('').sort(() => Math.random() - 0.5).join('');
}

// Copy to clipboard
async function copyPasswordToClipboard(text, fieldName = 'Text') {
    try {
        await navigator.clipboard.writeText(text);
        showPasswordToast(`${fieldName} copied to clipboard!`, 'success');
    } catch (error) {
        console.error('Failed to copy:', error);
        // Fallback method
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showPasswordToast(`${fieldName} copied to clipboard!`, 'success');
        } catch (err) {
            showPasswordToast('Failed to copy to clipboard', 'error');
        }
        document.body.removeChild(textArea);
    }
}

// Toggle password visibility
function togglePasswordVisibility(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Render Password Manager Page
window.renderPasswordManager = async function renderPasswordManager() {
    const dashboard = document.querySelector('.dashboard');

    // Initialize if not already done
    if (!firebasePasswordsManager.isInitialized) {
        await initializeFirebasePasswords();
    }

    const categoryOptions = Object.entries(passwordCategories)
        .map(([value, cat]) => `<option value="${value}">${cat.label}</option>`)
        .join('');

    dashboard.innerHTML = `
        <div class="page-header" style="margin-bottom: 24px;">
            <div class="page-header-left">
                <h2 class="section-title" style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-key" style="color: white; font-size: 20px;"></i>
                    </div>
                    Password Manager
                </h2>
                <p class="section-subtitle">Securely store and manage all your business passwords</p>
            </div>
            <div class="page-header-right" style="display: flex; gap: 12px; align-items: center;">
                <!-- View Toggle -->
                <div style="display: flex; background: var(--bg-secondary); border-radius: 10px; padding: 4px; border: 1px solid var(--border-color);">
                    <button onclick="setPasswordViewMode('list')" id="pwd-view-list-btn" style="width: 38px; height: 38px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${passwordViewMode === 'list' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="List View">
                        <i class="fas fa-list"></i>
                    </button>
                    <button onclick="setPasswordViewMode('grid')" id="pwd-view-grid-btn" style="width: 38px; height: 38px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; ${passwordViewMode === 'grid' ? 'background: var(--accent-primary); color: white;' : 'background: transparent; color: var(--text-muted);'}" title="Grid View">
                        <i class="fas fa-th-large"></i>
                    </button>
                </div>
                <button class="btn-primary" onclick="toggleAddPasswordInline()" style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-plus"></i>
                    Add Password
                </button>
            </div>
        </div>

        <!-- Inline Add Form (hidden by default) -->
        <div id="inline-add-password" style="display: none; margin-bottom: 24px;">
            <div class="card" style="border: 2px solid var(--accent-primary); background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, var(--bg-secondary) 100%);">
                <div class="card-header" style="background: transparent; border-bottom: 1px solid var(--border-color);">
                    <h3 class="card-title" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-plus-circle" style="color: var(--accent-primary);"></i>
                        Add New Password
                    </h3>
                    <button onclick="toggleAddPasswordInline()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 8px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="card-body" style="padding: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Service Name</label>
                            <input type="text" id="inline-pwd-name" class="form-input" placeholder="e.g., AT&T Business">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Category</label>
                            <select id="inline-pwd-category" class="form-input">
                                <option value="">Select category</option>
                                ${categoryOptions}
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Store</label>
                            <select id="inline-pwd-store" class="form-input">
                                <option value="">Select store...</option>
                                <option value="All Stores">All Stores</option>
                                <option value="Miramar">VSU Miramar</option>
                                <option value="Morena">VSU Morena</option>
                                <option value="Kearny Mesa">VSU Kearny Mesa</option>
                                <option value="Chula Vista">VSU Chula Vista</option>
                                <option value="North Park">VSU North Park</option>
                                <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Username</label>
                            <input type="text" id="inline-pwd-username" class="form-input" placeholder="Username or ID">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Email</label>
                            <input type="email" id="inline-pwd-email" class="form-input" placeholder="email@example.com">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Password</label>
                            <div style="display: flex; gap: 8px;">
                                <div style="flex: 1; position: relative;">
                                    <input type="password" id="inline-pwd-password" class="form-input" placeholder="Enter password" style="padding-right: 44px;">
                                    <button type="button" onclick="togglePasswordVisibility('inline-pwd-password', 'inline-pwd-toggle-icon')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted);">
                                        <i class="fas fa-eye" id="inline-pwd-toggle-icon"></i>
                                    </button>
                                </div>
                                <button type="button" onclick="generateInlinePassword()" class="btn-secondary" title="Generate">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Website URL</label>
                            <input type="url" id="inline-pwd-url" class="form-input" placeholder="https://example.com">
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Notes</label>
                        <textarea id="inline-pwd-notes" class="form-input" placeholder="Additional notes..." style="min-height: 60px; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 12px;">
                        <button class="btn-secondary" onclick="toggleAddPasswordInline()">Cancel</button>
                        <button class="btn-primary" onclick="saveInlinePassword()">
                            <i class="fas fa-save"></i> Save Password
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; position: relative; min-width: 200px;">
                    <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                    <input type="text" id="password-search" class="form-input" placeholder="Search passwords..."
                        style="padding-left: 46px; height: 48px; font-size: 15px; border-radius: 12px;" oninput="filterPasswords()">
                </div>
                <select id="password-store-filter" class="form-input" onchange="filterPasswords()" style="width: 180px; height: 48px; border-radius: 12px;">
                    <option value="">All Stores</option>
                    <option value="Miramar">VSU Miramar</option>
                    <option value="Morena">VSU Morena</option>
                    <option value="Kearny Mesa">VSU Kearny Mesa</option>
                    <option value="Chula Vista">VSU Chula Vista</option>
                    <option value="North Park">VSU North Park</option>
                    <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                </select>
                <select id="password-category-filter" class="form-input" onchange="filterPasswords()" style="width: 180px; height: 48px; border-radius: 12px;">
                    <option value="">All Categories</option>
                    ${categoryOptions}
                </select>
            </div>
        </div>

        <!-- Passwords List/Grid -->
        <div id="passwords-container">
            ${passwordViewMode === 'grid' ? renderPasswordsGridView() : renderPasswordsList()}
        </div>
    `;
}

// Render passwords as expandable list
function renderPasswordsList() {
    if (firebasePasswords.length === 0) {
        return `
            <div class="card">
                <div class="card-body" style="text-align: center; padding: 60px 20px;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-key" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px;">No Passwords Yet</h3>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Start adding your business passwords to keep them organized and secure.</p>
                    <button class="btn-primary" onclick="toggleAddPasswordInline()">
                        <i class="fas fa-plus"></i> Add Your First Password
                    </button>
                </div>
            </div>
        `;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

    firebasePasswords.forEach(pwd => {
        const catInfo = passwordCategories[pwd.category] || passwordCategories.other;
        const escapedPassword = (pwd.password || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

        html += `
            <div class="password-list-item" data-id="${pwd.firestoreId}" style="background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.2s;">
                <!-- Main Row (always visible) -->
                <div onclick="togglePasswordExpand('${pwd.firestoreId}')" style="display: flex; align-items: center; padding: 16px 20px; gap: 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                    <!-- Icon -->
                    <div style="width: 48px; height: 48px; background: ${catInfo.color}15; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas ${catInfo.icon}" style="color: ${catInfo.color}; font-size: 20px;"></i>
                    </div>

                    <!-- Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 10px;">
                            ${pwd.name || 'Unnamed'}
                            ${pwd.url ? `<a href="${pwd.url.startsWith('http') ? pwd.url : 'https://' + pwd.url}" target="_blank" onclick="event.stopPropagation()" style="color: var(--accent-primary); font-size: 12px;"><i class="fas fa-external-link-alt"></i></a>` : ''}
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            ${pwd.username ? `<span><i class="fas fa-user" style="margin-right: 4px; opacity: 0.6;"></i>${pwd.username}</span>` : ''}
                            ${pwd.email ? `<span><i class="fas fa-envelope" style="margin-right: 4px; opacity: 0.6;"></i>${pwd.email}</span>` : ''}
                        </div>
                    </div>

                    <!-- Store Badge -->
                    ${pwd.store ? `
                    <div style="background: var(--bg-primary); color: var(--text-secondary); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-store" style="font-size: 10px;"></i>
                        ${pwd.store}
                    </div>
                    ` : ''}

                    <!-- Category Badge -->
                    <div style="background: ${catInfo.color}15; color: ${catInfo.color}; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        ${catInfo.label}
                    </div>

                    <!-- Quick Actions -->
                    <div style="display: flex; gap: 6px;" onclick="event.stopPropagation()">
                        <button onclick="copyPasswordToClipboard('${escapedPassword}', 'Password')" style="width: 38px; height: 38px; border-radius: 10px; border: none; background: var(--accent-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s;" title="Copy Password">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>

                    <!-- Expand Arrow -->
                    <div style="color: var(--text-muted); transition: transform 0.3s;" id="arrow-${pwd.firestoreId}">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>

                <!-- Expanded Details (hidden by default) -->
                <div id="expand-${pwd.firestoreId}" style="display: none; padding: 0 20px 20px; border-top: 1px solid var(--border-color); margin-top: 0;">
                    <div style="padding-top: 20px;">
                        <!-- Password Display -->
                        <div style="background: var(--bg-primary); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Password</div>
                                    <div style="font-family: 'Space Mono', monospace; font-size: 16px; color: var(--text-primary);" id="pwd-display-${pwd.firestoreId}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="togglePasswordDisplay('${pwd.firestoreId}', '${escapedPassword}')" style="width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);" title="Show/Hide">
                                        <i class="fas fa-eye" id="pwd-icon-${pwd.firestoreId}"></i>
                                    </button>
                                    <button onclick="copyPasswordToClipboard('${escapedPassword}', 'Password')" style="width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Details Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            ${pwd.username ? `
                                <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px;">
                                    <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Username</div>
                                    <div style="font-size: 14px; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between;">
                                        <span>${pwd.username}</span>
                                        <button onclick="copyPasswordToClipboard('${pwd.username}', 'Username')" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                            <i class="fas fa-copy" style="font-size: 12px;"></i>
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${pwd.email ? `
                                <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px;">
                                    <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Email</div>
                                    <div style="font-size: 14px; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between;">
                                        <span style="overflow: hidden; text-overflow: ellipsis;">${pwd.email}</span>
                                        <button onclick="copyPasswordToClipboard('${pwd.email}', 'Email')" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                            <i class="fas fa-copy" style="font-size: 12px;"></i>
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${pwd.url ? `
                                <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px;">
                                    <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Website</div>
                                    <div style="font-size: 14px;">
                                        <a href="${pwd.url.startsWith('http') ? pwd.url : 'https://' + pwd.url}" target="_blank" style="color: var(--accent-primary); text-decoration: none; display: flex; align-items: center; gap: 6px;">
                                            <i class="fas fa-external-link-alt" style="font-size: 10px;"></i>
                                            Open Site
                                        </a>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        ${pwd.notes ? `
                            <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                                <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Notes</div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">${pwd.notes}</div>
                            </div>
                        ` : ''}

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <button onclick="startEditPasswordInline('${pwd.firestoreId}')" class="btn-secondary" style="font-size: 13px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deletePasswordConfirm('${pwd.firestoreId}')" class="btn-secondary" style="font-size: 13px; color: #ef4444; border-color: #ef444450;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    return html;
}

// Render passwords as grid/mosaic view
function renderPasswordsGridView() {
    if (firebasePasswords.length === 0) {
        return `
            <div class="card">
                <div class="card-body" style="text-align: center; padding: 60px 20px;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-key" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px;">No Passwords Yet</h3>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Start adding your business passwords to keep them organized and secure.</p>
                    <button class="btn-primary" onclick="toggleAddPasswordInline()">
                        <i class="fas fa-plus"></i> Add Your First Password
                    </button>
                </div>
            </div>
        `;
    }

    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">';

    firebasePasswords.forEach(pwd => {
        const catInfo = passwordCategories[pwd.category] || passwordCategories.other;
        const escapedPassword = (pwd.password || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

        html += `
            <div class="password-grid-card" style="background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; transition: all 0.2s; display: flex; flex-direction: column;">
                <!-- Card Header -->
                <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: flex-start; gap: 14px;">
                        <!-- Icon -->
                        <div style="width: 52px; height: 52px; background: ${catInfo.color}15; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas ${catInfo.icon}" style="color: ${catInfo.color}; font-size: 22px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 16px; color: var(--text-primary); margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${pwd.name || 'Unnamed'}</span>
                                ${pwd.url ? `<a href="${pwd.url}" target="_blank" onclick="event.stopPropagation()" style="color: var(--accent-primary); font-size: 12px; flex-shrink: 0;"><i class="fas fa-external-link-alt"></i></a>` : ''}
                            </div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
                                <div style="background: ${catInfo.color}15; color: ${catInfo.color}; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block;">
                                    ${catInfo.label}
                                </div>
                                ${pwd.store ? `
                                <div style="background: var(--bg-primary); color: var(--text-secondary); padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="fas fa-store" style="font-size: 9px;"></i>
                                    ${pwd.store}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Body -->
                <div style="padding: 16px 20px; flex: 1;">
                    ${pwd.username ? `
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Username</div>
                            <div style="font-size: 14px; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between;">
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${pwd.username}</span>
                                <button onclick="copyPasswordToClipboard('${pwd.username}', 'Username')" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; flex-shrink: 0;">
                                    <i class="fas fa-copy" style="font-size: 12px;"></i>
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    ${pwd.email ? `
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Email</div>
                            <div style="font-size: 14px; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between;">
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${pwd.email}</span>
                                <button onclick="copyPasswordToClipboard('${pwd.email}', 'Email')" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; flex-shrink: 0;">
                                    <i class="fas fa-copy" style="font-size: 12px;"></i>
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    <!-- Password -->
                    <div style="background: var(--bg-primary); border-radius: 10px; padding: 12px;">
                        <div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Password</div>
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                            <div style="font-family: 'Space Mono', monospace; font-size: 14px; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis;" id="grid-pwd-display-${pwd.firestoreId}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                            <div style="display: flex; gap: 4px; flex-shrink: 0;">
                                <button onclick="toggleGridPasswordDisplay('${pwd.firestoreId}', '${escapedPassword}')" style="width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);" title="Show/Hide">
                                    <i class="fas fa-eye" id="grid-pwd-icon-${pwd.firestoreId}" style="font-size: 12px;"></i>
                                </button>
                                <button onclick="copyPasswordToClipboard('${escapedPassword}', 'Password')" style="width: 32px; height: 32px; border-radius: 8px; border: none; background: var(--accent-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; color: white;" title="Copy Password">
                                    <i class="fas fa-copy" style="font-size: 12px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Footer -->
                <div style="padding: 12px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; justify-content: flex-end;">
                    <button onclick="startEditPasswordInline('${pwd.firestoreId}')" class="btn-secondary" style="font-size: 12px; padding: 8px 14px;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button onclick="deletePasswordConfirm('${pwd.firestoreId}')" class="btn-secondary" style="font-size: 12px; padding: 8px 14px; color: #ef4444; border-color: #ef444450;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });

    html += '</div>';
    return html;
}

// Toggle password visibility in grid view
function toggleGridPasswordDisplay(id, password) {
    const display = document.getElementById(`grid-pwd-display-${id}`);
    const icon = document.getElementById(`grid-pwd-icon-${id}`);

    if (display.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
        display.textContent = password;
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        display.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Set password view mode (list or grid)
function setPasswordViewMode(mode) {
    passwordViewMode = mode;

    // Update button styles
    const listBtn = document.getElementById('pwd-view-list-btn');
    const gridBtn = document.getElementById('pwd-view-grid-btn');

    if (listBtn && gridBtn) {
        if (mode === 'list') {
            listBtn.style.background = 'var(--accent-primary)';
            listBtn.style.color = 'white';
            gridBtn.style.background = 'transparent';
            gridBtn.style.color = 'var(--text-muted)';
        } else {
            gridBtn.style.background = 'var(--accent-primary)';
            gridBtn.style.color = 'white';
            listBtn.style.background = 'transparent';
            listBtn.style.color = 'var(--text-muted)';
        }
    }

    // Re-render the passwords container
    const container = document.getElementById('passwords-container');
    if (container) {
        container.innerHTML = mode === 'grid' ? renderPasswordsGridView() : renderPasswordsList();
    }
}

// For backwards compatibility
function renderPasswordsGrid() {
    return renderPasswordsList();
}

// Toggle password expand/collapse
function togglePasswordExpand(id) {
    const expandDiv = document.getElementById(`expand-${id}`);
    const arrow = document.getElementById(`arrow-${id}`);

    if (expandDiv.style.display === 'none') {
        // Collapse all others first
        document.querySelectorAll('[id^="expand-"]').forEach(el => {
            el.style.display = 'none';
        });
        document.querySelectorAll('[id^="arrow-"]').forEach(el => {
            el.style.transform = 'rotate(0deg)';
        });

        // Expand this one
        expandDiv.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        expandDiv.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Toggle add password inline form
function toggleAddPasswordInline() {
    const form = document.getElementById('inline-add-password');
    if (form.style.display === 'none') {
        form.style.display = 'block';
        document.getElementById('inline-pwd-name').focus();
    } else {
        form.style.display = 'none';
        // Clear form
        document.getElementById('inline-pwd-name').value = '';
        document.getElementById('inline-pwd-category').value = '';
        document.getElementById('inline-pwd-username').value = '';
        document.getElementById('inline-pwd-email').value = '';
        document.getElementById('inline-pwd-password').value = '';
        document.getElementById('inline-pwd-url').value = '';
        document.getElementById('inline-pwd-notes').value = '';
    }
}

// Generate password for inline form
function generateInlinePassword() {
    const password = generateRandomPassword(16);
    const input = document.getElementById('inline-pwd-password');
    input.value = password;
    input.type = 'text';
    document.getElementById('inline-pwd-toggle-icon').classList.remove('fa-eye');
    document.getElementById('inline-pwd-toggle-icon').classList.add('fa-eye-slash');
}

// Save password from inline form
async function saveInlinePassword() {
    const name = document.getElementById('inline-pwd-name').value.trim();
    const category = document.getElementById('inline-pwd-category').value;
    const store = document.getElementById('inline-pwd-store').value;
    const username = document.getElementById('inline-pwd-username').value.trim();
    const email = document.getElementById('inline-pwd-email').value.trim();
    const password = document.getElementById('inline-pwd-password').value;
    const url = document.getElementById('inline-pwd-url').value.trim();
    const notes = document.getElementById('inline-pwd-notes').value.trim();

    if (!name) {
        showPasswordToast('Please enter a service name', 'error');
        return;
    }

    if (!password) {
        showPasswordToast('Please enter a password', 'error');
        return;
    }

    if (email && !isValidEmail(email)) {
        showPasswordToast('Please enter a valid email address', 'error');
        return;
    }

    if (url && !isValidUrl(url)) {
        showPasswordToast('Please enter a valid URL (e.g., https://example.com)', 'error');
        return;
    }

    try {
        const newPassword = {
            name,
            category: category || 'other',
            store: store || 'All Stores',
            username,
            email,
            password,
            url,
            notes
        };

        await firebasePasswordsManager.addPassword(newPassword);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        toggleAddPasswordInline();
        renderPasswordManager();
        showPasswordToast('Password saved successfully!', 'success');
    } catch (error) {
        console.error('Error saving password:', error);
        showPasswordToast('Error saving password. Please try again.', 'error');
    }
}

// Start inline edit
function startEditPasswordInline(firestoreId) {
    const pwd = firebasePasswords.find(p => p.firestoreId === firestoreId);
    if (!pwd) return;

    const categoryOptions = Object.entries(passwordCategories)
        .map(([value, cat]) => `<option value="${value}" ${pwd.category === value ? 'selected' : ''}>${cat.label}</option>`)
        .join('');

    const storeOptions = ['All Stores', 'Miramar', 'Morena', 'Kearny Mesa', 'Chula Vista', 'North Park', 'Miramar Wine & Liquor']
        .map(store => `<option value="${store}" ${pwd.store === store ? 'selected' : ''}>${store === 'All Stores' ? 'All Stores' : 'VSU ' + store}</option>`)
        .join('');

    const expandDiv = document.getElementById(`expand-${firestoreId}`);
    expandDiv.innerHTML = `
        <div style="padding-top: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Service Name</label>
                    <input type="text" id="edit-inline-name-${firestoreId}" class="form-input" value="${pwd.name || ''}">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Category</label>
                    <select id="edit-inline-category-${firestoreId}" class="form-input">
                        ${categoryOptions}
                    </select>
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Store</label>
                    <select id="edit-inline-store-${firestoreId}" class="form-input">
                        ${storeOptions}
                    </select>
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Username</label>
                    <input type="text" id="edit-inline-username-${firestoreId}" class="form-input" value="${pwd.username || ''}">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Email</label>
                    <input type="email" id="edit-inline-email-${firestoreId}" class="form-input" value="${pwd.email || ''}">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Password</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="edit-inline-password-${firestoreId}" class="form-input" value="${pwd.password || ''}" style="flex: 1;">
                        <button type="button" onclick="document.getElementById('edit-inline-password-${firestoreId}').value = generateRandomPassword(16)" class="btn-secondary" title="Generate">
                            <i class="fas fa-wand-magic-sparkles"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Website URL</label>
                    <input type="url" id="edit-inline-url-${firestoreId}" class="form-input" value="${pwd.url || ''}">
                </div>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="font-size: 11px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Notes</label>
                <textarea id="edit-inline-notes-${firestoreId}" class="form-input" style="min-height: 60px; resize: vertical;">${pwd.notes || ''}</textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="renderPasswordManager()" class="btn-secondary" style="font-size: 13px;">Cancel</button>
                <button onclick="saveEditPasswordInline('${firestoreId}')" class="btn-primary" style="font-size: 13px;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    `;
}

// Save inline edit
async function saveEditPasswordInline(firestoreId) {
    const name = document.getElementById(`edit-inline-name-${firestoreId}`).value.trim();
    const category = document.getElementById(`edit-inline-category-${firestoreId}`).value;
    const store = document.getElementById(`edit-inline-store-${firestoreId}`).value;
    const username = document.getElementById(`edit-inline-username-${firestoreId}`).value.trim();
    const email = document.getElementById(`edit-inline-email-${firestoreId}`).value.trim();
    const password = document.getElementById(`edit-inline-password-${firestoreId}`).value;
    const url = document.getElementById(`edit-inline-url-${firestoreId}`).value.trim();
    const notes = document.getElementById(`edit-inline-notes-${firestoreId}`).value.trim();

    if (!name) {
        showPasswordToast('Please enter a service name', 'error');
        return;
    }

    if (email && !isValidEmail(email)) {
        showPasswordToast('Please enter a valid email address', 'error');
        return;
    }

    if (url && !isValidUrl(url)) {
        showPasswordToast('Please enter a valid URL (e.g., https://example.com)', 'error');
        return;
    }

    try {
        const updatedData = {
            name,
            category: category || 'other',
            store: store || 'All Stores',
            username,
            email,
            password,
            url,
            notes
        };

        await firebasePasswordsManager.updatePassword(firestoreId, updatedData);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        renderPasswordManager();
        showPasswordToast('Password updated successfully!', 'success');
    } catch (error) {
        console.error('Error updating password:', error);
        showPasswordToast('Error updating password. Please try again.', 'error');
    }
}

// Toggle password display in list
function togglePasswordDisplay(id, password) {
    const display = document.getElementById(`pwd-display-${id}`);
    const icon = document.getElementById(`pwd-icon-${id}`);

    if (display.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
        display.textContent = password;
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        display.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Filter passwords
function filterPasswords() {
    const searchTerm = document.getElementById('password-search')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('password-category-filter')?.value || '';
    const storeFilter = document.getElementById('password-store-filter')?.value || '';

    // Get items based on current view mode
    const itemSelector = passwordViewMode === 'grid' ? '.password-grid-card' : '.password-list-item';
    const items = document.querySelectorAll(itemSelector);

    items.forEach((item, index) => {
        const pwd = firebasePasswords[index];
        if (!pwd) return;

        const matchesSearch = !searchTerm ||
            pwd.name?.toLowerCase().includes(searchTerm) ||
            pwd.username?.toLowerCase().includes(searchTerm) ||
            pwd.email?.toLowerCase().includes(searchTerm) ||
            pwd.url?.toLowerCase().includes(searchTerm) ||
            pwd.notes?.toLowerCase().includes(searchTerm) ||
            pwd.store?.toLowerCase().includes(searchTerm);

        const matchesCategory = !categoryFilter || pwd.category === categoryFilter;
        const matchesStore = !storeFilter || pwd.store === storeFilter || (!pwd.store && storeFilter === 'All Stores');

        if (matchesSearch && matchesCategory && matchesStore) {
            item.style.display = passwordViewMode === 'grid' ? 'flex' : 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Open Add Password Modal
function openAddPasswordModal() {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    const categoryOptions = Object.entries(passwordCategories)
        .map(([value, cat]) => `<option value="${value}">${cat.label}</option>`)
        .join('');

    modalContent.innerHTML = `
        <div class="modal-header">
            <h2 style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-plus" style="color: white;"></i>
                </div>
                Add New Password
            </h2>
            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="add-password-form" style="display: grid; gap: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label">Service Name</label>
                        <input type="text" id="pwd-name" class="form-input" placeholder="e.g., AT&T Business">
                    </div>
                    <div>
                        <label class="form-label">Category</label>
                        <select id="pwd-category" class="form-input">
                            <option value="">Select category</option>
                            ${categoryOptions}
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label">Username</label>
                        <input type="text" id="pwd-username" class="form-input" placeholder="Username or account ID">
                    </div>
                    <div>
                        <label class="form-label">Email</label>
                        <input type="email" id="pwd-email" class="form-input" placeholder="Associated email">
                    </div>
                </div>

                <div>
                    <label class="form-label">Password</label>
                    <div style="display: flex; gap: 8px;">
                        <div style="flex: 1; position: relative;">
                            <input type="password" id="pwd-password" class="form-input" placeholder="Enter password" style="padding-right: 44px;">
                            <button type="button" onclick="togglePasswordVisibility('pwd-password', 'pwd-toggle-icon')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                <i class="fas fa-eye" id="pwd-toggle-icon"></i>
                            </button>
                        </div>
                        <button type="button" onclick="fillGeneratedPassword()" class="btn-secondary" style="white-space: nowrap;" title="Generate strong password">
                            <i class="fas fa-wand-magic-sparkles"></i> Generate
                        </button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Website URL</label>
                    <input type="url" id="pwd-url" class="form-input" placeholder="https://example.com">
                </div>

                <div>
                    <label class="form-label">Notes</label>
                    <textarea id="pwd-notes" class="form-input" placeholder="Additional notes, security questions, account number, etc." style="min-height: 80px; resize: vertical;"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="saveNewPassword()">
                <i class="fas fa-save"></i> Save Password
            </button>
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    `;

    modal.classList.add('active');
}

// Fill generated password
function fillGeneratedPassword() {
    const password = generateRandomPassword(16);
    const input = document.getElementById('pwd-password');
    input.value = password;
    input.type = 'text'; // Show the generated password
    document.getElementById('pwd-toggle-icon').classList.remove('fa-eye');
    document.getElementById('pwd-toggle-icon').classList.add('fa-eye-slash');
}

// Save new password
async function saveNewPassword() {
    const name = document.getElementById('pwd-name').value.trim();
    const category = document.getElementById('pwd-category').value;
    const username = document.getElementById('pwd-username').value.trim();
    const email = document.getElementById('pwd-email').value.trim();
    const password = document.getElementById('pwd-password').value;
    const url = document.getElementById('pwd-url').value.trim();
    const notes = document.getElementById('pwd-notes').value.trim();

    if (!name) {
        showPasswordToast('Please enter a service name', 'error');
        return;
    }

    if (!password) {
        showPasswordToast('Please enter a password', 'error');
        return;
    }

    if (email && !isValidEmail(email)) {
        showPasswordToast('Please enter a valid email address', 'error');
        return;
    }

    if (url && !isValidUrl(url)) {
        showPasswordToast('Please enter a valid URL (e.g., https://example.com)', 'error');
        return;
    }

    try {
        const newPassword = {
            name,
            category: category || 'other',
            username,
            email,
            password,
            url,
            notes
        };

        await firebasePasswordsManager.addPassword(newPassword);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        closeModal();
        renderPasswordManager();
        showPasswordToast('Password saved successfully!', 'success');
    } catch (error) {
        console.error('Error saving password:', error);
        showPasswordToast('Error saving password. Please try again.', 'error');
    }
}

// Open Edit Password Modal
function openEditPasswordModal(firestoreId) {
    const pwd = firebasePasswords.find(p => p.firestoreId === firestoreId);
    if (!pwd) return;

    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    const categoryOptions = Object.entries(passwordCategories)
        .map(([value, cat]) => `<option value="${value}" ${pwd.category === value ? 'selected' : ''}>${cat.label}</option>`)
        .join('');

    modalContent.innerHTML = `
        <div class="modal-header">
            <h2 style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-edit" style="color: white;"></i>
                </div>
                Edit Password
            </h2>
            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="edit-password-form" style="display: grid; gap: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label">Service Name</label>
                        <input type="text" id="edit-pwd-name" class="form-input" value="${pwd.name || ''}" placeholder="e.g., AT&T Business">
                    </div>
                    <div>
                        <label class="form-label">Category</label>
                        <select id="edit-pwd-category" class="form-input">
                            <option value="">Select category</option>
                            ${categoryOptions}
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label">Username</label>
                        <input type="text" id="edit-pwd-username" class="form-input" value="${pwd.username || ''}" placeholder="Username or account ID">
                    </div>
                    <div>
                        <label class="form-label">Email</label>
                        <input type="email" id="edit-pwd-email" class="form-input" value="${pwd.email || ''}" placeholder="Associated email">
                    </div>
                </div>

                <div>
                    <label class="form-label">Password</label>
                    <div style="display: flex; gap: 8px;">
                        <div style="flex: 1; position: relative;">
                            <input type="password" id="edit-pwd-password" class="form-input" value="${pwd.password || ''}" placeholder="Enter password" style="padding-right: 44px;">
                            <button type="button" onclick="togglePasswordVisibility('edit-pwd-password', 'edit-pwd-toggle-icon')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                                <i class="fas fa-eye" id="edit-pwd-toggle-icon"></i>
                            </button>
                        </div>
                        <button type="button" onclick="fillEditGeneratedPassword()" class="btn-secondary" style="white-space: nowrap;" title="Generate strong password">
                            <i class="fas fa-wand-magic-sparkles"></i> Generate
                        </button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Website URL</label>
                    <input type="url" id="edit-pwd-url" class="form-input" value="${pwd.url || ''}" placeholder="https://example.com">
                </div>

                <div>
                    <label class="form-label">Notes</label>
                    <textarea id="edit-pwd-notes" class="form-input" placeholder="Additional notes, security questions, account number, etc." style="min-height: 80px; resize: vertical;">${pwd.notes || ''}</textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <div style="display: flex; gap: 8px;">
                <button class="btn-primary" onclick="updatePassword('${firestoreId}')">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
            <button class="btn-danger" onclick="deletePasswordConfirm('${firestoreId}')" style="background: #ef4444; color: white; border: none;">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    `;

    modal.classList.add('active');
}

// Fill generated password for edit form
function fillEditGeneratedPassword() {
    const password = generateRandomPassword(16);
    const input = document.getElementById('edit-pwd-password');
    input.value = password;
    input.type = 'text';
    document.getElementById('edit-pwd-toggle-icon').classList.remove('fa-eye');
    document.getElementById('edit-pwd-toggle-icon').classList.add('fa-eye-slash');
}

// Update password
async function updatePassword(firestoreId) {
    const name = document.getElementById('edit-pwd-name').value.trim();
    const category = document.getElementById('edit-pwd-category').value;
    const username = document.getElementById('edit-pwd-username').value.trim();
    const email = document.getElementById('edit-pwd-email').value.trim();
    const password = document.getElementById('edit-pwd-password').value;
    const url = document.getElementById('edit-pwd-url').value.trim();
    const notes = document.getElementById('edit-pwd-notes').value.trim();

    if (!name) {
        showPasswordToast('Please enter a service name', 'error');
        return;
    }

    if (!password) {
        showPasswordToast('Please enter a password', 'error');
        return;
    }

    try {
        const updateData = {
            name,
            category: category || 'other',
            username,
            email,
            password,
            url,
            notes
        };

        await firebasePasswordsManager.updatePassword(firestoreId, updateData);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        closeModal();
        renderPasswordManager();
        showPasswordToast('Password updated successfully!', 'success');
    } catch (error) {
        console.error('Error updating password:', error);
        showPasswordToast('Error updating password. Please try again.', 'error');
    }
}

// Delete password confirmation
function deletePasswordConfirm(firestoreId) {
    const pwd = firebasePasswords.find(p => p.firestoreId === firestoreId);
    if (!pwd) return;

    if (confirm(`Are you sure you want to delete "${pwd.name}"?\n\nThis action cannot be undone.`)) {
        deletePassword(firestoreId);
    }
}

// Delete password
async function deletePassword(firestoreId) {
    try {
        await firebasePasswordsManager.deletePassword(firestoreId);
        firebasePasswords = await firebasePasswordsManager.loadPasswords();

        closeModal();
        renderPasswordManager();
        showPasswordToast('Password deleted successfully!', 'success');
    } catch (error) {
        console.error('Error deleting password:', error);
        showPasswordToast('Error deleting password. Please try again.', 'error');
    }
}

// Toast notification for password manager
function showPasswordToast(message, type = 'info') {
    // Check if toast container exists
    let toastContainer = document.getElementById('password-toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'password-toast-container';
        toastContainer.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
        document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };

    toast.style.cssText = `
        padding: 14px 20px;
        background: ${colors[type] || colors.info};
        color: white;
        border-radius: 10px;
        font-weight: 500;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: pwdSlideIn 0.3s ease;
    `;

    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };

    toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i> ${message}`;
    toastContainer.appendChild(toast);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'pwdSlideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// =====================================================
// PROJECT ANALYTICS MODULE
// =====================================================

window.renderProjectAnalytics = function() {
    console.log('renderProjectAnalytics called');
    const dashboard = document.querySelector('.dashboard');

    // Project statistics - Real data (Updated December 15, 2025)
    const projectStats = {
        totalLines: 64568,
        jsLines: 50284,
        htmlLines: 5524,
        cssLines: 7994,
        configLines: 766,
        totalFunctions: 795,
        totalFiles: 21,
        totalModules: 28,
        projectSize: '9.5 MB',
        stores: 5,
        gitCommits: 65,
        projectStart: 'December 9, 2025',
        lastUpdate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
    };

    // Module list with descriptions and navigation
    const modules = [
        { name: 'Celeste AI', icon: 'fa-stars', status: 'active', page: 'celesteai', description: 'AI-powered assistant', fullDescription: 'Intelligent AI assistant powered by OpenAI GPT-4 for business insights, data analysis, and natural language queries.', features: ['Natural language', 'Business insights', 'Data analysis', 'Context awareness'], version: '2.0', linesOfCode: 1850 },
        { name: 'Dashboard', icon: 'fa-th-large', status: 'active', page: 'dashboard', description: 'Overview & KPIs', fullDescription: 'Central command center displaying real-time KPIs, quick stats, and business overview across all store locations.', features: ['Real-time metrics', 'Quick navigation', 'Store overview', 'Activity feed'], version: '2.5', linesOfCode: 950 },
        { name: 'Employees', icon: 'fa-users', status: 'active', page: 'employees', description: 'Staff management & profiles', fullDescription: 'Complete employee management system with profiles, photos, emergency contacts, and role assignments.', features: ['Profile photos', 'Camera capture', 'Role management', 'Emergency contacts'], version: '3.5', linesOfCode: 1400 },
        { name: 'Schedule', icon: 'fa-calendar-alt', status: 'active', page: 'schedule', description: 'Shift scheduling system', fullDescription: 'Visual drag-and-drop scheduling system for managing employee shifts across multiple stores.', features: ['Drag & drop', 'Multi-store view', 'Conflict detection', 'Export to PDF'], version: '1.8', linesOfCode: 1100 },
        { name: 'Clock In/Out', icon: 'fa-clock', status: 'active', page: 'clockin', description: 'Time tracking', fullDescription: 'Real-time employee time tracking with photo verification and automatic hour calculations.', features: ['Photo verification', 'GPS tracking', 'Auto calculations', 'Overtime alerts'], version: '2.5', linesOfCode: 750 },
        { name: 'Training Center', icon: 'fa-graduation-cap', status: 'active', page: 'training', description: 'Video & document training', fullDescription: 'Comprehensive training platform with video courses, documents, and completion tracking.', features: ['Video player', 'Progress tracking', 'Certificates', 'Required courses'], version: '2.0', linesOfCode: 820 },
        { name: 'Licenses & Docs', icon: 'fa-folder-open', status: 'active', page: 'licenses', description: 'Compliance management', fullDescription: 'Document management for business licenses, permits, and compliance certificates with expiration alerts.', features: ['Expiration alerts', 'Document upload', 'Auto reminders', 'Compliance status'], version: '1.5', linesOfCode: 680 },
        { name: 'Sales Analytics', icon: 'fa-chart-line', status: 'active', page: 'analytics', description: 'Shopify integration', fullDescription: 'Real-time sales analytics with Shopify integration, charts, and performance metrics.', features: ['Shopify sync', 'Interactive charts', 'Revenue tracking', 'Product analytics'], version: '3.0', linesOfCode: 1650 },
        { name: 'Barcode Labels', icon: 'fa-barcode', status: 'active', page: 'labels', description: 'Label generation', fullDescription: 'Barcode and label generation system for inventory management and product tagging.', features: ['Barcode generation', 'Label printing', 'Batch creation', 'Template editor'], version: '1.5', linesOfCode: 520 },
        { name: 'Product Requests', icon: 'fa-boxes', status: 'active', page: 'restock', description: 'Product requests', fullDescription: 'Simple product request system for stores.', features: ['Quick requests', 'Priority levels', 'Store tracking'], version: '2.0', linesOfCode: 300 },
        { name: 'Supplies', icon: 'fa-shopping-basket', status: 'active', page: 'supplies', description: 'Store supplies tracking', fullDescription: 'Track everyday supplies needed per store with pending/purchased status and monthly history.', features: ['Per-store tracking', 'Purchase status', 'Monthly history', 'All employees access'], version: '1.2', linesOfCode: 450 },
        { name: 'Daily Checklist', icon: 'fa-clipboard-check', status: 'active', page: 'dailychecklist', description: 'Task management', fullDescription: 'Daily operational checklist for store opening, closing, and routine tasks.', features: ['Custom checklists', 'Task templates', 'Completion tracking', 'Reminders'], version: '1.3', linesOfCode: 380 },
        { name: 'Abundance Cloud', icon: 'fa-cloud', status: 'active', page: 'abundancecloud', description: 'Order management engine', fullDescription: 'Powerful order processing engine for shipping, pickup, and delivery management.', features: ['Order tracking', 'Shipping labels', 'Pickup scheduling', 'Delivery status'], version: '3.5', linesOfCode: 2400 },
        { name: 'Transfers', icon: 'fa-exchange-alt', status: 'active', page: 'transfers', description: 'Inter-store transfers', fullDescription: 'Manage product and inventory transfers between store locations with tracking.', features: ['Transfer requests', 'Status tracking', 'Approval workflow', 'History log'], version: '1.0', linesOfCode: 420 },
        { name: 'Announcements', icon: 'fa-bullhorn', status: 'active', page: 'announcements', description: 'Internal communications', fullDescription: 'Company-wide announcement system with targeting by store, role, and priority levels.', features: ['Rich text editor', 'File attachments', 'Read receipts', 'Priority levels'], version: '2.0', linesOfCode: 580 },
        { name: 'Thief Database', icon: 'fa-user-secret', status: 'active', page: 'thieves', description: 'Incident tracking', fullDescription: 'Security incident tracking with photo evidence, descriptions, and cross-store alerts.', features: ['Photo evidence', 'Incident reports', 'Cross-store alerts', 'Search database'], version: '1.5', linesOfCode: 660 },
        { name: 'Invoices', icon: 'fa-file-invoice-dollar', status: 'active', page: 'invoices', description: 'Payment management', fullDescription: 'Invoice and payment tracking with vendor integration and payment status management.', features: ['Payment tracking', 'Due date alerts', 'Vendor linking', 'PDF generation'], version: '1.6', linesOfCode: 780 },
        { name: 'Issues Registry', icon: 'fa-exclamation-triangle', status: 'active', page: 'issues', description: 'Customer complaints', fullDescription: 'Customer complaint and issue tracking system with resolution workflow.', features: ['Ticket system', 'Resolution tracking', 'Priority queue', 'Customer follow-up'], version: '1.5', linesOfCode: 620 },
        { name: 'Gconomics', icon: 'fa-wallet', status: 'active', page: 'gconomics', description: 'Financial tracking', fullDescription: 'Personal finance tracking for expense planning and budget management.', features: ['Expense categories', 'Budget planning', 'Monthly reports', 'Spending insights'], version: '1.8', linesOfCode: 850 },
        { name: 'Vendors', icon: 'fa-truck', status: 'active', page: 'vendors', description: 'Supplier directory', fullDescription: 'Vendor and supplier management with contact information and order history.', features: ['Contact directory', 'Order history', 'Rating system', 'Quick reorder'], version: '1.4', linesOfCode: 520 },
        { name: 'Cash Control', icon: 'fa-money-bill-wave', status: 'active', page: 'cashout', description: 'Cash flow tracking', fullDescription: 'Daily cash flow tracking and management with receipt documentation.', features: ['Receipt upload', 'Category tracking', 'Daily totals', 'Approval workflow'], version: '2.0', linesOfCode: 980 },
        { name: 'Heady Pieces', icon: 'fa-vault', status: 'active', page: 'treasury', description: 'Art collection', fullDescription: 'Heady glass and art piece collection management with photos and valuations.', features: ['Photo gallery', 'Artist tracking', 'Valuation records', 'Location tracking'], version: '1.8', linesOfCode: 720 },
        { name: 'Change Records', icon: 'fa-coins', status: 'active', page: 'change', description: 'Cash flow between stores', fullDescription: 'Track change and cash transfers between store locations with photo verification.', features: ['Photo verification', 'Transfer tracking', 'Store-to-store', 'Balance history'], version: '1.6', linesOfCode: 580 },
        { name: 'Customer Care', icon: 'fa-heart', status: 'active', page: 'customercare', description: 'Customer care', fullDescription: 'Customer gift and promotional item tracking with recipient information.', features: ['Gift registry', 'Photo proof', 'Recipient tracking', 'Campaign linking'], version: '1.5', linesOfCode: 540 },
        { name: 'Risk Notes', icon: 'fa-shield-halved', status: 'active', page: 'risknotes', description: 'Security alerts', fullDescription: 'Security risk documentation and alert system for potential threats.', features: ['Risk assessment', 'Alert system', 'Action tracking', 'Priority levels'], version: '1.3', linesOfCode: 480 },
        { name: 'Password Manager', icon: 'fa-key', status: 'active', page: 'passwords', description: 'Credentials vault', fullDescription: 'Secure password and credential storage with encrypted access.', features: ['Secure storage', 'Category organization', 'Quick copy', 'Access logging'], version: '1.8', linesOfCode: 620 },
        { name: 'G Force', icon: 'fa-bolt', status: 'active', page: 'gforce', description: 'Daily motivation', fullDescription: 'Daily motivational quotes, affirmations, and philosophy for team inspiration.', features: ['Daily quotes', 'Affirmations', 'Philosophy tips', 'Random generation'], version: '1.5', linesOfCode: 440 },
        { name: 'Job Applications', icon: 'fa-user-plus', status: 'active', page: 'hrapplications', description: 'Job applications', fullDescription: 'Human resources application management system for hiring and recruitment processes.', features: ['Application forms', 'Status tracking', 'Interview scheduling', 'Document upload'], version: '1.0', linesOfCode: 650 },
        { name: 'Authentication', icon: 'fa-lock', status: 'active', page: null, description: 'Role-based access', fullDescription: 'Secure authentication system with role-based permissions and session management.', features: ['Role-based access', 'Session management', 'Permission levels', 'Audit logging'], version: '2.5', linesOfCode: 1020 },
        { name: 'Project Analytics', icon: 'fa-code', status: 'active', page: 'projectanalytics', description: 'System statistics', fullDescription: 'Meta-analytics showing project statistics, codebase metrics, and system overview.', features: ['Code metrics', 'Module overview', 'Tech stack', 'Development timeline'], version: '2.0', linesOfCode: 550 }
    ];

    // Build modules HTML - clickeable cards
    const modulesHtml = modules.map((mod, index) => `
        <div class="module-card" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; transition: all 0.2s; cursor: pointer;"
            onclick="showModuleDetails(${index})"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.borderColor='var(--accent-primary)';"
            onmouseout="this.style.transform='none'; this.style.boxShadow='none'; this.style.borderColor='transparent';">
            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <i class="fas ${mod.icon}" style="color: white; font-size: 14px;"></i>
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${mod.name}</div>
                <div style="font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${mod.description}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 10px; color: var(--text-muted);">v${mod.version}</span>
                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></div>
            </div>
        </div>
    `).join('');

    // Store modules globally for modal access
    window.projectModules = modules;

    dashboard.innerHTML = `
        <div class="page-header" style="margin-bottom: 24px;">
            <div class="page-header-left">
                <h2 class="section-title" style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-code" style="color: white; font-size: 20px;"></i>
                    </div>
                    Project Analytics
                </h2>
                <p class="section-subtitle">Ascendance Hub - Enterprise Management System Statistics</p>
            </div>
        </div>

        <!-- Hero Stats with Animated Counters -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; padding: 24px; border-radius: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(139,92,246,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                <div class="counter-value" data-target="${projectStats.totalLines}" style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">0</div>
                <div style="opacity: 0.9; font-size: 14px;">Lines of Code</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 24px; border-radius: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(245,158,11,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                <div class="counter-value" data-target="${projectStats.gitCommits}" style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">0</div>
                <div style="opacity: 0.9; font-size: 14px;">Git Commits</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 24px; border-radius: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(16,185,129,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                <div class="counter-value" data-target="${projectStats.totalModules}" style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">0</div>
                <div style="opacity: 0.9; font-size: 14px;">Modules</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 24px; border-radius: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(59,130,246,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                <div class="counter-value" data-target="${projectStats.totalFunctions}" style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">0</div>
                <div style="opacity: 0.9; font-size: 14px;">Functions</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 24px; border-radius: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(239,68,68,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                <div class="counter-value" data-target="${projectStats.stores}" style="font-size: 36px; font-weight: 800; margin-bottom: 4px;">0</div>
                <div style="opacity: 0.9; font-size: 14px;">Store Locations</div>
            </div>
        </div>

        <!-- Quality Badges -->
        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px; justify-content: center;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-secondary); border-radius: 20px; border: 1px solid #8b5cf6;">
                <i class="fas fa-feather" style="color: #8b5cf6;"></i>
                <span style="color: var(--text-primary); font-size: 13px; font-weight: 500;">Zero Framework Dependencies</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-secondary); border-radius: 20px; border: 1px solid #f59e0b;">
                <i class="fas fa-fire" style="color: #f59e0b;"></i>
                <span style="color: var(--text-primary); font-size: 13px; font-weight: 500;">Firebase Powered</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-secondary); border-radius: 20px; border: 1px solid #10b981;">
                <i class="fas fa-mobile-screen" style="color: #10b981;"></i>
                <span style="color: var(--text-primary); font-size: 13px; font-weight: 500;">Mobile Ready</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-secondary); border-radius: 20px; border: 1px solid #3b82f6;">
                <i class="fas fa-shield-halved" style="color: #3b82f6;"></i>
                <span style="color: var(--text-primary); font-size: 13px; font-weight: 500;">Role-Based Security</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-secondary); border-radius: 20px; border: 1px solid #ec4899;">
                <i class="fas fa-bolt" style="color: #ec4899;"></i>
                <span style="color: var(--text-primary); font-size: 13px; font-weight: 500;">Real-time Sync</span>
            </div>
        </div>

        <!-- AI Provider Configuration -->
        <div class="card" style="margin-bottom: 24px; border: 1px solid rgba(16,185,129,0.3); background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(5,150,105,0.05));">
            <div class="card-header" style="border-bottom: 1px solid rgba(16,185,129,0.2);">
                <h3 class="card-title" style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-brain" style="color: #10b981;"></i> AI Provider Configuration
                </h3>
                <div id="celeste-api-status" style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(16,185,129,0.15); color: #10b981;">
                    ‚óè OpenAI Ready
                </div>
            </div>
            <div class="card-body">
                <p style="margin: 0 0 16px; color: var(--text-secondary); font-size: 13px;">
                    Celeste AI and all voice/image assistants are powered by <strong>OpenAI GPT-4</strong>.
                </p>

                <!-- OpenAI Provider -->
                <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid rgba(16,185,129,0.2);">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-robot" style="color: white; font-size: 20px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600; font-size: 14px;">OpenAI GPT-4</span>
                            <span style="padding: 2px 8px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 6px; font-size: 10px; font-weight: 600;">ACTIVE</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">GPT-4o - Vision & Text Processing</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span style="font-size: 12px; color: #10b981; font-weight: 500;">Connected</span>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button onclick="openAIProvidersSettings()" class="btn-primary" style="padding: 10px 20px; background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-key"></i> Configure API Key
                    </button>
                    <button onclick="testCelesteFromProjectAnalytics()" class="btn-secondary" style="padding: 10px 20px;">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-wand-magic-sparkles"></i> Quick Actions</h3>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <button onclick="runSystemCheck()" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#10b981'; this.style.background='rgba(16,185,129,0.1)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--bg-secondary)';">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-stethoscope" style="color: white;"></i>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 600; color: var(--text-primary);">System Check</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Verify Firebase connection</div>
                        </div>
                    </button>
                    <button onclick="clearAppCache()" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#f59e0b'; this.style.background='rgba(245,158,11,0.1)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--bg-secondary)';">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-broom" style="color: white;"></i>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 600; color: var(--text-primary);">Clear Cache</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Reset local storage</div>
                        </div>
                    </button>
                    <button onclick="exportSystemReport()" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='rgba(59,130,246,0.1)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--bg-secondary)';">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-file-export" style="color: white;"></i>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 600; color: var(--text-primary);">Export Report</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Download system stats</div>
                        </div>
                    </button>
                    <button onclick="showRecentActivity()" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.background='rgba(139,92,246,0.1)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--bg-secondary)';">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-clock-rotate-left" style="color: white;"></i>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 600; color: var(--text-primary);">Recent Activity</div>
                            <div style="font-size: 12px; color: var(--text-muted);">View system logs</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <!-- Code Breakdown -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-pie"></i> Code Breakdown</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-weight: 500;">JavaScript</span>
                                <span style="color: var(--text-muted);">${projectStats.jsLines.toLocaleString()} lines</span>
                            </div>
                            <div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">
                                <div style="width: 78%; height: 100%; background: linear-gradient(90deg, #f7df1e, #f0d000); border-radius: 5px;"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-weight: 500;">CSS</span>
                                <span style="color: var(--text-muted);">${projectStats.cssLines.toLocaleString()} lines</span>
                            </div>
                            <div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">
                                <div style="width: 12%; height: 100%; background: linear-gradient(90deg, #264de4, #2965f1); border-radius: 5px;"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-weight: 500;">HTML</span>
                                <span style="color: var(--text-muted);">${projectStats.htmlLines.toLocaleString()} lines</span>
                            </div>
                            <div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">
                                <div style="width: 9%; height: 100%; background: linear-gradient(90deg, #e34f26, #f06529); border-radius: 5px;"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-weight: 500;">Config</span>
                                <span style="color: var(--text-muted);">${projectStats.configLines.toLocaleString()} lines</span>
                            </div>
                            <div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">
                                <div style="width: 1%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 5px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tech Stack -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-layer-group"></i> Technology Stack</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
                            <i class="fab fa-js" style="font-size: 32px; color: #f7df1e; margin-bottom: 8px;"></i>
                            <div style="font-weight: 600;">Vanilla JS</div>
                            <div style="font-size: 12px; color: var(--text-muted);">No frameworks</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
                            <i class="fas fa-fire" style="font-size: 32px; color: #ffca28; margin-bottom: 8px;"></i>
                            <div style="font-weight: 600;">Firebase</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Real-time sync</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
                            <i class="fas fa-chart-bar" style="font-size: 32px; color: #ff6384; margin-bottom: 8px;"></i>
                            <div style="font-weight: 600;">Chart.js</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Data visualization</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
                            <i class="fab fa-font-awesome" style="font-size: 32px; color: #339af0; margin-bottom: 8px;"></i>
                            <div style="font-weight: 600;">Font Awesome</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Icon library</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature Highlights -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-sparkles"></i> Key Features</h3>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1)); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-bolt" style="color: white;"></i>
                            </div>
                            <div style="font-weight: 600; font-size: 16px;">Real-time Operations</div>
                        </div>
                        <div style="color: var(--text-muted); font-size: 13px; line-height: 1.6;">Firebase-powered real-time sync across all modules. Changes reflect instantly across all connected devices.</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-shield-halved" style="color: white;"></i>
                            </div>
                            <div style="font-weight: 600; font-size: 16px;">Role-Based Security</div>
                        </div>
                        <div style="color: var(--text-muted); font-size: 13px; line-height: 1.6;">Three-tier permission system (Admin, Manager, Employee) with granular access control per module.</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.2);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-mobile-screen" style="color: white;"></i>
                            </div>
                            <div style="font-weight: 600; font-size: 16px;">Mobile Responsive</div>
                        </div>
                        <div style="color: var(--text-muted); font-size: 13px; line-height: 1.6;">Fully responsive design optimized for desktop, tablet, and mobile devices with camera integration.</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-plug" style="color: white;"></i>
                            </div>
                            <div style="font-weight: 600; font-size: 16px;">API Integrations</div>
                        </div>
                        <div style="color: var(--text-muted); font-size: 13px; line-height: 1.6;">Connected to Shopify for sales data, Firebase for storage, and custom APIs for order management.</div>
                    </div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 24px;">
            <!-- Development Stats -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-simple"></i> Development Metrics</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-code-branch" style="color: #8b5cf6;"></i>
                                <span>Git Commits</span>
                            </div>
                            <span style="font-weight: 700; color: var(--accent-primary);">${projectStats.gitCommits}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-file-code" style="color: #f59e0b;"></i>
                                <span>Source Files</span>
                            </div>
                            <span style="font-weight: 700; color: var(--accent-primary);">${projectStats.totalFiles}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-calendar-check" style="color: #10b981;"></i>
                                <span>Project Started</span>
                            </div>
                            <span style="font-weight: 700; color: var(--accent-primary);">Dec 9, 2025</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-store" style="color: #3b82f6;"></i>
                                <span>Stores Supported</span>
                            </div>
                            <span style="font-weight: 700; color: var(--accent-primary);">${projectStats.stores}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-puzzle-piece" style="color: #ef4444;"></i>
                                <span>Active Modules</span>
                            </div>
                            <span style="font-weight: 700; color: #10b981;">${projectStats.totalModules}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Modules -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title"><i class="fas fa-puzzle-piece"></i> System Modules (${modules.length})</h3>
                <span style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-mouse-pointer"></i> Click any module for details</span>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px;">
                    ${modulesHtml}
                </div>
            </div>
        </div>

        <!-- Development Timeline -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-timeline"></i> Development Timeline</h3>
            </div>
            <div class="card-body">
                <div style="position: relative; padding-left: 30px;">
                    <div style="position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: linear-gradient(180deg, #8b5cf6, #6366f1, #3b82f6, #10b981, #f59e0b, #ec4899);"></div>

                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 14px; height: 14px; background: #8b5cf6; border-radius: 50%; border: 3px solid var(--bg-primary);"></div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Day 1: Foundation</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">December 9, 2025</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Core architecture, authentication system, employee management, dashboard, and basic modules setup.</div>
                        </div>
                    </div>

                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 14px; height: 14px; background: #6366f1; border-radius: 50%; border: 3px solid var(--bg-primary);"></div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Day 2: Core Features</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">December 10, 2025</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Clock in/out, scheduling, training center, licenses & documents, sales analytics with Shopify integration.</div>
                        </div>
                    </div>

                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 14px; height: 14px; background: #3b82f6; border-radius: 50%; border: 3px solid var(--bg-primary);"></div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Day 3: Advanced Modules</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">December 11, 2025</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Abundance Cloud Engine, inventory management, vendor system, financial modules, treasury, and change tracking.</div>
                        </div>
                    </div>

                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 14px; height: 14px; background: #10b981; border-radius: 50%; border: 3px solid var(--bg-primary);"></div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Day 4: Polish & Enhancements</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">December 12, 2025</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Camera integration, employee photos, supplies module, G Force motivation, barcode labels system.</div>
                        </div>
                    </div>

                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 14px; height: 14px; background: #f59e0b; border-radius: 50%; border: 3px solid var(--bg-primary);"></div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Day 5-6: AI Integration</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">December 13-14, 2025</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Celeste AI assistant with OpenAI GPT-4, Project Analytics module, HR Applications system, and transfers module.</div>
                        </div>
                    </div>

                    <div style="position: relative;">
                        <div style="position: absolute; left: -26px; width: 14px; height: 14px; background: #ec4899; border-radius: 50%; border: 3px solid var(--bg-primary); animation: pulse 2s infinite;"></div>
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 12px; border: 1px solid rgba(236, 72, 153, 0.3);">
                            <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">Day 7: Continuous Development <span style="font-size: 10px; padding: 2px 8px; background: #ec4899; color: white; border-radius: 10px;">CURRENT</span></div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">December 15, 2025</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">System optimizations, bug fixes, UI/UX improvements, and continuous feature enhancements across all 28 modules.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Credits & Footer -->
        <div style="padding: 40px; background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%); border-radius: 24px; text-align: center; border: 1px solid rgba(139, 92, 246, 0.3); position: relative; overflow: hidden;">
            <!-- Decorative elements -->
            <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(139, 92, 246, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: radial-gradient(circle, rgba(59, 130, 246, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>

            <div style="position: relative; z-index: 1;">
                <!-- Main Title -->
                <div style="font-size: 42px; font-weight: 800; margin-bottom: 8px; background: linear-gradient(135deg, #8b5cf6, #ec4899, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px;">
                    Ascendance Hub
                </div>
                <div style="color: #a1a1aa; font-size: 16px; margin-bottom: 32px;">
                    Enterprise-grade retail management system
                </div>

                <!-- Stats Row -->
                <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; margin-bottom: 32px;">
                    <div>
                        <div style="font-size: 28px; font-weight: 700; color: white;">${projectStats.totalLines.toLocaleString()}</div>
                        <div style="font-size: 12px; color: #71717a; text-transform: uppercase; letter-spacing: 1px;">Lines of Code</div>
                    </div>
                    <div>
                        <div style="font-size: 28px; font-weight: 700; color: white;">${projectStats.gitCommits}</div>
                        <div style="font-size: 12px; color: #71717a; text-transform: uppercase; letter-spacing: 1px;">Commits</div>
                    </div>
                    <div>
                        <div style="font-size: 28px; font-weight: 700; color: white;">${projectStats.totalModules}</div>
                        <div style="font-size: 12px; color: #71717a; text-transform: uppercase; letter-spacing: 1px;">Modules</div>
                    </div>
                    <div>
                        <div style="font-size: 28px; font-weight: 700; color: white;">7</div>
                        <div style="font-size: 12px; color: #71717a; text-transform: uppercase; letter-spacing: 1px;">Days Built</div>
                    </div>
                </div>

                <!-- Divider -->
                <div style="width: 80px; height: 3px; background: linear-gradient(90deg, #8b5cf6, #ec4899); margin: 0 auto 32px; border-radius: 2px;"></div>

                <!-- Built By Section -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; color: #71717a; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px;">Built with passion by</div>
                    <a href="https://calidevs.com" target="_blank" style="display: inline-flex; align-items: center; gap: 12px; padding: 16px 32px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2)); border-radius: 16px; border: 1px solid rgba(139, 92, 246, 0.4); text-decoration: none; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(139, 92, 246, 0.3)'; this.style.borderColor='rgba(139, 92, 246, 0.8)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none'; this.style.borderColor='rgba(139, 92, 246, 0.4)';">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #8b5cf6, #ec4899); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-laptop-code" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-size: 20px; font-weight: 700; color: white; letter-spacing: -0.5px;">CaliDevs</div>
                            <div style="font-size: 13px; color: #a1a1aa;">Software Development Studio</div>
                        </div>
                        <i class="fas fa-arrow-up-right-from-square" style="color: #8b5cf6; margin-left: 8px;"></i>
                    </a>
                </div>

                <!-- Tech Stack Icons -->
                <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 24px;">
                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 10px; display: flex; align-items: center; justify-content: center;" title="JavaScript">
                        <i class="fab fa-js" style="color: #f7df1e; font-size: 20px;"></i>
                    </div>
                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 10px; display: flex; align-items: center; justify-content: center;" title="HTML5">
                        <i class="fab fa-html5" style="color: #e34f26; font-size: 20px;"></i>
                    </div>
                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 10px; display: flex; align-items: center; justify-content: center;" title="CSS3">
                        <i class="fab fa-css3-alt" style="color: #264de4; font-size: 20px;"></i>
                    </div>
                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 10px; display: flex; align-items: center; justify-content: center;" title="Firebase">
                        <i class="fas fa-fire" style="color: #ffca28; font-size: 18px;"></i>
                    </div>
                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 10px; display: flex; align-items: center; justify-content: center;" title="Chart.js">
                        <i class="fas fa-chart-pie" style="color: #ff6384; font-size: 18px;"></i>
                    </div>
                </div>

                <!-- Footer Info -->
                <div style="font-size: 12px; color: #52525b;">
                    Version 5.0 &bull; Last updated: ${projectStats.lastUpdate}
                </div>
                <div style="font-size: 11px; color: #3f3f46; margin-top: 8px;">
                    Made in San Diego, California
                </div>
            </div>
        </div>
    `;

    // Animate counters after render
    setTimeout(() => animateCounters(), 100);
}

// Show module details modal
window.showModuleDetails = function(index) {
    const mod = window.projectModules[index];
    if (!mod) return;

    const featuresHtml = mod.features.map(f => `
        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 8px;">
            <i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i>
            <span style="font-size: 13px;">${f}</span>
        </div>
    `).join('');

    const modalHtml = `
        <div id="module-details-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onmousedown="if(event.target === this) closeModuleDetails()">
            <div style="background: var(--bg-primary); border-radius: 20px; max-width: 560px; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalSlideIn 0.3s ease;">
                <!-- Header with gradient -->
                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 24px; color: white; position: relative;">
                    <button onclick="closeModuleDetails()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times" style="color: white;"></i>
                    </button>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${mod.icon}" style="font-size: 24px;"></i>
                        </div>
                        <div>
                            <h2 style="margin: 0; font-size: 22px; font-weight: 700;">${mod.name}</h2>
                            <div style="opacity: 0.9; font-size: 14px; margin-top: 4px;">${mod.description}</div>
                        </div>
                    </div>
                </div>

                <!-- Body -->
                <div style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 180px);">
                    <!-- Stats Row -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-primary);">v${mod.version}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Version</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">${mod.linesOfCode.toLocaleString()}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Lines of Code</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-size: 24px; font-weight: 700; color: #10b981;"><i class="fas fa-circle" style="font-size: 16px;"></i></div>
                            <div style="font-size: 12px; color: var(--text-muted);">Active</div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">About</h4>
                        <p style="margin: 0; color: var(--text-secondary); line-height: 1.7; font-size: 14px;">${mod.fullDescription}</p>
                    </div>

                    <!-- Features -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Key Features</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            ${featuresHtml}
                        </div>
                    </div>

                    <!-- Action Button -->
                    ${mod.page ? `
                        <button onclick="navigateToModule('${mod.page}')" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(139, 92, 246, 0.3)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                            <i class="fas fa-arrow-right"></i>
                            Go to ${mod.name}
                        </button>
                    ` : `
                        <div style="width: 100%; padding: 14px; background: var(--bg-secondary); color: var(--text-muted); border-radius: 12px; font-size: 14px; text-align: center;">
                            <i class="fas fa-lock"></i> System Module - No Direct Access
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;

    // Add animation keyframes if not already added
    if (!document.getElementById('module-modal-styles')) {
        const style = document.createElement('style');
        style.id = 'module-modal-styles';
        style.textContent = `
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: scale(0.95) translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    }

    // Remove any existing modal
    const existing = document.getElementById('module-details-modal');
    if (existing) existing.remove();

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Close module details modal
window.closeModuleDetails = function() {
    const modal = document.getElementById('module-details-modal');
    if (modal) {
        modal.style.animation = 'modalSlideIn 0.2s ease reverse';
        setTimeout(() => modal.remove(), 200);
    }
}

// Navigate to module from details modal
window.navigateToModule = function(page) {
    closeModuleDetails();
    if (page === 'gforce') {
        openGForceModal();
    } else if (page === 'gconomics') {
        openGconomicsModal();
    } else {
        navigateTo(page);
    }
}

// API Settings Modal for Celeste AI - OpenAI Only
window.openAPISettings = function() {
    const currentKey = localStorage.getItem('openai_api_key') || '';
    const maskedKey = currentKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + currentKey.slice(-8) : '';
    const isConnected = currentKey && currentKey.startsWith('sk-');

    const modalHtml = `
        <div id="api-settings-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; animation: modalSlideIn 0.3s ease;"
            onmousedown="if(event.target === this) closeAPISettings()">
            <div style="background: var(--bg-primary); border-radius: 20px; max-width: 500px; width: 100%; padding: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--border-color);">
                <!-- Header -->
                <div style="padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 16px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10a37f, #1a7f64); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-key" style="color: white; font-size: 20px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 18px;">API Settings</h3>
                        <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-muted);">Configure Celeste AI connection</p>
                    </div>
                    <button onclick="closeAPISettings()" style="width: 36px; height: 36px; border-radius: 10px; border: none; background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times" style="color: var(--text-muted);"></i>
                    </button>
                </div>

                <!-- Content -->
                <div style="padding: 24px;">
                    <!-- OpenAI Section -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg" alt="OpenAI" style="width: 24px; height: 24px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <i class="fas fa-robot" style="color: #10a37f; font-size: 20px; display: none;"></i>
                            <div>
                                <div style="font-weight: 600;">OpenAI GPT-4</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Powered by OpenAI API</div>
                            </div>
                            <div style="margin-left: auto; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; ${isConnected ? 'background: rgba(16,185,129,0.15); color: #10b981;' : 'background: rgba(239,68,68,0.15); color: #ef4444;'}">
                                ${isConnected ? 'Connected' : 'Not configured'}
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500;">OpenAI API Key</label>
                            <div style="position: relative;">
                                <input type="password" id="openai-api-key-input" class="form-input"
                                    placeholder="${maskedKey || 'sk-proj-...'}"
                                    value="${currentKey}"
                                    style="padding-right: 80px;">
                                <button onclick="toggleAPIKeyVisibility()" style="position: absolute; right: 44px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted);">
                                    <i class="fas fa-eye" id="api-key-toggle-icon"></i>
                                </button>
                                <button onclick="testOpenAIConnection()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #10a37f; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; color: white; font-size: 11px;">
                                    Test
                                </button>
                            </div>
                            <p style="margin: 8px 0 0; font-size: 11px; color: var(--text-muted);">
                                Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #10a37f; font-weight: 600;">platform.openai.com/api-keys</a>
                            </p>
                        </div>

                        <div id="api-test-result" style="display: none; padding: 12px; border-radius: 10px; margin-bottom: 16px; font-size: 13px;"></div>
                    </div>

                    <!-- Get API Key Button -->
                    <a href="https://platform.openai.com/api-keys" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 20px; background: linear-gradient(135deg, #10a37f, #1a7f64); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; margin-bottom: 20px; transition: all 0.2s;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16,163,127,0.3)';"
                        onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                        <i class="fas fa-external-link-alt"></i>
                        Get OpenAI API Key
                    </a>

                    <!-- Info -->
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <i class="fas fa-info-circle" style="color: #10a37f; margin-top: 2px;"></i>
                            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                                <strong>About Celeste AI:</strong><br>
                                Celeste uses OpenAI GPT-4 to understand natural language commands. You can ask her to record expenses, report suspicious people, navigate to modules, and more - just by talking or typing naturally.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div style="padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeAPISettings()" class="btn-secondary" style="padding: 10px 20px;">Cancel</button>
                    <button onclick="saveAPISettings()" class="btn-primary" style="padding: 10px 20px; background: #10a37f;">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal
    const existing = document.getElementById('api-settings-modal');
    if (existing) existing.remove();

    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Close API Settings Modal
window.closeAPISettings = function() {
    const modal = document.getElementById('api-settings-modal');
    if (modal) {
        modal.style.animation = 'modalSlideIn 0.2s ease reverse';
        setTimeout(() => modal.remove(), 200);
    }
}

// Toggle API key visibility
window.toggleAPIKeyVisibility = function() {
    const input = document.getElementById('openai-api-key-input');
    const icon = document.getElementById('api-key-toggle-icon');

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Test OpenAI Connection
window.testOpenAIConnection = async function() {
    const apiKey = document.getElementById('openai-api-key-input').value.trim();
    const resultDiv = document.getElementById('api-test-result');

    if (!apiKey) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = 'rgba(239,68,68,0.15)';
        resultDiv.style.color = '#ef4444';
        resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> Please enter an API key first';
        return;
    }

    resultDiv.style.display = 'block';
    resultDiv.style.background = 'rgba(59,130,246,0.15)';
    resultDiv.style.color = '#3b82f6';
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing connection...';

    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                max_tokens: 50,
                messages: [{ role: 'user', content: 'Say "Connected!" in one word.' }]
            })
        });

        if (response.ok) {
            resultDiv.style.background = 'rgba(16,185,129,0.15)';
            resultDiv.style.color = '#10b981';
            resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> Connection successful! Celeste AI is ready.';
        } else {
            const error = await response.json();
            throw new Error(error.error?.message || 'API error');
        }
    } catch (error) {
        resultDiv.style.background = 'rgba(239,68,68,0.15)';
        resultDiv.style.color = '#ef4444';
        resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> Connection failed: ' + error.message;
    }
}

// Save API Settings
window.saveAPISettings = function() {
    const apiKey = document.getElementById('openai-api-key-input').value.trim();

    // Save to localStorage for persistence
    if (apiKey) {
        localStorage.setItem('openai_api_key', apiKey);
        window.OPENAI_API_KEY = apiKey;
    } else {
        localStorage.removeItem('openai_api_key');
        window.OPENAI_API_KEY = '';
    }

    // Show success toast
    showAPISettingsToast('API settings saved successfully!', 'success');
    closeAPISettings();
}

// Toast for API settings
function showAPISettingsToast(message, type = 'info') {
    const toast = document.createElement('div');
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6'
    };

    toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 14px 20px;
        background: ${colors[type]};
        color: white;
        border-radius: 10px;
        font-weight: 500;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001;
        animation: slideInRight 0.3s ease;
    `;

    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i> ${message}`;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Load OpenAI API key from localStorage on init
(function loadSavedAPIKey() {
    const savedKey = localStorage.getItem('openai_api_key');
    if (savedKey && !window.OPENAI_API_KEY) {
        window.OPENAI_API_KEY = savedKey;
    }
})();

// Test Celeste connection from Project Analytics page - OpenAI Only
window.testCelesteFromProjectAnalytics = async function() {
    const statusDiv = document.getElementById('celeste-api-status');

    // Create debug modal
    const debugModal = document.createElement('div');
    debugModal.id = 'api-debug-modal';
    debugModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    debugModal.onmousedown = (e) => { if (e.target === debugModal) debugModal.remove(); };

    debugModal.innerHTML = `
        <div style="background: var(--bg-primary, #1a1a2e); border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 32px; animation: modalSlideIn 0.3s ease;">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-vial" style="color: white; font-size: 24px;"></i>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 20px; color: var(--text-primary, #fff);">OpenAI Connection Test</h3>
                    <p style="margin: 4px 0 0; color: var(--text-muted, #888); font-size: 13px;">Testing GPT-4o API Connection</p>
                </div>
                <button onclick="document.getElementById('api-debug-modal').remove()" style="margin-left: auto; background: none; border: none; color: var(--text-muted, #888); font-size: 20px; cursor: pointer; padding: 8px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="api-test-results">
                <!-- OpenAI Test Card -->
                <div id="openai-test-card" style="background: var(--bg-secondary, #16162a); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color, #333);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-robot" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary, #fff);">OpenAI GPT-4o</div>
                            <div style="font-size: 12px; color: var(--text-muted, #888);">AI PROVIDER</div>
                        </div>
                        <div id="openai-status" style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(59,130,246,0.15); color: #3b82f6;">
                            <i class="fas fa-spinner fa-spin"></i> Testing...
                        </div>
                    </div>
                    <div id="openai-details" style="font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; color: var(--text-muted, #aaa); white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto;">
Initializing test...
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color, #333); display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="document.getElementById('api-debug-modal').remove()" style="padding: 10px 20px; background: var(--bg-secondary, #16162a); color: var(--text-primary, #fff); border: 1px solid var(--border-color, #333); border-radius: 8px; font-weight: 500; cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(debugModal);

    // Helper to mask API key
    const maskKey = (key) => key ? key.substring(0, 12) + '...' + key.substring(key.length - 6) : 'NOT SET';

    // Helper to update details
    const updateDetails = (text, append = true) => {
        const el = document.getElementById('openai-details');
        if (el) {
            el.textContent = append ? el.textContent + '\n' + text : text;
            el.scrollTop = el.scrollHeight;
        }
    };

    // Helper to update status
    const updateStatus = (status, type) => {
        const el = document.getElementById('openai-status');
        if (el) {
            const styles = {
                testing: { bg: 'rgba(59,130,246,0.15)', color: '#3b82f6', icon: 'fa-spinner fa-spin', text: 'Testing...' },
                success: { bg: 'rgba(16,185,129,0.15)', color: '#10b981', icon: 'fa-check-circle', text: status },
                error: { bg: 'rgba(239,68,68,0.15)', color: '#ef4444', icon: 'fa-times-circle', text: status }
            };
            const s = styles[type] || styles.testing;
            el.style.background = s.bg;
            el.style.color = s.color;
            el.innerHTML = `<i class="fas ${s.icon}"></i> ${s.text}`;
        }
    };

    let openaiSuccess = false;

    try {
        const openaiKey = getOpenAIKey() || localStorage.getItem('openai_api_key');

        updateDetails(`[${new Date().toLocaleTimeString()}] Starting OpenAI GPT-4o test...`, false);
        updateDetails(`üìç Endpoint: https://api.openai.com/v1/chat/completions`);
        updateDetails(`ü§ñ Model: gpt-4o`);
        updateDetails(`üîë API Key: ${maskKey(openaiKey)}`);

        if (!openaiKey) {
            throw new Error('No OpenAI API key configured. Go to Project Analytics > Configure API Key');
        }

        updateDetails(`\n‚è≥ Sending request...`);
        const startTime = performance.now();

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${openaiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                max_tokens: 50,
                messages: [{ role: 'user', content: 'Say "Hello from GPT-4!" in exactly those words.' }]
            })
        });

        const latency = Math.round(performance.now() - startTime);
        updateDetails(`‚ö° Response time: ${latency}ms`);
        updateDetails(`üìä HTTP Status: ${response.status} ${response.statusText}`);

        const data = await response.json();

        if (response.ok) {
            const aiResponse = data.choices?.[0]?.message?.content || 'No text in response';
            updateDetails(`\n‚úÖ SUCCESS!`);
            updateDetails(`üí¨ AI Response: "${aiResponse}"`);
            updateDetails(`üìà Tokens used: ${data.usage?.prompt_tokens || 0} in / ${data.usage?.completion_tokens || 0} out`);
            updateStatus(`Connected (${latency}ms)`, 'success');
            openaiSuccess = true;
        } else {
            throw new Error(data.error?.message || `HTTP ${response.status}`);
        }
    } catch (error) {
        updateDetails(`\n‚ùå ERROR: ${error.message}`);
        updateStatus('Failed', 'error');
        console.error('OpenAI test error:', error);
    }

    // Update main status indicator
    if (statusDiv) {
        if (openaiSuccess) {
            statusDiv.innerHTML = '‚óè Connected';
            statusDiv.style.background = 'rgba(16,185,129,0.15)';
            statusDiv.style.color = '#10b981';
        } else {
            statusDiv.innerHTML = '‚óã Connection Failed';
            statusDiv.style.background = 'rgba(239,68,68,0.15)';
            statusDiv.style.color = '#ef4444';
        }
    }

    console.log('=== OpenAI API TEST ===');
    console.log('OpenAI GPT-4:', openaiSuccess ? '‚úÖ SUCCESS' : '‚ùå FAILED');
}

// Animated counter function
function animateCounters() {
    const counters = document.querySelectorAll('.counter-value');
    counters.forEach(counter => {
        const target = parseInt(counter.dataset.target);
        const duration = 1500; // 1.5 seconds
        const steps = 60;
        const stepDuration = duration / steps;
        let current = 0;
        const increment = target / steps;

        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                counter.textContent = target.toLocaleString();
                clearInterval(timer);
            } else {
                counter.textContent = Math.floor(current).toLocaleString();
            }
        }, stepDuration);
    });
}

// Quick Action: System Check
window.runSystemCheck = async function() {
    const checkModal = document.createElement('div');
    checkModal.id = 'system-check-modal';
    checkModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    checkModal.onmousedown = (e) => { if (e.target === checkModal) checkModal.remove(); };

    checkModal.innerHTML = `
        <div style="background: var(--bg-primary); border-radius: 20px; max-width: 480px; width: 100%; padding: 32px; text-align: center; animation: modalSlideIn 0.3s ease;">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fas fa-stethoscope" style="color: white; font-size: 28px;"></i>
            </div>
            <h3 style="margin: 0 0 8px; font-size: 20px;">System Health Check</h3>
            <p style="color: var(--text-muted); margin: 0 0 24px; font-size: 14px;">Running diagnostics...</p>
            <div id="check-results" style="text-align: left; background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <i class="fas fa-spinner fa-spin" style="color: var(--accent-primary);"></i>
                    <span>Checking Firebase connection...</span>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(checkModal);

    // Simulate checks
    const resultsDiv = document.getElementById('check-results');
    const checks = [
        { name: 'Firebase Connection', check: () => typeof firebase !== 'undefined' && firebase.apps.length > 0 },
        { name: 'Firestore Database', check: () => typeof firebase !== 'undefined' && typeof firebase.firestore === 'function' },
        { name: 'Firebase Storage', check: () => typeof firebase !== 'undefined' && typeof firebase.storage === 'function' },
        { name: 'Authentication System', check: () => typeof getCurrentUser === 'function' },
        { name: 'Local Storage', check: () => typeof localStorage !== 'undefined' }
    ];

    let resultsHtml = '';
    for (const item of checks) {
        await new Promise(r => setTimeout(r, 300));
        const passed = item.check();
        resultsHtml += `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <i class="fas ${passed ? 'fa-check-circle' : 'fa-times-circle'}" style="color: ${passed ? '#10b981' : '#ef4444'};"></i>
                <span>${item.name}</span>
                <span style="margin-left: auto; font-size: 12px; color: ${passed ? '#10b981' : '#ef4444'};">${passed ? 'OK' : 'FAIL'}</span>
            </div>
        `;
        resultsDiv.innerHTML = resultsHtml;
    }

    resultsHtml += `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center;">
            <button onclick="document.getElementById('system-check-modal').remove()" style="padding: 10px 24px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Done
            </button>
        </div>
    `;
    resultsDiv.innerHTML = resultsHtml;
}

// Quick Action: Clear Cache
window.clearAppCache = function() {
    if (confirm('This will clear all local cache and stored preferences. You may need to log in again. Continue?')) {
        localStorage.clear();
        sessionStorage.clear();
        showNotification('Cache cleared successfully! Refreshing...', 'success');
        setTimeout(() => window.location.reload(), 1500);
    }
}

// Quick Action: Export Report
window.exportSystemReport = function() {
    const report = {
        title: 'Ascendance Hub System Report',
        generatedAt: new Date().toISOString(),
        stats: {
            totalLines: 33726,
            jsLines: 25263,
            cssLines: 6259,
            htmlLines: 1504,
            configLines: 700,
            totalModules: 27,
            totalFiles: 20,
            gitCommits: 231,
            projectStart: 'December 9, 2025'
        },
        modules: window.projectModules?.map(m => ({
            name: m.name,
            version: m.version,
            status: m.status,
            linesOfCode: m.linesOfCode
        })) || [],
        browser: navigator.userAgent,
        screenSize: `${window.innerWidth}x${window.innerHeight}`
    };

    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ascendance-hub-report-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showNotification('Report exported successfully!', 'success');
}

// Quick Action: Show Recent Activity
window.showRecentActivity = function() {
    const activityModal = document.createElement('div');
    activityModal.id = 'activity-modal';
    activityModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    activityModal.onmousedown = (e) => { if (e.target === activityModal) activityModal.remove(); };

    // Get current user
    const user = typeof getCurrentUser === 'function' ? getCurrentUser() : { name: 'Unknown' };
    const now = new Date();

    const activities = [
        { icon: 'fa-right-to-bracket', color: '#10b981', text: `${user.name} logged in`, time: 'Just now' },
        { icon: 'fa-eye', color: '#3b82f6', text: 'Viewed Project Analytics', time: 'Just now' },
        { icon: 'fa-code', color: '#8b5cf6', text: 'System initialized', time: formatTimeAgo(now) },
        { icon: 'fa-database', color: '#f59e0b', text: 'Firebase connected', time: formatTimeAgo(now) },
        { icon: 'fa-shield-halved', color: '#10b981', text: 'Security check passed', time: formatTimeAgo(now) }
    ];

    const activitiesHtml = activities.map(a => `
        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px;">
            <div style="width: 36px; height: 36px; background: ${a.color}20; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <i class="fas ${a.icon}" style="color: ${a.color}; font-size: 14px;"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-size: 14px;">${a.text}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${a.time}</div>
            </div>
        </div>
    `).join('');

    activityModal.innerHTML = `
        <div style="background: var(--bg-primary); border-radius: 20px; max-width: 480px; width: 100%; max-height: 80vh; overflow: hidden; animation: modalSlideIn 0.3s ease;">
            <div style="padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;"><i class="fas fa-clock-rotate-left" style="color: var(--accent-primary); margin-right: 8px;"></i> Recent Activity</h3>
                <button onclick="document.getElementById('activity-modal').remove()" style="background: none; border: none; cursor: pointer; padding: 8px;">
                    <i class="fas fa-times" style="color: var(--text-muted);"></i>
                </button>
            </div>
            <div style="padding: 16px; max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
                ${activitiesHtml}
            </div>
        </div>
    `;
    document.body.appendChild(activityModal);
}

function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    return `${Math.floor(hours / 24)}d ago`;
}

// Store Locations Modal for Geofencing Configuration
window.openStoreLocationsModal = function() {
    const existingModal = document.getElementById('store-locations-modal');
    if (existingModal) existingModal.remove();

    // Get current store locations from config
    const storeLocations = window.STORE_LOCATIONS || {};
    const geofenceConfig = window.GEOFENCE_CONFIG || { enabled: true, strictMode: false, defaultRadius: 100 };

    // Build store rows HTML
    const storeRows = Object.entries(storeLocations).map(([key, store]) => `
        <div class="store-location-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 80px auto; gap: 10px; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 10px;">
            <div>
                <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Store</label>
                <span style="font-weight: 600; font-size: 13px;">${store.name || key}</span>
            </div>
            <div>
                <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Latitude</label>
                <input type="number" step="0.0001" value="${store.latitude || ''}"
                    data-store="${key}" data-field="latitude"
                    style="width: 100%; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 12px;"
                    placeholder="32.8934">
            </div>
            <div>
                <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Longitude</label>
                <input type="number" step="0.0001" value="${store.longitude || ''}"
                    data-store="${key}" data-field="longitude"
                    style="width: 100%; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 12px;"
                    placeholder="-117.1489">
            </div>
            <div>
                <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Radius (m)</label>
                <input type="number" value="${store.radius || 100}"
                    data-store="${key}" data-field="radius"
                    style="width: 100%; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 12px;"
                    placeholder="100">
            </div>
            <div>
                <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">&nbsp;</label>
                <button onclick="getStoreCurrentLocation('${key}')"
                    style="padding: 8px 12px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;"
                    title="Use current location">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
        </div>
    `).join('');

    const modal = document.createElement('div');
    modal.id = 'store-locations-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    modal.onmousedown = (e) => { if (e.target === modal) modal.remove(); };

    modal.innerHTML = `
        <div style="background: var(--bg-primary); border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow: hidden; animation: modalSlideIn 0.3s ease; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-map-marker-alt" style="color: #ec4899;"></i> Store Locations (Geofencing)
                </h3>
                <button onclick="document.getElementById('store-locations-modal').remove()" style="background: none; border: none; cursor: pointer; padding: 8px; opacity: 0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                    <i class="fas fa-times" style="color: var(--text-muted);"></i>
                </button>
            </div>
            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                <!-- Geofence Settings -->
                <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-secondary);">
                        <i class="fas fa-cog" style="margin-right: 8px;"></i>Geofence Settings
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="geofence-enabled" ${geofenceConfig.enabled ? 'checked' : ''}
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 13px;">Enable Geofencing</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="geofence-strict" ${geofenceConfig.strictMode ? 'checked' : ''}
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 13px;">Strict Mode (Block off-site clock-ins)</span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 13px;">Default Radius:</label>
                            <input type="number" id="geofence-default-radius" value="${geofenceConfig.defaultRadius || 100}"
                                style="width: 70px; padding: 6px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 12px;">
                            <span style="font-size: 12px; color: var(--text-muted);">meters</span>
                        </div>
                    </div>
                </div>

                <!-- Store Locations -->
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-secondary);">
                    <i class="fas fa-store" style="margin-right: 8px;"></i>Store Coordinates
                </h4>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                    Set GPS coordinates for each store. Use the <i class="fas fa-crosshairs"></i> button to use your current location.
                </p>
                <div id="store-locations-list">
                    ${storeRows}
                </div>
            </div>
            <div style="padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="document.getElementById('store-locations-modal').remove()"
                    style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary);">
                    Cancel
                </button>
                <button onclick="saveStoreLocations()"
                    style="padding: 10px 20px; background: linear-gradient(135deg, #ec4899, #db2777); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 600;">
                    <i class="fas fa-save" style="margin-right: 6px;"></i>Save Locations
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Get current location for a specific store input
window.getStoreCurrentLocation = async function(storeKey) {
    try {
        showNotification('Getting current location...', 'info');

        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        });

        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        // Find and update the inputs
        const latInput = document.querySelector(`input[data-store="${storeKey}"][data-field="latitude"]`);
        const lonInput = document.querySelector(`input[data-store="${storeKey}"][data-field="longitude"]`);

        if (latInput) latInput.value = lat.toFixed(6);
        if (lonInput) lonInput.value = lon.toFixed(6);

        showNotification(`Location set: ${lat.toFixed(4)}, ${lon.toFixed(4)}`, 'success');
    } catch (error) {
        console.error('Geolocation error:', error);
        showNotification('Could not get location. Please enable GPS.', 'error');
    }
}

// Save store locations to Firebase and localStorage
window.saveStoreLocations = async function() {
    try {
        // Collect all store location data from inputs
        const storeLocations = {};
        const rows = document.querySelectorAll('.store-location-row');

        rows.forEach(row => {
            const latInput = row.querySelector('input[data-field="latitude"]');
            const lonInput = row.querySelector('input[data-field="longitude"]');
            const radiusInput = row.querySelector('input[data-field="radius"]');

            if (latInput && lonInput) {
                const storeKey = latInput.dataset.store;
                const originalStore = window.STORE_LOCATIONS?.[storeKey] || {};

                storeLocations[storeKey] = {
                    name: originalStore.name || storeKey,
                    latitude: parseFloat(latInput.value) || 0,
                    longitude: parseFloat(lonInput.value) || 0,
                    radius: parseInt(radiusInput?.value) || 100
                };
            }
        });

        // Collect geofence config
        const geofenceConfig = {
            enabled: document.getElementById('geofence-enabled')?.checked ?? true,
            strictMode: document.getElementById('geofence-strict')?.checked ?? false,
            defaultRadius: parseInt(document.getElementById('geofence-default-radius')?.value) || 100,
            recordLocationAlways: true
        };

        // Save to Firebase
        try {
            const db = firebase.firestore();
            const settingsCollection = window.FIREBASE_COLLECTIONS?.settings || 'settings';

            // Save store locations
            await db.collection(settingsCollection).doc('storeLocations').set({
                locations: storeLocations,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: getCurrentUser()?.name || 'Unknown'
            });

            // Save geofence config
            await db.collection(settingsCollection).doc('geofenceConfig').set({
                config: geofenceConfig,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: getCurrentUser()?.name || 'Unknown'
            });

            console.log('‚úÖ Store locations saved to Firebase');
        } catch (firebaseError) {
            console.error('Firebase save error:', firebaseError);
            // Continue to save locally even if Firebase fails
        }

        // Also save to localStorage as backup/cache
        localStorage.setItem('store_locations', JSON.stringify(storeLocations));
        localStorage.setItem('geofence_config', JSON.stringify(geofenceConfig));

        // Update window objects immediately
        window.STORE_LOCATIONS = storeLocations;
        window.GEOFENCE_CONFIG = geofenceConfig;

        showNotification('Store locations saved successfully!', 'success');
        document.getElementById('store-locations-modal')?.remove();

    } catch (error) {
        console.error('Error saving store locations:', error);
        showNotification('Error saving locations. Please try again.', 'error');
    }
}

// Load saved store locations from Firebase (with localStorage fallback)
window.loadSavedStoreLocations = async function() {
    try {
        // First, try to load from localStorage as quick cache
        const cachedLocations = localStorage.getItem('store_locations');
        const cachedGeofenceConfig = localStorage.getItem('geofence_config');

        if (cachedLocations) {
            const locations = JSON.parse(cachedLocations);
            window.STORE_LOCATIONS = { ...window.STORE_LOCATIONS, ...locations };
        }

        if (cachedGeofenceConfig) {
            window.GEOFENCE_CONFIG = JSON.parse(cachedGeofenceConfig);
        }

        // Then try to load from Firebase (will override cache if successful)
        try {
            // Wait a moment for Firebase to initialize
            await new Promise(resolve => setTimeout(resolve, 1000));

            if (typeof firebase !== 'undefined' && firebase.firestore) {
                const db = firebase.firestore();
                const settingsCollection = window.FIREBASE_COLLECTIONS?.settings || 'settings';

                // Load store locations
                const locationsDoc = await db.collection(settingsCollection).doc('storeLocations').get();
                if (locationsDoc.exists) {
                    const data = locationsDoc.data();
                    if (data.locations) {
                        window.STORE_LOCATIONS = { ...window.STORE_LOCATIONS, ...data.locations };
                        // Update local cache
                        localStorage.setItem('store_locations', JSON.stringify(data.locations));
                        console.log('‚úÖ Store locations loaded from Firebase');
                    }
                }

                // Load geofence config
                const configDoc = await db.collection(settingsCollection).doc('geofenceConfig').get();
                if (configDoc.exists) {
                    const data = configDoc.data();
                    if (data.config) {
                        window.GEOFENCE_CONFIG = data.config;
                        // Update local cache
                        localStorage.setItem('geofence_config', JSON.stringify(data.config));
                        console.log('‚úÖ Geofence config loaded from Firebase');
                    }
                }
            }
        } catch (firebaseError) {
            console.warn('Could not load from Firebase, using cached data:', firebaseError.message);
        }
    } catch (error) {
        console.error('Error loading saved store locations:', error);
    }
}

// Load saved locations on page load
if (typeof window !== 'undefined') {
    // Load immediately from cache
    window.loadSavedStoreLocations();
}

// OpenAI API Settings Modal
window.openOpenAIAPISettings = function() {
    const existingModal = document.getElementById('openai-api-settings-modal');
    if (existingModal) existingModal.remove();

    // Get stored API key (masked for display)
    const storedKey = localStorage.getItem('openai_api_key') || '';
    const maskedKey = storedKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + storedKey.slice(-8) : '';
    const hasCustomKey = storedKey.length > 0;
    const usingDefault = !hasCustomKey;

    const modal = document.createElement('div');
    modal.id = 'openai-api-settings-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    modal.onmousedown = (e) => { if (e.target === modal) modal.remove(); };

    modal.innerHTML = `
        <div style="background: var(--bg-primary); border-radius: 16px; max-width: 420px; width: 100%; overflow: hidden; animation: modalSlideIn 0.3s ease; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-key" style="color: #10b981;"></i> OpenAI API Configuration
                </h3>
                <button onclick="document.getElementById('openai-api-settings-modal').remove()" style="background: none; border: none; cursor: pointer; padding: 8px; opacity: 0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                    <i class="fas fa-times" style="color: var(--text-muted);"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">OpenAI API Key</label>
                    <div style="position: relative;">
                        <input type="password" id="openai-api-key-input" placeholder="${hasCustomKey ? maskedKey : 'Using default key...'}"
                            style="width: 100%; padding: 12px 40px 12px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 14px; font-family: monospace; box-sizing: border-box;"
                            onfocus="this.placeholder='sk-...'"
                            onblur="if(!this.value) this.placeholder='${hasCustomKey ? maskedKey : 'Using default key...'}'">
                        <button onclick="toggleOpenAIKeyVisibility()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 4px;">
                            <i id="openai-key-toggle-icon" class="fas fa-eye" style="color: var(--text-muted); font-size: 14px;"></i>
                        </button>
                    </div>
                    <p style="margin: 8px 0 0 0; font-size: 11px; color: var(--text-muted);">
                        ${usingDefault ? '<i class="fas fa-check-circle" style="color: #10b981;"></i> Using default API key (ready to use)' : '<i class="fas fa-check-circle" style="color: #10b981;"></i> Custom API key configured'}
                    </p>
                </div>
                <div style="display: flex; gap: 10px;">
                    ${hasCustomKey ? `
                        <button onclick="clearOpenAIKey()" style="flex: 1; padding: 12px; background: var(--bg-secondary); border: 1px solid #ef4444; color: #ef4444; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.1)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <i class="fas fa-undo"></i> Use Default
                        </button>
                    ` : ''}
                    <button onclick="saveOpenAIKey()" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='none'">
                        <i class="fas fa-save"></i> Save Key
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

window.toggleOpenAIKeyVisibility = function() {
    const input = document.getElementById('openai-api-key-input');
    const icon = document.getElementById('openai-key-toggle-icon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

window.saveOpenAIKey = function() {
    const input = document.getElementById('openai-api-key-input');
    const key = input.value.trim();

    if (!key) {
        showNotification('Please enter an API key', 'error');
        return;
    }

    if (!key.startsWith('sk-')) {
        showNotification('Invalid API key format', 'error');
        return;
    }

    localStorage.setItem('openai_api_key', key);
    showNotification('OpenAI API key saved successfully', 'success');
    document.getElementById('openai-api-settings-modal').remove();
}

window.clearOpenAIKey = function() {
    if (confirm('Are you sure you want to remove the OpenAI API key?')) {
        localStorage.removeItem('openai_api_key');
        showNotification('OpenAI API key removed', 'success');
        document.getElementById('openai-api-settings-modal').remove();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI PROVIDER SETTINGS MODAL (OpenAI GPT-4)
// Firebase Cloud Storage - No localStorage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openAIProvidersSettings = async function() {
    const existingModal = document.getElementById('ai-providers-settings-modal');
    if (existingModal) existingModal.remove();

    // Show loading state while fetching from Firebase
    const loadingModal = document.createElement('div');
    loadingModal.id = 'ai-providers-settings-modal';
    loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    loadingModal.innerHTML = `
        <div style="background: var(--bg-primary); border-radius: 16px; padding: 40px; text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #8b5cf6; margin-bottom: 16px;"></i>
            <p style="margin: 0; color: var(--text-secondary);">Loading API settings from cloud...</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    // Ensure Firebase settings are loaded
    if (typeof window.reloadFirebaseAPISettings === 'function') {
        await window.reloadFirebaseAPISettings();
    }

    // Get stored keys from Firebase (cloud-only)
    const keys = typeof window.getFirebaseAPIKeys === 'function' ? window.getFirebaseAPIKeys() : { openai_api_key: '', hasCustomOpenAIKey: false };
    const storedOpenAIKey = keys.openai_api_key || '';
    const maskedOpenAIKey = storedOpenAIKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + storedOpenAIKey.slice(-8) : '';
    const hasCustomOpenAIKey = keys.hasCustomOpenAIKey;

    // Remove loading modal
    loadingModal.remove();

    const modal = document.createElement('div');
    modal.id = 'ai-providers-settings-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
    modal.onmousedown = (e) => { if (e.target === modal) modal.remove(); };

    modal.innerHTML = `
        <div style="background: var(--bg-primary); border-radius: 16px; max-width: 500px; width: 100%; overflow: hidden; animation: modalSlideIn 0.3s ease; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1));">
                <h3 style="margin: 0; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-brain" style="color: #10b981;"></i> AI Provider Configuration
                    <span style="padding: 2px 8px; background: rgba(59,130,246,0.2); color: #3b82f6; border-radius: 6px; font-size: 9px; font-weight: 600;">
                        <i class="fas fa-cloud"></i> CLOUD
                    </span>
                </h3>
                <button onclick="document.getElementById('ai-providers-settings-modal').remove()" style="background: none; border: none; cursor: pointer; padding: 8px; opacity: 0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                    <i class="fas fa-times" style="color: var(--text-muted);"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <!-- OpenAI GPT-4 -->
                <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid rgba(16,185,129,0.3);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-robot" style="color: white; font-size: 14px;"></i>
                        </div>
                        <div>
                            <span style="font-weight: 600; font-size: 14px;">OpenAI GPT-4</span>
                            <span style="padding: 2px 8px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 6px; font-size: 9px; font-weight: 600; margin-left: 8px;">AI ENGINE</span>
                        </div>
                    </div>
                    <p style="margin: 0 0 12px 0; font-size: 12px; color: var(--text-secondary);">
                        Powers all AI features including Celeste AI, voice assistants, invoice scanning, and smart analysis.
                    </p>
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">OpenAI API Key</label>
                    <div style="position: relative;">
                        <input type="password" id="openai-provider-api-key-input" placeholder="${hasCustomOpenAIKey ? maskedOpenAIKey : 'Using default key...'}"
                            style="width: 100%; padding: 10px 40px 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 13px; font-family: monospace; box-sizing: border-box;"
                            onfocus="this.placeholder='sk-proj-...'"
                            onblur="if(!this.value) this.placeholder='${hasCustomOpenAIKey ? maskedOpenAIKey : 'Using default key...'}'">
                        <button onclick="toggleAPIKeyVisibility('openai')" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 4px;">
                            <i id="openai-provider-key-toggle-icon" class="fas fa-eye" style="color: var(--text-muted); font-size: 12px;"></i>
                        </button>
                    </div>
                    <p style="margin: 6px 0 0 0; font-size: 10px; color: var(--text-muted);">
                        <i class="fas fa-check-circle" style="color: #10b981;"></i> ${hasCustomOpenAIKey ? 'Custom key configured' : 'Default key pre-configured'}
                    </p>
                </div>

                <div style="padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 11px; color: var(--text-secondary);">
                        <i class="fas fa-cloud" style="color: #3b82f6;"></i>
                        API key is securely stored in Firebase Cloud. Changes sync instantly across all devices.
                    </p>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="save-api-keys-btn" onclick="saveAIProviderKeys()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='none'">
                        <i class="fas fa-cloud-upload-alt"></i> Save to Cloud
                    </button>
                    <button onclick="resetAIProviderKeys()" style="padding: 12px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='var(--border-color)'">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

window.toggleAPIKeyVisibility = function(provider) {
    const input = document.getElementById('openai-provider-api-key-input');
    const icon = document.getElementById('openai-provider-key-toggle-icon');
    if (input && icon) {
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }
}

window.saveAIProviderKeys = async function() {
    const openaiInput = document.getElementById('openai-provider-api-key-input');
    const openaiKey = openaiInput ? openaiInput.value.trim() : '';
    const saveBtn = document.getElementById('save-api-keys-btn');

    // Show saving state
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving to Cloud...';
    }

    // Validate OpenAI key format if provided
    if (openaiKey && !openaiKey.startsWith('sk-')) {
        showNotification('Invalid OpenAI API key format (should start with sk-)', 'error');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Save to Cloud';
        }
        return;
    }

    try {
        // Save to Firebase (cloud-only)
        if (typeof window.saveFirebaseAPIKeys === 'function') {
            if (openaiKey) {
                const success = await window.saveFirebaseAPIKeys(
                    undefined,  // Reserved for future use
                    openaiKey
                );

                if (success) {
                    showNotification('API key saved to cloud successfully!', 'success');
                    document.getElementById('ai-providers-settings-modal').remove();
                } else {
                    throw new Error('Firebase save returned false');
                }
            } else {
                showNotification('No changes made (enter a key to save)', 'info');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Save to Cloud';
                }
            }
        } else {
            throw new Error('Firebase API key functions not available');
        }
    } catch (error) {
        console.error('Error saving API key to Firebase:', error);
        showNotification('Failed to save to cloud. Please try again.', 'error');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Save to Cloud';
        }
    }
}

window.resetAIProviderKeys = async function() {
    if (confirm('Reset API key to its default value in the cloud?')) {
        try {
            if (typeof window.resetFirebaseAPIKeys === 'function') {
                const success = await window.resetFirebaseAPIKeys();
                if (success) {
                    showNotification('API keys reset to defaults in cloud', 'success');
                    document.getElementById('ai-providers-settings-modal').remove();
                } else {
                    throw new Error('Reset returned false');
                }
            } else {
                throw new Error('Firebase reset function not available');
            }
        } catch (error) {
            console.error('Error resetting API keys:', error);
            showNotification('Failed to reset keys. Please try again.', 'error');
        }
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI API KEY DEFAULTS (Shared across all AI features)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OpenAI GPT-4 (used by Celeste AI and all voice assistants)
const DEFAULT_OPENAI_KEY = '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';

// Initialize default API key in localStorage on app load
(function initializeDefaultAPIKey() {
    if (!localStorage.getItem('openai_api_key')) {
        localStorage.setItem('openai_api_key', DEFAULT_OPENAI_KEY);
    }
})();

window.getOpenAIKey = function() {
    return localStorage.getItem('openai_api_key') || DEFAULT_OPENAI_KEY;
}

// ========== REUSABLE VOICE ASSISTANT COMPONENT ==========
// This component can be added to any modal to provide voice-to-AI functionality
// Usage: VoiceAssistant.create('unique-id', { prompt: '...', onFill: (data) => {...} })

const VoiceAssistant = {
    instances: {},

    // Generate the HTML for the voice assistant UI
    getHTML: function(id, options = {}) {
        const title = options.title || 'AI Voice Assistant';
        const subtitle = options.subtitle || 'Describe and auto-fill form';
        const buttonColor = options.buttonColor || 'linear-gradient(135deg, #8b5cf6, #6366f1)';

        return `
            <div id="voice-assistant-${id}" class="voice-assistant-container" style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 36px; height: 36px; background: ${buttonColor}; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-wand-magic-sparkles" style="color: white; font-size: 14px;"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${title}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${subtitle}</div>
                        </div>
                    </div>
                    <button type="button" id="va-btn-${id}" onclick="VoiceAssistant.toggle('${id}')" style="padding: 10px 16px; background: ${buttonColor}; border: none; color: white; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(139,92,246,0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                        <i id="va-icon-${id}" class="fas fa-microphone"></i>
                        <span id="va-text-${id}" style="font-family: Outfit;">Start Recording</span>
                    </button>
                </div>
                <div id="va-status-${id}" style="display: none; margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px;"></div>
                <div id="va-transcript-${id}" style="display: none; margin-top: 10px; padding: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px;">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; font-weight: 600;">What you said:</div>
                    <div id="va-transcript-text-${id}" style="font-size: 13px; color: var(--text-primary); line-height: 1.5;"></div>
                </div>
            </div>
        `;
    },

    // Initialize a voice assistant instance
    init: function(id, options = {}) {
        this.instances[id] = {
            recognition: null,
            isRecording: false,
            transcript: '',
            stoppedByUser: false,
            prompt: options.prompt || '',
            systemPrompt: options.systemPrompt || 'You are a helpful assistant that extracts structured information from voice transcripts.',
            onFill: options.onFill || function() {},
            buttonColor: options.buttonColor || 'linear-gradient(135deg, #8b5cf6, #6366f1)',
            listeningText: options.listeningText || 'Listening... Speak now'
        };
    },

    // Toggle recording
    toggle: function(id) {
        const instance = this.instances[id];
        if (!instance) {
            console.error('Voice assistant instance not found:', id);
            return;
        }

        if (instance.isRecording) {
            this.stop(id);
        } else {
            this.start(id);
        }
    },

    // Start recording
    start: function(id) {
        const instance = this.instances[id];
        if (!instance) return;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            this.updateStatus(id, '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Voice recognition not supported. Try Chrome or Edge.</span>');
            return;
        }

        try {
            instance.recognition = new SpeechRecognition();
            instance.recognition.continuous = true;
            instance.recognition.interimResults = true;
            instance.recognition.lang = 'en-US';
            instance.recognition.maxAlternatives = 1;

            instance.transcript = '';
            instance.stoppedByUser = false;

            const btn = document.getElementById(`va-btn-${id}`);
            const icon = document.getElementById(`va-icon-${id}`);
            const text = document.getElementById(`va-text-${id}`);
            const transcriptDiv = document.getElementById(`va-transcript-${id}`);

            instance.recognition.onstart = () => {
                instance.isRecording = true;
                if (btn) btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                if (icon) icon.className = 'fas fa-stop';
                if (text) text.textContent = 'Stop Recording';
                if (transcriptDiv) transcriptDiv.style.display = 'none';
                this.updateStatus(id, `<i class="fas fa-circle" style="color: #ef4444; animation: pulse 1s infinite;"></i> <span style="color: var(--text-primary);">${instance.listeningText}</span>`);
            };

            instance.recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    instance.transcript += finalTranscript;
                }

                // Show real-time transcript
                const transcriptText = document.getElementById(`va-transcript-text-${id}`);
                if (transcriptDiv && transcriptText) {
                    transcriptDiv.style.display = 'block';
                    transcriptText.innerHTML = instance.transcript + '<span style="color: var(--text-muted); font-style: italic;">' + interimTranscript + '</span>';
                }
            };

            instance.recognition.onerror = (event) => {
                console.error('Voice recognition error:', event.error);
                if (event.error !== 'aborted' && event.error !== 'no-speech') {
                    this.updateStatus(id, `<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Error: ${event.error}. Try again.</span>`);
                }
            };

            instance.recognition.onend = () => {
                // If stopped by user, processing is handled in stop()
                if (instance.stoppedByUser) return;

                // Auto-restart if still recording (browser timeout)
                if (instance.isRecording) {
                    try {
                        instance.recognition.start();
                        return;
                    } catch (e) {
                        console.log('Could not restart recognition:', e);
                    }
                }
                this.resetUI(id);
            };

            instance.recognition.start();

        } catch (error) {
            console.error('Error starting voice recognition:', error);
            this.updateStatus(id, '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span style="color: var(--text-primary);">Could not start voice recording. Check microphone permissions.</span>');
        }
    },

    // Stop recording
    stop: function(id) {
        const instance = this.instances[id];
        if (!instance) return;

        instance.stoppedByUser = true;
        instance.isRecording = false;

        if (instance.recognition) {
            try {
                instance.recognition.stop();
            } catch (e) {
                console.log('Error stopping recognition:', e);
            }
        }

        // Reset UI immediately
        this.resetUI(id);

        // Process with AI if we have transcript
        if (instance.transcript.trim()) {
            this.updateStatus(id, '<i class="fas fa-spinner fa-spin" style="color: #8b5cf6;"></i> <span style="color: var(--text-primary);">Processing with AI...</span>');
            this.processWithAI(id, instance.transcript.trim());
        } else {
            this.updateStatus(id, '<i class="fas fa-info-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">No speech detected. Please try again.</span>');
        }
    },

    // Reset UI to initial state
    resetUI: function(id) {
        const instance = this.instances[id];
        if (!instance) return;

        instance.isRecording = false;
        const btn = document.getElementById(`va-btn-${id}`);
        const icon = document.getElementById(`va-icon-${id}`);
        const text = document.getElementById(`va-text-${id}`);

        if (btn) btn.style.background = instance.buttonColor;
        if (icon) icon.className = 'fas fa-microphone';
        if (text) text.textContent = 'Start Recording';
    },

    // Update status message
    updateStatus: function(id, html) {
        const statusDiv = document.getElementById(`va-status-${id}`);
        if (statusDiv) {
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = html;
        }
    },

    // Process transcript with AI
    processWithAI: async function(id, transcript) {
        const instance = this.instances[id];
        if (!instance) return;

        try {
            const apiKey = window.getOpenAIKey ? window.getOpenAIKey() : localStorage.getItem('openai_api_key');

            if (!apiKey) {
                this.updateStatus(id, '<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">No API key configured. Transcript captured but not processed.</span>');
                // Call onFill with just the transcript
                instance.onFill({ _transcript: transcript });
                return;
            }

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + apiKey
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    max_tokens: 1024,
                    messages: [
                        {
                            role: 'system',
                            content: instance.systemPrompt
                        },
                        {
                            role: 'user',
                            content: instance.prompt.replace('{transcript}', transcript)
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
            }

            const data = await response.json();
            const content = data.choices[0].message.content;

            // Parse JSON response
            let parsedData;
            try {
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    parsedData = JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error('No JSON found');
                }
            } catch (parseError) {
                console.error('Error parsing AI response:', content);
                this.updateStatus(id, '<i class="fas fa-check-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">Transcript captured. AI parsing failed.</span>');
                instance.onFill({ _transcript: transcript, _parseError: true });
                return;
            }

            // Call the onFill callback with parsed data
            parsedData._transcript = transcript;
            instance.onFill(parsedData);

            this.updateStatus(id, '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span style="color: var(--text-primary);">Form auto-filled! Review and save.</span>');

        } catch (error) {
            console.error('Error processing with AI:', error);
            this.updateStatus(id, `<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> <span style="color: var(--text-primary);">AI error: ${error.message}. Transcript captured.</span>`);
            instance.onFill({ _transcript: transcript, _error: error.message });
        }
    },

    // Cleanup an instance
    destroy: function(id) {
        const instance = this.instances[id];
        if (instance && instance.recognition) {
            try {
                instance.recognition.stop();
            } catch (e) {}
        }
        delete this.instances[id];
    }
};

// Make it globally available
window.VoiceAssistant = VoiceAssistant;

// ========== END REUSABLE VOICE ASSISTANT COMPONENT ==========

// Floating add button - simple scroll threshold approach
var FLOATING_ADD_SCROLL_THRESHOLD = 150; // pixels scrolled before buttons become fixed
var FLOATING_ADD_MOBILE_THRESHOLD = 50; // smaller threshold for mobile
var floatingAddScrollListener = null;
var floatingAddScrollTimeout = null;

function isMobileView() {
    return window.innerWidth <= 768;
}

function refreshFloatingAddButtons() {
    if (typeof document === 'undefined' || typeof window === 'undefined') return;

    // Clean up existing listener
    if (floatingAddScrollListener) {
        window.removeEventListener('scroll', floatingAddScrollListener);
        floatingAddScrollListener = null;
    }

    // Simple scroll listener - fix buttons when scrolled past threshold
    floatingAddScrollListener = () => {
        const scrollY = window.scrollY || window.pageYOffset;
        const isMobile = isMobileView();
        const threshold = isMobile ? FLOATING_ADD_MOBILE_THRESHOLD : FLOATING_ADD_SCROLL_THRESHOLD;
        const shouldFix = scrollY > threshold;

        document.querySelectorAll('.floating-add-btn').forEach(button => {
            if (shouldFix) {
                button.classList.add('is-fixed');
                // Add is-scrolling class during active scroll (mobile optimization)
                button.classList.add('is-scrolling');
                // En mobile, agregar clase especial para flotante
                if (isMobile) {
                    button.classList.add('is-floating-mobile');
                }
            } else {
                button.classList.remove('is-fixed');
                button.classList.remove('is-scrolling');
                button.classList.remove('is-floating-mobile');
            }
        });

        // Remove is-scrolling class after scroll stops (150ms delay)
        if (floatingAddScrollTimeout) {
            clearTimeout(floatingAddScrollTimeout);
        }
        floatingAddScrollTimeout = setTimeout(() => {
            document.querySelectorAll('.floating-add-btn.is-scrolling').forEach(button => {
                button.classList.remove('is-scrolling');
            });
        }, 150);
    };

    window.addEventListener('scroll', floatingAddScrollListener, { passive: true });

    // Initial update
    floatingAddScrollListener();
}

function updateFloatingButtonsVisibility() {
    // Trigger scroll handler to update visibility
    if (floatingAddScrollListener) {
        floatingAddScrollListener();
    }
}

function ensureFloatingAddButtonFallback() {
    // This function is no longer needed but kept for compatibility
    return;
}

// Add CSS animation for password toast
const pwdToastStyles = document.createElement('style');
pwdToastStyles.textContent = `
    @keyframes pwdSlideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes pwdSlideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    .password-item:hover {
        background: var(--bg-tertiary) !important;
    }
    .btn-icon:hover {
        background: var(--bg-tertiary) !important;
        transform: translateY(-1px);
    }
`;
document.head.appendChild(pwdToastStyles);

// =====================================================
// BARCODE LABELS MODULE
// =====================================================

function renderLabels() {
    const dashboard = document.querySelector('.dashboard');

    if (typeof renderLabelsPage === 'function') {
        dashboard.innerHTML = renderLabelsPage();
        // Initialize the labels module UI
        updateLabelQueueUI();
    } else {
        dashboard.innerHTML = `
            <div style="text-align: center; padding: 60px;">
                <i class="fas fa-exclamation-circle" style="font-size: 48px; color: var(--danger); margin-bottom: 16px;"></i>
                <h3>Labels Module Not Loaded</h3>
                <p style="color: var(--text-muted);">Please refresh the page to load the barcode labels module.</p>
            </div>
        `;
    }
}

// =====================================================
// LEASES MODULE
// =====================================================

let firebaseLeases = [];
let leaseSearchTerm = '';
let leaseStoreFilter = 'all';

const STORE_LOCATIONS = [
    { id: 'miramar', name: 'Miramar', type: 'vape' },
    { id: 'morena', name: 'Morena', type: 'vape' },
    { id: 'kearny-mesa', name: 'Kearny Mesa', type: 'vape' },
    { id: 'chula-vista', name: 'Chula Vista', type: 'vape' },
    { id: 'north-park', name: 'North Park', type: 'vape' },
    { id: 'miramar-wine-liquor', name: 'Miramar Wine & Liquor', type: 'liquor' }
];

async function initLeases() {
    try {
        const db = firebase.firestore();
        const snapshot = await db.collection('leases').orderBy('storeName', 'asc').get();
        firebaseLeases = snapshot.docs.map(doc => ({
            firestoreId: doc.id,
            ...doc.data()
        }));
    } catch (error) {
        console.error('Error loading leases:', error);
        firebaseLeases = [];
    }
}

async function renderLeases() {
    const dashboard = document.querySelector('.dashboard');
    const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

    // Load leases from Firebase
    try {
        await initLeases();
    } catch (error) {
        console.error('Error initializing leases:', error);
    }

    const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');

    // Calculate summary stats
    const today = new Date();
    const activeLeases = firebaseLeases.filter(l => {
        if (!l.endDate) return true;
        const end = new Date(l.endDate);
        const days = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
        return days > 90;
    });
    const expiringLeases = firebaseLeases.filter(l => {
        if (!l.endDate) return false;
        const end = new Date(l.endDate);
        const days = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
        return days > 0 && days <= 90;
    });
    const expiredLeases = firebaseLeases.filter(l => {
        if (!l.endDate) return false;
        const end = new Date(l.endDate);
        return end < today;
    });

    // Calculate total monthly rent
    const totalMonthlyRent = firebaseLeases.reduce((sum, l) => sum + (parseFloat(l.monthlyRent) || 0), 0);

    dashboard.innerHTML = `
        <!-- Leases Header Banner -->
        <div style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%); border-radius: 16px; padding: 32px; margin-bottom: 24px; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; right: 0; width: 300px; height: 100%; opacity: 0.1;">
                <i class="fas fa-file-contract" style="font-size: 200px; position: absolute; right: -30px; top: 50%; transform: translateY(-50%); color: white;"></i>
            </div>
            <div style="position: relative; z-index: 1;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <h1 style="font-size: 28px; font-weight: 700; color: white; margin: 0 0 8px 0;">
                            <i class="fas fa-file-contract" style="margin-right: 12px;"></i>Lease Contracts
                        </h1>
                        <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 15px;">Manage all store lease agreements and contracts</p>
                    </div>
                    ${isAdmin ? `
                        <button class="btn-primary" onclick="openAddLeaseModal()" style="background: white; color: #4c1d95; border: none; font-weight: 600;">
                            <i class="fas fa-plus"></i> Add Lease
                        </button>
                    ` : ''}
                </div>
                <div style="display: flex; gap: 32px; margin-top: 24px; flex-wrap: wrap;">
                    <div>
                        <div style="font-size: 32px; font-weight: 700; color: white;">${firebaseLeases.length}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.6);">Total Leases</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: 700; color: #4ade80;">${activeLeases.length}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.6);">Active</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: 700; color: #fbbf24;">${expiringLeases.length}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.6);">Expiring Soon</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: 700; color: #f87171;">${expiredLeases.length}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.6);">Expired</div>
                    </div>
                    <div style="border-left: 1px solid rgba(255,255,255,0.2); padding-left: 32px;">
                        <div style="font-size: 32px; font-weight: 700; color: white;">$${totalMonthlyRent.toLocaleString()}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.6);">Monthly Rent Total</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="license-stores-grid">
            ${STORE_LOCATIONS.map(store => {
                const storeLeases = firebaseLeases.filter(l => l.storeId === store.id);
                const isLiquor = store.type === 'liquor';
                return `
                    <div class="license-store-zone" data-store="${store.id}">
                        <div class="license-store-header">
                            <div class="license-store-title">
                                <i class="fas ${isLiquor ? 'fa-wine-bottle' : 'fa-store'}"></i>
                                <span>${store.name}</span>
                            </div>
                            <div class="license-store-count">
                                <span class="count-badge">${storeLeases.length}</span>
                            </div>
                        </div>
                        <div class="license-drop-area">
                            ${storeLeases.length === 0 ? `
                                <div class="license-empty-state">
                                    <i class="fas fa-file-contract"></i>
                                    <span>No lease contracts</span>
                                </div>
                            ` : ''}
                            ${storeLeases.map(lease => {
                                const hasPdf = lease.pdfUrl;
                                // Calculate status
                                let status = 'valid';
                                let statusTitle = 'Active';
                                if (lease.endDate) {
                                    const endDate = new Date(lease.endDate);
                                    const daysLeft = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                                    if (daysLeft < 0) {
                                        status = 'expired';
                                        statusTitle = 'Expired';
                                    } else if (daysLeft <= 90) {
                                        status = 'expiring';
                                        statusTitle = 'Expiring Soon';
                                    }
                                }
                                return `
                                <div class="license-item" style="cursor: pointer;" onclick="viewLeaseDetails('${lease.firestoreId}')">
                                    <div class="license-item-header">
                                        <div class="license-item-name">
                                            <i class="fas fa-file-contract"></i>
                                            <span>Lease Contract</span>
                                        </div>
                                        <div class="license-item-status">
                                            <div class="status-dot ${status}" title="${statusTitle}"></div>
                                        </div>
                                    </div>
                                    <div style="padding: 8px 12px; font-size: 12px; color: var(--text-muted);">
                                        ${lease.landlord ? `<div><i class="fas fa-user-tie" style="width: 14px;"></i> ${lease.landlord}</div>` : ''}
                                        ${lease.monthlyRent ? `<div><i class="fas fa-dollar-sign" style="width: 14px;"></i> $${parseFloat(lease.monthlyRent).toLocaleString()}/mo</div>` : ''}
                                    </div>
                                    <div class="license-item-footer">
                                        <span class="license-expires">
                                            <i class="fas fa-calendar"></i>
                                            ${lease.endDate ? formatLeaseDate(lease.endDate) : 'No end date'}
                                        </span>
                                        <div class="license-item-actions" style="pointer-events: auto;">
                                            ${hasPdf ? `
                                                <a href="${lease.pdfUrl}" target="_blank" class="btn-icon-sm" onclick="event.stopPropagation();" title="View PDF" style="pointer-events: auto;">
                                                    <i class="fas fa-file-pdf"></i>
                                                </a>
                                            ` : ''}
                                            ${isAdmin ? `
                                                <button class="btn-icon-sm" onclick="event.stopPropagation(); deleteLease('${lease.firestoreId}')" title="Delete" style="pointer-events: auto;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function formatLeaseDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function renderLeasesList() {
    let filteredLeases = firebaseLeases;

    // Apply store filter
    if (leaseStoreFilter !== 'all') {
        filteredLeases = filteredLeases.filter(l => l.storeId === leaseStoreFilter);
    }

    // Apply search filter
    if (leaseSearchTerm) {
        const term = leaseSearchTerm.toLowerCase();
        filteredLeases = filteredLeases.filter(l =>
            l.storeName.toLowerCase().includes(term) ||
            (l.address && l.address.toLowerCase().includes(term)) ||
            (l.landlord && l.landlord.toLowerCase().includes(term))
        );
    }

    const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
    const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');

    if (filteredLeases.length === 0) {
        return `
            <div class="card">
                <div class="card-body" style="text-align: center; padding: 60px 20px;">
                    <i class="fas fa-file-contract" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px; display: block;"></i>
                    <div style="font-size: 16px; color: var(--text-muted);">No leases found</div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">
                        ${isAdmin ? 'Click "Add Lease" to add a new lease contract' : 'No lease contracts have been added yet'}
                    </div>
                </div>
            </div>
        `;
    }

    const storeColors = {
        'miramar': '#6366f1',
        'morena': '#8b5cf6',
        'kearny-mesa': '#3b82f6',
        'chula-vista': '#10b981',
        'north-park': '#f59e0b',
        'miramar-wine-liquor': '#ef4444'
    };

    return `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px;">
            ${filteredLeases.map(lease => {
                const storeColor = storeColors[lease.storeId] || 'var(--accent-primary)';
                const storeInfo = STORE_LOCATIONS.find(s => s.id === lease.storeId);
                const isLiquor = storeInfo && storeInfo.type === 'liquor';

                // Calculate lease status
                const today = new Date();
                const endDate = lease.endDate ? new Date(lease.endDate) : null;
                const daysUntilEnd = endDate ? Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)) : null;
                let statusBadge = '';
                if (daysUntilEnd !== null) {
                    if (daysUntilEnd < 0) {
                        statusBadge = '<span class="badge" style="background: #ef4444;">Expired</span>';
                    } else if (daysUntilEnd <= 90) {
                        statusBadge = '<span class="badge" style="background: #f59e0b;">Expiring Soon</span>';
                    } else {
                        statusBadge = '<span class="badge" style="background: #10b981;">Active</span>';
                    }
                }

                return `
                <div class="card" style="cursor: pointer; transition: all 0.2s; border-left: 4px solid ${storeColor};" onclick="viewLeaseDetails('${lease.firestoreId}')">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="display: flex; align-items: start; gap: 14px; flex: 1;">
                                <div style="width: 56px; height: 56px; border-radius: 10px; background: linear-gradient(135deg, ${storeColor}, ${storeColor}88); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas ${isLiquor ? 'fa-wine-bottle' : 'fa-store'}" style="font-size: 22px; color: white;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 6px; color: var(--text-primary);">
                                        ${lease.storeName}
                                    </h3>
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        ${statusBadge}
                                        <span class="badge" style="background: ${isLiquor ? '#a855f7' : '#6366f1'};">
                                            ${isLiquor ? 'Liquor Store' : 'Vape Shop'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--text-muted); font-size: 14px;"></i>
                        </div>

                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div style="display: grid; gap: 8px;">
                                ${lease.address ? `
                                    <div style="display: flex; align-items: start; gap: 8px; font-size: 14px;">
                                        <i class="fas fa-map-marker-alt" style="width: 16px; color: var(--text-muted); margin-top: 2px;"></i>
                                        <span style="color: var(--text-secondary);">${lease.address}</span>
                                    </div>
                                ` : ''}
                                ${lease.landlord ? `
                                    <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                        <i class="fas fa-user-tie" style="width: 16px; color: var(--text-muted);"></i>
                                        <span style="color: var(--text-secondary);">${lease.landlord}</span>
                                    </div>
                                ` : ''}
                                ${lease.monthlyRent ? `
                                    <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                        <i class="fas fa-dollar-sign" style="width: 16px; color: var(--text-muted);"></i>
                                        <span style="color: var(--text-secondary);">$${parseFloat(lease.monthlyRent).toLocaleString()}/month</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px; color: var(--text-muted);">
                                ${lease.startDate ? `${formatDate(lease.startDate)}` : 'No start date'}
                                ${lease.endDate ? ` - ${formatDate(lease.endDate)}` : ''}
                            </div>
                            ${lease.pdfUrl ? `
                                <div style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--accent-primary);">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>PDF</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('')}
        </div>
    `;
}

function searchLeases(searchTerm) {
    leaseSearchTerm = searchTerm;
    const leasesList = document.getElementById('leases-list');
    if (leasesList) {
        leasesList.innerHTML = renderLeasesList();
    }
}

function filterLeasesByStore(storeId) {
    leaseStoreFilter = storeId;
    const leasesList = document.getElementById('leases-list');
    if (leasesList) {
        leasesList.innerHTML = renderLeasesList();
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function closeLeaseModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.remove(), 300);
    }
}

// Add lease modal styles if not exists
if (!document.getElementById('lease-modal-styles')) {
    const leaseModalStyles = document.createElement('style');
    leaseModalStyles.id = 'lease-modal-styles';
    leaseModalStyles.textContent = `
        .lease-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .lease-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .lease-modal-overlay .lease-modal {
            background: var(--bg-card, #1e1e2e);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        .lease-modal-overlay.active .lease-modal {
            transform: scale(1);
        }
        .lease-modal .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color, #333);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lease-modal .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary, #fff);
        }
        .lease-modal .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted, #888);
            padding: 0;
            line-height: 1;
        }
        .lease-modal .modal-close:hover {
            color: var(--text-primary, #fff);
        }
        .lease-modal .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        .lease-modal .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color, #333);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
    `;
    document.head.appendChild(leaseModalStyles);
}

function openAddLeaseModal() {
    const modal = document.createElement('div');
    modal.className = 'lease-modal-overlay';
    modal.id = 'add-lease-modal';
    modal.innerHTML = `
        <div class="lease-modal">
            <div class="modal-header">
                <h3>Add New Lease</h3>
                <button class="modal-close" onclick="closeLeaseModal('add-lease-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Store Location *</label>
                    <select class="form-input" id="lease-store" required>
                        <option value="">Select Store</option>
                        ${STORE_LOCATIONS.map(store => `
                            <option value="${store.id}">${store.name}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Property Address</label>
                    <input type="text" class="form-input" id="lease-address" placeholder="Full property address">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Lease Start Date</label>
                        <input type="date" class="form-input" id="lease-start-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lease End Date</label>
                        <input type="date" class="form-input" id="lease-end-date">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Monthly Rent ($)</label>
                        <input type="number" class="form-input" id="lease-rent" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Security Deposit ($)</label>
                        <input type="number" class="form-input" id="lease-deposit" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Landlord / Property Manager</label>
                    <input type="text" class="form-input" id="lease-landlord" placeholder="Name of landlord or property management company">
                </div>
                <div class="form-group">
                    <label class="form-label">Landlord Phone</label>
                    <input type="tel" class="form-input" id="lease-landlord-phone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label class="form-label">Landlord Email</label>
                    <input type="email" class="form-input" id="lease-landlord-email" placeholder="landlord@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Lease Contract (PDF)</label>
                    <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;"
                         id="pdf-upload-area"
                         onclick="document.getElementById('lease-pdf-input').click()">
                        <i class="fas fa-file-pdf" style="font-size: 32px; color: var(--text-muted); margin-bottom: 8px;"></i>
                        <div style="color: var(--text-secondary); font-size: 14px;">Click to upload PDF</div>
                        <div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">Max file size: 10MB</div>
                        <input type="file" id="lease-pdf-input" accept=".pdf" style="display: none;" onchange="handleLeasePdfSelect(this)">
                    </div>
                    <div id="pdf-file-name" style="margin-top: 8px; font-size: 14px; color: var(--accent-primary); display: none;">
                        <i class="fas fa-check-circle"></i> <span></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="lease-notes" rows="3" placeholder="Additional notes about this lease..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeLeaseModal('add-lease-modal')">Cancel</button>
                <button class="btn-primary" onclick="saveLease()">
                    <i class="fas fa-save"></i> Save Lease
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('active'), 10);
}

let selectedLeasePdf = null;

function handleLeasePdfSelect(input) {
    const file = input.files[0];
    if (file) {
        if (file.size > 10 * 1024 * 1024) {
            showToast('File too large. Maximum size is 10MB.', 'error');
            return;
        }
        if (file.type !== 'application/pdf') {
            showToast('Please select a PDF file.', 'error');
            return;
        }
        selectedLeasePdf = file;
        const fileName = document.getElementById('pdf-file-name');
        fileName.style.display = 'block';
        fileName.querySelector('span').textContent = file.name;
        document.getElementById('pdf-upload-area').style.borderColor = 'var(--accent-primary)';
        document.getElementById('pdf-upload-area').style.background = 'rgba(99, 102, 241, 0.1)';
    }
}

async function uploadLeasePdf(file, leaseId) {
    try {
        const storage = firebase.storage();
        const fileRef = storage.ref(`leases/${leaseId}/${file.name}`);
        const snapshot = await fileRef.put(file);
        const downloadUrl = await snapshot.ref.getDownloadURL();
        return downloadUrl;
    } catch (error) {
        console.error('Error uploading PDF:', error);
        throw error;
    }
}

async function saveLease() {
    const db = firebase.firestore();
    const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

    const storeId = document.getElementById('lease-store').value;
    if (!storeId) {
        showToast('Please select a store location', 'error');
        return;
    }

    const store = STORE_LOCATIONS.find(s => s.id === storeId);

    const leaseData = {
        storeId: storeId,
        storeName: store.name,
        storeType: store.type,
        address: document.getElementById('lease-address').value.trim(),
        startDate: document.getElementById('lease-start-date').value,
        endDate: document.getElementById('lease-end-date').value,
        monthlyRent: document.getElementById('lease-rent').value,
        securityDeposit: document.getElementById('lease-deposit').value,
        landlord: document.getElementById('lease-landlord').value.trim(),
        landlordPhone: document.getElementById('lease-landlord-phone').value.trim(),
        landlordEmail: document.getElementById('lease-landlord-email').value.trim(),
        notes: document.getElementById('lease-notes').value.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser?.uid || 'unknown'
    };

    try {
        // Save lease to Firestore first
        const docRef = await db.collection('leases').add(leaseData);

        // Upload PDF if selected
        if (selectedLeasePdf) {
            showToast('Uploading PDF...', 'info');
            const pdfUrl = await uploadLeasePdf(selectedLeasePdf, docRef.id);
            await db.collection('leases').doc(docRef.id).update({
                pdfUrl: pdfUrl,
                pdfFileName: selectedLeasePdf.name
            });
        }

        selectedLeasePdf = null;
        closeLeaseModal('add-lease-modal');
        showToast('Lease saved successfully!', 'success');
        renderLeases();
    } catch (error) {
        console.error('Error saving lease:', error);
        showToast('Error saving lease. Please try again.', 'error');
    }
}

async function viewLeaseDetails(leaseId) {
    const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

    const lease = firebaseLeases.find(l => l.firestoreId === leaseId);
    if (!lease) {
        showToast('Lease not found', 'error');
        return;
    }

    const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');
    const storeInfo = STORE_LOCATIONS.find(s => s.id === lease.storeId);
    const isLiquor = storeInfo && storeInfo.type === 'liquor';

    // Calculate lease status
    const today = new Date();
    const endDate = lease.endDate ? new Date(lease.endDate) : null;
    const daysUntilEnd = endDate ? Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)) : null;
    let statusBadge = '';
    let statusText = '';
    if (daysUntilEnd !== null) {
        if (daysUntilEnd < 0) {
            statusBadge = '<span class="badge" style="background: #ef4444; font-size: 14px; padding: 6px 12px;">Expired</span>';
            statusText = `Expired ${Math.abs(daysUntilEnd)} days ago`;
        } else if (daysUntilEnd <= 90) {
            statusBadge = '<span class="badge" style="background: #f59e0b; font-size: 14px; padding: 6px 12px;">Expiring Soon</span>';
            statusText = `Expires in ${daysUntilEnd} days`;
        } else {
            statusBadge = '<span class="badge" style="background: #10b981; font-size: 14px; padding: 6px 12px;">Active</span>';
            statusText = `${daysUntilEnd} days remaining`;
        }
    }

    const modal = document.createElement('div');
    modal.className = 'lease-modal-overlay';
    modal.id = 'view-lease-modal';
    modal.innerHTML = `
        <div class="lease-modal" style="max-width: 700px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(135deg, var(--accent-primary), #7c3aed); display: flex; align-items: center; justify-content: center;">
                        <i class="fas ${isLiquor ? 'fa-wine-bottle' : 'fa-store'}" style="font-size: 20px; color: white;"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0;">${lease.storeName}</h3>
                        <div style="display: flex; gap: 8px; margin-top: 4px;">
                            ${statusBadge}
                        </div>
                    </div>
                </div>
                <button class="modal-close" onclick="closeLeaseModal('view-lease-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Status Banner -->
                ${statusText ? `
                    <div style="background: var(--bg-secondary); padding: 16px 24px; border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calendar-alt" style="color: var(--text-muted);"></i>
                            <span style="color: var(--text-secondary);">${statusText}</span>
                        </div>
                    </div>
                ` : ''}

                <div style="padding: 24px;">
                    <!-- Property Details -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Property Details</h4>
                        <div class="card" style="background: var(--bg-secondary);">
                            <div class="card-body" style="padding: 16px;">
                                <div style="display: grid; gap: 12px;">
                                    ${lease.address ? `
                                        <div style="display: flex; align-items: start; gap: 12px;">
                                            <i class="fas fa-map-marker-alt" style="width: 20px; color: var(--accent-primary); margin-top: 2px;"></i>
                                            <div>
                                                <div style="font-size: 12px; color: var(--text-muted);">Address</div>
                                                <div style="color: var(--text-primary);">${lease.address}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div style="display: flex; align-items: start; gap: 12px;">
                                            <i class="fas fa-calendar-check" style="width: 20px; color: var(--accent-primary); margin-top: 2px;"></i>
                                            <div>
                                                <div style="font-size: 12px; color: var(--text-muted);">Start Date</div>
                                                <div style="color: var(--text-primary);">${lease.startDate ? formatDate(lease.startDate) : 'Not set'}</div>
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: start; gap: 12px;">
                                            <i class="fas fa-calendar-times" style="width: 20px; color: var(--accent-primary); margin-top: 2px;"></i>
                                            <div>
                                                <div style="font-size: 12px; color: var(--text-muted);">End Date</div>
                                                <div style="color: var(--text-primary);">${lease.endDate ? formatDate(lease.endDate) : 'Not set'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Details -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Financial Details</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="card" style="background: var(--bg-secondary);">
                                <div class="card-body" style="padding: 16px; text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Monthly Rent</div>
                                    <div style="font-size: 24px; font-weight: 700; color: var(--accent-primary);">
                                        ${lease.monthlyRent ? '$' + parseFloat(lease.monthlyRent).toLocaleString() : 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="background: var(--bg-secondary);">
                                <div class="card-body" style="padding: 16px; text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Security Deposit</div>
                                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">
                                        ${lease.securityDeposit ? '$' + parseFloat(lease.securityDeposit).toLocaleString() : 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Landlord Info -->
                    ${(lease.landlord || lease.landlordPhone || lease.landlordEmail) ? `
                        <div style="margin-bottom: 24px;">
                            <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Landlord Information</h4>
                            <div class="card" style="background: var(--bg-secondary);">
                                <div class="card-body" style="padding: 16px;">
                                    <div style="display: grid; gap: 12px;">
                                        ${lease.landlord ? `
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <i class="fas fa-user-tie" style="width: 20px; color: var(--accent-primary);"></i>
                                                <div>
                                                    <div style="font-size: 12px; color: var(--text-muted);">Name</div>
                                                    <div style="color: var(--text-primary);">${lease.landlord}</div>
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${lease.landlordPhone ? `
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <i class="fas fa-phone" style="width: 20px; color: var(--accent-primary);"></i>
                                                <div>
                                                    <div style="font-size: 12px; color: var(--text-muted);">Phone</div>
                                                    <a href="tel:${lease.landlordPhone}" style="color: var(--accent-primary);">${lease.landlordPhone}</a>
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${lease.landlordEmail ? `
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <i class="fas fa-envelope" style="width: 20px; color: var(--accent-primary);"></i>
                                                <div>
                                                    <div style="font-size: 12px; color: var(--text-muted);">Email</div>
                                                    <a href="mailto:${lease.landlordEmail}" style="color: var(--accent-primary);">${lease.landlordEmail}</a>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Lease Contract PDF -->
                    ${lease.pdfUrl ? `
                        <div style="margin-bottom: 24px;">
                            <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Lease Contract</h4>
                            <div class="card" style="background: var(--bg-secondary);">
                                <div class="card-body" style="padding: 16px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 44px; height: 44px; border-radius: 8px; background: linear-gradient(135deg, #ef4444, #dc2626); display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-file-pdf" style="font-size: 20px; color: white;"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600; color: var(--text-primary);">${lease.pdfFileName || 'Lease Contract.pdf'}</div>
                                                <div style="font-size: 12px; color: var(--text-muted);">PDF Document</div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <a href="${lease.pdfUrl}" target="_blank" class="btn-secondary" style="text-decoration: none;">
                                                <i class="fas fa-external-link-alt"></i> View
                                            </a>
                                            <a href="${lease.pdfUrl}" download="${lease.pdfFileName || 'lease.pdf'}" class="btn-primary" style="text-decoration: none;">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Notes -->
                    ${lease.notes ? `
                        <div>
                            <h4 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Notes</h4>
                            <div class="card" style="background: var(--bg-secondary);">
                                <div class="card-body" style="padding: 16px;">
                                    <p style="color: var(--text-secondary); line-height: 1.6; margin: 0; white-space: pre-wrap;">${lease.notes}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    ${isAdmin ? `
                        <button class="btn-secondary" style="color: #ef4444;" onclick="deleteLease('${lease.firestoreId}')">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    ` : ''}
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-secondary" onclick="closeLeaseModal('view-lease-modal')">Close</button>
                    ${isAdmin ? `
                        <button class="btn-primary" onclick="editLease('${lease.firestoreId}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('active'), 10);
}

async function editLease(leaseId) {
    closeLeaseModal('view-lease-modal');

    const lease = firebaseLeases.find(l => l.firestoreId === leaseId);
    if (!lease) {
        showToast('Lease not found', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'lease-modal-overlay';
    modal.id = 'edit-lease-modal';
    modal.innerHTML = `
        <div class="lease-modal">
            <div class="modal-header">
                <h3>Edit Lease</h3>
                <button class="modal-close" onclick="closeLeaseModal('edit-lease-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Store Location *</label>
                    <select class="form-input" id="edit-lease-store" required>
                        <option value="">Select Store</option>
                        ${STORE_LOCATIONS.map(store => `
                            <option value="${store.id}" ${lease.storeId === store.id ? 'selected' : ''}>${store.name}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Property Address</label>
                    <input type="text" class="form-input" id="edit-lease-address" placeholder="Full property address" value="${lease.address || ''}">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Lease Start Date</label>
                        <input type="date" class="form-input" id="edit-lease-start-date" value="${lease.startDate || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lease End Date</label>
                        <input type="date" class="form-input" id="edit-lease-end-date" value="${lease.endDate || ''}">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Monthly Rent ($)</label>
                        <input type="number" class="form-input" id="edit-lease-rent" placeholder="0.00" step="0.01" value="${lease.monthlyRent || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Security Deposit ($)</label>
                        <input type="number" class="form-input" id="edit-lease-deposit" placeholder="0.00" step="0.01" value="${lease.securityDeposit || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Landlord / Property Manager</label>
                    <input type="text" class="form-input" id="edit-lease-landlord" placeholder="Name of landlord or property management company" value="${lease.landlord || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Landlord Phone</label>
                    <input type="tel" class="form-input" id="edit-lease-landlord-phone" placeholder="(555) 123-4567" value="${lease.landlordPhone || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Landlord Email</label>
                    <input type="email" class="form-input" id="edit-lease-landlord-email" placeholder="landlord@example.com" value="${lease.landlordEmail || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Lease Contract (PDF)</label>
                    ${lease.pdfUrl ? `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <i class="fas fa-file-pdf" style="font-size: 24px; color: #ef4444;"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 14px; color: var(--text-primary);">${lease.pdfFileName || 'Lease Contract.pdf'}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Current document</div>
                            </div>
                            <a href="${lease.pdfUrl}" target="_blank" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </div>
                    ` : ''}
                    <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;"
                         id="edit-pdf-upload-area"
                         onclick="document.getElementById('edit-lease-pdf-input').click()">
                        <i class="fas fa-file-pdf" style="font-size: 32px; color: var(--text-muted); margin-bottom: 8px;"></i>
                        <div style="color: var(--text-secondary); font-size: 14px;">${lease.pdfUrl ? 'Upload new PDF (replaces current)' : 'Click to upload PDF'}</div>
                        <div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">Max file size: 10MB</div>
                        <input type="file" id="edit-lease-pdf-input" accept=".pdf" style="display: none;" onchange="handleEditLeasePdfSelect(this)">
                    </div>
                    <div id="edit-pdf-file-name" style="margin-top: 8px; font-size: 14px; color: var(--accent-primary); display: none;">
                        <i class="fas fa-check-circle"></i> <span></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="edit-lease-notes" rows="3" placeholder="Additional notes about this lease...">${lease.notes || ''}</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeLeaseModal('edit-lease-modal')">Cancel</button>
                <button class="btn-primary" onclick="updateLease('${leaseId}')">
                    <i class="fas fa-save"></i> Update Lease
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('active'), 10);
}

let editSelectedLeasePdf = null;

function handleEditLeasePdfSelect(input) {
    const file = input.files[0];
    if (file) {
        if (file.size > 10 * 1024 * 1024) {
            showToast('File too large. Maximum size is 10MB.', 'error');
            return;
        }
        if (file.type !== 'application/pdf') {
            showToast('Please select a PDF file.', 'error');
            return;
        }
        editSelectedLeasePdf = file;
        const fileName = document.getElementById('edit-pdf-file-name');
        fileName.style.display = 'block';
        fileName.querySelector('span').textContent = file.name;
        document.getElementById('edit-pdf-upload-area').style.borderColor = 'var(--accent-primary)';
        document.getElementById('edit-pdf-upload-area').style.background = 'rgba(99, 102, 241, 0.1)';
    }
}

async function updateLease(leaseId) {
    const db = firebase.firestore();
    const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;

    const storeId = document.getElementById('edit-lease-store').value;
    if (!storeId) {
        showToast('Please select a store location', 'error');
        return;
    }

    const store = STORE_LOCATIONS.find(s => s.id === storeId);

    const leaseData = {
        storeId: storeId,
        storeName: store.name,
        storeType: store.type,
        address: document.getElementById('edit-lease-address').value.trim(),
        startDate: document.getElementById('edit-lease-start-date').value,
        endDate: document.getElementById('edit-lease-end-date').value,
        monthlyRent: document.getElementById('edit-lease-rent').value,
        securityDeposit: document.getElementById('edit-lease-deposit').value,
        landlord: document.getElementById('edit-lease-landlord').value.trim(),
        landlordPhone: document.getElementById('edit-lease-landlord-phone').value.trim(),
        landlordEmail: document.getElementById('edit-lease-landlord-email').value.trim(),
        notes: document.getElementById('edit-lease-notes').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.uid || 'unknown'
    };

    try {
        // Upload new PDF if selected
        if (editSelectedLeasePdf) {
            showToast('Uploading PDF...', 'info');
            const pdfUrl = await uploadLeasePdf(editSelectedLeasePdf, leaseId);
            leaseData.pdfUrl = pdfUrl;
            leaseData.pdfFileName = editSelectedLeasePdf.name;
        }

        await db.collection('leases').doc(leaseId).update(leaseData);

        editSelectedLeasePdf = null;
        closeLeaseModal('edit-lease-modal');
        showToast('Lease updated successfully!', 'success');
        renderLeases();
    } catch (error) {
        console.error('Error updating lease:', error);
        showToast('Error updating lease. Please try again.', 'error');
    }
}

async function deleteLease(leaseId) {
    if (!confirm('Are you sure you want to delete this lease? This action cannot be undone.')) {
        return;
    }

    try {
        const db = firebase.firestore();
        await db.collection('leases').doc(leaseId).delete();
        closeLeaseModal('view-lease-modal');
        showToast('Lease deleted successfully', 'success');
        renderLeases();
    } catch (error) {
        console.error('Error deleting lease:', error);
        showToast('Error deleting lease. Please try again.', 'error');
    }
}

// ========== Migration Function: Update "Carlos Admin" to "VSU Admin" ==========
// Auto-run on load to fix existing records
(async function migrateCarlosAdminToVSUAdmin() {
    // Wait for Firebase to be ready
    await new Promise(resolve => setTimeout(resolve, 3000));

    if (typeof firebase === 'undefined' || !firebase.firestore) {
        console.log('Firebase not ready for migration');
        return;
    }

    const db = firebase.firestore();
    const collections = ['cashOutRecords', 'invoices', 'issues', 'gifts', 'changeRecords', 'riskNotes', 'clockRecords'];
    let totalUpdated = 0;

    console.log('üîÑ Auto-migration: Carlos Admin -> VSU Admin');

    for (const collectionName of collections) {
        try {
            const snapshot = await db.collection(collectionName).where('createdBy', '==', 'Carlos Admin').get();

            if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, { createdBy: 'VSU Admin' });
                });
                await batch.commit();
                console.log(`‚úÖ Updated ${snapshot.size} records in ${collectionName}`);
                totalUpdated += snapshot.size;
            }
        } catch (error) {
            // Collection might not exist, ignore
        }
    }

    // Also check for 'recordedBy' field
    for (const collectionName of collections) {
        try {
            const snapshot = await db.collection(collectionName).where('recordedBy', '==', 'Carlos Admin').get();

            if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, { recordedBy: 'VSU Admin' });
                });
                await batch.commit();
                totalUpdated += snapshot.size;
            }
        } catch (error) {
            // Silently ignore
        }
    }

    if (totalUpdated > 0) {
        console.log(`‚úÖ Migration complete! Updated ${totalUpdated} records to VSU Admin`);
    }
})();

// =============================================================================
// G-LABS MODULE - Simple Spreadsheet for Number Crunching
// =============================================================================

// G-Labs state
let glabsSheets = {};
let glabsCurrentSheet = 'Sheet 1';
let glabsRows = 15;
let glabsCols = 10;
let glabsSelectedCell = null;
let glabsColWidths = {};
let glabsRowHeights = {};
let glabsCellStyles = {};

// Undo/Redo history
let glabsUndoStack = [];
let glabsRedoStack = [];
let glabsMaxHistory = 50;

// Clipboard
let glabsClipboard = null;

// Month navigation state
let glabsCurrentMonth = new Date().getMonth();
let glabsCurrentYear = new Date().getFullYear();

// Get month key for storage
function glabsGetMonthKey() {
    return `${glabsCurrentYear}-${String(glabsCurrentMonth + 1).padStart(2, '0')}`;
}

// Get month display name
function glabsGetMonthName() {
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
    return `${months[glabsCurrentMonth]} ${glabsCurrentYear}`;
}

// Navigate to previous month
function glabsPrevMonth() {
    glabsCurrentMonth--;
    if (glabsCurrentMonth < 0) {
        glabsCurrentMonth = 11;
        glabsCurrentYear--;
    }
    glabsLoadDataForMonth();
    renderGLabs();
}

// Navigate to next month
function glabsNextMonth() {
    glabsCurrentMonth++;
    if (glabsCurrentMonth > 11) {
        glabsCurrentMonth = 0;
        glabsCurrentYear++;
    }
    glabsLoadDataForMonth();
    renderGLabs();
}

// Go to current month
function glabsGoToCurrentMonth() {
    glabsCurrentMonth = new Date().getMonth();
    glabsCurrentYear = new Date().getFullYear();
    glabsLoadDataForMonth();
    renderGLabs();
}

// Initialize G-Labs data structure
function glabsInitSheet(sheetName) {
    if (!glabsSheets[sheetName]) {
        glabsSheets[sheetName] = {
            data: [],
            colWidths: {},
            rowHeights: {},
            cellStyles: {}
        };
        for (let i = 0; i < glabsRows; i++) {
            glabsSheets[sheetName].data[i] = [];
            for (let j = 0; j < glabsCols; j++) {
                glabsSheets[sheetName].data[i][j] = '';
            }
        }
    }
}

// Load G-Labs from localStorage for current month
function glabsLoadData() {
    glabsLoadDataForMonth();
}

// Load data for specific month
function glabsLoadDataForMonth() {
    const monthKey = glabsGetMonthKey();
    const saved = localStorage.getItem(`glabs_month_${monthKey}`);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            glabsSheets = parsed.sheets || {};
            glabsCurrentSheet = parsed.currentSheet || 'Sheet 1';
        } catch (e) {
            console.error('Error loading G-Labs:', e);
            glabsSheets = {};
        }
    } else {
        glabsSheets = {};
    }
    if (Object.keys(glabsSheets).length === 0) {
        glabsInitSheet('Sheet 1');
    }
}

// Save G-Labs to localStorage for current month
function glabsSaveData() {
    const monthKey = glabsGetMonthKey();
    localStorage.setItem(`glabs_month_${monthKey}`, JSON.stringify({
        sheets: glabsSheets,
        currentSheet: glabsCurrentSheet
    }));
}

// Save state for undo
function glabsSaveUndoState() {
    const state = JSON.stringify({
        sheets: glabsSheets,
        currentSheet: glabsCurrentSheet
    });
    glabsUndoStack.push(state);
    if (glabsUndoStack.length > glabsMaxHistory) {
        glabsUndoStack.shift();
    }
    // Clear redo stack when new action is performed
    glabsRedoStack = [];
}

// Undo last action
function glabsUndo() {
    if (glabsUndoStack.length === 0) return;

    // Save current state to redo stack
    const currentState = JSON.stringify({
        sheets: glabsSheets,
        currentSheet: glabsCurrentSheet
    });
    glabsRedoStack.push(currentState);

    // Restore previous state
    const prevState = JSON.parse(glabsUndoStack.pop());
    glabsSheets = prevState.sheets;
    glabsCurrentSheet = prevState.currentSheet;

    glabsSaveData();
    renderGLabs();
}

// Redo last undone action
function glabsRedo() {
    if (glabsRedoStack.length === 0) return;

    // Save current state to undo stack
    const currentState = JSON.stringify({
        sheets: glabsSheets,
        currentSheet: glabsCurrentSheet
    });
    glabsUndoStack.push(currentState);

    // Restore redo state
    const redoState = JSON.parse(glabsRedoStack.pop());
    glabsSheets = redoState.sheets;
    glabsCurrentSheet = redoState.currentSheet;

    glabsSaveData();
    renderGLabs();
}

// Copy selected cells
function glabsCopy() {
    if (!glabsSelectedCell && (!glabsSelectionStart || !glabsSelectionEnd)) return;

    const sheet = glabsSheets[glabsCurrentSheet];

    if (glabsSelectionStart && glabsSelectionEnd) {
        // Copy range
        const startRow = Math.min(glabsSelectionStart.row, glabsSelectionEnd.row);
        const endRow = Math.max(glabsSelectionStart.row, glabsSelectionEnd.row);
        const startCol = Math.min(glabsSelectionStart.col, glabsSelectionEnd.col);
        const endCol = Math.max(glabsSelectionStart.col, glabsSelectionEnd.col);

        glabsClipboard = {
            type: 'range',
            data: [],
            styles: []
        };

        for (let r = startRow; r <= endRow; r++) {
            const rowData = [];
            const rowStyles = [];
            for (let c = startCol; c <= endCol; c++) {
                rowData.push(sheet.data[r]?.[c] || '');
                rowStyles.push(sheet.cellStyles?.[`${r}-${c}`] || {});
            }
            glabsClipboard.data.push(rowData);
            glabsClipboard.styles.push(rowStyles);
        }
    } else if (glabsSelectedCell) {
        // Copy single cell
        const { row, col } = glabsSelectedCell;
        glabsClipboard = {
            type: 'single',
            data: sheet.data[row]?.[col] || '',
            style: sheet.cellStyles?.[`${row}-${col}`] || {}
        };
    }
}

// Paste clipboard content
function glabsPaste() {
    if (!glabsClipboard || !glabsSelectedCell) return;

    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    const { row, col } = glabsSelectedCell;

    if (!sheet.cellStyles) sheet.cellStyles = {};

    if (glabsClipboard.type === 'single') {
        if (!sheet.data[row]) sheet.data[row] = [];
        sheet.data[row][col] = glabsClipboard.data;
        sheet.cellStyles[`${row}-${col}`] = { ...glabsClipboard.style };
    } else if (glabsClipboard.type === 'range') {
        for (let r = 0; r < glabsClipboard.data.length; r++) {
            for (let c = 0; c < glabsClipboard.data[r].length; c++) {
                const targetRow = row + r;
                const targetCol = col + c;
                if (!sheet.data[targetRow]) sheet.data[targetRow] = [];
                sheet.data[targetRow][targetCol] = glabsClipboard.data[r][c];
                sheet.cellStyles[`${targetRow}-${targetCol}`] = { ...glabsClipboard.styles[r][c] };
            }
        }
    }

    glabsSaveData();
    renderGLabs();
}

// Delete content of selected cells
function glabsDeleteContent() {
    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];

    if (glabsSelectionStart && glabsSelectionEnd) {
        // Delete range
        const startRow = Math.min(glabsSelectionStart.row, glabsSelectionEnd.row);
        const endRow = Math.max(glabsSelectionStart.row, glabsSelectionEnd.row);
        const startCol = Math.min(glabsSelectionStart.col, glabsSelectionEnd.col);
        const endCol = Math.max(glabsSelectionStart.col, glabsSelectionEnd.col);

        for (let r = startRow; r <= endRow; r++) {
            for (let c = startCol; c <= endCol; c++) {
                if (sheet.data[r]) sheet.data[r][c] = '';
            }
        }
    } else if (glabsSelectedCell) {
        // Delete single cell
        const { row, col } = glabsSelectedCell;
        if (sheet.data[row]) sheet.data[row][col] = '';
    }

    glabsSaveData();
    renderGLabs();
}

// Navigate with arrow keys
function glabsNavigate(direction) {
    if (!glabsSelectedCell) return;

    const { row, col } = glabsSelectedCell;
    const sheet = glabsSheets[glabsCurrentSheet];
    const maxRow = sheet.data.length || glabsRows;
    const maxCol = sheet.data[0]?.length || glabsCols;

    let newRow = row;
    let newCol = col;

    switch (direction) {
        case 'up': newRow = Math.max(0, row - 1); break;
        case 'down': newRow = Math.min(maxRow - 1, row + 1); break;
        case 'left': newCol = Math.max(0, col - 1); break;
        case 'right': newCol = Math.min(maxCol - 1, col + 1); break;
    }

    // Find and click the new cell
    const newCell = document.querySelector(`[data-row="${newRow}"][data-col="${newCol}"]`);
    if (newCell) {
        glabsSelectCell(newRow, newCol, newCell);
    }
}

// Keyboard event handler for G-Labs
function glabsKeyboardHandler(e) {
    // Check if we're in G-Labs module
    if (!document.getElementById('glabs-table')) return;

    // Don't intercept if typing in formula bar or cell editor
    if (e.target.id === 'glabs-formula-bar' || e.target.classList.contains('glabs-cell-editor')) {
        // Handle Enter in formula bar
        if (e.key === 'Enter' && e.target.id === 'glabs-formula-bar') {
            glabsApplyFormula();
            glabsNavigate('down');
            e.preventDefault();
        }
        // Handle Escape in formula bar - cancel editing
        if (e.key === 'Escape') {
            e.preventDefault();
            document.getElementById('glabs-formula-bar').blur();
            renderGLabs();
        }
        return;
    }

    // F2 = Edit cell directly
    if (e.key === 'F2' && glabsSelectedCell) {
        e.preventDefault();
        glabsEditCellDirectly(glabsSelectedCell.row, glabsSelectedCell.col, glabsSelectedCell.element);
        return;
    }

    // Escape = Cancel selection or deselect
    if (e.key === 'Escape') {
        e.preventDefault();
        glabsSelectedCell = null;
        glabsSelectionStart = null;
        glabsSelectionEnd = null;
        glabsSelectedCells = [];
        renderGLabs();
        return;
    }

    // Ctrl/Cmd + Z = Undo
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        glabsUndo();
        return;
    }

    // Ctrl/Cmd + Y or Ctrl/Cmd + Shift + Z = Redo
    if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        glabsRedo();
        return;
    }

    // Ctrl/Cmd + C = Copy
    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        glabsCopy();
        return;
    }

    // Ctrl/Cmd + V = Paste
    if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        e.preventDefault();
        glabsPaste();
        return;
    }

    // Ctrl/Cmd + X = Cut
    if ((e.ctrlKey || e.metaKey) && e.key === 'x') {
        e.preventDefault();
        glabsCopy();
        glabsDeleteContent();
        return;
    }

    // Ctrl/Cmd + F = Find
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        glabsShowFindDialog();
        return;
    }

    // Delete or Backspace = Clear content
    if (e.key === 'Delete' || e.key === 'Backspace') {
        e.preventDefault();
        glabsDeleteContent();
        return;
    }

    // Arrow keys = Navigate
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
        const dir = e.key.replace('Arrow', '').toLowerCase();
        glabsNavigate(dir);
        return;
    }

    // Tab = Move right
    if (e.key === 'Tab') {
        e.preventDefault();
        glabsNavigate(e.shiftKey ? 'left' : 'right');
        return;
    }

    // Enter = Edit cell or move down
    if (e.key === 'Enter') {
        e.preventDefault();
        if (glabsSelectedCell) {
            // Edit cell on Enter
            glabsEditCellDirectly(glabsSelectedCell.row, glabsSelectedCell.col, glabsSelectedCell.element);
        }
        return;
    }

    // Start typing to edit cell (if alphanumeric key pressed) - replaces content
    if (glabsSelectedCell && e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        glabsEditCellDirectly(glabsSelectedCell.row, glabsSelectedCell.col, glabsSelectedCell.element, e.key);
    }
}

// Edit cell directly (in-cell editing)
function glabsEditCellDirectly(row, col, element, initialValue = null) {
    const sheet = glabsSheets[glabsCurrentSheet];

    // Find element if not provided or invalid
    if (!element || !element.querySelector) {
        element = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
    }
    if (!element) return;

    const contentDiv = element.querySelector('.glabs-cell-content');
    if (!contentDiv) return;

    const currentValue = initialValue !== null ? initialValue : (sheet.data[row]?.[col] || '');

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'glabs-cell-editor';
    input.value = currentValue;
    input.style.cssText = 'width: 100%; height: 100%; border: none; background: white; padding: 4px 8px; font-size: 13px; outline: none; box-sizing: border-box;';

    input.onblur = () => glabsSaveCell(input, row, col);
    input.onkeydown = (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            glabsSaveCell(input, row, col);
            glabsNavigate('down');
        } else if (event.key === 'Tab') {
            event.preventDefault();
            glabsSaveCell(input, row, col);
            glabsNavigate(event.shiftKey ? 'left' : 'right');
        } else if (event.key === 'Escape') {
            event.preventDefault();
            renderGLabs(); // Cancel without saving
        }
    };

    contentDiv.innerHTML = '';
    contentDiv.appendChild(input);
    input.focus();

    // If initial value was passed (user started typing), put cursor at end
    if (initialValue !== null) {
        input.setSelectionRange(input.value.length, input.value.length);
    } else {
        input.select();
    }
}

// Get list of all months that have data
function glabsGetSavedMonths() {
    const months = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('glabs_month_')) {
            const monthKey = key.replace('glabs_month_', '');
            months.push(monthKey);
        }
    }
    return months.sort().reverse();
}

// Multi-selection state
let glabsSelectionStart = null;
let glabsSelectionEnd = null;
let glabsIsSelecting = false;
let glabsSelectedCells = [];

function renderGLabs() {
    const dashboard = document.querySelector('.dashboard');

    // Register keyboard handler (only once)
    if (!window.glabsKeyboardRegistered) {
        document.addEventListener('keydown', glabsKeyboardHandler);
        window.glabsKeyboardRegistered = true;
    }

    // Load data
    glabsLoadData();

    const sheet = glabsSheets[glabsCurrentSheet];
    const glabsData = sheet.data;
    const actualRows = glabsData.length || glabsRows;
    const actualCols = glabsData[0]?.length || glabsCols;

    // Column letters
    const colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

    // Sheet tabs HTML
    const sheetTabs = Object.keys(glabsSheets).map(name => `
        <button class="glabs-sheet-tab ${name === glabsCurrentSheet ? 'active' : ''}"
                onclick="glabsSwitchSheet('${name}')"
                ondblclick="glabsRenameSheet('${name}')">
            ${name}
            ${Object.keys(glabsSheets).length > 1 ? `<span class="glabs-tab-close" onclick="event.stopPropagation(); glabsDeleteSheet('${name}')">&times;</span>` : ''}
        </button>
    `).join('');

    dashboard.innerHTML = `
        <!-- Header with gradient -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px 32px; margin-bottom: 20px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-flask"></i> G-Labs One
                    </h2>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Professional spreadsheet for data crunching</p>
                </div>

                <!-- Month Navigation -->
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="glabsPrevMonth()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div style="text-align: center; min-width: 150px;">
                        <span style="font-size: 18px; font-weight: 600;">${glabsGetMonthName()}</span>
                    </div>
                    <button onclick="glabsNextMonth()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button onclick="glabsGoToCurrentMonth()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-calendar-day"></i> Today
                    </button>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="glabsExportCSV()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button onclick="glabsClearAll()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <!-- Cell Reference -->
            <span id="glabs-cell-ref" style="font-family: monospace; font-weight: 700; color: var(--accent-primary); min-width: 45px; font-size: 15px; background: var(--bg-tertiary); padding: 6px 12px; border-radius: 6px;">A1</span>

            <!-- Formula Bar -->
            <input type="text" id="glabs-formula-bar" placeholder="Enter value, text, or formula (=SUM, =AVG, =A1+B1...)"
                style="flex: 1; min-width: 200px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 12px; color: var(--text-primary); font-family: 'Outfit', sans-serif; font-size: 14px;"
                onkeydown="if(event.key === 'Enter') glabsApplyFormula()">

            <div style="display: flex; gap: 8px; align-items: center;">
                <!-- Color Picker -->
                <div style="position: relative;">
                    <button id="glabs-color-btn" onclick="glabsToggleColorPicker()" title="Cell Color" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--text-primary);">
                        <i class="fas fa-fill-drip"></i>
                        <span id="glabs-color-preview" style="width: 16px; height: 16px; border-radius: 3px; background: #ffffff; border: 1px solid var(--border-color);"></span>
                    </button>
                    <div id="glabs-color-picker" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;">
                            ${['#ffffff', '#f3f4f6', '#fef3c7', '#fce7f3', '#dbeafe', '#d1fae5',
                               '#fbbf24', '#f97316', '#ef4444', '#ec4899', '#8b5cf6', '#3b82f6',
                               '#10b981', '#14b8a6', '#06b6d4', '#6366f1', '#a855f7', '#d946ef',
                               '#1f2937', '#374151', '#4b5563', '#6b7280', '#9ca3af', '#d1d5db'].map(color => `
                                <button onclick="glabsSetCellColor('${color}')"
                                    style="width: 28px; height: 28px; border-radius: 4px; background: ${color}; border: 1px solid var(--border-color); cursor: pointer;"
                                    title="${color}"></button>
                            `).join('')}
                        </div>
                        <button onclick="glabsSetCellColor('')" style="margin-top: 8px; width: 100%; padding: 6px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; color: var(--text-primary); font-size: 12px;">
                            <i class="fas fa-times"></i> No Color
                        </button>
                    </div>
                </div>

                <!-- Text Color -->
                <div style="position: relative;">
                    <button onclick="glabsToggleTextColorPicker()" title="Text Color" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--text-primary);">
                        <i class="fas fa-font"></i>
                        <span id="glabs-text-color-preview" style="width: 16px; height: 16px; border-radius: 3px; background: #000000; border: 1px solid var(--border-color);"></span>
                    </button>
                    <div id="glabs-text-color-picker" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;">
                            ${['#000000', '#374151', '#6b7280', '#9ca3af', '#d1d5db', '#ffffff',
                               '#dc2626', '#ea580c', '#d97706', '#65a30d', '#059669', '#0891b2',
                               '#2563eb', '#7c3aed', '#c026d3', '#db2777', '#e11d48', '#f43f5e'].map(color => `
                                <button onclick="glabsSetTextColor('${color}')"
                                    style="width: 28px; height: 28px; border-radius: 4px; background: ${color}; border: 1px solid var(--border-color); cursor: pointer;"
                                    title="${color}"></button>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Column Width -->
                <select id="glabs-col-width" onchange="glabsSetColumnWidth(this.value)" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; color: var(--text-primary); font-size: 13px; cursor: pointer;">
                    <option value="">Col Width</option>
                    <option value="60">Narrow</option>
                    <option value="100">Normal</option>
                    <option value="150">Wide</option>
                    <option value="200">Extra Wide</option>
                </select>

                <!-- Row/Column Actions -->
                <button onclick="glabsAddRow()" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; color: var(--text-primary); font-size: 13px;">
                    <i class="fas fa-plus"></i> Row
                </button>
                <button onclick="glabsAddColumn()" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; color: var(--text-primary); font-size: 13px;">
                    <i class="fas fa-plus"></i> Col
                </button>
            </div>
        </div>

        <!-- Selection Stats Bar -->
        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 12px; overflow: hidden;">
            <div style="display: flex; align-items: stretch; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 100px; padding: 12px 16px; border-right: 1px solid var(--border-color); text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Sum</div>
                    <div id="glabs-sum" style="font-size: 18px; font-weight: 700; color: var(--accent-primary);">-</div>
                </div>
                <div style="flex: 1; min-width: 100px; padding: 12px 16px; border-right: 1px solid var(--border-color); text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Average</div>
                    <div id="glabs-avg" style="font-size: 18px; font-weight: 700; color: #10b981;">-</div>
                </div>
                <div style="flex: 1; min-width: 100px; padding: 12px 16px; border-right: 1px solid var(--border-color); text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Min</div>
                    <div id="glabs-min" style="font-size: 18px; font-weight: 700; color: #f59e0b;">-</div>
                </div>
                <div style="flex: 1; min-width: 100px; padding: 12px 16px; border-right: 1px solid var(--border-color); text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Max</div>
                    <div id="glabs-max" style="font-size: 18px; font-weight: 700; color: #ef4444;">-</div>
                </div>
                <div style="flex: 1; min-width: 100px; padding: 12px 16px; border-right: 1px solid var(--border-color); text-align: center;">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Count</div>
                    <div id="glabs-count" style="font-size: 18px; font-weight: 700; color: #8b5cf6;">-</div>
                </div>
                <div style="flex: 1.5; min-width: 150px; padding: 12px 16px; text-align: center; background: var(--bg-tertiary);">
                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Selection</div>
                    <div id="glabs-selection-range" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">-</div>
                </div>
            </div>
            <div id="glabs-formula-suggestion" style="display: none; padding: 8px 16px; background: var(--bg-tertiary); border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-muted);">
                <span style="margin-right: 8px;"><i class="fas fa-lightbulb" style="color: #f59e0b;"></i> Tip:</span>
                <span id="glabs-formula-text">Select cells to see formula suggestions</span>
                <button id="glabs-insert-formula-btn" onclick="glabsInsertSuggestedFormula()" style="margin-left: 12px; padding: 4px 12px; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; display: none;">
                    <i class="fas fa-plus"></i> Insert
                </button>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 6px 16px; background: linear-gradient(90deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); border-top: 1px solid var(--border-color);">
                <span id="glabs-saved" style="font-size: 11px; color: #10b981;"><i class="fas fa-check-circle"></i> Auto-saved</span>
                <span style="font-size: 11px; color: var(--text-muted);">
                    <i class="fas fa-keyboard"></i> Ctrl+Z Undo | Ctrl+F Find | Arrow keys Navigate
                </span>
            </div>
        </div>

        <!-- Find Dialog -->
        <div id="glabs-find-dialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; z-index: 1001; box-shadow: 0 8px 32px rgba(0,0,0,0.2); min-width: 350px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0; color: var(--text-primary); font-size: 16px;"><i class="fas fa-search"></i> Find & Replace</h3>
                <button onclick="glabsCloseFindDialog()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 18px;">&times;</button>
            </div>
            <div style="margin-bottom: 12px;">
                <label style="display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Find:</label>
                <input type="text" id="glabs-find-input" placeholder="Search text..." style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px; box-sizing: border-box;" onkeydown="if(event.key === 'Enter') glabsFindNext()">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Replace with:</label>
                <input type="text" id="glabs-replace-input" placeholder="Replace text..." style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="glabsFindNext()" style="flex: 1; padding: 10px 16px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Find Next</button>
                <button onclick="glabsReplace()" style="flex: 1; padding: 10px 16px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 13px;">Replace</button>
                <button onclick="glabsReplaceAll()" style="flex: 1; padding: 10px 16px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 13px;">Replace All</button>
            </div>
            <div id="glabs-find-status" style="margin-top: 12px; color: var(--text-muted); font-size: 12px; text-align: center;"></div>
        </div>

        <!-- Context Menu -->
        <div id="glabs-context-menu" style="display: none; position: fixed; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 180px; max-height: 60vh; overflow-y: auto;">
            <div class="glabs-ctx-item" onclick="glabsFormatCurrency()"><i class="fas fa-dollar-sign" style="width: 20px;"></i> Currency ($)</div>
            <div class="glabs-ctx-item" onclick="glabsFormatPercent()"><i class="fas fa-percent" style="width: 20px;"></i> Percentage (%)</div>
            <div class="glabs-ctx-item" onclick="glabsFormatNumber()"><i class="fas fa-hashtag" style="width: 20px;"></i> Number (1,000)</div>
            <div class="glabs-ctx-item" onclick="glabsFormatDecimal()"><i class="fas fa-calculator" style="width: 20px;"></i> Decimal (0.00)</div>
            <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>
            <div class="glabs-ctx-item" onclick="glabsFormatBold()"><i class="fas fa-bold" style="width: 20px;"></i> Bold</div>
            <div class="glabs-ctx-item" onclick="glabsFormatItalic()"><i class="fas fa-italic" style="width: 20px;"></i> Italic</div>
            <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>
            <div class="glabs-ctx-item" onclick="glabsAlignLeft()"><i class="fas fa-align-left" style="width: 20px;"></i> Align Left</div>
            <div class="glabs-ctx-item" onclick="glabsAlignCenter()"><i class="fas fa-align-center" style="width: 20px;"></i> Align Center</div>
            <div class="glabs-ctx-item" onclick="glabsAlignRight()"><i class="fas fa-align-right" style="width: 20px;"></i> Align Right</div>
            <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>
            <div class="glabs-ctx-item" onclick="glabsSortAZ()"><i class="fas fa-sort-alpha-down" style="width: 20px;"></i> Sort A ‚Üí Z</div>
            <div class="glabs-ctx-item" onclick="glabsSortZA()"><i class="fas fa-sort-alpha-up" style="width: 20px;"></i> Sort Z ‚Üí A</div>
            <div class="glabs-ctx-item" onclick="glabsSortNumAsc()"><i class="fas fa-sort-numeric-down" style="width: 20px;"></i> Sort Small ‚Üí Large</div>
            <div class="glabs-ctx-item" onclick="glabsSortNumDesc()"><i class="fas fa-sort-numeric-up" style="width: 20px;"></i> Sort Large ‚Üí Small</div>
            <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>
            <div class="glabs-ctx-item" onclick="glabsInsertRowAbove()"><i class="fas fa-arrow-up" style="width: 20px;"></i> Insert Row Above</div>
            <div class="glabs-ctx-item" onclick="glabsInsertRowBelow()"><i class="fas fa-arrow-down" style="width: 20px;"></i> Insert Row Below</div>
            <div class="glabs-ctx-item" onclick="glabsInsertColLeft()"><i class="fas fa-arrow-left" style="width: 20px;"></i> Insert Column Left</div>
            <div class="glabs-ctx-item" onclick="glabsInsertColRight()"><i class="fas fa-arrow-right" style="width: 20px;"></i> Insert Column Right</div>
            <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>
            <div class="glabs-ctx-item" onclick="glabsDeleteRow()"><i class="fas fa-minus" style="width: 20px;"></i> Delete Row</div>
            <div class="glabs-ctx-item" onclick="glabsDeleteCol()"><i class="fas fa-minus" style="width: 20px;"></i> Delete Column</div>
            <div class="glabs-ctx-item" onclick="glabsMergeCells()"><i class="fas fa-compress-alt" style="width: 20px;"></i> Merge Cells</div>
            <div class="glabs-ctx-item" onclick="glabsUnmergeCells()"><i class="fas fa-expand-alt" style="width: 20px;"></i> Unmerge Cells</div>
            <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>
            <div class="glabs-ctx-item" onclick="glabsClearFormat()"><i class="fas fa-eraser" style="width: 20px;"></i> Clear Format</div>
            <div class="glabs-ctx-item" onclick="glabsDeleteCellContent()"><i class="fas fa-trash" style="width: 20px;"></i> Delete Content</div>
        </div>

        <!-- Spreadsheet Grid -->
        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
            <div id="glabs-grid-container" style="overflow: auto; max-height: 55vh;" onmouseup="glabsEndSelection()">
                <table id="glabs-table" style="width: 100%; border-collapse: collapse; font-family: 'Outfit', sans-serif; user-select: none;">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr style="background: var(--bg-tertiary);">
                            <th onclick="glabsSelectAll()" style="width: 50px; padding: 10px; border: 1px solid var(--border-color); color: var(--text-muted); font-weight: 600; font-size: 12px; position: sticky; left: 0; background: var(--bg-tertiary); z-index: 11; cursor: pointer;" title="Select All"></th>
                            ${Array.from({length: actualCols}, (_, i) => {
                                const width = sheet.colWidths?.[i] || 100;
                                return `
                                <th onclick="glabsSelectColumn(${i})" style="min-width: ${width}px; width: ${width}px; padding: 10px; border: 1px solid var(--border-color); color: var(--text-muted); font-weight: 600; font-size: 12px; text-align: center; position: relative; cursor: pointer;" data-col="${i}" title="Click to select column ${colLetters[i]}">
                                    ${colLetters[i] || 'Z' + (i - 25)}
                                    <div class="glabs-resize-handle" onmousedown="event.stopPropagation(); glabsStartResize(event, ${i})" style="position: absolute; right: 0; top: 0; bottom: 0; width: 5px; cursor: col-resize; background: transparent;"></div>
                                </th>
                            `}).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${Array.from({length: actualRows}, (_, rowIdx) => `
                            <tr>
                                <td onclick="glabsSelectRow(${rowIdx})" style="padding: 8px 10px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-muted); font-weight: 600; font-size: 12px; text-align: center; position: sticky; left: 0; z-index: 5; cursor: pointer;" title="Click to select row ${rowIdx + 1}">
                                    ${rowIdx + 1}
                                </td>
                                ${Array.from({length: actualCols}, (_, colIdx) => {
                                    // Check if this cell is part of a merge (but not the main cell)
                                    if (glabsIsMergedSlave(rowIdx, colIdx, sheet)) {
                                        return ''; // Don't render slave cells
                                    }

                                    const cellId = `${colLetters[colIdx]}${rowIdx + 1}`;
                                    const value = glabsData[rowIdx]?.[colIdx] || '';
                                    const cellStyle = sheet.cellStyles?.[`${rowIdx}-${colIdx}`] || {};
                                    const displayValue = glabsFormatValue(glabsEvaluateCell(value, rowIdx, colIdx), cellStyle.format);
                                    const bgColor = cellStyle.bg || '';
                                    const textColor = cellStyle.color || '';
                                    const bold = cellStyle.bold ? 'font-weight: 700;' : '';
                                    const italic = cellStyle.italic ? 'font-style: italic;' : '';
                                    const align = cellStyle.align || 'left';
                                    const width = sheet.colWidths?.[colIdx] || 100;

                                    // Check if this cell is the start of a merge
                                    const merge = glabsGetMerge(rowIdx, colIdx, sheet);
                                    const colspan = merge ? (merge.endCol - merge.startCol + 1) : 1;
                                    const rowspan = merge ? (merge.endRow - merge.startRow + 1) : 1;
                                    const mergeAttr = merge ? `colspan="${colspan}" rowspan="${rowspan}"` : '';

                                    return `
                                        <td class="glabs-cell ${merge ? 'glabs-merged' : ''}" data-row="${rowIdx}" data-col="${colIdx}" data-cell="${cellId}" ${mergeAttr}
                                            onmousedown="glabsStartSelection(event, ${rowIdx}, ${colIdx})"
                                            onmouseover="glabsUpdateSelection(event, ${rowIdx}, ${colIdx})"
                                            ondblclick="glabsEditCellDirectly(${rowIdx}, ${colIdx}, this)"
                                            oncontextmenu="glabsShowContextMenu(event, ${rowIdx}, ${colIdx})"
                                            style="padding: 0; border: 1px solid var(--border-color); cursor: cell; position: relative; min-width: ${width}px; ${bgColor ? 'background: ' + bgColor + ';' : ''}">
                                            <div class="glabs-cell-content" style="padding: 8px 10px; min-height: 24px; font-size: 13px; text-align: ${align}; ${textColor ? 'color: ' + textColor + ';' : 'color: var(--text-primary);'} ${bold} ${italic} white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                ${displayValue}
                                            </div>
                                            <div class="glabs-autofill-handle" onmousedown="event.stopPropagation(); glabsStartAutofill(event, ${rowIdx}, ${colIdx})" style="display: none; position: absolute; right: -3px; bottom: -3px; width: 8px; height: 8px; background: var(--accent-primary); border: 1px solid white; cursor: crosshair; z-index: 5;"></div>
                                        </td>
                                    `;
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>

            <!-- Sheet Tabs -->
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-top: 1px solid var(--border-color);">
                ${sheetTabs}
                <button onclick="glabsAddSheet()" style="background: transparent; border: 1px dashed var(--border-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 12px;">
                    <i class="fas fa-plus"></i> New Sheet
                </button>
            </div>
        </div>


        <style>
            .glabs-cell:hover {
                background: var(--bg-hover) !important;
            }
            .glabs-cell.selected {
                outline: 2px solid var(--accent-primary) !important;
                outline-offset: -2px;
                background: rgba(96, 165, 250, 0.15) !important;
            }
            .glabs-cell.in-selection {
                background: rgba(96, 165, 250, 0.25) !important;
            }
            .glabs-cell input {
                width: 100%;
                height: 100%;
                border: none;
                background: white;
                padding: 8px 10px;
                font-family: 'Outfit', sans-serif;
                font-size: 13px;
                outline: none;
                color: #000;
            }
            .glabs-sheet-tab {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                padding: 6px 14px;
                border-radius: 6px 6px 0 0;
                cursor: pointer;
                color: var(--text-muted);
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
            }
            .glabs-sheet-tab:hover {
                background: var(--bg-secondary);
                color: var(--text-primary);
            }
            .glabs-sheet-tab.active {
                background: var(--bg-secondary);
                color: var(--accent-primary);
                border-bottom-color: var(--bg-secondary);
                font-weight: 600;
            }
            .glabs-tab-close {
                font-size: 14px;
                opacity: 0.5;
                margin-left: 4px;
            }
            .glabs-tab-close:hover {
                opacity: 1;
                color: #ef4444;
            }
            .glabs-resize-handle:hover {
                background: var(--accent-primary) !important;
            }
            .glabs-ctx-item {
                padding: 8px 16px;
                cursor: pointer;
                color: var(--text-primary);
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .glabs-ctx-item:hover {
                background: var(--bg-hover);
            }
            .glabs-sheet-tab.drag-over {
                background: var(--accent-primary) !important;
                color: white !important;
            }
            .glabs-sheet-tab[draggable="true"] {
                cursor: grab;
            }
            .glabs-sheet-tab[draggable="true"]:active {
                cursor: grabbing;
            }
        </style>
    `;

    // Close context menu on click outside
    document.addEventListener('click', glabsHideContextMenu);

    // Initialize sheet drag and drop
    setTimeout(() => glabsInitSheetDrag(), 100);
}

// Format value based on format type
function glabsFormatValue(value, format) {
    if (!format) return value;
    if (value === '' || value === null || value === undefined) return '';

    // Remove existing format symbols to get raw number
    const cleanValue = String(value).replace(/[$,%]/g, '').replace(/,/g, '').trim();
    const num = parseFloat(cleanValue);

    if (isNaN(num)) return value; // Return original if not a number

    switch (format) {
        case 'currency':
            return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        case 'percent':
            // Don't multiply by 100 - user enters the number they want to see
            return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + '%';
        case 'number':
            return num.toLocaleString('en-US');
        case 'decimal':
            return num.toFixed(2);
        default:
            return value;
    }
}

// Track drag state
let glabsIsDragging = false;

// Start multi-cell selection
function glabsStartSelection(event, row, col) {
    if (event.button === 2) return; // Ignore right click

    // Check if clicking on an input (already editing)
    if (event.target.tagName === 'INPUT') return;

    glabsIsSelecting = true;
    glabsIsDragging = false;
    glabsSelectionStart = { row, col };
    glabsSelectionEnd = { row, col };
    glabsSelectedCells = [{ row, col }];

    // Clear previous selection
    document.querySelectorAll('.glabs-cell.selected, .glabs-cell.in-selection').forEach(el => {
        el.classList.remove('selected', 'in-selection');
    });

    const td = document.querySelector(`.glabs-cell[data-row="${row}"][data-col="${col}"]`);
    if (td) {
        td.classList.add('selected');
        glabsSelectedCell = { row, col, element: td };
    }

    // Update formula bar
    const colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const cellRef = `${colLetters[col]}${row + 1}`;
    document.getElementById('glabs-cell-ref').textContent = cellRef;

    const sheet = glabsSheets[glabsCurrentSheet];
    document.getElementById('glabs-formula-bar').value = sheet.data[row]?.[col] || '';
}

// Update selection while dragging
function glabsUpdateSelection(event, row, col) {
    if (!glabsIsSelecting) return;

    // Mark as dragging if moved to different cell
    if (glabsSelectionStart && (glabsSelectionStart.row !== row || glabsSelectionStart.col !== col)) {
        glabsIsDragging = true;
    }

    glabsSelectionEnd = { row, col };

    // Clear previous in-selection
    document.querySelectorAll('.glabs-cell.in-selection').forEach(el => {
        el.classList.remove('in-selection');
    });

    // Calculate selection range
    const minRow = Math.min(glabsSelectionStart.row, glabsSelectionEnd.row);
    const maxRow = Math.max(glabsSelectionStart.row, glabsSelectionEnd.row);
    const minCol = Math.min(glabsSelectionStart.col, glabsSelectionEnd.col);
    const maxCol = Math.max(glabsSelectionStart.col, glabsSelectionEnd.col);

    glabsSelectedCells = [];
    for (let r = minRow; r <= maxRow; r++) {
        for (let c = minCol; c <= maxCol; c++) {
            glabsSelectedCells.push({ row: r, col: c });
            const cell = document.querySelector(`.glabs-cell[data-row="${r}"][data-col="${c}"]`);
            if (cell) cell.classList.add('in-selection');
        }
    }

    // Update stats for selected range
    glabsUpdateSelectionStats();

    // Update cell ref to show range
    const colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    if (minRow !== maxRow || minCol !== maxCol) {
        document.getElementById('glabs-cell-ref').textContent =
            `${colLetters[minCol]}${minRow + 1}:${colLetters[maxCol]}${maxRow + 1}`;
    }
}

// End selection
function glabsEndSelection() {
    glabsIsSelecting = false;
    glabsIsDragging = false;

    // Show autofill handle on selected cell
    glabsShowAutofillHandle();
}

// Show autofill handle on the last selected cell
function glabsShowAutofillHandle() {
    // Hide all autofill handles first
    document.querySelectorAll('.glabs-autofill-handle').forEach(h => h.style.display = 'none');

    // Show handle on the last selected cell
    if (glabsSelectedCell) {
        const cell = document.querySelector(`[data-row="${glabsSelectedCell.row}"][data-col="${glabsSelectedCell.col}"]`);
        if (cell) {
            const handle = cell.querySelector('.glabs-autofill-handle');
            if (handle) handle.style.display = 'block';
        }
    }
}

// Select a specific cell (helper function)
function glabsSelectCell(row, col, element) {
    const sheet = glabsSheets[glabsCurrentSheet];
    const colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

    // Clear previous selection
    document.querySelectorAll('.glabs-cell').forEach(cell => {
        const r = parseInt(cell.dataset.row);
        const c = parseInt(cell.dataset.col);
        cell.style.outline = '';
        cell.style.background = sheet.cellStyles?.[`${r}-${c}`]?.bg || '';
    });

    // Set new selection
    glabsSelectedCell = { row, col, element };
    glabsSelectionStart = { row, col };
    glabsSelectionEnd = { row, col };
    glabsSelectedCells = [{ row, col }];

    // Highlight the cell
    element.style.outline = '2px solid var(--accent-primary)';

    // Update formula bar
    const cellRef = `${colLetters[col]}${row + 1}`;
    document.getElementById('glabs-cell-ref').textContent = cellRef;

    const value = sheet.data[row]?.[col] || '';
    document.getElementById('glabs-formula-bar').value = value;

    // Show autofill handle
    glabsShowAutofillHandle();
}

// Store suggested formula for insertion
let glabsSuggestedFormula = '';

// Update stats for selected cells
function glabsUpdateSelectionStats() {
    const sheet = glabsSheets[glabsCurrentSheet];
    let sum = 0, count = 0, numCount = 0;
    let min = Infinity, max = -Infinity;
    let numbers = [];

    glabsSelectedCells.forEach(({ row, col }) => {
        const value = sheet.data[row]?.[col] || '';
        const evaluated = glabsEvaluateCell(value, row, col);
        const num = parseFloat(String(evaluated).replace(/[$,%]/g, '').replace(/,/g, ''));
        if (!isNaN(num)) {
            sum += num;
            numCount++;
            numbers.push(num);
            if (num < min) min = num;
            if (num > max) max = num;
        }
        if (value) count++;
    });

    document.getElementById('glabs-sum').textContent = numCount > 0 ? sum.toLocaleString() : '-';
    document.getElementById('glabs-avg').textContent = numCount > 0 ? (sum / numCount).toLocaleString(undefined, { maximumFractionDigits: 2 }) : '-';
    document.getElementById('glabs-min').textContent = numCount > 0 ? min.toLocaleString() : '-';
    document.getElementById('glabs-max').textContent = numCount > 0 ? max.toLocaleString() : '-';
    document.getElementById('glabs-count').textContent = count > 0 ? count : '-';

    // Update selection range display
    const colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const selectionEl = document.getElementById('glabs-selection-range');
    const formulaSuggestion = document.getElementById('glabs-formula-suggestion');
    const formulaText = document.getElementById('glabs-formula-text');
    const insertBtn = document.getElementById('glabs-insert-formula-btn');

    if (glabsSelectedCells.length === 0) {
        selectionEl.textContent = '-';
        formulaSuggestion.style.display = 'none';
    } else if (glabsSelectedCells.length === 1) {
        const cell = glabsSelectedCells[0];
        selectionEl.textContent = `${colLetters[cell.col] || 'Z'}${cell.row + 1}`;
        formulaSuggestion.style.display = 'none';
    } else {
        // Find range bounds
        const rows = glabsSelectedCells.map(c => c.row);
        const cols = glabsSelectedCells.map(c => c.col);
        const minRow = Math.min(...rows);
        const maxRow = Math.max(...rows);
        const minCol = Math.min(...cols);
        const maxCol = Math.max(...cols);

        const startCell = `${colLetters[minCol] || 'Z'}${minRow + 1}`;
        const endCell = `${colLetters[maxCol] || 'Z'}${maxRow + 1}`;
        selectionEl.textContent = `${startCell}:${endCell}`;

        // Show formula suggestion if numeric values
        if (numCount > 1) {
            glabsSuggestedFormula = `=SUM(${startCell}:${endCell})`;
            formulaText.innerHTML = `To sum these cells, use: <code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; color: var(--accent-primary);">${glabsSuggestedFormula}</code>`;
            formulaSuggestion.style.display = 'block';
            insertBtn.style.display = 'inline-block';
        } else {
            formulaSuggestion.style.display = 'none';
        }
    }
}

// Insert suggested formula into cell below selection
function glabsInsertSuggestedFormula() {
    if (!glabsSuggestedFormula || glabsSelectedCells.length === 0) {
        console.log('No formula or selection');
        return;
    }

    const sheet = glabsSheets[glabsCurrentSheet];

    // Find the bottom of the selection to insert below
    const rows = glabsSelectedCells.map(c => c.row);
    const cols = glabsSelectedCells.map(c => c.col);
    const maxRow = Math.max(...rows);
    const minCol = Math.min(...cols);

    // Target cell is one row below the selection, in the first column of selection
    const targetRow = maxRow + 1;
    const targetCol = minCol;

    // Ensure row exists
    while (sheet.data.length <= targetRow) {
        sheet.data.push(Array(glabsCols).fill(''));
    }

    // Save state for undo
    glabsSaveState();

    // Insert formula
    sheet.data[targetRow][targetCol] = glabsSuggestedFormula;

    // Update display
    glabsSaveData();
    renderGLabs();

    // Select the cell with formula
    setTimeout(() => {
        glabsSelectCell(targetRow, targetCol);
    }, 50);
}

// Show context menu
function glabsShowContextMenu(event, row, col) {
    event.preventDefault();

    // Select the cell if not already selected
    if (!glabsSelectedCells.some(c => c.row === row && c.col === col)) {
        glabsSelectedCells = [{ row, col }];
        glabsSelectedCell = { row, col };
        document.querySelectorAll('.glabs-cell.selected, .glabs-cell.in-selection').forEach(el => {
            el.classList.remove('selected', 'in-selection');
        });
        const td = document.querySelector(`.glabs-cell[data-row="${row}"][data-col="${col}"]`);
        if (td) td.classList.add('selected');
    }

    const menu = document.getElementById('glabs-context-menu');
    menu.style.display = 'block';

    // Position menu, ensuring it doesn't go off screen
    const menuHeight = menu.offsetHeight || 400;
    const menuWidth = menu.offsetWidth || 180;
    const windowHeight = window.innerHeight;
    const windowWidth = window.innerWidth;

    let left = event.clientX;
    let top = event.clientY;

    // Adjust if menu would go off right edge
    if (left + menuWidth > windowWidth) {
        left = windowWidth - menuWidth - 10;
    }

    // Adjust if menu would go off bottom edge
    if (top + menuHeight > windowHeight) {
        top = windowHeight - menuHeight - 10;
    }

    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
}

// Hide context menu
function glabsHideContextMenu() {
    const menu = document.getElementById('glabs-context-menu');
    if (menu) menu.style.display = 'none';
}

// Format functions
function glabsApplyFormat(formatType, styleKey, styleValue) {
    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    if (!sheet.cellStyles) sheet.cellStyles = {};

    glabsSelectedCells.forEach(({ row, col }) => {
        const key = `${row}-${col}`;
        if (!sheet.cellStyles[key]) sheet.cellStyles[key] = {};
        if (formatType) sheet.cellStyles[key].format = formatType;
        if (styleKey) sheet.cellStyles[key][styleKey] = styleValue;
    });

    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

function glabsFormatCurrency() { glabsApplyFormat('currency'); }
function glabsFormatPercent() { glabsApplyFormat('percent'); }
function glabsFormatNumber() { glabsApplyFormat('number'); }
function glabsFormatDecimal() { glabsApplyFormat('decimal'); }
function glabsFormatBold() { glabsApplyFormat(null, 'bold', true); }
function glabsFormatItalic() { glabsApplyFormat(null, 'italic', true); }
function glabsAlignLeft() { glabsApplyFormat(null, 'align', 'left'); }
function glabsAlignCenter() { glabsApplyFormat(null, 'align', 'center'); }
function glabsAlignRight() { glabsApplyFormat(null, 'align', 'right'); }

// Select entire row
function glabsSelectRow(rowIdx) {
    const sheet = glabsSheets[glabsCurrentSheet];
    const cols = sheet.data[0]?.length || glabsCols;

    glabsSelectionStart = { row: rowIdx, col: 0 };
    glabsSelectionEnd = { row: rowIdx, col: cols - 1 };
    glabsSelectedCells = [];

    for (let c = 0; c < cols; c++) {
        glabsSelectedCells.push({ row: rowIdx, col: c });
    }

    // Highlight cells
    document.querySelectorAll('.glabs-cell').forEach(cell => {
        const r = parseInt(cell.dataset.row);
        if (r === rowIdx) {
            cell.style.outline = '2px solid var(--accent-primary)';
            cell.style.background = 'rgba(99, 102, 241, 0.1)';
        } else {
            cell.style.outline = '';
            cell.style.background = sheet.cellStyles?.[`${r}-${cell.dataset.col}`]?.bg || '';
        }
    });

    // Set first cell as selected for formula bar
    const firstCell = document.querySelector(`[data-row="${rowIdx}"][data-col="0"]`);
    if (firstCell) glabsSelectCell(rowIdx, 0, firstCell);

    document.getElementById('glabs-cell-ref').textContent = `${rowIdx + 1}:${rowIdx + 1}`;
}

// Select entire column
function glabsSelectColumn(colIdx) {
    const sheet = glabsSheets[glabsCurrentSheet];
    const rows = sheet.data.length || glabsRows;
    const colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

    glabsSelectionStart = { row: 0, col: colIdx };
    glabsSelectionEnd = { row: rows - 1, col: colIdx };
    glabsSelectedCells = [];

    for (let r = 0; r < rows; r++) {
        glabsSelectedCells.push({ row: r, col: colIdx });
    }

    // Highlight cells
    document.querySelectorAll('.glabs-cell').forEach(cell => {
        const c = parseInt(cell.dataset.col);
        const r = parseInt(cell.dataset.row);
        if (c === colIdx) {
            cell.style.outline = '2px solid var(--accent-primary)';
            cell.style.background = 'rgba(99, 102, 241, 0.1)';
        } else {
            cell.style.outline = '';
            cell.style.background = sheet.cellStyles?.[`${r}-${c}`]?.bg || '';
        }
    });

    // Set first cell as selected for formula bar
    const firstCell = document.querySelector(`[data-row="0"][data-col="${colIdx}"]`);
    if (firstCell) glabsSelectCell(0, colIdx, firstCell);

    document.getElementById('glabs-cell-ref').textContent = `${colLetters[colIdx]}:${colLetters[colIdx]}`;
}

// Select all cells
function glabsSelectAll() {
    const sheet = glabsSheets[glabsCurrentSheet];
    const rows = sheet.data.length || glabsRows;
    const cols = sheet.data[0]?.length || glabsCols;

    glabsSelectionStart = { row: 0, col: 0 };
    glabsSelectionEnd = { row: rows - 1, col: cols - 1 };
    glabsSelectedCells = [];

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            glabsSelectedCells.push({ row: r, col: c });
        }
    }

    // Highlight all cells
    document.querySelectorAll('.glabs-cell').forEach(cell => {
        cell.style.outline = '2px solid var(--accent-primary)';
        cell.style.background = 'rgba(99, 102, 241, 0.1)';
    });

    document.getElementById('glabs-cell-ref').textContent = 'All';
}

// Autofill state
let glabsAutofillStart = null;
let glabsAutofillEnd = null;
let glabsIsAutofilling = false;

// Start autofill
function glabsStartAutofill(event, row, col) {
    event.preventDefault();
    glabsIsAutofilling = true;
    glabsAutofillStart = { row, col };
    glabsAutofillEnd = { row, col };

    document.addEventListener('mousemove', glabsAutofillMove);
    document.addEventListener('mouseup', glabsAutofillFinish);
}

function glabsAutofillMove(event) {
    if (!glabsIsAutofilling) return;

    const cell = document.elementFromPoint(event.clientX, event.clientY);
    if (cell && cell.classList.contains('glabs-cell')) {
        glabsAutofillEnd = {
            row: parseInt(cell.dataset.row),
            col: parseInt(cell.dataset.col)
        };

        // Highlight autofill range
        document.querySelectorAll('.glabs-cell').forEach(c => {
            const r = parseInt(c.dataset.row);
            const col = parseInt(c.dataset.col);
            const inRange = isInAutofillRange(r, col);
            if (inRange) {
                c.style.outline = '2px dashed var(--accent-primary)';
            } else {
                c.style.outline = '';
            }
        });
    }
}

function isInAutofillRange(row, col) {
    if (!glabsAutofillStart || !glabsAutofillEnd) return false;

    const startRow = glabsAutofillStart.row;
    const startCol = glabsAutofillStart.col;
    const endRow = glabsAutofillEnd.row;
    const endCol = glabsAutofillEnd.col;

    // Autofill either horizontally or vertically
    if (startCol === endCol) {
        // Vertical autofill
        const minRow = Math.min(startRow, endRow);
        const maxRow = Math.max(startRow, endRow);
        return col === startCol && row >= minRow && row <= maxRow;
    } else if (startRow === endRow) {
        // Horizontal autofill
        const minCol = Math.min(startCol, endCol);
        const maxCol = Math.max(startCol, endCol);
        return row === startRow && col >= minCol && col <= maxCol;
    }
    return false;
}

function glabsAutofillFinish() {
    if (!glabsIsAutofilling) return;

    document.removeEventListener('mousemove', glabsAutofillMove);
    document.removeEventListener('mouseup', glabsAutofillFinish);

    glabsIsAutofilling = false;

    if (!glabsAutofillStart || !glabsAutofillEnd) return;
    if (glabsAutofillStart.row === glabsAutofillEnd.row && glabsAutofillStart.col === glabsAutofillEnd.col) return;

    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    const sourceValue = sheet.data[glabsAutofillStart.row]?.[glabsAutofillStart.col] || '';
    const sourceStyle = sheet.cellStyles?.[`${glabsAutofillStart.row}-${glabsAutofillStart.col}`] || {};

    // Detect if value is a number for incrementing
    const numMatch = sourceValue.match(/^(\D*)(\d+)(\D*)$/);
    let baseText = '';
    let baseNum = null;
    let suffix = '';

    if (numMatch) {
        baseText = numMatch[1];
        baseNum = parseInt(numMatch[2]);
        suffix = numMatch[3];
    }

    const startRow = glabsAutofillStart.row;
    const startCol = glabsAutofillStart.col;
    const endRow = glabsAutofillEnd.row;
    const endCol = glabsAutofillEnd.col;

    if (!sheet.cellStyles) sheet.cellStyles = {};

    if (startCol === endCol) {
        // Vertical autofill
        const minRow = Math.min(startRow, endRow);
        const maxRow = Math.max(startRow, endRow);
        const direction = endRow > startRow ? 1 : -1;

        for (let r = minRow; r <= maxRow; r++) {
            if (r === startRow) continue;
            if (!sheet.data[r]) sheet.data[r] = [];

            const offset = (r - startRow) * direction;
            if (baseNum !== null) {
                sheet.data[r][startCol] = baseText + (baseNum + offset) + suffix;
            } else {
                sheet.data[r][startCol] = sourceValue;
            }
            sheet.cellStyles[`${r}-${startCol}`] = { ...sourceStyle };
        }
    } else if (startRow === endRow) {
        // Horizontal autofill
        const minCol = Math.min(startCol, endCol);
        const maxCol = Math.max(startCol, endCol);
        const direction = endCol > startCol ? 1 : -1;

        for (let c = minCol; c <= maxCol; c++) {
            if (c === startCol) continue;
            if (!sheet.data[startRow]) sheet.data[startRow] = [];

            const offset = (c - startCol) * direction;
            if (baseNum !== null) {
                sheet.data[startRow][c] = baseText + (baseNum + offset) + suffix;
            } else {
                sheet.data[startRow][c] = sourceValue;
            }
            sheet.cellStyles[`${startRow}-${c}`] = { ...sourceStyle };
        }
    }

    glabsAutofillStart = null;
    glabsAutofillEnd = null;

    glabsSaveData();
    renderGLabs();
}

// ==================== SORT FUNCTIONS ====================

// Sort column A-Z (alphabetically)
function glabsSortAZ() {
    if (!glabsSelectedCell) return;
    glabsSortColumn(glabsSelectedCell.col, 'az');
}

// Sort column Z-A (alphabetically descending)
function glabsSortZA() {
    if (!glabsSelectedCell) return;
    glabsSortColumn(glabsSelectedCell.col, 'za');
}

// Sort column numerically ascending
function glabsSortNumAsc() {
    if (!glabsSelectedCell) return;
    glabsSortColumn(glabsSelectedCell.col, 'numasc');
}

// Sort column numerically descending
function glabsSortNumDesc() {
    if (!glabsSelectedCell) return;
    glabsSortColumn(glabsSelectedCell.col, 'numdesc');
}

// Generic sort function
function glabsSortColumn(colIdx, sortType) {
    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    const data = sheet.data;

    // Get all rows with their original indices
    const rows = data.map((row, idx) => ({ row, idx, styles: {} }));

    // Store styles for each row
    rows.forEach((item, rowIdx) => {
        const numCols = item.row?.length || 0;
        for (let c = 0; c < numCols; c++) {
            const styleKey = `${rowIdx}-${c}`;
            if (sheet.cellStyles?.[styleKey]) {
                item.styles[c] = { ...sheet.cellStyles[styleKey] };
            }
        }
    });

    // Sort based on the specified column
    rows.sort((a, b) => {
        const valA = a.row?.[colIdx] || '';
        const valB = b.row?.[colIdx] || '';

        // Clean values for comparison
        const cleanA = String(valA).replace(/[$,%]/g, '').replace(/,/g, '');
        const cleanB = String(valB).replace(/[$,%]/g, '').replace(/,/g, '');

        if (sortType === 'az') {
            return String(valA).localeCompare(String(valB));
        } else if (sortType === 'za') {
            return String(valB).localeCompare(String(valA));
        } else if (sortType === 'numasc') {
            const numA = parseFloat(cleanA) || 0;
            const numB = parseFloat(cleanB) || 0;
            return numA - numB;
        } else if (sortType === 'numdesc') {
            const numA = parseFloat(cleanA) || 0;
            const numB = parseFloat(cleanB) || 0;
            return numB - numA;
        }
        return 0;
    });

    // Rebuild data and styles
    sheet.data = rows.map(item => item.row);
    sheet.cellStyles = {};

    rows.forEach((item, newRowIdx) => {
        Object.keys(item.styles).forEach(colKey => {
            sheet.cellStyles[`${newRowIdx}-${colKey}`] = item.styles[colKey];
        });
    });

    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

// ==================== INSERT/DELETE FUNCTIONS ====================

// Insert row above selected row
function glabsInsertRowAbove() {
    if (!glabsSelectedCell) return;
    glabsInsertRow(glabsSelectedCell.row);
}

// Insert row below selected row
function glabsInsertRowBelow() {
    if (!glabsSelectedCell) return;
    glabsInsertRow(glabsSelectedCell.row + 1);
}

// Insert row at index
function glabsInsertRow(atIndex) {
    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    const numCols = sheet.data[0]?.length || glabsCols;

    // Create new empty row
    const newRow = Array(numCols).fill('');

    // Insert the row
    sheet.data.splice(atIndex, 0, newRow);

    // Shift cell styles down
    const newStyles = {};
    Object.keys(sheet.cellStyles || {}).forEach(key => {
        const [r, c] = key.split('-').map(Number);
        if (r >= atIndex) {
            newStyles[`${r + 1}-${c}`] = sheet.cellStyles[key];
        } else {
            newStyles[key] = sheet.cellStyles[key];
        }
    });
    sheet.cellStyles = newStyles;

    // Shift merged cells
    if (sheet.mergedCells) {
        sheet.mergedCells = sheet.mergedCells.map(merge => {
            if (merge.startRow >= atIndex) {
                return { ...merge, startRow: merge.startRow + 1, endRow: merge.endRow + 1 };
            } else if (merge.endRow >= atIndex) {
                return { ...merge, endRow: merge.endRow + 1 };
            }
            return merge;
        });
    }

    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

// Insert column left of selected column
function glabsInsertColLeft() {
    if (!glabsSelectedCell) return;
    glabsInsertCol(glabsSelectedCell.col);
}

// Insert column right of selected column
function glabsInsertColRight() {
    if (!glabsSelectedCell) return;
    glabsInsertCol(glabsSelectedCell.col + 1);
}

// Insert column at index
function glabsInsertCol(atIndex) {
    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];

    // Insert empty cell in each row
    sheet.data.forEach(row => {
        if (row) row.splice(atIndex, 0, '');
    });

    // Shift cell styles right
    const newStyles = {};
    Object.keys(sheet.cellStyles || {}).forEach(key => {
        const [r, c] = key.split('-').map(Number);
        if (c >= atIndex) {
            newStyles[`${r}-${c + 1}`] = sheet.cellStyles[key];
        } else {
            newStyles[key] = sheet.cellStyles[key];
        }
    });
    sheet.cellStyles = newStyles;

    // Shift column widths
    const newWidths = {};
    Object.keys(sheet.colWidths || {}).forEach(key => {
        const c = parseInt(key);
        if (c >= atIndex) {
            newWidths[c + 1] = sheet.colWidths[key];
        } else {
            newWidths[c] = sheet.colWidths[key];
        }
    });
    sheet.colWidths = newWidths;

    // Shift merged cells
    if (sheet.mergedCells) {
        sheet.mergedCells = sheet.mergedCells.map(merge => {
            if (merge.startCol >= atIndex) {
                return { ...merge, startCol: merge.startCol + 1, endCol: merge.endCol + 1 };
            } else if (merge.endCol >= atIndex) {
                return { ...merge, endCol: merge.endCol + 1 };
            }
            return merge;
        });
    }

    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

// Delete selected row
function glabsDeleteRow() {
    if (!glabsSelectedCell) return;

    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    const rowIdx = glabsSelectedCell.row;

    // Remove the row
    sheet.data.splice(rowIdx, 1);

    // Ensure at least one row exists
    if (sheet.data.length === 0) {
        sheet.data.push(Array(glabsCols).fill(''));
    }

    // Shift cell styles up
    const newStyles = {};
    Object.keys(sheet.cellStyles || {}).forEach(key => {
        const [r, c] = key.split('-').map(Number);
        if (r > rowIdx) {
            newStyles[`${r - 1}-${c}`] = sheet.cellStyles[key];
        } else if (r < rowIdx) {
            newStyles[key] = sheet.cellStyles[key];
        }
        // Skip styles for deleted row
    });
    sheet.cellStyles = newStyles;

    // Update merged cells
    if (sheet.mergedCells) {
        sheet.mergedCells = sheet.mergedCells
            .filter(merge => !(merge.startRow <= rowIdx && merge.endRow >= rowIdx))
            .map(merge => {
                if (merge.startRow > rowIdx) {
                    return { ...merge, startRow: merge.startRow - 1, endRow: merge.endRow - 1 };
                }
                return merge;
            });
    }

    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

// Delete selected column
function glabsDeleteCol() {
    if (!glabsSelectedCell) return;

    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    const colIdx = glabsSelectedCell.col;

    // Remove cell from each row
    sheet.data.forEach(row => {
        if (row && row.length > colIdx) {
            row.splice(colIdx, 1);
        }
    });

    // Ensure at least one column exists
    if (sheet.data[0]?.length === 0) {
        sheet.data.forEach(row => row.push(''));
    }

    // Shift cell styles left
    const newStyles = {};
    Object.keys(sheet.cellStyles || {}).forEach(key => {
        const [r, c] = key.split('-').map(Number);
        if (c > colIdx) {
            newStyles[`${r}-${c - 1}`] = sheet.cellStyles[key];
        } else if (c < colIdx) {
            newStyles[key] = sheet.cellStyles[key];
        }
    });
    sheet.cellStyles = newStyles;

    // Shift column widths
    const newWidths = {};
    Object.keys(sheet.colWidths || {}).forEach(key => {
        const c = parseInt(key);
        if (c > colIdx) {
            newWidths[c - 1] = sheet.colWidths[key];
        } else if (c < colIdx) {
            newWidths[c] = sheet.colWidths[key];
        }
    });
    sheet.colWidths = newWidths;

    // Update merged cells
    if (sheet.mergedCells) {
        sheet.mergedCells = sheet.mergedCells
            .filter(merge => !(merge.startCol <= colIdx && merge.endCol >= colIdx))
            .map(merge => {
                if (merge.startCol > colIdx) {
                    return { ...merge, startCol: merge.startCol - 1, endCol: merge.endCol - 1 };
                }
                return merge;
            });
    }

    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

// ==================== MERGE CELLS FUNCTIONS ====================

// Merge selected cells
function glabsMergeCells() {
    if (!glabsSelectionStart || !glabsSelectionEnd) return;
    if (glabsSelectionStart.row === glabsSelectionEnd.row && glabsSelectionStart.col === glabsSelectionEnd.col) return;

    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    if (!sheet.mergedCells) sheet.mergedCells = [];

    const startRow = Math.min(glabsSelectionStart.row, glabsSelectionEnd.row);
    const endRow = Math.max(glabsSelectionStart.row, glabsSelectionEnd.row);
    const startCol = Math.min(glabsSelectionStart.col, glabsSelectionEnd.col);
    const endCol = Math.max(glabsSelectionStart.col, glabsSelectionEnd.col);

    // Check if any cell in the range is already merged
    const hasOverlap = sheet.mergedCells.some(merge => {
        return !(merge.endRow < startRow || merge.startRow > endRow ||
                 merge.endCol < startCol || merge.startCol > endCol);
    });

    if (hasOverlap) {
        alert('Cannot merge: Some cells are already merged');
        glabsHideContextMenu();
        return;
    }

    // Keep value of first cell, clear others
    const firstValue = sheet.data[startRow]?.[startCol] || '';
    for (let r = startRow; r <= endRow; r++) {
        for (let c = startCol; c <= endCol; c++) {
            if (r === startRow && c === startCol) continue;
            if (sheet.data[r]) sheet.data[r][c] = '';
        }
    }

    // Add merge record
    sheet.mergedCells.push({ startRow, endRow, startCol, endCol });

    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

// Unmerge cells
function glabsUnmergeCells() {
    if (!glabsSelectedCell) return;

    const sheet = glabsSheets[glabsCurrentSheet];
    if (!sheet.mergedCells) return;

    const { row, col } = glabsSelectedCell;

    // Find merge that contains this cell
    const mergeIdx = sheet.mergedCells.findIndex(merge => {
        return row >= merge.startRow && row <= merge.endRow &&
               col >= merge.startCol && col <= merge.endCol;
    });

    if (mergeIdx === -1) return;

    glabsSaveUndoState();

    // Remove the merge
    sheet.mergedCells.splice(mergeIdx, 1);

    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

// Check if cell is part of a merge (but not the main cell)
function glabsIsMergedSlave(row, col, sheet) {
    if (!sheet.mergedCells) return false;

    return sheet.mergedCells.some(merge => {
        if (row === merge.startRow && col === merge.startCol) return false; // Main cell
        return row >= merge.startRow && row <= merge.endRow &&
               col >= merge.startCol && col <= merge.endCol;
    });
}

// Get merge info for a cell
function glabsGetMerge(row, col, sheet) {
    if (!sheet.mergedCells) return null;

    return sheet.mergedCells.find(merge => {
        return row === merge.startRow && col === merge.startCol;
    });
}

// ==================== FIND & REPLACE FUNCTIONS ====================

let glabsFindIndex = -1;
let glabsFindResults = [];

// Show find dialog
function glabsShowFindDialog() {
    const dialog = document.getElementById('glabs-find-dialog');
    dialog.style.display = 'block';
    document.getElementById('glabs-find-input').focus();
    document.getElementById('glabs-find-status').textContent = '';
}

// Close find dialog
function glabsCloseFindDialog() {
    document.getElementById('glabs-find-dialog').style.display = 'none';
    glabsFindIndex = -1;
    glabsFindResults = [];

    // Clear highlights
    document.querySelectorAll('.glabs-cell').forEach(cell => {
        cell.classList.remove('glabs-find-highlight');
    });
}

// Find all matches
function glabsFindAll(searchText) {
    if (!searchText) return [];

    const sheet = glabsSheets[glabsCurrentSheet];
    const results = [];
    const searchLower = searchText.toLowerCase();

    sheet.data.forEach((row, rowIdx) => {
        if (!row) return;
        row.forEach((cell, colIdx) => {
            if (cell && String(cell).toLowerCase().includes(searchLower)) {
                results.push({ row: rowIdx, col: colIdx });
            }
        });
    });

    return results;
}

// Find next match
function glabsFindNext() {
    const searchText = document.getElementById('glabs-find-input').value;
    if (!searchText) {
        document.getElementById('glabs-find-status').textContent = 'Enter text to search';
        return;
    }

    glabsFindResults = glabsFindAll(searchText);

    if (glabsFindResults.length === 0) {
        document.getElementById('glabs-find-status').textContent = 'No matches found';
        return;
    }

    // Move to next result
    glabsFindIndex = (glabsFindIndex + 1) % glabsFindResults.length;

    const match = glabsFindResults[glabsFindIndex];

    // Clear previous highlights
    document.querySelectorAll('.glabs-cell').forEach(cell => {
        cell.style.background = '';
    });

    // Highlight all matches lightly
    glabsFindResults.forEach(({ row, col }) => {
        const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        if (cell) cell.style.background = 'rgba(255, 193, 7, 0.2)';
    });

    // Highlight current match
    const currentCell = document.querySelector(`[data-row="${match.row}"][data-col="${match.col}"]`);
    if (currentCell) {
        currentCell.style.background = 'rgba(255, 193, 7, 0.5)';
        currentCell.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Select the cell
        glabsSelectCell(match.row, match.col, currentCell);
    }

    document.getElementById('glabs-find-status').textContent =
        `${glabsFindIndex + 1} of ${glabsFindResults.length} matches`;
}

// Replace current match
function glabsReplace() {
    if (glabsFindResults.length === 0 || glabsFindIndex < 0) {
        glabsFindNext();
        return;
    }

    const searchText = document.getElementById('glabs-find-input').value;
    const replaceText = document.getElementById('glabs-replace-input').value;

    if (!searchText) return;

    glabsSaveUndoState();

    const match = glabsFindResults[glabsFindIndex];
    const sheet = glabsSheets[glabsCurrentSheet];

    // Replace in the cell
    const currentValue = sheet.data[match.row]?.[match.col] || '';
    const newValue = currentValue.replace(new RegExp(searchText, 'gi'), replaceText);

    if (!sheet.data[match.row]) sheet.data[match.row] = [];
    sheet.data[match.row][match.col] = newValue;

    glabsSaveData();

    // Remove this match from results
    glabsFindResults.splice(glabsFindIndex, 1);

    // Adjust index
    if (glabsFindIndex >= glabsFindResults.length) {
        glabsFindIndex = 0;
    }

    // Find next or update status
    if (glabsFindResults.length > 0) {
        glabsFindIndex--; // Will be incremented in findNext
        glabsFindNext();
    } else {
        document.getElementById('glabs-find-status').textContent = 'All matches replaced';
        renderGLabs();
    }
}

// Replace all matches
function glabsReplaceAll() {
    const searchText = document.getElementById('glabs-find-input').value;
    const replaceText = document.getElementById('glabs-replace-input').value;

    if (!searchText) {
        document.getElementById('glabs-find-status').textContent = 'Enter text to search';
        return;
    }

    const results = glabsFindAll(searchText);

    if (results.length === 0) {
        document.getElementById('glabs-find-status').textContent = 'No matches found';
        return;
    }

    glabsSaveUndoState();

    const sheet = glabsSheets[glabsCurrentSheet];
    let count = 0;

    results.forEach(({ row, col }) => {
        const currentValue = sheet.data[row]?.[col] || '';
        const newValue = currentValue.replace(new RegExp(searchText, 'gi'), replaceText);

        if (!sheet.data[row]) sheet.data[row] = [];
        sheet.data[row][col] = newValue;
        count++;
    });

    glabsSaveData();
    glabsFindResults = [];
    glabsFindIndex = -1;

    document.getElementById('glabs-find-status').textContent = `Replaced ${count} matches`;
    renderGLabs();
}

function glabsClearFormat() {
    const sheet = glabsSheets[glabsCurrentSheet];
    glabsSelectedCells.forEach(({ row, col }) => {
        const key = `${row}-${col}`;
        if (sheet.cellStyles?.[key]) {
            delete sheet.cellStyles[key].format;
            delete sheet.cellStyles[key].bold;
            delete sheet.cellStyles[key].italic;
        }
    });
    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

function glabsDeleteCellContent() {
    const sheet = glabsSheets[glabsCurrentSheet];
    glabsSelectedCells.forEach(({ row, col }) => {
        if (sheet.data[row]) sheet.data[row][col] = '';
    });
    glabsSaveData();
    glabsHideContextMenu();
    renderGLabs();
}

// Edit a cell (single click)
function glabsEditCell(td, row, col) {
    if (!td) return;
    const sheet = glabsSheets[glabsCurrentSheet];
    const currentValue = sheet.data[row]?.[col] || '';
    const contentDiv = td.querySelector('.glabs-cell-content');
    if (!contentDiv) return;

    // Use a safer way to handle the value with special characters
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.onblur = function() { glabsSaveCell(this, row, col); };
    input.onkeydown = function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            glabsSaveCell(this, row, col);
            // Move to next row
            const nextCell = document.querySelector(`.glabs-cell[data-row="${row + 1}"][data-col="${col}"]`);
            if (nextCell) {
                glabsStartSelection({ button: 0 }, row + 1, col);
            }
        } else if (event.key === 'Tab') {
            event.preventDefault();
            glabsSaveCell(this, row, col);
            glabsMoveNext(row, col, event.shiftKey);
        } else if (event.key === 'Escape') {
            renderGLabs();
        } else if (event.key === 'ArrowDown') {
            event.preventDefault();
            glabsSaveCell(this, row, col);
            const nextCell = document.querySelector(`.glabs-cell[data-row="${row + 1}"][data-col="${col}"]`);
            if (nextCell) glabsStartSelection({ button: 0 }, row + 1, col);
        } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            glabsSaveCell(this, row, col);
            const nextCell = document.querySelector(`.glabs-cell[data-row="${row - 1}"][data-col="${col}"]`);
            if (nextCell) glabsStartSelection({ button: 0 }, row - 1, col);
        } else if (event.key === 'ArrowRight' && this.selectionStart === this.value.length) {
            event.preventDefault();
            glabsSaveCell(this, row, col);
            glabsMoveNext(row, col, false);
        } else if (event.key === 'ArrowLeft' && this.selectionStart === 0) {
            event.preventDefault();
            glabsSaveCell(this, row, col);
            glabsMoveNext(row, col, true);
        }
    };

    contentDiv.innerHTML = '';
    contentDiv.appendChild(input);
    input.focus();
    input.select();
}

// Save cell value
function glabsSaveCell(input, row, col) {
    const value = input.value;
    const sheet = glabsSheets[glabsCurrentSheet];

    // Save undo state before modifying
    glabsSaveUndoState();

    // Ensure row exists
    if (!sheet.data[row]) {
        sheet.data[row] = [];
    }

    sheet.data[row][col] = value;

    // Save to localStorage
    glabsSaveData();

    // Re-render the cell with proper formatting
    const evaluatedValue = glabsEvaluateCell(value, row, col);
    const cellStyle = sheet.cellStyles?.[`${row}-${col}`] || {};
    const displayValue = glabsFormatValue(evaluatedValue, cellStyle.format);
    const textColor = cellStyle.color || '';
    const bold = cellStyle.bold ? 'font-weight: 700;' : '';
    const italic = cellStyle.italic ? 'font-style: italic;' : '';

    if (input.parentElement) {
        input.parentElement.innerHTML = `<span style="${textColor ? 'color: ' + textColor + ';' : ''} ${bold} ${italic}">${displayValue}</span>`;
    }

    // Show saved indicator
    const savedEl = document.getElementById('glabs-saved');
    if (savedEl) savedEl.innerHTML = '<i class="fas fa-check-circle"></i> Saved';
}

// Move to next cell
function glabsMoveNext(row, col, backwards) {
    const sheet = glabsSheets[glabsCurrentSheet];
    const actualCols = sheet.data[0]?.length || glabsCols;
    const nextCol = backwards ? col - 1 : col + 1;
    const nextRow = row;

    if (nextCol >= 0 && nextCol < actualCols) {
        const nextCell = document.querySelector(`.glabs-cell[data-row="${nextRow}"][data-col="${nextCol}"]`);
        if (nextCell) {
            glabsSelectCell(nextCell, nextRow, nextCol);
            glabsEditCell(nextCell, nextRow, nextCol);
        }
    }
}

// Toggle color picker
function glabsToggleColorPicker() {
    const picker = document.getElementById('glabs-color-picker');
    const textPicker = document.getElementById('glabs-text-color-picker');
    if (textPicker) textPicker.style.display = 'none';
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
}

// Toggle text color picker
function glabsToggleTextColorPicker() {
    const picker = document.getElementById('glabs-text-color-picker');
    const bgPicker = document.getElementById('glabs-color-picker');
    if (bgPicker) bgPicker.style.display = 'none';
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
}

// Set cell background color
function glabsSetCellColor(color) {
    if (!glabsSelectedCell) return;

    glabsSaveUndoState();

    const { row, col, element } = glabsSelectedCell;
    const sheet = glabsSheets[glabsCurrentSheet];

    if (!sheet.cellStyles) sheet.cellStyles = {};
    if (!sheet.cellStyles[`${row}-${col}`]) sheet.cellStyles[`${row}-${col}`] = {};

    sheet.cellStyles[`${row}-${col}`].bg = color;

    if (color) {
        element.style.background = color;
    } else {
        element.style.background = '';
    }

    glabsSaveData();
    document.getElementById('glabs-color-picker').style.display = 'none';
    document.getElementById('glabs-color-preview').style.background = color || '#ffffff';
}

// Set cell text color
function glabsSetTextColor(color) {
    if (!glabsSelectedCell) return;

    glabsSaveUndoState();

    const { row, col, element } = glabsSelectedCell;
    const sheet = glabsSheets[glabsCurrentSheet];

    if (!sheet.cellStyles) sheet.cellStyles = {};
    if (!sheet.cellStyles[`${row}-${col}`]) sheet.cellStyles[`${row}-${col}`] = {};

    sheet.cellStyles[`${row}-${col}`].color = color;

    const contentDiv = element.querySelector('.glabs-cell-content');
    if (contentDiv) {
        contentDiv.style.color = color || '';
    }

    glabsSaveData();
    document.getElementById('glabs-text-color-picker').style.display = 'none';
    document.getElementById('glabs-text-color-preview').style.background = color || '#000000';
}

// Set column width
function glabsSetColumnWidth(width) {
    if (!glabsSelectedCell || !width) return;

    const { col } = glabsSelectedCell;
    const sheet = glabsSheets[glabsCurrentSheet];

    if (!sheet.colWidths) sheet.colWidths = {};
    sheet.colWidths[col] = parseInt(width);

    glabsSaveData();
    renderGLabs();
}

// Column resize functionality
let glabsResizing = null;

function glabsStartResize(event, colIndex) {
    event.preventDefault();
    glabsResizing = { col: colIndex, startX: event.clientX };

    document.addEventListener('mousemove', glabsDoResize);
    document.addEventListener('mouseup', glabsStopResize);
}

function glabsDoResize(event) {
    if (!glabsResizing) return;

    const sheet = glabsSheets[glabsCurrentSheet];
    const currentWidth = sheet.colWidths?.[glabsResizing.col] || 100;
    const diff = event.clientX - glabsResizing.startX;
    const newWidth = Math.max(40, currentWidth + diff);

    // Update all cells in this column
    const cells = document.querySelectorAll(`th[data-col="${glabsResizing.col}"], td[data-col="${glabsResizing.col}"]`);
    cells.forEach(cell => {
        cell.style.minWidth = newWidth + 'px';
        cell.style.width = newWidth + 'px';
    });

    glabsResizing.startX = event.clientX;
    if (!sheet.colWidths) sheet.colWidths = {};
    sheet.colWidths[glabsResizing.col] = newWidth;
}

function glabsStopResize() {
    if (glabsResizing) {
        glabsSaveData();
        glabsResizing = null;
    }
    document.removeEventListener('mousemove', glabsDoResize);
    document.removeEventListener('mouseup', glabsStopResize);
}

// Sheet management
function glabsAddSheet() {
    const sheetCount = Object.keys(glabsSheets).length + 1;
    let newName = `Sheet ${sheetCount}`;

    // Find unique name
    while (glabsSheets[newName]) {
        newName = `Sheet ${sheetCount + Math.floor(Math.random() * 100)}`;
    }

    glabsInitSheet(newName);
    glabsCurrentSheet = newName;
    glabsSaveData();
    renderGLabs();
}

function glabsSwitchSheet(name) {
    if (glabsSheets[name]) {
        glabsCurrentSheet = name;
        glabsSaveData();
        renderGLabs();
    }
}

function glabsRenameSheet(oldName) {
    const newName = prompt('Nuevo nombre de la hoja:', oldName);
    if (newName && newName !== oldName && !glabsSheets[newName]) {
        glabsSheets[newName] = glabsSheets[oldName];
        delete glabsSheets[oldName];
        if (glabsCurrentSheet === oldName) {
            glabsCurrentSheet = newName;
        }
        glabsSaveData();
        renderGLabs();
    }
}

function glabsDeleteSheet(name) {
    if (Object.keys(glabsSheets).length <= 1) {
        alert('You cannot delete the only sheet.');
        return;
    }

    if (confirm(`Delete sheet "${name}"?`)) {
        delete glabsSheets[name];
        if (glabsCurrentSheet === name) {
            glabsCurrentSheet = Object.keys(glabsSheets)[0];
        }
        glabsSaveData();
        renderGLabs();
    }
}

// Drag and drop sheet reordering
let glabsDraggedSheet = null;

function glabsInitSheetDrag() {
    const tabs = document.querySelectorAll('.glabs-sheet-tab');
    tabs.forEach(tab => {
        tab.setAttribute('draggable', 'true');
        tab.addEventListener('dragstart', glabsSheetDragStart);
        tab.addEventListener('dragover', glabsSheetDragOver);
        tab.addEventListener('drop', glabsSheetDrop);
        tab.addEventListener('dragend', glabsSheetDragEnd);
    });
}

function glabsSheetDragStart(e) {
    glabsDraggedSheet = e.target.textContent.trim().replace('√ó', '').trim();
    e.target.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
}

function glabsSheetDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    e.target.closest('.glabs-sheet-tab')?.classList.add('drag-over');
}

function glabsSheetDrop(e) {
    e.preventDefault();
    const targetTab = e.target.closest('.glabs-sheet-tab');
    if (!targetTab) return;

    const targetSheet = targetTab.textContent.trim().replace('√ó', '').trim();
    if (glabsDraggedSheet && targetSheet && glabsDraggedSheet !== targetSheet) {
        // Reorder sheets
        const sheetNames = Object.keys(glabsSheets);
        const draggedIndex = sheetNames.indexOf(glabsDraggedSheet);
        const targetIndex = sheetNames.indexOf(targetSheet);

        if (draggedIndex !== -1 && targetIndex !== -1) {
            // Create new order
            sheetNames.splice(draggedIndex, 1);
            sheetNames.splice(targetIndex, 0, glabsDraggedSheet);

            // Rebuild sheets object in new order
            const newSheets = {};
            sheetNames.forEach(name => {
                newSheets[name] = glabsSheets[name];
            });
            glabsSheets = newSheets;
            glabsSaveData();
            renderGLabs();
        }
    }
    targetTab.classList.remove('drag-over');
}

function glabsSheetDragEnd(e) {
    e.target.style.opacity = '1';
    document.querySelectorAll('.glabs-sheet-tab').forEach(tab => {
        tab.classList.remove('drag-over');
    });
    glabsDraggedSheet = null;
}

// Evaluate cell value (handle formulas)
function glabsEvaluateCell(value, row, col) {
    if (!value || typeof value !== 'string') return value || '';

    if (!value.startsWith('=')) return value;

    try {
        const sheet = glabsSheets[glabsCurrentSheet];
        const glabsData = sheet?.data || [];
        const formula = value.substring(1).toUpperCase();

        // Parse cell references like A1, B2, etc.
        const colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        // Helper to clean formatted values (remove $, %, commas)
        function cleanVal(rawVal) {
            if (!rawVal) return 0;
            const cleaned = String(rawVal).replace(/[$,%]/g, '').replace(/,/g, '');
            return parseFloat(cleaned) || 0;
        }

        // Handle SUM(A1:A10)
        const sumMatch = formula.match(/SUM\(([A-Z])(\d+):([A-Z])(\d+)\)/);
        if (sumMatch) {
            const [_, startCol, startRow, endCol, endRow] = sumMatch;
            let sum = 0;
            const sc = colLetters.indexOf(startCol);
            const ec = colLetters.indexOf(endCol);
            const sr = parseInt(startRow) - 1;
            const er = parseInt(endRow) - 1;

            for (let r = sr; r <= er; r++) {
                for (let c = sc; c <= ec; c++) {
                    sum += cleanVal(glabsData[r]?.[c]);
                }
            }
            return sum.toLocaleString();
        }

        // Handle AVG(A1:A10)
        const avgMatch = formula.match(/AVG\(([A-Z])(\d+):([A-Z])(\d+)\)/);
        if (avgMatch) {
            const [_, startCol, startRow, endCol, endRow] = avgMatch;
            let sum = 0, count = 0;
            const sc = colLetters.indexOf(startCol);
            const ec = colLetters.indexOf(endCol);
            const sr = parseInt(startRow) - 1;
            const er = parseInt(endRow) - 1;

            for (let r = sr; r <= er; r++) {
                for (let c = sc; c <= ec; c++) {
                    const val = cleanVal(glabsData[r]?.[c]);
                    if (val !== 0 || glabsData[r]?.[c]) { sum += val; count++; }
                }
            }
            return count > 0 ? (sum / count).toLocaleString(undefined, {maximumFractionDigits: 2}) : '0';
        }

        // Handle MAX(A1:A10)
        const maxMatch = formula.match(/MAX\(([A-Z])(\d+):([A-Z])(\d+)\)/);
        if (maxMatch) {
            const [_, startCol, startRow, endCol, endRow] = maxMatch;
            let max = -Infinity;
            const sc = colLetters.indexOf(startCol);
            const ec = colLetters.indexOf(endCol);
            const sr = parseInt(startRow) - 1;
            const er = parseInt(endRow) - 1;

            for (let r = sr; r <= er; r++) {
                for (let c = sc; c <= ec; c++) {
                    const val = cleanVal(glabsData[r]?.[c]);
                    if (val > max) max = val;
                }
            }
            return max === -Infinity ? '0' : max.toLocaleString();
        }

        // Handle MIN(A1:A10)
        const minMatch = formula.match(/MIN\(([A-Z])(\d+):([A-Z])(\d+)\)/);
        if (minMatch) {
            const [_, startCol, startRow, endCol, endRow] = minMatch;
            let min = Infinity;
            const sc = colLetters.indexOf(startCol);
            const ec = colLetters.indexOf(endCol);
            const sr = parseInt(startRow) - 1;
            const er = parseInt(endRow) - 1;

            for (let r = sr; r <= er; r++) {
                for (let c = sc; c <= ec; c++) {
                    if (glabsData[r]?.[c]) {
                        const val = cleanVal(glabsData[r]?.[c]);
                        if (val < min) min = val;
                    }
                }
            }
            return min === Infinity ? '0' : min.toLocaleString();
        }

        // Handle COUNT(A1:A10)
        const countMatch = formula.match(/COUNT\(([A-Z])(\d+):([A-Z])(\d+)\)/);
        if (countMatch) {
            const [_, startCol, startRow, endCol, endRow] = countMatch;
            let count = 0;
            const sc = colLetters.indexOf(startCol);
            const ec = colLetters.indexOf(endCol);
            const sr = parseInt(startRow) - 1;
            const er = parseInt(endRow) - 1;

            for (let r = sr; r <= er; r++) {
                for (let c = sc; c <= ec; c++) {
                    if (glabsData[r]?.[c]) count++;
                }
            }
            return count.toString();
        }

        // Handle simple range without function (D1:D4) - auto SUM
        const rangeMatch = formula.match(/^([A-Z])(\d+):([A-Z])(\d+)$/);
        if (rangeMatch) {
            const [_, startCol, startRow, endCol, endRow] = rangeMatch;
            let sum = 0;
            const sc = colLetters.indexOf(startCol);
            const ec = colLetters.indexOf(endCol);
            const sr = parseInt(startRow) - 1;
            const er = parseInt(endRow) - 1;

            for (let r = sr; r <= er; r++) {
                for (let c = sc; c <= ec; c++) {
                    sum += cleanVal(glabsData[r]?.[c]);
                }
            }
            return sum.toLocaleString(undefined, {maximumFractionDigits: 2});
        }

        // Handle simple math with cell references (A1+B1, A1*2, etc.)
        let evalFormula = formula;
        const cellRefs = formula.match(/[A-Z]\d+/g) || [];
        cellRefs.forEach(ref => {
            const c = colLetters.indexOf(ref[0]);
            const r = parseInt(ref.substring(1)) - 1;
            const val = cleanVal(glabsData[r]?.[c]);
            evalFormula = evalFormula.replace(ref, val);
        });

        // Safe eval for math only
        const result = Function('"use strict"; return (' + evalFormula + ')')();
        return typeof result === 'number' ? result.toLocaleString(undefined, {maximumFractionDigits: 2}) : result;

    } catch (e) {
        return '#ERROR';
    }
}

// Apply formula from formula bar
function glabsApplyFormula() {
    if (!glabsSelectedCell) return;

    glabsSaveUndoState();

    const { row, col, element } = glabsSelectedCell;
    const value = document.getElementById('glabs-formula-bar').value;
    const sheet = glabsSheets[glabsCurrentSheet];

    if (!sheet.data[row]) sheet.data[row] = [];
    sheet.data[row][col] = value;

    // Save to localStorage
    glabsSaveData();

    // Update display with proper formatting
    const evaluatedValue = glabsEvaluateCell(value, row, col);
    const cellStyle = sheet.cellStyles?.[`${row}-${col}`] || {};
    const displayValue = glabsFormatValue(evaluatedValue, cellStyle.format);
    const textColor = cellStyle.color || '';
    const bold = cellStyle.bold ? 'font-weight: 700;' : '';
    const italic = cellStyle.italic ? 'font-style: italic;' : '';

    const contentEl = element?.querySelector('.glabs-cell-content');
    if (contentEl) {
        contentEl.innerHTML = `<span style="${textColor ? 'color: ' + textColor + ';' : ''} ${bold} ${italic}">${displayValue}</span>`;
    }

    // Update quick stats
    const numValue = parseFloat(String(evaluatedValue).replace(/[$,%]/g, '').replace(/,/g, ''));
    if (!isNaN(numValue)) {
        document.getElementById('glabs-sum').textContent = numValue.toLocaleString();
        document.getElementById('glabs-avg').textContent = numValue.toLocaleString();
        document.getElementById('glabs-count').textContent = '1';
    }

    document.getElementById('glabs-saved').innerHTML = '<i class="fas fa-check-circle"></i> Saved';
}

// Add row
function glabsAddRow() {
    const sheet = glabsSheets[glabsCurrentSheet];
    const currentCols = sheet.data[0]?.length || glabsCols;
    sheet.data.push(Array(currentCols).fill(''));
    glabsSaveData();
    renderGLabs();
}

// Add column
function glabsAddColumn() {
    const sheet = glabsSheets[glabsCurrentSheet];
    const currentCols = sheet.data[0]?.length || glabsCols;
    if (currentCols >= 26) return; // Max 26 columns (A-Z)
    sheet.data.forEach(row => row.push(''));
    glabsSaveData();
    renderGLabs();
}

// Clear all data
function glabsClearAll() {
    if (!confirm('Are you sure you want to clear all data in this sheet? This cannot be undone.')) return;

    const sheet = glabsSheets[glabsCurrentSheet];
    const rows = sheet.data.length || glabsRows;
    const cols = sheet.data[0]?.length || glabsCols;

    sheet.data = [];
    for (let i = 0; i < rows; i++) {
        sheet.data[i] = Array(cols).fill('');
    }
    sheet.cellStyles = {};
    glabsSaveData();
    renderGLabs();
}

// Export to CSV
function glabsExportCSV() {
    const sheet = glabsSheets[glabsCurrentSheet];
    const glabsData = sheet.data;
    const colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const numCols = glabsData[0]?.length || glabsCols;
    let csv = '';

    // Header row
    csv += ',' + Array.from({length: numCols}, (_, i) => colLetters[i]).join(',') + '\n';

    // Data rows
    glabsData.forEach((row, idx) => {
        const rowData = [idx + 1];
        for (let c = 0; c < numCols; c++) {
            const val = String(glabsEvaluateCell(row[c] || '', idx, c));
            // Escape commas and quotes
            if (val.includes(',') || val.includes('"')) {
                rowData.push(`"${val.replace(/"/g, '""')}"`);
            } else {
                rowData.push(val);
            }
        }
        csv += rowData.join(',') + '\n';
    });

    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `glabs_${glabsCurrentSheet.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

