<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ascendance Hub | Vape Smoke Universe Management</title>
    <link rel="icon" type="image/x-icon" href="img/AH.ico">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/abundance-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
</head>

<body class="light-theme">
    <div class="bg-gradient"></div>

    <!-- Loading Overlay - Shown until page is fully initialized -->
    <div id="initial-loading-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        flex-direction: column;
        gap: 20px;
        overflow: hidden;
    ">
        <!-- Gradiente animado de fondo -->
        <canvas id="gradient-canvas" style="
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        "></canvas>

        <!-- Contenido del loading -->
        <div style="
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            padding: 40px 50px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        ">
            <div style="
                width: 60px;
                height: 60px;
                border: 4px solid rgba(255, 255, 255, 0.2);
                border-top: 4px solid rgba(255, 255, 255, 0.9);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            "></div>
            <div style="text-align: center;">
                <p style="color: rgba(255, 255, 255, 0.95); font-weight: 600; margin: 0; font-size: 18px;">Initializing Ascendance Hub</p>
                <p style="color: rgba(255, 255, 255, 0.7); font-size: 12px; margin: 8px 0 0 0;">Validating permissions...</p>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        // Efecto de gradiente fluido animado
        window.gradientAnimation = {
            running: true,
            animationId: null,
            stop: function() {
                this.running = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
            }
        };
        
        (function() {
            const canvas = document.getElementById('gradient-canvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            let time = 0;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            resize();
            window.addEventListener('resize', resize);

            // Crear ruido/textura
            function createNoise(imageData) {
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const noise = Math.random() * 25;
                    data[i] += noise; // R
                    data[i + 1] += noise; // G
                    data[i + 2] += noise; // B
                }
            }

            function animate() {
                time += 0.005;

                // Crear gradientes con movimiento
                const gradient1 = ctx.createRadialGradient(
                    canvas.width * (0.3 + Math.sin(time) * 0.2),
                    canvas.height * (0.4 + Math.cos(time * 0.7) * 0.2),
                    0,
                    canvas.width * (0.3 + Math.sin(time) * 0.2),
                    canvas.height * (0.4 + Math.cos(time * 0.7) * 0.2),
                    canvas.width * 0.8
                );
                gradient1.addColorStop(0, '#ff6b9d');
                gradient1.addColorStop(0.5, '#c44569');
                gradient1.addColorStop(1, 'transparent');

                const gradient2 = ctx.createRadialGradient(
                    canvas.width * (0.7 + Math.cos(time * 1.1) * 0.2),
                    canvas.height * (0.6 + Math.sin(time * 0.9) * 0.2),
                    0,
                    canvas.width * (0.7 + Math.cos(time * 1.1) * 0.2),
                    canvas.height * (0.6 + Math.sin(time * 0.9) * 0.2),
                    canvas.width * 0.7
                );
                gradient2.addColorStop(0, '#a855f7');
                gradient2.addColorStop(0.5, '#6366f1');
                gradient2.addColorStop(1, 'transparent');

                const gradient3 = ctx.createRadialGradient(
                    canvas.width * (0.5 + Math.sin(time * 0.8) * 0.3),
                    canvas.height * (0.3 + Math.cos(time * 1.2) * 0.3),
                    0,
                    canvas.width * (0.5 + Math.sin(time * 0.8) * 0.3),
                    canvas.height * (0.3 + Math.cos(time * 1.2) * 0.3),
                    canvas.width * 0.6
                );
                gradient3.addColorStop(0, '#10b981');
                gradient3.addColorStop(0.5, '#059669');
                gradient3.addColorStop(1, 'transparent');

                // Fondo base oscuro
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Aplicar gradientes con blend modes
                ctx.globalCompositeOperation = 'screen';

                ctx.fillStyle = gradient1;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = gradient2;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = gradient3;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.globalCompositeOperation = 'source-over';

                // Agregar textura de ruido sutil
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                createNoise(imageData);
                ctx.putImageData(imageData, 0, 0);

                // Overlay oscuro para suavizar
                ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (window.gradientAnimation.running) {
                    window.gradientAnimation.animationId = requestAnimationFrame(animate);
                }
            }

            animate();
        })();
    </script>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modal-content"></div>
    </div>

    <!-- G Force Modal -->
    <div class="modal" id="gforce-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-bolt" style="color: var(--accent-primary);"></i> G Force - GiselleÂ´s Daily Motivation
                </h2>
                <button class="modal-close" onclick="closeGForceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="gforce-body">
                <div id="gforce-date" style="text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 13px;"></div>

                <!-- Quote Card -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body" style="text-align: center;">
                        <div id="gforce-quote-text" style="font-size: 1.4rem; line-height: 1.6; margin-bottom: 16px; font-weight: 300;"></div>
                        <div id="gforce-quote-author" style="text-align: right; color: var(--accent-primary); font-size: 1rem; font-style: italic;"></div>
                    </div>
                </div>

                <!-- Affirmations -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-sparkles"></i> Daily Affirmations
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="gforce-affirmations"></div>
                    </div>
                </div>

                <!-- Philosophy -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-seedling"></i> Daily Philosophy
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="gforce-philosophy-text" style="font-size: 14px; line-height: 1.8; margin-bottom: 20px; color: var(--text-secondary);"></div>
                        <div id="gforce-tips"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn-secondary" onclick="generateGForceQuote()">
                        <i class="fas fa-sync-alt"></i> New Quote
                    </button>
                    <button class="btn-secondary" onclick="generateGForceAffirmations()">
                        <i class="fas fa-sync-alt"></i> New Affirmations
                    </button>
                    <button class="btn-secondary" onclick="generateGForcePhilosophy()">
                        <i class="fas fa-sync-alt"></i> New Philosophy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mark As Modal (Abundance Cloud) -->
    <div class="modal" id="markAsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="markAsTitle">Mark Order</h2>
                <button class="modal-close" onclick="closeMarkAsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="markAsForm">
                    <div class="form-group">
                        <label>Order ID or Number:</label>
                        <input type="text" id="markAsOrderInput" class="form-input" placeholder="Enter order ID or scan barcode" required>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn-secondary" onclick="toggleBarcodeScanner()">
                            <i class="fas fa-camera"></i>
                            <span id="scannerBtnText">Scan with Camera</span>
                        </button>
                    </div>

                    <div id="barcodeScannerContainer" style="display: none;">
                        <video id="barcodeVideo" style="width: 100%; border-radius: 12px; margin: 16px 0;"></video>
                        <canvas id="barcodeCanvas" style="display: none;"></canvas>
                    </div>

                    <div id="markAsMessage" class="alert" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeMarkAsModal()">Cancel</button>
                <button type="button" class="btn-primary" id="markAsSubmitBtn" onclick="submitMarkAs()">
                    <i class="fas fa-check"></i>
                    <span id="markAsSubmitText">Submit</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal (Abundance Cloud) -->
    <div class="modal" id="orderDetailsModal">
        <div class="modal-content" style="max-width: 720px;">
            <div class="modal-header">
                <h2 id="orderDetailsTitle">Order Details</h2>
                <button class="modal-close" onclick="closeOrderDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="orderDetailsBody">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeOrderDetailsModal()">Close</button>
                <button type="button" class="btn-primary" onclick="printOrder()">
                    <i class="fas fa-print"></i>
                    Print
                </button>
            </div>
        </div>
    </div>

    <!-- Thief Report Modal (Abundance Cloud) -->
    <div class="modal" id="thiefReportModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-user-secret" style="color: var(--danger);"></i> Report Theft Incident
                </h2>
                <button class="modal-close" onclick="closeThiefReportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="thiefReportForm">
                    <!-- Photo Upload -->
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            <i class="fas fa-camera"></i> Photo of Suspect *
                        </label>
                        <div id="photoUploadArea" class="photo-upload-area" onclick="document.getElementById('thiefPhotoInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--text-muted); margin-bottom: 12px;"></i>
                            <p style="color: var(--text-muted); margin: 0;">Click to upload or drag and drop</p>
                            <p style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">PNG, JPG up to 10MB</p>
                        </div>
                        <input type="file" id="thiefPhotoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)" required>
                        <div id="photoPreview" style="display: none; margin-top: 12px;">
                            <img id="photoPreviewImg" style="max-width: 100%; max-height: 300px; border-radius: 12px; border: 2px solid var(--border-color);">
                            <button type="button" class="btn-secondary" onclick="removePhoto()" style="margin-top: 8px; width: 100%;">
                                <i class="fas fa-trash"></i> Remove Photo
                            </button>
                        </div>
                    </div>

                    <!-- Store Location -->
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            <i class="fas fa-store"></i> Store Location *
                        </label>
                        <select id="storeLocation" class="form-input" required>
                            <option value="">Select store...</option>
                            <option value="VSU Miramar">VSU Miramar</option>
                            <option value="VSU Chulavista">VSU Chulavista</option>
                            <option value="VSU North Park">VSU North Park</option>
                            <option value="VSU Morena">VSU Morena</option>
                            <option value="VSU Kearny Mesa">VSU Kearny Mesa</option>
                            <option value="Miramar Wine & Liquor">Miramar Wine & Liquor</option>
                        </select>
                    </div>

                    <!-- Date and Time -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                                <i class="fas fa-calendar"></i> Approximate Date *
                            </label>
                            <input type="date" id="incidentDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                                <i class="fas fa-clock"></i> Approximate Time *
                            </label>
                            <input type="time" id="incidentTime" class="form-input" required>
                        </div>
                    </div>

                    <!-- Identifying Characteristics -->
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            <i class="fas fa-id-badge"></i> Identifying Characteristics
                        </label>
                        <textarea id="identifyingMarks" class="form-input" rows="4" placeholder="Describe any distinctive features: tattoos, scars, clothing, accessories, approximate height/build, hair color, etc." style="resize: vertical;"></textarea>
                    </div>

                    <!-- Additional Notes -->
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            <i class="fas fa-clipboard"></i> Additional Notes
                        </label>
                        <textarea id="additionalNotes" class="form-input" rows="3" placeholder="Any other relevant information about the incident..." style="resize: vertical;"></textarea>
                    </div>

                    <div id="thiefReportMessage" class="alert" style="display: none; margin-top: 16px;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeThiefReportModal()">Cancel</button>
                <button type="button" class="btn-primary" id="submitThiefReportBtn" onclick="submitThiefReport()">
                    <i class="fas fa-paper-plane"></i>
                    Submit Report
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-section">
            <div class="logo">
                <div class="logo-icon">
                    <img src="img/AH.png" alt="Ascendance Hub" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <div class="logo-text">
                    <h1>Ascendance</h1>
                    <span>Hub Management</span>
                </div>
            </div>
        </div>

        <nav class="nav-section">
            <!-- SUPER ADMIN - Only visible for carlos@calidevs.com -->
            <div id="super-admin-nav" style="display: none;">
                <div class="nav-label" style="color: #ef4444; font-weight: 700;">Developer Mode</div>
                <a href="#" class="nav-item" data-page="superadmin" onclick="window.navigateTo && window.navigateTo('superadmin'); return false;" style="background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(185,28,28,0.2)); border: 1px solid rgba(239,68,68,0.4);">
                    <span class="nav-icon"><i class="fas fa-crown" style="color: gold;"></i></span> <span style="color: #ef4444; font-weight: 600;">God Mode</span>
                </a>
                <a href="#" class="nav-item" data-page="devlog" onclick="window.navigateTo && window.navigateTo('devlog'); return false;" style="background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(139,92,246,0.2)); border: 1px solid rgba(99,102,241,0.4);">
                    <span class="nav-icon"><i class="fas fa-code" style="color: #6366f1;"></i></span> <span style="color: #6366f1; font-weight: 600;">Development</span>
                </a>
            </div>

            <!-- PRINCIPAL -->
            <div class="nav-label">Principal</div>
            <a href="#" class="nav-item" data-page="celesteai" onclick="window.navigateTo && window.navigateTo('celesteai'); return false;" style="background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15)); border: 1px solid rgba(102,126,234,0.3);">
                <span class="nav-icon"><img src="img/celeste-ai.svg" alt="Celeste" style="width: 22px; height: 22px; border-radius: 50%; object-fit: cover;" onerror="this.outerHTML='<i class=\'fas fa-stars\' style=\'color: #a855f7;\'></i>'"></span> Celeste AI
            </a>
            <a href="#" class="nav-item" data-page="podmatcher" onclick="window.navigateTo && window.navigateTo('podmatcher'); return false;" style="background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(99,102,241,0.15)); border: 1px solid rgba(139,92,246,0.3);">
                <span class="nav-icon"><i class="fas fa-search-plus" style="color: #8b5cf6;"></i></span> Pod Matcher
            </a>
            <a href="#" class="nav-item active" data-page="dashboard" onclick="window.navigateTo && window.navigateTo('dashboard'); return false;">
                <span class="nav-icon"><i class="fas fa-th-large"></i></span> Dashboard
            </a>
            <a href="#" class="nav-item" data-page="announcements" onclick="window.navigateTo && window.navigateTo('announcements'); return false;">
                <span class="nav-icon"><i class="fas fa-bullhorn"></i></span> Announcements
                <span class="nav-badge" id="announcements-badge">0</span>
            </a>

            <!-- EQUIPO -->
            <div class="nav-label">Team</div>
            <a href="#" class="nav-item" data-page="employees" onclick="window.navigateTo && window.navigateTo('employees'); return false;">
                <span class="nav-icon"><i class="fas fa-users"></i></span> Employees
                <span class="nav-badge" id="employees-count-badge">0</span>
            </a>
            <a href="#" class="nav-item" data-page="schedule" onclick="window.navigateTo && window.navigateTo('schedule'); return false;">
                <span class="nav-icon"><i class="fas fa-calendar-alt"></i></span> Schedule
            </a>
            <a href="#" class="nav-item" data-page="clockin" onclick="window.navigateTo && window.navigateTo('clockin'); return false;">
                <span class="nav-icon"><i class="fas fa-clock"></i></span> Clock In/Out
            </a>
            <a href="#" class="nav-item" data-page="training" onclick="window.navigateTo && window.navigateTo('training'); return false;">
                <span class="nav-icon"><i class="fas fa-graduation-cap"></i></span> Training Center
            </a>
            <a href="#" class="nav-item" data-page="dailychecklist" onclick="window.navigateTo && window.navigateTo('dailychecklist'); return false;">
                <span class="nav-icon"><i class="fas fa-clipboard-check"></i></span> Daily Checklist
            </a>
            <a href="#" class="nav-item" data-page="timeoffrequests" onclick="window.navigateTo && window.navigateTo('timeoffrequests'); return false;">
                <span class="nav-icon"><i class="fas fa-umbrella-beach"></i></span> Time Off Requests
                <span class="nav-badge" id="pto-pending-badge" style="display: none;">0</span>
            </a>
            <a href="#" class="nav-item" data-page="shiftexchanges" onclick="window.navigateTo && window.navigateTo('shiftexchanges'); return false;">
                <span class="nav-icon"><i class="fas fa-people-arrows"></i></span> Shift Exchanges
                <span class="nav-badge" id="shift-exchange-badge" style="display: none;">0</span>
            </a>

            <!-- INVENTARIO -->
            <div class="nav-label">Inventory</div>
            <!-- New Products - hidden until functionality is implemented
            <a href="#" class="nav-item" data-page="newproducts" onclick="window.navigateTo && window.navigateTo('newproducts'); return false;">
                <span class="nav-icon"><i class="fas fa-box"></i></span> New Products
            </a>
            -->
            <a href="#" class="nav-item" data-page="restock" onclick="window.navigateTo && window.navigateTo('restock'); return false;">
                <span class="nav-icon"><i class="fas fa-boxes"></i></span> Running Low
            </a>
            <a href="#" class="nav-item" data-page="supplies" onclick="window.navigateTo && window.navigateTo('supplies'); return false;">
                <span class="nav-icon"><i class="fas fa-shopping-basket"></i></span> Supplies
            </a>
            <a href="#" class="nav-item" data-page="transfers" onclick="window.navigateTo && window.navigateTo('transfers'); return false;">
                <span class="nav-icon"><i class="fas fa-exchange-alt"></i></span> Transfers
            </a>
            <!-- Barcode Labels hidden - uncomment to restore
            <a href="#" class="nav-item" data-page="labels" onclick="window.navigateTo && window.navigateTo('labels'); return false;">
                <span class="nav-icon"><i class="fas fa-barcode"></i></span> Barcode Labels
            </a>
            -->

            <!-- FINANZAS -->
            <div class="nav-label">Finance</div>
            <a href="#" class="nav-item" data-page="analytics" onclick="window.navigateTo && window.navigateTo('analytics'); return false;">
                <span class="nav-icon"><i class="fas fa-chart-line"></i></span> Sales & Analytics
            </a>
            <a href="#" class="nav-item" data-page="thechamps" onclick="window.navigateTo && window.navigateTo('thechamps'); return false;">
                <span class="nav-icon"><i class="fas fa-trophy" style="color: #FFD700;"></i></span> Best Sellers
            </a>
            <a href="#" class="nav-item" data-page="salesperformance" onclick="window.navigateTo && window.navigateTo('salesperformance'); return false;">
                <span class="nav-icon"><i class="fas fa-ranking-star"></i></span> Sales Performance
            </a>
            <a href="#" class="nav-item" data-page="gconomics" onclick="window.navigateTo && window.navigateTo('gconomics'); return false;">
                <span class="nav-icon"><i class="fas fa-wallet"></i></span> G-conomics
            </a>
            <a href="#" class="nav-item" data-page="invoices" onclick="window.navigateTo && window.navigateTo('invoices'); return false;">
                <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span> Invoices & Payments
            </a>
            <a href="#" class="nav-item" data-page="cashout" onclick="window.navigateTo && window.navigateTo('cashout'); return false;">
                <span class="nav-icon"><i class="fas fa-money-bill-wave"></i></span> Cash Removed
            </a>
            <a href="#" class="nav-item" data-page="change" onclick="window.navigateTo && window.navigateTo('change'); return false;">
                <span class="nav-icon"><i class="fas fa-coins"></i></span> Change Box
            </a>

            <!-- OPERACIONES -->
            <div class="nav-label">Operations</div>
            <a href="#" class="nav-item" data-page="hrapplications" onclick="window.navigateTo && window.navigateTo('hrapplications'); return false;">
                <span class="nav-icon"><i class="fas fa-user-plus"></i></span> Job Applications
            </a>
            <a href="#" class="nav-item" data-page="vendors" onclick="window.navigateTo && window.navigateTo('vendors'); return false;">
                <span class="nav-icon"><i class="fas fa-truck"></i></span> Vendors & Suppliers
            </a>
            <a href="#" class="nav-item" data-page="leases" onclick="window.navigateTo && window.navigateTo('leases'); return false;">
                <span class="nav-icon"><i class="fas fa-file-contract"></i></span> Leases
            </a>
            <a href="#" class="nav-item" data-page="licenses" onclick="window.navigateTo && window.navigateTo('licenses'); return false;">
                <span class="nav-icon"><i class="fas fa-folder-open"></i></span> Licenses & Docs
            </a>
            <a href="#" class="nav-item" data-page="abundancecloud" onclick="window.navigateTo && window.navigateTo('abundancecloud'); return false;">
                <span class="nav-icon"><i class="fas fa-cloud"></i></span> Loyal VSU
            </a>
            <a href="#" class="nav-item" data-page="glabs" onclick="window.navigateTo && window.navigateTo('glabs'); return false;">
                <span class="nav-icon"><i class="fas fa-table"></i></span> Blank Excel
            </a>
            <a href="#" class="nav-item" data-page="customercare" onclick="window.navigateTo && window.navigateTo('customercare'); return false;">
                <span class="nav-icon"><i class="fas fa-gift"></i></span> Comps
            </a>
            <a href="#" class="nav-item" data-page="employeepurchases" onclick="window.navigateTo && window.navigateTo('employeepurchases'); return false;">
                <span class="nav-icon"><i class="fas fa-shopping-bag"></i></span> Employee Purchases
            </a>
            <a href="#" class="nav-item" data-page="treasury" onclick="window.navigateTo && window.navigateTo('treasury'); return false;">
                <span class="nav-icon"><i class="fas fa-vault"></i></span> Heady Pieces
            </a>

            <!-- SEGURIDAD -->
            <div class="nav-label">Security</div>
            <a href="#" class="nav-item" data-page="thieves" onclick="window.navigateTo && window.navigateTo('thieves'); return false;">
                <span class="nav-icon"><i class="fas fa-ban"></i></span> Banned Customers
            </a>
            <a href="#" class="nav-item" data-page="incidentlog" onclick="window.navigateTo && window.navigateTo('incidentlog'); return false;">
                <span class="nav-icon"><i class="fas fa-clipboard-list"></i></span> Incident Log
            </a>
            <a href="#" class="nav-item" data-page="issues" onclick="window.navigateTo && window.navigateTo('issues'); return false;">
                <span class="nav-icon"><i class="fas fa-headset"></i></span> Customer Issue Log
            </a>
                        <a href="#" class="nav-item" data-page="passwords" onclick="window.navigateTo && window.navigateTo('passwords'); return false;">
                <span class="nav-icon"><i class="fas fa-key"></i></span> Password Manager
            </a>

            <!-- SISTEMA -->
            <div class="nav-label">System</div>
            <a href="#" class="nav-item" data-page="activitylog" onclick="window.navigateTo && window.navigateTo('activitylog'); return false;">
                <span class="nav-icon"><i class="fas fa-history"></i></span> Activity Log
            </a>
            <a href="#" class="nav-item" data-page="gforce" onclick="window.navigateTo && window.navigateTo('gforce'); return false;">
                <span class="nav-icon"><i class="fas fa-bolt"></i></span> G-Force
            </a>
            <a href="#" class="nav-item" data-page="projectanalytics" onclick="window.navigateTo && window.navigateTo('projectanalytics'); return false;">
                <span class="nav-icon"><i class="fas fa-code"></i></span> Project Analytics
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="sidebar-footer-btn" onclick="logout()" title="Logout">
                <i class="fas fa-arrow-right-from-bracket"></i>
            </button>
            <button class="sidebar-footer-btn" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
            <button class="sidebar-footer-btn sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="Collapse Menu">
                <i class="fas fa-angles-left" id="collapse-icon"></i>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="page-title">Dashboard</h1>
                <div class="breadcrumb">
                    <a href="#" onclick="window.navigateTo && window.navigateTo('dashboard'); return false;">Home</a>
                    <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                    <span>Overview</span>
                </div>
            </div>

            <div class="search-bar-container">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="global-search" placeholder="Search employees, thieves, invoices..." oninput="handleGlobalSearch(this.value)" onfocus="showSearchResults()" autocomplete="off">
                    <span class="search-shortcut">Ctrl+K</span>
                </div>
            </div>

            <!-- Search results dropdown - shared between desktop and mobile search -->
            <div class="search-results-dropdown" id="search-results-dropdown">
                <div class="search-results-list" id="search-results-list">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <div class="header-right">
                <!-- Announcements Bell -->
                <div class="header-notification-container">
                    <button class="header-notification-btn" onclick="toggleAnnouncementsDropdown()" title="Announcements">
                        <i class="fas fa-bell"></i>
                        <span class="header-notification-badge" id="header-announcements-badge">0</span>
                    </button>
                    <div class="announcements-dropdown" id="announcements-dropdown">
                        <div class="announcements-dropdown-header">
                            <h4>Announcements</h4>
                            <a href="#" onclick="window.navigateTo && window.navigateTo('announcements'); closeAnnouncementsDropdown(); return false;">View All</a>
                        </div>
                        <div class="announcements-dropdown-list" id="announcements-dropdown-list">
                            <!-- Announcements will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Mobile search (replaces user menu on mobile) -->
                <div class="mobile-header-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="mobile-global-search" placeholder="Search..." oninput="handleGlobalSearch(this.value)" onfocus="showSearchResults()" autocomplete="off">
                </div>

                <div class="user-menu-container">
                    <div class="user-menu">
                        <div class="user-avatar" id="header-user-avatar">--</div>
                        <div class="user-info">
                            <span class="user-name" id="header-user-name">Loading...</span>
                            <span class="user-role" id="header-user-role">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard -->
        <div class="dashboard">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card" onclick="window.navigateTo && window.navigateTo('employees')" style="cursor: pointer;">
                    <div class="stat-header">
                        <div class="stat-icon purple">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-trend up">
                            <i class="fas fa-arrow-up"></i> +2
                        </div>
                    </div>
                    <div class="stat-value">20</div>
                    <div class="stat-label">Total Employees</div>
                </div>

                <div class="stat-card" onclick="window.navigateTo && window.navigateTo('training')" style="cursor: pointer;">
                    <div class="stat-header">
                        <div class="stat-icon blue">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-trend down">
                            <i class="fas fa-exclamation"></i> 2 expiring
                        </div>
                    </div>
                    <div class="stat-value">12</div>
                    <div class="stat-label">Active Licenses</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <a href="#" class="quick-action" onclick="openModal('add-employee'); return false;">
                    <div class="quick-action-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <span class="quick-action-label">Add Employee</span>
                </a>
                <a href="#" class="quick-action" onclick="alert('Upload Training feature coming soon!'); return false;">
                    <div class="quick-action-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <span class="quick-action-label">Upload Training</span>
                </a>
                <a href="#" class="quick-action" onclick="openModal('add-license'); return false;">
                    <div class="quick-action-icon">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    <span class="quick-action-label">Add License</span>
                </a>
                <a href="#" class="quick-action" onclick="window.navigateTo && window.navigateTo('analytics'); return false;">
                    <div class="quick-action-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <span class="quick-action-label">View Reports</span>
                </a>
            </div>

            <!-- Bottom Grid -->
            <div class="bottom-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-trophy"></i> Store Performance
                        </h3>
                        <button class="card-action">Details</button>
                    </div>
                    <div class="card-body">
                        <div class="store-performance">
                            <div class="store-item">
                                <div class="store-rank first">1</div>
                                <div class="store-details">
                                    <div class="store-name">VSU Miramar</div>
                                    <div class="store-sales">142 orders this week</div>
                                </div>
                                <div class="store-amount">$15,420</div>
                            </div>
                            <div class="store-item">
                                <div class="store-rank second">2</div>
                                <div class="store-details">
                                    <div class="store-name">VSU Kearny Mesa</div>
                                    <div class="store-sales">118 orders this week</div>
                                </div>
                                <div class="store-amount">$12,890</div>
                            </div>
                            <div class="store-item">
                                <div class="store-rank third">3</div>
                                <div class="store-details">
                                    <div class="store-name">VSU Chula Vista</div>
                                    <div class="store-sales">96 orders this week</div>
                                </div>
                                <div class="store-amount">$10,340</div>
                            </div>
                            <div class="store-item">
                                <div class="store-rank fourth">4</div>
                                <div class="store-details">
                                    <div class="store-name">VSU Morena</div>
                                    <div class="store-sales">87 orders this week</div>
                                </div>
                                <div class="store-amount">$9,550</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-file-certificate"></i> Licenses Status
                        </h3>
                        <button class="card-action">Upload</button>
                    </div>
                    <div class="card-body">
                        <div class="licenses-grid">
                            <div class="license-card">
                                <div class="license-icon valid">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="license-info">
                                    <div class="license-name">Business License - Miramar</div>
                                    <div class="license-meta">Expires: Dec 2025</div>
                                </div>
                                <span class="license-status valid">Valid</span>
                            </div>
                            <div class="license-card">
                                <div class="license-icon expiring">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="license-info">
                                    <div class="license-name">Tobacco License - Morena</div>
                                    <div class="license-meta">Expires: Jan 2026</div>
                                </div>
                                <span class="license-status expiring">Expiring</span>
                            </div>
                            <div class="license-card">
                                <div class="license-icon valid">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="license-info">
                                    <div class="license-name">Health Permit - Kearny</div>
                                    <div class="license-meta">Expires: Mar 2026</div>
                                </div>
                                <span class="license-status valid">Valid</span>
                            </div>
                            <div class="license-card">
                                <div class="license-icon expiring">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="license-info">
                                    <div class="license-name">Fire Safety - Chula Vista</div>
                                    <div class="license-meta">Expires: Feb 2026</div>
                                </div>
                                <span class="license-status expiring">Expiring</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bullhorn"></i> Recent Announcements
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="announcement-list">
                            <div class="announcement-item" style="border: 2px dashed var(--border-color); background: transparent; padding: 20px; cursor: pointer; transition: all 0.2s;">
                                <div style="text-align: center; color: var(--text-muted);">
                                    <i class="fas fa-plus-circle" style="font-size: 24px; margin-bottom: 8px; color: var(--accent-primary);"></i>
                                    <div style="font-size: 14px; font-weight: 500;">Click to add a new announcement</div>
                                </div>
                            </div>
                            <div class="announcement-item">
                                <div class="announcement-date">Dec 02, 2025</div>
                                <div class="announcement-text">Holiday schedule updates have been posted. Please check your shifts for the upcoming weeks.</div>
                            </div>
                            <div class="announcement-item">
                                <div class="announcement-date">Nov 28, 2025</div>
                                <div class="announcement-text">New product line arriving next week - mandatory training session on Thursday.</div>
                            </div>
                            <div class="announcement-item">
                                <div class="announcement-date">Nov 25, 2025</div>
                                <div class="announcement-text">Congratulations to VSU Miramar for hitting Q4 sales targets! ðŸŽ‰</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Employees -->
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-users"></i> Recent Employees
                        </h3>
                        <button class="card-action">View All</button>
                    </div>
                    <div class="card-body">
                        <div class="employee-list">
                            <div class="employee-item">
                                <div class="employee-avatar a">MR</div>
                                <div class="employee-info">
                                    <div class="employee-name">Marcus Rodriguez</div>
                                    <div class="employee-role">Store Manager</div>
                                </div>
                                <span class="employee-store">Miramar</span>
                                <div class="employee-status active"></div>
                            </div>
                            <div class="employee-item">
                                <div class="employee-avatar b">SK</div>
                                <div class="employee-info">
                                    <div class="employee-name">Sarah Kim</div>
                                    <div class="employee-role">Sales Associate</div>
                                </div>
                                <span class="employee-store">Morena</span>
                                <div class="employee-status active"></div>
                            </div>
                            <div class="employee-item">
                                <div class="employee-avatar c">JT</div>
                                <div class="employee-info">
                                    <div class="employee-name">James Thompson</div>
                                    <div class="employee-role">Shift Lead</div>
                                </div>
                                <span class="employee-store">Kearny Mesa</span>
                                <div class="employee-status active"></div>
                            </div>
                            <div class="employee-item">
                                <div class="employee-avatar d">AL</div>
                                <div class="employee-info">
                                    <div class="employee-name">Amanda Lopez</div>
                                    <div class="employee-role">Sales Associate</div>
                                </div>
                                <span class="employee-store">Chula Vista</span>
                                <div class="employee-status inactive"></div>
                            </div>
                            <div class="employee-item">
                                <div class="employee-avatar e">DN</div>
                                <div class="employee-info">
                                    <div class="employee-name">David Nguyen</div>
                                    <div class="employee-role">Inventory Specialist</div>
                                </div>
                                <span class="employee-store">Miramar</span>
                                <div class="employee-status active"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Firebase Scripts (Using compat version for traditional script loading) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- PDF.js for PDF thumbnail generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>

    <!-- Environment variables (generated at build time) -->
    <script src="config/env.js"></script>
    <!-- Configuration (Update with your actual credentials) -->
    <script src="config/abundance-config.js?v=2"></script>

    <!-- Firebase Utilities -->
    <script src="js/firebase-utils.js?v=2"></script>

    <!-- Firebase Sync Manager -->
    <script src="js/firebase-sync.js"></script>

    <!-- Gconomics Firebase Manager -->
    <script src="js/gconomics-firebase.js"></script>

    <!-- Authentication Manager -->
    <script src="js/auth-manager.js"></script>

    <!-- Transfers Module -->
    <script src="js/transfers.js?v=3"></script>

    <!-- Main Application Script -->
    <script src="js/script.js?v=80"></script>

    <!-- Modular Scripts (extracted from script.js) -->
    <script src="js/daily-checklist.js?v=1"></script>
    <script src="js/pto-system.js?v=1"></script>
    <script src="js/shift-exchanges.js?v=3"></script>
    <script src="js/inventory-newstuff.js?v=1"></script>
    <script src="js/vendors-module.js?v=1"></script>
    <script src="js/thieves-module.js?v=1"></script>
    <script src="js/invoices-module.js?v=1"></script>
    <script src="js/password-manager.js?v=1"></script>
    <script src="js/super-admin.js?v=1"></script>
    <script src="js/development-log.js?v=1"></script>
    <script src="js/project-analytics.js?v=1"></script>
    <script src="js/voice-assistant.js?v=1"></script>
    <script src="js/leases-module.js?v=1"></script>
    <script src="js/g-labs.js?v=1"></script>
    <script src="js/activity-log.js?v=1"></script>
    <script src="js/sales-performance.js?v=1"></script>
    <script src="js/bulk-invoice.js?v=1"></script>
    <script src="js/pod-matcher.js?v=1"></script>

    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Shopify Analytics (Frontend API) -->
    <script src="js/shopify-analytics.js?v=15"></script>

    <!-- Shopify API Client -->
    <script src="js/api-client.js?v=14"></script>

    <!-- Abundance Cloud Script -->
    <script src="js/abundance-cloud.js"></script>

    <!-- Barcode Labels Module -->
    <script src="js/barcode-labels.js?v=3"></script>

    <!-- Celeste AI Assistant -->
    <script src="js/celeste-ai.js?v=3"></script>

    <!-- HR Applications Module -->
    <script src="js/hr-applications.js"></script>

    <!-- Initialize Application -->
    <script>
        // Initialize authentication first
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is authenticated
            authManager.initialize();

            if (!authManager.isAuthenticated()) {
                // Redirect to login if not authenticated
                console.warn('User not authenticated, redirecting to login...');
                window.location.href = 'login.html';
                return;
            }

            const user = authManager.getCurrentUser();

            // Update header user info
            try {
                const userName = user.name || user.email.split('@')[0];
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                const roleLabel = (window.ROLE_PERMISSIONS?.[user.role]?.label) || user.role || 'User';

                document.getElementById('header-user-avatar').textContent = userInitials;
                document.getElementById('header-user-name').textContent = userName;
                document.getElementById('header-user-role').textContent = roleLabel;
            } catch (error) {
                console.warn('âš ï¸ Failed to update header user info:', error);
            }

            try {
                // Initialize Firebase employees
                await initializeFirebaseEmployees();
            } catch (error) {
                console.warn('âš ï¸ Firebase employees initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase thieves database
                await initializeFirebaseThieves();
            } catch (error) {
                console.warn('âš ï¸ Firebase thieves initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Clock In/Out Manager
                await firebaseClockInManager.initialize();
            } catch (error) {
                console.warn('âš ï¸ Firebase Clock In Manager initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Announcements
                await initializeFirebaseAnnouncements();
            } catch (error) {
                console.warn('âš ï¸ Firebase Announcements initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Restock Requests
                await initializeFirebaseRestockRequests();
            } catch (error) {
                console.warn('âš ï¸ Firebase Restock Requests initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Change Records
                await initializeFirebaseChangeRecords();
            } catch (error) {
                console.warn('âš ï¸ Firebase Change Records initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Cash Out Records
                await initializeFirebaseCashOut();
            } catch (error) {
                console.warn('âš ï¸ Firebase Cash Out initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Gifts
                await initializeFirebaseGifts();
            } catch (error) {
                console.warn('âš ï¸ Firebase Gifts initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Issues
                await initializeFirebaseIssues();
            } catch (error) {
                console.warn('âš ï¸ Firebase Issues initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Gconomics
                await initializeGconomicsFirebase(user.userId || user.id, user.email);
                await loadGconomicsFromFirebase();
            } catch (error) {
                console.warn('âš ï¸ Firebase Gconomics initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Licenses
                await initializeFirebaseLicenses();
            } catch (error) {
                console.warn('âš ï¸ Firebase Licenses initialization failed, using local fallback data:', error);
            }

            try {
                // Initialize Firebase Password Manager
                await initializeFirebasePasswords();
            } catch (error) {
                console.warn('âš ï¸ Firebase Password Manager initialization failed, using local fallback data:', error);
            }

            // Filter navigation menu based on user role
            try {
                filterNavigationByRole();
                const roleLabel = (window.ROLE_PERMISSIONS?.[user.role]?.label) || user.role;
            } catch (error) {
                console.warn('âš ï¸ Navigation filtering failed:', error);
            }

            // Log login activity if this is a new login session
            try {
                const isNewLogin = localStorage.getItem('ascendance_new_login') === 'true';
                if (isNewLogin && typeof logActivity === 'function') {
                    localStorage.removeItem('ascendance_new_login');
                    await logActivity('login', {
                        message: 'User logged in',
                        store: user.store || 'Unknown'
                    }, 'user', user.userId || user.id);
                    console.log('âœ… Login activity logged');
                }
            } catch (error) {
                console.warn('âš ï¸ Failed to log login activity:', error);
            }

            // Restore the last viewed page from sessionStorage (persists on refresh, clears on tab close)
            // URL parameter ?page= takes priority over sessionStorage
            try {
                // Check URL for page parameter first (highest priority)
                const urlParams = new URLSearchParams(window.location.search);
                const pageFromUrl = urlParams.get('page');

                const savedPage = sessionStorage.getItem('ascendance_current_page');

                // Determine default page based on user role
                let defaultPage = 'dashboard';
                if (user.role === 'employee') {
                    defaultPage = 'clockin'; // Employees default to Clock In/Out
                } else if (user.role === 'manager') {
                    defaultPage = 'dashboard'; // Managers default to Dashboard
                } else {
                    defaultPage = 'dashboard'; // Admins default to Dashboard
                }

                // Validate that saved page is allowed for current user role
                const userPermissions = window.ROLE_PERMISSIONS[user.role] || window.ROLE_PERMISSIONS['employee'];
                const allowedPages = userPermissions.pages || [];

                // URL parameter has highest priority, then sessionStorage, then default
                let pageToShow;
                if (pageFromUrl && allowedPages.includes(pageFromUrl)) {
                    pageToShow = pageFromUrl;
                } else if (savedPage && allowedPages.includes(savedPage)) {
                    pageToShow = savedPage;
                } else {
                    pageToShow = defaultPage;
                }

                // Wait for navigateTo to be available from script.js
                if (typeof window.navigateTo === 'function') {
                    window.navigateTo(pageToShow);
                } else {
                    // If navigateTo isn't ready yet, wait a bit and retry
                    const waitForNavigate = setInterval(() => {
                        if (typeof window.navigateTo === 'function') {
                            clearInterval(waitForNavigate);
                            window.navigateTo(pageToShow);
                        }
                    }, 50);
                    // Timeout after 3 seconds
                    setTimeout(() => clearInterval(waitForNavigate), 3000);
                }
            } catch (error) {
                console.warn('âš ï¸ Failed to restore page state, defaulting based on role:', error);
                const defaultPage = user.role === 'employee' ? 'clockin' : 'dashboard';
                // Wait for navigateTo to be available from script.js
                if (typeof window.navigateTo === 'function') {
                    window.navigateTo(defaultPage);
                } else {
                    const waitForNavigate = setInterval(() => {
                        if (typeof window.navigateTo === 'function') {
                            clearInterval(waitForNavigate);
                            window.navigateTo(defaultPage);
                        }
                    }, 50);
                    setTimeout(() => clearInterval(waitForNavigate), 3000);
                }
            }

            // Hide loading overlay - all initialization and permission checks are complete
            setTimeout(() => {
                const loadingOverlay = document.getElementById('initial-loading-overlay');
                if (loadingOverlay) {
                    // Detener la animaciÃ³n del gradiente
                    if (window.gradientAnimation) {
                        window.gradientAnimation.stop();
                    }
                    
                    loadingOverlay.style.opacity = '0';
                    loadingOverlay.style.transition = 'opacity 0.3s ease-out';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                        // Remover completamente el overlay del DOM para liberar memoria
                        loadingOverlay.remove();
                    }, 300);
                }
            }, 100);

            // Check if redirected from 404 page with Celeste flag
            if (sessionStorage.getItem('openCeleste') === 'true') {
                sessionStorage.removeItem('openCeleste');
                setTimeout(() => {
                    if (typeof toggleCelesteChat === 'function') {
                        toggleCelesteChat();
                    }
                }, 500);
            }

        });
    </script>
</body>

</html>